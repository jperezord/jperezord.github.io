# Multivariate (Google mobility + temp) prediction {.unnumbered}

Load packages:

```{r}
pacman::p_load(
      here,      # file locator
      tidyverse, # data management and ggplot2 graphics
      skimr,     # get overview of data
      janitor,   # produce and adorn tabulations and cross-tabulations
      tsibble,
      fable,
      feasts,
      fabletools,
      lubridate
)

covid_data <- readRDS(here("data", "clean", "final_covid_data.rds"))
```

The temporal limits of our prediction will be:

-   Data as of June 14th 2020 which is considered the beginning of the second epidemiological period in Spain
-   In the first case scenario, data previous the start of the sixth wave of covid-19 (14 oct 2021).
-   In the second case scenario, all the available data (limited by mobility information 29 dec 2021)

# Before sixth epidemiological period

## Asturias

```{r}
data_asturias <- covid_data %>% 
      filter(provincia == "Asturias") %>% 
      filter(fecha > as.Date("2020-06-14", format = "%Y-%m-%d")) %>% 
      select(provincia, fecha, num_casos, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces) %>% 
      drop_na() %>% 
      as_tsibble(key = provincia, index = fecha)
data_asturias
```

```{r}
data_asturias_train <- data_asturias %>% 
      filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d"))
summary(data_asturias_train$fecha)
```

```{r}
data_asturias_test <- data_asturias %>% 
      filter(fecha > as.Date("2021-10-14", format = "%Y-%m-%d"))
summary(data_asturias_test$fecha)
```

```{r}
#| warning = FALSE
# Lamba for num_casos
lambda_asturias_casos <- data_asturias %>%
      features(num_casos, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_asturias_casos

# Lamba for average temp
lambda_asturias_tmed <- data_asturias %>%
      features(tmed, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_asturias_tmed

# Lamba for mobility
lambda_asturias_grocery <- data_asturias %>%
      features(mob_grocery_pharmacy, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_asturias_grocery

lambda_asturias_parks <- data_asturias %>%
      features(mob_parks, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_asturias_parks

lambda_asturias_resd <- data_asturias %>%
      features(mob_residential, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_asturias_resd

lambda_asturias_retail <- data_asturias %>%
      features(mob_retail_recreation, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_asturias_retail

lambda_asturias_transit <- data_asturias %>%
      features(mob_transit_stations, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_asturias_transit

lambda_asturias_work <- data_asturias %>%
      features(mob_workplaces, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_asturias_work
```

```{r}
fit_model <- data_asturias_train %>%
      model(
            arima_at1 = ARIMA(box_cox(num_casos, lambda_asturias_casos) ~ 
                                    box_cox(tmed, lambda_asturias_tmed) + 
                                    box_cox(mob_grocery_pharmacy, lambda_asturias_grocery) +
                                    box_cox(mob_parks, lambda_asturias_parks) +
                                    box_cox(mob_residential, lambda_asturias_resd) +
                                    box_cox(mob_retail_recreation, lambda_asturias_retail) +
                                    box_cox(mob_transit_stations, lambda_asturias_transit) +
                                    box_cox(mob_workplaces, lambda_asturias_work)
                              ),
            arima_at2 = ARIMA(box_cox(num_casos, lambda_asturias_casos) ~ 
                                    box_cox(tmed, lambda_asturias_tmed) + 
                                    box_cox(mob_grocery_pharmacy, lambda_asturias_grocery) +
                                    box_cox(mob_parks, lambda_asturias_parks) +
                                    box_cox(mob_residential, lambda_asturias_resd) +
                                    box_cox(mob_retail_recreation, lambda_asturias_retail) +
                                    box_cox(mob_transit_stations, lambda_asturias_transit) +
                                    box_cox(mob_workplaces, lambda_asturias_work),
                              stepwise = FALSE, approx = FALSE),
            Snaive = SNAIVE(box_cox(num_casos, lambda_asturias_casos))
      )

# Show and report model
fit_model
```

```{r}
glance(fit_model)
```

```{r}
#| warning = FALSE
fit_model %>% 
      pivot_longer(-provincia,
                   names_to = ".model",
                   values_to = "orders") %>% 
      left_join(glance(fit_model), by = c("provincia", ".model")) %>% 
      arrange(AICc) %>% 
      select(.model:BIC)
```

```{r}
#| warning = FALSE
# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise
fit_model %>% 
      select(Snaive) %>% 
      gg_tsresiduals()
```

```{r}
fit_model %>% 
      select(arima_at1) %>% 
      gg_tsresiduals()
```

```{r}
fit_model %>% 
      select(arima_at2) %>% 
      gg_tsresiduals()
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=7)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=14)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=21)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=90)
```

```{r}
# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility
# We are going to select those from the test dataset
data_fc_h7 <- data_asturias_test %>% 
      select(-num_casos) %>% 
      slice(1:7)
data_fc_h14 <- data_asturias_test %>% 
      select(-num_casos) %>% 
      slice(1:14)
data_fc_h21 <- data_asturias_test %>% 
      select(-num_casos) %>% 
      slice(1:21)
data_fc_h90 <- data_asturias_test %>% 
      select(-num_casos) %>% 
      slice(1:90)
```

```{r}
# Significant spikes out of 30 is still consistent with white noise
# To be sure, use a Ljung-Box test, which has a large p-value, confirming that
# the residuals are similar to white noise.
# Note that the alternative models also passed this test.
# 
# Forecast
fc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)
fc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)
fc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)
fc_h90 <- fabletools::forecast(fit_model, new_data = data_fc_h90)
```

### 7 days

```{r}
# Plots
fc_h7 %>%
      autoplot(
            data_asturias_test %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(7))
      ) +
      labs(y = "Nº cases", title = "Asturias - forecast h7")
```

```{r}
fc_h7 %>%
      autoplot(
            data_asturias %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(7) &
                               fecha > as.Date("2021-07-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Asturias - forecast h7")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h7, data_asturias)
```

### 14 days

```{r}
# Plots
fc_h14 %>%
      autoplot(
            data_asturias_test %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(14))
      ) +
      labs(y = "Nº cases", title = "Asturias - forecast h14")
```

```{r}
fc_h14 %>%
      autoplot(
            data_asturias %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(14) &
                               fecha > as.Date("2021-07-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Asturias - forecast h14")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h14, data_asturias)
```

### 21 days

```{r}
# Plots
fc_h21 %>%
      autoplot(
            data_asturias_test %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(21))
      ) +
      labs(y = "Nº cases", title = "Asturias - forecast h21")
```

```{r}
fc_h21 %>%
      autoplot(
            data_asturias %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(21) &
                               fecha > as.Date("2021-07-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Asturias - forecast h21")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h21, data_asturias)
```

### 90 days

```{r}
# Plots
fc_h90 %>%
      autoplot(
            data_asturias_test %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(90))
      ) +
      labs(y = "Nº cases", title = "Asturias - forecast h90")
```

```{r}
fc_h90 %>%
      autoplot(
            data_asturias %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(90) &
                               fecha > as.Date("2021-07-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Asturias - forecast h90")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h90, data_asturias)
```

## Barcelona

```{r}
data_Barcelona <- covid_data %>% 
      filter(provincia == "Barcelona") %>% 
      filter(fecha > as.Date("2020-06-14", format = "%Y-%m-%d")) %>% 
      select(provincia, fecha, num_casos, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces) %>% 
      drop_na() %>% 
      as_tsibble(key = provincia, index = fecha)
data_Barcelona
```

```{r}
data_Barcelona_train <- data_Barcelona %>% 
      filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d"))
summary(data_Barcelona_train$fecha)
```

```{r}
data_Barcelona_test <- data_Barcelona %>% 
      filter(fecha > as.Date("2021-10-14", format = "%Y-%m-%d"))
summary(data_Barcelona_test$fecha)
```

```{r}
#| warning = FALSE
# Lamba for num_casos
lambda_Barcelona_casos <- data_asturias %>%
      features(num_casos, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Barcelona_casos

# Lamba for average temp
lambda_Barcelona_tmed <- data_asturias %>%
      features(tmed, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Barcelona_tmed

# Lamba for mobility
lambda_Barcelona_grocery <- data_asturias %>%
      features(mob_grocery_pharmacy, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Barcelona_grocery

lambda_Barcelona_parks <- data_asturias %>%
      features(mob_parks, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Barcelona_parks

lambda_Barcelona_resd <- data_asturias %>%
      features(mob_residential, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Barcelona_resd

lambda_Barcelona_retail <- data_asturias %>%
      features(mob_retail_recreation, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Barcelona_retail

lambda_Barcelona_transit <- data_asturias %>%
      features(mob_transit_stations, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Barcelona_transit

lambda_Barcelona_work <- data_asturias %>%
      features(mob_workplaces, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Barcelona_work
```

```{r}
fit_model <- data_Barcelona_train %>%
      model(
            arima_at1 = ARIMA(box_cox(num_casos, lambda_Barcelona_casos) ~ 
                                    box_cox(tmed, lambda_Barcelona_tmed) + 
                                    box_cox(mob_grocery_pharmacy, lambda_Barcelona_grocery) +
                                    box_cox(mob_parks, lambda_Barcelona_parks) +
                                    box_cox(mob_residential, lambda_Barcelona_resd) +
                                    box_cox(mob_retail_recreation, lambda_Barcelona_retail) +
                                    box_cox(mob_transit_stations, lambda_Barcelona_transit) +
                                    box_cox(mob_workplaces, lambda_Barcelona_work)
                              ),
            arima_at2 = ARIMA(box_cox(num_casos, lambda_Barcelona_casos) ~ 
                                    box_cox(tmed, lambda_Barcelona_tmed) + 
                                    box_cox(mob_grocery_pharmacy, lambda_Barcelona_grocery) +
                                    box_cox(mob_parks, lambda_Barcelona_parks) +
                                    box_cox(mob_residential, lambda_Barcelona_resd) +
                                    box_cox(mob_retail_recreation, lambda_Barcelona_retail) +
                                    box_cox(mob_transit_stations, lambda_Barcelona_transit) +
                                    box_cox(mob_workplaces, lambda_Barcelona_work),
                              stepwise = FALSE, approx = FALSE),
            Snaive = SNAIVE(box_cox(num_casos, lambda_Barcelona_casos))
      )

# Show and report model
fit_model
```

```{r}
glance(fit_model)
```

```{r}
#| warning = FALSE
fit_model %>% 
      pivot_longer(-provincia,
                   names_to = ".model",
                   values_to = "orders") %>% 
      left_join(glance(fit_model), by = c("provincia", ".model")) %>% 
      arrange(AICc) %>% 
      select(.model:BIC)
```

```{r}
#| warning = FALSE
# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise
fit_model %>% 
      select(Snaive) %>% 
      gg_tsresiduals()
```

```{r}
fit_model %>% 
      select(arima_at1) %>% 
      gg_tsresiduals()
```

```{r}
fit_model %>% 
      select(arima_at2) %>% 
      gg_tsresiduals()
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=7)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=14)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=21)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=90)
```

```{r}
# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility
# We are going to select those from the test dataset
data_fc_h7 <- data_Barcelona_test %>% 
      select(-num_casos) %>% 
      slice(1:7)
data_fc_h14 <- data_Barcelona_test %>% 
      select(-num_casos) %>% 
      slice(1:14)
data_fc_h21 <- data_Barcelona_test %>% 
      select(-num_casos) %>% 
      slice(1:21)
data_fc_h90 <- data_Barcelona_test %>% 
      select(-num_casos) %>% 
      slice(1:90)
```

```{r}
# Significant spikes out of 30 is still consistent with white noise
# To be sure, use a Ljung-Box test, which has a large p-value, confirming that
# the residuals are similar to white noise.
# Note that the alternative models also passed this test.
# 
# Forecast
fc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)
fc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)
fc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)
fc_h90 <- fabletools::forecast(fit_model, new_data = data_fc_h90)
```

### 7 days

```{r}
# Plots
fc_h7 %>%
      autoplot(
            data_Barcelona_test %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(7))
      ) +
      labs(y = "Nº cases", title = "Barcelona - forecast h7")
```

```{r}
fc_h7 %>%
      autoplot(
            data_Barcelona %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(7) &
                               fecha > as.Date("2021-07-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Barcelona - forecast h7")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h7, data_Barcelona)
```

### 14 days

```{r}
# Plots
fc_h14 %>%
      autoplot(
            data_Barcelona_test %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(14))
      ) +
      labs(y = "Nº cases", title = "Barcelona - forecast h14")
```

```{r}
fc_h14 %>%
      autoplot(
            data_Barcelona %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(14) &
                               fecha > as.Date("2021-07-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Barcelona - forecast h14")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h14, data_Barcelona)
```

### 21 days

```{r}
# Plots
fc_h21 %>%
      autoplot(
            data_Barcelona_test %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(21))
      ) +
      labs(y = "Nº cases", title = "Barcelona - forecast h21")
```

```{r}
fc_h21 %>%
      autoplot(
            data_Barcelona %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(21) &
                               fecha > as.Date("2021-07-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Barcelona - forecast h21")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h21, data_Barcelona)
```

### 90 days

```{r}
# Plots
fc_h90 %>%
      autoplot(
            data_Barcelona_test %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(90))
      ) +
      labs(y = "Nº cases", title = "Barcelona - forecast h90")
```

```{r}
fc_h90 %>%
      autoplot(
            data_Barcelona %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(90) &
                               fecha > as.Date("2021-07-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Barcelona - forecast h90")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h90, data_Barcelona)
```

## Madrid

```{r}
data_Madrid <- covid_data %>% 
      filter(provincia == "Madrid") %>% 
      filter(fecha > as.Date("2020-06-14", format = "%Y-%m-%d")) %>% 
      select(provincia, fecha, num_casos, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces) %>% 
      drop_na() %>% 
      as_tsibble(key = provincia, index = fecha)
data_Madrid
```

```{r}
data_Madrid_train <- data_Madrid %>% 
      filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d"))
summary(data_Madrid_train$fecha)
```

```{r}
data_Madrid_test <- data_Madrid %>% 
      filter(fecha > as.Date("2021-10-14", format = "%Y-%m-%d"))
summary(data_Madrid_test$fecha)
```

```{r}
#| warning = FALSE
# Lamba for num_casos
lambda_Madrid_casos <- data_asturias %>%
      features(num_casos, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Madrid_casos

# Lamba for average temp
lambda_Madrid_tmed <- data_asturias %>%
      features(tmed, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Madrid_tmed

# Lamba for mobility
lambda_Madrid_grocery <- data_asturias %>%
      features(mob_grocery_pharmacy, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Madrid_grocery

lambda_Madrid_parks <- data_asturias %>%
      features(mob_parks, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Madrid_parks

lambda_Madrid_resd <- data_asturias %>%
      features(mob_residential, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Madrid_resd

lambda_Madrid_retail <- data_asturias %>%
      features(mob_retail_recreation, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Madrid_retail

lambda_Madrid_transit <- data_asturias %>%
      features(mob_transit_stations, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Madrid_transit

lambda_Madrid_work <- data_asturias %>%
      features(mob_workplaces, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Madrid_work
```

```{r}
fit_model <- data_Madrid_train %>%
      model(
            arima_at1 = ARIMA(box_cox(num_casos, lambda_Madrid_casos) ~ 
                                    box_cox(tmed, lambda_Madrid_tmed) + 
                                    box_cox(mob_grocery_pharmacy, lambda_Madrid_grocery) +
                                    box_cox(mob_parks, lambda_Madrid_parks) +
                                    box_cox(mob_residential, lambda_Madrid_resd) +
                                    box_cox(mob_retail_recreation, lambda_Madrid_retail) +
                                    box_cox(mob_transit_stations, lambda_Madrid_transit) +
                                    box_cox(mob_workplaces, lambda_Madrid_work)
                              ),
            arima_at2 = ARIMA(box_cox(num_casos, lambda_Madrid_casos) ~ 
                                    box_cox(tmed, lambda_Madrid_tmed) + 
                                    box_cox(mob_grocery_pharmacy, lambda_Madrid_grocery) +
                                    box_cox(mob_parks, lambda_Madrid_parks) +
                                    box_cox(mob_residential, lambda_Madrid_resd) +
                                    box_cox(mob_retail_recreation, lambda_Madrid_retail) +
                                    box_cox(mob_transit_stations, lambda_Madrid_transit) +
                                    box_cox(mob_workplaces, lambda_Madrid_work),
                              stepwise = FALSE, approx = FALSE),
            Snaive = SNAIVE(box_cox(num_casos, lambda_Madrid_casos))
      )

# Show and report model
fit_model
```

```{r}
glance(fit_model)
```

```{r}
#| warning = FALSE
fit_model %>% 
      pivot_longer(-provincia,
                   names_to = ".model",
                   values_to = "orders") %>% 
      left_join(glance(fit_model), by = c("provincia", ".model")) %>% 
      arrange(AICc) %>% 
      select(.model:BIC)
```

```{r}
#| warning = FALSE
# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise
fit_model %>% 
      select(Snaive) %>% 
      gg_tsresiduals()
```

```{r}
fit_model %>% 
      select(arima_at1) %>% 
      gg_tsresiduals()
```

```{r}
fit_model %>% 
      select(arima_at2) %>% 
      gg_tsresiduals()
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=7)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=14)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=21)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=90)
```

```{r}
# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility
# We are going to select those from the test dataset
data_fc_h7 <- data_Madrid_test %>% 
      select(-num_casos) %>% 
      slice(1:7)
data_fc_h14 <- data_Madrid_test %>% 
      select(-num_casos) %>% 
      slice(1:14)
data_fc_h21 <- data_Madrid_test %>% 
      select(-num_casos) %>% 
      slice(1:21)
data_fc_h90 <- data_Madrid_test %>% 
      select(-num_casos) %>% 
      slice(1:90)
```

```{r}
# Significant spikes out of 30 is still consistent with white noise
# To be sure, use a Ljung-Box test, which has a large p-value, confirming that
# the residuals are similar to white noise.
# Note that the alternative models also passed this test.
# 
# Forecast
fc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)
fc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)
fc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)
fc_h90 <- fabletools::forecast(fit_model, new_data = data_fc_h90)
```

### 7 days

```{r}
# Plots
fc_h7 %>%
      autoplot(
            data_Madrid_test %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(7))
      ) +
      labs(y = "Nº cases", title = "Madrid - forecast h7")
```

```{r}
fc_h7 %>%
      autoplot(
            data_Madrid %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(7) &
                               fecha > as.Date("2021-07-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Madrid - forecast h7")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h7, data_Madrid)
```

### 14 days

```{r}
# Plots
fc_h14 %>%
      autoplot(
            data_Madrid_test %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(14))
      ) +
      labs(y = "Nº cases", title = "Madrid - forecast h14")
```

```{r}
fc_h14 %>%
      autoplot(
            data_Madrid %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(14) &
                               fecha > as.Date("2021-07-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Madrid - forecast h14")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h14, data_Madrid)
```

### 21 days

```{r}
# Plots
fc_h21 %>%
      autoplot(
            data_Madrid_test %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(21))
      ) +
      labs(y = "Nº cases", title = "Madrid - forecast h21")
```

```{r}
fc_h21 %>%
      autoplot(
            data_Madrid %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(21) &
                               fecha > as.Date("2021-07-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Madrid - forecast h21")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h21, data_Madrid)
```

### 90 days

```{r}
# Plots
fc_h90 %>%
      autoplot(
            data_Madrid_test %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(90))
      ) +
      labs(y = "Nº cases", title = "Madrid - forecast h90")
```

```{r}
fc_h90 %>%
      autoplot(
            data_Madrid %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(90) &
                               fecha > as.Date("2021-07-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Madrid - forecast h90")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h90, data_Madrid)
```

## Malaga

```{r}
data_Malaga <- covid_data %>% 
      filter(provincia == "Málaga") %>% 
      filter(fecha > as.Date("2020-06-14", format = "%Y-%m-%d")) %>% 
      select(provincia, fecha, num_casos, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces) %>% 
      drop_na() %>% 
      as_tsibble(key = provincia, index = fecha)
data_Malaga
```

```{r}
data_Malaga_train <- data_Malaga %>% 
      filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d"))
summary(data_Malaga_train$fecha)
```

```{r}
data_Malaga_test <- data_Malaga %>% 
      filter(fecha > as.Date("2021-10-14", format = "%Y-%m-%d"))
summary(data_Malaga_test$fecha)
```

```{r}
#| warning = FALSE
# Lamba for num_casos
lambda_Malaga_casos <- data_asturias %>%
      features(num_casos, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Malaga_casos

# Lamba for average temp
lambda_Malaga_tmed <- data_asturias %>%
      features(tmed, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Malaga_tmed

# Lamba for mobility
lambda_Malaga_grocery <- data_asturias %>%
      features(mob_grocery_pharmacy, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Malaga_grocery

lambda_Malaga_parks <- data_asturias %>%
      features(mob_parks, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Malaga_parks

lambda_Malaga_resd <- data_asturias %>%
      features(mob_residential, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Malaga_resd

lambda_Malaga_retail <- data_asturias %>%
      features(mob_retail_recreation, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Malaga_retail

lambda_Malaga_transit <- data_asturias %>%
      features(mob_transit_stations, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Malaga_transit

lambda_Malaga_work <- data_asturias %>%
      features(mob_workplaces, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Malaga_work
```

```{r}
fit_model <- data_Malaga_train %>%
      model(
            arima_at1 = ARIMA(box_cox(num_casos, lambda_Malaga_casos) ~ 
                                    box_cox(tmed, lambda_Malaga_tmed) + 
                                    box_cox(mob_grocery_pharmacy, lambda_Malaga_grocery) +
                                    box_cox(mob_parks, lambda_Malaga_parks) +
                                    box_cox(mob_residential, lambda_Malaga_resd) +
                                    box_cox(mob_retail_recreation, lambda_Malaga_retail) +
                                    box_cox(mob_transit_stations, lambda_Malaga_transit) +
                                    box_cox(mob_workplaces, lambda_Malaga_work)
                              ),
            arima_at2 = ARIMA(box_cox(num_casos, lambda_Malaga_casos) ~ 
                                    box_cox(tmed, lambda_Malaga_tmed) + 
                                    box_cox(mob_grocery_pharmacy, lambda_Malaga_grocery) +
                                    box_cox(mob_parks, lambda_Malaga_parks) +
                                    box_cox(mob_residential, lambda_Malaga_resd) +
                                    box_cox(mob_retail_recreation, lambda_Malaga_retail) +
                                    box_cox(mob_transit_stations, lambda_Malaga_transit) +
                                    box_cox(mob_workplaces, lambda_Malaga_work),
                              stepwise = FALSE, approx = FALSE),
            Snaive = SNAIVE(box_cox(num_casos, lambda_Malaga_casos))
      )

# Show and report model
fit_model
```

```{r}
glance(fit_model)
```

```{r}
#| warning = FALSE
fit_model %>% 
      pivot_longer(-provincia,
                   names_to = ".model",
                   values_to = "orders") %>% 
      left_join(glance(fit_model), by = c("provincia", ".model")) %>% 
      arrange(AICc) %>% 
      select(.model:BIC)
```

```{r}
#| warning = FALSE
# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise
fit_model %>% 
      select(Snaive) %>% 
      gg_tsresiduals()
```

```{r}
fit_model %>% 
      select(arima_at1) %>% 
      gg_tsresiduals()
```

```{r}
fit_model %>% 
      select(arima_at2) %>% 
      gg_tsresiduals()
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=7)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=14)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=21)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=90)
```

```{r}
# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility
# We are going to select those from the test dataset
data_fc_h7 <- data_Malaga_test %>% 
      select(-num_casos) %>% 
      slice(1:7)
data_fc_h14 <- data_Malaga_test %>% 
      select(-num_casos) %>% 
      slice(1:14)
data_fc_h21 <- data_Malaga_test %>% 
      select(-num_casos) %>% 
      slice(1:21)
data_fc_h90 <- data_Malaga_test %>% 
      select(-num_casos) %>% 
      slice(1:90)
```

```{r}
# Significant spikes out of 30 is still consistent with white noise
# To be sure, use a Ljung-Box test, which has a large p-value, confirming that
# the residuals are similar to white noise.
# Note that the alternative models also passed this test.
# 
# Forecast
fc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)
fc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)
fc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)
fc_h90 <- fabletools::forecast(fit_model, new_data = data_fc_h90)
```

### 7 days

```{r}
# Plots
fc_h7 %>%
      autoplot(
            data_Malaga_test %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(7))
      ) +
      labs(y = "Nº cases", title = "Malaga - forecast h7")
```

```{r}
fc_h7 %>%
      autoplot(
            data_Malaga %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(7) &
                               fecha > as.Date("2021-07-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Malaga - forecast h7")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h7, data_Malaga)
```

### 14 days

```{r}
# Plots
fc_h14 %>%
      autoplot(
            data_Malaga_test %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(14))
      ) +
      labs(y = "Nº cases", title = "Malaga - forecast h14")
```

```{r}
fc_h14 %>%
      autoplot(
            data_Malaga %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(14) &
                               fecha > as.Date("2021-07-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Malaga - forecast h14")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h14, data_Malaga)
```

### 21 days

```{r}
# Plots
fc_h21 %>%
      autoplot(
            data_Malaga_test %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(21))
      ) +
      labs(y = "Nº cases", title = "Malaga - forecast h21")
```

```{r}
fc_h21 %>%
      autoplot(
            data_Malaga %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(21) &
                               fecha > as.Date("2021-07-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Malaga - forecast h21")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h21, data_Malaga)
```

### 90 days

```{r}
# Plots
fc_h90 %>%
      autoplot(
            data_Malaga_test %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(90))
      ) +
      labs(y = "Nº cases", title = "Malaga - forecast h90")
```

```{r}
fc_h90 %>%
      autoplot(
            data_Malaga %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(90) &
                               fecha > as.Date("2021-07-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Malaga - forecast h90")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h90, data_Malaga)
```

## Sevilla

```{r}
data_Sevilla <- covid_data %>% 
      filter(provincia == "Sevilla") %>% 
      filter(fecha > as.Date("2020-06-14", format = "%Y-%m-%d")) %>% 
      select(provincia, fecha, num_casos, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces) %>% 
      drop_na() %>% 
      as_tsibble(key = provincia, index = fecha)
data_Sevilla
```

```{r}
data_Sevilla_train <- data_Sevilla %>% 
      filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d"))
summary(data_Sevilla_train$fecha)
```

```{r}
data_Sevilla_test <- data_Sevilla %>% 
      filter(fecha > as.Date("2021-10-14", format = "%Y-%m-%d"))
summary(data_Sevilla_test$fecha)
```

```{r}
#| warning = FALSE
# Lamba for num_casos
lambda_Sevilla_casos <- data_asturias %>%
      features(num_casos, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Sevilla_casos

# Lamba for average temp
lambda_Sevilla_tmed <- data_asturias %>%
      features(tmed, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Sevilla_tmed

# Lamba for mobility
lambda_Sevilla_grocery <- data_asturias %>%
      features(mob_grocery_pharmacy, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Sevilla_grocery

lambda_Sevilla_parks <- data_asturias %>%
      features(mob_parks, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Sevilla_parks

lambda_Sevilla_resd <- data_asturias %>%
      features(mob_residential, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Sevilla_resd

lambda_Sevilla_retail <- data_asturias %>%
      features(mob_retail_recreation, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Sevilla_retail

lambda_Sevilla_transit <- data_asturias %>%
      features(mob_transit_stations, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Sevilla_transit

lambda_Sevilla_work <- data_asturias %>%
      features(mob_workplaces, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Sevilla_work
```

```{r}
fit_model <- data_Sevilla_train %>%
      model(
            arima_at1 = ARIMA(box_cox(num_casos, lambda_Sevilla_casos) ~ 
                                    box_cox(tmed, lambda_Sevilla_tmed) + 
                                    box_cox(mob_grocery_pharmacy, lambda_Sevilla_grocery) +
                                    box_cox(mob_parks, lambda_Sevilla_parks) +
                                    box_cox(mob_residential, lambda_Sevilla_resd) +
                                    box_cox(mob_retail_recreation, lambda_Sevilla_retail) +
                                    box_cox(mob_transit_stations, lambda_Sevilla_transit) +
                                    box_cox(mob_workplaces, lambda_Sevilla_work)
                              ),
            arima_at2 = ARIMA(box_cox(num_casos, lambda_Sevilla_casos) ~ 
                                    box_cox(tmed, lambda_Sevilla_tmed) + 
                                    box_cox(mob_grocery_pharmacy, lambda_Sevilla_grocery) +
                                    box_cox(mob_parks, lambda_Sevilla_parks) +
                                    box_cox(mob_residential, lambda_Sevilla_resd) +
                                    box_cox(mob_retail_recreation, lambda_Sevilla_retail) +
                                    box_cox(mob_transit_stations, lambda_Sevilla_transit) +
                                    box_cox(mob_workplaces, lambda_Sevilla_work),
                              stepwise = FALSE, approx = FALSE),
            Snaive = SNAIVE(box_cox(num_casos, lambda_Sevilla_casos))
      )

# Show and report model
fit_model
```

```{r}
glance(fit_model)
```

```{r}
#| warning = FALSE
fit_model %>% 
      pivot_longer(-provincia,
                   names_to = ".model",
                   values_to = "orders") %>% 
      left_join(glance(fit_model), by = c("provincia", ".model")) %>% 
      arrange(AICc) %>% 
      select(.model:BIC)
```

```{r}
#| warning = FALSE
# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise
fit_model %>% 
      select(Snaive) %>% 
      gg_tsresiduals()
```

```{r}
fit_model %>% 
      select(arima_at1) %>% 
      gg_tsresiduals()
```

```{r}
fit_model %>% 
      select(arima_at2) %>% 
      gg_tsresiduals()
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=7)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=14)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=21)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=90)
```

```{r}
# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility
# We are going to select those from the test dataset
data_fc_h7 <- data_Sevilla_test %>% 
      select(-num_casos) %>% 
      slice(1:7)
data_fc_h14 <- data_Sevilla_test %>% 
      select(-num_casos) %>% 
      slice(1:14)
data_fc_h21 <- data_Sevilla_test %>% 
      select(-num_casos) %>% 
      slice(1:21)
data_fc_h90 <- data_Sevilla_test %>% 
      select(-num_casos) %>% 
      slice(1:90)
```

```{r}
# Significant spikes out of 30 is still consistent with white noise
# To be sure, use a Ljung-Box test, which has a large p-value, confirming that
# the residuals are similar to white noise.
# Note that the alternative models also passed this test.
# 
# Forecast
fc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)
fc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)
fc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)
fc_h90 <- fabletools::forecast(fit_model, new_data = data_fc_h90)
```

### 7 days

```{r}
# Plots
fc_h7 %>%
      autoplot(
            data_Sevilla_test %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(7))
      ) +
      labs(y = "Nº cases", title = "Sevilla - forecast h7")
```

```{r}
fc_h7 %>%
      autoplot(
            data_Sevilla %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(7) &
                               fecha > as.Date("2021-07-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Sevilla - forecast h7")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h7, data_Sevilla)
```

### 14 days

```{r}
# Plots
fc_h14 %>%
      autoplot(
            data_Sevilla_test %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(14))
      ) +
      labs(y = "Nº cases", title = "Sevilla - forecast h14")
```

```{r}
fc_h14 %>%
      autoplot(
            data_Sevilla %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(14) &
                               fecha > as.Date("2021-07-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Sevilla - forecast h14")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h14, data_Sevilla)
```

### 21 days

```{r}
# Plots
fc_h21 %>%
      autoplot(
            data_Sevilla_test %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(21))
      ) +
      labs(y = "Nº cases", title = "Sevilla - forecast h21")
```

```{r}
fc_h21 %>%
      autoplot(
            data_Sevilla %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(21) &
                               fecha > as.Date("2021-07-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Sevilla - forecast h21")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h21, data_Sevilla)
```

### 90 days

```{r}
# Plots
fc_h90 %>%
      autoplot(
            data_Sevilla_test %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(90))
      ) +
      labs(y = "Nº cases", title = "Sevilla - forecast h90")
```

```{r}
fc_h90 %>%
      autoplot(
            data_Sevilla %>% 
                  filter(fecha <= as.Date("2021-10-14", format = "%Y-%m-%d")+days(90) &
                               fecha > as.Date("2021-07-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Sevilla - forecast h90")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h90, data_Sevilla)
```

# Middel of sixth epidemiological period

## Asturias

```{r}
data_asturias <- covid_data %>% 
      filter(provincia == "Asturias") %>% 
      filter(fecha > as.Date("2020-06-14", format = "%Y-%m-%d")) %>% 
      select(provincia, fecha, num_casos, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces) %>% 
      drop_na() %>% 
      as_tsibble(key = provincia, index = fecha)
data_asturias
```

```{r}
data_asturias_train <- data_asturias %>% 
      filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d"))
summary(data_asturias_train$fecha)
```

```{r}
data_asturias_test <- data_asturias %>% 
      filter(fecha > as.Date("2022-01-31", format = "%Y-%m-%d"))
summary(data_asturias_test$fecha)
```

```{r}
#| warning = FALSE
# Lamba for num_casos
lambda_asturias_casos <- data_asturias %>%
      features(num_casos, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_asturias_casos

# Lamba for average temp
lambda_asturias_tmed <- data_asturias %>%
      features(tmed, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_asturias_tmed

# Lamba for mobility
lambda_asturias_grocery <- data_asturias %>%
      features(mob_grocery_pharmacy, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_asturias_grocery

lambda_asturias_parks <- data_asturias %>%
      features(mob_parks, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_asturias_parks

lambda_asturias_resd <- data_asturias %>%
      features(mob_residential, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_asturias_resd

lambda_asturias_retail <- data_asturias %>%
      features(mob_retail_recreation, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_asturias_retail

lambda_asturias_transit <- data_asturias %>%
      features(mob_transit_stations, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_asturias_transit

lambda_asturias_work <- data_asturias %>%
      features(mob_workplaces, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_asturias_work
```

```{r}
fit_model <- data_asturias_train %>%
      model(
            arima_at1 = ARIMA(box_cox(num_casos, lambda_asturias_casos) ~ 
                                    box_cox(tmed, lambda_asturias_tmed) + 
                                    box_cox(mob_grocery_pharmacy, lambda_asturias_grocery) +
                                    box_cox(mob_parks, lambda_asturias_parks) +
                                    box_cox(mob_residential, lambda_asturias_resd) +
                                    box_cox(mob_retail_recreation, lambda_asturias_retail) +
                                    box_cox(mob_transit_stations, lambda_asturias_transit) +
                                    box_cox(mob_workplaces, lambda_asturias_work)
                              ),
            arima_at2 = ARIMA(box_cox(num_casos, lambda_asturias_casos) ~ 
                                    box_cox(tmed, lambda_asturias_tmed) + 
                                    box_cox(mob_grocery_pharmacy, lambda_asturias_grocery) +
                                    box_cox(mob_parks, lambda_asturias_parks) +
                                    box_cox(mob_residential, lambda_asturias_resd) +
                                    box_cox(mob_retail_recreation, lambda_asturias_retail) +
                                    box_cox(mob_transit_stations, lambda_asturias_transit) +
                                    box_cox(mob_workplaces, lambda_asturias_work),
                              stepwise = FALSE, approx = FALSE),
            Snaive = SNAIVE(box_cox(num_casos, lambda_asturias_casos))
      )

# Show and report model
fit_model
```

```{r}
glance(fit_model)
```

```{r}
#| warning = FALSE
fit_model %>% 
      pivot_longer(-provincia,
                   names_to = ".model",
                   values_to = "orders") %>% 
      left_join(glance(fit_model), by = c("provincia", ".model")) %>% 
      arrange(AICc) %>% 
      select(.model:BIC)
```

```{r}
#| warning = FALSE
# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise
fit_model %>% 
      select(Snaive) %>% 
      gg_tsresiduals()
```

```{r}
fit_model %>% 
      select(arima_at1) %>% 
      gg_tsresiduals()
```

```{r}
fit_model %>% 
      select(arima_at2) %>% 
      gg_tsresiduals()
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=7)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=14)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=21)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=57)
```

```{r}
# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility
# We are going to select those from the test dataset
data_fc_h7 <- data_asturias_test %>% 
      select(-num_casos) %>% 
      slice(1:7)
data_fc_h14 <- data_asturias_test %>% 
      select(-num_casos) %>% 
      slice(1:14)
data_fc_h21 <- data_asturias_test %>% 
      select(-num_casos) %>% 
      slice(1:21)
data_fc_h57 <- data_asturias_test %>% 
      select(-num_casos) %>% 
      slice(1:57)
```

```{r}
# Significant spikes out of 30 is still consistent with white noise
# To be sure, use a Ljung-Box test, which has a large p-value, confirming that
# the residuals are similar to white noise.
# Note that the alternative models also passed this test.
# 
# Forecast
fc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)
fc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)
fc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)
fc_h57 <- fabletools::forecast(fit_model, new_data = data_fc_h57)
```

### 7 days

```{r}
# Plots
fc_h7 %>%
      autoplot(
            data_asturias_test %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(7))
      ) +
      labs(y = "Nº cases", title = "Asturias - forecast h7")
```

```{r}
fc_h7 %>%
      autoplot(
            data_asturias %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(7) &
                               fecha > as.Date("2022-01-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Asturias - forecast h7")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h7, data_asturias)
```

### 14 days

```{r}
# Plots
fc_h14 %>%
      autoplot(
            data_asturias_test %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(14))
      ) +
      labs(y = "Nº cases", title = "Asturias - forecast h14")
```

```{r}
fc_h14 %>%
      autoplot(
            data_asturias %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(14) &
                               fecha > as.Date("2022-01-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Asturias - forecast h14")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h14, data_asturias)
```

### 21 days

```{r}
# Plots
fc_h21 %>%
      autoplot(
            data_asturias_test %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(21))
      ) +
      labs(y = "Nº cases", title = "Asturias - forecast h21")
```

```{r}
fc_h21 %>%
      autoplot(
            data_asturias %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(21) &
                               fecha > as.Date("2022-01-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Asturias - forecast h21")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h21, data_asturias)
```

### 57 days

```{r}
# Plots
fc_h57 %>%
      autoplot(
            data_asturias_test %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(57))
      ) +
      labs(y = "Nº cases", title = "Asturias - forecast h57")
```

```{r}
fc_h57 %>%
      autoplot(
            data_asturias %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(57) &
                               fecha > as.Date("2022-01-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Asturias - forecast h57")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h57, data_asturias)
```

## Barcelona

```{r}
data_Barcelona <- covid_data %>% 
      filter(provincia == "Barcelona") %>% 
      filter(fecha > as.Date("2020-06-14", format = "%Y-%m-%d")) %>% 
      select(provincia, fecha, num_casos, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces) %>% 
      drop_na() %>% 
      as_tsibble(key = provincia, index = fecha)
data_Barcelona
```

```{r}
data_Barcelona_train <- data_Barcelona %>% 
      filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d"))
summary(data_Barcelona_train$fecha)
```

```{r}
data_Barcelona_test <- data_Barcelona %>% 
      filter(fecha > as.Date("2022-01-31", format = "%Y-%m-%d"))
summary(data_Barcelona_test$fecha)
```

```{r}
#| warning = FALSE
# Lamba for num_casos
lambda_Barcelona_casos <- data_asturias %>%
      features(num_casos, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Barcelona_casos

# Lamba for average temp
lambda_Barcelona_tmed <- data_asturias %>%
      features(tmed, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Barcelona_tmed

# Lamba for mobility
lambda_Barcelona_grocery <- data_asturias %>%
      features(mob_grocery_pharmacy, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Barcelona_grocery

lambda_Barcelona_parks <- data_asturias %>%
      features(mob_parks, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Barcelona_parks

lambda_Barcelona_resd <- data_asturias %>%
      features(mob_residential, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Barcelona_resd

lambda_Barcelona_retail <- data_asturias %>%
      features(mob_retail_recreation, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Barcelona_retail

lambda_Barcelona_transit <- data_asturias %>%
      features(mob_transit_stations, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Barcelona_transit

lambda_Barcelona_work <- data_asturias %>%
      features(mob_workplaces, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Barcelona_work
```

```{r}
fit_model <- data_Barcelona_train %>%
      model(
            arima_at1 = ARIMA(box_cox(num_casos, lambda_Barcelona_casos) ~ 
                                    box_cox(tmed, lambda_Barcelona_tmed) + 
                                    box_cox(mob_grocery_pharmacy, lambda_Barcelona_grocery) +
                                    box_cox(mob_parks, lambda_Barcelona_parks) +
                                    box_cox(mob_residential, lambda_Barcelona_resd) +
                                    box_cox(mob_retail_recreation, lambda_Barcelona_retail) +
                                    box_cox(mob_transit_stations, lambda_Barcelona_transit) +
                                    box_cox(mob_workplaces, lambda_Barcelona_work)
                              ),
            arima_at2 = ARIMA(box_cox(num_casos, lambda_Barcelona_casos) ~ 
                                    box_cox(tmed, lambda_Barcelona_tmed) + 
                                    box_cox(mob_grocery_pharmacy, lambda_Barcelona_grocery) +
                                    box_cox(mob_parks, lambda_Barcelona_parks) +
                                    box_cox(mob_residential, lambda_Barcelona_resd) +
                                    box_cox(mob_retail_recreation, lambda_Barcelona_retail) +
                                    box_cox(mob_transit_stations, lambda_Barcelona_transit) +
                                    box_cox(mob_workplaces, lambda_Barcelona_work),
                              stepwise = FALSE, approx = FALSE),
            Snaive = SNAIVE(box_cox(num_casos, lambda_Barcelona_casos))
      )

# Show and report model
fit_model
```

```{r}
glance(fit_model)
```

```{r}
#| warning = FALSE
fit_model %>% 
      pivot_longer(-provincia,
                   names_to = ".model",
                   values_to = "orders") %>% 
      left_join(glance(fit_model), by = c("provincia", ".model")) %>% 
      arrange(AICc) %>% 
      select(.model:BIC)
```

```{r}
#| warning = FALSE
# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise
fit_model %>% 
      select(Snaive) %>% 
      gg_tsresiduals()
```

```{r}
fit_model %>% 
      select(arima_at1) %>% 
      gg_tsresiduals()
```

```{r}
fit_model %>% 
      select(arima_at2) %>% 
      gg_tsresiduals()
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=7)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=14)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=21)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=57)
```

```{r}
# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility
# We are going to select those from the test dataset
data_fc_h7 <- data_Barcelona_test %>% 
      select(-num_casos) %>% 
      slice(1:7)
data_fc_h14 <- data_Barcelona_test %>% 
      select(-num_casos) %>% 
      slice(1:14)
data_fc_h21 <- data_Barcelona_test %>% 
      select(-num_casos) %>% 
      slice(1:21)
data_fc_h57 <- data_Barcelona_test %>% 
      select(-num_casos) %>% 
      slice(1:57)
```

```{r}
# Significant spikes out of 30 is still consistent with white noise
# To be sure, use a Ljung-Box test, which has a large p-value, confirming that
# the residuals are similar to white noise.
# Note that the alternative models also passed this test.
# 
# Forecast
fc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)
fc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)
fc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)
fc_h57 <- fabletools::forecast(fit_model, new_data = data_fc_h57)
```

### 7 days

```{r}
# Plots
fc_h7 %>%
      autoplot(
            data_Barcelona_test %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(7))
      ) +
      labs(y = "Nº cases", title = "Barcelona - forecast h7")
```

```{r}
fc_h7 %>%
      autoplot(
            data_Barcelona %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(7) &
                               fecha > as.Date("2022-01-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Barcelona - forecast h7")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h7, data_Barcelona)
```

### 14 days

```{r}
# Plots
fc_h14 %>%
      autoplot(
            data_Barcelona_test %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(14))
      ) +
      labs(y = "Nº cases", title = "Barcelona - forecast h14")
```

```{r}
fc_h14 %>%
      autoplot(
            data_Barcelona %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(14) &
                               fecha > as.Date("2022-01-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Barcelona - forecast h14")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h14, data_Barcelona)
```

### 21 days

```{r}
# Plots
fc_h21 %>%
      autoplot(
            data_Barcelona_test %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(21))
      ) +
      labs(y = "Nº cases", title = "Barcelona - forecast h21")
```

```{r}
fc_h21 %>%
      autoplot(
            data_Barcelona %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(21) &
                               fecha > as.Date("2022-01-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Barcelona - forecast h21")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h21, data_Barcelona)
```

### 57 days

```{r}
# Plots
fc_h57 %>%
      autoplot(
            data_Barcelona_test %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(57))
      ) +
      labs(y = "Nº cases", title = "Barcelona - forecast h57")
```

```{r}
fc_h57 %>%
      autoplot(
            data_Barcelona %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(57) &
                               fecha > as.Date("2022-01-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Barcelona - forecast h57")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h57, data_Barcelona)
```

## Madrid

```{r}
data_Madrid <- covid_data %>% 
      filter(provincia == "Madrid") %>% 
      filter(fecha > as.Date("2020-06-14", format = "%Y-%m-%d")) %>% 
      select(provincia, fecha, num_casos, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces) %>% 
      drop_na() %>% 
      as_tsibble(key = provincia, index = fecha)
data_Madrid
```

```{r}
data_Madrid_train <- data_Madrid %>% 
      filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d"))
summary(data_Madrid_train$fecha)
```

```{r}
data_Madrid_test <- data_Madrid %>% 
      filter(fecha > as.Date("2022-01-31", format = "%Y-%m-%d"))
summary(data_Madrid_test$fecha)
```

```{r}
#| warning = FALSE
# Lamba for num_casos
lambda_Madrid_casos <- data_asturias %>%
      features(num_casos, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Madrid_casos

# Lamba for average temp
lambda_Madrid_tmed <- data_asturias %>%
      features(tmed, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Madrid_tmed

# Lamba for mobility
lambda_Madrid_grocery <- data_asturias %>%
      features(mob_grocery_pharmacy, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Madrid_grocery

lambda_Madrid_parks <- data_asturias %>%
      features(mob_parks, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Madrid_parks

lambda_Madrid_resd <- data_asturias %>%
      features(mob_residential, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Madrid_resd

lambda_Madrid_retail <- data_asturias %>%
      features(mob_retail_recreation, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Madrid_retail

lambda_Madrid_transit <- data_asturias %>%
      features(mob_transit_stations, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Madrid_transit

lambda_Madrid_work <- data_asturias %>%
      features(mob_workplaces, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Madrid_work
```

```{r}
fit_model <- data_Madrid_train %>%
      model(
            arima_at1 = ARIMA(box_cox(num_casos, lambda_Madrid_casos) ~ 
                                    box_cox(tmed, lambda_Madrid_tmed) + 
                                    box_cox(mob_grocery_pharmacy, lambda_Madrid_grocery) +
                                    box_cox(mob_parks, lambda_Madrid_parks) +
                                    box_cox(mob_residential, lambda_Madrid_resd) +
                                    box_cox(mob_retail_recreation, lambda_Madrid_retail) +
                                    box_cox(mob_transit_stations, lambda_Madrid_transit) +
                                    box_cox(mob_workplaces, lambda_Madrid_work)
                              ),
            arima_at2 = ARIMA(box_cox(num_casos, lambda_Madrid_casos) ~ 
                                    box_cox(tmed, lambda_Madrid_tmed) + 
                                    box_cox(mob_grocery_pharmacy, lambda_Madrid_grocery) +
                                    box_cox(mob_parks, lambda_Madrid_parks) +
                                    box_cox(mob_residential, lambda_Madrid_resd) +
                                    box_cox(mob_retail_recreation, lambda_Madrid_retail) +
                                    box_cox(mob_transit_stations, lambda_Madrid_transit) +
                                    box_cox(mob_workplaces, lambda_Madrid_work),
                              stepwise = FALSE, approx = FALSE),
            Snaive = SNAIVE(box_cox(num_casos, lambda_Madrid_casos))
      )

# Show and report model
fit_model
```

```{r}
glance(fit_model)
```

```{r}
#| warning = FALSE
fit_model %>% 
      pivot_longer(-provincia,
                   names_to = ".model",
                   values_to = "orders") %>% 
      left_join(glance(fit_model), by = c("provincia", ".model")) %>% 
      arrange(AICc) %>% 
      select(.model:BIC)
```

```{r}
#| warning = FALSE
# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise
fit_model %>% 
      select(Snaive) %>% 
      gg_tsresiduals()
```

```{r}
fit_model %>% 
      select(arima_at1) %>% 
      gg_tsresiduals()
```

```{r}
fit_model %>% 
      select(arima_at2) %>% 
      gg_tsresiduals()
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=7)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=14)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=21)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=57)
```

```{r}
# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility
# We are going to select those from the test dataset
data_fc_h7 <- data_Madrid_test %>% 
      select(-num_casos) %>% 
      slice(1:7)
data_fc_h14 <- data_Madrid_test %>% 
      select(-num_casos) %>% 
      slice(1:14)
data_fc_h21 <- data_Madrid_test %>% 
      select(-num_casos) %>% 
      slice(1:21)
data_fc_h57 <- data_Madrid_test %>% 
      select(-num_casos) %>% 
      slice(1:57)
```

```{r}
# Significant spikes out of 30 is still consistent with white noise
# To be sure, use a Ljung-Box test, which has a large p-value, confirming that
# the residuals are similar to white noise.
# Note that the alternative models also passed this test.
# 
# Forecast
fc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)
fc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)
fc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)
fc_h57 <- fabletools::forecast(fit_model, new_data = data_fc_h57)
```

### 7 days

```{r}
# Plots
fc_h7 %>%
      autoplot(
            data_Madrid_test %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(7))
      ) +
      labs(y = "Nº cases", title = "Madrid - forecast h7")
```

```{r}
fc_h7 %>%
      autoplot(
            data_Madrid %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(7) &
                               fecha > as.Date("2022-01-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Madrid - forecast h7")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h7, data_Madrid)
```

### 14 days

```{r}
# Plots
fc_h14 %>%
      autoplot(
            data_Madrid_test %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(14))
      ) +
      labs(y = "Nº cases", title = "Madrid - forecast h14")
```

```{r}
fc_h14 %>%
      autoplot(
            data_Madrid %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(14) &
                               fecha > as.Date("2022-01-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Madrid - forecast h14")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h14, data_Madrid)
```

### 21 days

```{r}
# Plots
fc_h21 %>%
      autoplot(
            data_Madrid_test %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(21))
      ) +
      labs(y = "Nº cases", title = "Madrid - forecast h21")
```

```{r}
fc_h21 %>%
      autoplot(
            data_Madrid %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(21) &
                               fecha > as.Date("2022-01-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Madrid - forecast h21")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h21, data_Madrid)
```

### 57 days

```{r}
# Plots
fc_h57 %>%
      autoplot(
            data_Madrid_test %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(57))
      ) +
      labs(y = "Nº cases", title = "Madrid - forecast h57")
```

```{r}
fc_h57 %>%
      autoplot(
            data_Madrid %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(57) &
                               fecha > as.Date("2022-01-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Madrid - forecast h57")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h57, data_Madrid)
```

## Malaga

```{r}
data_Malaga <- covid_data %>% 
      filter(provincia == "Málaga") %>% 
      filter(fecha > as.Date("2020-06-14", format = "%Y-%m-%d")) %>% 
      select(provincia, fecha, num_casos, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces) %>% 
      drop_na() %>% 
      as_tsibble(key = provincia, index = fecha)
data_Malaga
```

```{r}
data_Malaga_train <- data_Malaga %>% 
      filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d"))
summary(data_Malaga_train$fecha)
```

```{r}
data_Malaga_test <- data_Malaga %>% 
      filter(fecha > as.Date("2022-01-31", format = "%Y-%m-%d"))
summary(data_Malaga_test$fecha)
```

```{r}
#| warning = FALSE
# Lamba for num_casos
lambda_Malaga_casos <- data_asturias %>%
      features(num_casos, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Malaga_casos

# Lamba for average temp
lambda_Malaga_tmed <- data_asturias %>%
      features(tmed, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Malaga_tmed

# Lamba for mobility
lambda_Malaga_grocery <- data_asturias %>%
      features(mob_grocery_pharmacy, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Malaga_grocery

lambda_Malaga_parks <- data_asturias %>%
      features(mob_parks, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Malaga_parks

lambda_Malaga_resd <- data_asturias %>%
      features(mob_residential, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Malaga_resd

lambda_Malaga_retail <- data_asturias %>%
      features(mob_retail_recreation, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Malaga_retail

lambda_Malaga_transit <- data_asturias %>%
      features(mob_transit_stations, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Malaga_transit

lambda_Malaga_work <- data_asturias %>%
      features(mob_workplaces, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Malaga_work
```

```{r}
fit_model <- data_Malaga_train %>%
      model(
            arima_at1 = ARIMA(box_cox(num_casos, lambda_Malaga_casos) ~ 
                                    box_cox(tmed, lambda_Malaga_tmed) + 
                                    box_cox(mob_grocery_pharmacy, lambda_Malaga_grocery) +
                                    box_cox(mob_parks, lambda_Malaga_parks) +
                                    box_cox(mob_residential, lambda_Malaga_resd) +
                                    box_cox(mob_retail_recreation, lambda_Malaga_retail) +
                                    box_cox(mob_transit_stations, lambda_Malaga_transit) +
                                    box_cox(mob_workplaces, lambda_Malaga_work)
                              ),
            arima_at2 = ARIMA(box_cox(num_casos, lambda_Malaga_casos) ~ 
                                    box_cox(tmed, lambda_Malaga_tmed) + 
                                    box_cox(mob_grocery_pharmacy, lambda_Malaga_grocery) +
                                    box_cox(mob_parks, lambda_Malaga_parks) +
                                    box_cox(mob_residential, lambda_Malaga_resd) +
                                    box_cox(mob_retail_recreation, lambda_Malaga_retail) +
                                    box_cox(mob_transit_stations, lambda_Malaga_transit) +
                                    box_cox(mob_workplaces, lambda_Malaga_work),
                              stepwise = FALSE, approx = FALSE),
            Snaive = SNAIVE(box_cox(num_casos, lambda_Malaga_casos))
      )

# Show and report model
fit_model
```

```{r}
glance(fit_model)
```

```{r}
#| warning = FALSE
fit_model %>% 
      pivot_longer(-provincia,
                   names_to = ".model",
                   values_to = "orders") %>% 
      left_join(glance(fit_model), by = c("provincia", ".model")) %>% 
      arrange(AICc) %>% 
      select(.model:BIC)
```

```{r}
#| warning = FALSE
# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise
fit_model %>% 
      select(Snaive) %>% 
      gg_tsresiduals()
```

```{r}
fit_model %>% 
      select(arima_at1) %>% 
      gg_tsresiduals()
```

```{r}
fit_model %>% 
      select(arima_at2) %>% 
      gg_tsresiduals()
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=7)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=14)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=21)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=57)
```

```{r}
# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility
# We are going to select those from the test dataset
data_fc_h7 <- data_Malaga_test %>% 
      select(-num_casos) %>% 
      slice(1:7)
data_fc_h14 <- data_Malaga_test %>% 
      select(-num_casos) %>% 
      slice(1:14)
data_fc_h21 <- data_Malaga_test %>% 
      select(-num_casos) %>% 
      slice(1:21)
data_fc_h57 <- data_Malaga_test %>% 
      select(-num_casos) %>% 
      slice(1:57)
```

```{r}
# Significant spikes out of 30 is still consistent with white noise
# To be sure, use a Ljung-Box test, which has a large p-value, confirming that
# the residuals are similar to white noise.
# Note that the alternative models also passed this test.
# 
# Forecast
fc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)
fc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)
fc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)
fc_h57 <- fabletools::forecast(fit_model, new_data = data_fc_h57)
```

### 7 days

```{r}
# Plots
fc_h7 %>%
      autoplot(
            data_Malaga_test %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(7))
      ) +
      labs(y = "Nº cases", title = "Malaga - forecast h7")
```

```{r}
fc_h7 %>%
      autoplot(
            data_Malaga %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(7) &
                               fecha > as.Date("2022-01-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Malaga - forecast h7")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h7, data_Malaga)
```

### 14 days

```{r}
# Plots
fc_h14 %>%
      autoplot(
            data_Malaga_test %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(14))
      ) +
      labs(y = "Nº cases", title = "Malaga - forecast h14")
```

```{r}
fc_h14 %>%
      autoplot(
            data_Malaga %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(14) &
                               fecha > as.Date("2022-01-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Malaga - forecast h14")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h14, data_Malaga)
```

### 21 days

```{r}
# Plots
fc_h21 %>%
      autoplot(
            data_Malaga_test %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(21))
      ) +
      labs(y = "Nº cases", title = "Malaga - forecast h21")
```

```{r}
fc_h21 %>%
      autoplot(
            data_Malaga %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(21) &
                               fecha > as.Date("2022-01-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Malaga - forecast h21")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h21, data_Malaga)
```

### 57 days

```{r}
# Plots
fc_h57 %>%
      autoplot(
            data_Malaga_test %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(57))
      ) +
      labs(y = "Nº cases", title = "Malaga - forecast h57")
```

```{r}
fc_h57 %>%
      autoplot(
            data_Malaga %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(57) &
                               fecha > as.Date("2022-01-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Malaga - forecast h57")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h57, data_Malaga)
```

## Sevilla

```{r}
data_Sevilla <- covid_data %>% 
      filter(provincia == "Sevilla") %>% 
      filter(fecha > as.Date("2020-06-14", format = "%Y-%m-%d")) %>% 
      select(provincia, fecha, num_casos, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces) %>% 
      drop_na() %>% 
      as_tsibble(key = provincia, index = fecha)
data_Sevilla
```

```{r}
data_Sevilla_train <- data_Sevilla %>% 
      filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d"))
summary(data_Sevilla_train$fecha)
```

```{r}
data_Sevilla_test <- data_Sevilla %>% 
      filter(fecha > as.Date("2022-01-31", format = "%Y-%m-%d"))
summary(data_Sevilla_test$fecha)
```

```{r}
#| warning = FALSE
# Lamba for num_casos
lambda_Sevilla_casos <- data_asturias %>%
      features(num_casos, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Sevilla_casos

# Lamba for average temp
lambda_Sevilla_tmed <- data_asturias %>%
      features(tmed, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Sevilla_tmed

# Lamba for mobility
lambda_Sevilla_grocery <- data_asturias %>%
      features(mob_grocery_pharmacy, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Sevilla_grocery

lambda_Sevilla_parks <- data_asturias %>%
      features(mob_parks, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Sevilla_parks

lambda_Sevilla_resd <- data_asturias %>%
      features(mob_residential, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Sevilla_resd

lambda_Sevilla_retail <- data_asturias %>%
      features(mob_retail_recreation, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Sevilla_retail

lambda_Sevilla_transit <- data_asturias %>%
      features(mob_transit_stations, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Sevilla_transit

lambda_Sevilla_work <- data_asturias %>%
      features(mob_workplaces, features = guerrero) %>%
      pull(lambda_guerrero)
lambda_Sevilla_work
```

```{r}
fit_model <- data_Sevilla_train %>%
      model(
            arima_at1 = ARIMA(box_cox(num_casos, lambda_Sevilla_casos) ~ 
                                    box_cox(tmed, lambda_Sevilla_tmed) + 
                                    box_cox(mob_grocery_pharmacy, lambda_Sevilla_grocery) +
                                    box_cox(mob_parks, lambda_Sevilla_parks) +
                                    box_cox(mob_residential, lambda_Sevilla_resd) +
                                    box_cox(mob_retail_recreation, lambda_Sevilla_retail) +
                                    box_cox(mob_transit_stations, lambda_Sevilla_transit) +
                                    box_cox(mob_workplaces, lambda_Sevilla_work)
                              ),
            arima_at2 = ARIMA(box_cox(num_casos, lambda_Sevilla_casos) ~ 
                                    box_cox(tmed, lambda_Sevilla_tmed) + 
                                    box_cox(mob_grocery_pharmacy, lambda_Sevilla_grocery) +
                                    box_cox(mob_parks, lambda_Sevilla_parks) +
                                    box_cox(mob_residential, lambda_Sevilla_resd) +
                                    box_cox(mob_retail_recreation, lambda_Sevilla_retail) +
                                    box_cox(mob_transit_stations, lambda_Sevilla_transit) +
                                    box_cox(mob_workplaces, lambda_Sevilla_work),
                              stepwise = FALSE, approx = FALSE),
            Snaive = SNAIVE(box_cox(num_casos, lambda_Sevilla_casos))
      )

# Show and report model
fit_model
```

```{r}
glance(fit_model)
```

```{r}
#| warning = FALSE
fit_model %>% 
      pivot_longer(-provincia,
                   names_to = ".model",
                   values_to = "orders") %>% 
      left_join(glance(fit_model), by = c("provincia", ".model")) %>% 
      arrange(AICc) %>% 
      select(.model:BIC)
```

```{r}
#| warning = FALSE
# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise
fit_model %>% 
      select(Snaive) %>% 
      gg_tsresiduals()
```

```{r}
fit_model %>% 
      select(arima_at1) %>% 
      gg_tsresiduals()
```

```{r}
fit_model %>% 
      select(arima_at2) %>% 
      gg_tsresiduals()
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=7)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=14)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=21)
```

```{r}
augment(fit_model) %>%
      features(.innov, ljung_box, lag=57)
```

```{r}
# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility
# We are going to select those from the test dataset
data_fc_h7 <- data_Sevilla_test %>% 
      select(-num_casos) %>% 
      slice(1:7)
data_fc_h14 <- data_Sevilla_test %>% 
      select(-num_casos) %>% 
      slice(1:14)
data_fc_h21 <- data_Sevilla_test %>% 
      select(-num_casos) %>% 
      slice(1:21)
data_fc_h57 <- data_Sevilla_test %>% 
      select(-num_casos) %>% 
      slice(1:57)
```

```{r}
# Significant spikes out of 30 is still consistent with white noise
# To be sure, use a Ljung-Box test, which has a large p-value, confirming that
# the residuals are similar to white noise.
# Note that the alternative models also passed this test.
# 
# Forecast
fc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)
fc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)
fc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)
fc_h57 <- fabletools::forecast(fit_model, new_data = data_fc_h57)
```

### 7 days

```{r}
# Plots
fc_h7 %>%
      autoplot(
            data_Sevilla_test %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(7))
      ) +
      labs(y = "Nº cases", title = "Sevilla - forecast h7")
```

```{r}
fc_h7 %>%
      autoplot(
            data_Sevilla %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(7) &
                               fecha > as.Date("2022-01-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Sevilla - forecast h7")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h7, data_Sevilla)
```

### 14 days

```{r}
# Plots
fc_h14 %>%
      autoplot(
            data_Sevilla_test %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(14))
      ) +
      labs(y = "Nº cases", title = "Sevilla - forecast h14")
```

```{r}
fc_h14 %>%
      autoplot(
            data_Sevilla %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(14) &
                               fecha > as.Date("2022-01-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Sevilla - forecast h14")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h14, data_Sevilla)
```

### 21 days

```{r}
# Plots
fc_h21 %>%
      autoplot(
            data_Sevilla_test %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(21))
      ) +
      labs(y = "Nº cases", title = "Sevilla - forecast h21")
```

```{r}
fc_h21 %>%
      autoplot(
            data_Sevilla %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(21) &
                               fecha > as.Date("2022-01-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Sevilla - forecast h21")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h21, data_Sevilla)
```

### 57 days

```{r}
# Plots
fc_h57 %>%
      autoplot(
            data_Sevilla_test %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(57))
      ) +
      labs(y = "Nº cases", title = "Sevilla - forecast h57")
```

```{r}
fc_h57 %>%
      autoplot(
            data_Sevilla %>% 
                  filter(fecha <= as.Date("2022-01-31", format = "%Y-%m-%d")+days(57) &
                               fecha > as.Date("2022-01-01", format = "%Y-%m-%d"))
      ) +
      labs(y = "Nº cases", title = "Sevilla - forecast h57")
```

```{r}
# Accuracy
fabletools::accuracy(fc_h57, data_Sevilla)
```
