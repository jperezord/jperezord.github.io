<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.442">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>PEC3 - COVID-19 Outbreak prediction - LSTM univariate prediction</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<link href="./lstm_multi.html" rel="next">
<link href="./lstm.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link id="quarto-text-highlighting-styles" href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">LSTM univariate prediction</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">PEC3 - COVID-19 Outbreak prediction</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/jperezord/jperezord.github.io.git" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Welcome</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">Introduction</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./data.html" class="sidebar-item-text sidebar-link">Task 1: Data acquisition and exploration</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cne_data.html" class="sidebar-item-text sidebar-link">CNE data</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ine_data.html" class="sidebar-item-text sidebar-link">INE data</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./google_data.html" class="sidebar-item-text sidebar-link">GOOGLE data</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./aemet_data.html" class="sidebar-item-text sidebar-link">AEMET data</a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./combination.html" class="sidebar-item-text sidebar-link">Task 2: Datasets combination</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visual.html" class="sidebar-item-text sidebar-link">Task 3: Visual analysis</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visual_demo.html" class="sidebar-item-text sidebar-link">Task 4: Visual demographic analysis</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./arima.html" class="sidebar-item-text sidebar-link">Task 5: ARIMA</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./acf.html" class="sidebar-item-text sidebar-link">ACF and PACF plots</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./stl.html" class="sidebar-item-text sidebar-link">STL decomposition / Transformations</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./univariate.html" class="sidebar-item-text sidebar-link">Univariate prediction</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multivariate_temp.html" class="sidebar-item-text sidebar-link">Multivariate (temperature) prediction</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multivariate.html" class="sidebar-item-text sidebar-link">Multivariate (INE mobility + temp) prediction</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multivariate_google.html" class="sidebar-item-text sidebar-link">Multivariate (Google mobility + temp) prediction</a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./lstm.html" class="sidebar-item-text sidebar-link">Task 6: LSTM</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lstm_uni.html" class="sidebar-item-text sidebar-link active">LSTM univariate prediction</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lstm_multi.html" class="sidebar-item-text sidebar-link">LSTM multivariate prediction</a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#all-the-available-data" id="toc-all-the-available-data" class="nav-link active" data-scroll-target="#all-the-available-data">All the available data</a>
  <ul class="collapse">
  <li><a href="#asturias" id="toc-asturias" class="nav-link" data-scroll-target="#asturias">Asturias</a></li>
  <li><a href="#barcelona" id="toc-barcelona" class="nav-link" data-scroll-target="#barcelona">Barcelona</a></li>
  <li><a href="#madrid" id="toc-madrid" class="nav-link" data-scroll-target="#madrid">Madrid</a></li>
  <li><a href="#malaga" id="toc-malaga" class="nav-link" data-scroll-target="#malaga">Malaga</a></li>
  <li><a href="#sevilla" id="toc-sevilla" class="nav-link" data-scroll-target="#sevilla">Sevilla</a></li>
  </ul></li>
  <li><a href="#just-before-the-sixth-wave" id="toc-just-before-the-sixth-wave" class="nav-link" data-scroll-target="#just-before-the-sixth-wave">Just before the sixth wave</a>
  <ul class="collapse">
  <li><a href="#asturias-1" id="toc-asturias-1" class="nav-link" data-scroll-target="#asturias-1">Asturias</a></li>
  <li><a href="#barcelona-1" id="toc-barcelona-1" class="nav-link" data-scroll-target="#barcelona-1">Barcelona</a></li>
  <li><a href="#madrid-1" id="toc-madrid-1" class="nav-link" data-scroll-target="#madrid-1">Madrid</a></li>
  <li><a href="#malaga-1" id="toc-malaga-1" class="nav-link" data-scroll-target="#malaga-1">Malaga</a></li>
  <li><a href="#sevilla-1" id="toc-sevilla-1" class="nav-link" data-scroll-target="#sevilla-1">Sevilla</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">LSTM univariate prediction</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<p>Import python packages:</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> MinMaxScaler</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_absolute_error, mean_squared_error</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras <span class="im">import</span> Input</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.models <span class="im">import</span> Sequential</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> Dense, LSTM</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers.core <span class="im">import</span> Dense, Activation, Dropout</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>data_covid <span class="op">=</span> pd.read_csv(<span class="st">'data/clean/final_covid_data.csv'</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>data_covid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>provincia</th>
      <th>fecha</th>
      <th>num_casos</th>
      <th>num_casos_prueba_pcr</th>
      <th>num_casos_prueba_test_ac</th>
      <th>num_casos_prueba_ag</th>
      <th>num_casos_prueba_elisa</th>
      <th>num_casos_prueba_desconocida</th>
      <th>num_hosp</th>
      <th>num_uci</th>
      <th>...</th>
      <th>ws</th>
      <th>ws_max</th>
      <th>sol</th>
      <th>mob_grocery_pharmacy</th>
      <th>mob_parks</th>
      <th>mob_residential</th>
      <th>mob_retail_recreation</th>
      <th>mob_transit_stations</th>
      <th>mob_workplaces</th>
      <th>mob_flujo</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Barcelona</td>
      <td>2020-01-01</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>2.5</td>
      <td>7.2</td>
      <td>4.9</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Madrid</td>
      <td>2020-01-01</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>...</td>
      <td>0.8</td>
      <td>3.6</td>
      <td>8.3</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Málaga</td>
      <td>2020-01-01</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>3.3</td>
      <td>6.7</td>
      <td>7.7</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Asturias</td>
      <td>2020-01-01</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>2.5</td>
      <td>7.8</td>
      <td>7.9</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Sevilla</td>
      <td>2020-01-01</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>...</td>
      <td>1.9</td>
      <td>5.8</td>
      <td>9.1</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>4090</th>
      <td>Barcelona</td>
      <td>2022-03-29</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>7.2</td>
      <td>13.3</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-13.0</td>
      <td>5.0</td>
      <td>-24.0</td>
      <td>-16.0</td>
      <td>-17.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4091</th>
      <td>Madrid</td>
      <td>2022-03-29</td>
      <td>6</td>
      <td>3</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>2.2</td>
      <td>6.1</td>
      <td>2.4</td>
      <td>1.0</td>
      <td>-11.0</td>
      <td>4.0</td>
      <td>-25.0</td>
      <td>-16.0</td>
      <td>-16.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4092</th>
      <td>Málaga</td>
      <td>2022-03-29</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>4.2</td>
      <td>10.8</td>
      <td>1.5</td>
      <td>4.0</td>
      <td>-3.0</td>
      <td>4.0</td>
      <td>-16.0</td>
      <td>1.0</td>
      <td>-8.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4093</th>
      <td>Asturias</td>
      <td>2022-03-29</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>...</td>
      <td>2.2</td>
      <td>6.7</td>
      <td>0.0</td>
      <td>-4.0</td>
      <td>17.0</td>
      <td>3.0</td>
      <td>-25.0</td>
      <td>-15.0</td>
      <td>-12.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4094</th>
      <td>Sevilla</td>
      <td>2022-03-29</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>2.5</td>
      <td>8.3</td>
      <td>1.6</td>
      <td>3.0</td>
      <td>-7.0</td>
      <td>2.0</td>
      <td>-15.0</td>
      <td>-13.0</td>
      <td>-5.0</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>4095 rows × 26 columns</p>
</div>
</div>
</div>
<section id="all-the-available-data" class="level1">
<h1>All the available data</h1>
<p>We will only detele data from the first wave since it is not reliable.</p>
<section id="asturias" class="level2">
<h2 class="anchored" data-anchor-id="asturias">Asturias</h2>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>data_asturias <span class="op">=</span> data_covid.loc[data_covid[<span class="st">'provincia'</span>] <span class="op">==</span> <span class="st">'Asturias'</span>]</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>data_asturias <span class="op">=</span> data_asturias.set_index(<span class="st">'fecha'</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>data_asturias <span class="op">=</span> data_asturias.<span class="bu">filter</span>([<span class="st">'num_casos'</span>])</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>data_asturias <span class="op">=</span> data_asturias[<span class="st">'2020-06-14'</span>:]</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>data_asturias</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
    </tr>
    <tr>
      <th>fecha</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-14</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2020-06-15</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2020-06-16</th>
      <td>1</td>
    </tr>
    <tr>
      <th>2020-06-17</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2020-06-18</th>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>2022-03-25</th>
      <td>244</td>
    </tr>
    <tr>
      <th>2022-03-26</th>
      <td>432</td>
    </tr>
    <tr>
      <th>2022-03-27</th>
      <td>1</td>
    </tr>
    <tr>
      <th>2022-03-28</th>
      <td>9</td>
    </tr>
    <tr>
      <th>2022-03-29</th>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>654 rows × 1 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>data_asturias.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>654.00000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>312.11315</td>
    </tr>
    <tr>
      <th>std</th>
      <td>565.17985</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>43.50000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>117.00000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>323.75000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>3827.00000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>np_data_asturias <span class="op">=</span> data_asturias.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias <span class="op">=</span> scaler.fit_transform(np_data_asturias)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud del conjunto de datos disponible: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_asturias)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud del conjunto de datos disponible: 654</code></pre>
</div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we are going to predict future values based on the X past elements, </span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to create a list with those historic information for each element</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>historic_values <span class="op">=</span> <span class="dv">90</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias_x <span class="op">=</span> []</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias_y <span class="op">=</span> []</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> num_casos_i <span class="kw">in</span> <span class="bu">range</span>(historic_values, <span class="bu">len</span>(scaled_data_asturias)):</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    scaled_data_asturias_x.append(scaled_data_asturias[(num_casos_i<span class="op">-</span>historic_values):num_casos_i, <span class="dv">0</span>])</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    scaled_data_asturias_y.append(scaled_data_asturias[num_casos_i, <span class="dv">0</span>])</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the x_train and y_train to numpy arrays</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias_x <span class="op">=</span> np.array(scaled_data_asturias_x)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias_y <span class="op">=</span> np.array(scaled_data_asturias_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train data looks like</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias_x[<span class="dv">235</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>array([0.07002874, 0.0611445 , 0.07107395, 0.07394826, 0.06689313,
       0.05644108, 0.05278286, 0.03841129, 0.03501437, 0.04285341,
       0.04990854, 0.05016985, 0.04285341, 0.03710478, 0.03057225,
       0.03240136, 0.03945649, 0.03971779, 0.03762738, 0.04311471,
       0.02926574, 0.02691403, 0.03945649, 0.03919519, 0.03396917,
       0.04206951, 0.03684348, 0.03841129, 0.03475307, 0.02795924,
       0.02560753, 0.02743663, 0.03788869, 0.03814999, 0.02769794,
       0.03031095, 0.02822054, 0.03893389, 0.03240136, 0.03553697,
       0.03971779, 0.01802979, 0.01646198, 0.03004965, 0.03109485,
       0.02926574, 0.04468252, 0.03266266, 0.02482362, 0.03031095,
       0.03109485, 0.03893389, 0.03579828, 0.02325581, 0.03841129,
       0.0195976 , 0.02508492, 0.02456232, 0.03057225, 0.03527567,
       0.03919519, 0.03605958, 0.02534622, 0.02926574, 0.03240136,
       0.04807944, 0.0399791 , 0.03396917, 0.02743663, 0.02325581,
       0.02613013, 0.03083355, 0.03788869, 0.02848184, 0.03344656,
       0.03396917, 0.02822054, 0.02247191, 0.02351712, 0.02586883,
       0.02534622, 0.02874314, 0.0198589 , 0.0211654 , 0.01254246,
       0.01907499, 0.01228116, 0.01228116, 0.01881369, 0.01515547])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test data looks like</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias_y[<span class="dv">235</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>0.013326365299189964</code></pre>
</div>
</div>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since the first 90 values does not have historic, the dataset has been reduced in 90 values</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud datos de entrenamiento con historico: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_asturias_y)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud datos de entrenamiento con historico: 564</code></pre>
</div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we split data in train and test</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as in previous analysis, we are going to predict a maximum of 21 days</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> scaled_data_asturias_x[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_asturias_x)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> scaled_data_asturias_y[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_asturias_y)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de entrenamiento: x=</span><span class="sc">{</span><span class="bu">len</span>(x_train)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> scaled_data_asturias_x[<span class="bu">len</span>(scaled_data_asturias_x)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_asturias_x)]</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaled_data_asturias_y[<span class="bu">len</span>(scaled_data_asturias_y)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_asturias_y)]</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de test: x=</span><span class="sc">{</span><span class="bu">len</span>(x_test)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_test)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cantidad datos de entrenamiento: x=473 - y=473
Cantidad datos de test: x=90 - y=90</code></pre>
</div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data to feed de recurrent network</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> np.reshape(x_train, (x_train.shape[<span class="dv">0</span>], x_train.shape[<span class="dv">1</span>], <span class="dv">1</span>))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train data shape:"</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_train.shape)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_train.shape)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> np.reshape(x_test, (x_test.shape[<span class="dv">0</span>], x_test.shape[<span class="dv">1</span>], <span class="dv">1</span>))</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test data shape:"</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_test.shape)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train data shape:
(473, 90, 1)
(473,)
Test data shape:
(90, 90, 1)
(90,)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># # Configure / setup the neural network model - LSTM</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the model</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Build model...'</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with Neurons </span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputshape = neurons -&gt; Timestamps</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>neurons<span class="op">=</span> x_train.shape[<span class="dv">1</span>]</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">90</span>, </span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>, </span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>               input_shape <span class="op">=</span> (x_train.shape[<span class="dv">1</span>], <span class="dv">1</span>))) </span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">50</span>, </span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>)) </span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">25</span>, </span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">False</span>)) </span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">5</span>, activation <span class="op">=</span> <span class="st">'relu'</span>))</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Build model...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2022-05-25 01:22:54.266575: I tensorflow/core/platform/cpu_feature_guard.cc:193] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.</code></pre>
</div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mean_squared_error'</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "sequential"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Layer (type)                Output Shape              Param #   </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm (LSTM)                 (None, 90, 90)            33120     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_1 (LSTM)               (None, 90, 50)            28200     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_2 (LSTM)               (None, 25)                7600      </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense (Dense)               (None, 5)                 130       </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_1 (Dense)             (None, 1)                 6         </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Total params: 69,056</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Trainable params: 69,056</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Non-trainable params: 0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
</div>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="co"># # fit network</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(x_train, </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>                    y_train, </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>                    batch_size<span class="op">=</span><span class="dv">1000</span>, </span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>                    epochs <span class="op">=</span> <span class="dv">30</span>, </span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>                    validation_data <span class="op">=</span> (x_test, y_test), </span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>                    verbose <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'loss'</span>], label<span class="op">=</span><span class="st">'train'</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'val_loss'</span>], label<span class="op">=</span><span class="st">'test'</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>plt.show() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_uni_files/figure-html/cell-17-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predicted values</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.predict(x_test)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> scaler.inverse_transform(predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1/3 [=========&gt;....................] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - 0s 31ms/step</code></pre>
</div>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y_test.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaler.inverse_transform(y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean absolute error (MAE)</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, predictions)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MAE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(mae, <span class="dv">1</span>)))</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test,predictions))</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> mean_squared_error(y_test, </span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>                          predictions,</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>                          squared <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE: 1074.0
RMSE: 1479.1
RMSE: 1479.1</code></pre>
</div>
</div>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the difference between the valid and predicted prices</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> data_asturias[:(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">92</span>)]</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> data_asturias[(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">91</span>):]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Predictions"</span>, predictions, <span class="va">True</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Difference"</span>, valid[<span class="st">"Predictions"</span>] <span class="op">-</span> valid[<span class="st">"num_casos"</span>], <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Zoom-in to a closer timeframe</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Date from which on the date is displayed</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>display_start_date <span class="op">=</span> <span class="st">"2021-10-31"</span> </span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> valid[valid.index <span class="op">&gt;</span> display_start_date]</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> train[train.index <span class="op">&gt;</span> display_start_date]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the data</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>matplotlib.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">22</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Train</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> train.index<span class="op">;</span> </span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> train[[<span class="st">"num_casos"</span>]]</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Test / validation </span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>xv <span class="op">=</span> valid.index<span class="op">;</span> </span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>yv <span class="op">=</span> valid[[<span class="st">"num_casos"</span>, <span class="st">"Predictions"</span>]]</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Asturias: Predictions vs Real infections"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Nº Cases"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>plt.plot(yt, color<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"Predictions"</span>], color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"num_casos"</span>], color<span class="op">=</span><span class="st">"green"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"LSTM Predictions"</span>, <span class="st">"Test"</span>], </span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>           loc<span class="op">=</span><span class="st">"upper left"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot with the differences</span></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> valid.index</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> valid[<span class="st">"Difference"</span>]</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>plt.bar(x, y, width<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">"grey"</span>)</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_uni_files/figure-html/cell-24-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="barcelona" class="level2">
<h2 class="anchored" data-anchor-id="barcelona">Barcelona</h2>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>data_Barcelona <span class="op">=</span> data_covid.loc[data_covid[<span class="st">'provincia'</span>] <span class="op">==</span> <span class="st">'Barcelona'</span>]</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>data_Barcelona <span class="op">=</span> data_Barcelona.set_index(<span class="st">'fecha'</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>data_Barcelona <span class="op">=</span> data_Barcelona.<span class="bu">filter</span>([<span class="st">'num_casos'</span>])</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>data_Barcelona <span class="op">=</span> data_Barcelona[<span class="st">'2020-06-14'</span>:]</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>data_Barcelona</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
    </tr>
    <tr>
      <th>fecha</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-14</th>
      <td>33</td>
    </tr>
    <tr>
      <th>2020-06-15</th>
      <td>62</td>
    </tr>
    <tr>
      <th>2020-06-16</th>
      <td>66</td>
    </tr>
    <tr>
      <th>2020-06-17</th>
      <td>70</td>
    </tr>
    <tr>
      <th>2020-06-18</th>
      <td>68</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>2022-03-25</th>
      <td>598</td>
    </tr>
    <tr>
      <th>2022-03-26</th>
      <td>345</td>
    </tr>
    <tr>
      <th>2022-03-27</th>
      <td>252</td>
    </tr>
    <tr>
      <th>2022-03-28</th>
      <td>688</td>
    </tr>
    <tr>
      <th>2022-03-29</th>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>654 rows × 1 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>data_Barcelona.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>654.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>2605.048930</td>
    </tr>
    <tr>
      <th>std</th>
      <td>4823.001644</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>597.250000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>1030.500000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>2243.750000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>34701.000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>np_data_Barcelona <span class="op">=</span> data_Barcelona.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Barcelona <span class="op">=</span> scaler.fit_transform(np_data_Barcelona)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud del conjunto de datos disponible: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_Barcelona)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud del conjunto de datos disponible: 654</code></pre>
</div>
</div>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we are going to predict future values based on the 90 past elements, </span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to create a list with those historic information for each element</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>historic_values <span class="op">=</span> <span class="dv">90</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>scaled_data_Barcelona_x <span class="op">=</span> []</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>scaled_data_Barcelona_y <span class="op">=</span> []</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> num_casos_i <span class="kw">in</span> <span class="bu">range</span>(historic_values, <span class="bu">len</span>(scaled_data_Barcelona)):</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    scaled_data_Barcelona_x.append(scaled_data_Barcelona[(num_casos_i<span class="op">-</span>historic_values):num_casos_i, <span class="dv">0</span>])</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    scaled_data_Barcelona_y.append(scaled_data_Barcelona[num_casos_i, <span class="dv">0</span>])</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the x_train and y_train to numpy arrays</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>scaled_data_Barcelona_x <span class="op">=</span> np.array(scaled_data_Barcelona_x)</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>scaled_data_Barcelona_y <span class="op">=</span> np.array(scaled_data_Barcelona_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train data looks like</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Barcelona_x[<span class="dv">235</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>array([0.05037319, 0.04726089, 0.02899052, 0.02507132, 0.04639636,
       0.04190081, 0.03749171, 0.03527276, 0.03786634, 0.02619521,
       0.02351517, 0.04077692, 0.03760699, 0.03587793, 0.0364831 ,
       0.03120948, 0.02449497, 0.02083513, 0.03792398, 0.03613729,
       0.03195873, 0.02754964, 0.02818363, 0.02025878, 0.01752111,
       0.03484049, 0.03037376, 0.02870234, 0.0233999 , 0.02610876,
       0.01876027, 0.01645486, 0.0282989 , 0.02625285, 0.02680038,
       0.02564768, 0.02596467, 0.01953834, 0.01746347, 0.03184346,
       0.02973978, 0.02573413, 0.02838535, 0.02919224, 0.02190139,
       0.01890435, 0.03720354, 0.03642546, 0.0325639 , 0.0304314 ,
       0.03556093, 0.02524423, 0.02149794, 0.03803925, 0.03426414,
       0.03048903, 0.03365897, 0.02218956, 0.02530186, 0.02533068,
       0.02832771, 0.03835624, 0.03740526, 0.03512867, 0.03680009,
       0.02855825, 0.02118095, 0.03878851, 0.03507104, 0.03985476,
       0.03155529, 0.03394715, 0.02423561, 0.02169966, 0.03953777,
       0.04596409, 0.0350134 , 0.0395954 , 0.03267917, 0.02772254,
       0.02380335, 0.04668453, 0.04213135, 0.03806807, 0.03671364,
       0.03509985, 0.02106568, 0.01694476, 0.03803925, 0.02815481])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test data looks like</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Barcelona_y[<span class="dv">235</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>0.030661940578081325</code></pre>
</div>
</div>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since the first 90th values does not have historic, the dataset has been reduced in 90 values</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud datos de entrenamiento con historico: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_Barcelona_y)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud datos de entrenamiento con historico: 564</code></pre>
</div>
</div>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we split data in train and test</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as in previous analysis, we are going to predict a maximum of 90 days</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> scaled_data_Barcelona_x[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_Barcelona_x)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> scaled_data_Barcelona_y[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_Barcelona_y)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de entrenamiento: x=</span><span class="sc">{</span><span class="bu">len</span>(x_train)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> scaled_data_Barcelona_x[<span class="bu">len</span>(scaled_data_Barcelona_x)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_Barcelona_x)]</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaled_data_Barcelona_y[<span class="bu">len</span>(scaled_data_Barcelona_y)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_Barcelona_y)]</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de test: x=</span><span class="sc">{</span><span class="bu">len</span>(x_test)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_test)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cantidad datos de entrenamiento: x=473 - y=473
Cantidad datos de test: x=90 - y=90</code></pre>
</div>
</div>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data to feed de recurrent network</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> np.reshape(x_train, (x_train.shape[<span class="dv">0</span>], x_train.shape[<span class="dv">1</span>], <span class="dv">1</span>))</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train data shape:"</span>)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_train.shape)</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_train.shape)</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> np.reshape(x_test, (x_test.shape[<span class="dv">0</span>], x_test.shape[<span class="dv">1</span>], <span class="dv">1</span>))</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test data shape:"</span>)</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_test.shape)</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train data shape:
(473, 90, 1)
(473,)
Test data shape:
(90, 90, 1)
(90,)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure / setup the neural network model - LSTM</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the model</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Build model...'</span>)</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with Neurons </span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputshape = neurons -&gt; Timestamps</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>neurons<span class="op">=</span> x_train.shape[<span class="dv">1</span>]</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">90</span>, </span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>, </span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>               input_shape <span class="op">=</span> (x_train.shape[<span class="dv">1</span>], <span class="dv">1</span>))) </span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">50</span>, </span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>)) </span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">25</span>, </span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">False</span>)) </span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">5</span>, activation <span class="op">=</span> <span class="st">'relu'</span>))</span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Build model...</code></pre>
</div>
</div>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mean_squared_error'</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "sequential_1"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Layer (type)                Output Shape              Param #   </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_3 (LSTM)               (None, 90, 90)            33120     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_4 (LSTM)               (None, 90, 50)            28200     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_5 (LSTM)               (None, 25)                7600      </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_2 (Dense)             (None, 5)                 130       </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_3 (Dense)             (None, 1)                 6         </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Total params: 69,056</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Trainable params: 69,056</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Non-trainable params: 0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
</div>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fit network</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(x_train, </span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>                    y_train, </span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>                    batch_size <span class="op">=</span> <span class="dv">1000</span>, </span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>                    epochs <span class="op">=</span> <span class="dv">30</span>, </span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>                    validation_data <span class="op">=</span> (x_test, y_test), </span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>                    verbose <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'loss'</span>], label<span class="op">=</span><span class="st">'train'</span>)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'val_loss'</span>], label<span class="op">=</span><span class="st">'test'</span>)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>plt.show() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_uni_files/figure-html/cell-38-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predicted values</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.predict(x_test)</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> scaler.inverse_transform(predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1/3 [=========&gt;....................] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - 0s 31ms/step</code></pre>
</div>
</div>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y_test.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaler.inverse_transform(y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean absolute error (MAE)</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, predictions)</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MAE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(mae, <span class="dv">1</span>)))</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test,predictions))</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> mean_squared_error(y_test, </span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>                          predictions,</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>                          squared <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE: 5228.7
RMSE: 7609.8
RMSE: 7609.8</code></pre>
</div>
</div>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the difference between the valid and predicted prices</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> data_Barcelona[:(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">92</span>)]</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> data_Barcelona[(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">91</span>):]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Predictions"</span>, predictions, <span class="va">True</span>)</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Difference"</span>, valid[<span class="st">"Predictions"</span>] <span class="op">-</span> valid[<span class="st">"num_casos"</span>], <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Zoom-in to a closer timeframe</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Date from which on the date is displayed</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>display_start_date <span class="op">=</span> <span class="st">"2021-10-31"</span> </span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> valid[valid.index <span class="op">&gt;</span> display_start_date]</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> train[train.index <span class="op">&gt;</span> display_start_date]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the data</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>matplotlib.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">22</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Train</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> train.index<span class="op">;</span> </span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> train[[<span class="st">"num_casos"</span>]]</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Test / validation </span></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>xv <span class="op">=</span> valid.index<span class="op">;</span> </span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>yv <span class="op">=</span> valid[[<span class="st">"num_casos"</span>, <span class="st">"Predictions"</span>]]</span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Barcelona: Predictions vs Real infections"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Nº Cases"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>plt.plot(yt, color<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"Predictions"</span>], color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"num_casos"</span>], color<span class="op">=</span><span class="st">"green"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"LSTM Predictions"</span>, <span class="st">"Test"</span>], </span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a>           loc<span class="op">=</span><span class="st">"upper left"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot with the differences</span></span>
<span id="cb105-23"><a href="#cb105-23" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> valid.index</span>
<span id="cb105-24"><a href="#cb105-24" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> valid[<span class="st">"Difference"</span>]</span>
<span id="cb105-25"><a href="#cb105-25" aria-hidden="true" tabindex="-1"></a>plt.bar(x, y, width<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">"grey"</span>)</span>
<span id="cb105-26"><a href="#cb105-26" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb105-27"><a href="#cb105-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_uni_files/figure-html/cell-45-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="madrid" class="level2">
<h2 class="anchored" data-anchor-id="madrid">Madrid</h2>
<div class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>data_Madrid <span class="op">=</span> data_covid.loc[data_covid[<span class="st">'provincia'</span>] <span class="op">==</span> <span class="st">'Madrid'</span>]</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>data_Madrid <span class="op">=</span> data_Madrid.set_index(<span class="st">'fecha'</span>)</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>data_Madrid <span class="op">=</span> data_Madrid.<span class="bu">filter</span>([<span class="st">'num_casos'</span>])</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>data_Madrid <span class="op">=</span> data_Madrid[<span class="st">'2020-06-14'</span>:]</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>data_Madrid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
    </tr>
    <tr>
      <th>fecha</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-14</th>
      <td>81</td>
    </tr>
    <tr>
      <th>2020-06-15</th>
      <td>153</td>
    </tr>
    <tr>
      <th>2020-06-16</th>
      <td>91</td>
    </tr>
    <tr>
      <th>2020-06-17</th>
      <td>93</td>
    </tr>
    <tr>
      <th>2020-06-18</th>
      <td>85</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>2022-03-25</th>
      <td>356</td>
    </tr>
    <tr>
      <th>2022-03-26</th>
      <td>303</td>
    </tr>
    <tr>
      <th>2022-03-27</th>
      <td>77</td>
    </tr>
    <tr>
      <th>2022-03-28</th>
      <td>839</td>
    </tr>
    <tr>
      <th>2022-03-29</th>
      <td>6</td>
    </tr>
  </tbody>
</table>
<p>654 rows × 1 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>data_Madrid.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>654.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>2392.562691</td>
    </tr>
    <tr>
      <th>std</th>
      <td>3390.272836</td>
    </tr>
    <tr>
      <th>min</th>
      <td>6.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>662.750000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>1413.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>2475.750000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>23811.000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>np_data_Madrid <span class="op">=</span> data_Madrid.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Madrid <span class="op">=</span> scaler.fit_transform(np_data_Madrid)</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud del conjunto de datos disponible: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_Madrid)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud del conjunto de datos disponible: 654</code></pre>
</div>
</div>
<div class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we are going to predict future values based on the X past elements, </span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to create a list with those historic information for each element</span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>historic_values <span class="op">=</span> <span class="dv">90</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>scaled_data_Madrid_x <span class="op">=</span> []</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>scaled_data_Madrid_y <span class="op">=</span> []</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> num_casos_i <span class="kw">in</span> <span class="bu">range</span>(historic_values, <span class="bu">len</span>(scaled_data_Madrid)):</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>    scaled_data_Madrid_x.append(scaled_data_Madrid[(num_casos_i<span class="op">-</span>historic_values):num_casos_i, <span class="dv">0</span>])</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>    scaled_data_Madrid_y.append(scaled_data_Madrid[num_casos_i, <span class="dv">0</span>])</span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the x_train and y_train to numpy arrays</span></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>scaled_data_Madrid_x <span class="op">=</span> np.array(scaled_data_Madrid_x)</span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>scaled_data_Madrid_y <span class="op">=</span> np.array(scaled_data_Madrid_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train data looks like</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Madrid_x[<span class="dv">235</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>array([0.11510187, 0.14820416, 0.08880487, 0.06481832, 0.11169922,
       0.11354757, 0.089477  , 0.0694812 , 0.09300567, 0.06133165,
       0.04709095, 0.08447805, 0.07746272, 0.06595253, 0.05708885,
       0.06515438, 0.04835119, 0.04377232, 0.06372611, 0.05931527,
       0.05141777, 0.04541063, 0.05330813, 0.04150389, 0.04032766,
       0.05486242, 0.05225793, 0.04822516, 0.04259609, 0.05246797,
       0.03919345, 0.03860534, 0.05561857, 0.05452636, 0.04814115,
       0.04448645, 0.05288805, 0.04125184, 0.03994959, 0.05448435,
       0.05183785, 0.0531401 , 0.05713085, 0.0431842 , 0.05061962,
       0.0478891 , 0.07292586, 0.07830288, 0.0626339 , 0.05902121,
       0.07485822, 0.05326612, 0.05335014, 0.07111951, 0.07095148,
       0.07784079, 0.05469439, 0.06166772, 0.07149758, 0.07456417,
       0.09880277, 0.09850872, 0.0857803 , 0.08178954, 0.08951901,
       0.07225373, 0.05977736, 0.09750053, 0.09762655, 0.08930897,
       0.08544423, 0.09489603, 0.07187566, 0.06406217, 0.09329973,
       0.09855072, 0.08435203, 0.07653854, 0.08905692, 0.0647343 ,
       0.05486242, 0.08237765, 0.0873766 , 0.07326192, 0.06259189,
       0.07485822, 0.04654484, 0.04494854, 0.04721697, 0.06700273])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test data looks like</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Madrid_y[<span class="dv">235</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>0.0648183154799412</code></pre>
</div>
</div>
<div class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since the first 90th values does not have historic, the dataset has been reduced in 90 values</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud datos de entrenamiento con historico: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_Madrid_y)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud datos de entrenamiento con historico: 564</code></pre>
</div>
</div>
<div class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we split data in train and test</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as in previous analysis, we are going to predict a maximum of 91 days</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> scaled_data_Madrid_x[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_Madrid_x)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> scaled_data_Madrid_y[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_Madrid_y)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de entrenamiento: x=</span><span class="sc">{</span><span class="bu">len</span>(x_train)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> scaled_data_Madrid_x[<span class="bu">len</span>(scaled_data_Madrid_x)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_Madrid_x)]</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaled_data_Madrid_y[<span class="bu">len</span>(scaled_data_Madrid_y)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_Madrid_y)]</span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de test: x=</span><span class="sc">{</span><span class="bu">len</span>(x_test)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_test)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cantidad datos de entrenamiento: x=473 - y=473
Cantidad datos de test: x=90 - y=90</code></pre>
</div>
</div>
<div class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data to feed de recurrent network</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> np.reshape(x_train, (x_train.shape[<span class="dv">0</span>], x_train.shape[<span class="dv">1</span>], <span class="dv">1</span>))</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train data shape:"</span>)</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_train.shape)</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_train.shape)</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> np.reshape(x_test, (x_test.shape[<span class="dv">0</span>], x_test.shape[<span class="dv">1</span>], <span class="dv">1</span>))</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test data shape:"</span>)</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_test.shape)</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train data shape:
(473, 90, 1)
(473,)
Test data shape:
(90, 90, 1)
(90,)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure / setup the neural network model - LSTM</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the model</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Build model...'</span>)</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with Neurons </span></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputshape = neurons -&gt; Timestamps</span></span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>neurons<span class="op">=</span> x_train.shape[<span class="dv">1</span>]</span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">90</span>, </span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>, </span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>               input_shape <span class="op">=</span> (x_train.shape[<span class="dv">1</span>], <span class="dv">1</span>))) </span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">50</span>, </span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>)) </span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">25</span>, </span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">False</span>)) </span>
<span id="cb122-18"><a href="#cb122-18" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">5</span>, activation <span class="op">=</span> <span class="st">'relu'</span>))</span>
<span id="cb122-19"><a href="#cb122-19" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Build model...</code></pre>
</div>
</div>
<div class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mean_squared_error'</span>)</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "sequential_2"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Layer (type)                Output Shape              Param #   </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_6 (LSTM)               (None, 90, 90)            33120     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_7 (LSTM)               (None, 90, 50)            28200     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_8 (LSTM)               (None, 25)                7600      </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_4 (Dense)             (None, 5)                 130       </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_5 (Dense)             (None, 1)                 6         </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Total params: 69,056</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Trainable params: 69,056</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Non-trainable params: 0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
</div>
<div class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fit network</span></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(x_train, </span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>                    y_train, </span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>                    batch_size <span class="op">=</span> <span class="dv">1000</span>, </span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>                    epochs <span class="op">=</span> <span class="dv">30</span>, </span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>                    validation_data <span class="op">=</span> (x_test, y_test), </span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>                    verbose <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'loss'</span>], label<span class="op">=</span><span class="st">'train'</span>)</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'val_loss'</span>], label<span class="op">=</span><span class="st">'test'</span>)</span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>plt.show() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_uni_files/figure-html/cell-59-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predicted values</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.predict(x_test)</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> scaler.inverse_transform(predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1/3 [=========&gt;....................] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - 0s 30ms/step</code></pre>
</div>
</div>
<div class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y_test.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaler.inverse_transform(y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean absolute error (MAE)</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, predictions)</span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MAE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(mae, <span class="dv">1</span>)))</span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test,predictions))</span>
<span id="cb151-7"><a href="#cb151-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span>
<span id="cb151-8"><a href="#cb151-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-9"><a href="#cb151-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb151-10"><a href="#cb151-10" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> mean_squared_error(y_test, </span>
<span id="cb151-11"><a href="#cb151-11" aria-hidden="true" tabindex="-1"></a>                          predictions,</span>
<span id="cb151-12"><a href="#cb151-12" aria-hidden="true" tabindex="-1"></a>                          squared <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb151-13"><a href="#cb151-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE: 4748.2
RMSE: 6975.8
RMSE: 6975.8</code></pre>
</div>
</div>
<div class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the difference between the valid and predicted prices</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> data_Madrid[:(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">92</span>)]</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> data_Madrid[(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">91</span>):]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Predictions"</span>, predictions, <span class="va">True</span>)</span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Difference"</span>, valid[<span class="st">"Predictions"</span>] <span class="op">-</span> valid[<span class="st">"num_casos"</span>], <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Zoom-in to a closer timeframe</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Date from which on the date is displayed</span></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>display_start_date <span class="op">=</span> <span class="st">"2021-10-31"</span> </span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> valid[valid.index <span class="op">&gt;</span> display_start_date]</span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> train[train.index <span class="op">&gt;</span> display_start_date]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the data</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>matplotlib.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">22</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Train</span></span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> train.index<span class="op">;</span> </span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> train[[<span class="st">"num_casos"</span>]]</span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Test / validation </span></span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a>xv <span class="op">=</span> valid.index<span class="op">;</span> </span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a>yv <span class="op">=</span> valid[[<span class="st">"num_casos"</span>, <span class="st">"Predictions"</span>]]</span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Madrid: Predictions vs Real infections"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Nº Cases"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-16"><a href="#cb156-16" aria-hidden="true" tabindex="-1"></a>plt.plot(yt, color<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb156-17"><a href="#cb156-17" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"Predictions"</span>], color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb156-18"><a href="#cb156-18" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"num_casos"</span>], color<span class="op">=</span><span class="st">"green"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb156-19"><a href="#cb156-19" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"LSTM Predictions"</span>, <span class="st">"Test"</span>], </span>
<span id="cb156-20"><a href="#cb156-20" aria-hidden="true" tabindex="-1"></a>           loc<span class="op">=</span><span class="st">"upper left"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb156-21"><a href="#cb156-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-22"><a href="#cb156-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot with the differences</span></span>
<span id="cb156-23"><a href="#cb156-23" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> valid.index</span>
<span id="cb156-24"><a href="#cb156-24" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> valid[<span class="st">"Difference"</span>]</span>
<span id="cb156-25"><a href="#cb156-25" aria-hidden="true" tabindex="-1"></a>plt.bar(x, y, width<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">"grey"</span>)</span>
<span id="cb156-26"><a href="#cb156-26" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb156-27"><a href="#cb156-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_uni_files/figure-html/cell-66-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="malaga" class="level2">
<h2 class="anchored" data-anchor-id="malaga">Malaga</h2>
<div class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>data_Malaga <span class="op">=</span> data_covid.loc[data_covid[<span class="st">'provincia'</span>] <span class="op">==</span> <span class="st">'Málaga'</span>]</span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>data_Malaga <span class="op">=</span> data_Malaga.set_index(<span class="st">'fecha'</span>)</span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>data_Malaga <span class="op">=</span> data_Malaga.<span class="bu">filter</span>([<span class="st">'num_casos'</span>])</span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>data_Malaga <span class="op">=</span> data_Malaga[<span class="st">'2020-06-14'</span>:]</span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>data_Malaga</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="66">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
    </tr>
    <tr>
      <th>fecha</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-14</th>
      <td>2</td>
    </tr>
    <tr>
      <th>2020-06-15</th>
      <td>1</td>
    </tr>
    <tr>
      <th>2020-06-16</th>
      <td>1</td>
    </tr>
    <tr>
      <th>2020-06-17</th>
      <td>2</td>
    </tr>
    <tr>
      <th>2020-06-18</th>
      <td>2</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>2022-03-25</th>
      <td>565</td>
    </tr>
    <tr>
      <th>2022-03-26</th>
      <td>79</td>
    </tr>
    <tr>
      <th>2022-03-27</th>
      <td>65</td>
    </tr>
    <tr>
      <th>2022-03-28</th>
      <td>39</td>
    </tr>
    <tr>
      <th>2022-03-29</th>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>654 rows × 1 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>data_Malaga.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="67">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>654.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>410.206422</td>
    </tr>
    <tr>
      <th>std</th>
      <td>489.452348</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>122.250000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>215.500000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>475.250000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>3080.000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>np_data_Malaga <span class="op">=</span> data_Malaga.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Malaga <span class="op">=</span> scaler.fit_transform(np_data_Malaga)</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud del conjunto de datos disponible: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_Malaga)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud del conjunto de datos disponible: 654</code></pre>
</div>
</div>
<div class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we are going to predict future values based on the X past elements, </span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to create a list with those historic information for each element</span></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>historic_values <span class="op">=</span> <span class="dv">90</span></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a>scaled_data_Malaga_x <span class="op">=</span> []</span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>scaled_data_Malaga_y <span class="op">=</span> []</span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> num_casos_i <span class="kw">in</span> <span class="bu">range</span>(historic_values, <span class="bu">len</span>(scaled_data_Malaga)):</span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a>    scaled_data_Malaga_x.append(scaled_data_Malaga[(num_casos_i<span class="op">-</span>historic_values):num_casos_i, <span class="dv">0</span>])</span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a>    scaled_data_Malaga_y.append(scaled_data_Malaga[num_casos_i, <span class="dv">0</span>])</span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-11"><a href="#cb162-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the x_train and y_train to numpy arrays</span></span>
<span id="cb162-12"><a href="#cb162-12" aria-hidden="true" tabindex="-1"></a>scaled_data_Malaga_x <span class="op">=</span> np.array(scaled_data_Malaga_x)</span>
<span id="cb162-13"><a href="#cb162-13" aria-hidden="true" tabindex="-1"></a>scaled_data_Malaga_y <span class="op">=</span> np.array(scaled_data_Malaga_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train data looks like</span></span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Malaga_x[<span class="dv">235</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>array([0.24448052, 0.21915584, 0.15649351, 0.12045455, 0.15357143,
       0.14448052, 0.1474026 , 0.14675325, 0.11655844, 0.09448052,
       0.06753247, 0.09545455, 0.11071429, 0.06883117, 0.06980519,
       0.06688312, 0.04902597, 0.03474026, 0.05974026, 0.04935065,
       0.04967532, 0.04480519, 0.04188312, 0.03993506, 0.02954545,
       0.04188312, 0.04772727, 0.05162338, 0.04902597, 0.04318182,
       0.02792208, 0.0288961 , 0.04253247, 0.04123377, 0.04025974,
       0.03538961, 0.05097403, 0.03051948, 0.02662338, 0.04123377,
       0.03149351, 0.04350649, 0.03733766, 0.03571429, 0.02954545,
       0.0211039 , 0.04188312, 0.04545455, 0.03863636, 0.04772727,
       0.04935065, 0.03571429, 0.0288961 , 0.05357143, 0.05324675,
       0.05616883, 0.04253247, 0.04058442, 0.03474026, 0.04935065,
       0.06623377, 0.07824675, 0.06623377, 0.05909091, 0.06233766,
       0.05064935, 0.03116883, 0.07077922, 0.05649351, 0.07792208,
       0.06168831, 0.0711039 , 0.04155844, 0.04577922, 0.06623377,
       0.06720779, 0.05909091, 0.05519481, 0.05324675, 0.04383117,
       0.03668831, 0.05941558, 0.06525974, 0.06006494, 0.05551948,
       0.05876623, 0.04512987, 0.04545455, 0.06266234, 0.07727273])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test data looks like</span></span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Malaga_y[<span class="dv">235</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="72">
<pre><code>0.0737012987012987</code></pre>
</div>
</div>
<div class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since the first 90th values does not have historic, the dataset has been reduced in 90 values</span></span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud datos de entrenamiento con historico: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_Malaga_y)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud datos de entrenamiento con historico: 564</code></pre>
</div>
</div>
<div class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we split data in train and test</span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as in previous analysis, we are going to predict a maximum of 91 days</span></span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> scaled_data_Malaga_x[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_Malaga_x)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> scaled_data_Malaga_y[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_Malaga_y)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de entrenamiento: x=</span><span class="sc">{</span><span class="bu">len</span>(x_train)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> scaled_data_Malaga_x[<span class="bu">len</span>(scaled_data_Malaga_x)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_Malaga_x)]</span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaled_data_Malaga_y[<span class="bu">len</span>(scaled_data_Malaga_y)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_Malaga_y)]</span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de test: x=</span><span class="sc">{</span><span class="bu">len</span>(x_test)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_test)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cantidad datos de entrenamiento: x=473 - y=473
Cantidad datos de test: x=90 - y=90</code></pre>
</div>
</div>
<div class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data to feed de recurrent network</span></span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> np.reshape(x_train, (x_train.shape[<span class="dv">0</span>], x_train.shape[<span class="dv">1</span>], <span class="dv">1</span>))</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train data shape:"</span>)</span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_train.shape)</span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_train.shape)</span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> np.reshape(x_test, (x_test.shape[<span class="dv">0</span>], x_test.shape[<span class="dv">1</span>], <span class="dv">1</span>))</span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test data shape:"</span>)</span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_test.shape)</span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train data shape:
(473, 90, 1)
(473,)
Test data shape:
(90, 90, 1)
(90,)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure / setup the neural network model - LSTM</span></span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the model</span></span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Build model...'</span>)</span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with Neurons </span></span>
<span id="cb173-6"><a href="#cb173-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputshape = neurons -&gt; Timestamps</span></span>
<span id="cb173-7"><a href="#cb173-7" aria-hidden="true" tabindex="-1"></a>neurons<span class="op">=</span> x_train.shape[<span class="dv">1</span>]</span>
<span id="cb173-8"><a href="#cb173-8" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">90</span>, </span>
<span id="cb173-9"><a href="#cb173-9" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb173-10"><a href="#cb173-10" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>, </span>
<span id="cb173-11"><a href="#cb173-11" aria-hidden="true" tabindex="-1"></a>               input_shape <span class="op">=</span> (x_train.shape[<span class="dv">1</span>], <span class="dv">1</span>))) </span>
<span id="cb173-12"><a href="#cb173-12" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">50</span>, </span>
<span id="cb173-13"><a href="#cb173-13" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb173-14"><a href="#cb173-14" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>)) </span>
<span id="cb173-15"><a href="#cb173-15" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">25</span>, </span>
<span id="cb173-16"><a href="#cb173-16" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb173-17"><a href="#cb173-17" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">False</span>)) </span>
<span id="cb173-18"><a href="#cb173-18" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">5</span>, activation <span class="op">=</span> <span class="st">'relu'</span>))</span>
<span id="cb173-19"><a href="#cb173-19" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Build model...</code></pre>
</div>
</div>
<div class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mean_squared_error'</span>)</span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "sequential_3"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Layer (type)                Output Shape              Param #   </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_9 (LSTM)               (None, 90, 90)            33120     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_10 (LSTM)              (None, 90, 50)            28200     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_11 (LSTM)              (None, 25)                7600      </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_6 (Dense)             (None, 5)                 130       </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_7 (Dense)             (None, 1)                 6         </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Total params: 69,056</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Trainable params: 69,056</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Non-trainable params: 0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
</div>
<div class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model</span></span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fit network</span></span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(x_train, </span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>                    y_train, </span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a>                    batch_size <span class="op">=</span> <span class="dv">1000</span>, </span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a>                    epochs <span class="op">=</span> <span class="dv">30</span>, </span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a>                    validation_data <span class="op">=</span> (x_test, y_test), </span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a>                    verbose <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'loss'</span>], label<span class="op">=</span><span class="st">'train'</span>)</span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'val_loss'</span>], label<span class="op">=</span><span class="st">'test'</span>)</span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a>plt.show() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_uni_files/figure-html/cell-80-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predicted values</span></span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.predict(x_test)</span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> scaler.inverse_transform(predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1/3 [=========&gt;....................] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - 0s 31ms/step</code></pre>
</div>
</div>
<div class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y_test.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaler.inverse_transform(y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean absolute error (MAE)</span></span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, predictions)</span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MAE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(mae, <span class="dv">1</span>)))</span>
<span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-5"><a href="#cb202-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb202-6"><a href="#cb202-6" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test,predictions))</span>
<span id="cb202-7"><a href="#cb202-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span>
<span id="cb202-8"><a href="#cb202-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-9"><a href="#cb202-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb202-10"><a href="#cb202-10" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> mean_squared_error(y_test, </span>
<span id="cb202-11"><a href="#cb202-11" aria-hidden="true" tabindex="-1"></a>                          predictions,</span>
<span id="cb202-12"><a href="#cb202-12" aria-hidden="true" tabindex="-1"></a>                          squared <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb202-13"><a href="#cb202-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE: 353.5
RMSE: 481.1
RMSE: 481.1</code></pre>
</div>
</div>
<div class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the difference between the valid and predicted prices</span></span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> data_Malaga[:(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">92</span>)]</span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> data_Malaga[(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">91</span>):]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Predictions"</span>, predictions, <span class="va">True</span>)</span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Difference"</span>, valid[<span class="st">"Predictions"</span>] <span class="op">-</span> valid[<span class="st">"num_casos"</span>], <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb206"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Zoom-in to a closer timeframe</span></span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Date from which on the date is displayed</span></span>
<span id="cb206-3"><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a>display_start_date <span class="op">=</span> <span class="st">"2021-10-31"</span> </span>
<span id="cb206-4"><a href="#cb206-4" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> valid[valid.index <span class="op">&gt;</span> display_start_date]</span>
<span id="cb206-5"><a href="#cb206-5" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> train[train.index <span class="op">&gt;</span> display_start_date]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the data</span></span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a>matplotlib.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">22</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Train</span></span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> train.index<span class="op">;</span> </span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> train[[<span class="st">"num_casos"</span>]]</span>
<span id="cb207-8"><a href="#cb207-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Test / validation </span></span>
<span id="cb207-9"><a href="#cb207-9" aria-hidden="true" tabindex="-1"></a>xv <span class="op">=</span> valid.index<span class="op">;</span> </span>
<span id="cb207-10"><a href="#cb207-10" aria-hidden="true" tabindex="-1"></a>yv <span class="op">=</span> valid[[<span class="st">"num_casos"</span>, <span class="st">"Predictions"</span>]]</span>
<span id="cb207-11"><a href="#cb207-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-12"><a href="#cb207-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb207-13"><a href="#cb207-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Malaga: Predictions vs Real infections"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb207-14"><a href="#cb207-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Nº Cases"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb207-15"><a href="#cb207-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-16"><a href="#cb207-16" aria-hidden="true" tabindex="-1"></a>plt.plot(yt, color<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb207-17"><a href="#cb207-17" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"Predictions"</span>], color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb207-18"><a href="#cb207-18" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"num_casos"</span>], color<span class="op">=</span><span class="st">"green"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb207-19"><a href="#cb207-19" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"LSTM Predictions"</span>, <span class="st">"Test"</span>], </span>
<span id="cb207-20"><a href="#cb207-20" aria-hidden="true" tabindex="-1"></a>           loc<span class="op">=</span><span class="st">"upper left"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb207-21"><a href="#cb207-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-22"><a href="#cb207-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot with the differences</span></span>
<span id="cb207-23"><a href="#cb207-23" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> valid.index</span>
<span id="cb207-24"><a href="#cb207-24" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> valid[<span class="st">"Difference"</span>]</span>
<span id="cb207-25"><a href="#cb207-25" aria-hidden="true" tabindex="-1"></a>plt.bar(x, y, width<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">"grey"</span>)</span>
<span id="cb207-26"><a href="#cb207-26" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb207-27"><a href="#cb207-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_uni_files/figure-html/cell-87-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="sevilla" class="level2">
<h2 class="anchored" data-anchor-id="sevilla">Sevilla</h2>
<div class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a>data_Sevilla <span class="op">=</span> data_covid.loc[data_covid[<span class="st">'provincia'</span>] <span class="op">==</span> <span class="st">'Sevilla'</span>]</span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a>data_Sevilla <span class="op">=</span> data_Sevilla.set_index(<span class="st">'fecha'</span>)</span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a>data_Sevilla <span class="op">=</span> data_Sevilla.<span class="bu">filter</span>([<span class="st">'num_casos'</span>])</span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a>data_Sevilla <span class="op">=</span> data_Sevilla[<span class="st">'2020-06-14'</span>:]</span>
<span id="cb208-5"><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a>data_Sevilla</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="87">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
    </tr>
    <tr>
      <th>fecha</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-14</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2020-06-15</th>
      <td>2</td>
    </tr>
    <tr>
      <th>2020-06-16</th>
      <td>1</td>
    </tr>
    <tr>
      <th>2020-06-17</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2020-06-18</th>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>2022-03-25</th>
      <td>365</td>
    </tr>
    <tr>
      <th>2022-03-26</th>
      <td>67</td>
    </tr>
    <tr>
      <th>2022-03-27</th>
      <td>24</td>
    </tr>
    <tr>
      <th>2022-03-28</th>
      <td>12</td>
    </tr>
    <tr>
      <th>2022-03-29</th>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>654 rows × 1 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a>data_Sevilla.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="88">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>654.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>432.978593</td>
    </tr>
    <tr>
      <th>std</th>
      <td>500.618517</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>127.250000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>282.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>528.250000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>3692.000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="89">
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a>np_data_Sevilla <span class="op">=</span> data_Sevilla.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="90">
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Sevilla <span class="op">=</span> scaler.fit_transform(np_data_Sevilla)</span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud del conjunto de datos disponible: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_Sevilla)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud del conjunto de datos disponible: 654</code></pre>
</div>
</div>
<div class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we are going to predict future values based on the X past elements, </span></span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to create a list with those historic information for each element</span></span>
<span id="cb213-3"><a href="#cb213-3" aria-hidden="true" tabindex="-1"></a>historic_values <span class="op">=</span> <span class="dv">90</span></span>
<span id="cb213-4"><a href="#cb213-4" aria-hidden="true" tabindex="-1"></a>scaled_data_Sevilla_x <span class="op">=</span> []</span>
<span id="cb213-5"><a href="#cb213-5" aria-hidden="true" tabindex="-1"></a>scaled_data_Sevilla_y <span class="op">=</span> []</span>
<span id="cb213-6"><a href="#cb213-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-7"><a href="#cb213-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> num_casos_i <span class="kw">in</span> <span class="bu">range</span>(historic_values, <span class="bu">len</span>(scaled_data_Sevilla)):</span>
<span id="cb213-8"><a href="#cb213-8" aria-hidden="true" tabindex="-1"></a>    scaled_data_Sevilla_x.append(scaled_data_Sevilla[(num_casos_i<span class="op">-</span>historic_values):num_casos_i, <span class="dv">0</span>])</span>
<span id="cb213-9"><a href="#cb213-9" aria-hidden="true" tabindex="-1"></a>    scaled_data_Sevilla_y.append(scaled_data_Sevilla[num_casos_i, <span class="dv">0</span>])</span>
<span id="cb213-10"><a href="#cb213-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-11"><a href="#cb213-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the x_train and y_train to numpy arrays</span></span>
<span id="cb213-12"><a href="#cb213-12" aria-hidden="true" tabindex="-1"></a>scaled_data_Sevilla_x <span class="op">=</span> np.array(scaled_data_Sevilla_x)</span>
<span id="cb213-13"><a href="#cb213-13" aria-hidden="true" tabindex="-1"></a>scaled_data_Sevilla_y <span class="op">=</span> np.array(scaled_data_Sevilla_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train data looks like</span></span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Sevilla_x[<span class="dv">235</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="92">
<pre><code>array([0.18634886, 0.19799567, 0.14626219, 0.0896533 , 0.13894908,
       0.1695558 , 0.14572048, 0.12242687, 0.13434453, 0.06500542,
       0.05390033, 0.08206934, 0.08667389, 0.09452871, 0.06798483,
       0.05904659, 0.04252438, 0.0343987 , 0.06554713, 0.06473456,
       0.05444204, 0.0503792 , 0.05796316, 0.04577465, 0.03819068,
       0.04712893, 0.0528169 , 0.0663597 , 0.06013001, 0.05119177,
       0.03764897, 0.031961  , 0.05119177, 0.05010834, 0.04739978,
       0.05119177, 0.05390033, 0.03927411, 0.03737811, 0.06013001,
       0.05633803, 0.05606717, 0.05850488, 0.06473456, 0.04658722,
       0.04198267, 0.07150596, 0.07340195, 0.05823402, 0.08071506,
       0.07773564, 0.05877573, 0.05471289, 0.07990249, 0.08829902,
       0.0872156 , 0.09019502, 0.07069339, 0.08775731, 0.08396533,
       0.14951246, 0.12432286, 0.12269772, 0.12378115, 0.13028169,
       0.11348862, 0.07936078, 0.13299025, 0.12269772, 0.11213434,
       0.12107259, 0.12432286, 0.09723727, 0.07042254, 0.09886241,
       0.11782232, 0.10157096, 0.10346696, 0.12621885, 0.08342362,
       0.07340195, 0.0847779 , 0.08559047, 0.11159263, 0.10292524,
       0.08911159, 0.07502709, 0.04821235, 0.08315276, 0.09913326])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb216"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test data looks like</span></span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Sevilla_y[<span class="dv">235</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="93">
<pre><code>0.10861321776814734</code></pre>
</div>
</div>
<div class="cell" data-execution_count="94">
<div class="sourceCode cell-code" id="cb218"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since the first 90th values does not have historic, the dataset has been reduced in 90 values</span></span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud datos de entrenamiento con historico: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_Sevilla_y)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud datos de entrenamiento con historico: 564</code></pre>
</div>
</div>
<div class="cell" data-execution_count="95">
<div class="sourceCode cell-code" id="cb220"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we split data in train and test</span></span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as in previous analysis, we are going to predict a maximum of 91 days</span></span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> scaled_data_Sevilla_x[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_Sevilla_x)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb220-4"><a href="#cb220-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> scaled_data_Sevilla_y[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_Sevilla_y)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb220-5"><a href="#cb220-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de entrenamiento: x=</span><span class="sc">{</span><span class="bu">len</span>(x_train)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb220-6"><a href="#cb220-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-7"><a href="#cb220-7" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> scaled_data_Sevilla_x[<span class="bu">len</span>(scaled_data_Sevilla_x)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_Sevilla_x)]</span>
<span id="cb220-8"><a href="#cb220-8" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaled_data_Sevilla_y[<span class="bu">len</span>(scaled_data_Sevilla_y)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_Sevilla_y)]</span>
<span id="cb220-9"><a href="#cb220-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de test: x=</span><span class="sc">{</span><span class="bu">len</span>(x_test)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_test)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cantidad datos de entrenamiento: x=473 - y=473
Cantidad datos de test: x=90 - y=90</code></pre>
</div>
</div>
<div class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb222"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data to feed de recurrent network</span></span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> np.reshape(x_train, (x_train.shape[<span class="dv">0</span>], x_train.shape[<span class="dv">1</span>], <span class="dv">1</span>))</span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train data shape:"</span>)</span>
<span id="cb222-4"><a href="#cb222-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_train.shape)</span>
<span id="cb222-5"><a href="#cb222-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_train.shape)</span>
<span id="cb222-6"><a href="#cb222-6" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> np.reshape(x_test, (x_test.shape[<span class="dv">0</span>], x_test.shape[<span class="dv">1</span>], <span class="dv">1</span>))</span>
<span id="cb222-7"><a href="#cb222-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test data shape:"</span>)</span>
<span id="cb222-8"><a href="#cb222-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_test.shape)</span>
<span id="cb222-9"><a href="#cb222-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train data shape:
(473, 90, 1)
(473,)
Test data shape:
(90, 90, 1)
(90,)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb224"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure / setup the neural network model - LSTM</span></span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the model</span></span>
<span id="cb224-3"><a href="#cb224-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Build model...'</span>)</span>
<span id="cb224-4"><a href="#cb224-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb224-5"><a href="#cb224-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with Neurons </span></span>
<span id="cb224-6"><a href="#cb224-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputshape = neurons -&gt; Timestamps</span></span>
<span id="cb224-7"><a href="#cb224-7" aria-hidden="true" tabindex="-1"></a>neurons<span class="op">=</span> x_train.shape[<span class="dv">1</span>]</span>
<span id="cb224-8"><a href="#cb224-8" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">90</span>, </span>
<span id="cb224-9"><a href="#cb224-9" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb224-10"><a href="#cb224-10" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>, </span>
<span id="cb224-11"><a href="#cb224-11" aria-hidden="true" tabindex="-1"></a>               input_shape <span class="op">=</span> (x_train.shape[<span class="dv">1</span>], <span class="dv">1</span>))) </span>
<span id="cb224-12"><a href="#cb224-12" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">50</span>, </span>
<span id="cb224-13"><a href="#cb224-13" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb224-14"><a href="#cb224-14" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>)) </span>
<span id="cb224-15"><a href="#cb224-15" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">25</span>, </span>
<span id="cb224-16"><a href="#cb224-16" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb224-17"><a href="#cb224-17" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">False</span>)) </span>
<span id="cb224-18"><a href="#cb224-18" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">5</span>, activation <span class="op">=</span> <span class="st">'relu'</span>))</span>
<span id="cb224-19"><a href="#cb224-19" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Build model...</code></pre>
</div>
</div>
<div class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb226"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mean_squared_error'</span>)</span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "sequential_4"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Layer (type)                Output Shape              Param #   </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_12 (LSTM)              (None, 90, 90)            33120     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_13 (LSTM)              (None, 90, 50)            28200     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_14 (LSTM)              (None, 25)                7600      </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_8 (Dense)             (None, 5)                 130       </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_9 (Dense)             (None, 1)                 6         </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Total params: 69,056</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Trainable params: 69,056</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Non-trainable params: 0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
</div>
<div class="cell" data-execution_count="99">
<div class="sourceCode cell-code" id="cb246"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model</span></span>
<span id="cb246-2"><a href="#cb246-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fit network</span></span>
<span id="cb246-3"><a href="#cb246-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(x_train, </span>
<span id="cb246-4"><a href="#cb246-4" aria-hidden="true" tabindex="-1"></a>                    y_train, </span>
<span id="cb246-5"><a href="#cb246-5" aria-hidden="true" tabindex="-1"></a>                    batch_size <span class="op">=</span> <span class="dv">1000</span>, </span>
<span id="cb246-6"><a href="#cb246-6" aria-hidden="true" tabindex="-1"></a>                    epochs <span class="op">=</span> <span class="dv">30</span>, </span>
<span id="cb246-7"><a href="#cb246-7" aria-hidden="true" tabindex="-1"></a>                    validation_data <span class="op">=</span> (x_test, y_test), </span>
<span id="cb246-8"><a href="#cb246-8" aria-hidden="true" tabindex="-1"></a>                    verbose <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="100">
<div class="sourceCode cell-code" id="cb247"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'loss'</span>], label<span class="op">=</span><span class="st">'train'</span>)</span>
<span id="cb247-2"><a href="#cb247-2" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'val_loss'</span>], label<span class="op">=</span><span class="st">'test'</span>)</span>
<span id="cb247-3"><a href="#cb247-3" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb247-4"><a href="#cb247-4" aria-hidden="true" tabindex="-1"></a>plt.show() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_uni_files/figure-html/cell-101-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="101">
<div class="sourceCode cell-code" id="cb248"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predicted values</span></span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.predict(x_test)</span>
<span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> scaler.inverse_transform(predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>WARNING:tensorflow:5 out of the last 13 calls to &lt;function Model.make_predict_function.&lt;locals&gt;.predict_function at 0x7fdc69aa8c10&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>1/3 [=========&gt;....................] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - 0s 32ms/step</code></pre>
</div>
</div>
<div class="cell" data-execution_count="102">
<div class="sourceCode cell-code" id="cb253"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y_test.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaler.inverse_transform(y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="103">
<div class="sourceCode cell-code" id="cb254"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean absolute error (MAE)</span></span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, predictions)</span>
<span id="cb254-3"><a href="#cb254-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MAE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(mae, <span class="dv">1</span>)))</span>
<span id="cb254-4"><a href="#cb254-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-5"><a href="#cb254-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb254-6"><a href="#cb254-6" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test,predictions))</span>
<span id="cb254-7"><a href="#cb254-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span>
<span id="cb254-8"><a href="#cb254-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-9"><a href="#cb254-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb254-10"><a href="#cb254-10" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> mean_squared_error(y_test, </span>
<span id="cb254-11"><a href="#cb254-11" aria-hidden="true" tabindex="-1"></a>                          predictions,</span>
<span id="cb254-12"><a href="#cb254-12" aria-hidden="true" tabindex="-1"></a>                          squared <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb254-13"><a href="#cb254-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE: 335.1
RMSE: 474.0
RMSE: 474.0</code></pre>
</div>
</div>
<div class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb256"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the difference between the valid and predicted prices</span></span>
<span id="cb256-2"><a href="#cb256-2" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> data_Sevilla[:(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">92</span>)]</span>
<span id="cb256-3"><a href="#cb256-3" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> data_Sevilla[(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">91</span>):]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="105">
<div class="sourceCode cell-code" id="cb257"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Predictions"</span>, predictions, <span class="va">True</span>)</span>
<span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Difference"</span>, valid[<span class="st">"Predictions"</span>] <span class="op">-</span> valid[<span class="st">"num_casos"</span>], <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="106">
<div class="sourceCode cell-code" id="cb258"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Zoom-in to a closer timeframe</span></span>
<span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Date from which on the date is displayed</span></span>
<span id="cb258-3"><a href="#cb258-3" aria-hidden="true" tabindex="-1"></a>display_start_date <span class="op">=</span> <span class="st">"2021-10-31"</span> </span>
<span id="cb258-4"><a href="#cb258-4" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> valid[valid.index <span class="op">&gt;</span> display_start_date]</span>
<span id="cb258-5"><a href="#cb258-5" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> train[train.index <span class="op">&gt;</span> display_start_date]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="107">
<div class="sourceCode cell-code" id="cb259"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the data</span></span>
<span id="cb259-2"><a href="#cb259-2" aria-hidden="true" tabindex="-1"></a>matplotlib.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb259-3"><a href="#cb259-3" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">22</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb259-4"><a href="#cb259-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-5"><a href="#cb259-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Train</span></span>
<span id="cb259-6"><a href="#cb259-6" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> train.index<span class="op">;</span> </span>
<span id="cb259-7"><a href="#cb259-7" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> train[[<span class="st">"num_casos"</span>]]</span>
<span id="cb259-8"><a href="#cb259-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Test / validation </span></span>
<span id="cb259-9"><a href="#cb259-9" aria-hidden="true" tabindex="-1"></a>xv <span class="op">=</span> valid.index<span class="op">;</span> </span>
<span id="cb259-10"><a href="#cb259-10" aria-hidden="true" tabindex="-1"></a>yv <span class="op">=</span> valid[[<span class="st">"num_casos"</span>, <span class="st">"Predictions"</span>]]</span>
<span id="cb259-11"><a href="#cb259-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-12"><a href="#cb259-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb259-13"><a href="#cb259-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Sevilla: Predictions vs Real infections"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb259-14"><a href="#cb259-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Nº Cases"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb259-15"><a href="#cb259-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-16"><a href="#cb259-16" aria-hidden="true" tabindex="-1"></a>plt.plot(yt, color<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb259-17"><a href="#cb259-17" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"Predictions"</span>], color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb259-18"><a href="#cb259-18" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"num_casos"</span>], color<span class="op">=</span><span class="st">"green"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb259-19"><a href="#cb259-19" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"LSTM Predictions"</span>, <span class="st">"Test"</span>], </span>
<span id="cb259-20"><a href="#cb259-20" aria-hidden="true" tabindex="-1"></a>           loc<span class="op">=</span><span class="st">"upper left"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb259-21"><a href="#cb259-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-22"><a href="#cb259-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot with the differences</span></span>
<span id="cb259-23"><a href="#cb259-23" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> valid.index</span>
<span id="cb259-24"><a href="#cb259-24" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> valid[<span class="st">"Difference"</span>]</span>
<span id="cb259-25"><a href="#cb259-25" aria-hidden="true" tabindex="-1"></a>plt.bar(x, y, width<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">"grey"</span>)</span>
<span id="cb259-26"><a href="#cb259-26" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb259-27"><a href="#cb259-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_uni_files/figure-html/cell-108-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="just-before-the-sixth-wave" class="level1">
<h1>Just before the sixth wave</h1>
<section id="asturias-1" class="level2">
<h2 class="anchored" data-anchor-id="asturias-1">Asturias</h2>
<div class="cell" data-execution_count="108">
<div class="sourceCode cell-code" id="cb260"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a>data_asturias <span class="op">=</span> data_covid.loc[data_covid[<span class="st">'provincia'</span>] <span class="op">==</span> <span class="st">'Asturias'</span>]</span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a>data_asturias <span class="op">=</span> data_asturias.set_index(<span class="st">'fecha'</span>)</span>
<span id="cb260-3"><a href="#cb260-3" aria-hidden="true" tabindex="-1"></a>data_asturias <span class="op">=</span> data_asturias.<span class="bu">filter</span>([<span class="st">'num_casos'</span>])</span>
<span id="cb260-4"><a href="#cb260-4" aria-hidden="true" tabindex="-1"></a>data_asturias <span class="op">=</span> data_asturias[<span class="st">'2020-06-14'</span>:<span class="st">'2021-12-31'</span>]</span>
<span id="cb260-5"><a href="#cb260-5" aria-hidden="true" tabindex="-1"></a>data_asturias</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="108">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
    </tr>
    <tr>
      <th>fecha</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-14</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2020-06-15</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2020-06-16</th>
      <td>1</td>
    </tr>
    <tr>
      <th>2020-06-17</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2020-06-18</th>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>2021-12-27</th>
      <td>2363</td>
    </tr>
    <tr>
      <th>2021-12-28</th>
      <td>2150</td>
    </tr>
    <tr>
      <th>2021-12-29</th>
      <td>2159</td>
    </tr>
    <tr>
      <th>2021-12-30</th>
      <td>2020</td>
    </tr>
    <tr>
      <th>2021-12-31</th>
      <td>1949</td>
    </tr>
  </tbody>
</table>
<p>566 rows × 1 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="109">
<div class="sourceCode cell-code" id="cb261"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a>data_asturias.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="109">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>566.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>180.913428</td>
    </tr>
    <tr>
      <th>std</th>
      <td>276.250633</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>36.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>94.500000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>225.750000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>2363.000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="110">
<div class="sourceCode cell-code" id="cb262"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a>np_data_asturias <span class="op">=</span> data_asturias.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="111">
<div class="sourceCode cell-code" id="cb263"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb263-2"><a href="#cb263-2" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias <span class="op">=</span> scaler.fit_transform(np_data_asturias)</span>
<span id="cb263-3"><a href="#cb263-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud del conjunto de datos disponible: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_asturias)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud del conjunto de datos disponible: 566</code></pre>
</div>
</div>
<div class="cell" data-execution_count="112">
<div class="sourceCode cell-code" id="cb265"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we are going to predict future values based on the X past elements, </span></span>
<span id="cb265-2"><a href="#cb265-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to create a list with those historic information for each element</span></span>
<span id="cb265-3"><a href="#cb265-3" aria-hidden="true" tabindex="-1"></a>historic_values <span class="op">=</span> <span class="dv">90</span></span>
<span id="cb265-4"><a href="#cb265-4" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias_x <span class="op">=</span> []</span>
<span id="cb265-5"><a href="#cb265-5" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias_y <span class="op">=</span> []</span>
<span id="cb265-6"><a href="#cb265-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-7"><a href="#cb265-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> num_casos_i <span class="kw">in</span> <span class="bu">range</span>(historic_values, <span class="bu">len</span>(scaled_data_asturias)):</span>
<span id="cb265-8"><a href="#cb265-8" aria-hidden="true" tabindex="-1"></a>    scaled_data_asturias_x.append(scaled_data_asturias[(num_casos_i<span class="op">-</span>historic_values):num_casos_i, <span class="dv">0</span>])</span>
<span id="cb265-9"><a href="#cb265-9" aria-hidden="true" tabindex="-1"></a>    scaled_data_asturias_y.append(scaled_data_asturias[num_casos_i, <span class="dv">0</span>])</span>
<span id="cb265-10"><a href="#cb265-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-11"><a href="#cb265-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the x_train and y_train to numpy arrays</span></span>
<span id="cb265-12"><a href="#cb265-12" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias_x <span class="op">=</span> np.array(scaled_data_asturias_x)</span>
<span id="cb265-13"><a href="#cb265-13" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias_y <span class="op">=</span> np.array(scaled_data_asturias_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="113">
<div class="sourceCode cell-code" id="cb266"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since the first 90 values does not have historic, the dataset has been reduced in 90 values</span></span>
<span id="cb266-2"><a href="#cb266-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud datos de entrenamiento con historico: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_asturias_y)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud datos de entrenamiento con historico: 476</code></pre>
</div>
</div>
<div class="cell" data-execution_count="114">
<div class="sourceCode cell-code" id="cb268"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we split data in train and test</span></span>
<span id="cb268-2"><a href="#cb268-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as in previous analysis, we are going to predict a maximum of 21 days</span></span>
<span id="cb268-3"><a href="#cb268-3" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> scaled_data_asturias_x[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_asturias_x)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb268-4"><a href="#cb268-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> scaled_data_asturias_y[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_asturias_y)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb268-5"><a href="#cb268-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de entrenamiento: x=</span><span class="sc">{</span><span class="bu">len</span>(x_train)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb268-6"><a href="#cb268-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb268-7"><a href="#cb268-7" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> scaled_data_asturias_x[<span class="bu">len</span>(scaled_data_asturias_x)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_asturias_x)]</span>
<span id="cb268-8"><a href="#cb268-8" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaled_data_asturias_y[<span class="bu">len</span>(scaled_data_asturias_y)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_asturias_y)]</span>
<span id="cb268-9"><a href="#cb268-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de test: x=</span><span class="sc">{</span><span class="bu">len</span>(x_test)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_test)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cantidad datos de entrenamiento: x=385 - y=385
Cantidad datos de test: x=90 - y=90</code></pre>
</div>
</div>
<div class="cell" data-execution_count="115">
<div class="sourceCode cell-code" id="cb270"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data to feed de recurrent network</span></span>
<span id="cb270-2"><a href="#cb270-2" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> np.reshape(x_train, (x_train.shape[<span class="dv">0</span>], x_train.shape[<span class="dv">1</span>], <span class="dv">1</span>))</span>
<span id="cb270-3"><a href="#cb270-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train data shape:"</span>)</span>
<span id="cb270-4"><a href="#cb270-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_train.shape)</span>
<span id="cb270-5"><a href="#cb270-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_train.shape)</span>
<span id="cb270-6"><a href="#cb270-6" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> np.reshape(x_test, (x_test.shape[<span class="dv">0</span>], x_test.shape[<span class="dv">1</span>], <span class="dv">1</span>))</span>
<span id="cb270-7"><a href="#cb270-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test data shape:"</span>)</span>
<span id="cb270-8"><a href="#cb270-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_test.shape)</span>
<span id="cb270-9"><a href="#cb270-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train data shape:
(385, 90, 1)
(385,)
Test data shape:
(90, 90, 1)
(90,)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="116">
<div class="sourceCode cell-code" id="cb272"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a><span class="co"># # Configure / setup the neural network model - LSTM</span></span>
<span id="cb272-2"><a href="#cb272-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the model</span></span>
<span id="cb272-3"><a href="#cb272-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Build model...'</span>)</span>
<span id="cb272-4"><a href="#cb272-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb272-5"><a href="#cb272-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with Neurons </span></span>
<span id="cb272-6"><a href="#cb272-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputshape = neurons -&gt; Timestamps</span></span>
<span id="cb272-7"><a href="#cb272-7" aria-hidden="true" tabindex="-1"></a>neurons<span class="op">=</span> x_train.shape[<span class="dv">1</span>]</span>
<span id="cb272-8"><a href="#cb272-8" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">90</span>, </span>
<span id="cb272-9"><a href="#cb272-9" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb272-10"><a href="#cb272-10" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>, </span>
<span id="cb272-11"><a href="#cb272-11" aria-hidden="true" tabindex="-1"></a>               input_shape <span class="op">=</span> (x_train.shape[<span class="dv">1</span>], <span class="dv">1</span>))) </span>
<span id="cb272-12"><a href="#cb272-12" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">50</span>, </span>
<span id="cb272-13"><a href="#cb272-13" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb272-14"><a href="#cb272-14" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>)) </span>
<span id="cb272-15"><a href="#cb272-15" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">25</span>, </span>
<span id="cb272-16"><a href="#cb272-16" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb272-17"><a href="#cb272-17" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">False</span>)) </span>
<span id="cb272-18"><a href="#cb272-18" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">5</span>, activation <span class="op">=</span> <span class="st">'relu'</span>))</span>
<span id="cb272-19"><a href="#cb272-19" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Build model...</code></pre>
</div>
</div>
<div class="cell" data-execution_count="117">
<div class="sourceCode cell-code" id="cb274"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mean_squared_error'</span>)</span>
<span id="cb274-2"><a href="#cb274-2" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "sequential_5"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Layer (type)                Output Shape              Param #   </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_15 (LSTM)              (None, 90, 90)            33120     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_16 (LSTM)              (None, 90, 50)            28200     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_17 (LSTM)              (None, 25)                7600      </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_10 (Dense)            (None, 5)                 130       </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_11 (Dense)            (None, 1)                 6         </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Total params: 69,056</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Trainable params: 69,056</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Non-trainable params: 0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
</div>
<div class="cell" data-execution_count="118">
<div class="sourceCode cell-code" id="cb294"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model</span></span>
<span id="cb294-2"><a href="#cb294-2" aria-hidden="true" tabindex="-1"></a><span class="co"># # fit network</span></span>
<span id="cb294-3"><a href="#cb294-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(x_train, </span>
<span id="cb294-4"><a href="#cb294-4" aria-hidden="true" tabindex="-1"></a>                    y_train, </span>
<span id="cb294-5"><a href="#cb294-5" aria-hidden="true" tabindex="-1"></a>                    batch_size<span class="op">=</span><span class="dv">1000</span>, </span>
<span id="cb294-6"><a href="#cb294-6" aria-hidden="true" tabindex="-1"></a>                    epochs<span class="op">=</span><span class="dv">50</span>, </span>
<span id="cb294-7"><a href="#cb294-7" aria-hidden="true" tabindex="-1"></a>                    validation_data <span class="op">=</span> (x_test, y_test), </span>
<span id="cb294-8"><a href="#cb294-8" aria-hidden="true" tabindex="-1"></a>                    verbose <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="119">
<div class="sourceCode cell-code" id="cb295"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'loss'</span>], label<span class="op">=</span><span class="st">'train'</span>)</span>
<span id="cb295-2"><a href="#cb295-2" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'val_loss'</span>], label<span class="op">=</span><span class="st">'test'</span>)</span>
<span id="cb295-3"><a href="#cb295-3" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb295-4"><a href="#cb295-4" aria-hidden="true" tabindex="-1"></a>plt.show() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_uni_files/figure-html/cell-120-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="120">
<div class="sourceCode cell-code" id="cb296"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb296-1"><a href="#cb296-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predicted values</span></span>
<span id="cb296-2"><a href="#cb296-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.predict(x_test)</span>
<span id="cb296-3"><a href="#cb296-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> scaler.inverse_transform(predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>WARNING:tensorflow:5 out of the last 13 calls to &lt;function Model.make_predict_function.&lt;locals&gt;.predict_function at 0x7fdc3a579c10&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>1/3 [=========&gt;....................] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - 0s 31ms/step</code></pre>
</div>
</div>
<div class="cell" data-execution_count="121">
<div class="sourceCode cell-code" id="cb301"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb301-1"><a href="#cb301-1" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y_test.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb301-2"><a href="#cb301-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaler.inverse_transform(y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="122">
<div class="sourceCode cell-code" id="cb302"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb302-1"><a href="#cb302-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean absolute error (MAE)</span></span>
<span id="cb302-2"><a href="#cb302-2" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, predictions)</span>
<span id="cb302-3"><a href="#cb302-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MAE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(mae, <span class="dv">1</span>)))</span>
<span id="cb302-4"><a href="#cb302-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb302-5"><a href="#cb302-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb302-6"><a href="#cb302-6" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test,predictions))</span>
<span id="cb302-7"><a href="#cb302-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span>
<span id="cb302-8"><a href="#cb302-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb302-9"><a href="#cb302-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb302-10"><a href="#cb302-10" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> mean_squared_error(y_test, </span>
<span id="cb302-11"><a href="#cb302-11" aria-hidden="true" tabindex="-1"></a>                          predictions,</span>
<span id="cb302-12"><a href="#cb302-12" aria-hidden="true" tabindex="-1"></a>                          squared <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb302-13"><a href="#cb302-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE: 208.7
RMSE: 387.0
RMSE: 387.0</code></pre>
</div>
</div>
<div class="cell" data-execution_count="123">
<div class="sourceCode cell-code" id="cb304"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the difference between the valid and predicted prices</span></span>
<span id="cb304-2"><a href="#cb304-2" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> data_asturias[:(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">92</span>)]</span>
<span id="cb304-3"><a href="#cb304-3" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> data_asturias[(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">91</span>):]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="124">
<div class="sourceCode cell-code" id="cb305"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Predictions"</span>, predictions, <span class="va">True</span>)</span>
<span id="cb305-2"><a href="#cb305-2" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Difference"</span>, valid[<span class="st">"Predictions"</span>] <span class="op">-</span> valid[<span class="st">"num_casos"</span>], <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="125">
<div class="sourceCode cell-code" id="cb306"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Zoom-in to a closer timeframe</span></span>
<span id="cb306-2"><a href="#cb306-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Date from which on the date is displayed</span></span>
<span id="cb306-3"><a href="#cb306-3" aria-hidden="true" tabindex="-1"></a>display_start_date <span class="op">=</span> <span class="st">"2021-07-15"</span></span>
<span id="cb306-4"><a href="#cb306-4" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> valid[valid.index <span class="op">&gt;</span> display_start_date]</span>
<span id="cb306-5"><a href="#cb306-5" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> train[train.index <span class="op">&gt;</span> display_start_date]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="126">
<div class="sourceCode cell-code" id="cb307"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb307-1"><a href="#cb307-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the data</span></span>
<span id="cb307-2"><a href="#cb307-2" aria-hidden="true" tabindex="-1"></a>matplotlib.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb307-3"><a href="#cb307-3" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">22</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb307-4"><a href="#cb307-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-5"><a href="#cb307-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Train</span></span>
<span id="cb307-6"><a href="#cb307-6" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> train.index<span class="op">;</span> </span>
<span id="cb307-7"><a href="#cb307-7" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> train[[<span class="st">"num_casos"</span>]]</span>
<span id="cb307-8"><a href="#cb307-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Test / validation </span></span>
<span id="cb307-9"><a href="#cb307-9" aria-hidden="true" tabindex="-1"></a>xv <span class="op">=</span> valid.index<span class="op">;</span> </span>
<span id="cb307-10"><a href="#cb307-10" aria-hidden="true" tabindex="-1"></a>yv <span class="op">=</span> valid[[<span class="st">"num_casos"</span>, <span class="st">"Predictions"</span>]]</span>
<span id="cb307-11"><a href="#cb307-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-12"><a href="#cb307-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb307-13"><a href="#cb307-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Asturias: Predictions vs Real infections"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb307-14"><a href="#cb307-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Nº Cases"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb307-15"><a href="#cb307-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-16"><a href="#cb307-16" aria-hidden="true" tabindex="-1"></a>plt.plot(yt, color<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb307-17"><a href="#cb307-17" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"Predictions"</span>], color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb307-18"><a href="#cb307-18" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"num_casos"</span>], color<span class="op">=</span><span class="st">"green"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb307-19"><a href="#cb307-19" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"LSTM Predictions"</span>, <span class="st">"Test"</span>], </span>
<span id="cb307-20"><a href="#cb307-20" aria-hidden="true" tabindex="-1"></a>           loc<span class="op">=</span><span class="st">"upper left"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb307-21"><a href="#cb307-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-22"><a href="#cb307-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot with the differences</span></span>
<span id="cb307-23"><a href="#cb307-23" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> valid.index</span>
<span id="cb307-24"><a href="#cb307-24" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> valid[<span class="st">"Difference"</span>]</span>
<span id="cb307-25"><a href="#cb307-25" aria-hidden="true" tabindex="-1"></a>plt.bar(x, y, width<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">"grey"</span>)</span>
<span id="cb307-26"><a href="#cb307-26" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb307-27"><a href="#cb307-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_uni_files/figure-html/cell-127-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="barcelona-1" class="level2">
<h2 class="anchored" data-anchor-id="barcelona-1">Barcelona</h2>
<div class="cell" data-execution_count="127">
<div class="sourceCode cell-code" id="cb308"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb308-1"><a href="#cb308-1" aria-hidden="true" tabindex="-1"></a>data_Barcelona <span class="op">=</span> data_covid.loc[data_covid[<span class="st">'provincia'</span>] <span class="op">==</span> <span class="st">'Barcelona'</span>]</span>
<span id="cb308-2"><a href="#cb308-2" aria-hidden="true" tabindex="-1"></a>data_Barcelona <span class="op">=</span> data_Barcelona.set_index(<span class="st">'fecha'</span>)</span>
<span id="cb308-3"><a href="#cb308-3" aria-hidden="true" tabindex="-1"></a>data_Barcelona <span class="op">=</span> data_Barcelona.<span class="bu">filter</span>([<span class="st">'num_casos'</span>])</span>
<span id="cb308-4"><a href="#cb308-4" aria-hidden="true" tabindex="-1"></a>data_Barcelona <span class="op">=</span> data_Barcelona[<span class="st">'2020-06-14'</span>:<span class="st">'2021-12-31'</span>]</span>
<span id="cb308-5"><a href="#cb308-5" aria-hidden="true" tabindex="-1"></a>data_Barcelona</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="127">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
    </tr>
    <tr>
      <th>fecha</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-14</th>
      <td>33</td>
    </tr>
    <tr>
      <th>2020-06-15</th>
      <td>62</td>
    </tr>
    <tr>
      <th>2020-06-16</th>
      <td>66</td>
    </tr>
    <tr>
      <th>2020-06-17</th>
      <td>70</td>
    </tr>
    <tr>
      <th>2020-06-18</th>
      <td>68</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>2021-12-27</th>
      <td>19383</td>
    </tr>
    <tr>
      <th>2021-12-28</th>
      <td>20192</td>
    </tr>
    <tr>
      <th>2021-12-29</th>
      <td>19361</td>
    </tr>
    <tr>
      <th>2021-12-30</th>
      <td>17639</td>
    </tr>
    <tr>
      <th>2021-12-31</th>
      <td>16651</td>
    </tr>
  </tbody>
</table>
<p>566 rows × 1 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="128">
<div class="sourceCode cell-code" id="cb309"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb309-1"><a href="#cb309-1" aria-hidden="true" tabindex="-1"></a>data_Barcelona.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="128">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>566.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>1575.480565</td>
    </tr>
    <tr>
      <th>std</th>
      <td>2281.290383</td>
    </tr>
    <tr>
      <th>min</th>
      <td>33.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>544.750000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>944.500000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>1609.500000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>20192.000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="129">
<div class="sourceCode cell-code" id="cb310"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb310-1"><a href="#cb310-1" aria-hidden="true" tabindex="-1"></a>np_data_Barcelona <span class="op">=</span> data_Barcelona.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="130">
<div class="sourceCode cell-code" id="cb311"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb311-1"><a href="#cb311-1" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb311-2"><a href="#cb311-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Barcelona <span class="op">=</span> scaler.fit_transform(np_data_Barcelona)</span>
<span id="cb311-3"><a href="#cb311-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud del conjunto de datos disponible: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_Barcelona)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud del conjunto de datos disponible: 566</code></pre>
</div>
</div>
<div class="cell" data-execution_count="131">
<div class="sourceCode cell-code" id="cb313"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb313-1"><a href="#cb313-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we are going to predict future values based on the 90 past elements, </span></span>
<span id="cb313-2"><a href="#cb313-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to create a list with those historic information for each element</span></span>
<span id="cb313-3"><a href="#cb313-3" aria-hidden="true" tabindex="-1"></a>historic_values <span class="op">=</span> <span class="dv">90</span></span>
<span id="cb313-4"><a href="#cb313-4" aria-hidden="true" tabindex="-1"></a>scaled_data_Barcelona_x <span class="op">=</span> []</span>
<span id="cb313-5"><a href="#cb313-5" aria-hidden="true" tabindex="-1"></a>scaled_data_Barcelona_y <span class="op">=</span> []</span>
<span id="cb313-6"><a href="#cb313-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb313-7"><a href="#cb313-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> num_casos_i <span class="kw">in</span> <span class="bu">range</span>(historic_values, <span class="bu">len</span>(scaled_data_Barcelona)):</span>
<span id="cb313-8"><a href="#cb313-8" aria-hidden="true" tabindex="-1"></a>    scaled_data_Barcelona_x.append(scaled_data_Barcelona[(num_casos_i<span class="op">-</span>historic_values):num_casos_i, <span class="dv">0</span>])</span>
<span id="cb313-9"><a href="#cb313-9" aria-hidden="true" tabindex="-1"></a>    scaled_data_Barcelona_y.append(scaled_data_Barcelona[num_casos_i, <span class="dv">0</span>])</span>
<span id="cb313-10"><a href="#cb313-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb313-11"><a href="#cb313-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the x_train and y_train to numpy arrays</span></span>
<span id="cb313-12"><a href="#cb313-12" aria-hidden="true" tabindex="-1"></a>scaled_data_Barcelona_x <span class="op">=</span> np.array(scaled_data_Barcelona_x)</span>
<span id="cb313-13"><a href="#cb313-13" aria-hidden="true" tabindex="-1"></a>scaled_data_Barcelona_y <span class="op">=</span> np.array(scaled_data_Barcelona_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="132">
<div class="sourceCode cell-code" id="cb314"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb314-1"><a href="#cb314-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train data looks like</span></span>
<span id="cb314-2"><a href="#cb314-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Barcelona_x[<span class="dv">235</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="132">
<pre><code>array([0.08507366, 0.07971626, 0.04826628, 0.04151992, 0.07822809,
       0.07048961, 0.06289995, 0.05908031, 0.06354482, 0.04345454,
       0.03884121, 0.06855499, 0.06309837, 0.06012203, 0.06116375,
       0.05208592, 0.0405278 , 0.03422789, 0.06364403, 0.06056848,
       0.05337566, 0.045786  , 0.04687733, 0.03323578, 0.02852324,
       0.05833623, 0.05064735, 0.04777023, 0.03864279, 0.04330572,
       0.03065628, 0.02668783, 0.04707575, 0.04355375, 0.04449625,
       0.04251203, 0.04305769, 0.03199563, 0.02842403, 0.05317724,
       0.04955603, 0.04266085, 0.04722456, 0.04861352, 0.0360633 ,
       0.03090431, 0.06240389, 0.06106454, 0.05441738, 0.05074656,
       0.05957637, 0.04181755, 0.03536882, 0.06384245, 0.05734411,
       0.05084578, 0.0563024 , 0.03655935, 0.04191676, 0.04196637,
       0.04712535, 0.06438811, 0.06275113, 0.05883228, 0.06170941,
       0.0475222 , 0.03482316, 0.0651322 , 0.05873307, 0.06696761,
       0.05268118, 0.05679845, 0.04008135, 0.03571606, 0.06642195,
       0.077484  , 0.05863386, 0.06652116, 0.0546158 , 0.04608364,
       0.03933727, 0.07872414, 0.07088645, 0.06389206, 0.06156059,
       0.05878268, 0.03462473, 0.02753113, 0.06384245, 0.04682772])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="133">
<div class="sourceCode cell-code" id="cb316"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb316-1"><a href="#cb316-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test data looks like</span></span>
<span id="cb316-2"><a href="#cb316-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Barcelona_y[<span class="dv">235</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="133">
<pre><code>0.05114340989136366</code></pre>
</div>
</div>
<div class="cell" data-execution_count="134">
<div class="sourceCode cell-code" id="cb318"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb318-1"><a href="#cb318-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since the first 90th values does not have historic, the dataset has been reduced in 90 values</span></span>
<span id="cb318-2"><a href="#cb318-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud datos de entrenamiento con historico: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_Barcelona_y)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud datos de entrenamiento con historico: 476</code></pre>
</div>
</div>
<div class="cell" data-execution_count="135">
<div class="sourceCode cell-code" id="cb320"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb320-1"><a href="#cb320-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we split data in train and test</span></span>
<span id="cb320-2"><a href="#cb320-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as in previous analysis, we are going to predict a maximum of 90 days</span></span>
<span id="cb320-3"><a href="#cb320-3" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> scaled_data_Barcelona_x[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_Barcelona_x)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb320-4"><a href="#cb320-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> scaled_data_Barcelona_y[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_Barcelona_y)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb320-5"><a href="#cb320-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de entrenamiento: x=</span><span class="sc">{</span><span class="bu">len</span>(x_train)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb320-6"><a href="#cb320-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb320-7"><a href="#cb320-7" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> scaled_data_Barcelona_x[<span class="bu">len</span>(scaled_data_Barcelona_x)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_Barcelona_x)]</span>
<span id="cb320-8"><a href="#cb320-8" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaled_data_Barcelona_y[<span class="bu">len</span>(scaled_data_Barcelona_y)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_Barcelona_y)]</span>
<span id="cb320-9"><a href="#cb320-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de test: x=</span><span class="sc">{</span><span class="bu">len</span>(x_test)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_test)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cantidad datos de entrenamiento: x=385 - y=385
Cantidad datos de test: x=90 - y=90</code></pre>
</div>
</div>
<div class="cell" data-execution_count="136">
<div class="sourceCode cell-code" id="cb322"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb322-1"><a href="#cb322-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data to feed de recurrent network</span></span>
<span id="cb322-2"><a href="#cb322-2" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> np.reshape(x_train, (x_train.shape[<span class="dv">0</span>], x_train.shape[<span class="dv">1</span>], <span class="dv">1</span>))</span>
<span id="cb322-3"><a href="#cb322-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train data shape:"</span>)</span>
<span id="cb322-4"><a href="#cb322-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_train.shape)</span>
<span id="cb322-5"><a href="#cb322-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_train.shape)</span>
<span id="cb322-6"><a href="#cb322-6" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> np.reshape(x_test, (x_test.shape[<span class="dv">0</span>], x_test.shape[<span class="dv">1</span>], <span class="dv">1</span>))</span>
<span id="cb322-7"><a href="#cb322-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test data shape:"</span>)</span>
<span id="cb322-8"><a href="#cb322-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_test.shape)</span>
<span id="cb322-9"><a href="#cb322-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train data shape:
(385, 90, 1)
(385,)
Test data shape:
(90, 90, 1)
(90,)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="137">
<div class="sourceCode cell-code" id="cb324"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb324-1"><a href="#cb324-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure / setup the neural network model - LSTM</span></span>
<span id="cb324-2"><a href="#cb324-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the model</span></span>
<span id="cb324-3"><a href="#cb324-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Build model...'</span>)</span>
<span id="cb324-4"><a href="#cb324-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb324-5"><a href="#cb324-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with Neurons </span></span>
<span id="cb324-6"><a href="#cb324-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputshape = neurons -&gt; Timestamps</span></span>
<span id="cb324-7"><a href="#cb324-7" aria-hidden="true" tabindex="-1"></a>neurons<span class="op">=</span> x_train.shape[<span class="dv">1</span>]</span>
<span id="cb324-8"><a href="#cb324-8" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">90</span>, </span>
<span id="cb324-9"><a href="#cb324-9" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb324-10"><a href="#cb324-10" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>, </span>
<span id="cb324-11"><a href="#cb324-11" aria-hidden="true" tabindex="-1"></a>               input_shape <span class="op">=</span> (x_train.shape[<span class="dv">1</span>], <span class="dv">1</span>))) </span>
<span id="cb324-12"><a href="#cb324-12" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">50</span>, </span>
<span id="cb324-13"><a href="#cb324-13" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb324-14"><a href="#cb324-14" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>)) </span>
<span id="cb324-15"><a href="#cb324-15" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">25</span>, </span>
<span id="cb324-16"><a href="#cb324-16" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb324-17"><a href="#cb324-17" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">False</span>)) </span>
<span id="cb324-18"><a href="#cb324-18" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">5</span>, activation <span class="op">=</span> <span class="st">'relu'</span>))</span>
<span id="cb324-19"><a href="#cb324-19" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Build model...</code></pre>
</div>
</div>
<div class="cell" data-execution_count="138">
<div class="sourceCode cell-code" id="cb326"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb326-1"><a href="#cb326-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mean_squared_error'</span>)</span>
<span id="cb326-2"><a href="#cb326-2" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "sequential_6"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Layer (type)                Output Shape              Param #   </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_18 (LSTM)              (None, 90, 90)            33120     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_19 (LSTM)              (None, 90, 50)            28200     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_20 (LSTM)              (None, 25)                7600      </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_12 (Dense)            (None, 5)                 130       </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_13 (Dense)            (None, 1)                 6         </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Total params: 69,056</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Trainable params: 69,056</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Non-trainable params: 0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
</div>
<div class="cell" data-execution_count="139">
<div class="sourceCode cell-code" id="cb346"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb346-1"><a href="#cb346-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model</span></span>
<span id="cb346-2"><a href="#cb346-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fit network</span></span>
<span id="cb346-3"><a href="#cb346-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(x_train, </span>
<span id="cb346-4"><a href="#cb346-4" aria-hidden="true" tabindex="-1"></a>                    y_train, </span>
<span id="cb346-5"><a href="#cb346-5" aria-hidden="true" tabindex="-1"></a>                    batch_size <span class="op">=</span> <span class="dv">1000</span>, </span>
<span id="cb346-6"><a href="#cb346-6" aria-hidden="true" tabindex="-1"></a>                    epochs <span class="op">=</span> <span class="dv">50</span>, </span>
<span id="cb346-7"><a href="#cb346-7" aria-hidden="true" tabindex="-1"></a>                    validation_data <span class="op">=</span> (x_test, y_test), </span>
<span id="cb346-8"><a href="#cb346-8" aria-hidden="true" tabindex="-1"></a>                    verbose <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="140">
<div class="sourceCode cell-code" id="cb347"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb347-1"><a href="#cb347-1" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'loss'</span>], label<span class="op">=</span><span class="st">'train'</span>)</span>
<span id="cb347-2"><a href="#cb347-2" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'val_loss'</span>], label<span class="op">=</span><span class="st">'test'</span>)</span>
<span id="cb347-3"><a href="#cb347-3" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb347-4"><a href="#cb347-4" aria-hidden="true" tabindex="-1"></a>plt.show() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_uni_files/figure-html/cell-141-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="141">
<div class="sourceCode cell-code" id="cb348"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb348-1"><a href="#cb348-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predicted values</span></span>
<span id="cb348-2"><a href="#cb348-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.predict(x_test)</span>
<span id="cb348-3"><a href="#cb348-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> scaler.inverse_transform(predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1/3 [=========&gt;....................] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - 0s 31ms/step</code></pre>
</div>
</div>
<div class="cell" data-execution_count="142">
<div class="sourceCode cell-code" id="cb352"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb352-1"><a href="#cb352-1" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y_test.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb352-2"><a href="#cb352-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaler.inverse_transform(y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="143">
<div class="sourceCode cell-code" id="cb353"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb353-1"><a href="#cb353-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean absolute error (MAE)</span></span>
<span id="cb353-2"><a href="#cb353-2" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, predictions)</span>
<span id="cb353-3"><a href="#cb353-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MAE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(mae, <span class="dv">1</span>)))</span>
<span id="cb353-4"><a href="#cb353-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb353-5"><a href="#cb353-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb353-6"><a href="#cb353-6" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test,predictions))</span>
<span id="cb353-7"><a href="#cb353-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span>
<span id="cb353-8"><a href="#cb353-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb353-9"><a href="#cb353-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb353-10"><a href="#cb353-10" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> mean_squared_error(y_test, </span>
<span id="cb353-11"><a href="#cb353-11" aria-hidden="true" tabindex="-1"></a>                          predictions,</span>
<span id="cb353-12"><a href="#cb353-12" aria-hidden="true" tabindex="-1"></a>                          squared <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb353-13"><a href="#cb353-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE: 1674.3
RMSE: 3525.8
RMSE: 3525.8</code></pre>
</div>
</div>
<div class="cell" data-execution_count="144">
<div class="sourceCode cell-code" id="cb355"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb355-1"><a href="#cb355-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the difference between the valid and predicted prices</span></span>
<span id="cb355-2"><a href="#cb355-2" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> data_Barcelona[:(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">92</span>)]</span>
<span id="cb355-3"><a href="#cb355-3" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> data_Barcelona[(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">91</span>):]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="145">
<div class="sourceCode cell-code" id="cb356"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb356-1"><a href="#cb356-1" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Predictions"</span>, predictions, <span class="va">True</span>)</span>
<span id="cb356-2"><a href="#cb356-2" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Difference"</span>, valid[<span class="st">"Predictions"</span>] <span class="op">-</span> valid[<span class="st">"num_casos"</span>], <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="146">
<div class="sourceCode cell-code" id="cb357"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb357-1"><a href="#cb357-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Zoom-in to a closer timeframe</span></span>
<span id="cb357-2"><a href="#cb357-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Date from which on the date is displayed</span></span>
<span id="cb357-3"><a href="#cb357-3" aria-hidden="true" tabindex="-1"></a>display_start_date <span class="op">=</span> <span class="st">"2021-07-15"</span> </span>
<span id="cb357-4"><a href="#cb357-4" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> valid[valid.index <span class="op">&gt;</span> display_start_date]</span>
<span id="cb357-5"><a href="#cb357-5" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> train[train.index <span class="op">&gt;</span> display_start_date]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="147">
<div class="sourceCode cell-code" id="cb358"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb358-1"><a href="#cb358-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the data</span></span>
<span id="cb358-2"><a href="#cb358-2" aria-hidden="true" tabindex="-1"></a>matplotlib.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb358-3"><a href="#cb358-3" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">22</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb358-4"><a href="#cb358-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-5"><a href="#cb358-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Train</span></span>
<span id="cb358-6"><a href="#cb358-6" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> train.index<span class="op">;</span> </span>
<span id="cb358-7"><a href="#cb358-7" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> train[[<span class="st">"num_casos"</span>]]</span>
<span id="cb358-8"><a href="#cb358-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Test / validation </span></span>
<span id="cb358-9"><a href="#cb358-9" aria-hidden="true" tabindex="-1"></a>xv <span class="op">=</span> valid.index<span class="op">;</span> </span>
<span id="cb358-10"><a href="#cb358-10" aria-hidden="true" tabindex="-1"></a>yv <span class="op">=</span> valid[[<span class="st">"num_casos"</span>, <span class="st">"Predictions"</span>]]</span>
<span id="cb358-11"><a href="#cb358-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-12"><a href="#cb358-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb358-13"><a href="#cb358-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Barcelona: Predictions vs Real infections"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb358-14"><a href="#cb358-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Nº Cases"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb358-15"><a href="#cb358-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-16"><a href="#cb358-16" aria-hidden="true" tabindex="-1"></a>plt.plot(yt, color<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb358-17"><a href="#cb358-17" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"Predictions"</span>], color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb358-18"><a href="#cb358-18" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"num_casos"</span>], color<span class="op">=</span><span class="st">"green"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb358-19"><a href="#cb358-19" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"LSTM Predictions"</span>, <span class="st">"Test"</span>], </span>
<span id="cb358-20"><a href="#cb358-20" aria-hidden="true" tabindex="-1"></a>           loc<span class="op">=</span><span class="st">"upper left"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb358-21"><a href="#cb358-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-22"><a href="#cb358-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot with the differences</span></span>
<span id="cb358-23"><a href="#cb358-23" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> valid.index</span>
<span id="cb358-24"><a href="#cb358-24" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> valid[<span class="st">"Difference"</span>]</span>
<span id="cb358-25"><a href="#cb358-25" aria-hidden="true" tabindex="-1"></a>plt.bar(x, y, width<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">"grey"</span>)</span>
<span id="cb358-26"><a href="#cb358-26" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb358-27"><a href="#cb358-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_uni_files/figure-html/cell-148-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="madrid-1" class="level2">
<h2 class="anchored" data-anchor-id="madrid-1">Madrid</h2>
<div class="cell" data-execution_count="148">
<div class="sourceCode cell-code" id="cb359"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb359-1"><a href="#cb359-1" aria-hidden="true" tabindex="-1"></a>data_Madrid <span class="op">=</span> data_covid.loc[data_covid[<span class="st">'provincia'</span>] <span class="op">==</span> <span class="st">'Madrid'</span>]</span>
<span id="cb359-2"><a href="#cb359-2" aria-hidden="true" tabindex="-1"></a>data_Madrid <span class="op">=</span> data_Madrid.set_index(<span class="st">'fecha'</span>)</span>
<span id="cb359-3"><a href="#cb359-3" aria-hidden="true" tabindex="-1"></a>data_Madrid <span class="op">=</span> data_Madrid.<span class="bu">filter</span>([<span class="st">'num_casos'</span>])</span>
<span id="cb359-4"><a href="#cb359-4" aria-hidden="true" tabindex="-1"></a>data_Madrid <span class="op">=</span> data_Madrid[<span class="st">'2020-06-14'</span>:<span class="st">'2021-12-31'</span>]</span>
<span id="cb359-5"><a href="#cb359-5" aria-hidden="true" tabindex="-1"></a>data_Madrid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="148">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
    </tr>
    <tr>
      <th>fecha</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-14</th>
      <td>81</td>
    </tr>
    <tr>
      <th>2020-06-15</th>
      <td>153</td>
    </tr>
    <tr>
      <th>2020-06-16</th>
      <td>91</td>
    </tr>
    <tr>
      <th>2020-06-17</th>
      <td>93</td>
    </tr>
    <tr>
      <th>2020-06-18</th>
      <td>85</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>2021-12-27</th>
      <td>22958</td>
    </tr>
    <tr>
      <th>2021-12-28</th>
      <td>23811</td>
    </tr>
    <tr>
      <th>2021-12-29</th>
      <td>21914</td>
    </tr>
    <tr>
      <th>2021-12-30</th>
      <td>20666</td>
    </tr>
    <tr>
      <th>2021-12-31</th>
      <td>7556</td>
    </tr>
  </tbody>
</table>
<p>566 rows × 1 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="149">
<div class="sourceCode cell-code" id="cb360"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb360-1"><a href="#cb360-1" aria-hidden="true" tabindex="-1"></a>data_Madrid.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="149">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>566.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>1994.136042</td>
    </tr>
    <tr>
      <th>std</th>
      <td>2795.419848</td>
    </tr>
    <tr>
      <th>min</th>
      <td>28.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>550.250000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>1312.500000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>2282.500000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>23811.000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="150">
<div class="sourceCode cell-code" id="cb361"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb361-1"><a href="#cb361-1" aria-hidden="true" tabindex="-1"></a>np_data_Madrid <span class="op">=</span> data_Madrid.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="151">
<div class="sourceCode cell-code" id="cb362"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb362-1"><a href="#cb362-1" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb362-2"><a href="#cb362-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Madrid <span class="op">=</span> scaler.fit_transform(np_data_Madrid)</span>
<span id="cb362-3"><a href="#cb362-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud del conjunto de datos disponible: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_Madrid)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud del conjunto de datos disponible: 566</code></pre>
</div>
</div>
<div class="cell" data-execution_count="152">
<div class="sourceCode cell-code" id="cb364"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb364-1"><a href="#cb364-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we are going to predict future values based on the X past elements, </span></span>
<span id="cb364-2"><a href="#cb364-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to create a list with those historic information for each element</span></span>
<span id="cb364-3"><a href="#cb364-3" aria-hidden="true" tabindex="-1"></a>historic_values <span class="op">=</span> <span class="dv">90</span></span>
<span id="cb364-4"><a href="#cb364-4" aria-hidden="true" tabindex="-1"></a>scaled_data_Madrid_x <span class="op">=</span> []</span>
<span id="cb364-5"><a href="#cb364-5" aria-hidden="true" tabindex="-1"></a>scaled_data_Madrid_y <span class="op">=</span> []</span>
<span id="cb364-6"><a href="#cb364-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-7"><a href="#cb364-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> num_casos_i <span class="kw">in</span> <span class="bu">range</span>(historic_values, <span class="bu">len</span>(scaled_data_Madrid)):</span>
<span id="cb364-8"><a href="#cb364-8" aria-hidden="true" tabindex="-1"></a>    scaled_data_Madrid_x.append(scaled_data_Madrid[(num_casos_i<span class="op">-</span>historic_values):num_casos_i, <span class="dv">0</span>])</span>
<span id="cb364-9"><a href="#cb364-9" aria-hidden="true" tabindex="-1"></a>    scaled_data_Madrid_y.append(scaled_data_Madrid[num_casos_i, <span class="dv">0</span>])</span>
<span id="cb364-10"><a href="#cb364-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-11"><a href="#cb364-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the x_train and y_train to numpy arrays</span></span>
<span id="cb364-12"><a href="#cb364-12" aria-hidden="true" tabindex="-1"></a>scaled_data_Madrid_x <span class="op">=</span> np.array(scaled_data_Madrid_x)</span>
<span id="cb364-13"><a href="#cb364-13" aria-hidden="true" tabindex="-1"></a>scaled_data_Madrid_y <span class="op">=</span> np.array(scaled_data_Madrid_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="153">
<div class="sourceCode cell-code" id="cb365"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb365-1"><a href="#cb365-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train data looks like</span></span>
<span id="cb365-2"><a href="#cb365-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Madrid_x[<span class="dv">235</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="153">
<pre><code>array([0.11428331, 0.14741622, 0.08796199, 0.06395324, 0.11087752,
       0.11272758, 0.08863474, 0.06862044, 0.09216667, 0.06046336,
       0.04620948, 0.08363117, 0.07660934, 0.06508851, 0.05621663,
       0.06428962, 0.04747088, 0.04288778, 0.06286003, 0.05844511,
       0.0505403 , 0.0445276 , 0.05243241, 0.04061725, 0.03943994,
       0.05398814, 0.05138124, 0.04734474, 0.04171047, 0.05159147,
       0.03830467, 0.03771602, 0.05474499, 0.05365177, 0.04726065,
       0.04360257, 0.05201194, 0.04036497, 0.03906151, 0.05360972,
       0.05096077, 0.05226422, 0.05625867, 0.04229912, 0.04974141,
       0.04700837, 0.07206828, 0.07745028, 0.06176681, 0.05815078,
       0.07400244, 0.05239036, 0.05247446, 0.07026027, 0.07009208,
       0.07698776, 0.05381996, 0.06079973, 0.07063869, 0.07370811,
       0.09796914, 0.09767481, 0.08493462, 0.08094017, 0.08867679,
       0.07139553, 0.05890762, 0.09666569, 0.09679183, 0.08846655,
       0.08459824, 0.09405878, 0.07101711, 0.0631964 , 0.092461  ,
       0.09771686, 0.08350502, 0.07568431, 0.08821427, 0.06386915,
       0.05398814, 0.08152882, 0.0865324 , 0.07240466, 0.06172476,
       0.07400244, 0.04566287, 0.04406509, 0.04633562, 0.06613968])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="154">
<div class="sourceCode cell-code" id="cb367"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb367-1"><a href="#cb367-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test data looks like</span></span>
<span id="cb367-2"><a href="#cb367-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Madrid_y[<span class="dv">235</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="154">
<pre><code>0.0639532439137199</code></pre>
</div>
</div>
<div class="cell" data-execution_count="155">
<div class="sourceCode cell-code" id="cb369"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb369-1"><a href="#cb369-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since the first 90th values does not have historic, the dataset has been reduced in 90 values</span></span>
<span id="cb369-2"><a href="#cb369-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud datos de entrenamiento con historico: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_Madrid_y)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud datos de entrenamiento con historico: 476</code></pre>
</div>
</div>
<div class="cell" data-execution_count="156">
<div class="sourceCode cell-code" id="cb371"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb371-1"><a href="#cb371-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we split data in train and test</span></span>
<span id="cb371-2"><a href="#cb371-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as in previous analysis, we are going to predict a maximum of 91 days</span></span>
<span id="cb371-3"><a href="#cb371-3" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> scaled_data_Madrid_x[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_Madrid_x)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb371-4"><a href="#cb371-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> scaled_data_Madrid_y[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_Madrid_y)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb371-5"><a href="#cb371-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de entrenamiento: x=</span><span class="sc">{</span><span class="bu">len</span>(x_train)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb371-6"><a href="#cb371-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb371-7"><a href="#cb371-7" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> scaled_data_Madrid_x[<span class="bu">len</span>(scaled_data_Madrid_x)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_Madrid_x)]</span>
<span id="cb371-8"><a href="#cb371-8" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaled_data_Madrid_y[<span class="bu">len</span>(scaled_data_Madrid_y)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_Madrid_y)]</span>
<span id="cb371-9"><a href="#cb371-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de test: x=</span><span class="sc">{</span><span class="bu">len</span>(x_test)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_test)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cantidad datos de entrenamiento: x=385 - y=385
Cantidad datos de test: x=90 - y=90</code></pre>
</div>
</div>
<div class="cell" data-execution_count="157">
<div class="sourceCode cell-code" id="cb373"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb373-1"><a href="#cb373-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data to feed de recurrent network</span></span>
<span id="cb373-2"><a href="#cb373-2" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> np.reshape(x_train, (x_train.shape[<span class="dv">0</span>], x_train.shape[<span class="dv">1</span>], <span class="dv">1</span>))</span>
<span id="cb373-3"><a href="#cb373-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train data shape:"</span>)</span>
<span id="cb373-4"><a href="#cb373-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_train.shape)</span>
<span id="cb373-5"><a href="#cb373-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_train.shape)</span>
<span id="cb373-6"><a href="#cb373-6" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> np.reshape(x_test, (x_test.shape[<span class="dv">0</span>], x_test.shape[<span class="dv">1</span>], <span class="dv">1</span>))</span>
<span id="cb373-7"><a href="#cb373-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test data shape:"</span>)</span>
<span id="cb373-8"><a href="#cb373-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_test.shape)</span>
<span id="cb373-9"><a href="#cb373-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train data shape:
(385, 90, 1)
(385,)
Test data shape:
(90, 90, 1)
(90,)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="158">
<div class="sourceCode cell-code" id="cb375"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb375-1"><a href="#cb375-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure / setup the neural network model - LSTM</span></span>
<span id="cb375-2"><a href="#cb375-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the model</span></span>
<span id="cb375-3"><a href="#cb375-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Build model...'</span>)</span>
<span id="cb375-4"><a href="#cb375-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb375-5"><a href="#cb375-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with Neurons </span></span>
<span id="cb375-6"><a href="#cb375-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputshape = neurons -&gt; Timestamps</span></span>
<span id="cb375-7"><a href="#cb375-7" aria-hidden="true" tabindex="-1"></a>neurons<span class="op">=</span> x_train.shape[<span class="dv">1</span>]</span>
<span id="cb375-8"><a href="#cb375-8" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">90</span>, </span>
<span id="cb375-9"><a href="#cb375-9" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb375-10"><a href="#cb375-10" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>, </span>
<span id="cb375-11"><a href="#cb375-11" aria-hidden="true" tabindex="-1"></a>               input_shape <span class="op">=</span> (x_train.shape[<span class="dv">1</span>], <span class="dv">1</span>))) </span>
<span id="cb375-12"><a href="#cb375-12" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">50</span>, </span>
<span id="cb375-13"><a href="#cb375-13" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb375-14"><a href="#cb375-14" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>)) </span>
<span id="cb375-15"><a href="#cb375-15" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">25</span>, </span>
<span id="cb375-16"><a href="#cb375-16" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb375-17"><a href="#cb375-17" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">False</span>)) </span>
<span id="cb375-18"><a href="#cb375-18" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">5</span>, activation <span class="op">=</span> <span class="st">'relu'</span>))</span>
<span id="cb375-19"><a href="#cb375-19" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Build model...</code></pre>
</div>
</div>
<div class="cell" data-execution_count="159">
<div class="sourceCode cell-code" id="cb377"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb377-1"><a href="#cb377-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mean_squared_error'</span>)</span>
<span id="cb377-2"><a href="#cb377-2" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "sequential_7"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Layer (type)                Output Shape              Param #   </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_21 (LSTM)              (None, 90, 90)            33120     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_22 (LSTM)              (None, 90, 50)            28200     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_23 (LSTM)              (None, 25)                7600      </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_14 (Dense)            (None, 5)                 130       </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_15 (Dense)            (None, 1)                 6         </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Total params: 69,056</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Trainable params: 69,056</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Non-trainable params: 0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
</div>
<div class="cell" data-execution_count="160">
<div class="sourceCode cell-code" id="cb397"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb397-1"><a href="#cb397-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model</span></span>
<span id="cb397-2"><a href="#cb397-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fit network</span></span>
<span id="cb397-3"><a href="#cb397-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(x_train, </span>
<span id="cb397-4"><a href="#cb397-4" aria-hidden="true" tabindex="-1"></a>                    y_train, </span>
<span id="cb397-5"><a href="#cb397-5" aria-hidden="true" tabindex="-1"></a>                    batch_size <span class="op">=</span> <span class="dv">1000</span>, </span>
<span id="cb397-6"><a href="#cb397-6" aria-hidden="true" tabindex="-1"></a>                    epochs <span class="op">=</span> <span class="dv">50</span>, </span>
<span id="cb397-7"><a href="#cb397-7" aria-hidden="true" tabindex="-1"></a>                    validation_data <span class="op">=</span> (x_test, y_test), </span>
<span id="cb397-8"><a href="#cb397-8" aria-hidden="true" tabindex="-1"></a>                    verbose <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="161">
<div class="sourceCode cell-code" id="cb398"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb398-1"><a href="#cb398-1" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'loss'</span>], label<span class="op">=</span><span class="st">'train'</span>)</span>
<span id="cb398-2"><a href="#cb398-2" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'val_loss'</span>], label<span class="op">=</span><span class="st">'test'</span>)</span>
<span id="cb398-3"><a href="#cb398-3" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb398-4"><a href="#cb398-4" aria-hidden="true" tabindex="-1"></a>plt.show() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_uni_files/figure-html/cell-162-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="162">
<div class="sourceCode cell-code" id="cb399"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb399-1"><a href="#cb399-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predicted values</span></span>
<span id="cb399-2"><a href="#cb399-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.predict(x_test)</span>
<span id="cb399-3"><a href="#cb399-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> scaler.inverse_transform(predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1/3 [=========&gt;....................] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - 0s 31ms/step</code></pre>
</div>
</div>
<div class="cell" data-execution_count="163">
<div class="sourceCode cell-code" id="cb403"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb403-1"><a href="#cb403-1" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y_test.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb403-2"><a href="#cb403-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaler.inverse_transform(y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="164">
<div class="sourceCode cell-code" id="cb404"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb404-1"><a href="#cb404-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean absolute error (MAE)</span></span>
<span id="cb404-2"><a href="#cb404-2" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, predictions)</span>
<span id="cb404-3"><a href="#cb404-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MAE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(mae, <span class="dv">1</span>)))</span>
<span id="cb404-4"><a href="#cb404-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-5"><a href="#cb404-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb404-6"><a href="#cb404-6" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test,predictions))</span>
<span id="cb404-7"><a href="#cb404-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span>
<span id="cb404-8"><a href="#cb404-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-9"><a href="#cb404-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb404-10"><a href="#cb404-10" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> mean_squared_error(y_test, </span>
<span id="cb404-11"><a href="#cb404-11" aria-hidden="true" tabindex="-1"></a>                          predictions,</span>
<span id="cb404-12"><a href="#cb404-12" aria-hidden="true" tabindex="-1"></a>                          squared <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb404-13"><a href="#cb404-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE: 2521.6
RMSE: 5345.2
RMSE: 5345.2</code></pre>
</div>
</div>
<div class="cell" data-execution_count="165">
<div class="sourceCode cell-code" id="cb406"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb406-1"><a href="#cb406-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the difference between the valid and predicted prices</span></span>
<span id="cb406-2"><a href="#cb406-2" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> data_Madrid[:(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">92</span>)]</span>
<span id="cb406-3"><a href="#cb406-3" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> data_Madrid[(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">91</span>):]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="166">
<div class="sourceCode cell-code" id="cb407"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb407-1"><a href="#cb407-1" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Predictions"</span>, predictions, <span class="va">True</span>)</span>
<span id="cb407-2"><a href="#cb407-2" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Difference"</span>, valid[<span class="st">"Predictions"</span>] <span class="op">-</span> valid[<span class="st">"num_casos"</span>], <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="167">
<div class="sourceCode cell-code" id="cb408"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb408-1"><a href="#cb408-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Zoom-in to a closer timeframe</span></span>
<span id="cb408-2"><a href="#cb408-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Date from which on the date is displayed</span></span>
<span id="cb408-3"><a href="#cb408-3" aria-hidden="true" tabindex="-1"></a>display_start_date <span class="op">=</span> <span class="st">"2021-07-15"</span> </span>
<span id="cb408-4"><a href="#cb408-4" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> valid[valid.index <span class="op">&gt;</span> display_start_date]</span>
<span id="cb408-5"><a href="#cb408-5" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> train[train.index <span class="op">&gt;</span> display_start_date]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="168">
<div class="sourceCode cell-code" id="cb409"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb409-1"><a href="#cb409-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the data</span></span>
<span id="cb409-2"><a href="#cb409-2" aria-hidden="true" tabindex="-1"></a>matplotlib.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb409-3"><a href="#cb409-3" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">22</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb409-4"><a href="#cb409-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb409-5"><a href="#cb409-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Train</span></span>
<span id="cb409-6"><a href="#cb409-6" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> train.index<span class="op">;</span> </span>
<span id="cb409-7"><a href="#cb409-7" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> train[[<span class="st">"num_casos"</span>]]</span>
<span id="cb409-8"><a href="#cb409-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Test / validation </span></span>
<span id="cb409-9"><a href="#cb409-9" aria-hidden="true" tabindex="-1"></a>xv <span class="op">=</span> valid.index<span class="op">;</span> </span>
<span id="cb409-10"><a href="#cb409-10" aria-hidden="true" tabindex="-1"></a>yv <span class="op">=</span> valid[[<span class="st">"num_casos"</span>, <span class="st">"Predictions"</span>]]</span>
<span id="cb409-11"><a href="#cb409-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb409-12"><a href="#cb409-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb409-13"><a href="#cb409-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Madrid: Predictions vs Real infections"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb409-14"><a href="#cb409-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Nº Cases"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb409-15"><a href="#cb409-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb409-16"><a href="#cb409-16" aria-hidden="true" tabindex="-1"></a>plt.plot(yt, color<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb409-17"><a href="#cb409-17" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"Predictions"</span>], color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb409-18"><a href="#cb409-18" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"num_casos"</span>], color<span class="op">=</span><span class="st">"green"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb409-19"><a href="#cb409-19" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"LSTM Predictions"</span>, <span class="st">"Test"</span>], </span>
<span id="cb409-20"><a href="#cb409-20" aria-hidden="true" tabindex="-1"></a>           loc<span class="op">=</span><span class="st">"upper left"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb409-21"><a href="#cb409-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb409-22"><a href="#cb409-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot with the differences</span></span>
<span id="cb409-23"><a href="#cb409-23" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> valid.index</span>
<span id="cb409-24"><a href="#cb409-24" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> valid[<span class="st">"Difference"</span>]</span>
<span id="cb409-25"><a href="#cb409-25" aria-hidden="true" tabindex="-1"></a>plt.bar(x, y, width<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">"grey"</span>)</span>
<span id="cb409-26"><a href="#cb409-26" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb409-27"><a href="#cb409-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_uni_files/figure-html/cell-169-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="malaga-1" class="level2">
<h2 class="anchored" data-anchor-id="malaga-1">Malaga</h2>
<div class="cell" data-execution_count="169">
<div class="sourceCode cell-code" id="cb410"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb410-1"><a href="#cb410-1" aria-hidden="true" tabindex="-1"></a>data_Malaga <span class="op">=</span> data_covid.loc[data_covid[<span class="st">'provincia'</span>] <span class="op">==</span> <span class="st">'Málaga'</span>]</span>
<span id="cb410-2"><a href="#cb410-2" aria-hidden="true" tabindex="-1"></a>data_Malaga <span class="op">=</span> data_Malaga.set_index(<span class="st">'fecha'</span>)</span>
<span id="cb410-3"><a href="#cb410-3" aria-hidden="true" tabindex="-1"></a>data_Malaga <span class="op">=</span> data_Malaga.<span class="bu">filter</span>([<span class="st">'num_casos'</span>])</span>
<span id="cb410-4"><a href="#cb410-4" aria-hidden="true" tabindex="-1"></a>data_Malaga <span class="op">=</span> data_Malaga[<span class="st">'2020-06-14'</span>:<span class="st">'2021-12-31'</span>]</span>
<span id="cb410-5"><a href="#cb410-5" aria-hidden="true" tabindex="-1"></a>data_Malaga</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="169">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
    </tr>
    <tr>
      <th>fecha</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-14</th>
      <td>2</td>
    </tr>
    <tr>
      <th>2020-06-15</th>
      <td>1</td>
    </tr>
    <tr>
      <th>2020-06-16</th>
      <td>1</td>
    </tr>
    <tr>
      <th>2020-06-17</th>
      <td>2</td>
    </tr>
    <tr>
      <th>2020-06-18</th>
      <td>2</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>2021-12-27</th>
      <td>1627</td>
    </tr>
    <tr>
      <th>2021-12-28</th>
      <td>2772</td>
    </tr>
    <tr>
      <th>2021-12-29</th>
      <td>3080</td>
    </tr>
    <tr>
      <th>2021-12-30</th>
      <td>3075</td>
    </tr>
    <tr>
      <th>2021-12-31</th>
      <td>2646</td>
    </tr>
  </tbody>
</table>
<p>566 rows × 1 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="170">
<div class="sourceCode cell-code" id="cb411"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb411-1"><a href="#cb411-1" aria-hidden="true" tabindex="-1"></a>data_Malaga.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="170">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>566.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>339.227915</td>
    </tr>
    <tr>
      <th>std</th>
      <td>427.261346</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>110.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>193.500000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>344.750000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>3080.000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="171">
<div class="sourceCode cell-code" id="cb412"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb412-1"><a href="#cb412-1" aria-hidden="true" tabindex="-1"></a>np_data_Malaga <span class="op">=</span> data_Malaga.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="172">
<div class="sourceCode cell-code" id="cb413"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb413-1"><a href="#cb413-1" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb413-2"><a href="#cb413-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Malaga <span class="op">=</span> scaler.fit_transform(np_data_Malaga)</span>
<span id="cb413-3"><a href="#cb413-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud del conjunto de datos disponible: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_Malaga)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud del conjunto de datos disponible: 566</code></pre>
</div>
</div>
<div class="cell" data-execution_count="173">
<div class="sourceCode cell-code" id="cb415"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb415-1"><a href="#cb415-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we are going to predict future values based on the X past elements, </span></span>
<span id="cb415-2"><a href="#cb415-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to create a list with those historic information for each element</span></span>
<span id="cb415-3"><a href="#cb415-3" aria-hidden="true" tabindex="-1"></a>historic_values <span class="op">=</span> <span class="dv">90</span></span>
<span id="cb415-4"><a href="#cb415-4" aria-hidden="true" tabindex="-1"></a>scaled_data_Malaga_x <span class="op">=</span> []</span>
<span id="cb415-5"><a href="#cb415-5" aria-hidden="true" tabindex="-1"></a>scaled_data_Malaga_y <span class="op">=</span> []</span>
<span id="cb415-6"><a href="#cb415-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb415-7"><a href="#cb415-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> num_casos_i <span class="kw">in</span> <span class="bu">range</span>(historic_values, <span class="bu">len</span>(scaled_data_Malaga)):</span>
<span id="cb415-8"><a href="#cb415-8" aria-hidden="true" tabindex="-1"></a>    scaled_data_Malaga_x.append(scaled_data_Malaga[(num_casos_i<span class="op">-</span>historic_values):num_casos_i, <span class="dv">0</span>])</span>
<span id="cb415-9"><a href="#cb415-9" aria-hidden="true" tabindex="-1"></a>    scaled_data_Malaga_y.append(scaled_data_Malaga[num_casos_i, <span class="dv">0</span>])</span>
<span id="cb415-10"><a href="#cb415-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb415-11"><a href="#cb415-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the x_train and y_train to numpy arrays</span></span>
<span id="cb415-12"><a href="#cb415-12" aria-hidden="true" tabindex="-1"></a>scaled_data_Malaga_x <span class="op">=</span> np.array(scaled_data_Malaga_x)</span>
<span id="cb415-13"><a href="#cb415-13" aria-hidden="true" tabindex="-1"></a>scaled_data_Malaga_y <span class="op">=</span> np.array(scaled_data_Malaga_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="174">
<div class="sourceCode cell-code" id="cb416"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb416-1"><a href="#cb416-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train data looks like</span></span>
<span id="cb416-2"><a href="#cb416-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Malaga_x[<span class="dv">235</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="174">
<pre><code>array([0.24423514, 0.21890224, 0.15621955, 0.12016889, 0.15329652,
       0.14420266, 0.14712569, 0.14647613, 0.11627152, 0.09418642,
       0.06722962, 0.09516077, 0.11042546, 0.06852874, 0.06950309,
       0.06658006, 0.04871712, 0.03442676, 0.05943488, 0.0490419 ,
       0.04936668, 0.04449497, 0.04157194, 0.03962325, 0.02923027,
       0.04157194, 0.04741799, 0.05131536, 0.04871712, 0.04287106,
       0.02760637, 0.02858071, 0.0422215 , 0.04092238, 0.03994804,
       0.03507632, 0.0506658 , 0.03020461, 0.02630724, 0.04092238,
       0.03117895, 0.04319584, 0.03702501, 0.0354011 , 0.02923027,
       0.02078597, 0.04157194, 0.04514453, 0.03832413, 0.04741799,
       0.0490419 , 0.0354011 , 0.02858071, 0.05326405, 0.05293927,
       0.05586229, 0.0422215 , 0.04027282, 0.03442676, 0.0490419 ,
       0.0659305 , 0.07794739, 0.0659305 , 0.05878532, 0.06203313,
       0.05034102, 0.03085417, 0.07047743, 0.05618707, 0.0776226 ,
       0.06138357, 0.07080221, 0.04124716, 0.04546931, 0.0659305 ,
       0.06690484, 0.05878532, 0.05488795, 0.05293927, 0.04352062,
       0.03637545, 0.0591101 , 0.06495615, 0.05975966, 0.05521273,
       0.05846054, 0.04481975, 0.04514453, 0.06235791, 0.07697304])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="175">
<div class="sourceCode cell-code" id="cb418"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb418-1"><a href="#cb418-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test data looks like</span></span>
<span id="cb418-2"><a href="#cb418-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Malaga_y[<span class="dv">235</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="175">
<pre><code>0.07340045469308218</code></pre>
</div>
</div>
<div class="cell" data-execution_count="176">
<div class="sourceCode cell-code" id="cb420"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb420-1"><a href="#cb420-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since the first 90th values does not have historic, the dataset has been reduced in 90 values</span></span>
<span id="cb420-2"><a href="#cb420-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud datos de entrenamiento con historico: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_Malaga_y)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud datos de entrenamiento con historico: 476</code></pre>
</div>
</div>
<div class="cell" data-execution_count="177">
<div class="sourceCode cell-code" id="cb422"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb422-1"><a href="#cb422-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we split data in train and test</span></span>
<span id="cb422-2"><a href="#cb422-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as in previous analysis, we are going to predict a maximum of 91 days</span></span>
<span id="cb422-3"><a href="#cb422-3" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> scaled_data_Malaga_x[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_Malaga_x)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb422-4"><a href="#cb422-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> scaled_data_Malaga_y[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_Malaga_y)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb422-5"><a href="#cb422-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de entrenamiento: x=</span><span class="sc">{</span><span class="bu">len</span>(x_train)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb422-6"><a href="#cb422-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb422-7"><a href="#cb422-7" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> scaled_data_Malaga_x[<span class="bu">len</span>(scaled_data_Malaga_x)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_Malaga_x)]</span>
<span id="cb422-8"><a href="#cb422-8" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaled_data_Malaga_y[<span class="bu">len</span>(scaled_data_Malaga_y)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_Malaga_y)]</span>
<span id="cb422-9"><a href="#cb422-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de test: x=</span><span class="sc">{</span><span class="bu">len</span>(x_test)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_test)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cantidad datos de entrenamiento: x=385 - y=385
Cantidad datos de test: x=90 - y=90</code></pre>
</div>
</div>
<div class="cell" data-execution_count="178">
<div class="sourceCode cell-code" id="cb424"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb424-1"><a href="#cb424-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data to feed de recurrent network</span></span>
<span id="cb424-2"><a href="#cb424-2" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> np.reshape(x_train, (x_train.shape[<span class="dv">0</span>], x_train.shape[<span class="dv">1</span>], <span class="dv">1</span>))</span>
<span id="cb424-3"><a href="#cb424-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train data shape:"</span>)</span>
<span id="cb424-4"><a href="#cb424-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_train.shape)</span>
<span id="cb424-5"><a href="#cb424-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_train.shape)</span>
<span id="cb424-6"><a href="#cb424-6" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> np.reshape(x_test, (x_test.shape[<span class="dv">0</span>], x_test.shape[<span class="dv">1</span>], <span class="dv">1</span>))</span>
<span id="cb424-7"><a href="#cb424-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test data shape:"</span>)</span>
<span id="cb424-8"><a href="#cb424-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_test.shape)</span>
<span id="cb424-9"><a href="#cb424-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train data shape:
(385, 90, 1)
(385,)
Test data shape:
(90, 90, 1)
(90,)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="179">
<div class="sourceCode cell-code" id="cb426"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb426-1"><a href="#cb426-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure / setup the neural network model - LSTM</span></span>
<span id="cb426-2"><a href="#cb426-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the model</span></span>
<span id="cb426-3"><a href="#cb426-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Build model...'</span>)</span>
<span id="cb426-4"><a href="#cb426-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb426-5"><a href="#cb426-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with Neurons </span></span>
<span id="cb426-6"><a href="#cb426-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputshape = neurons -&gt; Timestamps</span></span>
<span id="cb426-7"><a href="#cb426-7" aria-hidden="true" tabindex="-1"></a>neurons<span class="op">=</span> x_train.shape[<span class="dv">1</span>]</span>
<span id="cb426-8"><a href="#cb426-8" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">90</span>, </span>
<span id="cb426-9"><a href="#cb426-9" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb426-10"><a href="#cb426-10" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>, </span>
<span id="cb426-11"><a href="#cb426-11" aria-hidden="true" tabindex="-1"></a>               input_shape <span class="op">=</span> (x_train.shape[<span class="dv">1</span>], <span class="dv">1</span>))) </span>
<span id="cb426-12"><a href="#cb426-12" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">50</span>, </span>
<span id="cb426-13"><a href="#cb426-13" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb426-14"><a href="#cb426-14" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>)) </span>
<span id="cb426-15"><a href="#cb426-15" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">25</span>, </span>
<span id="cb426-16"><a href="#cb426-16" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb426-17"><a href="#cb426-17" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">False</span>)) </span>
<span id="cb426-18"><a href="#cb426-18" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">5</span>, activation <span class="op">=</span> <span class="st">'relu'</span>))</span>
<span id="cb426-19"><a href="#cb426-19" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Build model...</code></pre>
</div>
</div>
<div class="cell" data-execution_count="180">
<div class="sourceCode cell-code" id="cb428"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb428-1"><a href="#cb428-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mean_squared_error'</span>)</span>
<span id="cb428-2"><a href="#cb428-2" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "sequential_8"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Layer (type)                Output Shape              Param #   </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_24 (LSTM)              (None, 90, 90)            33120     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_25 (LSTM)              (None, 90, 50)            28200     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_26 (LSTM)              (None, 25)                7600      </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_16 (Dense)            (None, 5)                 130       </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_17 (Dense)            (None, 1)                 6         </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Total params: 69,056</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Trainable params: 69,056</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Non-trainable params: 0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
</div>
<div class="cell" data-execution_count="181">
<div class="sourceCode cell-code" id="cb448"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb448-1"><a href="#cb448-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model</span></span>
<span id="cb448-2"><a href="#cb448-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fit network</span></span>
<span id="cb448-3"><a href="#cb448-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(x_train, </span>
<span id="cb448-4"><a href="#cb448-4" aria-hidden="true" tabindex="-1"></a>                    y_train, </span>
<span id="cb448-5"><a href="#cb448-5" aria-hidden="true" tabindex="-1"></a>                    batch_size <span class="op">=</span> <span class="dv">1000</span>, </span>
<span id="cb448-6"><a href="#cb448-6" aria-hidden="true" tabindex="-1"></a>                    epochs <span class="op">=</span> <span class="dv">50</span>, </span>
<span id="cb448-7"><a href="#cb448-7" aria-hidden="true" tabindex="-1"></a>                    validation_data <span class="op">=</span> (x_test, y_test), </span>
<span id="cb448-8"><a href="#cb448-8" aria-hidden="true" tabindex="-1"></a>                    verbose <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="182">
<div class="sourceCode cell-code" id="cb449"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb449-1"><a href="#cb449-1" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'loss'</span>], label<span class="op">=</span><span class="st">'train'</span>)</span>
<span id="cb449-2"><a href="#cb449-2" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'val_loss'</span>], label<span class="op">=</span><span class="st">'test'</span>)</span>
<span id="cb449-3"><a href="#cb449-3" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb449-4"><a href="#cb449-4" aria-hidden="true" tabindex="-1"></a>plt.show() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_uni_files/figure-html/cell-183-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="183">
<div class="sourceCode cell-code" id="cb450"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb450-1"><a href="#cb450-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predicted values</span></span>
<span id="cb450-2"><a href="#cb450-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.predict(x_test)</span>
<span id="cb450-3"><a href="#cb450-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> scaler.inverse_transform(predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1/3 [=========&gt;....................] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - 0s 31ms/step</code></pre>
</div>
</div>
<div class="cell" data-execution_count="184">
<div class="sourceCode cell-code" id="cb454"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb454-1"><a href="#cb454-1" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y_test.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb454-2"><a href="#cb454-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaler.inverse_transform(y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="185">
<div class="sourceCode cell-code" id="cb455"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb455-1"><a href="#cb455-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean absolute error (MAE)</span></span>
<span id="cb455-2"><a href="#cb455-2" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, predictions)</span>
<span id="cb455-3"><a href="#cb455-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MAE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(mae, <span class="dv">1</span>)))</span>
<span id="cb455-4"><a href="#cb455-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb455-5"><a href="#cb455-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb455-6"><a href="#cb455-6" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test,predictions))</span>
<span id="cb455-7"><a href="#cb455-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span>
<span id="cb455-8"><a href="#cb455-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb455-9"><a href="#cb455-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb455-10"><a href="#cb455-10" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> mean_squared_error(y_test, </span>
<span id="cb455-11"><a href="#cb455-11" aria-hidden="true" tabindex="-1"></a>                          predictions,</span>
<span id="cb455-12"><a href="#cb455-12" aria-hidden="true" tabindex="-1"></a>                          squared <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb455-13"><a href="#cb455-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE: 197.7
RMSE: 331.7
RMSE: 331.7</code></pre>
</div>
</div>
<div class="cell" data-execution_count="186">
<div class="sourceCode cell-code" id="cb457"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb457-1"><a href="#cb457-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the difference between the valid and predicted prices</span></span>
<span id="cb457-2"><a href="#cb457-2" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> data_Malaga[:(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">92</span>)]</span>
<span id="cb457-3"><a href="#cb457-3" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> data_Malaga[(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">91</span>):]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="187">
<div class="sourceCode cell-code" id="cb458"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb458-1"><a href="#cb458-1" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Predictions"</span>, predictions, <span class="va">True</span>)</span>
<span id="cb458-2"><a href="#cb458-2" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Difference"</span>, valid[<span class="st">"Predictions"</span>] <span class="op">-</span> valid[<span class="st">"num_casos"</span>], <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="188">
<div class="sourceCode cell-code" id="cb459"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb459-1"><a href="#cb459-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Zoom-in to a closer timeframe</span></span>
<span id="cb459-2"><a href="#cb459-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Date from which on the date is displayed</span></span>
<span id="cb459-3"><a href="#cb459-3" aria-hidden="true" tabindex="-1"></a>display_start_date <span class="op">=</span> <span class="st">"2021-07-15"</span> </span>
<span id="cb459-4"><a href="#cb459-4" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> valid[valid.index <span class="op">&gt;</span> display_start_date]</span>
<span id="cb459-5"><a href="#cb459-5" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> train[train.index <span class="op">&gt;</span> display_start_date]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="189">
<div class="sourceCode cell-code" id="cb460"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb460-1"><a href="#cb460-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the data</span></span>
<span id="cb460-2"><a href="#cb460-2" aria-hidden="true" tabindex="-1"></a>matplotlib.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb460-3"><a href="#cb460-3" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">22</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb460-4"><a href="#cb460-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb460-5"><a href="#cb460-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Train</span></span>
<span id="cb460-6"><a href="#cb460-6" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> train.index<span class="op">;</span> </span>
<span id="cb460-7"><a href="#cb460-7" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> train[[<span class="st">"num_casos"</span>]]</span>
<span id="cb460-8"><a href="#cb460-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Test / validation </span></span>
<span id="cb460-9"><a href="#cb460-9" aria-hidden="true" tabindex="-1"></a>xv <span class="op">=</span> valid.index<span class="op">;</span> </span>
<span id="cb460-10"><a href="#cb460-10" aria-hidden="true" tabindex="-1"></a>yv <span class="op">=</span> valid[[<span class="st">"num_casos"</span>, <span class="st">"Predictions"</span>]]</span>
<span id="cb460-11"><a href="#cb460-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb460-12"><a href="#cb460-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb460-13"><a href="#cb460-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Malaga: Predictions vs Real infections"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb460-14"><a href="#cb460-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Nº Cases"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb460-15"><a href="#cb460-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb460-16"><a href="#cb460-16" aria-hidden="true" tabindex="-1"></a>plt.plot(yt, color<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb460-17"><a href="#cb460-17" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"Predictions"</span>], color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb460-18"><a href="#cb460-18" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"num_casos"</span>], color<span class="op">=</span><span class="st">"green"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb460-19"><a href="#cb460-19" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"LSTM Predictions"</span>, <span class="st">"Test"</span>], </span>
<span id="cb460-20"><a href="#cb460-20" aria-hidden="true" tabindex="-1"></a>           loc<span class="op">=</span><span class="st">"upper left"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb460-21"><a href="#cb460-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb460-22"><a href="#cb460-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot with the differences</span></span>
<span id="cb460-23"><a href="#cb460-23" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> valid.index</span>
<span id="cb460-24"><a href="#cb460-24" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> valid[<span class="st">"Difference"</span>]</span>
<span id="cb460-25"><a href="#cb460-25" aria-hidden="true" tabindex="-1"></a>plt.bar(x, y, width<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">"grey"</span>)</span>
<span id="cb460-26"><a href="#cb460-26" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb460-27"><a href="#cb460-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_uni_files/figure-html/cell-190-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="sevilla-1" class="level2">
<h2 class="anchored" data-anchor-id="sevilla-1">Sevilla</h2>
<div class="cell" data-execution_count="190">
<div class="sourceCode cell-code" id="cb461"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb461-1"><a href="#cb461-1" aria-hidden="true" tabindex="-1"></a>data_Sevilla <span class="op">=</span> data_covid.loc[data_covid[<span class="st">'provincia'</span>] <span class="op">==</span> <span class="st">'Sevilla'</span>]</span>
<span id="cb461-2"><a href="#cb461-2" aria-hidden="true" tabindex="-1"></a>data_Sevilla <span class="op">=</span> data_Sevilla.set_index(<span class="st">'fecha'</span>)</span>
<span id="cb461-3"><a href="#cb461-3" aria-hidden="true" tabindex="-1"></a>data_Sevilla <span class="op">=</span> data_Sevilla.<span class="bu">filter</span>([<span class="st">'num_casos'</span>])</span>
<span id="cb461-4"><a href="#cb461-4" aria-hidden="true" tabindex="-1"></a>data_Sevilla <span class="op">=</span> data_Sevilla[<span class="st">'2020-06-14'</span>:<span class="st">'2021-12-31'</span>]</span>
<span id="cb461-5"><a href="#cb461-5" aria-hidden="true" tabindex="-1"></a>data_Sevilla</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="190">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
    </tr>
    <tr>
      <th>fecha</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-14</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2020-06-15</th>
      <td>2</td>
    </tr>
    <tr>
      <th>2020-06-16</th>
      <td>1</td>
    </tr>
    <tr>
      <th>2020-06-17</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2020-06-18</th>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>2021-12-27</th>
      <td>2617</td>
    </tr>
    <tr>
      <th>2021-12-28</th>
      <td>3190</td>
    </tr>
    <tr>
      <th>2021-12-29</th>
      <td>3692</td>
    </tr>
    <tr>
      <th>2021-12-30</th>
      <td>3508</td>
    </tr>
    <tr>
      <th>2021-12-31</th>
      <td>2816</td>
    </tr>
  </tbody>
</table>
<p>566 rows × 1 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="191">
<div class="sourceCode cell-code" id="cb462"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb462-1"><a href="#cb462-1" aria-hidden="true" tabindex="-1"></a>data_Sevilla.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="191">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>566.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>383.807420</td>
    </tr>
    <tr>
      <th>std</th>
      <td>454.714408</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>112.750000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>260.500000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>459.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>3692.000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="192">
<div class="sourceCode cell-code" id="cb463"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb463-1"><a href="#cb463-1" aria-hidden="true" tabindex="-1"></a>np_data_Sevilla <span class="op">=</span> data_Sevilla.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="193">
<div class="sourceCode cell-code" id="cb464"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb464-1"><a href="#cb464-1" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb464-2"><a href="#cb464-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Sevilla <span class="op">=</span> scaler.fit_transform(np_data_Sevilla)</span>
<span id="cb464-3"><a href="#cb464-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud del conjunto de datos disponible: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_Sevilla)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud del conjunto de datos disponible: 566</code></pre>
</div>
</div>
<div class="cell" data-execution_count="194">
<div class="sourceCode cell-code" id="cb466"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb466-1"><a href="#cb466-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we are going to predict future values based on the X past elements, </span></span>
<span id="cb466-2"><a href="#cb466-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to create a list with those historic information for each element</span></span>
<span id="cb466-3"><a href="#cb466-3" aria-hidden="true" tabindex="-1"></a>historic_values <span class="op">=</span> <span class="dv">90</span></span>
<span id="cb466-4"><a href="#cb466-4" aria-hidden="true" tabindex="-1"></a>scaled_data_Sevilla_x <span class="op">=</span> []</span>
<span id="cb466-5"><a href="#cb466-5" aria-hidden="true" tabindex="-1"></a>scaled_data_Sevilla_y <span class="op">=</span> []</span>
<span id="cb466-6"><a href="#cb466-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb466-7"><a href="#cb466-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> num_casos_i <span class="kw">in</span> <span class="bu">range</span>(historic_values, <span class="bu">len</span>(scaled_data_Sevilla)):</span>
<span id="cb466-8"><a href="#cb466-8" aria-hidden="true" tabindex="-1"></a>    scaled_data_Sevilla_x.append(scaled_data_Sevilla[(num_casos_i<span class="op">-</span>historic_values):num_casos_i, <span class="dv">0</span>])</span>
<span id="cb466-9"><a href="#cb466-9" aria-hidden="true" tabindex="-1"></a>    scaled_data_Sevilla_y.append(scaled_data_Sevilla[num_casos_i, <span class="dv">0</span>])</span>
<span id="cb466-10"><a href="#cb466-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb466-11"><a href="#cb466-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the x_train and y_train to numpy arrays</span></span>
<span id="cb466-12"><a href="#cb466-12" aria-hidden="true" tabindex="-1"></a>scaled_data_Sevilla_x <span class="op">=</span> np.array(scaled_data_Sevilla_x)</span>
<span id="cb466-13"><a href="#cb466-13" aria-hidden="true" tabindex="-1"></a>scaled_data_Sevilla_y <span class="op">=</span> np.array(scaled_data_Sevilla_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="195">
<div class="sourceCode cell-code" id="cb467"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb467-1"><a href="#cb467-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train data looks like</span></span>
<span id="cb467-2"><a href="#cb467-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Sevilla_x[<span class="dv">235</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="195">
<pre><code>array([0.18634886, 0.19799567, 0.14626219, 0.0896533 , 0.13894908,
       0.1695558 , 0.14572048, 0.12242687, 0.13434453, 0.06500542,
       0.05390033, 0.08206934, 0.08667389, 0.09452871, 0.06798483,
       0.05904659, 0.04252438, 0.0343987 , 0.06554713, 0.06473456,
       0.05444204, 0.0503792 , 0.05796316, 0.04577465, 0.03819068,
       0.04712893, 0.0528169 , 0.0663597 , 0.06013001, 0.05119177,
       0.03764897, 0.031961  , 0.05119177, 0.05010834, 0.04739978,
       0.05119177, 0.05390033, 0.03927411, 0.03737811, 0.06013001,
       0.05633803, 0.05606717, 0.05850488, 0.06473456, 0.04658722,
       0.04198267, 0.07150596, 0.07340195, 0.05823402, 0.08071506,
       0.07773564, 0.05877573, 0.05471289, 0.07990249, 0.08829902,
       0.0872156 , 0.09019502, 0.07069339, 0.08775731, 0.08396533,
       0.14951246, 0.12432286, 0.12269772, 0.12378115, 0.13028169,
       0.11348862, 0.07936078, 0.13299025, 0.12269772, 0.11213434,
       0.12107259, 0.12432286, 0.09723727, 0.07042254, 0.09886241,
       0.11782232, 0.10157096, 0.10346696, 0.12621885, 0.08342362,
       0.07340195, 0.0847779 , 0.08559047, 0.11159263, 0.10292524,
       0.08911159, 0.07502709, 0.04821235, 0.08315276, 0.09913326])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="196">
<div class="sourceCode cell-code" id="cb469"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb469-1"><a href="#cb469-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test data looks like</span></span>
<span id="cb469-2"><a href="#cb469-2" aria-hidden="true" tabindex="-1"></a>scaled_data_Sevilla_y[<span class="dv">235</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="196">
<pre><code>0.10861321776814734</code></pre>
</div>
</div>
<div class="cell" data-execution_count="197">
<div class="sourceCode cell-code" id="cb471"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb471-1"><a href="#cb471-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since the first 90th values does not have historic, the dataset has been reduced in 90 values</span></span>
<span id="cb471-2"><a href="#cb471-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud datos de entrenamiento con historico: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_Sevilla_y)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud datos de entrenamiento con historico: 476</code></pre>
</div>
</div>
<div class="cell" data-execution_count="198">
<div class="sourceCode cell-code" id="cb473"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb473-1"><a href="#cb473-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we split data in train and test</span></span>
<span id="cb473-2"><a href="#cb473-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as in previous analysis, we are going to predict a maximum of 91 days</span></span>
<span id="cb473-3"><a href="#cb473-3" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> scaled_data_Sevilla_x[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_Sevilla_x)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb473-4"><a href="#cb473-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> scaled_data_Sevilla_y[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_Sevilla_y)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb473-5"><a href="#cb473-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de entrenamiento: x=</span><span class="sc">{</span><span class="bu">len</span>(x_train)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb473-6"><a href="#cb473-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb473-7"><a href="#cb473-7" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> scaled_data_Sevilla_x[<span class="bu">len</span>(scaled_data_Sevilla_x)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_Sevilla_x)]</span>
<span id="cb473-8"><a href="#cb473-8" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaled_data_Sevilla_y[<span class="bu">len</span>(scaled_data_Sevilla_y)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_Sevilla_y)]</span>
<span id="cb473-9"><a href="#cb473-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de test: x=</span><span class="sc">{</span><span class="bu">len</span>(x_test)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_test)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cantidad datos de entrenamiento: x=385 - y=385
Cantidad datos de test: x=90 - y=90</code></pre>
</div>
</div>
<div class="cell" data-execution_count="199">
<div class="sourceCode cell-code" id="cb475"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb475-1"><a href="#cb475-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data to feed de recurrent network</span></span>
<span id="cb475-2"><a href="#cb475-2" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> np.reshape(x_train, (x_train.shape[<span class="dv">0</span>], x_train.shape[<span class="dv">1</span>], <span class="dv">1</span>))</span>
<span id="cb475-3"><a href="#cb475-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train data shape:"</span>)</span>
<span id="cb475-4"><a href="#cb475-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_train.shape)</span>
<span id="cb475-5"><a href="#cb475-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_train.shape)</span>
<span id="cb475-6"><a href="#cb475-6" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> np.reshape(x_test, (x_test.shape[<span class="dv">0</span>], x_test.shape[<span class="dv">1</span>], <span class="dv">1</span>))</span>
<span id="cb475-7"><a href="#cb475-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test data shape:"</span>)</span>
<span id="cb475-8"><a href="#cb475-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_test.shape)</span>
<span id="cb475-9"><a href="#cb475-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train data shape:
(385, 90, 1)
(385,)
Test data shape:
(90, 90, 1)
(90,)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="200">
<div class="sourceCode cell-code" id="cb477"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb477-1"><a href="#cb477-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure / setup the neural network model - LSTM</span></span>
<span id="cb477-2"><a href="#cb477-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the model</span></span>
<span id="cb477-3"><a href="#cb477-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Build model...'</span>)</span>
<span id="cb477-4"><a href="#cb477-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb477-5"><a href="#cb477-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with Neurons </span></span>
<span id="cb477-6"><a href="#cb477-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputshape = neurons -&gt; Timestamps</span></span>
<span id="cb477-7"><a href="#cb477-7" aria-hidden="true" tabindex="-1"></a>neurons<span class="op">=</span> x_train.shape[<span class="dv">1</span>]</span>
<span id="cb477-8"><a href="#cb477-8" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">90</span>, </span>
<span id="cb477-9"><a href="#cb477-9" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb477-10"><a href="#cb477-10" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>, </span>
<span id="cb477-11"><a href="#cb477-11" aria-hidden="true" tabindex="-1"></a>               input_shape <span class="op">=</span> (x_train.shape[<span class="dv">1</span>], <span class="dv">1</span>))) </span>
<span id="cb477-12"><a href="#cb477-12" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">50</span>, </span>
<span id="cb477-13"><a href="#cb477-13" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb477-14"><a href="#cb477-14" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>)) </span>
<span id="cb477-15"><a href="#cb477-15" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">25</span>, </span>
<span id="cb477-16"><a href="#cb477-16" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb477-17"><a href="#cb477-17" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">False</span>)) </span>
<span id="cb477-18"><a href="#cb477-18" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">5</span>, activation <span class="op">=</span> <span class="st">'relu'</span>))</span>
<span id="cb477-19"><a href="#cb477-19" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Build model...</code></pre>
</div>
</div>
<div class="cell" data-execution_count="201">
<div class="sourceCode cell-code" id="cb479"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb479-1"><a href="#cb479-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mean_squared_error'</span>)</span>
<span id="cb479-2"><a href="#cb479-2" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "sequential_9"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Layer (type)                Output Shape              Param #   </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_27 (LSTM)              (None, 90, 90)            33120     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_28 (LSTM)              (None, 90, 50)            28200     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_29 (LSTM)              (None, 25)                7600      </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_18 (Dense)            (None, 5)                 130       </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_19 (Dense)            (None, 1)                 6         </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Total params: 69,056</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Trainable params: 69,056</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Non-trainable params: 0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
</div>
<div class="cell" data-execution_count="202">
<div class="sourceCode cell-code" id="cb499"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb499-1"><a href="#cb499-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model</span></span>
<span id="cb499-2"><a href="#cb499-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fit network</span></span>
<span id="cb499-3"><a href="#cb499-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(x_train, </span>
<span id="cb499-4"><a href="#cb499-4" aria-hidden="true" tabindex="-1"></a>                    y_train, </span>
<span id="cb499-5"><a href="#cb499-5" aria-hidden="true" tabindex="-1"></a>                    batch_size <span class="op">=</span> <span class="dv">1000</span>, </span>
<span id="cb499-6"><a href="#cb499-6" aria-hidden="true" tabindex="-1"></a>                    epochs <span class="op">=</span> <span class="dv">50</span>, </span>
<span id="cb499-7"><a href="#cb499-7" aria-hidden="true" tabindex="-1"></a>                    validation_data <span class="op">=</span> (x_test, y_test), </span>
<span id="cb499-8"><a href="#cb499-8" aria-hidden="true" tabindex="-1"></a>                    verbose <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="203">
<div class="sourceCode cell-code" id="cb500"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb500-1"><a href="#cb500-1" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'loss'</span>], label<span class="op">=</span><span class="st">'train'</span>)</span>
<span id="cb500-2"><a href="#cb500-2" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'val_loss'</span>], label<span class="op">=</span><span class="st">'test'</span>)</span>
<span id="cb500-3"><a href="#cb500-3" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb500-4"><a href="#cb500-4" aria-hidden="true" tabindex="-1"></a>plt.show() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_uni_files/figure-html/cell-204-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="204">
<div class="sourceCode cell-code" id="cb501"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb501-1"><a href="#cb501-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predicted values</span></span>
<span id="cb501-2"><a href="#cb501-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.predict(x_test)</span>
<span id="cb501-3"><a href="#cb501-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> scaler.inverse_transform(predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1/3 [=========&gt;....................] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - 0s 32ms/step</code></pre>
</div>
</div>
<div class="cell" data-execution_count="205">
<div class="sourceCode cell-code" id="cb505"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb505-1"><a href="#cb505-1" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y_test.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb505-2"><a href="#cb505-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaler.inverse_transform(y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="206">
<div class="sourceCode cell-code" id="cb506"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb506-1"><a href="#cb506-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean absolute error (MAE)</span></span>
<span id="cb506-2"><a href="#cb506-2" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, predictions)</span>
<span id="cb506-3"><a href="#cb506-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MAE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(mae, <span class="dv">1</span>)))</span>
<span id="cb506-4"><a href="#cb506-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb506-5"><a href="#cb506-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb506-6"><a href="#cb506-6" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test,predictions))</span>
<span id="cb506-7"><a href="#cb506-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span>
<span id="cb506-8"><a href="#cb506-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb506-9"><a href="#cb506-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb506-10"><a href="#cb506-10" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> mean_squared_error(y_test, </span>
<span id="cb506-11"><a href="#cb506-11" aria-hidden="true" tabindex="-1"></a>                          predictions,</span>
<span id="cb506-12"><a href="#cb506-12" aria-hidden="true" tabindex="-1"></a>                          squared <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb506-13"><a href="#cb506-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE: 329.2
RMSE: 595.9
RMSE: 595.9</code></pre>
</div>
</div>
<div class="cell" data-execution_count="207">
<div class="sourceCode cell-code" id="cb508"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb508-1"><a href="#cb508-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the difference between the valid and predicted prices</span></span>
<span id="cb508-2"><a href="#cb508-2" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> data_Sevilla[:(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">92</span>)]</span>
<span id="cb508-3"><a href="#cb508-3" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> data_Sevilla[(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">91</span>):]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="208">
<div class="sourceCode cell-code" id="cb509"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb509-1"><a href="#cb509-1" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Predictions"</span>, predictions, <span class="va">True</span>)</span>
<span id="cb509-2"><a href="#cb509-2" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Difference"</span>, valid[<span class="st">"Predictions"</span>] <span class="op">-</span> valid[<span class="st">"num_casos"</span>], <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="209">
<div class="sourceCode cell-code" id="cb510"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb510-1"><a href="#cb510-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Zoom-in to a closer timeframe</span></span>
<span id="cb510-2"><a href="#cb510-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Date from which on the date is displayed</span></span>
<span id="cb510-3"><a href="#cb510-3" aria-hidden="true" tabindex="-1"></a>display_start_date <span class="op">=</span> <span class="st">"2021-07-15"</span> </span>
<span id="cb510-4"><a href="#cb510-4" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> valid[valid.index <span class="op">&gt;</span> display_start_date]</span>
<span id="cb510-5"><a href="#cb510-5" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> train[train.index <span class="op">&gt;</span> display_start_date]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="210">
<div class="sourceCode cell-code" id="cb511"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb511-1"><a href="#cb511-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the data</span></span>
<span id="cb511-2"><a href="#cb511-2" aria-hidden="true" tabindex="-1"></a>matplotlib.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb511-3"><a href="#cb511-3" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">22</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb511-4"><a href="#cb511-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-5"><a href="#cb511-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Train</span></span>
<span id="cb511-6"><a href="#cb511-6" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> train.index<span class="op">;</span> </span>
<span id="cb511-7"><a href="#cb511-7" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> train[[<span class="st">"num_casos"</span>]]</span>
<span id="cb511-8"><a href="#cb511-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Test / validation </span></span>
<span id="cb511-9"><a href="#cb511-9" aria-hidden="true" tabindex="-1"></a>xv <span class="op">=</span> valid.index<span class="op">;</span> </span>
<span id="cb511-10"><a href="#cb511-10" aria-hidden="true" tabindex="-1"></a>yv <span class="op">=</span> valid[[<span class="st">"num_casos"</span>, <span class="st">"Predictions"</span>]]</span>
<span id="cb511-11"><a href="#cb511-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-12"><a href="#cb511-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb511-13"><a href="#cb511-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Sevilla: Predictions vs Real infections"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb511-14"><a href="#cb511-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Nº Cases"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb511-15"><a href="#cb511-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-16"><a href="#cb511-16" aria-hidden="true" tabindex="-1"></a>plt.plot(yt, color<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb511-17"><a href="#cb511-17" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"Predictions"</span>], color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb511-18"><a href="#cb511-18" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"num_casos"</span>], color<span class="op">=</span><span class="st">"green"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb511-19"><a href="#cb511-19" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"LSTM Predictions"</span>, <span class="st">"Test"</span>], </span>
<span id="cb511-20"><a href="#cb511-20" aria-hidden="true" tabindex="-1"></a>           loc<span class="op">=</span><span class="st">"upper left"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb511-21"><a href="#cb511-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-22"><a href="#cb511-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot with the differences</span></span>
<span id="cb511-23"><a href="#cb511-23" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> valid.index</span>
<span id="cb511-24"><a href="#cb511-24" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> valid[<span class="st">"Difference"</span>]</span>
<span id="cb511-25"><a href="#cb511-25" aria-hidden="true" tabindex="-1"></a>plt.bar(x, y, width<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">"grey"</span>)</span>
<span id="cb511-26"><a href="#cb511-26" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb511-27"><a href="#cb511-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_uni_files/figure-html/cell-211-output-1.png" class="img-fluid"></p>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./lstm.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Task 6: LSTM</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./lstm_multi.html" class="pagination-link">
        <span class="nav-page-text">LSTM multivariate prediction</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>