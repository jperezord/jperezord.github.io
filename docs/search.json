[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "PEC3 - COVID-19 Outbreak prediction",
    "section": "",
    "text": "This is the website for the master’s thesis “COVID-19: Outbreak prediction combining meteorological and mobility data” for UOC’s master in Data Science.\nThis book contains the development of the third working package (PEC3) with delivery date 15-may-2022.\nThroughout the book, it is exposed the acquisition, cleaning and exploration process of the starting data. It also includes the development of the predictive models used for outbreak prediction and the results obtained.\n\n\n\n\n\n\nThis book was written with the Quarto publishing system and hosted at https://jperezord.github.io/ using Github pages."
  },
  {
    "objectID": "index.html#authorship",
    "href": "index.html#authorship",
    "title": "PEC3 - COVID-19 Outbreak prediction",
    "section": "Authorship",
    "text": "Authorship\n\nAuthor: Jaime Pérez Ordieres\nTutor: Carlos Luis Sánchez Bocanegra"
  },
  {
    "objectID": "index.html#license",
    "href": "index.html#license",
    "title": "PEC3 - COVID-19 Outbreak prediction",
    "section": "License",
    "text": "License\nThis work is under an Attribution-NonCommercial-NoDerivs work license 3.0 (CC BY-NC-ND 3.0) 3.0 CreativeCommons"
  },
  {
    "objectID": "intro.html",
    "href": "intro.html",
    "title": "Introduction",
    "section": "",
    "text": "Transmission of the virus occurs primarily through exhalation of very small respiratory droplets and particles that contain the virus even when the infected person has no symptoms. According to the World Health Organization (WHO), infected people are apparently most contagious just before symptoms appear (about two days before) and in the first phase of the disease [link]. Said respiratory particles can be inhaled by people and/or deposit on their eyes, nose or mouth.\nThe current measures that governments are taking to mitigate the socioeconomic impact of COVID-19 and support the economic recovery of the countries seem to have a tendency towards coexistence with the virus. This strategy is mainly supported by the high vaccination rate that minimizes the potential health effects of the virus. Given this scenario, obtaining a prediction model that includes factors considered key in transmission will be vital for proper optimization of the health system’s resources.\nThe main objective of this work will be the use of machine learning techniques applied to time series for the prediction of COVID-19 outbreaks. For this, meteorological data and mobility data will be used, detailing demographic factors as far as possible.\n\nObjetives\nThe main objectives are:\n\nIdentify whether meteorological and mobility factors are important in predicting COVID-19 outbreaks.\nUse of machine learning and time series prediction techniques for modeling the evolution of the virus.\n\nFor which, it will be necessary to achieve a series of secondary objectives:\n\nIdentification of relevant data and study of the possibilities they offer.\nUnderstand the behavior of the virus by analyzing the medical literature Identification of machine learning and prediction techniques that best suit the purpose of our project."
  },
  {
    "objectID": "data.html",
    "href": "data.html",
    "title": "Task 1: Data acquisition and exploration",
    "section": "",
    "text": "The data published in the CNE COVID-19 Panel offers information related to infections, recoveries and deaths reported by local and regional governments in Spain. It comes from the individualised declaration of COVID-19 cases to the National Epidemiological Surveillance Network (RENAVE) through the SiViEs computer application.\nIn SiViEs, all reported cases are accounted for, following the surveillance strategy in force at the time (Strategy for early detection, surveillance and control of COVID-19 available at https://www.mscbs.gob.es/profesionales/saludPublica/ccayes/alertasActual/nCov/documentos/COVID19_Estrategia_vigilancia_y_control_e_indicadores.pdf\nIn the current work, we will use two datasets from CNE:\n\ncasos_tecnica_provincia.csv: Number of cases by diagnostic technique and province (of residence)\ncasos_hosp_uci_def_sexo_edad_provres.csv: Number of hospitalisations, number of admissions to ICU and number of deaths by sex, age and province of residence."
  },
  {
    "objectID": "data.html#mobility-data",
    "href": "data.html#mobility-data",
    "title": "Task 1: Data acquisition and exploration",
    "section": "Mobility data",
    "text": "Mobility data\n\nINE data\nThe main objective of the INE dataset is to measure mobility between areas during the period starting in March-2020 and ended in 2021.\nThe population scope is made up of the mobile telephones of the resident population in Spain of the three main mobile operators. Foreign numbered phones are excluded, usually mobiles in the hands of tourists which operate in Spain while roaming.\nData is available in the Spanish National Institute of Statistics in the following link. It is also provided a link for direct access to the download portal via queries.\nData can be downloaded in different formats. We recommend using ‘CSV: separado por ;’.\n\n\nGoogle data\nThe data published at https://www.google.com/covid19/mobility/?hl=en-GB offers information related to mobility using the Google ecosystem application services such as Android.\nThe dataset information is available worldwide. In our case, only the information relating to Spain was extracted.\nThe Google Mobility Reports aim to provide insights into what has changed in response to policies aimed at combating COVID-19. The reports chart movement trends over time by geography, across different categories of places such as retail and recreation, supermarkets and pharmacies, parks, public transport, workplaces and residential.\nEach Community Mobility Report is broken down by location and displays the change in visits to places.\nData provided by Google:\n\nRegion_Mobility_Report_CSVs.zip contains worldwide information\n20XX_ES_Region_Mobility_Report.csv contains information for Spain. Note: information is provided by year in separate files."
  },
  {
    "objectID": "data.html#meteorological-data",
    "href": "data.html#meteorological-data",
    "title": "Task 1: Data acquisition and exploration",
    "section": "Meteorological data",
    "text": "Meteorological data\n\nAEMET data\nAEMET’s meteorological data are available throug its service AEMET OpenData.\nAEMET OpenData is a REST API developed by AEMET that allows the dissemination and reuse of the Agency’s meteorological and climatological information, in the sense indicated in Law 18/2015, of July 9, amending Law 37/2007, of November 16, on the reuse of public sector information.\nAEMET OpenData allows free download of the data specified in Annex II of the resolution of December 30, 2015 of AEMET, which establishes the public prices to govern the provision of meteorological and climatological services. This resolution has been published in the BOE No. 4 of January 5, 2016. Also available are the data obtained by AEMET in the framework of the collaboration agreement between the State Research Agency and the State Meteorological Agency regarding Spanish activities in Antarctica.\nIn order to access AEMET OpenData, it is necessary to request a free API Key."
  },
  {
    "objectID": "cne_data.html",
    "href": "cne_data.html",
    "title": "CNE data",
    "section": "",
    "text": "Load packages:"
  },
  {
    "objectID": "cne_data.html#cne-diagnostic-technique",
    "href": "cne_data.html#cne-diagnostic-technique",
    "title": "CNE data",
    "section": "CNE diagnostic technique",
    "text": "CNE diagnostic technique\nNumber of cases by diagnostic technique and province of residence [link]:\n\nprovincia_iso: ISO code of the province of residence.\nfecha: date. From pandemic onset to May 10, the date of symptom or, if not, the date of diagnosis/symptoms minus 6 days. From May 11, the date of symptom onset, or in the absence thereof, the date of diagnosis minus 3 days.\nnum_casos: Number of cases by diagnostic technique and province of residence.\nnum_casos_prueba_pcr: Number of cases with PCR laboratory test or molecular techniques.\nnum_casos_prueba_test_ac: Number of cases with laboratory test of rapid antibody test.\nnum_casos_prueba_ag: Number of cases with laboratory test of antigen detection test antigen test.\nnum_casos_prueba_elisa: Number of cases with high-resolution serology laboratory testing.\nnum_casos_prueba_desconocida: Number of cases without information on laboratory testing.\n\n\ncne_tecnica <- read_csv(\n      file = here(\"data\", \"raw\", \"casos_tecnica_provincia.csv\"),\n      show_col_types = FALSE\n)\ncne_tecnica\n\n# A tibble: 43,407 × 8\n   provincia_iso fecha      num_casos num_casos_prueba_pcr num_casos_prueba_tes…\n   <chr>         <date>         <dbl>                <dbl>                 <dbl>\n 1 A             2020-01-01         0                    0                     0\n 2 AB            2020-01-01         0                    0                     0\n 3 AL            2020-01-01         0                    0                     0\n 4 AV            2020-01-01         0                    0                     0\n 5 B             2020-01-01         0                    0                     0\n 6 BA            2020-01-01         0                    0                     0\n 7 BI            2020-01-01         0                    0                     0\n 8 BU            2020-01-01         0                    0                     0\n 9 C             2020-01-01         0                    0                     0\n10 CA            2020-01-01         0                    0                     0\n# … with 43,397 more rows, and 3 more variables: num_casos_prueba_ag <dbl>,\n#   num_casos_prueba_elisa <dbl>, num_casos_prueba_desconocida <dbl>\n\n\nCheck data distribution and missing data.\n\nskim(cne_tecnica)\n\n\nData summary\n\n\nName\ncne_tecnica\n\n\nNumber of rows\n43407\n\n\nNumber of columns\n8\n\n\n_______________________\n\n\n\nColumn type frequency:\n\n\n\ncharacter\n1\n\n\nDate\n1\n\n\nnumeric\n6\n\n\n________________________\n\n\n\nGroup variables\nNone\n\n\n\nVariable type: character\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nempty\nn_unique\nwhitespace\n\n\n\n\nprovincia_iso\n819\n0.98\n1\n2\n0\n52\n0\n\n\n\nVariable type: Date\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nmedian\nn_unique\n\n\n\n\nfecha\n0\n1\n2020-01-01\n2022-03-29\n2021-02-13\n819\n\n\n\nVariable type: numeric\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmean\nsd\np0\np25\np50\np75\np100\nhist\n\n\n\n\nnum_casos\n0\n1\n265.67\n973.38\n0\n11\n58\n184\n34701\n▇▁▁▁▁\n\n\nnum_casos_prueba_pcr\n0\n1\n122.34\n328.97\n0\n7\n36\n109\n10167\n▇▁▁▁▁\n\n\nnum_casos_prueba_test_ac\n0\n1\n0.11\n0.97\n0\n0\n0\n0\n32\n▇▁▁▁▁\n\n\nnum_casos_prueba_ag\n0\n1\n128.28\n715.58\n0\n0\n8\n50\n31073\n▇▁▁▁▁\n\n\nnum_casos_prueba_elisa\n0\n1\n0.11\n1.12\n0\n0\n0\n0\n55\n▇▁▁▁▁\n\n\nnum_casos_prueba_desconocida\n0\n1\n14.83\n101.87\n0\n0\n0\n0\n3418\n▇▁▁▁▁\n\n\n\n\n\n\ncne_tecnica %>%  \n      tabyl(provincia_iso) %>% \n      adorn_pct_formatting() %>%\n      adorn_title(row_name = \"Province\")\n\n                                 NA\n Province   n percent valid_percent\n        A 819    1.9%          1.9%\n       AB 819    1.9%          1.9%\n       AL 819    1.9%          1.9%\n       AV 819    1.9%          1.9%\n        B 819    1.9%          1.9%\n       BA 819    1.9%          1.9%\n       BI 819    1.9%          1.9%\n       BU 819    1.9%          1.9%\n        C 819    1.9%          1.9%\n       CA 819    1.9%          1.9%\n       CC 819    1.9%          1.9%\n       CE 819    1.9%          1.9%\n       CO 819    1.9%          1.9%\n       CR 819    1.9%          1.9%\n       CS 819    1.9%          1.9%\n       CU 819    1.9%          1.9%\n       GC 819    1.9%          1.9%\n       GI 819    1.9%          1.9%\n       GR 819    1.9%          1.9%\n       GU 819    1.9%          1.9%\n        H 819    1.9%          1.9%\n       HU 819    1.9%          1.9%\n        J 819    1.9%          1.9%\n        L 819    1.9%          1.9%\n       LE 819    1.9%          1.9%\n       LO 819    1.9%          1.9%\n       LU 819    1.9%          1.9%\n        M 819    1.9%          1.9%\n       MA 819    1.9%          1.9%\n       ML 819    1.9%          1.9%\n       MU 819    1.9%          1.9%\n       NC 819    1.9%          1.9%\n        O 819    1.9%          1.9%\n       OR 819    1.9%          1.9%\n        P 819    1.9%          1.9%\n       PM 819    1.9%          1.9%\n       PO 819    1.9%          1.9%\n        S 819    1.9%          1.9%\n       SA 819    1.9%          1.9%\n       SE 819    1.9%          1.9%\n       SG 819    1.9%          1.9%\n       SO 819    1.9%          1.9%\n       SS 819    1.9%          1.9%\n        T 819    1.9%          1.9%\n       TE 819    1.9%          1.9%\n       TF 819    1.9%          1.9%\n       TO 819    1.9%          1.9%\n        V 819    1.9%          1.9%\n       VA 819    1.9%          1.9%\n       VI 819    1.9%          1.9%\n        Z 819    1.9%          1.9%\n       ZA 819    1.9%          1.9%\n     <NA> 819    1.9%             -\n\n\nCleaning NAs\n\ncne_tecnica <- cne_tecnica %>% \n      drop_na(provincia_iso)\n      \n# Show data information\nskim(cne_tecnica)\n\n\nData summary\n\n\nName\ncne_tecnica\n\n\nNumber of rows\n42588\n\n\nNumber of columns\n8\n\n\n_______________________\n\n\n\nColumn type frequency:\n\n\n\ncharacter\n1\n\n\nDate\n1\n\n\nnumeric\n6\n\n\n________________________\n\n\n\nGroup variables\nNone\n\n\n\nVariable type: character\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nempty\nn_unique\nwhitespace\n\n\n\n\nprovincia_iso\n0\n1\n1\n2\n0\n52\n0\n\n\n\nVariable type: Date\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nmedian\nn_unique\n\n\n\n\nfecha\n0\n1\n2020-01-01\n2022-03-29\n2021-02-13\n819\n\n\n\nVariable type: numeric\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmean\nsd\np0\np25\np50\np75\np100\nhist\n\n\n\n\nnum_casos\n0\n1\n265.36\n979.13\n0\n11\n57\n182\n34701\n▇▁▁▁▁\n\n\nnum_casos_prueba_pcr\n0\n1\n122.65\n331.70\n0\n7\n35\n108\n10167\n▇▁▁▁▁\n\n\nnum_casos_prueba_test_ac\n0\n1\n0.11\n0.98\n0\n0\n0\n0\n32\n▇▁▁▁▁\n\n\nnum_casos_prueba_ag\n0\n1\n127.55\n718.45\n0\n0\n8\n49\n31073\n▇▁▁▁▁\n\n\nnum_casos_prueba_elisa\n0\n1\n0.12\n1.13\n0\n0\n0\n0\n55\n▇▁▁▁▁\n\n\nnum_casos_prueba_desconocida\n0\n1\n14.93\n102.69\n0\n0\n0\n0\n3418\n▇▁▁▁▁"
  },
  {
    "objectID": "cne_data.html#cne-hospitalizations",
    "href": "cne_data.html#cne-hospitalizations",
    "title": "CNE data",
    "section": "CNE hospitalizations",
    "text": "CNE hospitalizations\nNumber of cases, hospitalisations, admissions to ICU and deaths by sex, age and province of residence [link]:\n\nprovincia_iso:ISO code of the province of residence.\nfecha: date. For cases the date of diagnosis is used and for hospitalisations, ICU admissions and deaths the hospitalised cases are represented by date of hospitalisation (failing this, date of diagnosis, and if not, date of death).\nsexo: sex of cases: H (male), M (female), NC (not stated)\ngrupo_edad: age group to which the case belongs: 0-9, 10-19, 20-29, 30-39, 40-49, 50-59, 60-69, 70-79, ≥80 years. NC: not stated\nnum_casos: number of reported cases confirmed as having a positive diagnostic test for active infection (PDIA) as infection (PDIA) as set out in the Early Detection Strategy, surveillance and control strategy for COVID-19 and in addition cases notified before 11-May that required hospitalisation, ICU admission or required hospitalisation, ICU admission or died with a clinical diagnosis of COVID19, according to the case definitions in force at the time.\nnum_hosp: number of hospitalised cases\nnum_uci: number of cases admitted to ICU\nnum_def: number of deaths\n\n\ncne_hosp_data <- read_csv(\n      file = here(\"data\", \"raw\", \"casos_hosp_uci_def_sexo_edad_provres.csv\"),\n      show_col_types = FALSE\n)\ncne_hosp_data\n\n# A tibble: 1,302,210 × 8\n   provincia_iso sexo  grupo_edad fecha      num_casos num_hosp num_uci num_def\n   <chr>         <chr> <chr>      <date>         <dbl>    <dbl>   <dbl>   <dbl>\n 1 A             H     0-9        2020-01-01         0        0       0       0\n 2 A             H     10-19      2020-01-01         0        0       0       0\n 3 A             H     20-29      2020-01-01         0        0       0       0\n 4 A             H     30-39      2020-01-01         0        0       0       0\n 5 A             H     40-49      2020-01-01         0        0       0       0\n 6 A             H     50-59      2020-01-01         0        0       0       0\n 7 A             H     60-69      2020-01-01         0        0       0       0\n 8 A             H     70-79      2020-01-01         0        0       0       0\n 9 A             H     80+        2020-01-01         0        0       0       0\n10 A             H     NC         2020-01-01         0        0       0       0\n# … with 1,302,200 more rows\n\n\nCheck data distribution and missing data.\n\nskim(cne_hosp_data)\n\n\nData summary\n\n\nName\ncne_hosp_data\n\n\nNumber of rows\n1302210\n\n\nNumber of columns\n8\n\n\n_______________________\n\n\n\nColumn type frequency:\n\n\n\ncharacter\n3\n\n\nDate\n1\n\n\nnumeric\n4\n\n\n________________________\n\n\n\nGroup variables\nNone\n\n\n\nVariable type: character\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nempty\nn_unique\nwhitespace\n\n\n\n\nprovincia_iso\n24570\n0.98\n1\n2\n0\n52\n0\n\n\nsexo\n0\n1.00\n1\n2\n0\n3\n0\n\n\ngrupo_edad\n0\n1.00\n2\n5\n0\n10\n0\n\n\n\nVariable type: Date\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nmedian\nn_unique\n\n\n\n\nfecha\n0\n1\n2020-01-01\n2022-03-29\n2021-02-13\n819\n\n\n\nVariable type: numeric\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmean\nsd\np0\np25\np50\np75\np100\nhist\n\n\n\n\nnum_casos\n0\n1\n8.86\n50.52\n0\n0\n0\n4\n3741\n▇▁▁▁▁\n\n\nnum_hosp\n0\n1\n0.39\n2.49\n0\n0\n0\n0\n270\n▇▁▁▁▁\n\n\nnum_uci\n0\n1\n0.04\n0.31\n0\n0\n0\n0\n35\n▇▁▁▁▁\n\n\nnum_def\n0\n1\n0.08\n0.80\n0\n0\n0\n0\n100\n▇▁▁▁▁\n\n\n\n\n\n\ncne_hosp_data %>% \n      tabyl(provincia_iso, sexo) %>% \n      adorn_totals(where = \"col\") %>% \n      adorn_percentages(denominator = \"col\") %>% \n      adorn_pct_formatting() %>% \n      adorn_ns(position = \"front\") %>% \n      adorn_title(\n            row_name = \"Province\",\n            col_name = \"Gender\",\n            placement = \"combined\")\n\n Province/Gender           H           M          NC        Total\n               A 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              AB 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              AL 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              AV 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n               B 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              BA 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              BI 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              BU 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n               C 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              CA 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              CC 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              CE 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              CO 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              CR 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              CS 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              CU 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              GC 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              GI 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              GR 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              GU 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n               H 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              HU 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n               J 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n               L 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              LE 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              LO 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              LU 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n               M 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              MA 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              ML 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              MU 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              NC 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n               O 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              OR 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n               P 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              PM 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              PO 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n               S 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              SA 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              SE 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              SG 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              SO 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              SS 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n               T 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              TE 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              TF 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              TO 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n               V 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              VA 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              VI 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n               Z 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n              ZA 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n            <NA> 8190 (1.9%) 8190 (1.9%) 8190 (1.9%) 24570 (1.9%)\n\n\nCleaning NAs\n\ncne_hosp_data <- cne_hosp_data %>% \n      drop_na(provincia_iso)\nskim(cne_hosp_data)\n\n\nData summary\n\n\nName\ncne_hosp_data\n\n\nNumber of rows\n1277640\n\n\nNumber of columns\n8\n\n\n_______________________\n\n\n\nColumn type frequency:\n\n\n\ncharacter\n3\n\n\nDate\n1\n\n\nnumeric\n4\n\n\n________________________\n\n\n\nGroup variables\nNone\n\n\n\nVariable type: character\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nempty\nn_unique\nwhitespace\n\n\n\n\nprovincia_iso\n0\n1\n1\n2\n0\n52\n0\n\n\nsexo\n0\n1\n1\n2\n0\n3\n0\n\n\ngrupo_edad\n0\n1\n2\n5\n0\n10\n0\n\n\n\nVariable type: Date\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nmedian\nn_unique\n\n\n\n\nfecha\n0\n1\n2020-01-01\n2022-03-29\n2021-02-13\n819\n\n\n\nVariable type: numeric\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmean\nsd\np0\np25\np50\np75\np100\nhist\n\n\n\n\nnum_casos\n0\n1\n8.85\n50.82\n0\n0\n0\n4\n3741\n▇▁▁▁▁\n\n\nnum_hosp\n0\n1\n0.39\n2.51\n0\n0\n0\n0\n270\n▇▁▁▁▁\n\n\nnum_uci\n0\n1\n0.04\n0.31\n0\n0\n0\n0\n35\n▇▁▁▁▁\n\n\nnum_def\n0\n1\n0.08\n0.80\n0\n0\n0\n0\n100\n▇▁▁▁▁"
  },
  {
    "objectID": "cne_data.html#combination",
    "href": "cne_data.html#combination",
    "title": "CNE data",
    "section": "Combination",
    "text": "Combination\nWe proceed to combine both datasets.\nBefore the combination it is neccesary to group the demographic data from the hospitalisation dataframe.\n\ncne_hosp_data_grouped <-  cne_hosp_data %>% \n      group_by(provincia_iso, fecha) %>% \n      summarise_at(vars(num_casos, num_hosp, num_uci, num_def), sum)\n\nData combination:\n\ncne_data <- inner_join(cne_tecnica, \n                       cne_hosp_data_grouped, \n                       by = c(\"provincia_iso\", \"fecha\"))\ncne_data\n\n# A tibble: 42,588 × 12\n   provincia_iso fecha      num_casos.x num_casos_prueba_pcr num_casos_prueba_t…\n   <chr>         <date>           <dbl>                <dbl>               <dbl>\n 1 A             2020-01-01           0                    0                   0\n 2 AB            2020-01-01           0                    0                   0\n 3 AL            2020-01-01           0                    0                   0\n 4 AV            2020-01-01           0                    0                   0\n 5 B             2020-01-01           0                    0                   0\n 6 BA            2020-01-01           0                    0                   0\n 7 BI            2020-01-01           0                    0                   0\n 8 BU            2020-01-01           0                    0                   0\n 9 C             2020-01-01           0                    0                   0\n10 CA            2020-01-01           0                    0                   0\n# … with 42,578 more rows, and 7 more variables: num_casos_prueba_ag <dbl>,\n#   num_casos_prueba_elisa <dbl>, num_casos_prueba_desconocida <dbl>,\n#   num_casos.y <dbl>, num_hosp <dbl>, num_uci <dbl>, num_def <dbl>\n\n\nThe total number of cases aggregated from hospitalisation data (‘num_casos.y’) should be the same as the data extracted from the detection tecnica.\n\nstr_glue(\"Is the aggregated data equal? {sum(cne_data$num_casos.x) == sum(cne_data$num_casos.y)}\")\n\nIs the aggregated data equal? TRUE\n\nstr_glue(\"Summatory from tecnica data: {sum(cne_data$num_casos.x)}\")\n\nSummatory from tecnica data: 11301030\n\nstr_glue(\"Summatory from hospitalisation data: {sum(cne_data$num_casos.y)}\")\n\nSummatory from hospitalisation data: 11301030\n\n\nHence it is possible to remove one of them.\n\ncne_data <- cne_data %>% \n      rename(num_casos = num_casos.x) %>% \n      select(-num_casos.y)             # Remove num_casos from hospitalisation data)\n\nResult:\n\ncne_data\n\n# A tibble: 42,588 × 11\n   provincia_iso fecha      num_casos num_casos_prueba_pcr num_casos_prueba_tes…\n   <chr>         <date>         <dbl>                <dbl>                 <dbl>\n 1 A             2020-01-01         0                    0                     0\n 2 AB            2020-01-01         0                    0                     0\n 3 AL            2020-01-01         0                    0                     0\n 4 AV            2020-01-01         0                    0                     0\n 5 B             2020-01-01         0                    0                     0\n 6 BA            2020-01-01         0                    0                     0\n 7 BI            2020-01-01         0                    0                     0\n 8 BU            2020-01-01         0                    0                     0\n 9 C             2020-01-01         0                    0                     0\n10 CA            2020-01-01         0                    0                     0\n# … with 42,578 more rows, and 6 more variables: num_casos_prueba_ag <dbl>,\n#   num_casos_prueba_elisa <dbl>, num_casos_prueba_desconocida <dbl>,\n#   num_hosp <dbl>, num_uci <dbl>, num_def <dbl>\n\n\nThe data contains information from 2020-01-01 to 2022-03-29."
  },
  {
    "objectID": "ine_data.html",
    "href": "ine_data.html",
    "title": "INE data",
    "section": "",
    "text": "pacman::p_load(\n      here,      # file locator\n      tidyverse, # data management and ggplot2 graphics\n      skimr,     # get overview of data\n      janitor,   # produce and adorn tabulations and cross-tabulations\n      tsibble,\n      imputeTS\n)\n\nThe main objective of the INE dataset is to measure mobility between areas during the period starting in March-2020 and ended in December-2021.\nData is available in the Spanish National Institute of Statistics in the following link. It is also provided a link for direct access to the download portal via queries.\nData can be downloaded in different formats. In our case we have used ‘CSV: separado por ;’\n\n\n\nDownloading process\n\n\nThe technical project carried out for INE study is available in the following link.\n\nine_data <- read_csv2(\n      file = here(\"data\", \"raw\", \"ine_48252_estudio_movilidad.csv\"),\n      show_col_types = FALSE\n)\n\nℹ Using \"','\" as decimal and \"'.'\" as grouping mark. Use `read_delim()` for more control.\n\nine_data\n\n# A tibble: 20,667 × 7\n   `Total Nacional` `Comunidades y Ciu…` Provincias Islas `Tipo de dato` Periodo\n   <chr>            <chr>                <chr>      <chr> <chr>          <chr>  \n 1 Total Nacional   <NA>                 <NA>       <NA>  Porcentaje de… 29/12/…\n 2 Total Nacional   <NA>                 <NA>       <NA>  Porcentaje de… 26/12/…\n 3 Total Nacional   <NA>                 <NA>       <NA>  Porcentaje de… 22/12/…\n 4 Total Nacional   <NA>                 <NA>       <NA>  Porcentaje de… 19/12/…\n 5 Total Nacional   <NA>                 <NA>       <NA>  Porcentaje de… 15/12/…\n 6 Total Nacional   <NA>                 <NA>       <NA>  Porcentaje de… 12/12/…\n 7 Total Nacional   <NA>                 <NA>       <NA>  Porcentaje de… 8/12/2…\n 8 Total Nacional   <NA>                 <NA>       <NA>  Porcentaje de… 1/12/2…\n 9 Total Nacional   <NA>                 <NA>       <NA>  Porcentaje de… 28/11/…\n10 Total Nacional   <NA>                 <NA>       <NA>  Porcentaje de… 24/11/…\n# … with 20,657 more rows, and 1 more variable: Total <dbl>\n\n\nIt is needed to rename columns in order to improve the handling of the dataset.\n\nine_data <- ine_data %>% \n      select(\n            CA = 'Comunidades y Ciudades Autónomas',\n            province = Provincias,\n            islas = Islas,\n            fecha = Periodo,\n            flujo = Total\n      )\nine_data\n\n# A tibble: 20,667 × 5\n   CA    province islas fecha      flujo\n   <chr> <chr>    <chr> <chr>      <dbl>\n 1 <NA>  <NA>     <NA>  29/12/2021  15.9\n 2 <NA>  <NA>     <NA>  26/12/2021  10.2\n 3 <NA>  <NA>     <NA>  22/12/2021  18.6\n 4 <NA>  <NA>     <NA>  19/12/2021  12.6\n 5 <NA>  <NA>     <NA>  15/12/2021  21.0\n 6 <NA>  <NA>     <NA>  12/12/2021  12.9\n 7 <NA>  <NA>     <NA>  8/12/2021   12.3\n 8 <NA>  <NA>     <NA>  1/12/2021   21.4\n 9 <NA>  <NA>     <NA>  28/11/2021  12.3\n10 <NA>  <NA>     <NA>  24/11/2021  20.7\n# … with 20,657 more rows\n\n\nTransform date to a valid format:\n\nine_data <- ine_data %>% \n      mutate(fecha = as.Date(fecha, format = \"%d/%m/%Y\"))\nsummary(ine_data$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2019-11-18\" \"2020-05-23\" \"2020-10-18\" \"2020-11-27\" \"2021-05-23\" \"2021-12-29\" \n\n\nThere are missing data for CA and provinces. So, we proceed to remove the missing information.\n\nine_data <- ine_data %>% \n      drop_na(CA, province)\nskim(ine_data)\n\n\nData summary\n\n\nName\nine_data\n\n\nNumber of rows\n15687\n\n\nNumber of columns\n5\n\n\n_______________________\n\n\n\nColumn type frequency:\n\n\n\ncharacter\n3\n\n\nDate\n1\n\n\nnumeric\n1\n\n\n________________________\n\n\n\nGroup variables\nNone\n\n\n\nVariable type: character\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nempty\nn_unique\nwhitespace\n\n\n\n\nCA\n0\n1.00\n5\n27\n0\n19\n0\n\n\nprovince\n0\n1.00\n4\n22\n0\n52\n0\n\n\nislas\n12948\n0.17\n5\n13\n0\n11\n0\n\n\n\nVariable type: Date\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nmedian\nn_unique\n\n\n\n\nfecha\n0\n1\n2019-11-18\n2021-12-29\n2020-10-18\n249\n\n\n\nVariable type: numeric\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmean\nsd\np0\np25\np50\np75\np100\nhist\n\n\n\n\nflujo\n0\n1\n13.03\n4.98\n0.83\n9.44\n12.69\n16.61\n36.7\n▂▇▅▁▁\n\n\n\n\n\nNo isles will be used in our analysis, so instead of clean and impute missing values, we have decided to remove them from the dataset.\nWe also remove the CA column since it information is superfluous with province.\n\nine_data <- ine_data %>% \n      filter(is.na(islas)) %>% \n      select(-islas, -CA)\n\nRegarding completeness of the dataset, there are not daily information. The gap between days vary between one day (no gaps during lockdown period) and up to four days.\nTo complete the data, we are going to interpolate the data between the known values.\nIn order to do that, we are going to transform data in a wider format (as a matrix).\n\nine_data <- ine_data %>% \n      pivot_wider(names_from = province, values_from = flujo)\nine_data\n\n# A tibble: 249 × 53\n   fecha      Almería Cádiz Córdoba Granada Huelva  Jaén Málaga Sevilla Huesca\n   <date>       <dbl> <dbl>   <dbl>   <dbl>  <dbl> <dbl>  <dbl>   <dbl>  <dbl>\n 1 2021-12-29   15.9   16.4   15.0     17.6  13.6  13.1    17.4    17.6  12.6 \n 2 2021-12-26    9.89  10.9    9.54    11.4   8.36  8.16   11.0    10.6   8.54\n 3 2021-12-22   17.4   17.1   15.4     18.4  14.1  13.0    18.8    19.3  13.3 \n 4 2021-12-19   11.5   13.0   12.1     14.5  10.5  11.7    13.1    13.9   9.91\n 5 2021-12-15   18.4   19.3   18.4     20.4  16.7  16      21.0    22.9  14.3 \n 6 2021-12-12   11.6   13.5   12.4     14.3  10.7  11.5    13.6    13.5  10.2 \n 7 2021-12-08   12.3   13.7   12.2     13.8  11.4  10.2    14.0    13.5  11.9 \n 8 2021-12-01   18.3   19.2   18.4     20.1  16.6  15.5    21.3    22.7  14.3 \n 9 2021-11-28   11.8   12.5   11.7     13.9  10.3   9.89   13.7    13.2   9.11\n10 2021-11-24   18.2   18.6   17.9     19.6  16.5  13.3    21.1    22.6  12.9 \n# … with 239 more rows, and 43 more variables: Teruel <dbl>, Zaragoza <dbl>,\n#   Asturias <dbl>, `Balears, Illes` <dbl>, `Palmas, Las` <dbl>,\n#   `Santa Cruz de Tenerife` <dbl>, Cantabria <dbl>, Ávila <dbl>, Burgos <dbl>,\n#   León <dbl>, Palencia <dbl>, Salamanca <dbl>, Segovia <dbl>, Soria <dbl>,\n#   Valladolid <dbl>, Zamora <dbl>, Albacete <dbl>, `Ciudad Real` <dbl>,\n#   Cuenca <dbl>, Guadalajara <dbl>, Toledo <dbl>, Barcelona <dbl>,\n#   Girona <dbl>, Lleida <dbl>, Tarragona <dbl>, `Alicante/Alacant` <dbl>, …\n\n\nFor all the provinces, there are information for November, 18 2019 which is the pre-pandemic reference value. Since it is not needed to show variations in mobility, we are going to filter it.\n\nine_data <- ine_data %>% \n      filter(fecha > as.Date(\"18/11/2019\", format = \"%d/%m/%Y\")) %>% \n      arrange(fecha)\nsummary(ine_data$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-03-16\" \"2020-05-23\" \"2020-10-19\" \"2020-11-28\" \"2021-05-23\" \"2021-12-29\" \n\n\nTo interpolate the data, we need to convert the dataframe in a time series format and fill gaps with the missing days.\n\nine_data <- ine_data %>% \n      as_tsibble() %>% \n      fill_gaps()\n\nUsing `fecha` as index variable.\n\n\nThe total number of missing values per province are:\n\ncolSums(is.na(ine_data))\n\n                 fecha                Almería                  Cádiz \n                     0                    406                    406 \n               Córdoba                Granada                 Huelva \n                   406                    406                    406 \n                  Jaén                 Málaga                Sevilla \n                   406                    406                    406 \n                Huesca                 Teruel               Zaragoza \n                   406                    406                    406 \n              Asturias         Balears, Illes            Palmas, Las \n                   406                    406                    406 \nSanta Cruz de Tenerife              Cantabria                  Ávila \n                   406                    406                    406 \n                Burgos                   León               Palencia \n                   406                    406                    406 \n             Salamanca                Segovia                  Soria \n                   406                    406                    406 \n            Valladolid                 Zamora               Albacete \n                   406                    406                    406 \n           Ciudad Real                 Cuenca            Guadalajara \n                   406                    406                    406 \n                Toledo              Barcelona                 Girona \n                   406                    406                    406 \n                Lleida              Tarragona       Alicante/Alacant \n                   406                    406                    406 \n    Castellón/Castelló      Valencia/València                Badajoz \n                   406                    406                    406 \n               Cáceres              Coruña, A                   Lugo \n                   406                    406                    406 \n               Ourense             Pontevedra                 Madrid \n                   406                    406                    406 \n                Murcia                Navarra            Araba/Álava \n                   406                    406                    406 \n               Bizkaia               Gipuzkoa              Rioja, La \n                   406                    406                    406 \n                 Ceuta                Melilla \n                   406                    406 \n\n\nThe missing data is completed by interpolating available information. Here is an example of how the interpolation works in our dataset.\n\nimp <- na_interpolation(ine_data)\nggplot_na_imputations(ine_data, imp)\n\n\n\n\nMissing data interpolation:\n\n# Aplicamos interpolacion\nine_data <- na_interpolation(ine_data)\nine_data\n\n# A tsibble: 654 x 53 [1D]\n   fecha      Almería Cádiz Córdoba Granada Huelva  Jaén Málaga Sevilla Huesca\n   <date>       <dbl> <dbl>   <dbl>   <dbl>  <dbl> <dbl>  <dbl>   <dbl>  <dbl>\n 1 2020-03-16   11.0  10.7    11.9    11.4   11.4   8.81  11.4    12.3   10.3 \n 2 2020-03-17    9.14 10.1    11.4     9.78  10.9   7.65  10.7    11.5   10.2 \n 3 2020-03-18    7.28  9.5    10.9     8.16  10.5   6.49  10.1    10.8   10.1 \n 4 2020-03-19    7.08  9.28   10.7     8.06  10.2   6.30   9.80   10.6   10.0 \n 5 2020-03-20    6.87  9.05   10.4     7.97  10.0   6.12   9.53   10.3    9.98\n 6 2020-03-21    5.53  7.24    8.06    7.08   7.77  5.35   7.09    7.89   7.11\n 7 2020-03-22    4.19  5.42    5.7     6.2    5.51  4.57   4.65    5.44   4.24\n 8 2020-03-23    6.59  7.74    8.24    8.20   8.30  6.25   7.02    8.48   7.04\n 9 2020-03-24    8.98 10.1    10.8    10.2   11.1   7.93   9.39   11.5    9.85\n10 2020-03-25    9.11 10.2    10.8    10.0   11.0   8.02   9.47   11.5    9.72\n# … with 644 more rows, and 43 more variables: Teruel <dbl>, Zaragoza <dbl>,\n#   Asturias <dbl>, `Balears, Illes` <dbl>, `Palmas, Las` <dbl>,\n#   `Santa Cruz de Tenerife` <dbl>, Cantabria <dbl>, Ávila <dbl>, Burgos <dbl>,\n#   León <dbl>, Palencia <dbl>, Salamanca <dbl>, Segovia <dbl>, Soria <dbl>,\n#   Valladolid <dbl>, Zamora <dbl>, Albacete <dbl>, `Ciudad Real` <dbl>,\n#   Cuenca <dbl>, Guadalajara <dbl>, Toledo <dbl>, Barcelona <dbl>,\n#   Girona <dbl>, Lleida <dbl>, Tarragona <dbl>, `Alicante/Alacant` <dbl>, …\n\n\nNow, the missing values per province are zero.\n\ncolSums(is.na(ine_data))\n\n                 fecha                Almería                  Cádiz \n                     0                      0                      0 \n               Córdoba                Granada                 Huelva \n                     0                      0                      0 \n                  Jaén                 Málaga                Sevilla \n                     0                      0                      0 \n                Huesca                 Teruel               Zaragoza \n                     0                      0                      0 \n              Asturias         Balears, Illes            Palmas, Las \n                     0                      0                      0 \nSanta Cruz de Tenerife              Cantabria                  Ávila \n                     0                      0                      0 \n                Burgos                   León               Palencia \n                     0                      0                      0 \n             Salamanca                Segovia                  Soria \n                     0                      0                      0 \n            Valladolid                 Zamora               Albacete \n                     0                      0                      0 \n           Ciudad Real                 Cuenca            Guadalajara \n                     0                      0                      0 \n                Toledo              Barcelona                 Girona \n                     0                      0                      0 \n                Lleida              Tarragona       Alicante/Alacant \n                     0                      0                      0 \n    Castellón/Castelló      Valencia/València                Badajoz \n                     0                      0                      0 \n               Cáceres              Coruña, A                   Lugo \n                     0                      0                      0 \n               Ourense             Pontevedra                 Madrid \n                     0                      0                      0 \n                Murcia                Navarra            Araba/Álava \n                     0                      0                      0 \n               Bizkaia               Gipuzkoa              Rioja, La \n                     0                      0                      0 \n                 Ceuta                Melilla \n                     0                      0 \n\n\nDataset summary:\n\nsummary(ine_data)\n\n     fecha               Almería          Cádiz          Córdoba     \n Min.   :2020-03-16   Min.   : 4.10   Min.   : 5.42   Min.   : 5.68  \n 1st Qu.:2020-08-26   1st Qu.:12.12   1st Qu.:13.60   1st Qu.:11.99  \n Median :2021-02-05   Median :14.07   Median :15.94   Median :13.63  \n Mean   :2021-02-05   Mean   :13.72   Mean   :15.24   Mean   :13.56  \n 3rd Qu.:2021-07-18   3rd Qu.:15.76   3rd Qu.:17.65   3rd Qu.:15.40  \n Max.   :2021-12-29   Max.   :18.49   Max.   :20.37   Max.   :18.85  \n    Granada          Huelva           Jaén           Málaga     \n Min.   : 5.71   Min.   : 5.51   Min.   : 4.17   Min.   : 4.56  \n 1st Qu.:13.13   1st Qu.:11.48   1st Qu.:10.30   1st Qu.:13.43  \n Median :15.29   Median :13.26   Median :11.64   Median :16.03  \n Mean   :14.80   Mean   :13.10   Mean   :11.38   Mean   :15.33  \n 3rd Qu.:17.00   3rd Qu.:15.03   3rd Qu.:12.87   3rd Qu.:17.90  \n Max.   :20.55   Max.   :18.76   Max.   :16.40   Max.   :21.37  \n    Sevilla          Huesca          Teruel          Zaragoza    \n Min.   : 5.44   Min.   : 4.24   Min.   : 1.950   Min.   : 5.80  \n 1st Qu.:13.00   1st Qu.:10.99   1st Qu.: 6.995   1st Qu.:13.30  \n Median :15.34   Median :12.62   Median : 8.685   Median :15.90  \n Mean   :15.27   Mean   :12.38   Mean   : 8.232   Mean   :15.88  \n 3rd Qu.:17.72   3rd Qu.:14.09   3rd Qu.: 9.849   3rd Qu.:18.57  \n Max.   :23.10   Max.   :17.95   Max.   :12.240   Max.   :24.51  \n    Asturias     Balears, Illes   Palmas, Las    Santa Cruz de Tenerife\n Min.   : 5.24   Min.   : 3.92   Min.   : 5.11   Min.   : 5.20         \n 1st Qu.:12.34   1st Qu.:13.40   1st Qu.:13.22   1st Qu.:13.37         \n Median :14.92   Median :16.00   Median :15.60   Median :15.83         \n Mean   :14.78   Mean   :15.43   Mean   :15.38   Mean   :15.59         \n 3rd Qu.:17.18   3rd Qu.:18.19   3rd Qu.:17.75   3rd Qu.:17.99         \n Max.   :24.28   Max.   :22.97   Max.   :22.60   Max.   :27.24         \n   Cantabria         Ávila           Burgos           León      \n Min.   : 5.84   Min.   : 4.51   Min.   : 3.97   Min.   : 5.56  \n 1st Qu.:13.28   1st Qu.:10.18   1st Qu.:10.36   1st Qu.:12.73  \n Median :16.35   Median :11.88   Median :12.15   Median :14.70  \n Mean   :16.05   Mean   :11.56   Mean   :12.01   Mean   :14.47  \n 3rd Qu.:18.84   3rd Qu.:13.25   3rd Qu.:13.89   3rd Qu.:16.61  \n Max.   :25.78   Max.   :17.09   Max.   :18.65   Max.   :20.39  \n    Palencia       Salamanca        Segovia          Soria       \n Min.   : 5.05   Min.   : 6.02   Min.   : 4.96   Min.   : 3.030  \n 1st Qu.:12.10   1st Qu.:12.68   1st Qu.:10.57   1st Qu.: 7.553  \n Median :14.25   Median :14.40   Median :12.13   Median : 8.706  \n Mean   :13.98   Mean   :14.21   Mean   :12.34   Mean   : 9.004  \n 3rd Qu.:16.22   3rd Qu.:16.28   3rd Qu.:14.23   3rd Qu.:10.776  \n Max.   :20.25   Max.   :20.24   Max.   :19.65   Max.   :14.310  \n   Valladolid        Zamora         Albacete      Ciudad Real    \n Min.   : 5.55   Min.   : 4.82   Min.   : 3.43   Min.   : 3.080  \n 1st Qu.:13.03   1st Qu.:10.98   1st Qu.:10.75   1st Qu.: 8.534  \n Median :15.58   Median :12.74   Median :12.53   Median : 9.940  \n Mean   :15.58   Mean   :12.53   Mean   :12.24   Mean   : 9.674  \n 3rd Qu.:18.56   3rd Qu.:14.41   3rd Qu.:14.25   3rd Qu.:11.237  \n Max.   :23.70   Max.   :17.99   Max.   :17.46   Max.   :13.670  \n     Cuenca        Guadalajara        Toledo        Barcelona    \n Min.   : 3.010   Min.   : 4.38   Min.   : 4.15   Min.   : 6.42  \n 1st Qu.: 8.873   1st Qu.:11.97   1st Qu.:11.22   1st Qu.:14.37  \n Median :10.520   Median :14.20   Median :13.17   Median :17.23  \n Mean   :10.275   Mean   :14.13   Mean   :12.94   Mean   :16.97  \n 3rd Qu.:11.902   3rd Qu.:16.73   3rd Qu.:15.18   3rd Qu.:19.88  \n Max.   :15.270   Max.   :20.71   Max.   :19.05   Max.   :26.24  \n     Girona          Lleida        Tarragona     Alicante/Alacant\n Min.   : 4.16   Min.   : 5.16   Min.   : 4.93   Min.   : 5.72   \n 1st Qu.:11.18   1st Qu.:11.07   1st Qu.:11.55   1st Qu.:14.87   \n Median :13.64   Median :12.69   Median :13.69   Median :17.21   \n Mean   :13.04   Mean   :12.94   Mean   :13.39   Mean   :16.51   \n 3rd Qu.:15.11   3rd Qu.:14.98   3rd Qu.:15.59   3rd Qu.:18.81   \n Max.   :19.41   Max.   :20.68   Max.   :20.06   Max.   :22.39   \n Castellón/Castelló Valencia/València    Badajoz         Cáceres     \n Min.   : 4.95      Min.   : 6.17     Min.   : 4.90   Min.   : 4.02  \n 1st Qu.:13.07      1st Qu.:15.59     1st Qu.:10.73   1st Qu.:10.23  \n Median :15.11      Median :18.20     Median :12.47   Median :11.87  \n Mean   :14.82      Mean   :17.89     Mean   :12.27   Mean   :11.52  \n 3rd Qu.:17.04      3rd Qu.:20.74     3rd Qu.:14.07   3rd Qu.:13.29  \n Max.   :20.98      Max.   :25.81     Max.   :17.56   Max.   :16.27  \n   Coruña, A          Lugo          Ourense        Pontevedra   \n Min.   : 6.02   Min.   : 4.88   Min.   : 6.43   Min.   : 6.15  \n 1st Qu.:12.90   1st Qu.:10.94   1st Qu.:13.11   1st Qu.:13.85  \n Median :15.60   Median :13.12   Median :15.33   Median :16.95  \n Mean   :15.28   Mean   :12.74   Mean   :15.12   Mean   :16.61  \n 3rd Qu.:17.89   3rd Qu.:14.88   3rd Qu.:17.46   3rd Qu.:19.77  \n Max.   :23.06   Max.   :18.32   Max.   :22.01   Max.   :24.80  \n     Madrid          Murcia         Navarra       Araba/Álava   \n Min.   : 5.95   Min.   : 5.13   Min.   : 5.33   Min.   : 6.30  \n 1st Qu.:13.69   1st Qu.:11.64   1st Qu.:13.10   1st Qu.:14.78  \n Median :16.48   Median :13.43   Median :15.53   Median :17.75  \n Mean   :16.40   Mean   :13.40   Mean   :15.40   Mean   :17.39  \n 3rd Qu.:19.49   3rd Qu.:15.37   3rd Qu.:17.96   3rd Qu.:20.28  \n Max.   :25.68   Max.   :20.19   Max.   :23.29   Max.   :25.40  \n    Bizkaia         Gipuzkoa       Rioja, La         Ceuta       \n Min.   : 7.53   Min.   : 4.71   Min.   : 4.74   Min.   : 4.870  \n 1st Qu.:16.12   1st Qu.:11.71   1st Qu.:12.17   1st Qu.: 9.985  \n Median :19.37   Median :14.32   Median :14.29   Median :11.860  \n Mean   :19.23   Mean   :14.17   Mean   :14.11   Mean   :11.977  \n 3rd Qu.:22.63   3rd Qu.:16.65   3rd Qu.:16.34   3rd Qu.:13.985  \n Max.   :29.00   Max.   :22.56   Max.   :21.37   Max.   :18.340  \n    Melilla     \n Min.   : 6.48  \n 1st Qu.:12.45  \n Median :14.33  \n Mean   :14.32  \n 3rd Qu.:16.19  \n Max.   :20.19  \n\n\nFinally, we transform the data to a longer format so we will be able to easily join the data with other sources.\n\nine_data <- ine_data %>% \n      pivot_longer(!fecha, names_to = \"province\", values_to = \"flujo\")\nine_data\n\n# A tsibble: 34,008 x 3 [1D]\n# Key:       province [52]\n   fecha      province flujo\n   <date>     <chr>    <dbl>\n 1 2020-03-16 Almería  11.0 \n 2 2020-03-16 Cádiz    10.7 \n 3 2020-03-16 Córdoba  11.9 \n 4 2020-03-16 Granada  11.4 \n 5 2020-03-16 Huelva   11.4 \n 6 2020-03-16 Jaén      8.81\n 7 2020-03-16 Málaga   11.4 \n 8 2020-03-16 Sevilla  12.3 \n 9 2020-03-16 Huesca   10.3 \n10 2020-03-16 Teruel    6.77\n# … with 33,998 more rows"
  },
  {
    "objectID": "google_data.html",
    "href": "google_data.html",
    "title": "GOOGLE data",
    "section": "",
    "text": "pacman::p_load(\n      here,      # file locator\n      tidyverse, # data management and ggplot2 graphics\n      skimr,     # get overview of data\n      janitor,   # produce and adorn tabulations and cross-tabulations\n      tsibble,\n      imputeTS\n)\n\nThe data published by Google offers information related to mobility using the Google ecosystem application services such as Android. The dataset information is available worldwide link, but in our case, only the information relating to Spain was extracted.\nIt provides detail information about:\n\nCA: autonomous communities codes.\nprovince: province names.\niso_3166_2_code: province iso code\nfecha: date.\nmob_grocery_pharmacy: Mobility trends for places like grocery markets, food warehouses, farmers markets, specialty food shops, drug, stores, and pharmacies.\nmob_parks: Mobility trends for places like national parks, public beaches, marinas, dog parks, plazas, and public garden.\nmob_residential: Mobility trends for places of residence.\nmob_retail_recreation: Mobility trends for places like restaurants, cafes, shopping centers, theme parks, museums, libraries, and movie theaters.\nmob_transit_stations: Mobility trends for places like public transport hubs such as subway, bus, and train stations.\nmob_workplaces: Mobility trends for places of work.\n\n\n# List local google raw files\ngoogle_files <- list.files(\n      path = here(\"data\", \"raw\"),\n      recursive = TRUE,\n      full.names = TRUE,\n      pattern = \"*Region_Mobility_Report.csv\"\n)\n\n\ngoogle_data <- map_dfr(\n      .x = google_files, \n      .f = ~read_csv(.x, show_col_types = FALSE)\n)\ngoogle_data\n\n# A tibble: 50,702 × 15\n   country_region_code country_region sub_region_1 sub_region_2 metro_area\n   <chr>               <chr>          <chr>        <chr>        <lgl>     \n 1 ES                  Spain          <NA>         <NA>         NA        \n 2 ES                  Spain          <NA>         <NA>         NA        \n 3 ES                  Spain          <NA>         <NA>         NA        \n 4 ES                  Spain          <NA>         <NA>         NA        \n 5 ES                  Spain          <NA>         <NA>         NA        \n 6 ES                  Spain          <NA>         <NA>         NA        \n 7 ES                  Spain          <NA>         <NA>         NA        \n 8 ES                  Spain          <NA>         <NA>         NA        \n 9 ES                  Spain          <NA>         <NA>         NA        \n10 ES                  Spain          <NA>         <NA>         NA        \n# … with 50,692 more rows, and 10 more variables: iso_3166_2_code <chr>,\n#   census_fips_code <lgl>, place_id <chr>, date <date>,\n#   retail_and_recreation_percent_change_from_baseline <dbl>,\n#   grocery_and_pharmacy_percent_change_from_baseline <dbl>,\n#   parks_percent_change_from_baseline <dbl>,\n#   transit_stations_percent_change_from_baseline <dbl>,\n#   workplaces_percent_change_from_baseline <dbl>, …\n\n\n\nskim(google_data)\n\n\nData summary\n\n\nName\ngoogle_data\n\n\nNumber of rows\n50702\n\n\nNumber of columns\n15\n\n\n_______________________\n\n\n\nColumn type frequency:\n\n\n\ncharacter\n6\n\n\nDate\n1\n\n\nlogical\n2\n\n\nnumeric\n6\n\n\n________________________\n\n\n\nGroup variables\nNone\n\n\n\nVariable type: character\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nempty\nn_unique\nwhitespace\n\n\n\n\ncountry_region_code\n0\n1.00\n2\n2\n0\n1\n0\n\n\ncountry_region\n0\n1.00\n5\n5\n0\n1\n0\n\n\nsub_region_1\n805\n0.98\n5\n19\n0\n19\n0\n\n\nsub_region_2\n16087\n0.68\n4\n22\n0\n43\n0\n\n\niso_3166_2_code\n805\n0.98\n4\n5\n0\n62\n0\n\n\nplace_id\n0\n1.00\n27\n27\n0\n63\n0\n\n\n\nVariable type: Date\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nmedian\nn_unique\n\n\n\n\ndate\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\n\nVariable type: logical\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmean\ncount\n\n\n\n\nmetro_area\n50702\n0\nNaN\n:\n\n\ncensus_fips_code\n50702\n0\nNaN\n:\n\n\n\nVariable type: numeric\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmean\nsd\np0\np25\np50\np75\np100\nhist\n\n\n\n\nretail_and_recreation_percent_change_from_baseline\n56\n1.00\n-24.20\n25.84\n-97\n-34\n-20\n-9\n100\n▂▇▇▁▁\n\n\ngrocery_and_pharmacy_percent_change_from_baseline\n845\n0.98\n2.55\n26.92\n-96\n-7\n5\n15\n258\n▁▇▁▁▁\n\n\nparks_percent_change_from_baseline\n305\n0.99\n16.83\n57.82\n-94\n-14\n8\n36\n569\n▇▂▁▁▁\n\n\ntransit_stations_percent_change_from_baseline\n1410\n0.97\n-16.74\n28.68\n-100\n-31\n-15\n-1\n177\n▂▇▁▁▁\n\n\nworkplaces_percent_change_from_baseline\n42\n1.00\n-20.91\n19.27\n-92\n-29\n-16\n-9\n70\n▁▂▇▁▁\n\n\nresidential_percent_change_from_baseline\n387\n0.99\n5.77\n7.49\n-12\n1\n4\n8\n48\n▂▇▁▁▁\n\n\n\n\n\nThere are some discrepancies between the NA data.\nsub_region_1 and iso_3166_2_code has a total of 98,4% of completness while sub_region_2 has only 68,3%. One of the reasons could be that some sub_regions in Spain are considered both Autonomous Communities (AC)/Autonomous Cities (C) and Provinces (Pr).\nFor those cases, sub_region_2 contains missing values.\n\n# Fix sub_region_2 missing data\ngoogle_data <- google_data %>% \n      mutate(\n            sub_region_2 = case_when(\n                  sub_region_1 == \"Asturias\" ~ \"Asturias\",\n                  sub_region_1 == \"Balearic Islands\" ~ \"Baleares\",\n                  sub_region_1 == \"Cantabria\" ~ \"Cantabria\",\n                  sub_region_1 == \"Ceuta\" ~ \"Ceuta\",\n                  sub_region_1 == \"Community of Madrid\" ~ \"Madrid\",\n                  sub_region_1 == \"La Rioja\" ~ \"Rioja\",\n                  sub_region_1 == \"Melilla\" ~ \"Melilla\",\n                  sub_region_1 == \"Navarre\" ~ \"Navarra\",\n                  sub_region_1 == \"Region of Murcia\" ~ \"Murcia\",\n                  TRUE ~ sub_region_2\n            )\n      )\n\n\ngoogle_data %>%  \n      tabyl(sub_region_1) %>% \n      adorn_pct_formatting()\n\n        sub_region_1    n percent valid_percent\n           Andalusia 7245   14.3%         14.5%\n              Aragon 3220    6.4%          6.5%\n            Asturias  805    1.6%          1.6%\n    Balearic Islands  805    1.6%          1.6%\n      Basque Country 3220    6.4%          6.5%\n      Canary Islands 2415    4.8%          4.8%\n           Cantabria  805    1.6%          1.6%\n    Castile and León 8050   15.9%         16.1%\n   Castile-La Mancha 4830    9.5%          9.7%\n           Catalonia 4025    7.9%          8.1%\n               Ceuta  798    1.6%          1.6%\n Community of Madrid  805    1.6%          1.6%\n         Extremadura 2415    4.8%          4.8%\n             Galicia 4025    7.9%          8.1%\n            La Rioja  805    1.6%          1.6%\n             Melilla  799    1.6%          1.6%\n             Navarre  805    1.6%          1.6%\n    Region of Murcia  805    1.6%          1.6%\n Valencian Community 3220    6.4%          6.5%\n                <NA>  805    1.6%             -\n\n\n\ntable(google_data$sub_region_2)\n\n\n              A Coruña                  Álava               Albacete \n                   805                    805                    805 \n              Alicante                Almería               Asturias \n                   805                    805                    805 \n                 Ávila                Badajoz               Baleares \n                   805                    805                    805 \n             Barcelona                 Biscay                 Burgos \n                   805                    805                    805 \n               Cáceres                  Cádiz              Cantabria \n                   805                    805                    805 \n             Castellón                  Ceuta            Ciudad Real \n                   805                    798                    805 \n               Córdoba                 Cuenca               Gipuzkoa \n                   805                    805                    805 \n                Girona                Granada            Guadalajara \n                   805                    805                    805 \n                Huelva                 Huesca                   Jaén \n                   805                    805                    805 \n            Las Palmas                   León                 Lleida \n                   805                    805                    805 \n                  Lugo                 Madrid                 Málaga \n                   805                    805                    805 \n               Melilla                 Murcia                Navarra \n                   799                    805                    805 \n              Palencia             Pontevedra    Province of Ourense \n                   805                    805                    805 \n                 Rioja              Salamanca Santa Cruz de Tenerife \n                   805                    805                    805 \n               Segovia                Seville                  Soria \n                   805                    805                    805 \n             Tarragona                 Teruel                 Toledo \n                   805                    805                    805 \n              Valencia             Valladolid                 Zamora \n                   805                    805                    805 \n              Zaragoza \n                   805 \n\n\nTo clean the data, the following actions will be taken:\n\nNA data from sub_region_1 and 2 will be eliminated.\nSome columns do not add usefull information for our analysis shuch as “country_region_code”, “metro_area”, “census_fips_code” and “place_id”. So, they will be eliminated from the dataset\nColumn names are too longer and contain redundant information. We are going to rename them.\n\n\ngoogle_data <- google_data %>% \n      drop_na(sub_region_1, sub_region_2) %>% \n      select(-country_region, -country_region_code, -metro_area, -census_fips_code, -place_id) %>% \n      rename(\n            \"CA\"                = sub_region_1,\n            \"province\"          = sub_region_2,\n            \"fecha\"             = date,\n            \"retail_recreation\" = retail_and_recreation_percent_change_from_baseline,\n            \"grocery_pharmacy\"  = grocery_and_pharmacy_percent_change_from_baseline,\n            \"parks\"             = parks_percent_change_from_baseline,\n            \"transit_stations\"  = transit_stations_percent_change_from_baseline,\n            \"workplaces\"        = workplaces_percent_change_from_baseline,\n            \"residential\"       = residential_percent_change_from_baseline\n      )\ngoogle_data\n\n# A tibble: 41,847 × 10\n   CA      province iso_3166_2_code fecha      retail_recreati… grocery_pharmacy\n   <chr>   <chr>    <chr>           <date>                <dbl>            <dbl>\n 1 Andalu… Almería  ES-AL           2020-02-15                5               -3\n 2 Andalu… Almería  ES-AL           2020-02-16               -2                0\n 3 Andalu… Almería  ES-AL           2020-02-17                0               -2\n 4 Andalu… Almería  ES-AL           2020-02-18               -3               -3\n 5 Andalu… Almería  ES-AL           2020-02-19               -1               -3\n 6 Andalu… Almería  ES-AL           2020-02-20                1               -2\n 7 Andalu… Almería  ES-AL           2020-02-21                2               -1\n 8 Andalu… Almería  ES-AL           2020-02-22                4               -1\n 9 Andalu… Almería  ES-AL           2020-02-23                1                4\n10 Andalu… Almería  ES-AL           2020-02-24                1                0\n# … with 41,837 more rows, and 4 more variables: parks <dbl>,\n#   transit_stations <dbl>, workplaces <dbl>, residential <dbl>\n\n\n\nskim(google_data)\n\n\nData summary\n\n\nName\ngoogle_data\n\n\nNumber of rows\n41847\n\n\nNumber of columns\n10\n\n\n_______________________\n\n\n\nColumn type frequency:\n\n\n\ncharacter\n3\n\n\nDate\n1\n\n\nnumeric\n6\n\n\n________________________\n\n\n\nGroup variables\nNone\n\n\n\nVariable type: character\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nempty\nn_unique\nwhitespace\n\n\n\n\nCA\n0\n1\n5\n19\n0\n19\n0\n\n\nprovince\n0\n1\n4\n22\n0\n52\n0\n\n\niso_3166_2_code\n0\n1\n4\n5\n0\n52\n0\n\n\n\nVariable type: Date\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nmedian\nn_unique\n\n\n\n\nfecha\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\n\nVariable type: numeric\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmean\nsd\np0\np25\np50\np75\np100\nhist\n\n\n\n\nretail_recreation\n56\n1.00\n-23.70\n26.35\n-97\n-34\n-20\n-8\n100\n▂▇▇▁▁\n\n\ngrocery_pharmacy\n473\n0.99\n3.12\n27.63\n-96\n-7\n5\n16\n258\n▁▇▁▁▁\n\n\nparks\n305\n0.99\n18.24\n60.28\n-94\n-14\n9\n38\n569\n▇▂▁▁▁\n\n\ntransit_stations\n1410\n0.97\n-16.01\n29.57\n-100\n-32\n-15\n1\n177\n▂▇▂▁▁\n\n\nworkplaces\n42\n1.00\n-20.59\n19.36\n-92\n-29\n-16\n-8\n70\n▁▂▇▁▁\n\n\nresidential\n387\n0.99\n5.76\n7.47\n-12\n1\n4\n8\n48\n▂▇▁▁▁\n\n\n\n\n\nAt this point, only the numeric variables contains NAs. As this information is embedded in time series, it will be possible to impute missing values.\nMissing values are presented in all the provinces but mostly in Ceuta and Melilla.\n\ngoogle_data %>% \n      pivot_longer(cols = 5:10, names_to = \"variables\") %>% \n      filter(is.na(value)) %>% \n      pull(province) %>% \n      table() %>% \n      sort(decreasing = TRUE)\n\n.\n              Ceuta             Melilla               Soria            Asturias \n               1054                 623                 146                 103 \n             Murcia              Teruel            Palencia              Cuenca \n                 96                  59                  53                  52 \n              Ávila              Huesca              Zamora               Rioja \n                 51                  49                  49                  45 \n             Burgos             Segovia Province of Ourense           Cantabria \n                 37                  35                  29                  28 \n               Lugo              Huelva             Cáceres         Guadalajara \n                 28                  25                  22                  21 \n             Lleida                León         Ciudad Real            Albacete \n                 17                  15                  10                   8 \n            Navarra               Álava                Jaén           Salamanca \n                  7                   3                   3                   3 \n             Madrid          Valladolid \n                  1                   1 \n\n\nTo impute missing data, we will convert the data to time series:\n\ngoogle_TimeS <- google_data %>% \n      pivot_longer(cols = 5:10, names_to = \"variables\") %>% \n      as_tsibble(index = fecha, key = c(variables, province))\n\nFor the imputation of missing values the procedure to be followed will be as follows:\n\nFirst, we separate (group) by the source of mobility (pharmacy, etc…)\nSecondly, we will interpolate missing data\nFinally, we will combine the data again\n\nThe interpolation uses either linear, spline or stineman interpolation to replace missing values. In our case, we will use the linear one.\nAs an example, we will show how interpolation works for “grocery_pharmacy” data in Asturias.\n\nimp <- google_TimeS %>% \n      filter(variables == \"grocery_pharmacy\") %>% \n      select(-variables) %>% \n      group_by(province) %>% \n      na_interpolation() %>% \n      rename(\"mob_grocery_pharmacy\" = value) %>% \n      filter(province == \"Asturias\")\n\n\ninterpolation_test <- google_TimeS %>% \n      filter(variables == \"grocery_pharmacy\") %>% \n      select(-variables) %>% \n      rename(\"mob_grocery_pharmacy\" = value) %>% \n      filter(province == \"Asturias\")\n\n\nggplot_na_imputations(interpolation_test$mob_grocery_pharmacy, imp$mob_grocery_pharmacy)\n\n\n\n\nThe interpolation works fine, so we will proceed to impute missing data for the rest of provinces/variables.\n\ngrocery_pharmacy_data <- google_TimeS %>% \n      filter(variables == \"grocery_pharmacy\") %>% \n      select(-variables) %>% \n      group_by(province) %>% \n      na_interpolation() %>% \n      rename(\"mob_grocery_pharmacy\" = value)\n\n\ngrocery_parks_data <- google_TimeS %>% \n      filter(variables == \"parks\") %>% \n      select(-variables) %>%\n      group_by(province) %>% \n      na_interpolation() %>% \n      rename(\"mob_parks\" = value)\n\n\ngrocery_residential_data <- google_TimeS %>% \n      filter(variables == \"residential\") %>% \n      select(-variables) %>%\n      group_by(province) %>% \n      na_interpolation() %>% \n      rename(\"mob_residential\" = value)\n\n\ngrocery_retail_recreation_data <- google_TimeS %>% \n      filter(variables == \"retail_recreation\") %>% \n      select(-variables) %>%\n      group_by(province) %>% \n      na_interpolation() %>% \n      rename(\"mob_retail_recreation\" = value)\n\n\ngrocery_transit_stations_data <- google_TimeS %>% \n      filter(variables == \"transit_stations\") %>% \n      select(-variables) %>%\n      group_by(province) %>% \n      na_interpolation() %>% \n      rename(\"mob_transit_stations\" = value)\n\n\ngrocery_workplaces_data <- google_TimeS %>% \n      filter(variables == \"workplaces\") %>% \n      select(-variables) %>%\n      group_by(province) %>% \n      na_interpolation() %>% \n      rename(\"mob_workplaces\" = value)\n\nOnce imputed missing data, we can combine the data again\n\ngoogle_TimeS_imputed <- grocery_pharmacy_data %>% \n      inner_join(grocery_parks_data, by=c(\"CA\", \"province\", \"iso_3166_2_code\", \"fecha\")) %>% \n      inner_join(grocery_residential_data, by=c(\"CA\", \"province\", \"iso_3166_2_code\", \"fecha\")) %>% \n      inner_join(grocery_retail_recreation_data, by=c(\"CA\", \"province\", \"iso_3166_2_code\", \"fecha\")) %>% \n      inner_join(grocery_transit_stations_data, by=c(\"CA\", \"province\", \"iso_3166_2_code\", \"fecha\")) %>% \n      inner_join(grocery_workplaces_data, by=c(\"CA\", \"province\", \"iso_3166_2_code\", \"fecha\"))\ngoogle_TimeS_imputed\n\n# A tibble: 41,847 × 10\n# Groups:   province [52]\n   CA      province iso_3166_2_code fecha      mob_grocery_pharmacy mob_parks\n   <chr>   <chr>    <chr>           <date>                    <dbl>     <dbl>\n 1 Galicia A Coruña ES-C            2020-02-15                   -2       -15\n 2 Galicia A Coruña ES-C            2020-02-16                  -19       -27\n 3 Galicia A Coruña ES-C            2020-02-17                    4        28\n 4 Galicia A Coruña ES-C            2020-02-18                    0        21\n 5 Galicia A Coruña ES-C            2020-02-19                    0        22\n 6 Galicia A Coruña ES-C            2020-02-20                    3        17\n 7 Galicia A Coruña ES-C            2020-02-21                   -1        27\n 8 Galicia A Coruña ES-C            2020-02-22                   -4        32\n 9 Galicia A Coruña ES-C            2020-02-23                   10        29\n10 Galicia A Coruña ES-C            2020-02-24                   13        71\n# … with 41,837 more rows, and 4 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>\n\n\nApart from missing data, there are also some gaps in the data for Ceuta and Melilla.\n\ngoogle_TimeS_imputed %>% \n      pivot_longer(cols = 5:10, names_to = \"variables\") %>% \n      as_tsibble(index = fecha, key = c(variables, province)) %>% \n      has_gaps(.full = TRUE) %>% \n      filter(.gaps == TRUE)\n\n# A tibble: 12 × 3\n   variables             province .gaps\n   <chr>                 <chr>    <lgl>\n 1 mob_grocery_pharmacy  Ceuta    TRUE \n 2 mob_grocery_pharmacy  Melilla  TRUE \n 3 mob_parks             Ceuta    TRUE \n 4 mob_parks             Melilla  TRUE \n 5 mob_residential       Ceuta    TRUE \n 6 mob_residential       Melilla  TRUE \n 7 mob_retail_recreation Ceuta    TRUE \n 8 mob_retail_recreation Melilla  TRUE \n 9 mob_transit_stations  Ceuta    TRUE \n10 mob_transit_stations  Melilla  TRUE \n11 mob_workplaces        Ceuta    TRUE \n12 mob_workplaces        Melilla  TRUE \n\n\n\ngoogle_gaps <- google_TimeS_imputed %>% \n      pivot_longer(cols = 5:10, names_to = \"variables\") %>% \n      as_tsibble(index = fecha, key = c(variables, province)) %>% \n      count_gaps(.full = TRUE)\ngoogle_gaps\n\n# A tibble: 42 × 5\n   variables            province .from      .to           .n\n   <chr>                <chr>    <date>     <date>     <int>\n 1 mob_grocery_pharmacy Ceuta    2020-08-22 2020-08-23     2\n 2 mob_grocery_pharmacy Ceuta    2020-08-29 2020-08-30     2\n 3 mob_grocery_pharmacy Ceuta    2020-09-02 2020-09-02     1\n 4 mob_grocery_pharmacy Ceuta    2020-09-05 2020-09-06     2\n 5 mob_grocery_pharmacy Melilla  2020-08-22 2020-08-23     2\n 6 mob_grocery_pharmacy Melilla  2020-08-29 2020-08-30     2\n 7 mob_grocery_pharmacy Melilla  2020-09-05 2020-09-06     2\n 8 mob_parks            Ceuta    2020-08-22 2020-08-23     2\n 9 mob_parks            Ceuta    2020-08-29 2020-08-30     2\n10 mob_parks            Ceuta    2020-09-02 2020-09-02     1\n# … with 32 more rows\n\n\nSince in further analysis we will not use “Ceuta” or “Melilla” data, we chose to eliminate them rather than to impute the missing values.\n\ngoogle_TimeS_imputed <- google_TimeS_imputed %>% \n      filter(!province %in% c(\"Ceuta\", \"Melilla\"))\ngoogle_TimeS_imputed\n\n# A tibble: 40,250 × 10\n# Groups:   province [50]\n   CA      province iso_3166_2_code fecha      mob_grocery_pharmacy mob_parks\n   <chr>   <chr>    <chr>           <date>                    <dbl>     <dbl>\n 1 Galicia A Coruña ES-C            2020-02-15                   -2       -15\n 2 Galicia A Coruña ES-C            2020-02-16                  -19       -27\n 3 Galicia A Coruña ES-C            2020-02-17                    4        28\n 4 Galicia A Coruña ES-C            2020-02-18                    0        21\n 5 Galicia A Coruña ES-C            2020-02-19                    0        22\n 6 Galicia A Coruña ES-C            2020-02-20                    3        17\n 7 Galicia A Coruña ES-C            2020-02-21                   -1        27\n 8 Galicia A Coruña ES-C            2020-02-22                   -4        32\n 9 Galicia A Coruña ES-C            2020-02-23                   10        29\n10 Galicia A Coruña ES-C            2020-02-24                   13        71\n# … with 40,240 more rows, and 4 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>\n\n\n\nskim(google_TimeS_imputed)\n\n\nData summary\n\n\nName\ngoogle_TimeS_imputed\n\n\nNumber of rows\n40250\n\n\nNumber of columns\n10\n\n\n_______________________\n\n\n\nColumn type frequency:\n\n\n\ncharacter\n2\n\n\nDate\n1\n\n\nnumeric\n6\n\n\n________________________\n\n\n\nGroup variables\nprovince\n\n\n\nVariable type: character\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nprovince\nn_missing\ncomplete_rate\nmin\nmax\nempty\nn_unique\nwhitespace\n\n\n\n\nCA\nA Coruña\n0\n1\n7\n7\n0\n1\n0\n\n\nCA\nÁlava\n0\n1\n14\n14\n0\n1\n0\n\n\nCA\nAlbacete\n0\n1\n17\n17\n0\n1\n0\n\n\nCA\nAlicante\n0\n1\n19\n19\n0\n1\n0\n\n\nCA\nAlmería\n0\n1\n9\n9\n0\n1\n0\n\n\nCA\nAsturias\n0\n1\n8\n8\n0\n1\n0\n\n\nCA\nÁvila\n0\n1\n16\n16\n0\n1\n0\n\n\nCA\nBadajoz\n0\n1\n11\n11\n0\n1\n0\n\n\nCA\nBaleares\n0\n1\n16\n16\n0\n1\n0\n\n\nCA\nBarcelona\n0\n1\n9\n9\n0\n1\n0\n\n\nCA\nBiscay\n0\n1\n14\n14\n0\n1\n0\n\n\nCA\nBurgos\n0\n1\n16\n16\n0\n1\n0\n\n\nCA\nCáceres\n0\n1\n11\n11\n0\n1\n0\n\n\nCA\nCádiz\n0\n1\n9\n9\n0\n1\n0\n\n\nCA\nCantabria\n0\n1\n9\n9\n0\n1\n0\n\n\nCA\nCastellón\n0\n1\n19\n19\n0\n1\n0\n\n\nCA\nCiudad Real\n0\n1\n17\n17\n0\n1\n0\n\n\nCA\nCórdoba\n0\n1\n9\n9\n0\n1\n0\n\n\nCA\nCuenca\n0\n1\n17\n17\n0\n1\n0\n\n\nCA\nGipuzkoa\n0\n1\n14\n14\n0\n1\n0\n\n\nCA\nGirona\n0\n1\n9\n9\n0\n1\n0\n\n\nCA\nGranada\n0\n1\n9\n9\n0\n1\n0\n\n\nCA\nGuadalajara\n0\n1\n17\n17\n0\n1\n0\n\n\nCA\nHuelva\n0\n1\n9\n9\n0\n1\n0\n\n\nCA\nHuesca\n0\n1\n6\n6\n0\n1\n0\n\n\nCA\nJaén\n0\n1\n9\n9\n0\n1\n0\n\n\nCA\nLas Palmas\n0\n1\n14\n14\n0\n1\n0\n\n\nCA\nLeón\n0\n1\n16\n16\n0\n1\n0\n\n\nCA\nLleida\n0\n1\n9\n9\n0\n1\n0\n\n\nCA\nLugo\n0\n1\n7\n7\n0\n1\n0\n\n\nCA\nMadrid\n0\n1\n19\n19\n0\n1\n0\n\n\nCA\nMálaga\n0\n1\n9\n9\n0\n1\n0\n\n\nCA\nMurcia\n0\n1\n16\n16\n0\n1\n0\n\n\nCA\nNavarra\n0\n1\n7\n7\n0\n1\n0\n\n\nCA\nPalencia\n0\n1\n16\n16\n0\n1\n0\n\n\nCA\nPontevedra\n0\n1\n7\n7\n0\n1\n0\n\n\nCA\nProvince of Ourense\n0\n1\n7\n7\n0\n1\n0\n\n\nCA\nRioja\n0\n1\n8\n8\n0\n1\n0\n\n\nCA\nSalamanca\n0\n1\n16\n16\n0\n1\n0\n\n\nCA\nSanta Cruz de Tenerife\n0\n1\n14\n14\n0\n1\n0\n\n\nCA\nSegovia\n0\n1\n16\n16\n0\n1\n0\n\n\nCA\nSeville\n0\n1\n9\n9\n0\n1\n0\n\n\nCA\nSoria\n0\n1\n16\n16\n0\n1\n0\n\n\nCA\nTarragona\n0\n1\n9\n9\n0\n1\n0\n\n\nCA\nTeruel\n0\n1\n6\n6\n0\n1\n0\n\n\nCA\nToledo\n0\n1\n17\n17\n0\n1\n0\n\n\nCA\nValencia\n0\n1\n19\n19\n0\n1\n0\n\n\nCA\nValladolid\n0\n1\n16\n16\n0\n1\n0\n\n\nCA\nZamora\n0\n1\n16\n16\n0\n1\n0\n\n\nCA\nZaragoza\n0\n1\n6\n6\n0\n1\n0\n\n\niso_3166_2_code\nA Coruña\n0\n1\n4\n4\n0\n1\n0\n\n\niso_3166_2_code\nÁlava\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nAlbacete\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nAlicante\n0\n1\n4\n4\n0\n1\n0\n\n\niso_3166_2_code\nAlmería\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nAsturias\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nÁvila\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nBadajoz\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nBaleares\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nBarcelona\n0\n1\n4\n4\n0\n1\n0\n\n\niso_3166_2_code\nBiscay\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nBurgos\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nCáceres\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nCádiz\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nCantabria\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nCastellón\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nCiudad Real\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nCórdoba\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nCuenca\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nGipuzkoa\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nGirona\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nGranada\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nGuadalajara\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nHuelva\n0\n1\n4\n4\n0\n1\n0\n\n\niso_3166_2_code\nHuesca\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nJaén\n0\n1\n4\n4\n0\n1\n0\n\n\niso_3166_2_code\nLas Palmas\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nLeón\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nLleida\n0\n1\n4\n4\n0\n1\n0\n\n\niso_3166_2_code\nLugo\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nMadrid\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nMálaga\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nMurcia\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nNavarra\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nPalencia\n0\n1\n4\n4\n0\n1\n0\n\n\niso_3166_2_code\nPontevedra\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nProvince of Ourense\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nRioja\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nSalamanca\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nSanta Cruz de Tenerife\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nSegovia\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nSeville\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nSoria\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nTarragona\n0\n1\n4\n4\n0\n1\n0\n\n\niso_3166_2_code\nTeruel\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nToledo\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nValencia\n0\n1\n4\n4\n0\n1\n0\n\n\niso_3166_2_code\nValladolid\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nZamora\n0\n1\n5\n5\n0\n1\n0\n\n\niso_3166_2_code\nZaragoza\n0\n1\n4\n4\n0\n1\n0\n\n\n\nVariable type: Date\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nprovince\nn_missing\ncomplete_rate\nmin\nmax\nmedian\nn_unique\n\n\n\n\nfecha\nA Coruña\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nÁlava\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nAlbacete\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nAlicante\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nAlmería\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nAsturias\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nÁvila\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nBadajoz\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nBaleares\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nBarcelona\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nBiscay\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nBurgos\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nCáceres\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nCádiz\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nCantabria\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nCastellón\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nCiudad Real\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nCórdoba\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nCuenca\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nGipuzkoa\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nGirona\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nGranada\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nGuadalajara\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nHuelva\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nHuesca\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nJaén\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nLas Palmas\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nLeón\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nLleida\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nLugo\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nMadrid\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nMálaga\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nMurcia\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nNavarra\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nPalencia\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nPontevedra\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nProvince of Ourense\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nRioja\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nSalamanca\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nSanta Cruz de Tenerife\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nSegovia\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nSeville\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nSoria\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nTarragona\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nTeruel\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nToledo\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nValencia\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nValladolid\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nZamora\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nZaragoza\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\n\nVariable type: numeric\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nprovince\nn_missing\ncomplete_rate\nmean\nsd\np0\np25\np50\np75\np100\nhist\n\n\n\n\nmob_grocery_pharmacy\nA Coruña\n0\n1\n2.47\n24.83\n-95\n-3\n7.00\n14.0\n120\n▁▁▇▁▁\n\n\nmob_grocery_pharmacy\nÁlava\n0\n1\n-0.58\n22.24\n-93\n-6\n4.00\n11.0\n59\n▁▁▃▇▁\n\n\nmob_grocery_pharmacy\nAlbacete\n0\n1\n4.12\n28.57\n-95\n-4\n5.00\n18.0\n160\n▁▇▇▁▁\n\n\nmob_grocery_pharmacy\nAlicante\n0\n1\n4.62\n30.23\n-91\n-5\n5.00\n17.0\n157\n▁▇▆▁▁\n\n\nmob_grocery_pharmacy\nAlmería\n0\n1\n2.66\n28.81\n-92\n-7\n2.00\n14.0\n141\n▁▆▇▁▁\n\n\nmob_grocery_pharmacy\nAsturias\n0\n1\n-0.76\n19.96\n-94\n-3\n3.00\n9.0\n42\n▁▁▁▇▁\n\n\nmob_grocery_pharmacy\nÁvila\n0\n1\n16.14\n36.19\n-93\n2\n17.00\n31.0\n207\n▂▇▃▁▁\n\n\nmob_grocery_pharmacy\nBadajoz\n0\n1\n4.24\n26.47\n-92\n-5\n5.00\n17.0\n158\n▁▇▇▁▁\n\n\nmob_grocery_pharmacy\nBaleares\n0\n1\n1.27\n24.34\n-87\n-8\n2.00\n13.0\n99\n▁▂▇▁▁\n\n\nmob_grocery_pharmacy\nBarcelona\n0\n1\n-4.14\n20.77\n-91\n-10\n0.00\n9.0\n58\n▁▁▆▇▁\n\n\nmob_grocery_pharmacy\nBiscay\n0\n1\n2.48\n23.59\n-94\n-4\n8.00\n16.0\n59\n▁▁▂▇▁\n\n\nmob_grocery_pharmacy\nBurgos\n0\n1\n8.83\n29.66\n-94\n1\n11.00\n22.0\n173\n▂▇▇▁▁\n\n\nmob_grocery_pharmacy\nCáceres\n0\n1\n1.42\n24.30\n-93\n-5\n4.00\n14.0\n101\n▁▁▇▁▁\n\n\nmob_grocery_pharmacy\nCádiz\n0\n1\n5.02\n30.70\n-92\n-4\n6.00\n15.0\n179\n▁▇▂▁▁\n\n\nmob_grocery_pharmacy\nCantabria\n0\n1\n10.71\n33.37\n-92\n-1\n10.00\n22.0\n205\n▁▇▂▁▁\n\n\nmob_grocery_pharmacy\nCastellón\n0\n1\n11.81\n32.86\n-93\n0\n13.00\n27.0\n179\n▂▇▇▁▁\n\n\nmob_grocery_pharmacy\nCiudad Real\n0\n1\n-0.50\n26.79\n-95\n-6\n1.00\n8.0\n162\n▁▇▃▁▁\n\n\nmob_grocery_pharmacy\nCórdoba\n0\n1\n0.96\n25.85\n-93\n-9\n4.00\n13.0\n164\n▁▇▅▁▁\n\n\nmob_grocery_pharmacy\nCuenca\n0\n1\n3.81\n28.39\n-95\n-7\n5.00\n18.0\n180\n▁▇▃▁▁\n\n\nmob_grocery_pharmacy\nGipuzkoa\n0\n1\n-1.58\n21.61\n-92\n-7\n2.00\n10.0\n52\n▁▁▂▇▁\n\n\nmob_grocery_pharmacy\nGirona\n0\n1\n13.96\n30.71\n-86\n2\n15.00\n27.0\n129\n▁▂▇▂▁\n\n\nmob_grocery_pharmacy\nGranada\n0\n1\n-8.29\n22.15\n-93\n-14\n-5.00\n3.0\n100\n▁▂▇▁▁\n\n\nmob_grocery_pharmacy\nGuadalajara\n0\n1\n4.96\n24.11\n-93\n-1\n9.00\n15.0\n91\n▁▁▇▂▁\n\n\nmob_grocery_pharmacy\nHuelva\n0\n1\n18.61\n38.20\n-89\n3\n18.00\n29.0\n258\n▁▇▁▁▁\n\n\nmob_grocery_pharmacy\nHuesca\n0\n1\n18.73\n35.94\n-92\n3\n19.00\n34.0\n185\n▁▇▇▁▁\n\n\nmob_grocery_pharmacy\nJaén\n0\n1\n6.35\n30.42\n-95\n-4\n8.00\n19.0\n213\n▁▇▁▁▁\n\n\nmob_grocery_pharmacy\nLas Palmas\n0\n1\n-9.23\n20.16\n-88\n-18\n-8.00\n5.0\n61\n▁▂▇▅▁\n\n\nmob_grocery_pharmacy\nLeón\n0\n1\n5.59\n29.61\n-96\n-2\n8.00\n18.0\n182\n▁▇▃▁▁\n\n\nmob_grocery_pharmacy\nLleida\n0\n1\n5.27\n24.38\n-90\n-5\n8.00\n20.0\n69\n▁▁▅▇▁\n\n\nmob_grocery_pharmacy\nLugo\n0\n1\n11.99\n29.07\n-93\n3\n15.00\n26.0\n131\n▁▂▇▁▁\n\n\nmob_grocery_pharmacy\nMadrid\n0\n1\n-6.40\n19.37\n-87\n-13\n-3.00\n6.0\n50\n▁▁▆▇▁\n\n\nmob_grocery_pharmacy\nMálaga\n0\n1\n2.88\n30.53\n-91\n-8\n4.00\n14.0\n156\n▁▇▆▁▁\n\n\nmob_grocery_pharmacy\nMurcia\n0\n1\n0.33\n20.13\n-92\n-4\n3.00\n13.0\n53\n▁▁▂▇▁\n\n\nmob_grocery_pharmacy\nNavarra\n0\n1\n6.88\n23.15\n-92\n1\n11.00\n18.0\n74\n▁▁▅▇▁\n\n\nmob_grocery_pharmacy\nPalencia\n0\n1\n3.54\n25.36\n-94\n-3\n8.00\n17.0\n102\n▁▂▇▂▁\n\n\nmob_grocery_pharmacy\nPontevedra\n0\n1\n7.17\n26.29\n-94\n2\n10.00\n18.0\n154\n▁▃▇▁▁\n\n\nmob_grocery_pharmacy\nProvince of Ourense\n0\n1\n3.39\n25.50\n-95\n-4\n6.00\n17.0\n113\n▁▁▇▁▁\n\n\nmob_grocery_pharmacy\nRioja\n0\n1\n3.17\n23.32\n-90\n-3\n6.00\n16.0\n125\n▁▂▇▁▁\n\n\nmob_grocery_pharmacy\nSalamanca\n0\n1\n-1.33\n24.82\n-94\n-8\n4.00\n13.0\n90\n▁▁▇▂▁\n\n\nmob_grocery_pharmacy\nSanta Cruz de Tenerife\n0\n1\n-9.84\n18.64\n-89\n-16\n-6.00\n2.0\n43\n▁▁▅▇▁\n\n\nmob_grocery_pharmacy\nSegovia\n0\n1\n18.64\n31.83\n-93\n9\n22.00\n34.0\n124\n▁▁▇▂▁\n\n\nmob_grocery_pharmacy\nSeville\n0\n1\n-4.90\n22.74\n-91\n-12\n-1.00\n7.0\n117\n▁▃▇▁▁\n\n\nmob_grocery_pharmacy\nSoria\n0\n1\n-0.86\n25.35\n-94\n-10\n4.00\n12.0\n72\n▁▂▇▇▁\n\n\nmob_grocery_pharmacy\nTarragona\n0\n1\n12.37\n28.75\n-88\n2\n15.00\n26.0\n126\n▁▂▇▁▁\n\n\nmob_grocery_pharmacy\nTeruel\n0\n1\n5.79\n26.99\n-95\n-2\n8.00\n19.0\n104\n▁▁▇▂▁\n\n\nmob_grocery_pharmacy\nToledo\n0\n1\n3.19\n24.38\n-94\n-2\n5.00\n15.0\n125\n▁▁▇▁▁\n\n\nmob_grocery_pharmacy\nValencia\n0\n1\n-1.41\n24.09\n-94\n-7\n1.00\n11.0\n92\n▁▁▇▁▁\n\n\nmob_grocery_pharmacy\nValladolid\n0\n1\n1.92\n30.18\n-95\n-8\n5.00\n14.0\n199\n▁▇▁▁▁\n\n\nmob_grocery_pharmacy\nZamora\n0\n1\n2.46\n26.15\n-94\n-2\n5.00\n13.0\n150\n▁▅▇▁▁\n\n\nmob_grocery_pharmacy\nZaragoza\n0\n1\n-1.55\n21.95\n-90\n-9\n3.00\n11.0\n88\n▁▁▇▂▁\n\n\nmob_parks\nA Coruña\n0\n1\n33.56\n59.36\n-87\n1\n26.00\n58.0\n303\n▂▇▂▁▁\n\n\nmob_parks\nÁlava\n0\n1\n5.60\n32.65\n-89\n-11\n8.00\n26.0\n136\n▁▅▇▁▁\n\n\nmob_parks\nAlbacete\n0\n1\n18.94\n43.99\n-88\n-6\n18.00\n46.0\n191\n▂▇▆▁▁\n\n\nmob_parks\nAlicante\n0\n1\n20.31\n54.89\n-93\n-13\n12.00\n44.0\n203\n▂▇▃▂▁\n\n\nmob_parks\nAlmería\n0\n1\n23.56\n56.80\n-90\n-11\n11.00\n46.0\n216\n▂▇▂▁▁\n\n\nmob_parks\nAsturias\n0\n1\n45.19\n71.02\n-88\n5\n33.00\n70.0\n333\n▂▇▂▁▁\n\n\nmob_parks\nÁvila\n0\n1\n54.73\n84.95\n-85\n3\n36.00\n88.0\n569\n▇▅▁▁▁\n\n\nmob_parks\nBadajoz\n0\n1\n-7.12\n25.91\n-83\n-18\n-4.00\n8.0\n104\n▁▆▇▁▁\n\n\nmob_parks\nBaleares\n0\n1\n48.81\n74.65\n-92\n2\n29.00\n93.0\n294\n▂▇▃▂▁\n\n\nmob_parks\nBarcelona\n0\n1\n-10.48\n23.79\n-93\n-19\n-6.00\n5.0\n33\n▁▁▃▇▃\n\n\nmob_parks\nBiscay\n0\n1\n9.17\n39.06\n-93\n-13\n10.00\n35.0\n140\n▂▅▇▂▁\n\n\nmob_parks\nBurgos\n0\n1\n45.82\n59.50\n-81\n10\n35.00\n78.0\n260\n▂▇▃▁▁\n\n\nmob_parks\nCáceres\n0\n1\n16.81\n40.82\n-83\n-3\n14.00\n37.0\n261\n▂▇▂▁▁\n\n\nmob_parks\nCádiz\n0\n1\n18.41\n58.67\n-92\n-16\n7.00\n41.0\n202\n▂▇▃▂▁\n\n\nmob_parks\nCantabria\n0\n1\n63.89\n109.13\n-92\n1\n36.00\n92.0\n543\n▇▆▁▁▁\n\n\nmob_parks\nCastellón\n0\n1\n40.49\n80.06\n-92\n-8\n19.00\n66.0\n360\n▅▇▂▁▁\n\n\nmob_parks\nCiudad Real\n0\n1\n5.66\n34.59\n-87\n-11\n8.00\n26.0\n165\n▂▇▇▁▁\n\n\nmob_parks\nCórdoba\n0\n1\n-11.88\n25.20\n-88\n-23\n-8.00\n3.0\n133\n▁▇▃▁▁\n\n\nmob_parks\nCuenca\n0\n1\n21.96\n56.06\n-87\n-12\n14.00\n49.0\n360\n▆▇▂▁▁\n\n\nmob_parks\nGipuzkoa\n0\n1\n11.01\n51.29\n-94\n-20\n4.00\n35.0\n210\n▂▇▃▁▁\n\n\nmob_parks\nGirona\n0\n1\n64.72\n117.50\n-90\n-4\n22.00\n99.0\n539\n▇▃▂▁▁\n\n\nmob_parks\nGranada\n0\n1\n-6.72\n34.01\n-91\n-26\n-5.00\n13.0\n129\n▂▇▇▁▁\n\n\nmob_parks\nGuadalajara\n0\n1\n19.32\n43.40\n-85\n-4\n14.00\n47.0\n220\n▂▇▃▁▁\n\n\nmob_parks\nHuelva\n0\n1\n37.97\n60.11\n-78\n0\n27.00\n63.0\n228\n▂▇▃▂▁\n\n\nmob_parks\nHuesca\n0\n1\n56.50\n97.50\n-86\n-5\n29.00\n88.0\n489\n▇▆▂▁▁\n\n\nmob_parks\nJaén\n0\n1\n-1.66\n28.52\n-87\n-16\n0.00\n15.0\n120\n▁▅▇▁▁\n\n\nmob_parks\nLas Palmas\n0\n1\n-25.66\n22.06\n-93\n-37\n-22.00\n-10.0\n30\n▁▁▇▇▁\n\n\nmob_parks\nLeón\n0\n1\n49.33\n65.41\n-83\n13\n37.00\n79.0\n355\n▂▇▂▁▁\n\n\nmob_parks\nLleida\n0\n1\n38.19\n64.32\n-80\n2\n24.00\n63.0\n329\n▃▇▂▁▁\n\n\nmob_parks\nLugo\n0\n1\n26.86\n55.44\n-77\n-6\n16.00\n45.0\n261\n▃▇▂▁▁\n\n\nmob_parks\nMadrid\n0\n1\n-9.83\n28.19\n-92\n-22\n-6.00\n10.0\n77\n▁▂▇▃▁\n\n\nmob_parks\nMálaga\n0\n1\n6.13\n43.88\n-92\n-18\n2.00\n27.0\n152\n▂▇▆▂▁\n\n\nmob_parks\nMurcia\n0\n1\n6.97\n38.29\n-92\n-14\n6.00\n27.0\n135\n▁▆▇▂▁\n\n\nmob_parks\nNavarra\n0\n1\n12.19\n37.84\n-88\n-8\n10.00\n36.0\n134\n▁▅▇▂▁\n\n\nmob_parks\nPalencia\n0\n1\n51.64\n61.15\n-80\n16\n43.00\n83.0\n294\n▂▇▃▁▁\n\n\nmob_parks\nPontevedra\n0\n1\n33.11\n66.75\n-89\n-3\n21.00\n54.0\n315\n▃▇▂▁▁\n\n\nmob_parks\nProvince of Ourense\n0\n1\n14.79\n40.34\n-83\n-8\n14.00\n37.0\n168\n▂▇▆▁▁\n\n\nmob_parks\nRioja\n0\n1\n5.99\n37.34\n-90\n-15\n5.00\n27.6\n138\n▂▇▇▂▁\n\n\nmob_parks\nSalamanca\n0\n1\n9.45\n40.39\n-89\n-10\n9.00\n29.0\n207\n▂▇▃▁▁\n\n\nmob_parks\nSanta Cruz de Tenerife\n0\n1\n-19.53\n23.72\n-92\n-30\n-16.00\n-4.0\n64\n▁▃▇▂▁\n\n\nmob_parks\nSegovia\n0\n1\n11.20\n50.98\n-93\n-19\n10.00\n39.0\n333\n▅▇▁▁▁\n\n\nmob_parks\nSeville\n0\n1\n-17.95\n25.70\n-93\n-30\n-13.00\n-3.0\n95\n▁▅▇▁▁\n\n\nmob_parks\nSoria\n0\n1\n54.93\n80.96\n-89\n7\n36.00\n88.0\n414\n▅▇▂▁▁\n\n\nmob_parks\nTarragona\n0\n1\n51.91\n89.18\n-90\n-2\n21.00\n94.0\n369\n▅▇▂▁▁\n\n\nmob_parks\nTeruel\n0\n1\n19.36\n63.73\n-92\n-18\n11.00\n44.0\n387\n▇▇▁▁▁\n\n\nmob_parks\nToledo\n0\n1\n-8.53\n31.77\n-89\n-25\n-6.00\n9.0\n166\n▂▇▂▁▁\n\n\nmob_parks\nValencia\n0\n1\n5.68\n39.02\n-93\n-16\n5.00\n25.0\n106\n▁▃▇▃▁\n\n\nmob_parks\nValladolid\n0\n1\n15.60\n37.75\n-90\n-3\n19.00\n40.0\n140\n▁▃▇▂▁\n\n\nmob_parks\nZamora\n0\n1\n30.29\n59.94\n-82\n-2\n19.00\n52.0\n377\n▆▇▁▁▁\n\n\nmob_parks\nZaragoza\n0\n1\n16.17\n33.00\n-87\n1\n19.00\n36.0\n222\n▁▇▃▁▁\n\n\nmob_residential\nA Coruña\n0\n1\n6.35\n7.96\n-7\n1\n4.00\n9.0\n46\n▇▇▁▁▁\n\n\nmob_residential\nÁlava\n0\n1\n6.21\n8.39\n-10\n2\n4.00\n8.0\n46\n▃▇▁▁▁\n\n\nmob_residential\nAlbacete\n0\n1\n4.59\n7.92\n-10\n0\n2.00\n6.0\n43\n▅▇▁▁▁\n\n\nmob_residential\nAlicante\n0\n1\n6.36\n7.34\n-5\n2\n4.00\n8.0\n42\n▇▆▁▁▁\n\n\nmob_residential\nAlmería\n0\n1\n6.01\n6.58\n-4\n2\n5.00\n7.0\n41\n▇▅▁▁▁\n\n\nmob_residential\nAsturias\n0\n1\n5.34\n7.44\n-8\n1\n3.00\n8.0\n40\n▆▇▁▁▁\n\n\nmob_residential\nÁvila\n0\n1\n5.77\n7.24\n-5\n1\n4.00\n8.0\n40\n▇▅▁▁▁\n\n\nmob_residential\nBadajoz\n0\n1\n4.63\n6.44\n-7\n1\n3.00\n6.0\n37\n▆▇▁▁▁\n\n\nmob_residential\nBaleares\n0\n1\n5.53\n7.81\n-6\n0\n4.00\n8.0\n40\n▇▆▁▁▁\n\n\nmob_residential\nBarcelona\n0\n1\n9.00\n8.45\n-7\n4\n7.00\n11.0\n47\n▃▇▁▁▁\n\n\nmob_residential\nBiscay\n0\n1\n6.32\n8.25\n-10\n2\n4.00\n9.0\n45\n▃▇▁▁▁\n\n\nmob_residential\nBurgos\n0\n1\n4.13\n8.00\n-11\n-1\n2.00\n7.0\n43\n▃▇▁▁▁\n\n\nmob_residential\nCáceres\n0\n1\n4.27\n6.46\n-5\n0\n2.00\n6.0\n36\n▇▃▁▁▁\n\n\nmob_residential\nCádiz\n0\n1\n5.40\n7.10\n-5\n1\n3.00\n7.0\n38\n▇▆▁▁▁\n\n\nmob_residential\nCantabria\n0\n1\n5.66\n7.54\n-5\n1\n4.00\n7.0\n42\n▇▅▁▁▁\n\n\nmob_residential\nCastellón\n0\n1\n6.20\n7.66\n-6\n2\n4.00\n8.0\n45\n▇▅▁▁▁\n\n\nmob_residential\nCiudad Real\n0\n1\n4.91\n7.22\n-7\n1\n3.00\n6.0\n42\n▇▇▁▁▁\n\n\nmob_residential\nCórdoba\n0\n1\n5.34\n6.97\n-6\n1\n4.00\n7.0\n41\n▇▇▁▁▁\n\n\nmob_residential\nCuenca\n0\n1\n4.82\n7.24\n-6\n0\n3.00\n6.0\n42\n▇▅▁▁▁\n\n\nmob_residential\nGipuzkoa\n0\n1\n6.57\n7.91\n-6\n2\n5.00\n9.0\n44\n▇▆▁▁▁\n\n\nmob_residential\nGirona\n0\n1\n6.71\n7.54\n-5\n2\n5.00\n9.0\n42\n▇▆▂▁▁\n\n\nmob_residential\nGranada\n0\n1\n5.96\n7.32\n-6\n1\n4.00\n8.0\n40\n▇▇▂▁▁\n\n\nmob_residential\nGuadalajara\n0\n1\n6.80\n7.83\n-8\n2\n5.00\n8.0\n46\n▅▇▁▁▁\n\n\nmob_residential\nHuelva\n0\n1\n4.48\n6.03\n-6\n1\n3.00\n6.0\n33\n▆▇▂▁▁\n\n\nmob_residential\nHuesca\n0\n1\n4.94\n6.96\n-7\n1\n3.00\n7.0\n40\n▇▇▁▁▁\n\n\nmob_residential\nJaén\n0\n1\n5.63\n6.75\n-5\n2\n4.00\n7.0\n40\n▇▅▁▁▁\n\n\nmob_residential\nLas Palmas\n0\n1\n9.09\n5.72\n0\n5\n8.00\n10.0\n40\n▇▆▁▁▁\n\n\nmob_residential\nLeón\n0\n1\n4.37\n7.44\n-9\n0\n2.00\n7.0\n40\n▅▇▁▁▁\n\n\nmob_residential\nLleida\n0\n1\n5.69\n7.15\n-7\n1\n4.00\n8.0\n41\n▇▇▁▁▁\n\n\nmob_residential\nLugo\n0\n1\n4.74\n7.47\n-9\n0\n3.00\n7.0\n44\n▆▇▁▁▁\n\n\nmob_residential\nMadrid\n0\n1\n8.95\n9.18\n-10\n4\n7.00\n11.0\n46\n▂▇▂▁▁\n\n\nmob_residential\nMálaga\n0\n1\n6.22\n7.37\n-4\n2\n4.00\n8.0\n40\n▇▆▁▁▁\n\n\nmob_residential\nMurcia\n0\n1\n5.04\n7.38\n-6\n0\n3.00\n7.0\n42\n▇▆▁▁▁\n\n\nmob_residential\nNavarra\n0\n1\n5.49\n7.73\n-6\n1\n3.00\n7.0\n43\n▇▆▁▁▁\n\n\nmob_residential\nPalencia\n0\n1\n4.33\n7.46\n-9\n0\n2.00\n7.0\n40\n▅▇▁▁▁\n\n\nmob_residential\nPontevedra\n0\n1\n6.50\n8.08\n-6\n2\n4.00\n9.0\n48\n▇▅▁▁▁\n\n\nmob_residential\nProvince of Ourense\n0\n1\n5.28\n7.75\n-9\n1\n3.00\n8.0\n44\n▆▇▁▁▁\n\n\nmob_residential\nRioja\n0\n1\n4.74\n7.67\n-10\n0\n2.00\n7.0\n42\n▅▇▂▁▁\n\n\nmob_residential\nSalamanca\n0\n1\n5.42\n7.41\n-10\n1\n3.00\n8.0\n40\n▃▇▁▁▁\n\n\nmob_residential\nSanta Cruz de Tenerife\n0\n1\n9.11\n5.96\n-1\n6\n8.00\n10.0\n41\n▇▇▁▁▁\n\n\nmob_residential\nSegovia\n0\n1\n5.58\n7.58\n-6\n1\n3.00\n8.0\n42\n▇▆▁▁▁\n\n\nmob_residential\nSeville\n0\n1\n5.59\n7.59\n-7\n1\n4.00\n8.0\n42\n▆▇▁▁▁\n\n\nmob_residential\nSoria\n0\n1\n4.62\n7.63\n-8\n0\n2.00\n7.0\n38\n▇▇▂▁▁\n\n\nmob_residential\nTarragona\n0\n1\n6.65\n7.21\n-4\n2\n5.00\n9.0\n41\n▇▅▁▁▁\n\n\nmob_residential\nTeruel\n0\n1\n4.54\n7.21\n-9\n0\n3.00\n7.0\n40\n▅▇▁▁▁\n\n\nmob_residential\nToledo\n0\n1\n6.69\n7.63\n-4\n2\n5.00\n8.0\n45\n▇▅▁▁▁\n\n\nmob_residential\nValencia\n0\n1\n6.53\n7.86\n-8\n2\n5.00\n8.0\n44\n▅▇▁▁▁\n\n\nmob_residential\nValladolid\n0\n1\n5.54\n8.03\n-10\n1\n3.00\n8.0\n43\n▃▇▁▁▁\n\n\nmob_residential\nZamora\n0\n1\n3.86\n7.04\n-7\n-1\n2.00\n6.0\n38\n▇▅▁▁▁\n\n\nmob_residential\nZaragoza\n0\n1\n5.41\n7.84\n-12\n1\n4.00\n8.0\n43\n▂▇▁▁▁\n\n\nmob_retail_recreation\nA Coruña\n0\n1\n-28.17\n23.34\n-96\n-37\n-22.00\n-13.0\n15\n▁▁▃▇▂\n\n\nmob_retail_recreation\nÁlava\n0\n1\n-30.00\n21.83\n-96\n-37\n-25.00\n-15.0\n26\n▂▂▇▇▁\n\n\nmob_retail_recreation\nAlbacete\n0\n1\n-22.63\n24.17\n-97\n-28\n-16.00\n-7.0\n19\n▁▁▂▇▂\n\n\nmob_retail_recreation\nAlicante\n0\n1\n-19.75\n27.20\n-96\n-29\n-14.00\n-2.0\n39\n▂▂▆▇▁\n\n\nmob_retail_recreation\nAlmería\n0\n1\n-17.06\n26.99\n-96\n-28\n-11.00\n0.0\n45\n▁▂▆▇▁\n\n\nmob_retail_recreation\nAsturias\n0\n1\n-26.49\n24.13\n-97\n-34\n-21.00\n-11.0\n15\n▁▁▃▇▃\n\n\nmob_retail_recreation\nÁvila\n0\n1\n-15.99\n36.87\n-95\n-40\n-14.00\n4.0\n100\n▃▇▇▂▁\n\n\nmob_retail_recreation\nBadajoz\n0\n1\n-27.61\n22.27\n-96\n-33\n-23.00\n-13.0\n33\n▂▂▇▇▁\n\n\nmob_retail_recreation\nBaleares\n0\n1\n-17.84\n27.82\n-95\n-28\n-15.00\n2.0\n39\n▂▂▇▇▂\n\n\nmob_retail_recreation\nBarcelona\n0\n1\n-32.91\n21.91\n-97\n-43\n-27.00\n-17.0\n3\n▁▁▃▇▅\n\n\nmob_retail_recreation\nBiscay\n0\n1\n-30.21\n22.30\n-97\n-39\n-25.00\n-15.0\n9\n▁▁▃▇▃\n\n\nmob_retail_recreation\nBurgos\n0\n1\n-23.66\n25.80\n-96\n-36\n-17.00\n-6.0\n29\n▁▂▃▇▁\n\n\nmob_retail_recreation\nCáceres\n0\n1\n-21.43\n26.02\n-96\n-29\n-17.00\n-6.0\n46\n▂▂▇▆▁\n\n\nmob_retail_recreation\nCádiz\n0\n1\n-15.86\n28.82\n-96\n-27\n-11.00\n1.0\n50\n▂▂▇▇▂\n\n\nmob_retail_recreation\nCantabria\n0\n1\n-16.74\n30.12\n-96\n-30\n-15.00\n-1.0\n63\n▁▂▇▃▁\n\n\nmob_retail_recreation\nCastellón\n0\n1\n-17.96\n28.15\n-96\n-27\n-12.00\n-1.0\n49\n▂▂▇▇▁\n\n\nmob_retail_recreation\nCiudad Real\n0\n1\n-27.90\n22.74\n-97\n-33\n-23.00\n-14.0\n42\n▁▁▇▃▁\n\n\nmob_retail_recreation\nCórdoba\n0\n1\n-26.62\n21.36\n-96\n-33\n-22.00\n-13.0\n23\n▁▁▅▇▁\n\n\nmob_retail_recreation\nCuenca\n0\n1\n-16.85\n30.79\n-96\n-31\n-14.00\n1.0\n70\n▂▂▇▃▁\n\n\nmob_retail_recreation\nGipuzkoa\n0\n1\n-29.78\n20.82\n-96\n-35\n-25.00\n-16.0\n12\n▁▁▃▇▂\n\n\nmob_retail_recreation\nGirona\n0\n1\n-12.74\n34.29\n-95\n-34\n-8.00\n8.0\n82\n▂▃▇▃▁\n\n\nmob_retail_recreation\nGranada\n0\n1\n-30.60\n23.27\n-97\n-40\n-24.00\n-15.0\n23\n▂▂▆▇▁\n\n\nmob_retail_recreation\nGuadalajara\n0\n1\n-22.43\n23.79\n-96\n-29\n-15.00\n-7.0\n27\n▁▁▃▇▁\n\n\nmob_retail_recreation\nHuelva\n0\n1\n-10.91\n31.64\n-94\n-26\n-7.00\n7.0\n66\n▂▂▇▅▁\n\n\nmob_retail_recreation\nHuesca\n0\n1\n-21.27\n27.71\n-96\n-35\n-18.00\n-5.0\n61\n▁▂▇▂▁\n\n\nmob_retail_recreation\nJaén\n0\n1\n-27.36\n21.50\n-97\n-34\n-23.00\n-14.0\n27\n▁▁▆▇▁\n\n\nmob_retail_recreation\nLas Palmas\n0\n1\n-31.09\n21.83\n-97\n-39\n-29.00\n-14.0\n15\n▂▁▇▇▂\n\n\nmob_retail_recreation\nLeón\n0\n1\n-23.45\n26.64\n-96\n-35\n-16.00\n-7.0\n34\n▂▂▅▇▁\n\n\nmob_retail_recreation\nLleida\n0\n1\n-27.55\n23.10\n-95\n-40\n-22.00\n-12.0\n18\n▁▁▃▇▂\n\n\nmob_retail_recreation\nLugo\n0\n1\n-21.54\n26.90\n-95\n-33\n-15.00\n-4.0\n44\n▂▂▇▇▁\n\n\nmob_retail_recreation\nMadrid\n0\n1\n-32.62\n21.35\n-96\n-38\n-28.00\n-19.0\n4\n▁▁▃▇▂\n\n\nmob_retail_recreation\nMálaga\n0\n1\n-21.14\n26.07\n-97\n-31\n-16.00\n-4.0\n30\n▁▁▅▇▂\n\n\nmob_retail_recreation\nMurcia\n0\n1\n-27.37\n21.76\n-96\n-34\n-22.00\n-13.0\n7\n▁▁▂▇▅\n\n\nmob_retail_recreation\nNavarra\n0\n1\n-23.26\n22.90\n-95\n-30\n-18.00\n-9.0\n23\n▁▁▃▇▁\n\n\nmob_retail_recreation\nPalencia\n0\n1\n-19.57\n28.81\n-97\n-34\n-13.00\n0.0\n45\n▂▂▆▇▁\n\n\nmob_retail_recreation\nPontevedra\n0\n1\n-25.54\n23.57\n-95\n-36\n-19.00\n-11.0\n17\n▁▁▃▇▂\n\n\nmob_retail_recreation\nProvince of Ourense\n0\n1\n-25.16\n23.78\n-96\n-34\n-19.00\n-10.0\n49\n▁▂▇▃▁\n\n\nmob_retail_recreation\nRioja\n0\n1\n-23.71\n24.78\n-96\n-31\n-18.00\n-8.0\n33\n▂▁▅▇▁\n\n\nmob_retail_recreation\nSalamanca\n0\n1\n-29.79\n24.84\n-97\n-41\n-24.00\n-13.0\n24\n▂▂▅▇▁\n\n\nmob_retail_recreation\nSanta Cruz de Tenerife\n0\n1\n-28.81\n20.66\n-97\n-33\n-26.00\n-15.0\n10\n▁▁▂▇▂\n\n\nmob_retail_recreation\nSegovia\n0\n1\n-21.20\n30.42\n-96\n-39\n-14.00\n-2.0\n62\n▂▃▇▃▁\n\n\nmob_retail_recreation\nSeville\n0\n1\n-26.91\n22.30\n-97\n-35\n-23.00\n-11.0\n23\n▁▁▆▇▁\n\n\nmob_retail_recreation\nSoria\n0\n1\n-17.23\n33.54\n-96\n-38\n-10.00\n3.0\n82\n▂▃▇▂▁\n\n\nmob_retail_recreation\nTarragona\n0\n1\n-15.19\n31.19\n-95\n-31\n-11.00\n4.0\n68\n▂▃▇▃▁\n\n\nmob_retail_recreation\nTeruel\n0\n1\n-16.24\n31.17\n-96\n-32\n-13.00\n0.0\n94\n▂▅▇▁▁\n\n\nmob_retail_recreation\nToledo\n0\n1\n-25.87\n22.78\n-96\n-30\n-19.00\n-12.0\n17\n▁▁▂▇▁\n\n\nmob_retail_recreation\nValencia\n0\n1\n-26.73\n23.00\n-96\n-33\n-20.00\n-11.0\n10\n▁▁▂▇▅\n\n\nmob_retail_recreation\nValladolid\n0\n1\n-29.66\n23.46\n-97\n-39\n-24.00\n-13.0\n13\n▁▁▃▇▂\n\n\nmob_retail_recreation\nZamora\n0\n1\n-19.91\n30.33\n-96\n-37\n-15.00\n-3.0\n65\n▂▃▇▃▁\n\n\nmob_retail_recreation\nZaragoza\n0\n1\n-29.41\n20.63\n-96\n-36\n-25.00\n-16.0\n22\n▁▁▆▇▁\n\n\nmob_transit_stations\nA Coruña\n0\n1\n-17.79\n24.73\n-92\n-30\n-15.00\n0.0\n40\n▁▂▇▇▁\n\n\nmob_transit_stations\nÁlava\n0\n1\n-20.60\n20.70\n-92\n-28\n-16.00\n-7.0\n42\n▁▂▇▇▁\n\n\nmob_transit_stations\nAlbacete\n0\n1\n-18.32\n21.73\n-92\n-26\n-15.00\n-4.0\n21\n▁▁▃▇▃\n\n\nmob_transit_stations\nAlicante\n0\n1\n-20.98\n25.62\n-93\n-35\n-18.00\n-1.0\n24\n▂▂▇▇▅\n\n\nmob_transit_stations\nAlmería\n0\n1\n-0.41\n29.26\n-88\n-13\n2.00\n19.0\n61\n▂▂▇▇▂\n\n\nmob_transit_stations\nAsturias\n0\n1\n-17.30\n20.87\n-85\n-26\n-14.00\n-4.0\n26\n▁▁▅▇▂\n\n\nmob_transit_stations\nÁvila\n0\n1\n-9.47\n28.68\n-90\n-22\n-7.00\n7.0\n78\n▁▂▇▂▁\n\n\nmob_transit_stations\nBadajoz\n0\n1\n-8.54\n23.12\n-89\n-16\n-3.00\n6.0\n38\n▁▁▂▇▁\n\n\nmob_transit_stations\nBaleares\n0\n1\n-2.61\n44.99\n-92\n-33\n-8.00\n17.0\n120\n▂▇▆▃▁\n\n\nmob_transit_stations\nBarcelona\n0\n1\n-27.65\n18.95\n-91\n-35\n-25.00\n-15.0\n10\n▁▁▃▇▂\n\n\nmob_transit_stations\nBiscay\n0\n1\n-26.45\n18.79\n-91\n-33\n-22.00\n-14.0\n13\n▁▁▃▇▁\n\n\nmob_transit_stations\nBurgos\n0\n1\n2.38\n42.13\n-93\n-22\n5.00\n24.0\n135\n▂▆▇▂▁\n\n\nmob_transit_stations\nCáceres\n0\n1\n9.82\n44.07\n-94\n-13\n10.00\n38.0\n165\n▂▇▇▂▁\n\n\nmob_transit_stations\nCádiz\n0\n1\n-21.46\n26.13\n-93\n-35\n-18.00\n-3.0\n118\n▂▇▅▁▁\n\n\nmob_transit_stations\nCantabria\n0\n1\n-10.91\n27.11\n-91\n-24\n-7.00\n6.0\n49\n▁▂▆▇▂\n\n\nmob_transit_stations\nCastellón\n0\n1\n-23.82\n24.76\n-93\n-39\n-21.00\n-6.0\n54\n▂▃▇▃▁\n\n\nmob_transit_stations\nCiudad Real\n0\n1\n-26.81\n23.81\n-95\n-37\n-25.00\n-9.0\n33\n▂▂▇▇▁\n\n\nmob_transit_stations\nCórdoba\n0\n1\n-20.46\n21.89\n-92\n-30\n-17.00\n-6.0\n30\n▁▁▆▇▁\n\n\nmob_transit_stations\nCuenca\n0\n1\n-4.59\n29.80\n-90\n-20\n-2.00\n11.0\n101\n▁▃▇▂▁\n\n\nmob_transit_stations\nGipuzkoa\n0\n1\n-16.62\n19.96\n-89\n-22\n-11.00\n-4.0\n41\n▁▁▇▇▁\n\n\nmob_transit_stations\nGirona\n0\n1\n-11.15\n29.55\n-90\n-23\n-9.00\n5.0\n80\n▁▂▇▂▁\n\n\nmob_transit_stations\nGranada\n0\n1\n-14.85\n26.04\n-91\n-27\n-10.00\n4.0\n41\n▂▁▆▇▂\n\n\nmob_transit_stations\nGuadalajara\n0\n1\n-11.86\n28.97\n-93\n-29\n-10.00\n10.0\n51\n▂▂▇▇▂\n\n\nmob_transit_stations\nHuelva\n0\n1\n20.34\n38.52\n-85\n-1\n22.00\n48.0\n107\n▂▂▇▇▂\n\n\nmob_transit_stations\nHuesca\n0\n1\n-25.57\n26.29\n-92\n-42\n-25.00\n-9.0\n55\n▂▅▇▂▁\n\n\nmob_transit_stations\nJaén\n0\n1\n-21.62\n20.60\n-94\n-27\n-18.00\n-9.0\n48\n▁▁▇▂▁\n\n\nmob_transit_stations\nLas Palmas\n0\n1\n-25.13\n24.76\n-92\n-40\n-27.00\n-2.0\n20\n▁▂▇▃▅\n\n\nmob_transit_stations\nLeón\n0\n1\n-12.26\n26.59\n-90\n-24\n-10.00\n3.0\n61\n▁▂▇▃▁\n\n\nmob_transit_stations\nLleida\n0\n1\n-4.42\n26.82\n-89\n-15\n1.00\n14.0\n50\n▁▁▃▇▁\n\n\nmob_transit_stations\nLugo\n0\n1\n-7.71\n32.85\n-90\n-27\n-6.85\n11.0\n130\n▂▇▇▁▁\n\n\nmob_transit_stations\nMadrid\n0\n1\n-33.40\n19.63\n-93\n-42\n-32.00\n-19.0\n10\n▁▁▇▇▁\n\n\nmob_transit_stations\nMálaga\n0\n1\n-22.89\n25.52\n-93\n-37\n-22.00\n-3.0\n33\n▂▂▇▆▂\n\n\nmob_transit_stations\nMurcia\n0\n1\n-21.17\n19.80\n-89\n-29\n-19.00\n-7.0\n26\n▁▁▆▇▁\n\n\nmob_transit_stations\nNavarra\n0\n1\n-23.33\n22.52\n-91\n-35\n-18.00\n-7.0\n16\n▁▁▅▇▅\n\n\nmob_transit_stations\nPalencia\n0\n1\n-22.80\n23.15\n-93\n-34\n-19.00\n-8.0\n53\n▁▂▇▃▁\n\n\nmob_transit_stations\nPontevedra\n0\n1\n-10.89\n36.19\n-94\n-34\n-13.00\n16.0\n103\n▂▇▇▃▁\n\n\nmob_transit_stations\nProvince of Ourense\n0\n1\n-20.04\n25.65\n-93\n-35\n-19.00\n-1.0\n79\n▁▆▇▂▁\n\n\nmob_transit_stations\nRioja\n0\n1\n-21.79\n24.65\n-93\n-34\n-16.15\n-4.0\n40\n▂▃▇▇▁\n\n\nmob_transit_stations\nSalamanca\n0\n1\n-14.96\n26.94\n-94\n-25\n-9.00\n3.0\n52\n▂▂▇▇▁\n\n\nmob_transit_stations\nSanta Cruz de Tenerife\n0\n1\n-23.83\n22.16\n-91\n-34\n-25.00\n-5.0\n27\n▁▂▇▇▁\n\n\nmob_transit_stations\nSegovia\n0\n1\n-11.31\n35.93\n-95\n-33\n-11.00\n19.0\n130\n▃▇▇▁▁\n\n\nmob_transit_stations\nSeville\n0\n1\n-28.81\n21.99\n-94\n-40\n-27.00\n-14.0\n52\n▁▃▇▂▁\n\n\nmob_transit_stations\nSoria\n0\n1\n-10.53\n26.89\n-89\n-26\n-7.00\n5.0\n76\n▁▃▇▂▁\n\n\nmob_transit_stations\nTarragona\n0\n1\n-17.46\n25.20\n-92\n-28\n-14.00\n-3.0\n52\n▁▂▇▅▁\n\n\nmob_transit_stations\nTeruel\n0\n1\n-11.41\n35.64\n-86\n-40\n-4.15\n13.0\n177\n▅▇▂▁▁\n\n\nmob_transit_stations\nToledo\n0\n1\n-27.23\n20.93\n-94\n-35\n-21.00\n-14.0\n22\n▁▁▃▇▁\n\n\nmob_transit_stations\nValencia\n0\n1\n-24.41\n22.42\n-93\n-35\n-21.00\n-9.0\n53\n▁▃▇▃▁\n\n\nmob_transit_stations\nValladolid\n0\n1\n-19.97\n24.79\n-93\n-33\n-17.00\n-2.0\n27\n▁▂▆▇▃\n\n\nmob_transit_stations\nZamora\n0\n1\n2.78\n43.37\n-100\n-24\n4.00\n30.0\n145\n▂▇▇▂▁\n\n\nmob_transit_stations\nZaragoza\n0\n1\n-27.45\n19.35\n-91\n-36\n-24.00\n-15.0\n10\n▁▁▅▇▃\n\n\nmob_workplaces\nA Coruña\n0\n1\n-21.94\n18.55\n-89\n-29\n-17.00\n-11.0\n13\n▁▁▃▇▂\n\n\nmob_workplaces\nÁlava\n0\n1\n-22.64\n20.28\n-90\n-29\n-15.00\n-9.0\n11\n▁▂▂▇▅\n\n\nmob_workplaces\nAlbacete\n0\n1\n-19.12\n19.09\n-88\n-27\n-12.00\n-7.0\n12\n▁▁▂▇▅\n\n\nmob_workplaces\nAlicante\n0\n1\n-20.08\n19.36\n-89\n-27\n-14.00\n-9.0\n25\n▁▁▃▇▁\n\n\nmob_workplaces\nAlmería\n0\n1\n-17.85\n18.10\n-87\n-27\n-12.00\n-7.0\n30\n▁▁▅▇▁\n\n\nmob_workplaces\nAsturias\n0\n1\n-23.33\n17.05\n-88\n-28\n-19.00\n-13.0\n12\n▁▁▂▇▁\n\n\nmob_workplaces\nÁvila\n0\n1\n-13.46\n22.58\n-84\n-24\n-9.00\n-1.0\n69\n▁▃▇▁▁\n\n\nmob_workplaces\nBadajoz\n0\n1\n-20.37\n16.99\n-85\n-28\n-14.00\n-9.0\n9\n▁▁▂▇▅\n\n\nmob_workplaces\nBaleares\n0\n1\n-16.41\n22.67\n-88\n-24\n-15.00\n-6.0\n70\n▁▂▇▁▁\n\n\nmob_workplaces\nBarcelona\n0\n1\n-30.01\n19.76\n-92\n-39\n-26.00\n-17.0\n6\n▁▂▃▇▃\n\n\nmob_workplaces\nBiscay\n0\n1\n-25.63\n19.47\n-91\n-33\n-19.00\n-12.0\n17\n▁▂▃▇▁\n\n\nmob_workplaces\nBurgos\n0\n1\n-16.73\n20.20\n-88\n-25\n-12.00\n-4.0\n39\n▁▂▆▇▁\n\n\nmob_workplaces\nCáceres\n0\n1\n-14.95\n19.35\n-85\n-25\n-8.00\n-1.0\n22\n▁▁▃▇▃\n\n\nmob_workplaces\nCádiz\n0\n1\n-19.24\n18.85\n-87\n-26\n-14.00\n-8.0\n20\n▁▁▃▇▂\n\n\nmob_workplaces\nCantabria\n0\n1\n-19.24\n18.69\n-87\n-25\n-14.00\n-9.0\n32\n▁▂▅▇▁\n\n\nmob_workplaces\nCastellón\n0\n1\n-16.21\n20.90\n-89\n-24\n-9.00\n-4.0\n42\n▁▂▆▇▁\n\n\nmob_workplaces\nCiudad Real\n0\n1\n-22.53\n17.41\n-88\n-29\n-17.00\n-12.0\n17\n▁▁▃▇▁\n\n\nmob_workplaces\nCórdoba\n0\n1\n-22.43\n17.67\n-88\n-29\n-16.00\n-12.0\n6\n▁▁▂▇▅\n\n\nmob_workplaces\nCuenca\n0\n1\n-17.28\n18.09\n-86\n-24\n-12.00\n-7.0\n33\n▁▁▅▇▁\n\n\nmob_workplaces\nGipuzkoa\n0\n1\n-27.12\n18.05\n-90\n-32\n-20.00\n-16.0\n4\n▁▁▂▇▂\n\n\nmob_workplaces\nGirona\n0\n1\n-16.25\n20.65\n-88\n-24\n-12.00\n-5.0\n52\n▁▁▇▂▁\n\n\nmob_workplaces\nGranada\n0\n1\n-25.26\n18.27\n-88\n-33\n-21.00\n-14.0\n8\n▁▁▃▇▃\n\n\nmob_workplaces\nGuadalajara\n0\n1\n-21.34\n20.15\n-90\n-32\n-15.00\n-10.0\n31\n▁▂▅▇▁\n\n\nmob_workplaces\nHuelva\n0\n1\n-13.72\n18.60\n-79\n-22\n-10.00\n-3.0\n45\n▁▁▇▅▁\n\n\nmob_workplaces\nHuesca\n0\n1\n-13.28\n20.32\n-85\n-23\n-9.00\n1.0\n37\n▁▁▅▇▁\n\n\nmob_workplaces\nJaén\n0\n1\n-19.04\n17.90\n-88\n-25\n-13.00\n-7.0\n11\n▁▁▂▇▅\n\n\nmob_workplaces\nLas Palmas\n0\n1\n-25.87\n16.63\n-88\n-33\n-22.00\n-15.0\n5\n▁▁▂▇▃\n\n\nmob_workplaces\nLeón\n0\n1\n-17.66\n18.92\n-86\n-25\n-13.00\n-5.0\n26\n▁▁▃▇▁\n\n\nmob_workplaces\nLleida\n0\n1\n-22.03\n16.96\n-87\n-30\n-17.00\n-11.0\n5\n▁▁▂▇▇\n\n\nmob_workplaces\nLugo\n0\n1\n-15.89\n17.41\n-84\n-23\n-10.00\n-4.0\n19\n▁▁▂▇▂\n\n\nmob_workplaces\nMadrid\n0\n1\n-30.44\n22.60\n-92\n-45\n-27.00\n-15.0\n20\n▂▃▇▇▂\n\n\nmob_workplaces\nMálaga\n0\n1\n-21.63\n19.72\n-89\n-29\n-18.00\n-10.0\n29\n▁▁▆▇▁\n\n\nmob_workplaces\nMurcia\n0\n1\n-20.34\n17.68\n-88\n-26\n-16.00\n-10.0\n13\n▁▁▂▇▂\n\n\nmob_workplaces\nNavarra\n0\n1\n-21.07\n19.43\n-90\n-30\n-14.00\n-8.0\n15\n▁▁▃▇▂\n\n\nmob_workplaces\nPalencia\n0\n1\n-18.42\n18.35\n-85\n-26\n-12.00\n-6.0\n21\n▁▁▃▇▁\n\n\nmob_workplaces\nPontevedra\n0\n1\n-22.84\n17.54\n-89\n-28\n-18.00\n-13.0\n12\n▁▁▂▇▂\n\n\nmob_workplaces\nProvince of Ourense\n0\n1\n-19.81\n17.20\n-85\n-25\n-15.00\n-8.0\n10\n▁▁▂▇▅\n\n\nmob_workplaces\nRioja\n0\n1\n-19.39\n19.32\n-89\n-26\n-13.00\n-7.0\n27\n▁▁▃▇▁\n\n\nmob_workplaces\nSalamanca\n0\n1\n-19.55\n19.86\n-87\n-28\n-14.00\n-6.0\n16\n▁▁▃▇▅\n\n\nmob_workplaces\nSanta Cruz de Tenerife\n0\n1\n-25.31\n16.79\n-88\n-33\n-21.00\n-14.0\n2\n▁▂▂▇▆\n\n\nmob_workplaces\nSegovia\n0\n1\n-16.72\n20.47\n-86\n-25\n-11.00\n-5.0\n45\n▁▂▇▆▁\n\n\nmob_workplaces\nSeville\n0\n1\n-23.28\n19.04\n-90\n-32\n-17.00\n-10.0\n9\n▁▁▃▇▅\n\n\nmob_workplaces\nSoria\n0\n1\n-16.23\n19.22\n-85\n-24\n-12.00\n-2.0\n24\n▁▁▃▇▂\n\n\nmob_workplaces\nTarragona\n0\n1\n-19.20\n19.96\n-88\n-26\n-15.00\n-9.0\n45\n▁▁▇▂▁\n\n\nmob_workplaces\nTeruel\n0\n1\n-18.21\n18.51\n-87\n-25\n-15.00\n-6.0\n30\n▁▁▅▇▁\n\n\nmob_workplaces\nToledo\n0\n1\n-23.11\n17.88\n-89\n-30\n-16.00\n-13.0\n9\n▁▁▂▇▂\n\n\nmob_workplaces\nValencia\n0\n1\n-23.42\n19.84\n-90\n-32\n-17.00\n-11.0\n17\n▁▁▃▇▂\n\n\nmob_workplaces\nValladolid\n0\n1\n-23.80\n20.12\n-90\n-32\n-18.00\n-11.0\n15\n▁▁▃▇▂\n\n\nmob_workplaces\nZamora\n0\n1\n-19.79\n16.76\n-82\n-25\n-17.00\n-11.0\n27\n▁▂▆▇▁\n\n\nmob_workplaces\nZaragoza\n0\n1\n-21.95\n19.72\n-90\n-30\n-16.00\n-8.0\n11\n▁▁▃▇▆"
  },
  {
    "objectID": "aemet_data.html",
    "href": "aemet_data.html",
    "title": "AEMET data",
    "section": "",
    "text": "Load packages:\nData is available in the Spanish State Meteorological Agency through its opendata platform link.\nAEMET OpenData is a REST API (Application Programming Interface. REpresentational State Transfer) through which data can be downloaded free of charge.\nAEMET OpenData allows two types of access where both allow access to the same data catalog and data download in reusable formats:\nLast one method was used to download data from:\nLoad and deserialize json files.\nAll the information corresponds to airports.\nData statistics:\nSome cleaning is needed.\nFirst of all, we will remove useless columns for further analysis and rename the others. Secondly, we will transform date to a valid format. Last but not least, we will transform numeric data to a valid numeric format.\nIn order to unify the data with other available sources, a rename of the provinces it needed.\nThe data has missing information.\nAn interpolation for each provinces will be carried out in order to have the maximum information available."
  },
  {
    "objectID": "aemet_data.html#asturias",
    "href": "aemet_data.html#asturias",
    "title": "AEMET data",
    "section": "Asturias",
    "text": "Asturias\n\nmeteo_asturias <- meteo_data %>% \n      filter(provincia == \"Asturias\")\n\n\n# NA imputation test\nimp <- na_interpolation(meteo_asturias)\n\nNAs imputed to average temperature:\n\nggplot_na_imputations(meteo_asturias$tmed, imp$tmed)\n\n\n\n\nNAs imputed to precipitations:\n\nggplot_na_imputations(meteo_asturias$prec, imp$prec)\n\n\n\n\nNAs imputed to wind speed:\n\nggplot_na_imputations(meteo_asturias$ws, imp$ws)\n\n\n\n\nData interpolation test looks good, so we proceed to charge it:\n\nmeteo_asturias <- na_interpolation(meteo_asturias)"
  },
  {
    "objectID": "aemet_data.html#barcelona",
    "href": "aemet_data.html#barcelona",
    "title": "AEMET data",
    "section": "Barcelona",
    "text": "Barcelona\n\nmeteo_barcelona <- meteo_data %>% \n      filter(provincia == \"Barcelona\")\n\n\n# NA imputation test\nimp <- na_interpolation(meteo_barcelona)\n\nNAs imputed to average temperature:\n\nggplot_na_imputations(meteo_barcelona$tmed, imp$tmed)\n\n\n\n\nNAs imputed to precipitations:\n\nggplot_na_imputations(meteo_barcelona$prec, imp$prec)\n\n\n\n\nNAs imputed to wind speed:\n\nggplot_na_imputations(meteo_barcelona$ws, imp$ws)\n\n\n\n\nData interpolation test looks good, so we proceed to charge it:\n\nmeteo_barcelona <- na_interpolation(meteo_barcelona)"
  },
  {
    "objectID": "aemet_data.html#madrid",
    "href": "aemet_data.html#madrid",
    "title": "AEMET data",
    "section": "Madrid",
    "text": "Madrid\n\nmeteo_madrid <- meteo_data %>% \n      filter(provincia == \"Madrid\")\n\n\n# NA imputation test\nimp <- na_interpolation(meteo_madrid)\n\nNAs imputed to average temperature:\n\nprint(\"There are not NAs!\")\n\n[1] \"There are not NAs!\"\n\n\nNAs imputed to precipitations:\n\nggplot_na_imputations(meteo_madrid$prec, imp$prec)\n\n\n\n\nNAs imputed to wind speed:\n\nggplot_na_imputations(meteo_madrid$ws, imp$ws)\n\n\n\n\nData interpolation test looks good, so we proceed to charge it:\n\nmeteo_madrid <- na_interpolation(meteo_madrid)"
  },
  {
    "objectID": "aemet_data.html#malaga",
    "href": "aemet_data.html#malaga",
    "title": "AEMET data",
    "section": "Malaga",
    "text": "Malaga\n\nmeteo_malaga <- meteo_data %>% \n      filter(provincia == \"Málaga\")\n\n\n# NA imputation test\nimp <- na_interpolation(meteo_malaga)\n\nNAs imputed to average temperature:\n\nggplot_na_imputations(meteo_malaga$tmed, imp$tmed)\n\n\n\n\nNAs imputed to precipitations:\n\nggplot_na_imputations(meteo_malaga$prec, imp$prec)\n\n\n\n\nNAs imputed to wind speed:\n\nprint(\"There are not NAs!\")\n\n[1] \"There are not NAs!\"\n\n\nData interpolation test looks good, so we proceed to charge it:\n\nmeteo_malaga <- na_interpolation(meteo_malaga)"
  },
  {
    "objectID": "aemet_data.html#sevilla",
    "href": "aemet_data.html#sevilla",
    "title": "AEMET data",
    "section": "Sevilla",
    "text": "Sevilla\n\nmeteo_sevilla <- meteo_data %>% \n      filter(provincia == \"Sevilla\")\n\n\n# NA imputation test\nimp <- na_interpolation(meteo_sevilla)\n\nNAs imputed to average temperature:\n\nggplot_na_imputations(meteo_sevilla$tmed, imp$tmed)\n\n\n\n\nNAs imputed to precipitations:\n\nggplot_na_imputations(meteo_sevilla$prec, imp$prec)\n\n\n\n\nNAs imputed to wind speed:\n\nggplot_na_imputations(meteo_sevilla$ws, imp$ws)\n\n\n\n\nData interpolation test looks good, so we proceed to charge it:\n\nmeteo_sevilla <- na_interpolation(meteo_sevilla)"
  },
  {
    "objectID": "aemet_data.html#data-combination",
    "href": "aemet_data.html#data-combination",
    "title": "AEMET data",
    "section": "Data combination",
    "text": "Data combination\n\nmeteo_data_completed <- meteo_asturias %>% \n      rbind(meteo_barcelona) %>% \n      rbind(meteo_madrid) %>% \n      rbind(meteo_malaga) %>% \n      rbind(meteo_sevilla)\nunique(meteo_data_completed$provincia)\n\n[1] \"Asturias\"  \"Barcelona\" \"Madrid\"    \"Málaga\"    \"Sevilla\"  \n\n\nFinal statistics:\n\nskim(meteo_data_completed)\n\n\nData summary\n\n\nName\nmeteo_data_completed\n\n\nNumber of rows\n4105\n\n\nNumber of columns\n10\n\n\n_______________________\n\n\n\nColumn type frequency:\n\n\n\ncharacter\n1\n\n\nDate\n1\n\n\nnumeric\n8\n\n\n________________________\n\n\n\nGroup variables\nNone\n\n\n\nVariable type: character\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nempty\nn_unique\nwhitespace\n\n\n\n\nprovincia\n0\n1\n6\n9\n0\n5\n0\n\n\n\nVariable type: Date\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nmedian\nn_unique\n\n\n\n\nfecha\n0\n1\n2020-01-01\n2022-03-31\n2021-02-14\n821\n\n\n\nVariable type: numeric\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmean\nsd\np0\np25\np50\np75\np100\nhist\n\n\n\n\ntmed\n0\n1\n16.62\n6.45\n-6.2\n12.0\n15.6\n21.10\n34.5\n▁▂▇▅▂\n\n\nprec\n0\n1\n1.76\n6.13\n0.0\n0.0\n0.0\n0.20\n87.9\n▇▁▁▁▁\n\n\ntmin\n0\n1\n11.68\n6.22\n-13.4\n7.4\n11.3\n16.10\n27.5\n▁▁▇▇▂\n\n\ntmax\n0\n1\n21.56\n7.30\n0.3\n16.2\n20.3\n26.40\n44.9\n▁▇▇▃▁\n\n\nwd\n0\n1\n41.79\n36.26\n1.0\n15.0\n26.0\n99.00\n99.0\n▆▇▁▁▆\n\n\nws\n0\n1\n3.72\n1.73\n0.3\n2.5\n3.6\n4.40\n18.9\n▇▅▁▁▁\n\n\nws_max\n0\n1\n10.24\n3.61\n2.5\n7.8\n9.7\n12.15\n31.9\n▅▇▂▁▁\n\n\nsol\n0\n1\n6.97\n4.12\n0.0\n3.5\n7.7\n10.30\n14.3\n▇▅▆▇▅\n\n\n\n\n\nThe final data looks like:\n\nmeteo_data_completed\n\n# A tibble: 4,105 × 10\n   fecha      provincia  tmed  prec  tmin  tmax    wd    ws ws_max   sol\n   <date>     <chr>     <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl> <dbl>\n 1 2020-01-01 Asturias    7.4   0     3.8  11      99   2.5    7.8   7.9\n 2 2020-01-02 Asturias    7.3   0     3.2  11.4    22   2.8   10.3   2.8\n 3 2020-01-03 Asturias   10.7   0.7   7.4  14      99   2.8    9.7   1.9\n 4 2020-01-04 Asturias    8.4   2.4   5.6  11.1    99   3.6    7.2   0.7\n 5 2020-01-05 Asturias    8.2   0     4.7  11.8    13   2.5    7.2   8.6\n 6 2020-01-06 Asturias    7.6   0     2.8  12.3    22   3.1    8.9   6.3\n 7 2020-01-07 Asturias    8.8   0     4.3  13.3    99   1.9    8.9   8  \n 8 2020-01-08 Asturias   13.4   0     9    17.7    22   2.8    8.3   6.1\n 9 2020-01-09 Asturias   14.4   5.5   8.7  20.2    29   7.8   24.2   4.3\n10 2020-01-10 Asturias    8.2   0.6   4.9  11.6    28   2.2   16.1   1.9\n# … with 4,095 more rows"
  },
  {
    "objectID": "combination.html",
    "href": "combination.html",
    "title": "Task 2: Datasets combination",
    "section": "",
    "text": "During the first task, data loading and cleaning has been performed. For each of the datasets, the final files were stored in the “/data/clean/” project folder by saving them as a RDS file, which creates a serialized version of the dataset and then saves it with gzip.\nBy doing this we avoid problems in further reading, since the dataset will be loaded as an R object exactly as when the cleaning of the dataset were finished.\nFirst, we need to load packages:\n\npacman::p_load(\n      here,      # file locator\n      tidyverse, # data management and ggplot2 graphics\n      skimr,     # get overview of data\n      janitor    # produce and adorn tabulations and cross-tabulations\n)"
  },
  {
    "objectID": "combination.html#cne-aemet",
    "href": "combination.html#cne-aemet",
    "title": "Task 2: Datasets combination",
    "section": "CNE + AEMET",
    "text": "CNE + AEMET\nImport clean datasets:\n\ncne_clean_data <- readRDS(here(\"data\", \"clean\", \"cne_data.rds\"))\ncne_clean_data\n\n# A tibble: 42,588 × 11\n   provincia_iso fecha      num_casos num_casos_prueba_pcr num_casos_prueba_tes…\n   <chr>         <date>         <dbl>                <dbl>                 <dbl>\n 1 A             2020-01-01         0                    0                     0\n 2 AB            2020-01-01         0                    0                     0\n 3 AL            2020-01-01         0                    0                     0\n 4 AV            2020-01-01         0                    0                     0\n 5 B             2020-01-01         0                    0                     0\n 6 BA            2020-01-01         0                    0                     0\n 7 BI            2020-01-01         0                    0                     0\n 8 BU            2020-01-01         0                    0                     0\n 9 C             2020-01-01         0                    0                     0\n10 CA            2020-01-01         0                    0                     0\n# … with 42,578 more rows, and 6 more variables: num_casos_prueba_ag <dbl>,\n#   num_casos_prueba_elisa <dbl>, num_casos_prueba_desconocida <dbl>,\n#   num_hosp <dbl>, num_uci <dbl>, num_def <dbl>\n\n\n\naemet_clean_data <- readRDS(here(\"data\", \"clean\", \"aemet_data.rds\"))\naemet_clean_data\n\n# A tibble: 4,105 × 10\n   fecha      provincia  tmed  prec  tmin  tmax    wd    ws ws_max   sol\n   <date>     <chr>     <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl> <dbl>\n 1 2020-01-01 Asturias    7.4   0     3.8  11      99   2.5    7.8   7.9\n 2 2020-01-02 Asturias    7.3   0     3.2  11.4    22   2.8   10.3   2.8\n 3 2020-01-03 Asturias   10.7   0.7   7.4  14      99   2.8    9.7   1.9\n 4 2020-01-04 Asturias    8.4   2.4   5.6  11.1    99   3.6    7.2   0.7\n 5 2020-01-05 Asturias    8.2   0     4.7  11.8    13   2.5    7.2   8.6\n 6 2020-01-06 Asturias    7.6   0     2.8  12.3    22   3.1    8.9   6.3\n 7 2020-01-07 Asturias    8.8   0     4.3  13.3    99   1.9    8.9   8  \n 8 2020-01-08 Asturias   13.4   0     9    17.7    22   2.8    8.3   6.1\n 9 2020-01-09 Asturias   14.4   5.5   8.7  20.2    29   7.8   24.2   4.3\n10 2020-01-10 Asturias    8.2   0.6   4.9  11.6    28   2.2   16.1   1.9\n# … with 4,095 more rows\n\n\nIn the following analyses we will focus on the provinces:\n\nAsturias\nBarcelona\nMadrid\nMálaga\nSevilla\n\nMeteorological data from AEMET already corresponds to those provinces so we will proceed to filter the data from CNE.\n\n# Ref iso code provinces https://es.wikipedia.org/wiki/ISO_3166-2:ES\ncne_clean_data <- cne_clean_data %>% \n      filter(provincia_iso %in% c(\"O\", \"B\", \"M\", \"MA\", \"SE\")) %>% \n      mutate(\n            provincia_iso = case_when(\n                  provincia_iso == \"O\" ~ \"Asturias\",\n                  provincia_iso == \"B\" ~ \"Barcelona\",\n                  provincia_iso == \"M\" ~ \"Madrid\",\n                  provincia_iso == \"MA\" ~ \"Málaga\",\n                  provincia_iso == \"SE\" ~ \"Sevilla\",\n                  TRUE ~ provincia_iso\n            )\n      ) %>% \n      rename(provincia = provincia_iso)\ncne_clean_data\n\n# A tibble: 4,095 × 11\n   provincia fecha      num_casos num_casos_prueba_pcr num_casos_prueba_test_ac\n   <chr>     <date>         <dbl>                <dbl>                    <dbl>\n 1 Barcelona 2020-01-01         0                    0                        0\n 2 Madrid    2020-01-01         1                    1                        0\n 3 Málaga    2020-01-01         0                    0                        0\n 4 Asturias  2020-01-01         0                    0                        0\n 5 Sevilla   2020-01-01         0                    0                        0\n 6 Barcelona 2020-01-02         0                    0                        0\n 7 Madrid    2020-01-02         0                    0                        0\n 8 Málaga    2020-01-02         0                    0                        0\n 9 Asturias  2020-01-02         0                    0                        0\n10 Sevilla   2020-01-02         0                    0                        0\n# … with 4,085 more rows, and 6 more variables: num_casos_prueba_ag <dbl>,\n#   num_casos_prueba_elisa <dbl>, num_casos_prueba_desconocida <dbl>,\n#   num_hosp <dbl>, num_uci <dbl>, num_def <dbl>\n\n\n\ncovid_data <- left_join(cne_clean_data, aemet_clean_data, by=c(\"fecha\", \"provincia\"))\ncovid_data\n\n# A tibble: 4,095 × 19\n   provincia fecha      num_casos num_casos_prueba_pcr num_casos_prueba_test_ac\n   <chr>     <date>         <dbl>                <dbl>                    <dbl>\n 1 Barcelona 2020-01-01         0                    0                        0\n 2 Madrid    2020-01-01         1                    1                        0\n 3 Málaga    2020-01-01         0                    0                        0\n 4 Asturias  2020-01-01         0                    0                        0\n 5 Sevilla   2020-01-01         0                    0                        0\n 6 Barcelona 2020-01-02         0                    0                        0\n 7 Madrid    2020-01-02         0                    0                        0\n 8 Málaga    2020-01-02         0                    0                        0\n 9 Asturias  2020-01-02         0                    0                        0\n10 Sevilla   2020-01-02         0                    0                        0\n# … with 4,085 more rows, and 14 more variables: num_casos_prueba_ag <dbl>,\n#   num_casos_prueba_elisa <dbl>, num_casos_prueba_desconocida <dbl>,\n#   num_hosp <dbl>, num_uci <dbl>, num_def <dbl>, tmed <dbl>, prec <dbl>,\n#   tmin <dbl>, tmax <dbl>, wd <dbl>, ws <dbl>, ws_max <dbl>, sol <dbl>\n\n\nCheck if missing information:\n\nskim(covid_data)\n\n\nData summary\n\n\nName\ncovid_data\n\n\nNumber of rows\n4095\n\n\nNumber of columns\n19\n\n\n_______________________\n\n\n\nColumn type frequency:\n\n\n\ncharacter\n1\n\n\nDate\n1\n\n\nnumeric\n17\n\n\n________________________\n\n\n\nGroup variables\nNone\n\n\n\nVariable type: character\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nempty\nn_unique\nwhitespace\n\n\n\n\nprovincia\n0\n1\n6\n9\n0\n5\n0\n\n\n\nVariable type: Date\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nmedian\nn_unique\n\n\n\n\nfecha\n0\n1\n2020-01-01\n2022-03-29\n2021-02-13\n819\n\n\n\nVariable type: numeric\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmean\nsd\np0\np25\np50\np75\np100\nhist\n\n\n\n\nnum_casos\n0\n1\n1014.00\n2598.89\n0.0\n64.0\n280.0\n984.00\n34701.0\n▇▁▁▁▁\n\n\nnum_casos_prueba_pcr\n0\n1\n495.68\n854.53\n0.0\n50.0\n176.0\n565.50\n10167.0\n▇▁▁▁▁\n\n\nnum_casos_prueba_test_ac\n0\n1\n0.03\n0.25\n0.0\n0.0\n0.0\n0.00\n5.0\n▇▁▁▁▁\n\n\nnum_casos_prueba_ag\n0\n1\n504.14\n2018.32\n0.0\n0.0\n43.0\n240.00\n31073.0\n▇▁▁▁▁\n\n\nnum_casos_prueba_elisa\n0\n1\n0.71\n3.42\n0.0\n0.0\n0.0\n0.00\n55.0\n▇▁▁▁▁\n\n\nnum_casos_prueba_desconocida\n0\n1\n13.44\n53.64\n0.0\n0.0\n0.0\n0.00\n519.0\n▇▁▁▁▁\n\n\nnum_hosp\n0\n1\n51.28\n119.70\n0.0\n6.0\n18.0\n48.00\n1934.0\n▇▁▁▁▁\n\n\nnum_uci\n0\n1\n4.45\n9.74\n0.0\n0.0\n1.0\n4.00\n135.0\n▇▁▁▁▁\n\n\nnum_def\n0\n1\n9.78\n23.79\n0.0\n0.0\n3.0\n10.00\n334.0\n▇▁▁▁▁\n\n\ntmed\n0\n1\n16.63\n6.45\n-6.2\n12.0\n15.6\n21.20\n34.5\n▁▂▇▅▂\n\n\nprec\n0\n1\n1.75\n6.14\n0.0\n0.0\n0.0\n0.20\n87.9\n▇▁▁▁▁\n\n\ntmin\n0\n1\n11.69\n6.23\n-13.4\n7.4\n11.3\n16.10\n27.5\n▁▁▇▇▂\n\n\ntmax\n0\n1\n21.57\n7.30\n0.3\n16.2\n20.3\n26.40\n44.9\n▁▇▇▃▁\n\n\nwd\n0\n1\n41.76\n36.25\n1.0\n15.0\n26.0\n99.00\n99.0\n▆▇▁▁▆\n\n\nws\n0\n1\n3.72\n1.73\n0.3\n2.5\n3.6\n4.40\n18.9\n▇▅▁▁▁\n\n\nws_max\n0\n1\n10.24\n3.61\n2.5\n7.8\n9.7\n12.05\n31.9\n▅▇▂▁▁\n\n\nsol\n0\n1\n6.98\n4.12\n0.0\n3.5\n7.7\n10.30\n14.3\n▇▅▆▇▅"
  },
  {
    "objectID": "combination.html#cneaemet-google",
    "href": "combination.html#cneaemet-google",
    "title": "Task 2: Datasets combination",
    "section": "CNE/AEMET + GOOGLE",
    "text": "CNE/AEMET + GOOGLE\nLoad clean data:\n\ngoogle_data <- readRDS(here(\"data\", \"clean\", \"google_data.rds\"))\n\nRename provinces to match previous dataset:\n\ngoogle_data <- google_data %>% \n      filter(province %in% c(\"Asturias\", \"Barcelona\", \"Madrid\", \"Málaga\", \"Seville\")) %>% \n      mutate(province = ifelse(province == \"Seville\", \"Sevilla\", province)) %>% \n      select(-CA, -iso_3166_2_code, provincia = province)\ngoogle_data\n\n# A tibble: 4,025 × 8\n# Groups:   provincia [5]\n   provincia fecha      mob_grocery_pharmacy mob_parks mob_residential\n   <chr>     <date>                    <dbl>     <dbl>           <dbl>\n 1 Asturias  2020-02-15                   -1        20              -1\n 2 Asturias  2020-02-16                    1        11              -2\n 3 Asturias  2020-02-17                    0       -13              -1\n 4 Asturias  2020-02-18                    1        11              -1\n 5 Asturias  2020-02-19                    1        29              -2\n 6 Asturias  2020-02-20                    0        32              -3\n 7 Asturias  2020-02-21                   -1        18               0\n 8 Asturias  2020-02-22                    1        29              -1\n 9 Asturias  2020-02-23                    6        23              -3\n10 Asturias  2020-02-24                    5        48              -1\n# … with 4,015 more rows, and 3 more variables: mob_retail_recreation <dbl>,\n#   mob_transit_stations <dbl>, mob_workplaces <dbl>\n\n\nStatistics for Google data\n\nskim(google_data)\n\n\nData summary\n\n\nName\ngoogle_data\n\n\nNumber of rows\n4025\n\n\nNumber of columns\n8\n\n\n_______________________\n\n\n\nColumn type frequency:\n\n\n\nDate\n1\n\n\nnumeric\n6\n\n\n________________________\n\n\n\nGroup variables\nprovincia\n\n\n\nVariable type: Date\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nprovincia\nn_missing\ncomplete_rate\nmin\nmax\nmedian\nn_unique\n\n\n\n\nfecha\nAsturias\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nBarcelona\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nMadrid\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nMálaga\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\nfecha\nSevilla\n0\n1\n2020-02-15\n2022-04-29\n2021-03-23\n805\n\n\n\nVariable type: numeric\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nprovincia\nn_missing\ncomplete_rate\nmean\nsd\np0\np25\np50\np75\np100\nhist\n\n\n\n\nmob_grocery_pharmacy\nAsturias\n0\n1\n-0.76\n19.96\n-94\n-3\n3\n9\n42\n▁▁▁▇▁\n\n\nmob_grocery_pharmacy\nBarcelona\n0\n1\n-4.14\n20.77\n-91\n-10\n0\n9\n58\n▁▁▆▇▁\n\n\nmob_grocery_pharmacy\nMadrid\n0\n1\n-6.40\n19.37\n-87\n-13\n-3\n6\n50\n▁▁▆▇▁\n\n\nmob_grocery_pharmacy\nMálaga\n0\n1\n2.88\n30.53\n-91\n-8\n4\n14\n156\n▁▇▆▁▁\n\n\nmob_grocery_pharmacy\nSevilla\n0\n1\n-4.90\n22.74\n-91\n-12\n-1\n7\n117\n▁▃▇▁▁\n\n\nmob_parks\nAsturias\n0\n1\n45.19\n71.02\n-88\n5\n33\n70\n333\n▂▇▂▁▁\n\n\nmob_parks\nBarcelona\n0\n1\n-10.48\n23.79\n-93\n-19\n-6\n5\n33\n▁▁▃▇▃\n\n\nmob_parks\nMadrid\n0\n1\n-9.83\n28.19\n-92\n-22\n-6\n10\n77\n▁▂▇▃▁\n\n\nmob_parks\nMálaga\n0\n1\n6.13\n43.88\n-92\n-18\n2\n27\n152\n▂▇▆▂▁\n\n\nmob_parks\nSevilla\n0\n1\n-17.95\n25.70\n-93\n-30\n-13\n-3\n95\n▁▅▇▁▁\n\n\nmob_residential\nAsturias\n0\n1\n5.34\n7.44\n-8\n1\n3\n8\n40\n▆▇▁▁▁\n\n\nmob_residential\nBarcelona\n0\n1\n9.00\n8.45\n-7\n4\n7\n11\n47\n▃▇▁▁▁\n\n\nmob_residential\nMadrid\n0\n1\n8.95\n9.18\n-10\n4\n7\n11\n46\n▂▇▂▁▁\n\n\nmob_residential\nMálaga\n0\n1\n6.22\n7.37\n-4\n2\n4\n8\n40\n▇▆▁▁▁\n\n\nmob_residential\nSevilla\n0\n1\n5.59\n7.59\n-7\n1\n4\n8\n42\n▆▇▁▁▁\n\n\nmob_retail_recreation\nAsturias\n0\n1\n-26.49\n24.13\n-97\n-34\n-21\n-11\n15\n▁▁▃▇▃\n\n\nmob_retail_recreation\nBarcelona\n0\n1\n-32.91\n21.91\n-97\n-43\n-27\n-17\n3\n▁▁▃▇▅\n\n\nmob_retail_recreation\nMadrid\n0\n1\n-32.62\n21.35\n-96\n-38\n-28\n-19\n4\n▁▁▃▇▂\n\n\nmob_retail_recreation\nMálaga\n0\n1\n-21.14\n26.07\n-97\n-31\n-16\n-4\n30\n▁▁▅▇▂\n\n\nmob_retail_recreation\nSevilla\n0\n1\n-26.91\n22.30\n-97\n-35\n-23\n-11\n23\n▁▁▆▇▁\n\n\nmob_transit_stations\nAsturias\n0\n1\n-17.30\n20.87\n-85\n-26\n-14\n-4\n26\n▁▁▅▇▂\n\n\nmob_transit_stations\nBarcelona\n0\n1\n-27.65\n18.95\n-91\n-35\n-25\n-15\n10\n▁▁▃▇▂\n\n\nmob_transit_stations\nMadrid\n0\n1\n-33.40\n19.63\n-93\n-42\n-32\n-19\n10\n▁▁▇▇▁\n\n\nmob_transit_stations\nMálaga\n0\n1\n-22.89\n25.52\n-93\n-37\n-22\n-3\n33\n▂▂▇▆▂\n\n\nmob_transit_stations\nSevilla\n0\n1\n-28.81\n21.99\n-94\n-40\n-27\n-14\n52\n▁▃▇▂▁\n\n\nmob_workplaces\nAsturias\n0\n1\n-23.33\n17.05\n-88\n-28\n-19\n-13\n12\n▁▁▂▇▁\n\n\nmob_workplaces\nBarcelona\n0\n1\n-30.01\n19.76\n-92\n-39\n-26\n-17\n6\n▁▂▃▇▃\n\n\nmob_workplaces\nMadrid\n0\n1\n-30.44\n22.60\n-92\n-45\n-27\n-15\n20\n▂▃▇▇▂\n\n\nmob_workplaces\nMálaga\n0\n1\n-21.63\n19.72\n-89\n-29\n-18\n-10\n29\n▁▁▆▇▁\n\n\nmob_workplaces\nSevilla\n0\n1\n-23.28\n19.04\n-90\n-32\n-17\n-10\n9\n▁▁▃▇▅\n\n\n\n\n\nSince everything is right, we will combine the data with the already combined dataset from CNE and AEMET:\n\ncovid_data <- left_join(covid_data, google_data, by=c(\"fecha\", \"provincia\"))\ncovid_data\n\n# A tibble: 4,095 × 25\n   provincia fecha      num_casos num_casos_prueba_pcr num_casos_prueba_test_ac\n   <chr>     <date>         <dbl>                <dbl>                    <dbl>\n 1 Barcelona 2020-01-01         0                    0                        0\n 2 Madrid    2020-01-01         1                    1                        0\n 3 Málaga    2020-01-01         0                    0                        0\n 4 Asturias  2020-01-01         0                    0                        0\n 5 Sevilla   2020-01-01         0                    0                        0\n 6 Barcelona 2020-01-02         0                    0                        0\n 7 Madrid    2020-01-02         0                    0                        0\n 8 Málaga    2020-01-02         0                    0                        0\n 9 Asturias  2020-01-02         0                    0                        0\n10 Sevilla   2020-01-02         0                    0                        0\n# … with 4,085 more rows, and 20 more variables: num_casos_prueba_ag <dbl>,\n#   num_casos_prueba_elisa <dbl>, num_casos_prueba_desconocida <dbl>,\n#   num_hosp <dbl>, num_uci <dbl>, num_def <dbl>, tmed <dbl>, prec <dbl>,\n#   tmin <dbl>, tmax <dbl>, wd <dbl>, ws <dbl>, ws_max <dbl>, sol <dbl>,\n#   mob_grocery_pharmacy <dbl>, mob_parks <dbl>, mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>\n\n\nIt is important to note that Google provides data as of February 15nd. Before that day, there is not information related to Google´s mobility."
  },
  {
    "objectID": "combination.html#cneaemetgoogle-ine",
    "href": "combination.html#cneaemetgoogle-ine",
    "title": "Task 2: Datasets combination",
    "section": "CNE/AEMET/GOOGLE + INE",
    "text": "CNE/AEMET/GOOGLE + INE\nLoad clean INE data:\n\nine_data <- readRDS(here(\"data\", \"clean\", \"ine_data.rds\"))\n\nRename provinces to match previous datasets:\n\nine_data <- ine_data %>% \n      filter(province %in% c(\"Asturias\", \"Barcelona\", \"Madrid\", \"Málaga\", \"Sevilla\")) %>% \n      rename(\n            provincia = province,\n            mob_flujo = flujo\n      )\nine_data\n\n# A tibble: 3,270 × 3\n   fecha      provincia mob_flujo\n   <date>     <chr>         <dbl>\n 1 2020-03-16 Málaga         11.4\n 2 2020-03-16 Sevilla        12.3\n 3 2020-03-16 Asturias       13.1\n 4 2020-03-16 Barcelona      14.6\n 5 2020-03-16 Madrid         13.9\n 6 2020-03-17 Málaga         10.7\n 7 2020-03-17 Sevilla        11.5\n 8 2020-03-17 Asturias       12.5\n 9 2020-03-17 Barcelona      14.0\n10 2020-03-17 Madrid         13.4\n# … with 3,260 more rows\n\n\nCombination with previous datasets:\n\ncovid_data <- left_join(covid_data, ine_data, by=c(\"fecha\", \"provincia\"))\ncovid_data\n\n# A tibble: 4,095 × 26\n   provincia fecha      num_casos num_casos_prueba_pcr num_casos_prueba_test_ac\n   <chr>     <date>         <dbl>                <dbl>                    <dbl>\n 1 Barcelona 2020-01-01         0                    0                        0\n 2 Madrid    2020-01-01         1                    1                        0\n 3 Málaga    2020-01-01         0                    0                        0\n 4 Asturias  2020-01-01         0                    0                        0\n 5 Sevilla   2020-01-01         0                    0                        0\n 6 Barcelona 2020-01-02         0                    0                        0\n 7 Madrid    2020-01-02         0                    0                        0\n 8 Málaga    2020-01-02         0                    0                        0\n 9 Asturias  2020-01-02         0                    0                        0\n10 Sevilla   2020-01-02         0                    0                        0\n# … with 4,085 more rows, and 21 more variables: num_casos_prueba_ag <dbl>,\n#   num_casos_prueba_elisa <dbl>, num_casos_prueba_desconocida <dbl>,\n#   num_hosp <dbl>, num_uci <dbl>, num_def <dbl>, tmed <dbl>, prec <dbl>,\n#   tmin <dbl>, tmax <dbl>, wd <dbl>, ws <dbl>, ws_max <dbl>, sol <dbl>,\n#   mob_grocery_pharmacy <dbl>, mob_parks <dbl>, mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>, mob_flujo <dbl>\n\n\nMobility information published by INE is available as of March 16th which we will consider the beginning of our analysis."
  },
  {
    "objectID": "combination.html#final-covid-dataset",
    "href": "combination.html#final-covid-dataset",
    "title": "Task 2: Datasets combination",
    "section": "Final covid dataset",
    "text": "Final covid dataset\nThe statistics of the final dataset looks like:\n\nskim(covid_data)\n\n\nData summary\n\n\nName\ncovid_data\n\n\nNumber of rows\n4095\n\n\nNumber of columns\n26\n\n\n_______________________\n\n\n\nColumn type frequency:\n\n\n\ncharacter\n1\n\n\nDate\n1\n\n\nnumeric\n24\n\n\n________________________\n\n\n\nGroup variables\nNone\n\n\n\nVariable type: character\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nempty\nn_unique\nwhitespace\n\n\n\n\nprovincia\n0\n1\n6\n9\n0\n5\n0\n\n\n\nVariable type: Date\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nmedian\nn_unique\n\n\n\n\nfecha\n0\n1\n2020-01-01\n2022-03-29\n2021-02-13\n819\n\n\n\nVariable type: numeric\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmean\nsd\np0\np25\np50\np75\np100\nhist\n\n\n\n\nnum_casos\n0\n1.00\n1014.00\n2598.89\n0.00\n64.00\n280.00\n984.00\n34701.00\n▇▁▁▁▁\n\n\nnum_casos_prueba_pcr\n0\n1.00\n495.68\n854.53\n0.00\n50.00\n176.00\n565.50\n10167.00\n▇▁▁▁▁\n\n\nnum_casos_prueba_test_ac\n0\n1.00\n0.03\n0.25\n0.00\n0.00\n0.00\n0.00\n5.00\n▇▁▁▁▁\n\n\nnum_casos_prueba_ag\n0\n1.00\n504.14\n2018.32\n0.00\n0.00\n43.00\n240.00\n31073.00\n▇▁▁▁▁\n\n\nnum_casos_prueba_elisa\n0\n1.00\n0.71\n3.42\n0.00\n0.00\n0.00\n0.00\n55.00\n▇▁▁▁▁\n\n\nnum_casos_prueba_desconocida\n0\n1.00\n13.44\n53.64\n0.00\n0.00\n0.00\n0.00\n519.00\n▇▁▁▁▁\n\n\nnum_hosp\n0\n1.00\n51.28\n119.70\n0.00\n6.00\n18.00\n48.00\n1934.00\n▇▁▁▁▁\n\n\nnum_uci\n0\n1.00\n4.45\n9.74\n0.00\n0.00\n1.00\n4.00\n135.00\n▇▁▁▁▁\n\n\nnum_def\n0\n1.00\n9.78\n23.79\n0.00\n0.00\n3.00\n10.00\n334.00\n▇▁▁▁▁\n\n\ntmed\n0\n1.00\n16.63\n6.45\n-6.20\n12.00\n15.60\n21.20\n34.50\n▁▂▇▅▂\n\n\nprec\n0\n1.00\n1.75\n6.14\n0.00\n0.00\n0.00\n0.20\n87.90\n▇▁▁▁▁\n\n\ntmin\n0\n1.00\n11.69\n6.23\n-13.40\n7.40\n11.30\n16.10\n27.50\n▁▁▇▇▂\n\n\ntmax\n0\n1.00\n21.57\n7.30\n0.30\n16.20\n20.30\n26.40\n44.90\n▁▇▇▃▁\n\n\nwd\n0\n1.00\n41.76\n36.25\n1.00\n15.00\n26.00\n99.00\n99.00\n▆▇▁▁▆\n\n\nws\n0\n1.00\n3.72\n1.73\n0.30\n2.50\n3.60\n4.40\n18.90\n▇▅▁▁▁\n\n\nws_max\n0\n1.00\n10.24\n3.61\n2.50\n7.80\n9.70\n12.05\n31.90\n▅▇▂▁▁\n\n\nsol\n0\n1.00\n6.98\n4.12\n0.00\n3.50\n7.70\n10.30\n14.30\n▇▅▆▇▅\n\n\nmob_grocery_pharmacy\n225\n0.95\n-2.89\n23.44\n-94.00\n-10.00\n0.00\n9.00\n156.00\n▁▇▅▁▁\n\n\nmob_parks\n225\n0.95\n2.16\n48.40\n-93.00\n-20.00\n-3.00\n15.75\n333.00\n▇▇▁▁▁\n\n\nmob_residential\n225\n0.95\n7.24\n8.26\n-8.00\n2.00\n5.00\n10.00\n47.00\n▆▇▁▁▁\n\n\nmob_retail_recreation\n225\n0.95\n-28.46\n23.87\n-97.00\n-38.00\n-24.00\n-13.00\n30.00\n▂▂▇▇▁\n\n\nmob_transit_stations\n225\n0.95\n-26.74\n22.16\n-94.00\n-38.00\n-25.00\n-12.00\n26.00\n▁▂▇▇▂\n\n\nmob_workplaces\n225\n0.95\n-26.11\n20.04\n-92.00\n-35.00\n-22.00\n-12.00\n29.00\n▁▂▇▇▁\n\n\nmob_flujo\n825\n0.80\n15.75\n3.84\n4.56\n13.31\n15.95\n18.44\n26.24\n▁▃▇▅▁\n\n\n\n\n\nThe missing information corresponds to the periods for which no data have been provided. These are placed at the beginning of the dataset, so as of March 16, 2020 all the information is available up to December 29, 2021.\n\ncovid_data %>% \n      filter(!is.na(mob_flujo)) %>% \n      summarise(\n            initial_data_without_nas = min(fecha),\n            final_data_without_nas = max(fecha)\n      )\n\n# A tibble: 1 × 2\n  initial_data_without_nas final_data_without_nas\n  <date>                   <date>                \n1 2020-03-16               2021-12-29            \n\n\nStatistics for that period:\n\ncovid_data %>% \n      filter(fecha >= as.Date(\"2020-03-16\", format = \"%Y-%m-%d\") &\n                   fecha <= as.Date(\"2021-12-29\", format = \"%Y-%m-%d\")) %>% \n      skim()\n\n\nData summary\n\n\nName\nPiped data\n\n\nNumber of rows\n3270\n\n\nNumber of columns\n26\n\n\n_______________________\n\n\n\nColumn type frequency:\n\n\n\ncharacter\n1\n\n\nDate\n1\n\n\nnumeric\n24\n\n\n________________________\n\n\n\nGroup variables\nNone\n\n\n\nVariable type: character\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nempty\nn_unique\nwhitespace\n\n\n\n\nprovincia\n0\n1\n6\n9\n0\n5\n0\n\n\n\nVariable type: Date\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nmedian\nn_unique\n\n\n\n\nfecha\n0\n1\n2020-03-16\n2021-12-29\n2021-02-05\n654\n\n\n\nVariable type: numeric\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmean\nsd\np0\np25\np50\np75\np100\nhist\n\n\n\n\nnum_casos\n0\n1\n780.02\n1607.55\n0.00\n89.00\n271.00\n923.75\n23811.00\n▇▁▁▁▁\n\n\nnum_casos_prueba_pcr\n0\n1\n491.53\n831.31\n0.00\n65.25\n179.00\n580.00\n10167.00\n▇▁▁▁▁\n\n\nnum_casos_prueba_test_ac\n0\n1\n0.04\n0.27\n0.00\n0.00\n0.00\n0.00\n5.00\n▇▁▁▁▁\n\n\nnum_casos_prueba_ag\n0\n1\n273.56\n942.12\n0.00\n1.00\n40.00\n182.00\n16226.00\n▇▁▁▁▁\n\n\nnum_casos_prueba_elisa\n0\n1\n0.87\n3.79\n0.00\n0.00\n0.00\n0.00\n55.00\n▇▁▁▁▁\n\n\nnum_casos_prueba_desconocida\n0\n1\n14.02\n56.25\n0.00\n0.00\n0.00\n0.00\n519.00\n▇▁▁▁▁\n\n\nnum_hosp\n0\n1\n55.27\n127.95\n0.00\n7.00\n20.00\n54.00\n1934.00\n▇▁▁▁▁\n\n\nnum_uci\n0\n1\n4.97\n10.32\n0.00\n0.00\n2.00\n5.00\n135.00\n▇▁▁▁▁\n\n\nnum_def\n0\n1\n11.10\n26.14\n0.00\n1.00\n3.00\n11.00\n334.00\n▇▁▁▁▁\n\n\ntmed\n0\n1\n17.85\n6.48\n-6.20\n13.20\n17.40\n23.10\n34.50\n▁▂▇▆▂\n\n\nprec\n0\n1\n1.78\n6.06\n0.00\n0.00\n0.00\n0.20\n78.50\n▇▁▁▁▁\n\n\ntmin\n0\n1\n12.89\n6.11\n-13.40\n8.70\n12.90\n17.40\n27.50\n▁▁▆▇▃\n\n\ntmax\n0\n1\n22.80\n7.46\n0.30\n17.22\n21.70\n28.28\n44.90\n▁▆▇▅▁\n\n\nwd\n0\n1\n41.45\n35.80\n1.00\n16.00\n26.00\n99.00\n99.00\n▆▇▁▁▅\n\n\nws\n0\n1\n3.73\n1.62\n0.30\n2.50\n3.60\n4.40\n13.10\n▅▇▂▁▁\n\n\nws_max\n0\n1\n10.30\n3.50\n2.50\n7.80\n9.70\n12.06\n31.90\n▅▇▂▁▁\n\n\nsol\n0\n1\n7.32\n4.20\n0.00\n3.80\n8.10\n10.90\n14.30\n▆▅▆▇▆\n\n\nmob_grocery_pharmacy\n0\n1\n-4.38\n24.03\n-94.00\n-12.00\n-1.00\n8.00\n156.00\n▁▇▃▁▁\n\n\nmob_parks\n0\n1\n2.22\n51.72\n-93.00\n-22.00\n-4.00\n16.00\n333.00\n▇▇▁▁▁\n\n\nmob_residential\n0\n1\n7.92\n8.62\n-8.00\n2.00\n6.00\n11.00\n47.00\n▅▇▁▁▁\n\n\nmob_retail_recreation\n0\n1\n-30.76\n24.53\n-97.00\n-40.00\n-26.00\n-14.00\n30.00\n▂▂▇▆▁\n\n\nmob_transit_stations\n0\n1\n-29.40\n22.41\n-94.00\n-40.00\n-28.00\n-14.00\n26.00\n▁▂▇▅▁\n\n\nmob_workplaces\n0\n1\n-28.32\n20.09\n-92.00\n-37.00\n-25.00\n-14.00\n29.00\n▁▂▇▆▁\n\n\nmob_flujo\n0\n1\n15.75\n3.84\n4.56\n13.31\n15.95\n18.44\n26.24\n▁▃▇▅▁"
  },
  {
    "objectID": "combination.html#aditional-dataset",
    "href": "combination.html#aditional-dataset",
    "title": "Task 2: Datasets combination",
    "section": "Aditional dataset",
    "text": "Aditional dataset\nIn addition, we have the clean dataset corresponding to hospitalizations which provide detail by demographics.\nWe will not combine it with the previous dataset, but we will treat it additionally in case of needing more detail.\n\ncne_hosp_data <- readRDS(here(\"data\", \"clean\", \"cne_hosp_data.rds\"))\ncne_hosp_data\n\n# A tibble: 1,277,640 × 8\n   provincia_iso sexo  grupo_edad fecha      num_casos num_hosp num_uci num_def\n   <chr>         <chr> <chr>      <date>         <dbl>    <dbl>   <dbl>   <dbl>\n 1 A             H     0-9        2020-01-01         0        0       0       0\n 2 A             H     10-19      2020-01-01         0        0       0       0\n 3 A             H     20-29      2020-01-01         0        0       0       0\n 4 A             H     30-39      2020-01-01         0        0       0       0\n 5 A             H     40-49      2020-01-01         0        0       0       0\n 6 A             H     50-59      2020-01-01         0        0       0       0\n 7 A             H     60-69      2020-01-01         0        0       0       0\n 8 A             H     70-79      2020-01-01         0        0       0       0\n 9 A             H     80+        2020-01-01         0        0       0       0\n10 A             H     NC         2020-01-01         0        0       0       0\n# … with 1,277,630 more rows\n\n\n\ncne_hosp_data <- cne_hosp_data %>% \n      filter(provincia_iso %in% c(\"O\", \"B\", \"M\", \"MA\", \"SE\")) %>% \n      mutate(\n            provincia_iso = case_when(\n                  provincia_iso == \"O\" ~ \"Asturias\",\n                  provincia_iso == \"B\" ~ \"Barcelona\",\n                  provincia_iso == \"M\" ~ \"Madrid\",\n                  provincia_iso == \"MA\" ~ \"Málaga\",\n                  provincia_iso == \"SE\" ~ \"Sevilla\",\n                  TRUE ~ provincia_iso\n            )\n      ) %>% \n      rename(provincia = provincia_iso)\ncne_hosp_data\n\n# A tibble: 122,850 × 8\n   provincia sexo  grupo_edad fecha      num_casos num_hosp num_uci num_def\n   <chr>     <chr> <chr>      <date>         <dbl>    <dbl>   <dbl>   <dbl>\n 1 Barcelona H     0-9        2020-01-01         0        0       0       0\n 2 Barcelona H     10-19      2020-01-01         0        0       0       0\n 3 Barcelona H     20-29      2020-01-01         0        0       0       0\n 4 Barcelona H     30-39      2020-01-01         0        0       0       0\n 5 Barcelona H     40-49      2020-01-01         0        0       0       0\n 6 Barcelona H     50-59      2020-01-01         0        0       0       0\n 7 Barcelona H     60-69      2020-01-01         0        0       0       0\n 8 Barcelona H     70-79      2020-01-01         0        0       0       0\n 9 Barcelona H     80+        2020-01-01         0        0       0       0\n10 Barcelona H     NC         2020-01-01         0        0       0       0\n# … with 122,840 more rows\n\n\n\nskim(cne_hosp_data)\n\n\nData summary\n\n\nName\ncne_hosp_data\n\n\nNumber of rows\n122850\n\n\nNumber of columns\n8\n\n\n_______________________\n\n\n\nColumn type frequency:\n\n\n\ncharacter\n3\n\n\nDate\n1\n\n\nnumeric\n4\n\n\n________________________\n\n\n\nGroup variables\nNone\n\n\n\nVariable type: character\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nempty\nn_unique\nwhitespace\n\n\n\n\nprovincia\n0\n1\n6\n9\n0\n5\n0\n\n\nsexo\n0\n1\n1\n2\n0\n3\n0\n\n\ngrupo_edad\n0\n1\n2\n5\n0\n10\n0\n\n\n\nVariable type: Date\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmin\nmax\nmedian\nn_unique\n\n\n\n\nfecha\n0\n1\n2020-01-01\n2022-03-29\n2021-02-13\n819\n\n\n\nVariable type: numeric\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nskim_variable\nn_missing\ncomplete_rate\nmean\nsd\np0\np25\np50\np75\np100\nhist\n\n\n\n\nnum_casos\n0\n1\n33.80\n137.91\n0\n0\n0\n18\n3741\n▇▁▁▁▁\n\n\nnum_hosp\n0\n1\n1.71\n7.27\n0\n0\n0\n1\n270\n▇▁▁▁▁\n\n\nnum_uci\n0\n1\n0.15\n0.79\n0\n0\n0\n0\n35\n▇▁▁▁▁\n\n\nnum_def\n0\n1\n0.33\n2.27\n0\n0\n0\n0\n100\n▇▁▁▁▁\n\n\n\n\n\n\nNote\nFinal clean data are stored in the project’s folder “/data/clean/” both in rds and csv format.\n\nfinal_covid_data.csv (CNE+AEMET+GOOGLE+INE data)\nfinal_hosp_data.csv (CNE data with demographic detail)"
  },
  {
    "objectID": "visual.html",
    "href": "visual.html",
    "title": "Task 3: Visual analysis",
    "section": "",
    "text": "As previously mentioned, the visual analysis will focus on the following provinces:\n\nAsturias\nBarcelona\nMadrid\nMálaga\nSevilla\n\nFirst, we need to load packages and clean data generated during previous tasks:\n\npacman::p_load(\n      here,      # file locator\n      tidyverse, # data management and ggplot2 graphics\n      skimr,     # get overview of data\n      janitor,   # produce and adorn tabulations and cross-tabulations\n      lubridate, # manage dates\n      PerformanceAnalytics,\n      factoextra\n)\n\ncovid_data <- readRDS(here(\"data\", \"clean\", \"final_covid_data.rds\"))\ncovid_data\n\n# A tibble: 4,095 × 26\n   provincia fecha      num_casos num_casos_prueba_pcr num_casos_prueba_test_ac\n   <chr>     <date>         <dbl>                <dbl>                    <dbl>\n 1 Barcelona 2020-01-01         0                    0                        0\n 2 Madrid    2020-01-01         1                    1                        0\n 3 Málaga    2020-01-01         0                    0                        0\n 4 Asturias  2020-01-01         0                    0                        0\n 5 Sevilla   2020-01-01         0                    0                        0\n 6 Barcelona 2020-01-02         0                    0                        0\n 7 Madrid    2020-01-02         0                    0                        0\n 8 Málaga    2020-01-02         0                    0                        0\n 9 Asturias  2020-01-02         0                    0                        0\n10 Sevilla   2020-01-02         0                    0                        0\n# … with 4,085 more rows, and 21 more variables: num_casos_prueba_ag <dbl>,\n#   num_casos_prueba_elisa <dbl>, num_casos_prueba_desconocida <dbl>,\n#   num_hosp <dbl>, num_uci <dbl>, num_def <dbl>, tmed <dbl>, prec <dbl>,\n#   tmin <dbl>, tmax <dbl>, wd <dbl>, ws <dbl>, ws_max <dbl>, sol <dbl>,\n#   mob_grocery_pharmacy <dbl>, mob_parks <dbl>, mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>, mob_flujo <dbl>"
  },
  {
    "objectID": "visual.html#covid-19-indicatives",
    "href": "visual.html#covid-19-indicatives",
    "title": "Task 3: Visual analysis",
    "section": "Covid-19 indicatives",
    "text": "Covid-19 indicatives\n\nNumber of cases\nAccording to CNE, in the evolution of the COVID-19 pandemic in Spain, there have been six periods:\n\nFirst period: From the beginning of the pandemic until June 21, 2020, date on which the state of alarm in Spain ended after the end of the first epidemic outbreak of COVID-19.\nSecond period: June 22 through December 6, 2020, the turning point of the 14-day cumulative incidence (CI) of COVID-19 cases, between the second and third periods.\nThird period: December 7, 2020 through March 14, 2021, AI tipping point at 14 days of COVID-19 cases, between the third and fourth epidemic periods.\nFourth period: March 15, 2021 through June 19, the 14-day AI tipping point for COVID-19 cases, between the fourth and fifth epidemic periods.\nFifth period: June 20, 2021 through October 13, AI tipping point at 14 days of COVID-19 cases, between the fifth and sixth epidemic periods.\nSixth period: From October 14, 2021 to the present, which may vary depending on the epidemiological situation of the pandemic in Spain.\n\nIn the following plots, those periods are marked with vertical dashed lines.\n\ncovid_data %>% \n      ggplot(aes(x = fecha, y = num_casos)) +\n      geom_line(aes(color = provincia)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~provincia, ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Cases reported by Province\",\n           x =\"Date\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\nThe incidence of Covid-19 in Madrid and Barcelona are much larger than in the rest of the provinces, mainly due to the number of inhabitants. The next figure show the same information than the previous one but freeing the y-axis scale.\nThis approach will be followed in further plots.\n\ncovid_data %>% \n      ggplot(aes(x = fecha, y = num_casos)) +\n      geom_line(aes(color = provincia)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Cases reported by Province (free y axis)\",\n           x =\"Date\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\nNormality study\n\n# Histogram with density plot\ncovid_data %>% \n      ggplot(aes(x=num_casos)) + \n      geom_histogram(aes(y=..density..), colour=\"black\", fill=\"white\")+\n      geom_density(alpha=.2, fill=\"#FF6666\") +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme_bw()\n\n\n\n\n\ncovid_data %>% \n      filter(provincia == \"Asturias\") %>% \n      pull(num_casos) %>% \n      qqnorm()\n\n\n\ncovid_data %>% \n      filter(provincia == \"Barcelona\") %>% \n      pull(num_casos) %>% \n      qqnorm()\n\n\n\ncovid_data %>% \n      filter(provincia == \"Madrid\") %>% \n      pull(num_casos) %>% \n      qqnorm()\n\n\n\ncovid_data %>% \n      filter(provincia == \"Málaga\") %>% \n      pull(num_casos) %>% \n      qqnorm()\n\n\n\ncovid_data %>% \n      filter(provincia == \"Sevilla\") %>% \n      pull(num_casos) %>% \n      qqnorm()\n\n\n\n\n\n\nNumber of PCR positives:\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line(aes(y = num_casos_prueba_pcr, color = provincia)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"PCR positives reported by Province\",\n           x =\"Date\", y = \"Nº of PCR positives\") +\n      theme_bw()\n\n\n\n\nNumber of covid cases accounted by positive PCR tests:\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_area(aes(y = num_casos_prueba_pcr)) +\n      geom_line(aes(y = num_casos, color = provincia)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Porportion of positives cases based on positive PCR test\",\n           x =\"Date\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\n\nNumber of hospitalizations:\n\ncovid_data %>% \n      ggplot() +\n      geom_line(aes(x = fecha, y = num_hosp, color = provincia)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Hospitalization cases reported by Province\",\n           x =\"Date\", y = \"Nº of hospitazations\") +\n      theme_bw()\n\n\n\n\nNumber of hospitalizations vs number of cases:\n\n# Value used to transform the data\ncoeff <- 20\n\n# A few constants for colors\ntemperatureColor <- \"#ff9e81\"\npriceColor <- rgb(0.2, 0.6, 0.9, 1)\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line( aes(y = num_hosp), size=1, color=temperatureColor) + \n      geom_line( aes(y = num_casos / coeff), size=1, color=priceColor) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      scale_y_continuous(\n            # Features of the first axis\n            name = \"Number of hospitalizations\",\n            # Add a second axis and specify its features\n            sec.axis = sec_axis(~.*coeff, name=\"Nº of cases\")\n      ) +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme_bw() +\n      theme(\n            axis.title.y = element_text(color = temperatureColor, size=13),\n            axis.title.y.right = element_text(color = priceColor, size=13)\n      ) +\n      ggtitle(\"Hospitalization cases vs number of cases\")\n\n\n\n\n\n\nNumber of UCI hospitalizations:\n\ncovid_data %>% \n      ggplot() +\n      geom_line(aes(x = fecha, y = num_uci, color = provincia)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"UCI hospitalization cases reported by Province\",\n           x =\"Date\", y = \"Nº of UCI hospitazations\") +\n      theme_bw()\n\n\n\n\nNumber of UCI hospitalizations vs number of cases:\n\n# Value used to transform the data\ncoeff <- 300\n\n# A few constants for colors\ntemperatureColor <- \"#ff9e81\"\npriceColor <- rgb(0.2, 0.6, 0.9, 1)\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line( aes(y = num_uci), size=1, color=temperatureColor) + \n      geom_line( aes(y = num_casos / coeff), size=1, color=priceColor) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      scale_y_continuous(\n            # Features of the first axis\n            name = \"Number of UCI hospitalizations\",\n            # Add a second axis and specify its features\n            sec.axis = sec_axis(~.*coeff, name=\"Nº of cases\")\n      ) +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme_bw() +\n      theme(\n            axis.title.y = element_text(color = temperatureColor, size=13),\n            axis.title.y.right = element_text(color = priceColor, size=13)\n      ) +\n      ggtitle(\"UCI hospitalization vs number of cases\")\n\n\n\n\n\n\nNumber of deaths\n\ncovid_data %>% \n      ggplot() +\n      geom_line(aes(x = fecha, y = num_def, color = provincia)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Deaths reported by Province\",\n           x =\"Date\", y = \"Nº of deaths\") +\n      theme_bw()\n\n\n\n\n\n# Value used to transform the data\ncoeff <- 100\n\n# A few constants for colors\ntemperatureColor <- \"#ff9e81\"\npriceColor <- rgb(0.2, 0.6, 0.9, 1)\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line( aes(y = num_def), size=1, color=temperatureColor) + \n      geom_line( aes(y = num_casos / coeff), size=1, color=priceColor) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      scale_y_continuous(\n            # Features of the first axis\n            name = \"Number of deaths\",\n            # Add a second axis and specify its features\n            sec.axis = sec_axis(~.*coeff, name=\"Nº of cases\")\n      ) +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme_bw() +\n      theme(\n            axis.title.y = element_text(color = temperatureColor, size=13),\n            axis.title.y.right = element_text(color = priceColor, size=13)\n      ) +\n      ggtitle(\"Number of deaths vs number of cases\")\n\n\n\n\n\n\nhospitalizations vs uci vs deaths\n\ncovid_data %>% \n      ggplot() +\n      # geom_line(aes(x = fecha, y = num_uci, color = provincia)) +\n      # geom_line(aes(x = fecha, y = num_hosp, color = provincia)) +\n      # geom_line(aes(x = fecha, y = num_def, color = provincia)) +\n      geom_line(aes(x = fecha, y = num_uci, color = \"red\")) +\n      geom_line(aes(x = fecha, y = num_hosp, color = \"black\")) +\n      geom_line(aes(x = fecha, y = num_def, color = \"blue\")) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Hospitalization vs uci vs deaths reported by Province\",\n           x =\"Date\", y = \"Nº of cases reported (hosp/uci/deaths)\") +\n      theme_bw() +\n      theme(legend.position = \"none\") \n\n\n\n\n\n# Value used to transform the data\ncoeff <- 50\n\n# A few constants for colors\npriceColor <- rgb(0.2, 0.6, 0.9, 1)\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line(aes(x = fecha, y = num_uci, color = \"red\")) +\n      geom_line(aes(x = fecha, y = num_hosp, color = \"black\")) +\n      geom_line(aes(x = fecha, y = num_def, color = \"blue\")) +\n      geom_line( aes(y = num_casos / coeff), size=1, color=priceColor) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      scale_y_continuous(\n            # Features of the first axis\n            name = \"Nº of cases reported (hosp/uci/deaths)\",\n            # Add a second axis and specify its features\n            sec.axis = sec_axis(~.*coeff, name=\"Nº of cases\")\n      ) +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme_bw() +\n      theme(\n            axis.title.y = element_text(size=13),\n            axis.title.y.right = element_text(color = priceColor, size=13),\n            legend.position = \"none\") +\n      ggtitle(\"Hospitalization vs uci vs deaths vs number of cases\")"
  },
  {
    "objectID": "visual.html#meteorology",
    "href": "visual.html#meteorology",
    "title": "Task 3: Visual analysis",
    "section": "Meteorology",
    "text": "Meteorology\n\ntmed vs tmin\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line(aes(y = tmed, color = provincia)) +\n      geom_line(aes(y = tmin, color = provincia)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Evolution of temperature by Province\",\n           x =\"Date\", y = \"Temperature (Celsius °)\") +\n      theme_bw()\n\n\n\n\nEvolution of temperature vs number cases:\n\n# Value used to transform the data\ncoeff <- 400\n\n# A few constants for colors\ntemperatureColor <- \"#ff9e81\"\npriceColor <- rgb(0.2, 0.6, 0.9, 1)\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line( aes(y = tmin), size=1, color=temperatureColor) + \n      geom_line( aes(y = num_casos / coeff), size=1, color=priceColor) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      scale_y_continuous(\n            # Features of the first axis\n            name = \"Temperature (Celsius °)\",\n            # Add a second axis and specify its features\n            sec.axis = sec_axis(~.*coeff, name=\"Nº of cases\")\n      ) +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme_bw() +\n      theme(\n            axis.title.y = element_text(color = temperatureColor, size=13),\n            axis.title.y.right = element_text(color = priceColor, size=13)\n      ) +\n      ggtitle(\"Temperature variation vs number of cases\")\n\n\n\n\n\n\nPrecipitations\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_area(aes(y = prec, fill = provincia)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Precipitations meassured by Province\",\n           x =\"Date\", y = \"Precipitation (mm)\") +\n      theme_bw()\n\n\n\n\nPrecipitations vs number cases:\n\n# Value used to transform the data\ncoeff <- 200\n\n# A few constants for colors\ntemperatureColor <- \"#ff9e81\"\npriceColor <- rgb(0.2, 0.6, 0.9, 1)\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line( aes(y = prec), size=1, color=temperatureColor) + \n      geom_line( aes(y = num_casos / coeff), size=1, color=priceColor) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      scale_y_continuous(\n            # Features of the first axis\n            name = \"Precipitation (mm)\",\n            # Add a second axis and specify its features\n            sec.axis = sec_axis(~.*coeff, name=\"Nº of cases\")\n      ) +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme_bw() +\n      theme(\n            axis.title.y = element_text(color = temperatureColor, size=13),\n            axis.title.y.right = element_text(color = priceColor, size=13)\n      ) +\n      ggtitle(\"Precipitations meassured vs number of cases\")"
  },
  {
    "objectID": "visual.html#mobility",
    "href": "visual.html#mobility",
    "title": "Task 3: Visual analysis",
    "section": "Mobility",
    "text": "Mobility\n\ngrocery and pharmacy\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line(aes(y = mob_grocery_pharmacy, color = provincia)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Grocery and pharmacy\",\n           x =\"Date\", y = \"Flujo (% ref day)\") +\n      theme_bw()\n\n\n\n\n\n# Value used to transform the data\ncoeff <- 50\n\n# A few constants for colors\ntemperatureColor <- \"#ff9e81\"\npriceColor <- rgb(0.2, 0.6, 0.9, 1)\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line( aes(y = mob_grocery_pharmacy), size=1, color=temperatureColor) + \n      geom_line( aes(y = num_casos / coeff), size=1, color=priceColor) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      scale_y_continuous(\n            # Features of the first axis\n            name = \"Visits to groceries and pharmacies (%)\",\n            # Add a second axis and specify its features\n            sec.axis = sec_axis(~.*coeff, name=\"Nº of cases\")\n      ) +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme_bw() +\n      theme(\n            axis.title.y = element_text(color = temperatureColor, size=13),\n            axis.title.y.right = element_text(color = priceColor, size=13)\n      ) +\n      ggtitle(\"Visits to groceries and pharmacies vs number of cases\")\n\n\n\n\n\n\nparks\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line(aes(y = mob_parks, color = provincia)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Visits to parks by Province\",\n           x =\"Date\", y = \"Flujo (% ref day)\") +\n      theme_bw()\n\n\n\n\n\n# Value used to transform the data\ncoeff <- 50\n\n# A few constants for colors\ntemperatureColor <- \"#ff9e81\"\npriceColor <- rgb(0.2, 0.6, 0.9, 1)\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line( aes(y = mob_grocery_pharmacy), size=1, color=temperatureColor) + \n      geom_line( aes(y = num_casos / coeff), size=1, color=priceColor) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      scale_y_continuous(\n            # Features of the first axis\n            name = \"Visits to parks (%)\",\n            # Add a second axis and specify its features\n            sec.axis = sec_axis(~.*coeff, name=\"Nº of cases\")\n      ) +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme_bw() +\n      theme(\n            axis.title.y = element_text(color = temperatureColor, size=13),\n            axis.title.y.right = element_text(color = priceColor, size=13)\n      ) +\n      ggtitle(\"Visits to parks vs number of cases\")\n\n\n\n\n\n\nresidential\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line(aes(y = mob_residential, color = provincia)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Visits to residential places by Province\",\n           x =\"Date\", y = \"Flujo (% ref day)\") +\n      theme_bw()\n\n\n\n\n\n# Value used to transform the data\ncoeff <- 50\n\n# A few constants for colors\ntemperatureColor <- \"#ff9e81\"\npriceColor <- rgb(0.2, 0.6, 0.9, 1)\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line( aes(y = mob_grocery_pharmacy), size=1, color=temperatureColor) + \n      geom_line( aes(y = num_casos / coeff), size=1, color=priceColor) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      scale_y_continuous(\n            # Features of the first axis\n            name = \"Visits to residential places (%)\",\n            # Add a second axis and specify its features\n            sec.axis = sec_axis(~.*coeff, name=\"Nº of cases\")\n      ) +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme_bw() +\n      theme(\n            axis.title.y = element_text(color = temperatureColor, size=13),\n            axis.title.y.right = element_text(color = priceColor, size=13)\n      ) +\n      ggtitle(\"Visits to residential places vs number of cases\")\n\n\n\n\n\n\nretail and recreation\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line(aes(y = mob_retail_recreation, color = provincia)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Visits to retail and recreation places by Province\",\n           x =\"Date\", y = \"Flujo (% ref day)\") +\n      theme_bw()\n\n\n\n\n\n# Value used to transform the data\ncoeff <- 50\n\n# A few constants for colors\ntemperatureColor <- \"#ff9e81\"\npriceColor <- rgb(0.2, 0.6, 0.9, 1)\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line( aes(y = mob_grocery_pharmacy), size=1, color=temperatureColor) + \n      geom_line( aes(y = num_casos / coeff), size=1, color=priceColor) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      scale_y_continuous(\n            # Features of the first axis\n            name = \"Visits to retail and recreation places (%)\",\n            # Add a second axis and specify its features\n            sec.axis = sec_axis(~.*coeff, name=\"Nº of cases\")\n      ) +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme_bw() +\n      theme(\n            axis.title.y = element_text(color = temperatureColor, size=13),\n            axis.title.y.right = element_text(color = priceColor, size=13)\n      ) +\n      ggtitle(\"Visits to retail and recreation places vs number of cases\")\n\n\n\n\n\n\ntransit stations\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line(aes(y = mob_transit_stations, color = provincia)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Visits to trahsit stations by Province\",\n           x =\"Date\", y = \"Flujo (% ref day)\") +\n      theme_bw()\n\n\n\n\n\n# Value used to transform the data\ncoeff <- 50\n\n# A few constants for colors\ntemperatureColor <- \"#ff9e81\"\npriceColor <- rgb(0.2, 0.6, 0.9, 1)\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line( aes(y = mob_transit_stations), size=1, color=temperatureColor) + \n      geom_line( aes(y = num_casos / coeff), size=1, color=priceColor) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      scale_y_continuous(\n            # Features of the first axis\n            name = \"Visits to transit stations (%)\",\n            # Add a second axis and specify its features\n            sec.axis = sec_axis(~.*coeff, name=\"Nº of cases\")\n      ) +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme_bw() +\n      theme(\n            axis.title.y = element_text(color = temperatureColor, size=13),\n            axis.title.y.right = element_text(color = priceColor, size=13)\n      ) +\n      ggtitle(\"Visits to transit stations vs number of cases\")\n\n\n\n\n\n\nworkplaces\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line(aes(y = mob_workplaces, color = provincia)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Visits to workplaces by Province\",\n           x =\"Date\", y = \"Flujo (% ref day)\") +\n      theme_bw()\n\n\n\n\n\n# Value used to transform the data\ncoeff <- 50\n\n# A few constants for colors\ntemperatureColor <- \"#ff9e81\"\npriceColor <- rgb(0.2, 0.6, 0.9, 1)\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line( aes(y = mob_transit_stations), size=1, color=temperatureColor) + \n      geom_line( aes(y = num_casos / coeff), size=1, color=priceColor) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      scale_y_continuous(\n            # Features of the first axis\n            name = \"Visits to workplaces (%)\",\n            # Add a second axis and specify its features\n            sec.axis = sec_axis(~.*coeff, name=\"Nº of cases\")\n      ) +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme_bw() +\n      theme(\n            axis.title.y = element_text(color = temperatureColor, size=13),\n            axis.title.y.right = element_text(color = priceColor, size=13)\n      ) +\n      ggtitle(\"Visits to workplaces vs number of cases\")\n\n\n\n\n\n\nGoogle mobility vs cases\n\n# Value used to transform the data\ncoeff <- 300\n\n# A few constants for colors\npriceColor <- rgb(0.2, 0.6, 0.9, 1)\n\np <- covid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line(aes(x = fecha, y = mob_grocery_pharmacy, color = \"red\")) +\n      geom_line(aes(x = fecha, y = mob_parks, color = \"black\")) +\n      geom_line(aes(x = fecha, y = mob_residential, color = \"blue\")) +\n      geom_line(aes(x = fecha, y = mob_retail_recreation, color = \"green\")) +\n      geom_line(aes(x = fecha, y = mob_transit_stations, color = \"brown\")) +\n      geom_line(aes(x = fecha, y = mob_workplaces, color = \"yellow\")) +\n      geom_line( aes(y = num_casos / coeff), size=1, color=priceColor) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      scale_y_continuous(\n            # Features of the first axis\n            name = \"Mobility variations (% ref day)\",\n            # Add a second axis and specify its features\n            sec.axis = sec_axis(~.*coeff, name=\"Nº of cases\")\n      ) +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme_bw() +\n      theme(\n            axis.title.y = element_text(size=13),\n            axis.title.y.right = element_text(color = priceColor, size=13),\n            legend.position = \"none\") +\n      ggtitle(\"Mobility variations vs number of cases\")\n\np\n\n\n\n# ggplotly(p) # To make the graph interactive\n\n\n\nGeneral mobility (INE study zones)\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line(aes(y = mob_flujo, color = provincia)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"General mobility by Province\",\n           x =\"Date\", y = \"Mobility (% ref day)\") +\n      theme_bw()\n\n\n\n\n\n# Value used to transform the data\ncoeff <- 200\n\n# A few constants for colors\ntemperatureColor <- \"#ff9e81\"\npriceColor <- rgb(0.2, 0.6, 0.9, 1)\n\ncovid_data %>% \n      ggplot(aes(x = fecha)) +\n      geom_line( aes(y = mob_flujo), size=1, color=temperatureColor) + \n      geom_line( aes(y = num_casos / coeff), size=1, color=priceColor) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      scale_y_continuous(\n            # Features of the first axis\n            name = \"General mobility (%)\",\n            # Add a second axis and specify its features\n            sec.axis = sec_axis(~.*coeff, name=\"Nº of cases\")\n      ) +\n      facet_wrap(~provincia, scales = \"free_y\", ncol=1) +\n      theme_bw() +\n      theme(\n            axis.title.y = element_text(color = temperatureColor, size=13),\n            axis.title.y.right = element_text(color = priceColor, size=13)\n      ) +\n      ggtitle(\"General mobility vs number of cases\")"
  },
  {
    "objectID": "visual.html#correlations",
    "href": "visual.html#correlations",
    "title": "Task 3: Visual analysis",
    "section": "Correlations",
    "text": "Correlations\nFrom previous visual analysis, we will focus our attention in the following variables:\n\nnum_casos\nnum_hosp\ntmed\nmob_grocery_pharmacy\nmob_parks\nmob_residential\nmob_retail_recreation\nmob_transit_stations\nmob_workplaces\nmob_flujo\n\n\nAsturias\n\ndata_asturias <- covid_data %>% \n      filter(provincia == \"Asturias\") %>% \n      select(num_casos, num_hosp, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      drop_na()\n\nchart.Correlation(data_asturias, histogram=TRUE, pch=19)\n\n\n\n\n\n\nBarcelona\n\ndata_barcelona <- covid_data %>% \n      filter(provincia == \"Barcelona\") %>% \n      select(num_casos, num_hosp, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      drop_na()\n\nchart.Correlation(data_barcelona, histogram=TRUE, pch=19)\n\n\n\n\n\n\nMadrid\n\ndata_madrid <- covid_data %>% \n      filter(provincia == \"Madrid\") %>% \n      select(num_casos, num_hosp, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      drop_na()\n\nchart.Correlation(data_madrid, histogram=TRUE, pch=19)\n\n\n\n\n\n\nMálaga\n\ndata_malaga <- covid_data %>% \n      filter(provincia == \"Málaga\") %>% \n      select(num_casos, num_hosp, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      drop_na()\n\nchart.Correlation(data_malaga, histogram=TRUE, pch=19)\n\n\n\n\n\n\nSevilla\n\ndata_sevilla <- covid_data %>% \n      filter(provincia == \"Sevilla\") %>% \n      select(num_casos, num_hosp, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      drop_na()\n\nchart.Correlation(data_sevilla, histogram=TRUE, pch=19)"
  },
  {
    "objectID": "visual.html#pca-analysis",
    "href": "visual.html#pca-analysis",
    "title": "Task 3: Visual analysis",
    "section": "PCA Analysis",
    "text": "PCA Analysis\n\nAsturias\n\npca_asturias <- prcomp(data_asturias, scale = TRUE)\npca_asturias\n\nStandard deviations (1, .., p=10):\n [1] 2.3059001 1.3226315 1.0074444 0.7450691 0.6877792 0.6487611 0.4720477\n [8] 0.3739715 0.2771883 0.1730609\n\nRotation (n x k) = (10 x 10):\n                              PC1         PC2         PC3          PC4\nnum_casos              0.01450525  0.54489655 -0.51479322 -0.504451200\nnum_hosp               0.17409928  0.48500003 -0.37126430  0.690242359\ntmed                  -0.23699079 -0.37307749 -0.45271462  0.180603004\nmob_grocery_pharmacy  -0.35143243  0.28170300  0.11727970  0.126424273\nmob_parks             -0.35125168 -0.17159147 -0.38598591 -0.009257317\nmob_residential        0.41391323 -0.10601760 -0.11975556  0.054838852\nmob_retail_recreation -0.41354502  0.01666112 -0.02232460 -0.211710973\nmob_transit_stations  -0.37337796  0.24040335  0.05162636 -0.093305650\nmob_workplaces        -0.30382828  0.27686746  0.41962650  0.287377141\nmob_flujo             -0.30391699 -0.27186212 -0.18939142  0.285110210\n                               PC5         PC6         PC7          PC8\nnum_casos              0.007707022 -0.39838507  0.05559284 -0.036405423\nnum_hosp               0.027047134  0.16172768 -0.17598501  0.008142094\ntmed                  -0.642379737 -0.18881088  0.25498953  0.215754643\nmob_grocery_pharmacy   0.158062302  0.20143454  0.82468490 -0.057629741\nmob_parks              0.059354627  0.41906472 -0.19336176 -0.582750644\nmob_residential        0.136078986  0.07056199  0.29416933  0.118367813\nmob_retail_recreation  0.151941611  0.03708067 -0.07486246 -0.043270088\nmob_transit_stations  -0.084870133  0.37541715 -0.26001692  0.682427007\nmob_workplaces        -0.299536399 -0.45193891 -0.13878486 -0.273372087\nmob_flujo              0.647705124 -0.46016524 -0.06644608  0.229818685\n                              PC9         PC10\nnum_casos             -0.14106177 -0.017603053\nnum_hosp               0.24578351  0.043113614\ntmed                   0.08461699 -0.007038261\nmob_grocery_pharmacy  -0.06341817  0.119971853\nmob_parks             -0.34415326 -0.153430890\nmob_residential       -0.13120769 -0.811682780\nmob_retail_recreation  0.79014122 -0.356541626\nmob_transit_stations  -0.28731159 -0.165588538\nmob_workplaces        -0.19739302 -0.381355987\nmob_flujo             -0.16437188  0.032321955\n\n\n\nsummary(pca_asturias)\n\nImportance of components:\n                          PC1    PC2    PC3     PC4    PC5     PC6     PC7\nStandard deviation     2.3059 1.3226 1.0074 0.74507 0.6878 0.64876 0.47205\nProportion of Variance 0.5317 0.1749 0.1015 0.05551 0.0473 0.04209 0.02228\nCumulative Proportion  0.5317 0.7067 0.8082 0.86366 0.9110 0.95305 0.97534\n                           PC8     PC9   PC10\nStandard deviation     0.37397 0.27719 0.1731\nProportion of Variance 0.01399 0.00768 0.0030\nCumulative Proportion  0.98932 0.99700 1.0000\n\n\n\nfviz_contrib(pca_asturias, choice = \"var\", axes = 1)\n\n\n\n\n\nfviz_contrib(pca_asturias, choice = \"var\", axes = 2)\n\n\n\n\n\nfviz_contrib(pca_asturias, choice = \"var\", axes = 3)\n\n\n\n\n\n\nBarcelona\n\npca_barcelona <- prcomp(data_barcelona, scale = TRUE)\npca_barcelona\n\nStandard deviations (1, .., p=10):\n [1] 2.3500494 1.1639307 1.0203223 0.8907862 0.7077661 0.5991284 0.4632802\n [8] 0.3564024 0.2192014 0.1959267\n\nRotation (n x k) = (10 x 10):\n                              PC1          PC2         PC3          PC4\nnum_casos             -0.04635023  0.570768442  0.53457698 -0.492988960\nnum_hosp               0.29831071  0.284686532  0.09436374 -0.034833462\ntmed                  -0.14449540 -0.626623503  0.30664954 -0.452229899\nmob_grocery_pharmacy  -0.34713681  0.337004339  0.02002121  0.151561449\nmob_parks             -0.37335503 -0.193131167  0.18530647 -0.084926570\nmob_residential        0.38430706  0.007416082  0.24886368  0.259624192\nmob_retail_recreation -0.39452627  0.063798737  0.18765830  0.069063116\nmob_transit_stations  -0.40897022  0.127987718 -0.07637794  0.004222074\nmob_workplaces        -0.30468032  0.155504866 -0.55283186 -0.129464416\nmob_flujo             -0.25427521 -0.070430679  0.40981000  0.657343094\n                              PC5         PC6         PC7          PC8\nnum_casos              0.19339495  0.32350158 -0.00629119  0.030606330\nnum_hosp              -0.85463757 -0.17161237 -0.22533531  0.094962761\ntmed                  -0.33093566  0.09231281  0.39889639 -0.006104091\nmob_grocery_pharmacy  -0.08132938 -0.39493763  0.65121038  0.249245145\nmob_parks              0.08850418 -0.27365929 -0.49626105  0.644319123\nmob_residential        0.14832065 -0.12032335  0.28408811  0.321039366\nmob_retail_recreation -0.07064019 -0.29899673 -0.08915710 -0.584504519\nmob_transit_stations  -0.06330964 -0.11946594 -0.12154825 -0.072176343\nmob_workplaces        -0.20404108  0.48022022  0.12291337  0.248375683\nmob_flujo             -0.18867227  0.52701879 -0.03434211  0.033557108\n                               PC9        PC10\nnum_casos             -0.002320569  0.01509282\nnum_hosp               0.003777920  0.01349170\ntmed                  -0.092334422  0.04687160\nmob_grocery_pharmacy   0.134095696 -0.27528609\nmob_parks              0.182419504  0.06583257\nmob_residential       -0.196882515  0.68110459\nmob_retail_recreation  0.329721528  0.49758768\nmob_transit_stations  -0.875118234  0.08009707\nmob_workplaces         0.163742743  0.42982550\nmob_flujo              0.008575829 -0.12089009\n\n\n\nsummary(pca_barcelona)\n\nImportance of components:\n                          PC1    PC2    PC3     PC4     PC5    PC6     PC7\nStandard deviation     2.3500 1.1639 1.0203 0.89079 0.70777 0.5991 0.46328\nProportion of Variance 0.5523 0.1355 0.1041 0.07935 0.05009 0.0359 0.02146\nCumulative Proportion  0.5523 0.6877 0.7919 0.87120 0.92130 0.9572 0.97865\n                          PC8    PC9    PC10\nStandard deviation     0.3564 0.2192 0.19593\nProportion of Variance 0.0127 0.0048 0.00384\nCumulative Proportion  0.9914 0.9962 1.00000\n\n\n\nfviz_contrib(pca_barcelona, choice = \"var\", axes = 1)\n\n\n\n\n\nfviz_contrib(pca_barcelona, choice = \"var\", axes = 2)\n\n\n\n\n\nfviz_contrib(pca_barcelona, choice = \"var\", axes = 3)\n\n\n\n\n\n\nMadrid\n\npca_madrid <- prcomp(data_madrid, scale = TRUE)\npca_madrid\n\nStandard deviations (1, .., p=10):\n [1] 2.2848571 1.2225837 1.0319540 0.9173293 0.7538326 0.6158312 0.4456798\n [8] 0.3743592 0.2529196 0.1674507\n\nRotation (n x k) = (10 x 10):\n                              PC1        PC2         PC3         PC4\nnum_casos             -0.01423162  0.5854425  0.06882652 -0.70306268\nnum_hosp               0.27600601  0.3157810  0.06783645 -0.12215647\ntmed                  -0.06116377 -0.6156756 -0.18467058 -0.61357270\nmob_grocery_pharmacy  -0.37932123  0.2832513 -0.04936637  0.05230846\nmob_parks             -0.36244379 -0.1197542 -0.28139926 -0.13467682\nmob_residential        0.37894331  0.1601416 -0.35460347  0.16002713\nmob_retail_recreation -0.40910449  0.1516826 -0.11182971 -0.05493973\nmob_transit_stations  -0.41730212  0.1056251  0.08377947  0.08242167\nmob_workplaces        -0.30627182 -0.0855751  0.59690452  0.12801981\nmob_flujo             -0.25635724  0.1295295 -0.61104157  0.20402385\n                              PC5         PC6         PC7          PC8\nnum_casos              0.24552109 -0.26345562  0.15328157 -0.040875827\nnum_hosp              -0.83725304  0.30701841  0.09072498 -0.004431129\ntmed                  -0.25238790 -0.12186856 -0.28247772 -0.112257979\nmob_grocery_pharmacy  -0.04343098  0.12704931 -0.62858714 -0.502353135\nmob_parks              0.09156988  0.51766298  0.59572642 -0.336804286\nmob_residential        0.14343571  0.06769104 -0.09643941 -0.444183532\nmob_retail_recreation -0.03488279  0.25135710 -0.16413678  0.371254042\nmob_transit_stations  -0.05857713  0.08498906 -0.07417955  0.302309594\nmob_workplaces        -0.20465773 -0.32418049  0.23925417 -0.438932910\nmob_flujo             -0.31248859 -0.59773222  0.19870007  0.027020637\n                              PC9        PC10\nnum_casos              0.04735181 -0.03037372\nnum_hosp               0.02858333  0.01607570\ntmed                   0.09549151 -0.16297889\nmob_grocery_pharmacy  -0.02709125  0.32321617\nmob_parks              0.03477439  0.10523166\nmob_residential        0.17235888 -0.64648380\nmob_retail_recreation -0.54936170 -0.51296756\nmob_transit_stations   0.79984701 -0.23148779\nmob_workplaces        -0.11524111 -0.34062802\nmob_flujo             -0.03656999  0.07761072\n\n\n\nsummary(pca_madrid)\n\nImportance of components:\n                          PC1    PC2    PC3     PC4     PC5     PC6     PC7\nStandard deviation     2.2849 1.2226 1.0320 0.91733 0.75383 0.61583 0.44568\nProportion of Variance 0.5221 0.1495 0.1065 0.08415 0.05683 0.03792 0.01986\nCumulative Proportion  0.5221 0.6715 0.7780 0.86217 0.91900 0.95692 0.97678\n                           PC8    PC9   PC10\nStandard deviation     0.37436 0.2529 0.1675\nProportion of Variance 0.01401 0.0064 0.0028\nCumulative Proportion  0.99080 0.9972 1.0000\n\n\n\nfviz_contrib(pca_madrid, choice = \"var\", axes = 1)\n\n\n\n\n\nfviz_contrib(pca_madrid, choice = \"var\", axes = 2)\n\n\n\n\n\nfviz_contrib(pca_madrid, choice = \"var\", axes = 3)\n\n\n\n\n\n\nMálaga\n\npca_malaga <- prcomp(data_malaga, scale = TRUE)\npca_malaga\n\nStandard deviations (1, .., p=10):\n [1] 2.3625399 1.3170000 1.0383164 0.7852519 0.5772466 0.5206302 0.4750268\n [8] 0.3038546 0.2083302 0.1534463\n\nRotation (n x k) = (10 x 10):\n                              PC1          PC2         PC3         PC4\nnum_casos              0.05640851 -0.681859025 -0.17666101 -0.09250740\nnum_hosp              -0.09690841 -0.658078771 -0.17277530  0.16446076\ntmed                   0.22890688  0.259779290 -0.56344513  0.55423432\nmob_grocery_pharmacy   0.34728178 -0.131977546  0.28371284  0.29107154\nmob_parks              0.35909430  0.005032765 -0.42497959  0.05859394\nmob_residential       -0.39614334  0.017773316 -0.22433143 -0.03168938\nmob_retail_recreation  0.40839431 -0.035478728 -0.08152322 -0.13149072\nmob_transit_stations   0.39978838 -0.069319821  0.02511553 -0.12354574\nmob_workplaces         0.32225403 -0.057296167  0.51953797  0.24431420\nmob_flujo              0.31317929  0.086076717 -0.18123857 -0.68979451\n                             PC5         PC6         PC7          PC8\nnum_casos              0.2756412  0.63420561 -0.10354687  0.005289358\nnum_hosp              -0.4952974 -0.48305689  0.09110537 -0.048777062\ntmed                  -0.2695582  0.28397212 -0.17222092 -0.243272004\nmob_grocery_pharmacy   0.2253090 -0.26286323 -0.72540811  0.169909262\nmob_parks              0.2140875 -0.22819442  0.28231647  0.533739477\nmob_residential        0.1275766 -0.18007259 -0.37864503 -0.221293686\nmob_retail_recreation  0.2195409 -0.15605362  0.13333421 -0.040363776\nmob_transit_stations   0.2150227 -0.20170555  0.16010907 -0.753933044\nmob_workplaces        -0.4019800  0.24819776  0.15745543  0.024861931\nmob_flujo             -0.4869769  0.05969278 -0.36581567  0.070931556\n                              PC9         PC10\nnum_casos             -0.05523726 -0.011121973\nnum_hosp               0.10487794  0.017325549\ntmed                   0.11543780  0.001126233\nmob_grocery_pharmacy   0.04287048  0.141338298\nmob_parks             -0.47215118  0.039645398\nmob_residential       -0.48214317 -0.563842923\nmob_retail_recreation  0.52031692 -0.667331724\nmob_transit_stations  -0.27513488  0.250600567\nmob_workplaces        -0.40536315 -0.387737889\nmob_flujo             -0.06818165  0.040432668\n\n\n\nsummary(pca_malaga)\n\nImportance of components:\n                          PC1    PC2    PC3     PC4     PC5     PC6     PC7\nStandard deviation     2.3625 1.3170 1.0383 0.78525 0.57725 0.52063 0.47503\nProportion of Variance 0.5582 0.1734 0.1078 0.06166 0.03332 0.02711 0.02257\nCumulative Proportion  0.5582 0.7316 0.8394 0.90108 0.93440 0.96151 0.98407\n                           PC8     PC9    PC10\nStandard deviation     0.30385 0.20833 0.15345\nProportion of Variance 0.00923 0.00434 0.00235\nCumulative Proportion  0.99331 0.99765 1.00000\n\n\n\nfviz_contrib(pca_malaga, choice = \"var\", axes = 1)\n\n\n\n\n\nfviz_contrib(pca_malaga, choice = \"var\", axes = 2)\n\n\n\n\n\nfviz_contrib(pca_malaga, choice = \"var\", axes = 3)\n\n\n\n\n\n\nSevilla\n\npca_sevilla <- prcomp(data_sevilla, scale = TRUE)\npca_sevilla\n\nStandard deviations (1, .., p=10):\n [1] 2.2395871 1.3711914 0.9994651 0.9475874 0.6410011 0.5879385 0.5022399\n [8] 0.3201419 0.2436278 0.1912779\n\nRotation (n x k) = (10 x 10):\n                              PC1         PC2         PC3         PC4\nnum_casos              0.08150241 -0.58491283 -0.32912474 -0.26142419\nnum_hosp              -0.05238738 -0.61727951 -0.20123857 -0.25246638\ntmed                   0.04340192  0.44954399 -0.37052661 -0.70337586\nmob_grocery_pharmacy   0.37471247 -0.17820546  0.20885536  0.11256921\nmob_parks              0.37846238  0.07404912 -0.27887505  0.20297070\nmob_residential       -0.38959386 -0.11207374 -0.17372402  0.37740454\nmob_retail_recreation  0.42745656  0.01046447 -0.13781739  0.07017732\nmob_transit_stations   0.42845576 -0.05429597  0.07728593  0.09157181\nmob_workplaces         0.32651982 -0.07895759  0.51088635 -0.26966048\nmob_flujo              0.28353831  0.12514136 -0.52568667  0.30141396\n                              PC5         PC6          PC7         PC8\nnum_casos              0.25454148 -0.55590034 -0.261315069 -0.17160037\nnum_hosp              -0.29573128  0.59804282  0.197472850  0.15887408\ntmed                   0.03580312  0.01145557  0.309171717 -0.11350514\nmob_grocery_pharmacy   0.11251170 -0.20047756  0.782393836 -0.20791456\nmob_parks              0.26315130  0.46435105 -0.240775428 -0.61074831\nmob_residential       -0.01775795 -0.01133979  0.288160020 -0.31538551\nmob_retail_recreation  0.23710247  0.05163810  0.042042006  0.35950174\nmob_transit_stations   0.14290967  0.08444293 -0.061462646  0.37786984\nmob_workplaces        -0.48480812 -0.04475291 -0.196033741 -0.37384477\nmob_flujo             -0.67273121 -0.25582555  0.002867798  0.07022755\n                              PC9        PC10\nnum_casos              0.05322578 -0.01366919\nnum_hosp              -0.04927077 -0.01445777\ntmed                   0.23212479  0.01527527\nmob_grocery_pharmacy  -0.19087770 -0.16397555\nmob_parks             -0.07909801 -0.10100128\nmob_residential        0.59848164  0.34916107\nmob_retail_recreation -0.07771608  0.77286480\nmob_transit_stations   0.69152383 -0.38314075\nmob_workplaces         0.22610807  0.29508158\nmob_flujo             -0.06794530 -0.09580252\n\n\n\nsummary(pca_sevilla)\n\nImportance of components:\n                          PC1    PC2     PC3     PC4     PC5     PC6     PC7\nStandard deviation     2.2396 1.3712 0.99947 0.94759 0.64100 0.58794 0.50224\nProportion of Variance 0.5016 0.1880 0.09989 0.08979 0.04109 0.03457 0.02522\nCumulative Proportion  0.5016 0.6896 0.78948 0.87928 0.92037 0.95493 0.98016\n                           PC8     PC9    PC10\nStandard deviation     0.32014 0.24363 0.19128\nProportion of Variance 0.01025 0.00594 0.00366\nCumulative Proportion  0.99041 0.99634 1.00000\n\n\n\nfviz_contrib(pca_sevilla, choice = \"var\", axes = 1)\n\n\n\n\n\nfviz_contrib(pca_sevilla, choice = \"var\", axes = 2)\n\n\n\n\n\nfviz_contrib(pca_sevilla, choice = \"var\", axes = 3)"
  },
  {
    "objectID": "visual_demo.html",
    "href": "visual_demo.html",
    "title": "Task 4: Visual demographic analysis",
    "section": "",
    "text": "As previously mentioned, the visual analysis will focus on the following provinces:\n\nAsturias\nBarcelona\nMadrid\nMálaga\nSevilla\n\nFirst, we need to load packages and clean data generated during previous tasks:\n\npacman::p_load(\n      here,      # file locator\n      tidyverse, # data management and ggplot2 graphics\n      skimr,     # get overview of data\n      janitor,   # produce and adorn tabulations and cross-tabulations\n      lubridate, # manage dates\n      PerformanceAnalytics,\n      factoextra,\n      tsibble,\n      ggfortify\n)\n\nhosp_data <- readRDS(here(\"data\", \"clean\", \"final_hosp_data.rds\"))\nhosp_data\n\n# A tibble: 122,850 × 8\n   provincia sexo  grupo_edad fecha      num_casos num_hosp num_uci num_def\n   <chr>     <chr> <chr>      <date>         <dbl>    <dbl>   <dbl>   <dbl>\n 1 Barcelona H     0-9        2020-01-01         0        0       0       0\n 2 Barcelona H     10-19      2020-01-01         0        0       0       0\n 3 Barcelona H     20-29      2020-01-01         0        0       0       0\n 4 Barcelona H     30-39      2020-01-01         0        0       0       0\n 5 Barcelona H     40-49      2020-01-01         0        0       0       0\n 6 Barcelona H     50-59      2020-01-01         0        0       0       0\n 7 Barcelona H     60-69      2020-01-01         0        0       0       0\n 8 Barcelona H     70-79      2020-01-01         0        0       0       0\n 9 Barcelona H     80+        2020-01-01         0        0       0       0\n10 Barcelona H     NC         2020-01-01         0        0       0       0\n# … with 122,840 more rows"
  },
  {
    "objectID": "visual_demo.html#asturias",
    "href": "visual_demo.html#asturias",
    "title": "Task 4: Visual demographic analysis",
    "section": "Asturias",
    "text": "Asturias\n\ndata_asturias <- hosp_data %>% \n      filter(provincia == \"Asturias\") %>% \n      select(-provincia) %>% \n      as_tsibble(index = fecha, key = c(sexo, grupo_edad)) %>% \n      mutate(ola = case_when(\n            fecha < as.Date(\"2020-06-21\", format = \"%Y-%m-%d\") ~ \"1_ola\",\n            fecha < as.Date(\"2020-12-06\", format = \"%Y-%m-%d\") ~ \"2_ola\",\n            fecha < as.Date(\"2021-03-14\", format = \"%Y-%m-%d\") ~ \"3_ola\",\n            fecha < as.Date(\"2021-06-19\", format = \"%Y-%m-%d\") ~ \"4_ola\",\n            fecha < as.Date(\"2021-10-13\", format = \"%Y-%m-%d\") ~ \"5_ola\",\n            TRUE ~ \"6_ola\",\n      ))\ndata_asturias\n\n# A tsibble: 24,570 x 8 [1D]\n# Key:       sexo, grupo_edad [30]\n   sexo  grupo_edad fecha      num_casos num_hosp num_uci num_def ola  \n   <chr> <chr>      <date>         <dbl>    <dbl>   <dbl>   <dbl> <chr>\n 1 H     0-9        2020-01-01         0        0       0       0 1_ola\n 2 H     0-9        2020-01-02         0        0       0       0 1_ola\n 3 H     0-9        2020-01-03         0        0       0       0 1_ola\n 4 H     0-9        2020-01-04         0        0       0       0 1_ola\n 5 H     0-9        2020-01-05         0        0       0       0 1_ola\n 6 H     0-9        2020-01-06         0        0       0       0 1_ola\n 7 H     0-9        2020-01-07         0        0       0       0 1_ola\n 8 H     0-9        2020-01-08         0        0       0       0 1_ola\n 9 H     0-9        2020-01-09         0        0       0       0 1_ola\n10 H     0-9        2020-01-10         0        0       0       0 1_ola\n# … with 24,560 more rows\n\n\n\nby wave\n\ndata_asturias %>% \n      ggplot(aes(x=grupo_edad, y=num_casos)) + \n      geom_boxplot(aes(fill=grupo_edad)) +\n      facet_grid(. ~ ola) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Asturias - Cases reported by wave and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_asturias %>% \n      ggplot(aes(x=grupo_edad, y=num_def)) + \n      geom_boxplot(aes(fill=grupo_edad)) +\n      facet_grid(. ~ ola) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Asturias - Deaths reported by wave and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\n\nby age group\n\ndata_asturias %>% \n      ggplot(aes(x=ola, y=num_casos)) + \n      geom_boxplot(aes(fill=ola)) +\n      facet_grid(. ~ grupo_edad) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Asturias - Cases reported by wave and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_asturias %>% \n      ggplot(aes(x=ola, y=num_def)) + \n      geom_boxplot(aes(fill=ola)) +\n      facet_grid(. ~ grupo_edad) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Asturias - Deaths reported by wave and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_asturias %>% \n      ggplot(aes(x=fecha, y=num_casos)) +\n      geom_line(aes(color=grupo_edad)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~sexo, ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Asturias - Cases reported by age group and wave\",\n           x =\"Date\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\n\nby sex\n\ndata_asturias %>% \n      ggplot(aes(x=ola, y=num_casos)) + \n      geom_boxplot(aes(fill=ola)) +\n      facet_grid(. ~ sexo) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Asturias - Cases reported by sex and wave\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_asturias %>% \n      ggplot(aes(x=ola, y=num_def)) + \n      geom_boxplot(aes(fill=ola)) +\n      facet_grid(. ~ sexo) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Asturias - Deaths reported by sex and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_asturias %>% \n      ggplot(aes(x=fecha, y=num_casos)) +\n      geom_line(aes(color=sexo)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~grupo_edad, scales = \"free_y\", ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Asturias - Cases reported by sex and age group (free y axis)\",\n           x =\"Date\", y = \"Nº of cases\") +\n      theme_bw()"
  },
  {
    "objectID": "visual_demo.html#barcelona",
    "href": "visual_demo.html#barcelona",
    "title": "Task 4: Visual demographic analysis",
    "section": "Barcelona",
    "text": "Barcelona\n\ndata_Barcelona <- hosp_data %>% \n      filter(provincia == \"Barcelona\") %>% \n      select(-provincia) %>% \n      as_tsibble(index = fecha, key = c(sexo, grupo_edad)) %>% \n      mutate(ola = case_when(\n            fecha < as.Date(\"2020-06-21\", format = \"%Y-%m-%d\") ~ \"1_ola\",\n            fecha < as.Date(\"2020-12-06\", format = \"%Y-%m-%d\") ~ \"2_ola\",\n            fecha < as.Date(\"2021-03-14\", format = \"%Y-%m-%d\") ~ \"3_ola\",\n            fecha < as.Date(\"2021-06-19\", format = \"%Y-%m-%d\") ~ \"4_ola\",\n            fecha < as.Date(\"2021-10-13\", format = \"%Y-%m-%d\") ~ \"5_ola\",\n            TRUE ~ \"6_ola\",\n      ))\ndata_Barcelona\n\n# A tsibble: 24,570 x 8 [1D]\n# Key:       sexo, grupo_edad [30]\n   sexo  grupo_edad fecha      num_casos num_hosp num_uci num_def ola  \n   <chr> <chr>      <date>         <dbl>    <dbl>   <dbl>   <dbl> <chr>\n 1 H     0-9        2020-01-01         0        0       0       0 1_ola\n 2 H     0-9        2020-01-02         0        0       0       0 1_ola\n 3 H     0-9        2020-01-03         0        0       0       0 1_ola\n 4 H     0-9        2020-01-04         0        0       0       0 1_ola\n 5 H     0-9        2020-01-05         0        0       0       0 1_ola\n 6 H     0-9        2020-01-06         0        0       0       0 1_ola\n 7 H     0-9        2020-01-07         0        0       0       0 1_ola\n 8 H     0-9        2020-01-08         0        0       0       0 1_ola\n 9 H     0-9        2020-01-09         0        0       0       0 1_ola\n10 H     0-9        2020-01-10         1        0       0       0 1_ola\n# … with 24,560 more rows\n\n\n\nby wave\n\ndata_Barcelona %>% \n      ggplot(aes(x=grupo_edad, y=num_casos)) + \n      geom_boxplot(aes(fill=grupo_edad)) +\n      facet_grid(. ~ ola) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Barcelona - Cases reported by wave and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_Barcelona %>% \n      ggplot(aes(x=grupo_edad, y=num_def)) + \n      geom_boxplot(aes(fill=grupo_edad)) +\n      facet_grid(. ~ ola) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Barcelona - Deaths reported by wave and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\n\nby age group\n\ndata_Barcelona %>% \n      ggplot(aes(x=ola, y=num_casos)) + \n      geom_boxplot(aes(fill=ola)) +\n      facet_grid(. ~ grupo_edad) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Barcelona - Cases reported by wave and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_Barcelona %>% \n      ggplot(aes(x=ola, y=num_def)) + \n      geom_boxplot(aes(fill=ola)) +\n      facet_grid(. ~ grupo_edad) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Barcelona - Deaths reported by wave and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_Barcelona %>% \n      ggplot(aes(x=fecha, y=num_casos)) +\n      geom_line(aes(color=grupo_edad)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~sexo, ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Barcelona - Cases reported by age group and wave\",\n           x =\"Date\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\n\nby sex\n\ndata_Barcelona %>% \n      ggplot(aes(x=ola, y=num_casos)) + \n      geom_boxplot(aes(fill=ola)) +\n      facet_grid(. ~ sexo) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Barcelona - Cases reported by sex and wave\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_Barcelona %>% \n      ggplot(aes(x=ola, y=num_def)) + \n      geom_boxplot(aes(fill=ola)) +\n      facet_grid(. ~ sexo) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Barcelona - Deaths reported by sex and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_Barcelona %>% \n      ggplot(aes(x=fecha, y=num_casos)) +\n      geom_line(aes(color=sexo)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~grupo_edad, scales = \"free_y\", ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Barcelona - Cases reported by sex and age group (free y axis)\",\n           x =\"Date\", y = \"Nº of cases\") +\n      theme_bw()"
  },
  {
    "objectID": "visual_demo.html#madrid",
    "href": "visual_demo.html#madrid",
    "title": "Task 4: Visual demographic analysis",
    "section": "Madrid",
    "text": "Madrid\n\ndata_Madrid <- hosp_data %>% \n      filter(provincia == \"Madrid\") %>% \n      select(-provincia) %>% \n      as_tsibble(index = fecha, key = c(sexo, grupo_edad)) %>% \n      mutate(ola = case_when(\n            fecha < as.Date(\"2020-06-21\", format = \"%Y-%m-%d\") ~ \"1_ola\",\n            fecha < as.Date(\"2020-12-06\", format = \"%Y-%m-%d\") ~ \"2_ola\",\n            fecha < as.Date(\"2021-03-14\", format = \"%Y-%m-%d\") ~ \"3_ola\",\n            fecha < as.Date(\"2021-06-19\", format = \"%Y-%m-%d\") ~ \"4_ola\",\n            fecha < as.Date(\"2021-10-13\", format = \"%Y-%m-%d\") ~ \"5_ola\",\n            TRUE ~ \"6_ola\",\n      ))\ndata_Madrid\n\n# A tsibble: 24,570 x 8 [1D]\n# Key:       sexo, grupo_edad [30]\n   sexo  grupo_edad fecha      num_casos num_hosp num_uci num_def ola  \n   <chr> <chr>      <date>         <dbl>    <dbl>   <dbl>   <dbl> <chr>\n 1 H     0-9        2020-01-01         0        0       0       0 1_ola\n 2 H     0-9        2020-01-02         0        1       1       0 1_ola\n 3 H     0-9        2020-01-03         0        0       0       0 1_ola\n 4 H     0-9        2020-01-04         0        0       0       0 1_ola\n 5 H     0-9        2020-01-05         0        0       0       0 1_ola\n 6 H     0-9        2020-01-06         0        0       0       0 1_ola\n 7 H     0-9        2020-01-07         0        0       0       0 1_ola\n 8 H     0-9        2020-01-08         0        0       0       0 1_ola\n 9 H     0-9        2020-01-09         0        0       0       0 1_ola\n10 H     0-9        2020-01-10         0        0       0       0 1_ola\n# … with 24,560 more rows\n\n\n\nby wave\n\ndata_Madrid %>% \n      ggplot(aes(x=grupo_edad, y=num_casos)) + \n      geom_boxplot(aes(fill=grupo_edad)) +\n      facet_grid(. ~ ola) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Madrid - Cases reported by wave and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_Madrid %>% \n      ggplot(aes(x=grupo_edad, y=num_def)) + \n      geom_boxplot(aes(fill=grupo_edad)) +\n      facet_grid(. ~ ola) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Madrid - Deaths reported by wave and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\n\nby age group\n\ndata_Madrid %>% \n      ggplot(aes(x=ola, y=num_casos)) + \n      geom_boxplot(aes(fill=ola)) +\n      facet_grid(. ~ grupo_edad) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Madrid - Cases reported by wave and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_Madrid %>% \n      ggplot(aes(x=ola, y=num_def)) + \n      geom_boxplot(aes(fill=ola)) +\n      facet_grid(. ~ grupo_edad) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Madrid - Deaths reported by wave and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_Madrid %>% \n      ggplot(aes(x=fecha, y=num_casos)) +\n      geom_line(aes(color=grupo_edad)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~sexo, ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Madrid - Cases reported by age group and wave\",\n           x =\"Date\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\n\nby sex\n\ndata_Madrid %>% \n      ggplot(aes(x=ola, y=num_casos)) + \n      geom_boxplot(aes(fill=ola)) +\n      facet_grid(. ~ sexo) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Madrid - Cases reported by sex and wave\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_Madrid %>% \n      ggplot(aes(x=ola, y=num_def)) + \n      geom_boxplot(aes(fill=ola)) +\n      facet_grid(. ~ sexo) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Madrid - Deaths reported by sex and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_Madrid %>% \n      ggplot(aes(x=fecha, y=num_casos)) +\n      geom_line(aes(color=sexo)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~grupo_edad, scales = \"free_y\", ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Madrid - Cases reported by sex and age group (free y axis)\",\n           x =\"Date\", y = \"Nº of cases\") +\n      theme_bw()"
  },
  {
    "objectID": "visual_demo.html#malaga",
    "href": "visual_demo.html#malaga",
    "title": "Task 4: Visual demographic analysis",
    "section": "Malaga",
    "text": "Malaga\n\ndata_Malaga <- hosp_data %>% \n      filter(provincia == \"Málaga\") %>% \n      select(-provincia) %>% \n      as_tsibble(index = fecha, key = c(sexo, grupo_edad)) %>% \n      mutate(ola = case_when(\n            fecha < as.Date(\"2020-06-21\", format = \"%Y-%m-%d\") ~ \"1_ola\",\n            fecha < as.Date(\"2020-12-06\", format = \"%Y-%m-%d\") ~ \"2_ola\",\n            fecha < as.Date(\"2021-03-14\", format = \"%Y-%m-%d\") ~ \"3_ola\",\n            fecha < as.Date(\"2021-06-19\", format = \"%Y-%m-%d\") ~ \"4_ola\",\n            fecha < as.Date(\"2021-10-13\", format = \"%Y-%m-%d\") ~ \"5_ola\",\n            TRUE ~ \"6_ola\",\n      ))\ndata_Malaga\n\n# A tsibble: 24,570 x 8 [1D]\n# Key:       sexo, grupo_edad [30]\n   sexo  grupo_edad fecha      num_casos num_hosp num_uci num_def ola  \n   <chr> <chr>      <date>         <dbl>    <dbl>   <dbl>   <dbl> <chr>\n 1 H     0-9        2020-01-01         0        0       0       0 1_ola\n 2 H     0-9        2020-01-02         0        0       0       0 1_ola\n 3 H     0-9        2020-01-03         0        0       0       0 1_ola\n 4 H     0-9        2020-01-04         0        0       0       0 1_ola\n 5 H     0-9        2020-01-05         0        0       0       0 1_ola\n 6 H     0-9        2020-01-06         0        0       0       0 1_ola\n 7 H     0-9        2020-01-07         0        0       0       0 1_ola\n 8 H     0-9        2020-01-08         0        0       0       0 1_ola\n 9 H     0-9        2020-01-09         0        0       0       0 1_ola\n10 H     0-9        2020-01-10         0        0       0       0 1_ola\n# … with 24,560 more rows\n\n\n\nby wave\n\ndata_Malaga %>% \n      ggplot(aes(x=grupo_edad, y=num_casos)) + \n      geom_boxplot(aes(fill=grupo_edad)) +\n      facet_grid(. ~ ola) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Malaga - Cases reported by wave and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_Malaga %>% \n      ggplot(aes(x=grupo_edad, y=num_def)) + \n      geom_boxplot(aes(fill=grupo_edad)) +\n      facet_grid(. ~ ola) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Malaga - Deaths reported by wave and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\n\nby age group\n\ndata_Malaga %>% \n      ggplot(aes(x=ola, y=num_casos)) + \n      geom_boxplot(aes(fill=ola)) +\n      facet_grid(. ~ grupo_edad) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Malaga - Cases reported by wave and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_Malaga %>% \n      ggplot(aes(x=ola, y=num_def)) + \n      geom_boxplot(aes(fill=ola)) +\n      facet_grid(. ~ grupo_edad) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Malaga - Deaths reported by wave and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_Malaga %>% \n      ggplot(aes(x=fecha, y=num_casos)) +\n      geom_line(aes(color=grupo_edad)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~sexo, ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Malaga - Cases reported by age group and wave\",\n           x =\"Date\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\n\nby sex\n\ndata_Malaga %>% \n      ggplot(aes(x=ola, y=num_casos)) + \n      geom_boxplot(aes(fill=ola)) +\n      facet_grid(. ~ sexo) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Malaga - Cases reported by sex and wave\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_Malaga %>% \n      ggplot(aes(x=ola, y=num_def)) + \n      geom_boxplot(aes(fill=ola)) +\n      facet_grid(. ~ sexo) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Malaga - Deaths reported by sex and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_Malaga %>% \n      ggplot(aes(x=fecha, y=num_casos)) +\n      geom_line(aes(color=sexo)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~grupo_edad, scales = \"free_y\", ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Malaga - Cases reported by sex and age group (free y axis)\",\n           x =\"Date\", y = \"Nº of cases\") +\n      theme_bw()"
  },
  {
    "objectID": "visual_demo.html#sevilla",
    "href": "visual_demo.html#sevilla",
    "title": "Task 4: Visual demographic analysis",
    "section": "Sevilla",
    "text": "Sevilla\n\ndata_Sevilla <- hosp_data %>% \n      filter(provincia == \"Sevilla\") %>% \n      select(-provincia) %>% \n      as_tsibble(index = fecha, key = c(sexo, grupo_edad)) %>% \n      mutate(ola = case_when(\n            fecha < as.Date(\"2020-06-21\", format = \"%Y-%m-%d\") ~ \"1_ola\",\n            fecha < as.Date(\"2020-12-06\", format = \"%Y-%m-%d\") ~ \"2_ola\",\n            fecha < as.Date(\"2021-03-14\", format = \"%Y-%m-%d\") ~ \"3_ola\",\n            fecha < as.Date(\"2021-06-19\", format = \"%Y-%m-%d\") ~ \"4_ola\",\n            fecha < as.Date(\"2021-10-13\", format = \"%Y-%m-%d\") ~ \"5_ola\",\n            TRUE ~ \"6_ola\",\n      ))\ndata_Sevilla\n\n# A tsibble: 24,570 x 8 [1D]\n# Key:       sexo, grupo_edad [30]\n   sexo  grupo_edad fecha      num_casos num_hosp num_uci num_def ola  \n   <chr> <chr>      <date>         <dbl>    <dbl>   <dbl>   <dbl> <chr>\n 1 H     0-9        2020-01-01         0        0       0       0 1_ola\n 2 H     0-9        2020-01-02         0        0       0       0 1_ola\n 3 H     0-9        2020-01-03         0        0       0       0 1_ola\n 4 H     0-9        2020-01-04         0        0       0       0 1_ola\n 5 H     0-9        2020-01-05         0        0       0       0 1_ola\n 6 H     0-9        2020-01-06         0        0       0       0 1_ola\n 7 H     0-9        2020-01-07         0        0       0       0 1_ola\n 8 H     0-9        2020-01-08         0        0       0       0 1_ola\n 9 H     0-9        2020-01-09         0        0       0       0 1_ola\n10 H     0-9        2020-01-10         0        0       0       0 1_ola\n# … with 24,560 more rows\n\n\n\nby wave\n\ndata_Sevilla %>% \n      ggplot(aes(x=grupo_edad, y=num_casos)) + \n      geom_boxplot(aes(fill=grupo_edad)) +\n      facet_grid(. ~ ola) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Sevilla - Cases reported by wave and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_Sevilla %>% \n      ggplot(aes(x=grupo_edad, y=num_def)) + \n      geom_boxplot(aes(fill=grupo_edad)) +\n      facet_grid(. ~ ola) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Sevilla - Deaths reported by wave and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\n\nby age group\n\ndata_Sevilla %>% \n      ggplot(aes(x=ola, y=num_casos)) + \n      geom_boxplot(aes(fill=ola)) +\n      facet_grid(. ~ grupo_edad) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Sevilla - Cases reported by wave and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_Sevilla %>% \n      ggplot(aes(x=ola, y=num_def)) + \n      geom_boxplot(aes(fill=ola)) +\n      facet_grid(. ~ grupo_edad) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Sevilla - Deaths reported by wave and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_Sevilla %>% \n      ggplot(aes(x=fecha, y=num_casos)) +\n      geom_line(aes(color=grupo_edad)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~sexo, ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Sevilla - Cases reported by age group and wave\",\n           x =\"Date\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\n\nby sex\n\ndata_Sevilla %>% \n      ggplot(aes(x=ola, y=num_casos)) + \n      geom_boxplot(aes(fill=ola)) +\n      facet_grid(. ~ sexo) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Sevilla - Cases reported by sex and wave\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_Sevilla %>% \n      ggplot(aes(x=ola, y=num_def)) + \n      geom_boxplot(aes(fill=ola)) +\n      facet_grid(. ~ sexo) + \n      theme(legend.position = \"top\") +\n      labs(title=\"Sevilla - Deaths reported by sex and age\",\n           x =\"Age group\", y = \"Nº of cases\") +\n      theme_bw()\n\n\n\n\n\ndata_Sevilla %>% \n      ggplot(aes(x=fecha, y=num_casos)) +\n      geom_line(aes(color=sexo)) +\n      geom_vline(xintercept = as.Date(\"2020-06-21\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2020-12-06\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-03-14\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-06-19\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      geom_vline(xintercept = as.Date(\"2021-10-13\", format = \"%Y-%m-%d\"), linetype=\"dashed\") +\n      facet_wrap(~grupo_edad, scales = \"free_y\", ncol=1) +\n      theme(legend.position = \"top\") +\n      labs(title=\"Sevilla - Cases reported by sex and age group (free y axis)\",\n           x =\"Date\", y = \"Nº of cases\") +\n      theme_bw()"
  },
  {
    "objectID": "arima.html",
    "href": "arima.html",
    "title": "Task 5: ARIMA",
    "section": "",
    "text": "In addition to time series regression models and exponential smoothing, ARIMA provides another approach to time series forecasting.\nThe main objective of ARIMA models is to describe the autorrelations in the data, while exponential smoothing aim to describe the trend and seasonality in the data.\nDepending on how statistical properties vary over the time, series can be stationary (not depend on time observed) or non-sationary (those with trends or with seasonality).\nIn general, a stationary time series will have no predictable patterns in the long-term since we cannot be sure where the peaks and troughs of the cycles will be.\nAre covid series stationary?\nFor covid outbreaks, and according to what we have seen in the visual section, the cycles seems aperiodic. They could be caused when the level of infections is out of control and the containment policies in place are not sufficient. Then the implementation of additional policies against the spread of the virus allows the level of infection to decrease again.\nACF plots are useful for identifying what kind of time series we are facing. For a stationary time series, the ACF will drop to zero relatively quickly, while the ACF of non-stationary data decreases slowly. ACF is an (complete) auto-correlation function which gives us values of auto-correlation of any series with its lagged values while PACF is a partial auto-correlation function. Basically instead of finding correlations of present with lags like ACF, it finds correlation of the residuals (which remains after removing the effects which are already explained by the earlier lag(s)) with the next lag value hence ‘partial’ and not ‘complete’ as we remove already found variations before we find the next correlation.\nOn the other hand, STL is a versatile and robust method for decomposing time series that we will apply in one of the sections."
  },
  {
    "objectID": "arima.html#non-seasonal-arima",
    "href": "arima.html#non-seasonal-arima",
    "title": "Task 5: ARIMA",
    "section": "Non seasonal ARIMA",
    "text": "Non seasonal ARIMA\nNon seasonal ARIMA models are a combination of:\n\nAutoregressive models (AR) which forecast the variable of interest using a linear combination of predictors.\nMoving average models (MA) which forecast the variable of interest by using past values.\nReverse of differencing (I)"
  },
  {
    "objectID": "arima.html#seasonal-arima",
    "href": "arima.html#seasonal-arima",
    "title": "Task 5: ARIMA",
    "section": "Seasonal ARIMA",
    "text": "Seasonal ARIMA\nSeasonal ARIMA models includes additional seasonal terms similar to the non-seasonal."
  },
  {
    "objectID": "arima.html#dynamic-regression-models",
    "href": "arima.html#dynamic-regression-models",
    "title": "Task 5: ARIMA",
    "section": "Dynamic regression models",
    "text": "Dynamic regression models\nUp to this point the models showed do not allow the inclusion of information from other information sources which may be relevant. However, ARIMA models can be extended in order to allow other information to be included.\nFor doing that, we will allow the errors from a regression to contain autocorrelation. The error series will be assumed to follow an ARIMA model."
  },
  {
    "objectID": "acf.html",
    "href": "acf.html",
    "title": "ACF and PACF plots",
    "section": "",
    "text": "Load packages and data:\nThe ACF and PACF plots should be considered together.\nFor the AR process in the ARIMA, we expect that the ACF plot will gradually decrease and simultaneously the PACF should have a sharp drop after p significant lags.\nTo define a MA process in the ARIMA, we expect the opposite from the ACF and PACF plots, meaning that: the ACF should show a sharp drop after a certain q number of lags while PACF should show a geometric or gradual decreasing trend.\nOn the other hand, if both ACF and PACF plots demonstrate a gradual decreasing pattern, then the ARMA process should be considered for modeling."
  },
  {
    "objectID": "acf.html#asturias",
    "href": "acf.html#asturias",
    "title": "ACF and PACF plots",
    "section": "Asturias",
    "text": "Asturias\n\ndata_asturias <- covid_data %>% \n      filter(provincia == \"Asturias\") %>% \n      select(provincia, fecha, num_casos, num_hosp, tmed,mob_grocery_pharmacy, mob_parks,\n             mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      # Drop NAs dates except for mob_flujo since the data finish in 2021 while other sources are ut to 31/03/2022\n      drop_na(-mob_flujo) %>%  \n      as_tsibble(key = provincia, index = fecha)\ndata_asturias\n\n# A tsibble: 774 x 12 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos num_hosp  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl>    <dbl> <dbl>                <dbl>     <dbl>\n 1 Asturias  2020-02-15         0        0  12.2                   -1        20\n 2 Asturias  2020-02-16         0        0  16.2                    1        11\n 3 Asturias  2020-02-17         0        2   9.8                    0       -13\n 4 Asturias  2020-02-18         0        0   8.8                    1        11\n 5 Asturias  2020-02-19         0        0   8.6                    1        29\n 6 Asturias  2020-02-20         0        0   9.9                    0        32\n 7 Asturias  2020-02-21         0        0  11.2                   -1        18\n 8 Asturias  2020-02-22         0        0  10.5                    1        29\n 9 Asturias  2020-02-23         1        0   9.2                    6        23\n10 Asturias  2020-02-24         0        0   8.6                    5        48\n# … with 764 more rows, and 5 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>, mob_flujo <dbl>\n\n\n\n# ACF\ndata_asturias %>%\n      ACF(num_casos, lag_max = 30) %>%\n      autoplot() +\n      labs(title=\" Asturias - ACF Nº Cases\")\n\n\n\n# PACF\ndata_asturias %>%\n      PACF(num_casos, lag_max = 30) %>%\n      autoplot() +\n      labs(title=\" Asturias - PACF Nº Cases\")"
  },
  {
    "objectID": "acf.html#barcelona",
    "href": "acf.html#barcelona",
    "title": "ACF and PACF plots",
    "section": "Barcelona",
    "text": "Barcelona\n\ndata_barcelona <- covid_data %>% \n      filter(provincia == \"Barcelona\") %>% \n      select(provincia, fecha,num_casos, num_hosp, tmed, mob_grocery_pharmacy, mob_parks,\n             mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      # Drop NAs dates except for mob_flujo since the data finish in 2021 while other sources are ut to 31/03/2022\n      drop_na(-mob_flujo) %>%  \n      as_tsibble(key = provincia, index = fecha)\ndata_barcelona\n\n# A tsibble: 774 x 12 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos num_hosp  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl>    <dbl> <dbl>                <dbl>     <dbl>\n 1 Barcelona 2020-02-15        12        4  12.8                   -3        14\n 2 Barcelona 2020-02-16         2        4  14.5                   -8         2\n 3 Barcelona 2020-02-17         1        5  14.6                    1        11\n 4 Barcelona 2020-02-18         5        7  11.5                    1         8\n 5 Barcelona 2020-02-19         1        8  11.8                    1         6\n 6 Barcelona 2020-02-20        11       10  10.4                    1         9\n 7 Barcelona 2020-02-21        15        8  11.9                   -1        11\n 8 Barcelona 2020-02-22         8       10  12                     -1        25\n 9 Barcelona 2020-02-23         7        8  12.9                    0        26\n10 Barcelona 2020-02-24         8        4  13.6                    1        21\n# … with 764 more rows, and 5 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>, mob_flujo <dbl>\n\n\n\n# ACF\ndata_barcelona %>%\n      ACF(num_casos, lag_max = 30) %>%\n      autoplot() +\n      labs(title=\" Barcelona - ACF Nº Cases\")\n\n\n\ndata_barcelona %>%\n      PACF(num_casos, lag_max = 30) %>%\n      autoplot() +\n      labs(title=\" Barcelona - PACF Nº Cases\")"
  },
  {
    "objectID": "acf.html#madrid",
    "href": "acf.html#madrid",
    "title": "ACF and PACF plots",
    "section": "Madrid",
    "text": "Madrid\n\ndata_madrid <- covid_data %>% \n      filter(provincia == \"Madrid\") %>% \n      select(provincia, fecha, num_casos, num_hosp, tmed, mob_grocery_pharmacy, mob_parks,\n             mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      # Drop NAs dates except for mob_flujo since the data finish in 2021 while other sources are ut to 31/03/2022\n      drop_na(-mob_flujo) %>%  \n      as_tsibble(key = provincia, index = fecha)\ndata_madrid\n\n# A tsibble: 774 x 12 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos num_hosp  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl>    <dbl> <dbl>                <dbl>     <dbl>\n 1 Madrid    2020-02-15        13        4   8.6                   -2        31\n 2 Madrid    2020-02-16        13        2   9.6                    4        34\n 3 Madrid    2020-02-17        19        9   9.1                    3        10\n 4 Madrid    2020-02-18        14       13   8.5                    1        11\n 5 Madrid    2020-02-19        12       14   8.6                    1        18\n 6 Madrid    2020-02-20        25       15   8                      1        18\n 7 Madrid    2020-02-21        26       18  10.4                    1        22\n 8 Madrid    2020-02-22        29        8  10.8                   -1        53\n 9 Madrid    2020-02-23        44        8  11.6                    6        56\n10 Madrid    2020-02-24        56       18  10.8                    6        35\n# … with 764 more rows, and 5 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>, mob_flujo <dbl>\n\n\n\n# ACF\ndata_madrid %>%\n      ACF(num_casos, lag_max = 30) %>%\n      autoplot() +\n      labs(title=\" Madrid - ACF Nº Cases\")\n\n\n\n# PACF\ndata_madrid %>%\n      PACF(num_casos, lag_max = 30) %>%\n      autoplot() +\n      labs(title=\" Madrid - PACF Nº Cases\")"
  },
  {
    "objectID": "acf.html#málaga",
    "href": "acf.html#málaga",
    "title": "ACF and PACF plots",
    "section": "Málaga",
    "text": "Málaga\n\ndata_malaga <- covid_data %>% \n      filter(provincia == \"Málaga\") %>% \n      select(provincia, fecha, num_casos, num_hosp, tmed, mob_grocery_pharmacy, mob_parks,\n             mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      # Drop NAs dates except for mob_flujo since the data finish in 2021 while other sources are ut to 31/03/2022\n      drop_na(-mob_flujo) %>%  \n      as_tsibble(key = provincia, index = fecha)\ndata_malaga\n\n# A tsibble: 774 x 12 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos num_hosp  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl>    <dbl> <dbl>                <dbl>     <dbl>\n 1 Málaga    2020-02-15         1        0  13.5                    0        29\n 2 Málaga    2020-02-16         0        0  14                      4        16\n 3 Málaga    2020-02-17         0        0  17.1                    1        14\n 4 Málaga    2020-02-18         0        0  15.4                    0        -1\n 5 Málaga    2020-02-19         0        2  15.9                    0        -1\n 6 Málaga    2020-02-20         1        0  14.9                    1        13\n 7 Málaga    2020-02-21         3        2  13.6                   -1         3\n 8 Málaga    2020-02-22         2        1  14.2                   -1        25\n 9 Málaga    2020-02-23         2        0  13.2                   10        15\n10 Málaga    2020-02-24         2        1  14                      0        22\n# … with 764 more rows, and 5 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>, mob_flujo <dbl>\n\n\n\n# ACF\ndata_malaga %>%\n      ACF(num_casos, lag_max = 30) %>%\n      autoplot() +\n      labs(title=\" Malaga - ACF Nº Cases\")\n\n\n\n# PACF\ndata_malaga %>%\n      PACF(num_casos, lag_max = 30) %>%\n      autoplot() +\n      labs(title=\" Malaga - PACF Nº Cases\")"
  },
  {
    "objectID": "acf.html#sevilla",
    "href": "acf.html#sevilla",
    "title": "ACF and PACF plots",
    "section": "Sevilla",
    "text": "Sevilla\n\ndata_sevilla <- covid_data %>% \n      filter(provincia == \"Sevilla\") %>% \n      select(provincia, fecha, num_casos, num_hosp, tmed, mob_grocery_pharmacy, mob_parks,\n             mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      # Drop NAs dates except for mob_flujo since the data finish in 2021 while other sources are ut to 31/03/2022\n      drop_na(-mob_flujo) %>%   \n      as_tsibble(key = provincia, index = fecha)\ndata_sevilla\n\n# A tsibble: 774 x 12 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos num_hosp  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl>    <dbl> <dbl>                <dbl>     <dbl>\n 1 Sevilla   2020-02-15         0        1  15.9                   -5        34\n 2 Sevilla   2020-02-16         0        0  15.3                    1        15\n 3 Sevilla   2020-02-17         0        0  16.1                    0        14\n 4 Sevilla   2020-02-18         1        1  17.4                   -1        16\n 5 Sevilla   2020-02-19         0        1  15.9                    0        14\n 6 Sevilla   2020-02-20         1        1  16                     -1        13\n 7 Sevilla   2020-02-21         0        0  15.8                   -1        18\n 8 Sevilla   2020-02-22         0        0  16.6                   -2        33\n 9 Sevilla   2020-02-23         0        0  16.2                    5        20\n10 Sevilla   2020-02-24         2        0  16.3                    1        23\n# … with 764 more rows, and 5 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>, mob_flujo <dbl>\n\n\n\n# ACF\ndata_sevilla %>%\n      ACF(num_casos, lag_max = 30) %>%\n      autoplot() +\n      labs(title=\" Sevilla - ACF Nº Cases\")\n\n\n\n# PACF\ndata_sevilla %>%\n      PACF(num_casos, lag_max = 30) %>%\n      autoplot() +\n      labs(title=\" Sevilla - PACF Nº Cases\")"
  },
  {
    "objectID": "stl.html",
    "href": "stl.html",
    "title": "STL decomposition / Transformations",
    "section": "",
    "text": "pacman::p_load(\n      here,      # file locator\n      tidyverse, # data management and ggplot2 graphics\n      skimr,     # get overview of data\n      janitor,   # produce and adorn tabulations and cross-tabulations\n      tsibble,\n      fable,\n      feasts\n)\n\ncovid_data <- readRDS(here(\"data\", \"clean\", \"final_covid_data.rds\"))\n\n\nAsturias\n\ndata_asturias <- covid_data %>% \n      filter(provincia == \"Asturias\") %>% \n      select(provincia, fecha, num_casos, num_hosp, tmed,mob_grocery_pharmacy, mob_parks,\n             mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      # Drop NAs dates except for mob_flujo since the data finish in 2021 while other sources are ut to 31/03/2022\n      drop_na(-mob_flujo) %>%  \n      as_tsibble(key = provincia, index = fecha)\ndata_asturias\n\n# A tsibble: 774 x 12 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos num_hosp  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl>    <dbl> <dbl>                <dbl>     <dbl>\n 1 Asturias  2020-02-15         0        0  12.2                   -1        20\n 2 Asturias  2020-02-16         0        0  16.2                    1        11\n 3 Asturias  2020-02-17         0        2   9.8                    0       -13\n 4 Asturias  2020-02-18         0        0   8.8                    1        11\n 5 Asturias  2020-02-19         0        0   8.6                    1        29\n 6 Asturias  2020-02-20         0        0   9.9                    0        32\n 7 Asturias  2020-02-21         0        0  11.2                   -1        18\n 8 Asturias  2020-02-22         0        0  10.5                    1        29\n 9 Asturias  2020-02-23         1        0   9.2                    6        23\n10 Asturias  2020-02-24         0        0   8.6                    5        48\n# … with 764 more rows, and 5 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>, mob_flujo <dbl>\n\n\n\ndata_asturias %>%\n      model(STL(num_casos ~ season(window = 7) + trend(window = 7))) %>%\n      components() %>%\n      autoplot() + \n      labs(title = \"Asturias STL\") + \n      theme_bw()\n\n\n\n\n\ndata_asturias %>% \n      model(STL(num_casos ~ season(window = 7) + trend(window = 7))) %>%\n      components() %>% \n      as_tsibble() %>%\n      autoplot(num_casos, color = \"grey\") +\n      geom_line(aes(y = season_adjust), color = \"red\") +\n      geom_line(aes(y = trend), color = \"blue\") +\n      labs(title=\"Asturias season adjusted and trend\") +\n      theme_bw()\n\n\n\n\n\nlambda_asturias <- data_asturias %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias\n\n[1] 0.2253939\n\n\n\ndata_asturias %>%\n      gg_tsdisplay(\n            box_cox(num_casos, lambda_asturias),\n            plot_type = 'partial', lag = 30\n      ) +\n      labs(title = \"Asturias - Variance stb\")\n\n\n\n\n\ndata_asturias %>%\n      gg_tsdisplay(\n            difference(box_cox(num_casos, lambda_asturias)), \n            plot_type = 'partial', lag = 30\n      ) +\n      labs(title = \"Asturias - Difference once\")\n\n\n\n\n\ndata_asturias %>%\n      gg_tsdisplay(\n            difference(box_cox(num_casos, lambda_asturias)) %>% difference(),\n            plot_type = 'partial', lag = 30\n      ) +\n      labs(title=\"Asturias - Difference double\")\n\n\n\n\n\ndata_asturias %>% \n      model(\n            STL(num_casos ~ season(window = 7) + trend(window = 7), \n                robust = TRUE)\n      ) %>%\n      components() %>%\n      gg_tsdisplay(season_adjust, plot_type = 'partial', lag = 30) +\n      labs(title=\"Asturias - Orginal STL season_adjust\")\n\n\n\n\n\ndata_asturias %>% \n      model(\n            STL(num_casos ~ season(window = 7) + trend(window = 7), \n                robust = TRUE)\n      ) %>%\n      components() %>%\n      gg_tsdisplay(trend, plot_type = 'partial', lag = 30) +\n      labs(title=\"Asturias - Orginal STL trend\")\n\n\n\n\n\ndata_asturias %>% \n      model(\n            STL(num_casos ~ season(window = 7) + trend(window = 7), \n                robust = TRUE)\n      ) %>%\n      components() %>%\n      select(trend) %>%\n      gg_tsdisplay(difference(trend), plot_type = 'partial', lag = 30) +\n      labs(title=\"Asturias - Orginal STL trend first difference\")\n\n\n\n\n\ndata_asturias %>% \n      model(\n            STL(num_casos ~ season(window = 7) + trend(window = 7), \n                robust = TRUE)\n      ) %>%\n      components() %>%\n      select(trend) %>%\n      gg_tsdisplay(difference(difference(trend)), plot_type = 'partial', lag = 30) +\n      labs(title=\"Asturias - Orginal STL trend second difference\")\n\n\n\n\n\n\nBarcelona\n\ndata_barcelona <- covid_data %>% \n      filter(provincia == \"Barcelona\") %>% \n      select(provincia, fecha, num_casos, num_hosp, tmed,mob_grocery_pharmacy, mob_parks,\n             mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      # Drop NAs dates except for mob_flujo since the data finish in 2021 while other sources are ut to 31/03/2022\n      drop_na(-mob_flujo) %>%  \n      as_tsibble(key = provincia, index = fecha)\ndata_barcelona\n\n# A tsibble: 774 x 12 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos num_hosp  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl>    <dbl> <dbl>                <dbl>     <dbl>\n 1 Barcelona 2020-02-15        12        4  12.8                   -3        14\n 2 Barcelona 2020-02-16         2        4  14.5                   -8         2\n 3 Barcelona 2020-02-17         1        5  14.6                    1        11\n 4 Barcelona 2020-02-18         5        7  11.5                    1         8\n 5 Barcelona 2020-02-19         1        8  11.8                    1         6\n 6 Barcelona 2020-02-20        11       10  10.4                    1         9\n 7 Barcelona 2020-02-21        15        8  11.9                   -1        11\n 8 Barcelona 2020-02-22         8       10  12                     -1        25\n 9 Barcelona 2020-02-23         7        8  12.9                    0        26\n10 Barcelona 2020-02-24         8        4  13.6                    1        21\n# … with 764 more rows, and 5 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>, mob_flujo <dbl>\n\n\n\ndata_barcelona %>%\n      model(STL(num_casos ~ season(window = 7) + trend(window = 7))) %>%\n      components() %>%\n      autoplot() + \n      labs(title = \"Barcelona STL\") +\n      theme_bw()\n\n\n\n\n\ndata_barcelona %>% \n      model(STL(num_casos ~ season(window = 7) + trend(window = 7))) %>%\n      components() %>% \n      as_tsibble() %>%\n      autoplot(num_casos, color = \"grey\") +\n      geom_line(aes(y = season_adjust), color = \"red\") +\n      geom_line(aes(y = trend), color = \"blue\") +\n      labs(title=\"Barcelona season adjusted and trend\") +\n      theme_bw()\n\n\n\n\n\nlambda_barcelona <- data_barcelona %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_barcelona\n\n[1] 0.1052672\n\n\n\ndata_barcelona %>%\n      gg_tsdisplay(\n            box_cox(num_casos, lambda_barcelona),\n            plot_type = 'partial', lag = 30\n      ) +\n      labs(title = \"Barcelona - Variance stb\")\n\n\n\n\n\ndata_barcelona %>%\n      gg_tsdisplay(\n            difference(box_cox(num_casos, lambda_barcelona)),\n            plot_type = 'partial', lag = 30\n      ) +\n      labs(title = \"Barcelona - Difference once\")\n\n\n\n\n\ndata_barcelona %>%\n      gg_tsdisplay(\n            difference(box_cox(num_casos, lambda_barcelona)) %>% difference(),\n            plot_type = 'partial', lag = 30\n      ) +\n      labs(title=\"Barcelona - Difference double\")\n\n\n\n\n\ndata_barcelona %>% \n      model(\n            STL(num_casos ~ season(window = 7) + trend(window = 7), \n                robust = TRUE)\n      ) %>%\n      components() %>%\n      gg_tsdisplay(season_adjust, plot_type = 'partial', lag = 30) +\n      labs(title=\"Barcelona - Orginal STL season_adjust\")\n\n\n\n\n\ndata_barcelona %>% \n      model(\n            STL(num_casos ~ season(window = 7) + trend(window = 7), \n                robust = TRUE)\n      ) %>%\n      components() %>%\n      gg_tsdisplay(trend, plot_type = 'partial', lag = 30) +\n      labs(title=\"Barcelona - Orginal STL trend\")\n\n\n\n\n\ndata_barcelona %>% \n      model(\n            STL(num_casos ~ season(window = 7) + trend(window = 7), \n                robust = TRUE)\n      ) %>%\n      components() %>%\n      gg_tsdisplay(difference(trend), plot_type = 'partial', lag = 30) +\n      labs(title=\"Barcelona - Orginal STL trend first difference\")\n\n\n\n\n\ndata_barcelona %>% \n      model(\n            STL(num_casos ~ season(window = 7) + trend(window = 7), \n                robust = TRUE)\n      ) %>%\n      components() %>%\n      gg_tsdisplay(difference(difference(trend)), plot_type = 'partial', lag = 30) +\n      labs(title=\"Barcelona - Orginal STL trend second difference\")\n\n\n\n\n\n\nMadrid\n\ndata_madrid <- covid_data %>% \n      filter(provincia == \"Madrid\") %>% \n      select(provincia, fecha, num_casos, num_hosp, tmed,mob_grocery_pharmacy, mob_parks,\n             mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      # Drop NAs dates except for mob_flujo since the data finish in 2021 while other sources are ut to 31/03/2022\n      drop_na(-mob_flujo) %>%  \n      as_tsibble(key = provincia, index = fecha)\ndata_madrid\n\n# A tsibble: 774 x 12 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos num_hosp  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl>    <dbl> <dbl>                <dbl>     <dbl>\n 1 Madrid    2020-02-15        13        4   8.6                   -2        31\n 2 Madrid    2020-02-16        13        2   9.6                    4        34\n 3 Madrid    2020-02-17        19        9   9.1                    3        10\n 4 Madrid    2020-02-18        14       13   8.5                    1        11\n 5 Madrid    2020-02-19        12       14   8.6                    1        18\n 6 Madrid    2020-02-20        25       15   8                      1        18\n 7 Madrid    2020-02-21        26       18  10.4                    1        22\n 8 Madrid    2020-02-22        29        8  10.8                   -1        53\n 9 Madrid    2020-02-23        44        8  11.6                    6        56\n10 Madrid    2020-02-24        56       18  10.8                    6        35\n# … with 764 more rows, and 5 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>, mob_flujo <dbl>\n\n\n\ndata_madrid %>%\n      model(STL(num_casos ~ season(window = 7) + trend(window = 7))) %>%\n      components() %>%\n      autoplot() + \n      labs(title = \"Madrid STL\") +\n      theme_bw()\n\n\n\n\n\ndata_madrid %>% \n      model(STL(num_casos ~ season(window = 7) + trend(window = 7))) %>%\n      components() %>% \n      as_tsibble() %>%\n      autoplot(num_casos, color = \"grey\") +\n      geom_line(aes(y = season_adjust), color = \"red\") +\n      geom_line(aes(y = trend), color = \"blue\") +\n      labs(title=\"Madrid season adjusted and trend\") +\n      theme_bw()\n\n\n\n\n\nlambda_madrid <- data_madrid %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_madrid\n\n[1] 0.04702742\n\n\n\ndata_madrid %>%\n      gg_tsdisplay(\n            box_cox(num_casos, lambda_madrid),\n            plot_type = 'partial', lag = 30\n      ) +\n      labs(title = \"Madrid - Variance stb\")\n\n\n\n\n\ndata_madrid %>%\n      gg_tsdisplay(\n            difference(box_cox(num_casos, lambda_madrid)),\n            plot_type = 'partial', lag = 30\n      ) +\n      labs(title = \"Madrid - Difference once\")\n\n\n\n\n\ndata_madrid %>%\n      gg_tsdisplay(\n            difference(box_cox(num_casos, lambda_madrid)) %>% difference(),\n            plot_type = 'partial', lag = 30\n      ) +\n      labs(title=\"Madrid - Difference double\")\n\n\n\n\n\ndata_madrid %>% \n      model(\n            STL(num_casos ~ season(window = 7) + trend(window = 7), \n                robust = TRUE)\n      ) %>%\n      components() %>%\n      gg_tsdisplay(season_adjust, plot_type = 'partial', lag = 30) +\n      labs(title=\"Madrid - Orginal STL season_adjust\")\n\n\n\n\n\ndata_madrid %>% \n      model(\n            STL(num_casos ~ season(window = 7) + trend(window = 7), \n                robust = TRUE)\n      ) %>%\n      components() %>%\n      gg_tsdisplay(trend, plot_type = 'partial', lag = 30) +\n      labs(title=\"Madrid - Orginal STL trend\")\n\n\n\n\n\ndata_madrid %>% \n      model(\n            STL(num_casos ~ season(window = 7) + trend(window = 7), \n                robust = TRUE)\n      ) %>%\n      components() %>%\n      gg_tsdisplay(difference(trend), plot_type = 'partial', lag = 30) +\n      labs(title=\"Madrid - Orginal STL trend first difference\")\n\n\n\n\n\ndata_madrid %>% \n      model(\n            STL(num_casos ~ season(window = 7) + trend(window = 7), \n                robust = TRUE)\n      ) %>%\n      components() %>%\n      gg_tsdisplay(difference(difference(trend)), plot_type = 'partial', lag = 30) +\n      labs(title=\"Madrid - Orginal STL trend second difference\")\n\n\n\n\n\n\nMalaga\n\ndata_malaga <- covid_data %>% \n      filter(provincia == \"Málaga\") %>% \n      select(provincia, fecha, num_casos, num_hosp, tmed,mob_grocery_pharmacy, mob_parks,\n             mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      # Drop NAs dates except for mob_flujo since the data finish in 2021 while other sources are ut to 31/03/2022\n      drop_na(-mob_flujo) %>%  \n      as_tsibble(key = provincia, index = fecha)\ndata_malaga\n\n# A tsibble: 774 x 12 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos num_hosp  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl>    <dbl> <dbl>                <dbl>     <dbl>\n 1 Málaga    2020-02-15         1        0  13.5                    0        29\n 2 Málaga    2020-02-16         0        0  14                      4        16\n 3 Málaga    2020-02-17         0        0  17.1                    1        14\n 4 Málaga    2020-02-18         0        0  15.4                    0        -1\n 5 Málaga    2020-02-19         0        2  15.9                    0        -1\n 6 Málaga    2020-02-20         1        0  14.9                    1        13\n 7 Málaga    2020-02-21         3        2  13.6                   -1         3\n 8 Málaga    2020-02-22         2        1  14.2                   -1        25\n 9 Málaga    2020-02-23         2        0  13.2                   10        15\n10 Málaga    2020-02-24         2        1  14                      0        22\n# … with 764 more rows, and 5 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>, mob_flujo <dbl>\n\n\n\ndata_malaga %>%\n      model(STL(num_casos ~ season(window = 7) + trend(window = 7))) %>%\n      components() %>%\n      autoplot() + \n      labs(title = \"Málaga STL\") +\n      theme_bw()\n\n\n\n\n\ndata_malaga %>% \n      model(STL(num_casos ~ season(window = 7) + trend(window = 7))) %>%\n      components() %>% \n      as_tsibble() %>%\n      autoplot(num_casos, color = \"grey\") +\n      geom_line(aes(y = season_adjust), color = \"red\") +\n      geom_line(aes(y = trend), color = \"blue\") +\n      labs(title=\"Málaga season adjusted and trend\") +\n      theme_bw()\n\n\n\n\n\nlambda_malaga <- data_malaga %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_malaga\n\n[1] 0.2118375\n\n\n\ndata_malaga %>%\n      gg_tsdisplay(\n            box_cox(num_casos, lambda_malaga),\n            plot_type = 'partial', lag = 30\n      ) +\n      labs(title = \"Málaga - Variance stb\")\n\n\n\n\n\ndata_malaga %>%\n      gg_tsdisplay(\n            difference(box_cox(num_casos, lambda_malaga)),\n            plot_type = 'partial', lag = 30\n      ) +\n      labs(title = \"Málaga - Difference once\")\n\n\n\n\n\ndata_malaga %>%\n      gg_tsdisplay(\n            difference(box_cox(num_casos, lambda_malaga)) %>% difference(),\n            plot_type = 'partial', lag = 30\n      ) +\n      labs(title=\"Málaga - Difference double\")\n\n\n\n\n\ndata_malaga %>% \n      model(\n            STL(num_casos ~ season(window = 7) + trend(window = 7), \n                robust = TRUE)\n      ) %>%\n      components() %>%\n      gg_tsdisplay(season_adjust, plot_type = 'partial', lag = 30) +\n      labs(title=\"Málaga - Orginal STL season_adjust\")\n\n\n\n\n\ndata_malaga %>% \n      model(\n            STL(num_casos ~ season(window = 7) + trend(window = 7), \n                robust = TRUE)\n      ) %>%\n      components() %>%\n      gg_tsdisplay(trend, plot_type = 'partial', lag = 30) +\n      labs(title=\"Málaga - Orginal STL trend\")\n\n\n\n\n\ndata_malaga %>% \n      model(\n            STL(num_casos ~ season(window = 7) + trend(window = 7), \n                robust = TRUE)\n      ) %>%\n      components() %>%\n      gg_tsdisplay(difference(trend), plot_type = 'partial', lag = 30) +\n      labs(title=\"Málaga - Orginal STL trend first difference\")\n\n\n\n\n\ndata_malaga %>% \n      model(\n            STL(num_casos ~ season(window = 7) + trend(window = 7), \n                robust = TRUE)\n      ) %>%\n      components() %>%\n      gg_tsdisplay(difference(difference(trend)), plot_type = 'partial', lag = 30) +\n      labs(title=\"Málaga - Orginal STL trend second difference\")\n\n\n\n\n\n\nSevilla\n\ndata_sevilla <- covid_data %>% \n      filter(provincia == \"Sevilla\") %>% \n      select(provincia, fecha, num_casos, num_hosp, tmed,mob_grocery_pharmacy, mob_parks,\n             mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      # Drop NAs dates except for mob_flujo since the data finish in 2021 while other sources are ut to 31/03/2022\n      drop_na(-mob_flujo) %>%  \n      as_tsibble(key = provincia, index = fecha)\ndata_sevilla\n\n# A tsibble: 774 x 12 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos num_hosp  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl>    <dbl> <dbl>                <dbl>     <dbl>\n 1 Sevilla   2020-02-15         0        1  15.9                   -5        34\n 2 Sevilla   2020-02-16         0        0  15.3                    1        15\n 3 Sevilla   2020-02-17         0        0  16.1                    0        14\n 4 Sevilla   2020-02-18         1        1  17.4                   -1        16\n 5 Sevilla   2020-02-19         0        1  15.9                    0        14\n 6 Sevilla   2020-02-20         1        1  16                     -1        13\n 7 Sevilla   2020-02-21         0        0  15.8                   -1        18\n 8 Sevilla   2020-02-22         0        0  16.6                   -2        33\n 9 Sevilla   2020-02-23         0        0  16.2                    5        20\n10 Sevilla   2020-02-24         2        0  16.3                    1        23\n# … with 764 more rows, and 5 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>, mob_flujo <dbl>\n\n\n\ndata_sevilla %>%\n      model(STL(num_casos ~ season(window = 7) + trend(window = 7))) %>%\n      components() %>%\n      autoplot() + \n      labs(title = \"Sevilla STL\") +\n      theme_bw()\n\n\n\n\n\ndata_sevilla %>% \n      model(STL(num_casos ~ season(window = 7) + trend(window = 7))) %>%\n      components() %>% \n      as_tsibble() %>%\n      autoplot(num_casos, color = \"grey\") +\n      geom_line(aes(y = season_adjust), color = \"red\") +\n      geom_line(aes(y = trend), color = \"blue\") +\n      labs(title=\"Sevilla season adjusted and trend\") +\n      theme_bw()\n\n\n\n\n\nlambda_sevilla <- data_sevilla %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_sevilla\n\n[1] 0.2009975\n\n\n\ndata_sevilla %>%\n      gg_tsdisplay(\n            box_cox(num_casos, lambda_sevilla),\n            plot_type = 'partial', lag = 30\n      ) +\n      labs(title = \"Sevilla - Variance stb\")\n\n\n\n\n\ndata_sevilla %>%\n      gg_tsdisplay(\n            difference(box_cox(num_casos, lambda_sevilla)),\n            plot_type = 'partial', lag = 30\n      ) +\n      labs(title = \"Sevilla - Difference once\")\n\n\n\n\n\ndata_sevilla %>%\n      gg_tsdisplay(\n            difference(box_cox(num_casos, lambda_sevilla)) %>% difference(),\n            plot_type = 'partial', lag = 30\n      ) +\n      labs(title=\"Sevilla - Difference double\")\n\n\n\n\n\ndata_sevilla %>% \n      model(\n            STL(num_casos ~ season(window = 7) + trend(window = 7), \n                robust = TRUE)\n      ) %>%\n      components() %>%\n      gg_tsdisplay(season_adjust, plot_type = 'partial', lag = 30) +\n      labs(title=\"Sevilla - Orginal STL season_adjust\")\n\n\n\n\n\ndata_sevilla %>% \n      model(\n            STL(num_casos ~ season(window = 7) + trend(window = 7), \n                robust = TRUE)\n      ) %>%\n      components() %>%\n      gg_tsdisplay(trend, plot_type = 'partial', lag = 30) +\n      labs(title=\"Sevilla - Orginal STL trend\")\n\n\n\n\n\ndata_sevilla %>% \n      model(\n            STL(num_casos ~ season(window = 7) + trend(window = 7), \n                robust = TRUE)\n      ) %>%\n      components() %>%\n      gg_tsdisplay(difference(trend), plot_type = 'partial', lag = 30) +\n      labs(title=\"Sevilla - Orginal STL trend first difference\")\n\n\n\n\n\ndata_sevilla %>% \n      model(\n            STL(num_casos ~ season(window = 7) + trend(window = 7), \n                robust = TRUE)\n      ) %>%\n      components() %>%\n      gg_tsdisplay(difference(difference(trend)), plot_type = 'partial', lag = 30) +\n      labs(title=\"Sevilla - Orginal STL trend second difference\")"
  },
  {
    "objectID": "univariate.html",
    "href": "univariate.html",
    "title": "Univariate prediction",
    "section": "",
    "text": "Load packages:\nFor each period to study, we will train three different models:"
  },
  {
    "objectID": "univariate.html#asturias",
    "href": "univariate.html#asturias",
    "title": "Univariate prediction",
    "section": "Asturias",
    "text": "Asturias\n\ndata_asturias <- covid_data %>% \n      filter(provincia == \"Asturias\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, num_hosp, tmed,mob_grocery_pharmacy, mob_parks,\n             mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      drop_na(-mob_flujo) %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_asturias\n\n# A tsibble: 653 x 12 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos num_hosp  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl>    <dbl> <dbl>                <dbl>     <dbl>\n 1 Asturias  2020-06-15         0        0  16                   -6          39\n 2 Asturias  2020-06-16         1        0  15.6                 -6           7\n 3 Asturias  2020-06-17         0        0  15.6                 -7          20\n 4 Asturias  2020-06-18         0        0  15.1                 -4          68\n 5 Asturias  2020-06-19         0        0  14.8                 -4          52\n 6 Asturias  2020-06-20         0        0  16.8                -10          71\n 7 Asturias  2020-06-21         0        0  18.2                 -5.5        46\n 8 Asturias  2020-06-22         0        0  18.2                 -1          99\n 9 Asturias  2020-06-23         0        0  20                   -2         129\n10 Asturias  2020-06-24         0        0  18.2                 -9          63\n# … with 643 more rows, and 5 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>, mob_flujo <dbl>\n\n\n\ndata_asturias_train <- data_asturias %>% \n      filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_asturias_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-14\" \"2021-02-13\" \"2021-02-13\" \"2021-06-14\" \"2021-10-14\" \n\n\n\ndata_asturias_test <- data_asturias %>% \n      filter(fecha > as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_asturias_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-10-15\" \"2021-11-25\" \"2022-01-05\" \"2022-01-05\" \"2022-02-15\" \"2022-03-29\" \n\n\n\nlambda_asturias <- data_asturias %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\n\nfit_model <- data_asturias_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_asturias)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_asturias),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_asturias))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                arima_at1      arima_at2   Snaive\n  <chr>                      <model>        <model>  <model>\n1 Asturias  <ARIMA(3,1,1)(2,0,0)[7]> <ARIMA(2,1,4)> <SNAIVE>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>   \n1 Asturias  arima_at1  0.944   -673. 1360. 1360. 1390. <cpl [17]> <cpl [1]>\n2 Asturias  arima_at2  0.910   -664. 1343. 1343. 1372. <cpl [2]>  <cpl [4]>\n3 Asturias  Snaive     2.32      NA    NA    NA    NA  <NULL>     <NULL>   \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                      orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                      <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_at2           <ARIMA(2,1,4)>  0.910   -664. 1343. 1343. 1372.\n2 arima_at1 <ARIMA(3,1,1)(2,0,0)[7]>  0.944   -673. 1360. 1360. 1390.\n3 Snaive                    <SNAIVE>  2.32      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1   10.6      0.158\n2 Asturias  arima_at2    8.11     0.323\n3 Asturias  Snaive     629.       0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    33.1   0.00282\n2 Asturias  arima_at2    23.6   0.0509 \n3 Asturias  Snaive      892.    0      \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    49.3  0.000460\n2 Asturias  arima_at2    33.3  0.0433  \n3 Asturias  Snaive      927.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=90)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1   118.     0.0242\n2 Asturias  arima_at2    86.5    0.584 \n3 Asturias  Snaive     1195.     0     \n\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, h = 7)\nfc_h14 <- fabletools::forecast(fit_model, h = 14)\nfc_h21 <- fabletools::forecast(fit_model, h = 21)\nfc_h90 <- fabletools::forecast(fit_model, h = 90)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(9))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(9) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Asturias  Test   5.64 10.3   7.00  15.7  28.4 0.141 0.126 0.214  \n2 arima_at2 Asturias  Test   6.06  9.97  7.28  18.4  30.5 0.147 0.121 0.385  \n3 Snaive    Asturias  Test   2.41 14.0   9.98 -10.1  49.0 0.201 0.171 0.00766\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(16))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(16) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Asturias  Test  10.5   14.3  11.1 29.6   35.9 0.224 0.174  0.172\n2 arima_at2 Asturias  Test  10.9   14.2  11.5 32.1   38.1 0.232 0.173  0.303\n3 Snaive    Asturias  Test   6.69  16.0  11.4  8.17  41.5 0.229 0.195 -0.156\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(23))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(23) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Asturias  Test   9.79  13.5  10.5 27.5   32.9 0.211 0.164  0.0331\n2 arima_at2 Asturias  Test  10.6   13.7  11.0 31.0   35.1 0.222 0.167  0.126 \n3 Snaive    Asturias  Test   5.77  15.6  11.5  6.52  40.8 0.232 0.190 -0.223 \n\n\n\n\n90 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(92))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(92) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Asturias  Test   704. 1211.  704.  67.5  70.0  14.2  14.8 0.925\n2 arima_at2 Asturias  Test   713. 1221.  714.  71.1  72.9  14.4  14.9 0.926\n3 Snaive    Asturias  Test   702. 1213.  704.  60.0  71.7  14.2  14.8 0.925"
  },
  {
    "objectID": "univariate.html#barcelona",
    "href": "univariate.html#barcelona",
    "title": "Univariate prediction",
    "section": "Barcelona",
    "text": "Barcelona\n\ndata_barcelona <- covid_data %>% \n      filter(provincia == \"Barcelona\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, num_hosp, tmed,mob_grocery_pharmacy, mob_parks,\n             mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      drop_na(-mob_flujo) %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_barcelona\n\n# A tsibble: 653 x 12 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos num_hosp  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl>    <dbl> <dbl>                <dbl>     <dbl>\n 1 Barcelona 2020-06-15        62        3  21.2                   -9        17\n 2 Barcelona 2020-06-16        66        3  20.8                  -10       -16\n 3 Barcelona 2020-06-17        70        4  20.3                   -4        14\n 4 Barcelona 2020-06-18        68        4  18.8                   -8        -6\n 5 Barcelona 2020-06-19        65        4  20.4                   -5        10\n 6 Barcelona 2020-06-20        53        4  21.8                  -12        15\n 7 Barcelona 2020-06-21        38        1  22.8                  -18        18\n 8 Barcelona 2020-06-22        69        5  23.8                    5        24\n 9 Barcelona 2020-06-23        95        3  23.4                   19        28\n10 Barcelona 2020-06-24        44        4  23.6                  -71        28\n# … with 643 more rows, and 5 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>, mob_flujo <dbl>\n\n\n\ndata_barcelona_train <- data_barcelona %>% \n      filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_barcelona_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-14\" \"2021-02-13\" \"2021-02-13\" \"2021-06-14\" \"2021-10-14\" \n\n\n\ndata_barcelona_test <- data_barcelona %>% \n      filter(fecha > as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_barcelona_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-10-15\" \"2021-11-25\" \"2022-01-05\" \"2022-01-05\" \"2022-02-15\" \"2022-03-29\" \n\n\n\nlambda_Barcelona <- data_barcelona %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\n\nfit_model <- data_barcelona_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Barcelona)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Barcelona),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Barcelona))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                arima_at1                arima_at2   Snaive\n  <chr>                      <model>                  <model>  <model>\n1 Barcelona <ARIMA(0,1,3)(0,1,2)[7]> <ARIMA(1,1,2)(0,1,2)[7]> <SNAIVE>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots  \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>    <list>    \n1 Barcelona arima_at1  0.196   -293.  597.  598.  622. <cpl [0]> <cpl [17]>\n2 Barcelona arima_at2  0.188   -283.  579.  579.  604. <cpl [1]> <cpl [16]>\n3 Barcelona Snaive     0.964     NA    NA    NA    NA  <NULL>    <NULL>    \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                      orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                      <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_at2 <ARIMA(1,1,2)(0,1,2)[7]>  0.188   -283.  579.  579.  604.\n2 arima_at1 <ARIMA(0,1,3)(0,1,2)[7]>  0.196   -293.  597.  598.  622.\n3 Snaive                    <SNAIVE>  0.964     NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Barcelona arima_at1   11.7      0.110\n2 Barcelona arima_at2    2.55     0.923\n3 Barcelona Snaive    1610.       0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Barcelona arima_at1   27.0     0.0191\n2 Barcelona arima_at2    8.86    0.840 \n3 Barcelona Snaive    2198.      0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Barcelona arima_at1    30.7    0.0788\n2 Barcelona arima_at2    13.4    0.892 \n3 Barcelona Snaive     2259.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=90)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Barcelona arima_at1   131.    0.00328\n2 Barcelona arima_at2    88.9   0.513  \n3 Barcelona Snaive     3453.    0      \n\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, h = 7)\nfc_h14 <- fabletools::forecast(fit_model, h = 14)\nfc_h21 <- fabletools::forecast(fit_model, h = 21)\nfc_h90 <- fabletools::forecast(fit_model, h = 90)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_barcelona_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(9))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_barcelona %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(9) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE    MPE  MAPE  MASE  RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl>  <dbl> <dbl>\n1 arima_at1 Barcelona Test   18.9  64.7  54.8   1.87  28.9 0.146 0.0976 0.273\n2 arima_at2 Barcelona Test   23.0  68.1  55.2   3.74  28.5 0.147 0.103  0.160\n3 Snaive    Barcelona Test  -21.0  79.0  67.8 -15.5   40.3 0.180 0.119  0.184\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_barcelona_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(16))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_barcelona %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(16) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Barcelona Test   35.3  73.8  57.1  10.1  26.0 0.152 0.111 0.279 \n2 arima_at2 Barcelona Test   38.4  76.8  58.4  11.4  26.3 0.155 0.116 0.216 \n3 Snaive    Barcelona Test  -15.3  87.1  76.0 -12.2  40.4 0.202 0.131 0.0610\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_barcelona_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(23))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_barcelona %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(23) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Barcelona Test  58.9   107.  75.5  15.8  28.6 0.201 0.161  0.191\n2 arima_at2 Barcelona Test  56.9   103.  73.6  15.2  28.1 0.196 0.156  0.104\n3 Snaive    Barcelona Test  -2.10  119.  90.4 -10.9  41.3 0.240 0.179 -0.239\n\n\n\n\n90 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_barcelona_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(92))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_barcelona %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(92) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Barcelona Test  5068. 9027. 5072.  71.8  74.8  13.5  13.6 0.868\n2 arima_at2 Barcelona Test  4960. 8907. 4964.  67.8  70.8  13.2  13.4 0.868\n3 Snaive    Barcelona Test  4916. 8890. 4939.  58.7  71.4  13.1  13.4 0.870"
  },
  {
    "objectID": "univariate.html#madrid",
    "href": "univariate.html#madrid",
    "title": "Univariate prediction",
    "section": "Madrid",
    "text": "Madrid\n\ndata_madrid <- covid_data %>% \n      filter(provincia == \"Madrid\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, num_hosp, tmed,mob_grocery_pharmacy, mob_parks,\n             mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      drop_na(-mob_flujo) %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_madrid\n\n# A tsibble: 653 x 12 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos num_hosp  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl>    <dbl> <dbl>                <dbl>     <dbl>\n 1 Madrid    2020-06-15       153       10  20.7                   -8        34\n 2 Madrid    2020-06-16        91       16  21                     -8        21\n 3 Madrid    2020-06-17        93       14  20.2                   -5        34\n 4 Madrid    2020-06-18        85       17  21.9                   -7        30\n 5 Madrid    2020-06-19        78       20  22.6                   -9        22\n 6 Madrid    2020-06-20        67       20  23.4                  -12        25\n 7 Madrid    2020-06-21        42        3  25                    -13        14\n 8 Madrid    2020-06-22        60       16  27.3                   -8        29\n 9 Madrid    2020-06-23        68       11  28.4                   -9        23\n10 Madrid    2020-06-24        49       15  28                     -7        22\n# … with 643 more rows, and 5 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>, mob_flujo <dbl>\n\n\n\ndata_madrid_train <- data_madrid %>% \n      filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_madrid_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-14\" \"2021-02-13\" \"2021-02-13\" \"2021-06-14\" \"2021-10-14\" \n\n\n\ndata_madrid_test <- data_madrid %>% \n      filter(fecha > as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_madrid_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-10-15\" \"2021-11-25\" \"2022-01-05\" \"2022-01-05\" \"2022-02-15\" \"2022-03-29\" \n\n\n\nlambda_Madrid <- data_madrid %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\n\nfit_model <- data_madrid_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Madrid)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Madrid),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Madrid))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                arima_at1                arima_at2   Snaive\n  <chr>                      <model>                  <model>  <model>\n1 Madrid    <ARIMA(2,1,1)(1,1,1)[7]> <ARIMA(2,1,1)(1,1,1)[7]> <SNAIVE>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>    <list>   \n1 Madrid    arima_at1 0.0667   -33.4  78.8  79.0  104. <cpl [9]> <cpl [8]>\n2 Madrid    arima_at2 0.0667   -33.4  78.8  79.0  104. <cpl [9]> <cpl [8]>\n3 Madrid    Snaive    0.291     NA    NA    NA     NA  <NULL>    <NULL>   \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                      orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                      <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 <ARIMA(2,1,1)(1,1,1)[7]> 0.0667   -33.4  78.8  79.0  104.\n2 arima_at2 <ARIMA(2,1,1)(1,1,1)[7]> 0.0667   -33.4  78.8  79.0  104.\n3 Snaive                    <SNAIVE> 0.291     NA    NA    NA     NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    10.9     0.143\n2 Madrid    arima_at2    10.9     0.143\n3 Madrid    Snaive     1678.      0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    39.6  0.000292\n2 Madrid    arima_at2    39.6  0.000292\n3 Madrid    Snaive     2594.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    48.0  0.000679\n2 Madrid    arima_at2    48.0  0.000679\n3 Madrid    Snaive     2854.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=90)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    105.     0.130\n2 Madrid    arima_at2    105.     0.130\n3 Madrid    Snaive      3856.     0    \n\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, h = 7)\nfc_h14 <- fabletools::forecast(fit_model, h = 14)\nfc_h21 <- fabletools::forecast(fit_model, h = 21)\nfc_h90 <- fabletools::forecast(fit_model, h = 90)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_madrid_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(9))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_madrid %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(9) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Madrid    Test  135.   163.  144. 39.5   47.6 0.339 0.243 -0.0355\n2 arima_at2 Madrid    Test  135.   163.  144. 39.5   47.6 0.339 0.243 -0.0355\n3 Snaive    Madrid    Test   32.1  124.  105. -7.03  48.2 0.247 0.185 -0.109 \n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_madrid_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(16))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_madrid %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(16) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Madrid    Test  150.   178.  155. 45.1   49.4 0.364 0.265  0.0892\n2 arima_at2 Madrid    Test  150.   178.  155. 45.1   49.4 0.364 0.265  0.0892\n3 Snaive    Madrid    Test   26.3  126.  105. -8.58  46.6 0.246 0.188 -0.0472\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_madrid_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(23))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_madrid %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(23) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Madrid    Test  174.   210.  177. 50.0   52.8 0.418 0.313 0.287\n2 arima_at2 Madrid    Test  174.   210.  177. 50.0   52.8 0.418 0.313 0.287\n3 Snaive    Madrid    Test   34.8  140.  117. -8.01  48.6 0.275 0.209 0.131\n\n\n\n\n90 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_madrid_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(92))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_madrid %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(92) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Madrid    Test  5007. 8744. 5008.  81.7  82.4  11.8  13.0 0.840\n2 arima_at2 Madrid    Test  5007. 8744. 5008.  81.7  82.4  11.8  13.0 0.840\n3 Snaive    Madrid    Test  4763. 8564. 4792.  51.8  68.9  11.3  12.7 0.840"
  },
  {
    "objectID": "univariate.html#málaga",
    "href": "univariate.html#málaga",
    "title": "Univariate prediction",
    "section": "Málaga",
    "text": "Málaga\n\ndata_malaga <- covid_data %>% \n      filter(provincia == \"Málaga\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, num_hosp, tmed,mob_grocery_pharmacy, mob_parks,\n             mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      drop_na(-mob_flujo) %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_malaga\n\n# A tsibble: 653 x 12 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos num_hosp  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl>    <dbl> <dbl>                <dbl>     <dbl>\n 1 Málaga    2020-06-15         1        0  27.2                  -16        -9\n 2 Málaga    2020-06-16         1        0  27.8                  -13        -4\n 3 Málaga    2020-06-17         2        0  26.9                  -13         1\n 4 Málaga    2020-06-18         2        1  21.6                  -12         3\n 5 Málaga    2020-06-19         1        0  24.7                  -12         2\n 6 Málaga    2020-06-20         4        0  22.6                  -14         8\n 7 Málaga    2020-06-21         4        0  22.7                  -16        -3\n 8 Málaga    2020-06-22         6        0  25                    -13         1\n 9 Málaga    2020-06-23         8        0  25.6                  -10        18\n10 Málaga    2020-06-24        65        2  24.5                  -13        12\n# … with 643 more rows, and 5 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>, mob_flujo <dbl>\n\n\n\ndata_malaga_train <- data_malaga %>% \n      filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_malaga_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-14\" \"2021-02-13\" \"2021-02-13\" \"2021-06-14\" \"2021-10-14\" \n\n\n\ndata_malaga_test <- data_malaga %>% \n      filter(fecha > as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_malaga_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-10-15\" \"2021-11-25\" \"2022-01-05\" \"2022-01-05\" \"2022-02-15\" \"2022-03-29\" \n\n\n\nlambda_Malaga <- data_malaga %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\n\nfit_model <- data_malaga_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Malaga)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Malaga),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Malaga))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                arima_at1                arima_at2   Snaive\n  <chr>                      <model>                  <model>  <model>\n1 Málaga    <ARIMA(4,1,0)(1,1,1)[7]> <ARIMA(1,1,3)(0,1,1)[7]> <SNAIVE>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots  \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>    \n1 Málaga    arima_at1  0.518   -525. 1063. 1064. 1093. <cpl [11]> <cpl [7]> \n2 Málaga    arima_at2  0.504   -518. 1049. 1049. 1074. <cpl [1]>  <cpl [10]>\n3 Málaga    Snaive     2.15      NA    NA    NA    NA  <NULL>     <NULL>    \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                      orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                      <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_at2 <ARIMA(1,1,3)(0,1,1)[7]>  0.504   -518. 1049. 1049. 1074.\n2 arima_at1 <ARIMA(4,1,0)(1,1,1)[7]>  0.518   -525. 1063. 1064. 1093.\n3 Snaive                    <SNAIVE>  2.15      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1   12.3     0.0912\n2 Málaga    arima_at2    8.13    0.321 \n3 Málaga    Snaive    1361.      0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    30.5   0.00654\n2 Málaga    arima_at2    18.3   0.195  \n3 Málaga    Snaive     1956.    0      \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    35.2    0.0270\n2 Málaga    arima_at2    24.2    0.282 \n3 Málaga    Snaive     2100.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=90)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1   130.    0.00387\n2 Málaga    arima_at2    85.1   0.627  \n3 Málaga    Snaive     3195.    0      \n\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, h = 7)\nfc_h14 <- fabletools::forecast(fit_model, h = 14)\nfc_h21 <- fabletools::forecast(fit_model, h = 21)\nfc_h90 <- fabletools::forecast(fit_model, h = 90)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_malaga_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(9))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_malaga %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(9) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Málaga    Test  15.6   22.6  21.8  18.9  46.0 0.221 0.134 -0.133 \n2 arima_at2 Málaga    Test  15.4   22.9  22.3  18.1  47.8 0.226 0.135 -0.0302\n3 Snaive    Málaga    Test  -4.00  22.9  19.8 -27.0  52.2 0.201 0.135  0.0123\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_malaga_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(16))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_malaga %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(16) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Málaga    Test  20.1   27.7  24.0  26.8  42.4 0.243 0.163  0.199 \n2 arima_at2 Málaga    Test  21.4   29.0  25.2  28.8  44.9 0.256 0.172  0.261 \n3 Snaive    Málaga    Test  -3.86  22.7  18.7 -22.4  43.6 0.190 0.134 -0.0973\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_malaga_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(23))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_malaga %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(23) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE   MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Málaga    Test  26.7    33.3  29.2  35.0  45.4 0.297 0.197 0.270 \n2 arima_at2 Málaga    Test  28.1    34.8  30.7  37.2  47.9 0.311 0.205 0.303 \n3 Snaive    Málaga    Test  -0.951  22.0  18.6 -14.8  37.9 0.188 0.130 0.0886\n\n\n\n\n90 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_malaga_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(92))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_malaga %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(92) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Málaga    Test   680. 1100.  680.  73.4  75.9  6.91  6.50 0.934\n2 arima_at2 Málaga    Test   676. 1099.  677.  72.2  74.7  6.87  6.49 0.935\n3 Snaive    Málaga    Test   620. 1049.  628.  44.9  62.3  6.37  6.20 0.929"
  },
  {
    "objectID": "univariate.html#sevilla",
    "href": "univariate.html#sevilla",
    "title": "Univariate prediction",
    "section": "Sevilla",
    "text": "Sevilla\n\ndata_sevilla <- covid_data %>% \n      filter(provincia == \"Sevilla\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, num_hosp, tmed,mob_grocery_pharmacy, mob_parks,\n             mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      drop_na(-mob_flujo) %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_sevilla\n\n# A tsibble: 653 x 12 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos num_hosp  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl>    <dbl> <dbl>                <dbl>     <dbl>\n 1 Sevilla   2020-06-15         2        1  23.1                  -14       -13\n 2 Sevilla   2020-06-16         1        0  24.0                  -10        -4\n 3 Sevilla   2020-06-17         0        0  24.9                  -10        -7\n 4 Sevilla   2020-06-18         0        0  25.8                  -12       -13\n 5 Sevilla   2020-06-19         0        0  26.6                  -13       -20\n 6 Sevilla   2020-06-20         0        0  27.5                  -20       -34\n 7 Sevilla   2020-06-21         0        0  28.4                  -27       -47\n 8 Sevilla   2020-06-22         1        0  29.3                  -17       -19\n 9 Sevilla   2020-06-23         0        0  30.2                  -12       -13\n10 Sevilla   2020-06-24         1        0  29.4                  -12       -12\n# … with 643 more rows, and 5 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>, mob_flujo <dbl>\n\n\n\ndata_sevilla_train <- data_sevilla %>% \n      filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_sevilla_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-14\" \"2021-02-13\" \"2021-02-13\" \"2021-06-14\" \"2021-10-14\" \n\n\n\ndata_sevilla_test <- data_sevilla %>% \n      filter(fecha > as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_sevilla_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-10-15\" \"2021-11-25\" \"2022-01-05\" \"2022-01-05\" \"2022-02-15\" \"2022-03-29\" \n\n\n\nlambda_Sevilla <- data_sevilla %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\n\nfit_model <- data_sevilla_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Sevilla)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Sevilla),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Sevilla))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                arima_at1                arima_at2   Snaive\n  <chr>                      <model>                  <model>  <model>\n1 Sevilla   <ARIMA(3,1,1)(2,0,0)[7]> <ARIMA(4,1,0)(2,0,0)[7]> <SNAIVE>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>   \n1 Sevilla   arima_at1  0.924   -670. 1353. 1354. 1383. <cpl [17]> <cpl [1]>\n2 Sevilla   arima_at2  0.922   -669. 1353. 1353. 1382. <cpl [18]> <cpl [0]>\n3 Sevilla   Snaive     2.02      NA    NA    NA    NA  <NULL>     <NULL>   \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                      orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                      <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_at2 <ARIMA(4,1,0)(2,0,0)[7]>  0.922   -669. 1353. 1353. 1382.\n2 arima_at1 <ARIMA(3,1,1)(2,0,0)[7]>  0.924   -670. 1353. 1354. 1383.\n3 Snaive                    <SNAIVE>  2.02      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    8.72     0.274\n2 Sevilla   arima_at2    7.65     0.365\n3 Sevilla   Snaive     757.       0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    24.5    0.0402\n2 Sevilla   arima_at2    23.6    0.0511\n3 Sevilla   Snaive     1110.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    37.4    0.0151\n2 Sevilla   arima_at2    36.6    0.0189\n3 Sevilla   Snaive     1235.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=90)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    103.     0.161\n2 Sevilla   arima_at2    102.     0.179\n3 Sevilla   Snaive      1692.     0    \n\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, h = 7)\nfc_h14 <- fabletools::forecast(fit_model, h = 14)\nfc_h21 <- fabletools::forecast(fit_model, h = 21)\nfc_h90 <- fabletools::forecast(fit_model, h = 90)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_sevilla_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(9))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_sevilla %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(9) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE   MASE  RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>  <dbl>   <dbl>\n1 arima_at1 Sevilla   Test   7.30  11.4  8.80  19.1  24.7 0.0870 0.0721 -0.0998\n2 arima_at2 Sevilla   Test   7.38  11.4  8.93  19.3  25.1 0.0883 0.0725 -0.0852\n3 Snaive    Sevilla   Test  -5.85  16.0 13.7  -22.0  40.6 0.135  0.102   0.0310\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_sevilla_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(16))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_sevilla %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(16) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_sevilla)\n\n# A tibble: 3 × 11\n  .model   provincia .type     ME  RMSE   MAE    MPE  MAPE   MASE  RMSSE    ACF1\n  <chr>    <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl>  <dbl>  <dbl>   <dbl>\n1 arima_a… Sevilla   Test    4.45  9.82  7.83   6.10  27.4 0.0774 0.0623 -0.0579\n2 arima_a… Sevilla   Test    4.58  9.88  7.91   6.63  27.5 0.0782 0.0626 -0.0509\n3 Snaive   Sevilla   Test  -12.5  19.3  16.4  -57.6   66.9 0.162  0.122   0.275 \n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_sevilla_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(23))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_sevilla %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(23) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE    MPE  MAPE   MASE  RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl>  <dbl>  <dbl> <dbl>\n1 arima_at1 Sevilla   Test    5.70  11.3  8.54   8.79  26.3 0.0844 0.0716 0.183\n2 arima_at2 Sevilla   Test    5.84  11.4  8.61   9.32  26.3 0.0850 0.0720 0.187\n3 Snaive    Sevilla   Test  -13.9   22.1 19.1  -60.8   72.0 0.189  0.140  0.327\n\n\n\n\n90 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_sevilla_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(92))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_sevilla %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(92) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Sevilla   Test   681. 1161.  682.  59.5  64.8  6.74  7.36 0.891\n2 arima_at2 Sevilla   Test   681. 1161.  682.  59.7  64.8  6.74  7.36 0.891\n3 Snaive    Sevilla   Test   665. 1161.  677.  31.7  74.6  6.69  7.36 0.892"
  },
  {
    "objectID": "univariate.html#asturias-1",
    "href": "univariate.html#asturias-1",
    "title": "Univariate prediction",
    "section": "Asturias",
    "text": "Asturias\n\ndata_asturias <- covid_data %>% \n      filter(provincia == \"Asturias\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, num_hosp, tmed,mob_grocery_pharmacy, mob_parks,\n             mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      drop_na(-mob_flujo) %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_asturias\n\n# A tsibble: 653 x 12 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos num_hosp  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl>    <dbl> <dbl>                <dbl>     <dbl>\n 1 Asturias  2020-06-15         0        0  16                   -6          39\n 2 Asturias  2020-06-16         1        0  15.6                 -6           7\n 3 Asturias  2020-06-17         0        0  15.6                 -7          20\n 4 Asturias  2020-06-18         0        0  15.1                 -4          68\n 5 Asturias  2020-06-19         0        0  14.8                 -4          52\n 6 Asturias  2020-06-20         0        0  16.8                -10          71\n 7 Asturias  2020-06-21         0        0  18.2                 -5.5        46\n 8 Asturias  2020-06-22         0        0  18.2                 -1          99\n 9 Asturias  2020-06-23         0        0  20                   -2         129\n10 Asturias  2020-06-24         0        0  18.2                 -9          63\n# … with 643 more rows, and 5 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>, mob_flujo <dbl>\n\n\n\ndata_asturias_train <- data_asturias %>% \n      filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_asturias_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-11-10\" \"2021-04-08\" \"2021-04-08\" \"2021-09-04\" \"2022-01-31\" \n\n\n\ndata_asturias_test <- data_asturias %>% \n      filter(fecha > as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_asturias_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2022-02-01\" \"2022-02-15\" \"2022-03-01\" \"2022-03-01\" \"2022-03-15\" \"2022-03-29\" \n\n\n\nlambda_asturias <- data_asturias %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\n\nfit_model <- data_asturias_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_asturias)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_asturias),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_asturias))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                arima_at1                arima_at2   Snaive\n  <chr>                      <model>                  <model>  <model>\n1 Asturias  <ARIMA(3,1,1)(2,0,0)[7]> <ARIMA(0,1,1)(1,0,1)[7]> <SNAIVE>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>   \n1 Asturias  arima_at1  0.917   -816. 1646. 1646. 1677. <cpl [17]> <cpl [1]>\n2 Asturias  arima_at2  0.894   -811. 1629. 1629. 1647. <cpl [7]>  <cpl [8]>\n3 Asturias  Snaive     2.53      NA    NA    NA    NA  <NULL>     <NULL>   \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                      orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                      <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_at2 <ARIMA(0,1,1)(1,0,1)[7]>  0.894   -811. 1629. 1629. 1647.\n2 arima_at1 <ARIMA(3,1,1)(2,0,0)[7]>  0.917   -816. 1646. 1646. 1677.\n3 Snaive                    <SNAIVE>  2.53      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    13.8    0.0551\n2 Asturias  arima_at2    12.9    0.0743\n3 Asturias  Snaive      981.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    38.9  0.000378\n2 Asturias  arima_at2    35.2  0.00137 \n3 Asturias  Snaive     1393.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    60.0 0.0000128\n2 Asturias  arima_at2    49.0 0.000509 \n3 Asturias  Snaive     1470.  0        \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=57)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1   101.   0.000286\n2 Asturias  arima_at2    78.6  0.0304  \n3 Asturias  Snaive     1527.   0       \n\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, h = 7)\nfc_h14 <- fabletools::forecast(fit_model, h = 14)\nfc_h21 <- fabletools::forecast(fit_model, h = 21)\nfc_h90 <- fabletools::forecast(fit_model, h = 57)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(9))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(9) &\n                               fecha > as.Date(\"2021-12-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Asturias  Test  -173.  272.  251. -25.1  30.1  2.60  1.24  0.192\n2 arima_at2 Asturias  Test  -254.  334.  317. -33.7  37.7  3.27  1.52  0.162\n3 Snaive    Asturias  Test  -570.  586.  570. -62.8  62.8  5.89  2.66 -0.550\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(16))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(16) &\n                               fecha > as.Date(\"2021-12-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Asturias  Test  -271.  332.  310.  -44.0  46.5  3.20  1.51 0.372\n2 arima_at2 Asturias  Test  -393.  447.  424.  -60.8  62.8  4.38  2.03 0.444\n3 Snaive    Asturias  Test  -769.  812.  769. -107.  107.   7.94  3.69 0.299\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(23))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(23) &\n                               fecha > as.Date(\"2021-12-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Asturias  Test  -355.  411.  381.  -74.5  76.1  3.94  1.87 0.532\n2 arima_at2 Asturias  Test  -493.  543.  514.  -98.0  99.3  5.31  2.47 0.597\n3 Snaive    Asturias  Test  -920.  980.  920. -168.  168.   9.50  4.46 0.437\n\n\n\n\n57 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(59))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(59) &\n                               fecha > as.Date(\"2021-12-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Asturias  Test   -579.  631.  589.  -Inf   Inf  6.09  2.87 0.719\n2 arima_at2 Asturias  Test   -694.  735.  702.  -Inf   Inf  7.25  3.34 0.714\n3 Snaive    Asturias  Test  -1282. 1359. 1282.  -Inf   Inf 13.3   6.18 0.471"
  },
  {
    "objectID": "univariate.html#barcelona-1",
    "href": "univariate.html#barcelona-1",
    "title": "Univariate prediction",
    "section": "Barcelona",
    "text": "Barcelona\n\ndata_barcelona <- covid_data %>% \n      filter(provincia == \"Barcelona\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, num_hosp, tmed,mob_grocery_pharmacy, mob_parks,\n             mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      drop_na(-mob_flujo) %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_barcelona\n\n# A tsibble: 653 x 12 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos num_hosp  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl>    <dbl> <dbl>                <dbl>     <dbl>\n 1 Barcelona 2020-06-15        62        3  21.2                   -9        17\n 2 Barcelona 2020-06-16        66        3  20.8                  -10       -16\n 3 Barcelona 2020-06-17        70        4  20.3                   -4        14\n 4 Barcelona 2020-06-18        68        4  18.8                   -8        -6\n 5 Barcelona 2020-06-19        65        4  20.4                   -5        10\n 6 Barcelona 2020-06-20        53        4  21.8                  -12        15\n 7 Barcelona 2020-06-21        38        1  22.8                  -18        18\n 8 Barcelona 2020-06-22        69        5  23.8                    5        24\n 9 Barcelona 2020-06-23        95        3  23.4                   19        28\n10 Barcelona 2020-06-24        44        4  23.6                  -71        28\n# … with 643 more rows, and 5 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>, mob_flujo <dbl>\n\n\n\ndata_barcelona_train <- data_barcelona %>% \n      filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_barcelona_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-11-10\" \"2021-04-08\" \"2021-04-08\" \"2021-09-04\" \"2022-01-31\" \n\n\n\ndata_barcelona_test <- data_barcelona %>% \n      filter(fecha > as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_barcelona_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2022-02-01\" \"2022-02-15\" \"2022-03-01\" \"2022-03-01\" \"2022-03-15\" \"2022-03-29\" \n\n\n\nlambda_Barcelona <- data_barcelona %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\n\nfit_model <- data_barcelona_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Barcelona)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Barcelona),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Barcelona))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                arima_at1                arima_at2   Snaive\n  <chr>                      <model>                  <model>  <model>\n1 Barcelona <ARIMA(1,0,2)(0,1,1)[7]> <ARIMA(1,0,4)(0,1,1)[7]> <SNAIVE>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots  \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>    <list>    \n1 Barcelona arima_at1  0.344   -523. 1055. 1055. 1077. <cpl [1]> <cpl [9]> \n2 Barcelona arima_at2  0.341   -520. 1053. 1053. 1084. <cpl [1]> <cpl [11]>\n3 Barcelona Snaive     1.26      NA    NA    NA    NA  <NULL>    <NULL>    \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                      orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                      <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_at2 <ARIMA(1,0,4)(0,1,1)[7]>  0.341   -520. 1053. 1053. 1084.\n2 arima_at1 <ARIMA(1,0,2)(0,1,1)[7]>  0.344   -523. 1055. 1055. 1077.\n3 Snaive                    <SNAIVE>  1.26      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Barcelona arima_at1    33.4 0.0000220\n2 Barcelona arima_at2    26.1 0.000480 \n3 Barcelona Snaive     1654.  0        \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat  lb_pvalue\n  <chr>     <chr>       <dbl>      <dbl>\n1 Barcelona arima_at1    51.3 0.00000363\n2 Barcelona arima_at2    43.2 0.0000793 \n3 Barcelona Snaive     2253.  0         \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Barcelona arima_at1    57.6 0.0000289\n2 Barcelona arima_at2    49.3 0.000455 \n3 Barcelona Snaive     2362.  0        \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=57)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Barcelona arima_at1    162.  4.59e-12\n2 Barcelona arima_at2    153.  9.83e-11\n3 Barcelona Snaive      2651.  0       \n\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, h = 7)\nfc_h14 <- fabletools::forecast(fit_model, h = 14)\nfc_h21 <- fabletools::forecast(fit_model, h = 21)\nfc_h90 <- fabletools::forecast(fit_model, h = 57)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_barcelona_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(9))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_barcelona %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(9) &\n                               fecha > as.Date(\"2021-12-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE   MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Barcelona Test  -4569. 4824. 4569. -62.2  62.2  5.74  2.46 -0.0331\n2 arima_at2 Barcelona Test  -4145. 4383. 4145. -56.2  56.2  5.21  2.24 -0.0435\n3 Snaive    Barcelona Test  -7870. 8139. 7870. -99.0  99.0  9.88  4.16  0.551 \n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_barcelona_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(16))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_barcelona %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(16) &\n                               fecha > as.Date(\"2021-12-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME   RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Barcelona Test  -6582.  7100. 6582. -132.  132.  8.27  3.63 0.471\n2 arima_at2 Barcelona Test  -6038.  6534. 6038. -122.  122.  7.58  3.34 0.471\n3 Snaive    Barcelona Test  -9985. 10606. 9985. -188.  188. 12.5   5.42 0.548\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_barcelona_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(23))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_barcelona %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(23) &\n                               fecha > as.Date(\"2021-12-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type      ME   RMSE    MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>   <dbl>  <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Barcelona Test   -7823.  8400.  7823. -199.  199.  9.83  4.29 0.573\n2 arima_at2 Barcelona Test   -7199.  7750.  7199. -184.  184.  9.04  3.96 0.575\n3 Snaive    Barcelona Test  -11275. 12018. 11275. -272.  272. 14.2   6.14 0.602\n\n\n\n\n57 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_barcelona_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(59))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_barcelona %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(59) &\n                               fecha > as.Date(\"2021-12-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type      ME   RMSE    MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>   <dbl>  <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Barcelona Test  -11642. 12454. 11642.  -Inf   Inf  14.6  6.36 0.695\n2 arima_at2 Barcelona Test  -10693. 11449. 10693.  -Inf   Inf  13.4  5.85 0.691\n3 Snaive    Barcelona Test  -14809. 15796. 14809.  -Inf   Inf  18.6  8.06 0.592"
  },
  {
    "objectID": "univariate.html#madrid-1",
    "href": "univariate.html#madrid-1",
    "title": "Univariate prediction",
    "section": "Madrid",
    "text": "Madrid\n\ndata_madrid <- covid_data %>% \n      filter(provincia == \"Madrid\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, num_hosp, tmed,mob_grocery_pharmacy, mob_parks,\n             mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      drop_na(-mob_flujo) %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_madrid\n\n# A tsibble: 653 x 12 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos num_hosp  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl>    <dbl> <dbl>                <dbl>     <dbl>\n 1 Madrid    2020-06-15       153       10  20.7                   -8        34\n 2 Madrid    2020-06-16        91       16  21                     -8        21\n 3 Madrid    2020-06-17        93       14  20.2                   -5        34\n 4 Madrid    2020-06-18        85       17  21.9                   -7        30\n 5 Madrid    2020-06-19        78       20  22.6                   -9        22\n 6 Madrid    2020-06-20        67       20  23.4                  -12        25\n 7 Madrid    2020-06-21        42        3  25                    -13        14\n 8 Madrid    2020-06-22        60       16  27.3                   -8        29\n 9 Madrid    2020-06-23        68       11  28.4                   -9        23\n10 Madrid    2020-06-24        49       15  28                     -7        22\n# … with 643 more rows, and 5 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>, mob_flujo <dbl>\n\n\n\ndata_madrid_train <- data_madrid %>% \n      filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_madrid_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-11-10\" \"2021-04-08\" \"2021-04-08\" \"2021-09-04\" \"2022-01-31\" \n\n\n\ndata_madrid_test <- data_madrid %>% \n      filter(fecha > as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_madrid_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2022-02-01\" \"2022-02-15\" \"2022-03-01\" \"2022-03-01\" \"2022-03-15\" \"2022-03-29\" \n\n\n\nlambda_Madrid <- data_madrid %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\n\nfit_model <- data_madrid_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Madrid)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Madrid),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Madrid))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                arima_at1                arima_at2   Snaive\n  <chr>                      <model>                  <model>  <model>\n1 Madrid    <ARIMA(2,0,2)(0,1,2)[7]> <ARIMA(2,0,2)(0,1,2)[7]> <SNAIVE>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots  \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>    <list>    \n1 Madrid    arima_at1  0.132   -240.  494.  495.  525. <cpl [2]> <cpl [16]>\n2 Madrid    arima_at2  0.132   -240.  494.  495.  525. <cpl [2]> <cpl [16]>\n3 Madrid    Snaive     0.412     NA    NA    NA    NA  <NULL>    <NULL>    \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                      orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                      <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 <ARIMA(2,0,2)(0,1,2)[7]>  0.132   -240.  494.  495.  525.\n2 arima_at2 <ARIMA(2,0,2)(0,1,2)[7]>  0.132   -240.  494.  495.  525.\n3 Snaive                    <SNAIVE>  0.412     NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    24.8  0.000838\n2 Madrid    arima_at2    24.8  0.000838\n3 Madrid    Snaive     1617.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    38.5  0.000443\n2 Madrid    arima_at2    38.5  0.000443\n3 Madrid    Snaive     2282.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    47.9  0.000718\n2 Madrid    arima_at2    47.9  0.000718\n3 Madrid    Snaive     2422.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=57)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat   lb_pvalue\n  <chr>     <chr>       <dbl>       <dbl>\n1 Madrid    arima_at1    123. 0.000000995\n2 Madrid    arima_at2    123. 0.000000995\n3 Madrid    Snaive      2762. 0          \n\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, h = 7)\nfc_h14 <- fabletools::forecast(fit_model, h = 14)\nfc_h21 <- fabletools::forecast(fit_model, h = 21)\nfc_h90 <- fabletools::forecast(fit_model, h = 57)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_madrid_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(9))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_madrid %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(9) &\n                               fecha > as.Date(\"2021-12-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE    MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Madrid    Test    471.  788.  629.   8.70  11.7 0.843 0.441 0.0572\n2 arima_at2 Madrid    Test    471.  788.  629.   8.70  11.7 0.843 0.441 0.0572\n3 Snaive    Madrid    Test  -1836. 2070. 1836. -36.2   36.2 2.46  1.16  0.541 \n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_madrid_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(16))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_madrid %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(16) &\n                               fecha > as.Date(\"2021-12-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Madrid    Test    174.  612.  467.   2.98  10.9 0.625 0.343 0.215\n2 arima_at2 Madrid    Test    174.  612.  467.   2.98  10.9 0.625 0.343 0.215\n3 Snaive    Madrid    Test  -2914. 3386. 2914. -77.1   77.1 3.90  1.90  0.466\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_madrid_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(23))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_madrid %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(23) &\n                               fecha > as.Date(\"2021-12-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Madrid    Test   -228.  851.  664.  -16.7  26.5 0.888 0.477 0.512\n2 arima_at2 Madrid    Test   -228.  851.  664.  -16.7  26.5 0.888 0.477 0.512\n3 Snaive    Madrid    Test  -3903. 4584. 3903. -158.  158.  5.23  2.57  0.574\n\n\n\n\n57 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_madrid_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(59))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_madrid %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(59) &\n                               fecha > as.Date(\"2021-12-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Madrid    Test  -1540. 2217. 1701. -2124. 2127.  2.28  1.24 0.699\n2 arima_at2 Madrid    Test  -1540. 2217. 1701. -2124. 2127.  2.28  1.24 0.699\n3 Snaive    Madrid    Test  -6507. 7446. 6507. -4965. 4965.  8.71  4.17 0.627"
  },
  {
    "objectID": "univariate.html#málaga-1",
    "href": "univariate.html#málaga-1",
    "title": "Univariate prediction",
    "section": "Málaga",
    "text": "Málaga\n\ndata_malaga <- covid_data %>% \n      filter(provincia == \"Málaga\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, num_hosp, tmed,mob_grocery_pharmacy, mob_parks,\n             mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      drop_na(-mob_flujo) %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_malaga\n\n# A tsibble: 653 x 12 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos num_hosp  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl>    <dbl> <dbl>                <dbl>     <dbl>\n 1 Málaga    2020-06-15         1        0  27.2                  -16        -9\n 2 Málaga    2020-06-16         1        0  27.8                  -13        -4\n 3 Málaga    2020-06-17         2        0  26.9                  -13         1\n 4 Málaga    2020-06-18         2        1  21.6                  -12         3\n 5 Málaga    2020-06-19         1        0  24.7                  -12         2\n 6 Málaga    2020-06-20         4        0  22.6                  -14         8\n 7 Málaga    2020-06-21         4        0  22.7                  -16        -3\n 8 Málaga    2020-06-22         6        0  25                    -13         1\n 9 Málaga    2020-06-23         8        0  25.6                  -10        18\n10 Málaga    2020-06-24        65        2  24.5                  -13        12\n# … with 643 more rows, and 5 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>, mob_flujo <dbl>\n\n\n\ndata_malaga_train <- data_malaga %>% \n      filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_malaga_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-11-10\" \"2021-04-08\" \"2021-04-08\" \"2021-09-04\" \"2022-01-31\" \n\n\n\ndata_malaga_test <- data_malaga %>% \n      filter(fecha > as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_malaga_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2022-02-01\" \"2022-02-15\" \"2022-03-01\" \"2022-03-01\" \"2022-03-15\" \"2022-03-29\" \n\n\n\nlambda_Malaga <- data_malaga %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\n\nfit_model <- data_malaga_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Malaga)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Malaga),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Malaga))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                arima_at1                arima_at2   Snaive\n  <chr>                      <model>                  <model>  <model>\n1 Málaga    <ARIMA(2,0,3)(0,1,1)[7]> <ARIMA(2,0,3)(0,1,1)[7]> <SNAIVE>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots  \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>    <list>    \n1 Málaga    arima_at1  0.584   -679. 1372. 1372. 1402. <cpl [2]> <cpl [10]>\n2 Málaga    arima_at2  0.584   -679. 1372. 1372. 1402. <cpl [2]> <cpl [10]>\n3 Málaga    Snaive     2.41      NA    NA    NA    NA  <NULL>    <NULL>    \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                      orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                      <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 <ARIMA(2,0,3)(0,1,1)[7]>  0.584   -679. 1372. 1372. 1402.\n2 arima_at2 <ARIMA(2,0,3)(0,1,1)[7]>  0.584   -679. 1372. 1372. 1402.\n3 Snaive                    <SNAIVE>  2.41      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    3.28     0.858\n2 Málaga    arima_at2    3.28     0.858\n3 Málaga    Snaive    1621.       0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    15.4     0.350\n2 Málaga    arima_at2    15.4     0.350\n3 Málaga    Snaive     2376.      0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    29.2     0.109\n2 Málaga    arima_at2    29.2     0.109\n3 Málaga    Snaive     2555.      0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=57)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    58.4     0.423\n2 Málaga    arima_at2    58.4     0.423\n3 Málaga    Snaive     3422.      0    \n\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, h = 7)\nfc_h14 <- fabletools::forecast(fit_model, h = 14)\nfc_h21 <- fabletools::forecast(fit_model, h = 21)\nfc_h90 <- fabletools::forecast(fit_model, h = 57)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_malaga_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(9))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_malaga %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(9) &\n                               fecha > as.Date(\"2021-12-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Málaga    Test    74.3  190.  152.   3.78  24.3  1.15 0.769 0.249\n2 arima_at2 Málaga    Test    74.3  190.  152.   3.78  24.3  1.15 0.769 0.249\n3 Snaive    Málaga    Test  -170.   240.  191. -33.7   35.9  1.45 0.968 0.246\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_malaga_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(16))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_malaga %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(16) &\n                               fecha > as.Date(\"2021-12-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Málaga    Test   185.  290.  229.  17.9  29.6  1.73 1.17  0.340 \n2 arima_at2 Málaga    Test   185.  290.  229.  17.9  29.6  1.73 1.17  0.340 \n3 Snaive    Málaga    Test  -141.  223.  170. -28.9  31.8  1.28 0.899 0.0239\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_malaga_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(23))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_malaga %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(23) &\n                               fecha > as.Date(\"2021-12-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Málaga    Test   173.  267.  203.  19.1  26.9  1.53  1.08 0.422\n2 arima_at2 Málaga    Test   173.  267.  203.  19.1  26.9  1.53  1.08 0.422\n3 Snaive    Málaga    Test  -208.  279.  227. -41.4  43.4  1.72  1.13 0.172\n\n\n\n\n57 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_malaga_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(59))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_malaga %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(59) &\n                               fecha > as.Date(\"2021-12-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type      ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>   <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Málaga    Test    -6.39  278.  190.  -Inf   Inf  1.44  1.12 0.656\n2 arima_at2 Málaga    Test    -6.39  278.  190.  -Inf   Inf  1.44  1.12 0.656\n3 Snaive    Málaga    Test  -436.    525.  443.  -Inf   Inf  3.35  2.12 0.513"
  },
  {
    "objectID": "univariate.html#sevilla-1",
    "href": "univariate.html#sevilla-1",
    "title": "Univariate prediction",
    "section": "Sevilla",
    "text": "Sevilla\n\ndata_sevilla <- covid_data %>% \n      filter(provincia == \"Sevilla\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, num_hosp, tmed,mob_grocery_pharmacy, mob_parks,\n             mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces, mob_flujo) %>% \n      drop_na(-mob_flujo) %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_sevilla\n\n# A tsibble: 653 x 12 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos num_hosp  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl>    <dbl> <dbl>                <dbl>     <dbl>\n 1 Sevilla   2020-06-15         2        1  23.1                  -14       -13\n 2 Sevilla   2020-06-16         1        0  24.0                  -10        -4\n 3 Sevilla   2020-06-17         0        0  24.9                  -10        -7\n 4 Sevilla   2020-06-18         0        0  25.8                  -12       -13\n 5 Sevilla   2020-06-19         0        0  26.6                  -13       -20\n 6 Sevilla   2020-06-20         0        0  27.5                  -20       -34\n 7 Sevilla   2020-06-21         0        0  28.4                  -27       -47\n 8 Sevilla   2020-06-22         1        0  29.3                  -17       -19\n 9 Sevilla   2020-06-23         0        0  30.2                  -12       -13\n10 Sevilla   2020-06-24         1        0  29.4                  -12       -12\n# … with 643 more rows, and 5 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>, mob_flujo <dbl>\n\n\n\ndata_sevilla_train <- data_sevilla %>% \n      filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_sevilla_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-11-10\" \"2021-04-08\" \"2021-04-08\" \"2021-09-04\" \"2022-01-31\" \n\n\n\ndata_sevilla_test <- data_sevilla %>% \n      filter(fecha > as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_sevilla_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2022-02-01\" \"2022-02-15\" \"2022-03-01\" \"2022-03-01\" \"2022-03-15\" \"2022-03-29\" \n\n\n\nlambda_Sevilla <- data_sevilla %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\n\nfit_model <- data_sevilla_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Sevilla)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Sevilla),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Sevilla))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                arima_at1                arima_at2   Snaive\n  <chr>                      <model>                  <model>  <model>\n1 Sevilla   <ARIMA(3,1,1)(2,0,0)[7]> <ARIMA(4,1,0)(2,0,0)[7]> <SNAIVE>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>   \n1 Sevilla   arima_at1  0.962   -832. 1679. 1679. 1709. <cpl [17]> <cpl [1]>\n2 Sevilla   arima_at2  0.962   -832. 1678. 1679. 1709. <cpl [18]> <cpl [0]>\n3 Sevilla   Snaive     2.23      NA    NA    NA    NA  <NULL>     <NULL>   \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                      orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                      <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_at2 <ARIMA(4,1,0)(2,0,0)[7]>  0.962   -832. 1678. 1679. 1709.\n2 arima_at1 <ARIMA(3,1,1)(2,0,0)[7]>  0.962   -832. 1679. 1679. 1709.\n3 Snaive                    <SNAIVE>  2.23      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    7.13     0.416\n2 Sevilla   arima_at2    6.24     0.512\n3 Sevilla   Snaive     965.       0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    27.9    0.0146\n2 Sevilla   arima_at2    27.1    0.0185\n3 Sevilla   Snaive     1403.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    38.6    0.0108\n2 Sevilla   arima_at2    37.9    0.0132\n3 Sevilla   Snaive     1510.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=57)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    78.0    0.0335\n2 Sevilla   arima_at2    77.4    0.0372\n3 Sevilla   Snaive     1813.     0     \n\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, h = 7)\nfc_h14 <- fabletools::forecast(fit_model, h = 14)\nfc_h21 <- fabletools::forecast(fit_model, h = 21)\nfc_h90 <- fabletools::forecast(fit_model, h = 57)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_sevilla_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(9))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_sevilla %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(9) &\n                               fecha > as.Date(\"2021-12-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Sevilla   Test    27.5  78.6  56.6   3.30 10.0  0.396 0.288 0.143\n2 arima_at2 Sevilla   Test    29.1  78.8  55.9   3.60  9.91 0.391 0.289 0.142\n3 Snaive    Sevilla   Test  -305.  368.  311.  -48.0  49.4  2.17  1.35  0.523\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_sevilla_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(16))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_sevilla %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(16) &\n                               fecha > as.Date(\"2021-12-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Sevilla   Test   131.  223.  156.  13.5  21.5  1.09 0.817 0.433\n2 arima_at2 Sevilla   Test   133.  224.  157.  13.9  21.4  1.09 0.822 0.432\n3 Snaive    Sevilla   Test  -297.  338.  299. -50.4  51.1  2.09 1.24  0.411\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_sevilla_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(23))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_sevilla %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(23) &\n                               fecha > as.Date(\"2021-12-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Sevilla   Test   118.  208.  154.   9.96  26.1  1.08 0.762 0.499\n2 arima_at2 Sevilla   Test   121.  209.  155.  10.4   26.0  1.08 0.767 0.498\n3 Snaive    Sevilla   Test  -380.  430.  381. -76.5   77.0  2.67 1.58  0.507\n\n\n\n\n57 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_sevilla_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(59))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_sevilla %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(59) &\n                               fecha > as.Date(\"2021-12-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Sevilla   Test   -49.7  208.  157.  -Inf   Inf  1.10 0.761 0.718\n2 arima_at2 Sevilla   Test   -47.4  207.  156.  -Inf   Inf  1.09 0.759 0.717\n3 Snaive    Sevilla   Test  -737.   850.  738.  -Inf   Inf  5.16 3.11  0.642"
  },
  {
    "objectID": "multivariate_temp.html",
    "href": "multivariate_temp.html",
    "title": "Multivariate (temperature) prediction",
    "section": "",
    "text": "Load packages:\nThe temporal limits of our prediction will be:"
  },
  {
    "objectID": "multivariate_temp.html#asturias",
    "href": "multivariate_temp.html#asturias",
    "title": "Multivariate (temperature) prediction",
    "section": "Asturias",
    "text": "Asturias\n\ndata_asturias <- covid_data %>% \n      filter(provincia == \"Asturias\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_asturias\n\n# A tsibble: 653 x 4 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed\n   <chr>     <date>         <dbl> <dbl>\n 1 Asturias  2020-06-15         0  16  \n 2 Asturias  2020-06-16         1  15.6\n 3 Asturias  2020-06-17         0  15.6\n 4 Asturias  2020-06-18         0  15.1\n 5 Asturias  2020-06-19         0  14.8\n 6 Asturias  2020-06-20         0  16.8\n 7 Asturias  2020-06-21         0  18.2\n 8 Asturias  2020-06-22         0  18.2\n 9 Asturias  2020-06-23         0  20  \n10 Asturias  2020-06-24         0  18.2\n# … with 643 more rows\n\n\n\ndata_asturias_train <- data_asturias %>% \n      filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_asturias_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-14\" \"2021-02-13\" \"2021-02-13\" \"2021-06-14\" \"2021-10-14\" \n\n\n\ndata_asturias_test <- data_asturias %>% \n      filter(fecha > as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_asturias_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-10-15\" \"2021-11-25\" \"2022-01-05\" \"2022-01-05\" \"2022-02-15\" \"2022-03-29\" \n\n\n\n# Lamba for num_casos\nlambda_asturias_casos <- data_asturias %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_casos\n\n[1] 0.2278229\n\n# Lamba for average temp\nlambda_asturias_tmed <- data_asturias %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_tmed\n\n[1] 1.056074\n\n\n\nfit_model <- data_asturias_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_asturias_casos) ~ \n                                    box_cox(tmed, lambda_asturias_tmed)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_asturias_casos) ~ \n                                    box_cox(tmed, lambda_asturias_tmed),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_asturias_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1                   arima_at2\n  <chr>                                   <model>                     <model>\n1 Asturias  <LM w/ ARIMA(3,1,1)(2,0,0)[7] errors> <LM w/ ARIMA(2,1,4) errors>\n# … with 1 more variable: Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>   \n1 Asturias  arima_at1  0.946   -673. 1362. 1362. 1396. <cpl [17]> <cpl [1]>\n2 Asturias  arima_at2  0.912   -664. 1345. 1345. 1378. <cpl [2]>  <cpl [4]>\n3 Asturias  Snaive     2.32      NA    NA    NA    NA  <NULL>     <NULL>   \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_…           <LM w/ ARIMA(2,1,4) errors>  0.912   -664. 1345. 1345. 1378.\n2 arima_… <LM w/ ARIMA(3,1,1)(2,0,0)[7] errors>  0.946   -673. 1362. 1362. 1396.\n3 Snaive                               <SNAIVE>  2.32      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1   10.6      0.159\n2 Asturias  arima_at2    8.12     0.322\n3 Asturias  Snaive     629.       0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    32.8   0.00309\n2 Asturias  arima_at2    23.6   0.0509 \n3 Asturias  Snaive      892.    0      \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    49.1  0.000485\n2 Asturias  arima_at2    33.3  0.0432  \n3 Asturias  Snaive      927.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=90)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1   118.     0.0237\n2 Asturias  arima_at2    86.6    0.582 \n3 Asturias  Snaive     1195.     0     \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_asturias_test %>%\n      select(-num_casos) %>%\n      slice(1:7)\ndata_fc_h14 <- data_asturias_test %>%\n      select(-num_casos) %>%\n      slice(1:14)\ndata_fc_h21 <- data_asturias_test %>%\n      select(-num_casos) %>%\n      slice(1:21)\ndata_fc_h90 <- data_asturias_test %>%\n      select(-num_casos) %>%\n      slice(1:90)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h90 <- fabletools::forecast(fit_model, new_data = data_fc_h90)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(9))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(9) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Asturias  Test   5.43 10.1   6.80  14.8  27.6 0.137 0.123 0.198  \n2 arima_at2 Asturias  Test   6.02  9.93  7.26  18.2  30.5 0.146 0.121 0.384  \n3 Snaive    Asturias  Test   2.41 14.0   9.98 -10.1  49.0 0.201 0.171 0.00766\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(16))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(16) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Asturias  Test  10.3   14.2  11.0 29.1   35.5 0.222 0.173  0.171\n2 arima_at2 Asturias  Test  10.9   14.1  11.5 32.0   38.1 0.232 0.172  0.303\n3 Snaive    Asturias  Test   6.69  16.0  11.4  8.17  41.5 0.229 0.195 -0.156\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(23))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(23) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Asturias  Test   9.72  13.4  10.4 27.1   32.5 0.209 0.164  0.0341\n2 arima_at2 Asturias  Test  10.6   13.7  11.0 31.0   35.1 0.222 0.167  0.127 \n3 Snaive    Asturias  Test   5.77  15.6  11.5  6.52  40.8 0.232 0.190 -0.223 \n\n\n\n\n90 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(92))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(92) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Asturias  Test   704. 1211.  704.  67.5  70.0  14.2  14.8 0.925\n2 arima_at2 Asturias  Test   713. 1221.  714.  71.1  72.9  14.4  14.9 0.926\n3 Snaive    Asturias  Test   702. 1213.  704.  60.0  71.7  14.2  14.8 0.925"
  },
  {
    "objectID": "multivariate_temp.html#barcelona",
    "href": "multivariate_temp.html#barcelona",
    "title": "Multivariate (temperature) prediction",
    "section": "Barcelona",
    "text": "Barcelona\n\ndata_Barcelona <- covid_data %>% \n      filter(provincia == \"Barcelona\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Barcelona\n\n# A tsibble: 653 x 4 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed\n   <chr>     <date>         <dbl> <dbl>\n 1 Barcelona 2020-06-15        62  21.2\n 2 Barcelona 2020-06-16        66  20.8\n 3 Barcelona 2020-06-17        70  20.3\n 4 Barcelona 2020-06-18        68  18.8\n 5 Barcelona 2020-06-19        65  20.4\n 6 Barcelona 2020-06-20        53  21.8\n 7 Barcelona 2020-06-21        38  22.8\n 8 Barcelona 2020-06-22        69  23.8\n 9 Barcelona 2020-06-23        95  23.4\n10 Barcelona 2020-06-24        44  23.6\n# … with 643 more rows\n\n\n\ndata_Barcelona_train <- data_Barcelona %>% \n      filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Barcelona_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-14\" \"2021-02-13\" \"2021-02-13\" \"2021-06-14\" \"2021-10-14\" \n\n\n\ndata_Barcelona_test <- data_Barcelona %>% \n      filter(fecha > as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Barcelona_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-10-15\" \"2021-11-25\" \"2022-01-05\" \"2022-01-05\" \"2022-02-15\" \"2022-03-29\" \n\n\n\n# Lamba for num_casos\nlambda_Barcelona_casos <- data_Barcelona %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_casos\n\n[1] 0.1434101\n\n# Lamba for average temp\nlambda_Barcelona_tmed <- data_Barcelona %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_tmed\n\n[1] 1.098957\n\n\n\nfit_model <- data_Barcelona_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Barcelona_casos) ~ \n                                    box_cox(tmed, lambda_Barcelona_tmed)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Barcelona_casos) ~ \n                                    box_cox(tmed, lambda_Barcelona_tmed),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Barcelona_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Barcelona <LM w/ ARIMA(0,1,3)(0,1,2)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots  \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>    <list>    \n1 Barcelona arima_at1  0.195   -291.  595.  595.  624. <cpl [0]> <cpl [17]>\n2 Barcelona arima_at2  0.187   -280.  575.  575.  604. <cpl [1]> <cpl [16]>\n3 Barcelona Snaive     0.964     NA    NA    NA    NA  <NULL>    <NULL>    \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(1,1,2)(0,1,2)[7] errors>  0.187   -280.  575.  575.  604.\n2 arima_… <LM w/ ARIMA(0,1,3)(0,1,2)[7] errors>  0.195   -291.  595.  595.  624.\n3 Snaive                               <SNAIVE>  0.964     NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Barcelona arima_at1   13.5     0.0615\n2 Barcelona arima_at2    3.11    0.874 \n3 Barcelona Snaive    1610.      0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Barcelona arima_at1   29.3    0.00944\n2 Barcelona arima_at2    9.65   0.787  \n3 Barcelona Snaive    2198.     0      \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Barcelona arima_at1    32.8    0.0484\n2 Barcelona arima_at2    14.3    0.856 \n3 Barcelona Snaive     2259.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=90)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Barcelona arima_at1   133.    0.00214\n2 Barcelona arima_at2    86.8   0.576  \n3 Barcelona Snaive     3453.    0      \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h90 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:90)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h90 <- fabletools::forecast(fit_model, new_data = data_fc_h90)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(9))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(9) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE     MPE  MAPE  MASE  RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl>   <dbl> <dbl> <dbl>  <dbl> <dbl>\n1 arima_at1 Barcelona Test   16.6  64.7  56.2   0.729  30.0 0.149 0.0975 0.327\n2 arima_at2 Barcelona Test   19.8  67.5  56.3   2.11   29.6 0.150 0.102  0.211\n3 Snaive    Barcelona Test  -21.0  79.0  67.8 -15.5    40.3 0.180 0.119  0.184\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(16))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(16) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Barcelona Test   36.6  75.7  59.2  10.6  27.1 0.157 0.114 0.308 \n2 arima_at2 Barcelona Test   39.1  78.5  60.5  11.7  27.4 0.161 0.118 0.245 \n3 Snaive    Barcelona Test  -15.3  87.1  76.0 -12.2  40.4 0.202 0.131 0.0610\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(23))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(23) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Barcelona Test  60.6   109.  78.0  16.3  29.7 0.207 0.165  0.206\n2 arima_at2 Barcelona Test  58.3   106.  76.7  15.5  29.5 0.204 0.160  0.122\n3 Snaive    Barcelona Test  -2.10  119.  90.4 -10.9  41.3 0.240 0.179 -0.239\n\n\n\n\n90 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(92))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(92) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Barcelona Test  5077. 9032. 5081.  72.5  75.6  13.5  13.6 0.868\n2 arima_at2 Barcelona Test  4972. 8914. 4977.  68.6  71.8  13.2  13.4 0.868\n3 Snaive    Barcelona Test  4916. 8890. 4939.  58.7  71.4  13.1  13.4 0.870"
  },
  {
    "objectID": "multivariate_temp.html#madrid",
    "href": "multivariate_temp.html#madrid",
    "title": "Multivariate (temperature) prediction",
    "section": "Madrid",
    "text": "Madrid\n\ndata_Madrid <- covid_data %>% \n      filter(provincia == \"Madrid\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Madrid\n\n# A tsibble: 653 x 4 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed\n   <chr>     <date>         <dbl> <dbl>\n 1 Madrid    2020-06-15       153  20.7\n 2 Madrid    2020-06-16        91  21  \n 3 Madrid    2020-06-17        93  20.2\n 4 Madrid    2020-06-18        85  21.9\n 5 Madrid    2020-06-19        78  22.6\n 6 Madrid    2020-06-20        67  23.4\n 7 Madrid    2020-06-21        42  25  \n 8 Madrid    2020-06-22        60  27.3\n 9 Madrid    2020-06-23        68  28.4\n10 Madrid    2020-06-24        49  28  \n# … with 643 more rows\n\n\n\ndata_Madrid_train <- data_Madrid %>% \n      filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Madrid_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-14\" \"2021-02-13\" \"2021-02-13\" \"2021-06-14\" \"2021-10-14\" \n\n\n\ndata_Madrid_test <- data_Madrid %>% \n      filter(fecha > as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Madrid_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-10-15\" \"2021-11-25\" \"2022-01-05\" \"2022-01-05\" \"2022-02-15\" \"2022-03-29\" \n\n\n\n# Lamba for num_casos\nlambda_Madrid_casos <- data_Madrid %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_casos\n\n[1] 0.06260614\n\n# Lamba for average temp\nlambda_Madrid_tmed <- data_Madrid %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_tmed\n\n[1] 0.936519\n\n\n\nfit_model <- data_Madrid_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Madrid_casos) ~ \n                                    box_cox(tmed, lambda_Madrid_tmed)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Madrid_casos) ~ \n                                    box_cox(tmed, lambda_Madrid_tmed),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Madrid_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Madrid    <LM w/ ARIMA(2,1,1)(1,1,1)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>    <list>   \n1 Madrid    arima_at1 0.0669   -33.4  80.8  81.1  110. <cpl [9]> <cpl [8]>\n2 Madrid    arima_at2 0.0669   -33.4  80.8  81.1  110. <cpl [9]> <cpl [8]>\n3 Madrid    Snaive    0.291     NA    NA    NA     NA  <NULL>    <NULL>   \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(2,1,1)(1,1,1)[7] errors> 0.0669   -33.4  80.8  81.1  110.\n2 arima_… <LM w/ ARIMA(2,1,1)(1,1,1)[7] errors> 0.0669   -33.4  80.8  81.1  110.\n3 Snaive                               <SNAIVE> 0.291     NA    NA    NA     NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    10.8     0.146\n2 Madrid    arima_at2    10.8     0.146\n3 Madrid    Snaive     1678.      0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    39.8  0.000272\n2 Madrid    arima_at2    39.8  0.000272\n3 Madrid    Snaive     2594.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    48.4  0.000605\n2 Madrid    arima_at2    48.4  0.000605\n3 Madrid    Snaive     2854.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=90)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    106.     0.126\n2 Madrid    arima_at2    106.     0.126\n3 Madrid    Snaive      3856.     0    \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h90 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:90)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h90 <- fabletools::forecast(fit_model, new_data = data_fc_h90)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(9))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(9) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Madrid    Test  135.   163.  144. 39.4   47.5 0.339 0.242 -0.0363\n2 arima_at2 Madrid    Test  135.   163.  144. 39.4   47.5 0.339 0.242 -0.0363\n3 Snaive    Madrid    Test   32.1  124.  105. -7.03  48.2 0.247 0.185 -0.109 \n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(16))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(16) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Madrid    Test  150.   178.  154. 45.1   49.4 0.364 0.265  0.0893\n2 arima_at2 Madrid    Test  150.   178.  154. 45.1   49.4 0.364 0.265  0.0893\n3 Snaive    Madrid    Test   26.3  126.  105. -8.58  46.6 0.246 0.188 -0.0472\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(23))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(23) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Madrid    Test  174.   210.  177. 50.0   52.8 0.418 0.313 0.287\n2 arima_at2 Madrid    Test  174.   210.  177. 50.0   52.8 0.418 0.313 0.287\n3 Snaive    Madrid    Test   34.8  140.  117. -8.01  48.6 0.275 0.209 0.131\n\n\n\n\n90 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(92))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(92) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Madrid    Test  5007. 8744. 5008.  81.8  82.4  11.8  13.0 0.840\n2 arima_at2 Madrid    Test  5007. 8744. 5008.  81.8  82.4  11.8  13.0 0.840\n3 Snaive    Madrid    Test  4763. 8564. 4792.  51.8  68.9  11.3  12.7 0.840"
  },
  {
    "objectID": "multivariate_temp.html#malaga",
    "href": "multivariate_temp.html#malaga",
    "title": "Multivariate (temperature) prediction",
    "section": "Malaga",
    "text": "Malaga\n\ndata_Malaga <- covid_data %>% \n      filter(provincia == \"Málaga\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Malaga\n\n# A tsibble: 653 x 4 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed\n   <chr>     <date>         <dbl> <dbl>\n 1 Málaga    2020-06-15         1  27.2\n 2 Málaga    2020-06-16         1  27.8\n 3 Málaga    2020-06-17         2  26.9\n 4 Málaga    2020-06-18         2  21.6\n 5 Málaga    2020-06-19         1  24.7\n 6 Málaga    2020-06-20         4  22.6\n 7 Málaga    2020-06-21         4  22.7\n 8 Málaga    2020-06-22         6  25  \n 9 Málaga    2020-06-23         8  25.6\n10 Málaga    2020-06-24        65  24.5\n# … with 643 more rows\n\n\n\ndata_Malaga_train <- data_Malaga %>% \n      filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Malaga_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-14\" \"2021-02-13\" \"2021-02-13\" \"2021-06-14\" \"2021-10-14\" \n\n\n\ndata_Malaga_test <- data_Malaga %>% \n      filter(fecha > as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Malaga_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-10-15\" \"2021-11-25\" \"2022-01-05\" \"2022-01-05\" \"2022-02-15\" \"2022-03-29\" \n\n\n\n# Lamba for num_casos\nlambda_Malaga_casos <- data_Malaga %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_casos\n\n[1] 0.2312255\n\n# Lamba for average temp\nlambda_Malaga_tmed <- data_Malaga %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_tmed\n\n[1] 0.6288527\n\n\n\nfit_model <- data_Malaga_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Malaga_casos) ~ \n                                    box_cox(tmed, lambda_Malaga_tmed)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Malaga_casos) ~ \n                                    box_cox(tmed, lambda_Malaga_tmed),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Malaga_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Málaga    <LM w/ ARIMA(4,1,0)(2,0,0)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>   \n1 Málaga    arima_at1  0.553   -545. 1105. 1105. 1139. <cpl [18]> <cpl [0]>\n2 Málaga    arima_at2  0.550   -543. 1102. 1103. 1136. <cpl [14]> <cpl [4]>\n3 Málaga    Snaive     2.15      NA    NA    NA    NA  <NULL>     <NULL>   \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(0,1,4)(2,0,0)[7] errors>  0.550   -543. 1102. 1103. 1136.\n2 arima_… <LM w/ ARIMA(4,1,0)(2,0,0)[7] errors>  0.553   -545. 1105. 1105. 1139.\n3 Snaive                               <SNAIVE>  2.15      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    6.37     0.497\n2 Málaga    arima_at2    2.44     0.932\n3 Málaga    Snaive    1361.       0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    20.2     0.125\n2 Málaga    arima_at2    17.1     0.252\n3 Málaga    Snaive     1956.      0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    26.7     0.179\n2 Málaga    arima_at2    23.1     0.336\n3 Málaga    Snaive     2100.      0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=90)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    131.   0.00301\n2 Málaga    arima_at2    119.   0.0227 \n3 Málaga    Snaive      3195.   0      \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h90 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:90)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h90 <- fabletools::forecast(fit_model, new_data = data_fc_h90)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(9))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(9) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE    MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Málaga    Test  10.2   19.3  16.7   7.44  35.8 0.170 0.114 0.0661\n2 arima_at2 Málaga    Test  10.7   19.8  17.2   8.32  36.8 0.175 0.117 0.0950\n3 Snaive    Málaga    Test  -4.00  22.9  19.8 -27.0   52.2 0.201 0.135 0.0123\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(16))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(16) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Málaga    Test  13.4   22.2  18.0  14.1  32.1 0.183 0.131  0.179 \n2 arima_at2 Málaga    Test  13.9   22.6  18.4  14.9  32.7 0.187 0.134  0.190 \n3 Snaive    Málaga    Test  -3.86  22.7  18.7 -22.4  43.6 0.190 0.134 -0.0973\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(23))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(23) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE   MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Málaga    Test  18.4    25.9  21.7  20.9  33.3 0.220 0.153 0.249 \n2 arima_at2 Málaga    Test  18.6    26.0  21.9  21.2  33.7 0.222 0.154 0.244 \n3 Snaive    Málaga    Test  -0.951  22.0  18.6 -14.8  37.9 0.188 0.130 0.0886\n\n\n\n\n90 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(92))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(92) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Málaga    Test   606. 1013.  607.  55.8  59.8  6.17  5.99 0.927\n2 arima_at2 Málaga    Test   596. 1001.  597.  54.1  58.3  6.07  5.91 0.926\n3 Snaive    Málaga    Test   620. 1049.  628.  44.9  62.3  6.37  6.20 0.929"
  },
  {
    "objectID": "multivariate_temp.html#sevilla",
    "href": "multivariate_temp.html#sevilla",
    "title": "Multivariate (temperature) prediction",
    "section": "Sevilla",
    "text": "Sevilla\n\ndata_Sevilla <- covid_data %>% \n      filter(provincia == \"Sevilla\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Sevilla\n\n# A tsibble: 653 x 4 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed\n   <chr>     <date>         <dbl> <dbl>\n 1 Sevilla   2020-06-15         2  23.1\n 2 Sevilla   2020-06-16         1  24.0\n 3 Sevilla   2020-06-17         0  24.9\n 4 Sevilla   2020-06-18         0  25.8\n 5 Sevilla   2020-06-19         0  26.6\n 6 Sevilla   2020-06-20         0  27.5\n 7 Sevilla   2020-06-21         0  28.4\n 8 Sevilla   2020-06-22         1  29.3\n 9 Sevilla   2020-06-23         0  30.2\n10 Sevilla   2020-06-24         1  29.4\n# … with 643 more rows\n\n\n\ndata_Sevilla_train <- data_Sevilla %>% \n      filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Sevilla_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-14\" \"2021-02-13\" \"2021-02-13\" \"2021-06-14\" \"2021-10-14\" \n\n\n\ndata_Sevilla_test <- data_Sevilla %>% \n      filter(fecha > as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Sevilla_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-10-15\" \"2021-11-25\" \"2022-01-05\" \"2022-01-05\" \"2022-02-15\" \"2022-03-29\" \n\n\n\n# Lamba for num_casos\nlambda_Sevilla_casos <- data_Sevilla %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_casos\n\n[1] 0.1933674\n\n# Lamba for average temp\nlambda_Sevilla_tmed <- data_Sevilla %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_tmed\n\n[1] 0.9333023\n\n\n\nfit_model <- data_Sevilla_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Sevilla_casos) ~ \n                                    box_cox(tmed, lambda_Sevilla_tmed)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Sevilla_casos) ~ \n                                    box_cox(tmed, lambda_Sevilla_tmed),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Sevilla_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Sevilla   <LM w/ ARIMA(3,1,1)(2,0,0)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>   \n1 Sevilla   arima_at1  0.924   -669. 1355. 1355. 1388. <cpl [17]> <cpl [1]>\n2 Sevilla   arima_at2  0.922   -669. 1354. 1354. 1387. <cpl [18]> <cpl [0]>\n3 Sevilla   Snaive     2.02      NA    NA    NA    NA  <NULL>     <NULL>   \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(4,1,0)(2,0,0)[7] errors>  0.922   -669. 1354. 1354. 1387.\n2 arima_… <LM w/ ARIMA(3,1,1)(2,0,0)[7] errors>  0.924   -669. 1355. 1355. 1388.\n3 Snaive                               <SNAIVE>  2.02      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    8.68     0.276\n2 Sevilla   arima_at2    7.66     0.363\n3 Sevilla   Snaive     757.       0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    24.1    0.0446\n2 Sevilla   arima_at2    23.3    0.0555\n3 Sevilla   Snaive     1110.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    37.5    0.0147\n2 Sevilla   arima_at2    36.7    0.0181\n3 Sevilla   Snaive     1235.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=90)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    103.     0.166\n2 Sevilla   arima_at2    102.     0.182\n3 Sevilla   Snaive      1692.     0    \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h90 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:90)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h90 <- fabletools::forecast(fit_model, new_data = data_fc_h90)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(9))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(9) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE   MASE  RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>  <dbl>   <dbl>\n1 arima_at1 Sevilla   Test   7.42  11.3  8.79  19.6  24.7 0.0869 0.0717 -0.137 \n2 arima_at2 Sevilla   Test   7.51  11.4  8.93  19.8  25.1 0.0882 0.0722 -0.123 \n3 Snaive    Sevilla   Test  -5.85  16.0 13.7  -22.0  40.6 0.135  0.102   0.0310\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(16))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(16) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE    MPE  MAPE   MASE  RMSSE   ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl>  <dbl>  <dbl>  <dbl>\n1 arima_at1 Sevilla   Test    5.00  9.90  8.02   8.47  27.5 0.0793 0.0628 -0.116\n2 arima_at2 Sevilla   Test    5.13  9.96  8.10   8.97  27.6 0.0801 0.0631 -0.108\n3 Snaive    Sevilla   Test  -12.5  19.3  16.4  -57.6   66.9 0.162  0.122   0.275\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(23))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(23) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE   MPE  MAPE   MASE  RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>  <dbl> <dbl>\n1 arima_at1 Sevilla   Test    6.47  11.8  8.94  11.5  26.9 0.0883 0.0745 0.191\n2 arima_at2 Sevilla   Test    6.59  11.8  9.01  12.0  26.9 0.0890 0.0749 0.194\n3 Snaive    Sevilla   Test  -13.9   22.1 19.1  -60.8  72.0 0.189  0.140  0.327\n\n\n\n\n90 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(92))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(92) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Sevilla   Test   686. 1166.  687.  61.8  66.2  6.79  7.39 0.892\n2 arima_at2 Sevilla   Test   686. 1165.  687.  61.9  66.2  6.78  7.39 0.892\n3 Snaive    Sevilla   Test   665. 1161.  677.  31.7  74.6  6.69  7.36 0.892"
  },
  {
    "objectID": "multivariate_temp.html#asturias-1",
    "href": "multivariate_temp.html#asturias-1",
    "title": "Multivariate (temperature) prediction",
    "section": "Asturias",
    "text": "Asturias\n\ndata_asturias <- covid_data %>% \n      filter(provincia == \"Asturias\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_asturias\n\n# A tsibble: 653 x 4 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed\n   <chr>     <date>         <dbl> <dbl>\n 1 Asturias  2020-06-15         0  16  \n 2 Asturias  2020-06-16         1  15.6\n 3 Asturias  2020-06-17         0  15.6\n 4 Asturias  2020-06-18         0  15.1\n 5 Asturias  2020-06-19         0  14.8\n 6 Asturias  2020-06-20         0  16.8\n 7 Asturias  2020-06-21         0  18.2\n 8 Asturias  2020-06-22         0  18.2\n 9 Asturias  2020-06-23         0  20  \n10 Asturias  2020-06-24         0  18.2\n# … with 643 more rows\n\n\n\ndata_asturias_train <- data_asturias %>% \n      filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_asturias_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-11-10\" \"2021-04-08\" \"2021-04-08\" \"2021-09-04\" \"2022-01-31\" \n\n\n\ndata_asturias_test <- data_asturias %>% \n      filter(fecha > as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_asturias_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2022-02-01\" \"2022-02-15\" \"2022-03-01\" \"2022-03-01\" \"2022-03-15\" \"2022-03-29\" \n\n\n\n# Lamba for num_casos\nlambda_asturias_casos <- data_asturias %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_casos\n\n[1] 0.2278229\n\n# Lamba for average temp\nlambda_asturias_tmed <- data_asturias %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_tmed\n\n[1] 1.056074\n\n\n\nfit_model <- data_asturias_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_asturias_casos) ~ \n                                    box_cox(tmed, lambda_asturias_tmed)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_asturias_casos) ~ \n                                    box_cox(tmed, lambda_asturias_tmed),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_asturias_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Asturias  <LM w/ ARIMA(3,1,1)(2,0,0)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>   \n1 Asturias  arima_at1  0.917   -816. 1648. 1648. 1683. <cpl [17]> <cpl [1]>\n2 Asturias  arima_at2  0.895   -810. 1631. 1631. 1653. <cpl [7]>  <cpl [8]>\n3 Asturias  Snaive     2.53      NA    NA    NA    NA  <NULL>     <NULL>   \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(0,1,1)(1,0,1)[7] errors>  0.895   -810. 1631. 1631. 1653.\n2 arima_… <LM w/ ARIMA(3,1,1)(2,0,0)[7] errors>  0.917   -816. 1648. 1648. 1683.\n3 Snaive                               <SNAIVE>  2.53      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    13.8    0.0544\n2 Asturias  arima_at2    13.0    0.0717\n3 Asturias  Snaive      981.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    38.1  0.000503\n2 Asturias  arima_at2    34.9  0.00150 \n3 Asturias  Snaive     1393.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    59.1 0.0000173\n2 Asturias  arima_at2    48.9 0.000522 \n3 Asturias  Snaive     1470.  0        \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=57)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1   100.   0.000364\n2 Asturias  arima_at2    78.5  0.0308  \n3 Asturias  Snaive     1527.   0       \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_asturias_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_asturias_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_asturias_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h57 <- data_asturias_test %>% \n      select(-num_casos) %>% \n      slice(1:57)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h57 <- fabletools::forecast(fit_model, new_data = data_fc_h57)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Asturias  Test  -174.  274.  253. -25.3  30.3  2.61  1.25  0.192\n2 arima_at2 Asturias  Test  -256.  335.  318. -33.9  37.9  3.29  1.52  0.159\n3 Snaive    Asturias  Test  -570.  586.  570. -62.8  62.8  5.89  2.66 -0.550\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Asturias  Test  -273.  334.  313.  -44.4  46.9  3.23  1.52 0.375\n2 arima_at2 Asturias  Test  -395.  449.  426.  -61.1  63.1  4.40  2.04 0.443\n3 Snaive    Asturias  Test  -769.  812.  769. -107.  107.   7.94  3.69 0.299\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Asturias  Test  -359.  414.  385.  -75.2  76.8  3.98  1.88 0.534\n2 arima_at2 Asturias  Test  -495.  545.  516.  -98.4  99.8  5.34  2.48 0.595\n3 Snaive    Asturias  Test  -920.  980.  920. -168.  168.   9.50  4.46 0.437\n\n\n\n\n57 days\n\n# Plots\nfc_h57 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(57))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h57\")\n\n\n\n\n\nfc_h57 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(57) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h57\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h57, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Asturias  Test   -583.  634.  592.  -Inf   Inf  6.12  2.88 0.720\n2 arima_at2 Asturias  Test   -694.  735.  702.  -Inf   Inf  7.25  3.34 0.712\n3 Snaive    Asturias  Test  -1282. 1359. 1282.  -Inf   Inf 13.3   6.18 0.471"
  },
  {
    "objectID": "multivariate_temp.html#barcelona-1",
    "href": "multivariate_temp.html#barcelona-1",
    "title": "Multivariate (temperature) prediction",
    "section": "Barcelona",
    "text": "Barcelona\n\ndata_Barcelona <- covid_data %>% \n      filter(provincia == \"Barcelona\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Barcelona\n\n# A tsibble: 653 x 4 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed\n   <chr>     <date>         <dbl> <dbl>\n 1 Barcelona 2020-06-15        62  21.2\n 2 Barcelona 2020-06-16        66  20.8\n 3 Barcelona 2020-06-17        70  20.3\n 4 Barcelona 2020-06-18        68  18.8\n 5 Barcelona 2020-06-19        65  20.4\n 6 Barcelona 2020-06-20        53  21.8\n 7 Barcelona 2020-06-21        38  22.8\n 8 Barcelona 2020-06-22        69  23.8\n 9 Barcelona 2020-06-23        95  23.4\n10 Barcelona 2020-06-24        44  23.6\n# … with 643 more rows\n\n\n\ndata_Barcelona_train <- data_Barcelona %>% \n      filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_Barcelona_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-11-10\" \"2021-04-08\" \"2021-04-08\" \"2021-09-04\" \"2022-01-31\" \n\n\n\ndata_Barcelona_test <- data_Barcelona %>% \n      filter(fecha > as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_Barcelona_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2022-02-01\" \"2022-02-15\" \"2022-03-01\" \"2022-03-01\" \"2022-03-15\" \"2022-03-29\" \n\n\n\n# Lamba for num_casos\nlambda_Barcelona_casos <- data_Barcelona %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_casos\n\n[1] 0.1434101\n\n# Lamba for average temp\nlambda_Barcelona_tmed <- data_Barcelona %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_tmed\n\n[1] 1.098957\n\n\n\nfit_model <- data_Barcelona_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Barcelona_casos) ~ \n                                    box_cox(tmed, lambda_Barcelona_tmed)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Barcelona_casos) ~ \n                                    box_cox(tmed, lambda_Barcelona_tmed),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Barcelona_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Barcelona <LM w/ ARIMA(1,0,2)(0,1,1)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>    <list>   \n1 Barcelona arima_at1  0.342   -521. 1054. 1054. 1080. <cpl [1]> <cpl [9]>\n2 Barcelona arima_at2  0.328   -510. 1035. 1035. 1070. <cpl [4]> <cpl [8]>\n3 Barcelona Snaive     1.26      NA    NA    NA    NA  <NULL>    <NULL>   \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(4,0,1)(0,1,1)[7] errors>  0.328   -510. 1035. 1035. 1070.\n2 arima_… <LM w/ ARIMA(1,0,2)(0,1,1)[7] errors>  0.342   -521. 1054. 1054. 1080.\n3 Snaive                               <SNAIVE>  1.26      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat   lb_pvalue\n  <chr>     <chr>       <dbl>       <dbl>\n1 Barcelona arima_at1    35.9 0.00000742 \n2 Barcelona arima_at2    43.1 0.000000313\n3 Barcelona Snaive     1654.  0          \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat   lb_pvalue\n  <chr>     <chr>       <dbl>       <dbl>\n1 Barcelona arima_at1    54.6 0.00000102 \n2 Barcelona arima_at2    59.0 0.000000174\n3 Barcelona Snaive     2253.  0          \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat   lb_pvalue\n  <chr>     <chr>       <dbl>       <dbl>\n1 Barcelona arima_at1    60.9 0.00000917 \n2 Barcelona arima_at2    70.9 0.000000253\n3 Barcelona Snaive     2362.  0          \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=57)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Barcelona arima_at1    164.  2.71e-12\n2 Barcelona arima_at2    162.  4.88e-12\n3 Barcelona Snaive      2651.  0       \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h57 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:57)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h57 <- fabletools::forecast(fit_model, new_data = data_fc_h57)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE   MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Barcelona Test  -4666. 4908. 4666. -63.7  63.7  5.86 2.51  -0.0314\n2 arima_at2 Barcelona Test  -1704. 1754. 1704. -22.3  22.3  2.14 0.896 -0.328 \n3 Snaive    Barcelona Test  -7870. 8139. 7870. -99.0  99.0  9.88 4.16   0.551 \n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME   RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl>  <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Barcelona Test  -6738.  7266. 6738. -136.  136.   8.46 3.71  0.459\n2 arima_at2 Barcelona Test  -1843.  1947. 1843.  -33.4  33.4  2.31 0.994 0.180\n3 Snaive    Barcelona Test  -9985. 10606. 9985. -188.  188.  12.5  5.42  0.548\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type      ME   RMSE    MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>   <dbl>  <dbl>  <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Barcelona Test   -8063.  8669.  8063. -206.  206.  10.1  4.43  0.569\n2 arima_at2 Barcelona Test   -1589.  1743.  1589.  -33.3  33.3  2.00 0.890 0.446\n3 Snaive    Barcelona Test  -11275. 12018. 11275. -272.  272.  14.2  6.14  0.602\n\n\n\n\n57 days\n\n# Plots\nfc_h57 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(57))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h57\")\n\n\n\n\n\nfc_h57 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(57) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h57\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h57, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type      ME   RMSE    MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>   <dbl>  <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Barcelona Test  -12180. 13056. 12180.  -Inf   Inf 15.3  6.67  0.704\n2 arima_at2 Barcelona Test    -582.  1198.   942.  -Inf   Inf  1.18 0.612 0.806\n3 Snaive    Barcelona Test  -14809. 15796. 14809.  -Inf   Inf 18.6  8.06  0.592"
  },
  {
    "objectID": "multivariate_temp.html#madrid-1",
    "href": "multivariate_temp.html#madrid-1",
    "title": "Multivariate (temperature) prediction",
    "section": "Madrid",
    "text": "Madrid\n\ndata_Madrid <- covid_data %>% \n      filter(provincia == \"Madrid\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Madrid\n\n# A tsibble: 653 x 4 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed\n   <chr>     <date>         <dbl> <dbl>\n 1 Madrid    2020-06-15       153  20.7\n 2 Madrid    2020-06-16        91  21  \n 3 Madrid    2020-06-17        93  20.2\n 4 Madrid    2020-06-18        85  21.9\n 5 Madrid    2020-06-19        78  22.6\n 6 Madrid    2020-06-20        67  23.4\n 7 Madrid    2020-06-21        42  25  \n 8 Madrid    2020-06-22        60  27.3\n 9 Madrid    2020-06-23        68  28.4\n10 Madrid    2020-06-24        49  28  \n# … with 643 more rows\n\n\n\ndata_Madrid_train <- data_Madrid %>% \n      filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_Madrid_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-11-10\" \"2021-04-08\" \"2021-04-08\" \"2021-09-04\" \"2022-01-31\" \n\n\n\ndata_Madrid_test <- data_Madrid %>% \n      filter(fecha > as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_Madrid_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2022-02-01\" \"2022-02-15\" \"2022-03-01\" \"2022-03-01\" \"2022-03-15\" \"2022-03-29\" \n\n\n\n# Lamba for num_casos\nlambda_Madrid_casos <- data_Madrid %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_casos\n\n[1] 0.06260614\n\n# Lamba for average temp\nlambda_Madrid_tmed <- data_Madrid %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_tmed\n\n[1] 0.936519\n\n\n\nfit_model <- data_Madrid_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Madrid_casos) ~ \n                                    box_cox(tmed, lambda_Madrid_tmed)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Madrid_casos) ~ \n                                    box_cox(tmed, lambda_Madrid_tmed),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Madrid_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Madrid    <LM w/ ARIMA(2,0,2)(0,1,2)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots  \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>    <list>    \n1 Madrid    arima_at1  0.133   -240.  496.  496.  531. <cpl [2]> <cpl [16]>\n2 Madrid    arima_at2  0.133   -240.  496.  496.  531. <cpl [2]> <cpl [16]>\n3 Madrid    Snaive     0.412     NA    NA    NA    NA  <NULL>    <NULL>    \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(2,0,2)(0,1,2)[7] errors>  0.133   -240.  496.  496.  531.\n2 arima_… <LM w/ ARIMA(2,0,2)(0,1,2)[7] errors>  0.133   -240.  496.  496.  531.\n3 Snaive                               <SNAIVE>  0.412     NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    24.2   0.00104\n2 Madrid    arima_at2    24.2   0.00104\n3 Madrid    Snaive     1617.    0      \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    37.9  0.000530\n2 Madrid    arima_at2    37.9  0.000530\n3 Madrid    Snaive     2282.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    47.4  0.000825\n2 Madrid    arima_at2    47.4  0.000825\n3 Madrid    Snaive     2422.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=57)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat  lb_pvalue\n  <chr>     <chr>       <dbl>      <dbl>\n1 Madrid    arima_at1    122. 0.00000139\n2 Madrid    arima_at2    122. 0.00000139\n3 Madrid    Snaive      2762. 0         \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h57 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:57)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h57 <- fabletools::forecast(fit_model, new_data = data_fc_h57)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE    MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Madrid    Test    464.  796.  632.   8.60  11.7 0.846 0.446 0.0623\n2 arima_at2 Madrid    Test    464.  796.  632.   8.60  11.7 0.846 0.446 0.0623\n3 Snaive    Madrid    Test  -1836. 2070. 1836. -36.2   36.2 2.46  1.16  0.541 \n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Madrid    Test    179.  613.  463.   3.20  10.8 0.620 0.343 0.206\n2 arima_at2 Madrid    Test    179.  613.  463.   3.20  10.8 0.620 0.343 0.206\n3 Snaive    Madrid    Test  -2914. 3386. 2914. -77.1   77.1 3.90  1.90  0.466\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Madrid    Test   -216.  839.  654.  -16.1  26.0 0.875 0.470 0.503\n2 arima_at2 Madrid    Test   -216.  839.  654.  -16.1  26.0 0.875 0.470 0.503\n3 Snaive    Madrid    Test  -3903. 4584. 3903. -158.  158.  5.23  2.57  0.574\n\n\n\n\n57 days\n\n# Plots\nfc_h57 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(57))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h57\")\n\n\n\n\n\nfc_h57 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(57) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h57\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h57, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Madrid    Test  -1509. 2183. 1670. -2106. 2110.  2.24  1.22 0.698\n2 arima_at2 Madrid    Test  -1509. 2183. 1670. -2106. 2110.  2.24  1.22 0.698\n3 Snaive    Madrid    Test  -6507. 7446. 6507. -4965. 4965.  8.71  4.17 0.627"
  },
  {
    "objectID": "multivariate_temp.html#malaga-1",
    "href": "multivariate_temp.html#malaga-1",
    "title": "Multivariate (temperature) prediction",
    "section": "Malaga",
    "text": "Malaga\n\ndata_Malaga <- covid_data %>% \n      filter(provincia == \"Málaga\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Malaga\n\n# A tsibble: 653 x 4 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed\n   <chr>     <date>         <dbl> <dbl>\n 1 Málaga    2020-06-15         1  27.2\n 2 Málaga    2020-06-16         1  27.8\n 3 Málaga    2020-06-17         2  26.9\n 4 Málaga    2020-06-18         2  21.6\n 5 Málaga    2020-06-19         1  24.7\n 6 Málaga    2020-06-20         4  22.6\n 7 Málaga    2020-06-21         4  22.7\n 8 Málaga    2020-06-22         6  25  \n 9 Málaga    2020-06-23         8  25.6\n10 Málaga    2020-06-24        65  24.5\n# … with 643 more rows\n\n\n\ndata_Malaga_train <- data_Malaga %>% \n      filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_Malaga_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-11-10\" \"2021-04-08\" \"2021-04-08\" \"2021-09-04\" \"2022-01-31\" \n\n\n\ndata_Malaga_test <- data_Malaga %>% \n      filter(fecha > as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_Malaga_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2022-02-01\" \"2022-02-15\" \"2022-03-01\" \"2022-03-01\" \"2022-03-15\" \"2022-03-29\" \n\n\n\n# Lamba for num_casos\nlambda_Malaga_casos <- data_Malaga %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_casos\n\n[1] 0.2312255\n\n# Lamba for average temp\nlambda_Malaga_tmed <- data_Malaga %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_tmed\n\n[1] 0.6288527\n\n\n\nfit_model <- data_Malaga_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Malaga_casos) ~ \n                                    box_cox(tmed, lambda_Malaga_tmed)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Malaga_casos) ~ \n                                    box_cox(tmed, lambda_Malaga_tmed),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Malaga_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Málaga    <LM w/ ARIMA(4,1,0)(2,0,0)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>   \n1 Málaga    arima_at1  0.650   -715. 1446. 1446. 1481. <cpl [18]> <cpl [0]>\n2 Málaga    arima_at2  0.628   -706. 1425. 1425. 1456. <cpl [10]> <cpl [7]>\n3 Málaga    Snaive     2.41      NA    NA    NA    NA  <NULL>     <NULL>   \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(3,1,0)(1,0,1)[7] errors>  0.628   -706. 1425. 1425. 1456.\n2 arima_… <LM w/ ARIMA(4,1,0)(2,0,0)[7] errors>  0.650   -715. 1446. 1446. 1481.\n3 Snaive                               <SNAIVE>  2.41      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    8.29    0.308 \n2 Málaga    arima_at2   15.2     0.0335\n3 Málaga    Snaive    1621.      0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    28.4   0.0124 \n2 Málaga    arima_at2    35.7   0.00115\n3 Málaga    Snaive     2376.    0      \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    47.6  0.000771\n2 Málaga    arima_at2    48.3  0.000621\n3 Málaga    Snaive     2555.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=57)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    100. 0.000338 \n2 Málaga    arima_at2    112. 0.0000197\n3 Málaga    Snaive      3422. 0        \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h57 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:57)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h57 <- fabletools::forecast(fit_model, new_data = data_fc_h57)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE    MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Málaga    Test    45.0  168.  128.  -1.35  21.2 0.965 0.680 0.0875\n2 arima_at2 Málaga    Test   -17.6  158.  112. -11.6   21.6 0.851 0.640 0.209 \n3 Snaive    Málaga    Test  -170.   240.  191. -33.7   35.9 1.45  0.968 0.246 \n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE     MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>   <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Málaga    Test   149.   266.  204.  11.6    26.7  1.54 1.08  0.282 \n2 arima_at2 Málaga    Test    66.4  214.  169.  -0.972  25.7  1.28 0.866 0.260 \n3 Snaive    Málaga    Test  -141.   223.  170. -28.9    31.8  1.28 0.899 0.0239\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Málaga    Test   137.   249.  183.  12.1   24.5  1.38 1.01  0.388\n2 arima_at2 Málaga    Test    48.9  195.  148.  -2.29  23.1  1.12 0.786 0.354\n3 Snaive    Málaga    Test  -208.   279.  227. -41.4   43.4  1.72 1.13  0.172\n\n\n\n\n57 days\n\n# Plots\nfc_h57 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(57))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h57\")\n\n\n\n\n\nfc_h57 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(57) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h57\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h57, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Málaga    Test    36.7  237.  175.  -Inf   Inf  1.33 0.957 0.556\n2 arima_at2 Málaga    Test   -24.7  208.  158.  -Inf   Inf  1.19 0.842 0.501\n3 Snaive    Málaga    Test  -436.   525.  443.  -Inf   Inf  3.35 2.12  0.513"
  },
  {
    "objectID": "multivariate_temp.html#sevilla-1",
    "href": "multivariate_temp.html#sevilla-1",
    "title": "Multivariate (temperature) prediction",
    "section": "Sevilla",
    "text": "Sevilla\n\ndata_Sevilla <- covid_data %>% \n      filter(provincia == \"Sevilla\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Sevilla\n\n# A tsibble: 653 x 4 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed\n   <chr>     <date>         <dbl> <dbl>\n 1 Sevilla   2020-06-15         2  23.1\n 2 Sevilla   2020-06-16         1  24.0\n 3 Sevilla   2020-06-17         0  24.9\n 4 Sevilla   2020-06-18         0  25.8\n 5 Sevilla   2020-06-19         0  26.6\n 6 Sevilla   2020-06-20         0  27.5\n 7 Sevilla   2020-06-21         0  28.4\n 8 Sevilla   2020-06-22         1  29.3\n 9 Sevilla   2020-06-23         0  30.2\n10 Sevilla   2020-06-24         1  29.4\n# … with 643 more rows\n\n\n\ndata_Sevilla_train <- data_Sevilla %>% \n      filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_Sevilla_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-11-10\" \"2021-04-08\" \"2021-04-08\" \"2021-09-04\" \"2022-01-31\" \n\n\n\ndata_Sevilla_test <- data_Sevilla %>% \n      filter(fecha > as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_Sevilla_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2022-02-01\" \"2022-02-15\" \"2022-03-01\" \"2022-03-01\" \"2022-03-15\" \"2022-03-29\" \n\n\n\n# Lamba for num_casos\nlambda_Sevilla_casos <- data_Sevilla %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_casos\n\n[1] 0.1933674\n\n# Lamba for average temp\nlambda_Sevilla_tmed <- data_Sevilla %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_tmed\n\n[1] 0.9333023\n\n\n\nfit_model <- data_Sevilla_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Sevilla_casos) ~ \n                                    box_cox(tmed, lambda_Sevilla_tmed)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Sevilla_casos) ~ \n                                    box_cox(tmed, lambda_Sevilla_tmed),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Sevilla_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Sevilla   <LM w/ ARIMA(3,1,1)(2,0,0)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>   \n1 Sevilla   arima_at1  0.961   -832. 1679. 1679. 1714. <cpl [17]> <cpl [1]>\n2 Sevilla   arima_at2  0.961   -831. 1679. 1679. 1714. <cpl [18]> <cpl [0]>\n3 Sevilla   Snaive     2.23      NA    NA    NA    NA  <NULL>     <NULL>   \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(4,1,0)(2,0,0)[7] errors>  0.961   -831. 1679. 1679. 1714.\n2 arima_… <LM w/ ARIMA(3,1,1)(2,0,0)[7] errors>  0.961   -832. 1679. 1679. 1714.\n3 Snaive                               <SNAIVE>  2.23      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    6.88     0.441\n2 Sevilla   arima_at2    6.06     0.533\n3 Sevilla   Snaive     965.       0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    27.0    0.0190\n2 Sevilla   arima_at2    26.4    0.0232\n3 Sevilla   Snaive     1403.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    37.9    0.0132\n2 Sevilla   arima_at2    37.3    0.0155\n3 Sevilla   Snaive     1510.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=57)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    76.9    0.0406\n2 Sevilla   arima_at2    76.4    0.0439\n3 Sevilla   Snaive     1813.     0     \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h57 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:57)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h57 <- fabletools::forecast(fit_model, new_data = data_fc_h57)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Sevilla   Test    35.3  79.3  53.4   4.72  9.49 0.373 0.291 0.152\n2 arima_at2 Sevilla   Test    37.0  79.8  53.3   5.02  9.48 0.372 0.292 0.149\n3 Snaive    Sevilla   Test  -305.  368.  311.  -48.0  49.4  2.17  1.35  0.523\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Sevilla   Test   139.  228.  158.  15.1  21.4  1.10 0.834 0.436\n2 arima_at2 Sevilla   Test   141.  229.  158.  15.5  21.5  1.11 0.839 0.435\n3 Snaive    Sevilla   Test  -297.  338.  299. -50.4  51.1  2.09 1.24  0.411\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Sevilla   Test   128.  214.  157.  11.9  26.2  1.10 0.784 0.502\n2 arima_at2 Sevilla   Test   130.  215.  158.  12.3  26.3  1.11 0.789 0.501\n3 Snaive    Sevilla   Test  -380.  430.  381. -76.5  77.0  2.67 1.58  0.507\n\n\n\n\n57 days\n\n# Plots\nfc_h57 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(57))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h57\")\n\n\n\n\n\nfc_h57 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(57) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h57\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h57, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Sevilla   Test   -36.1  203.  151.  -Inf   Inf  1.06 0.744 0.710\n2 arima_at2 Sevilla   Test   -34.1  203.  151.  -Inf   Inf  1.05 0.743 0.709\n3 Snaive    Sevilla   Test  -737.   850.  738.  -Inf   Inf  5.16 3.11  0.642"
  },
  {
    "objectID": "multivariate.html",
    "href": "multivariate.html",
    "title": "Multivariate (INE mobility + temp) prediction",
    "section": "",
    "text": "Load packages:\nThe temporal limits of our prediction will be:"
  },
  {
    "objectID": "multivariate.html#asturias",
    "href": "multivariate.html#asturias",
    "title": "Multivariate (INE mobility + temp) prediction",
    "section": "Asturias",
    "text": "Asturias\n\ndata_asturias <- covid_data %>% \n      filter(provincia == \"Asturias\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed, mob_flujo) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_asturias\n\n# A tsibble: 563 x 5 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed mob_flujo\n   <chr>     <date>         <dbl> <dbl>     <dbl>\n 1 Asturias  2020-06-15         0  16        19.4\n 2 Asturias  2020-06-16         1  15.6      19.5\n 3 Asturias  2020-06-17         0  15.6      19.7\n 4 Asturias  2020-06-18         0  15.1      20.5\n 5 Asturias  2020-06-19         0  14.8      21.0\n 6 Asturias  2020-06-20         0  16.8      19.8\n 7 Asturias  2020-06-21         0  18.2      20.2\n 8 Asturias  2020-06-22         0  18.2      20.6\n 9 Asturias  2020-06-23         0  20        21.1\n10 Asturias  2020-06-24         0  18.2      21.5\n# … with 553 more rows\n\n\n\ndata_asturias_train <- data_asturias %>% \n      filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_asturias_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-14\" \"2021-02-13\" \"2021-02-13\" \"2021-06-14\" \"2021-10-14\" \n\n\n\ndata_asturias_test <- data_asturias %>% \n      filter(fecha > as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_asturias_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-10-15\" \"2021-11-02\" \"2021-11-21\" \"2021-11-21\" \"2021-12-10\" \"2021-12-29\" \n\n\n\n# Lamba for num_casos\nlambda_asturias_casos <- data_asturias %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_casos\n\n[1] 0.2493395\n\n# Lamba for average temp\nlambda_asturias_tmed <- data_asturias %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_tmed\n\n[1] 1.142823\n\n# Lamba for mobility\nlambda_asturias_mobil <- data_asturias %>%\n      features(mob_flujo, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_mobil\n\n[1] 1.459993\n\n\n\nfit_model <- data_asturias_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_asturias_casos) ~ \n                                    box_cox(tmed, lambda_asturias_tmed) + \n                                    box_cox(mob_flujo, lambda_asturias_mobil)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_asturias_casos) ~ \n                                    box_cox(tmed, lambda_asturias_tmed) + \n                                    box_cox(mob_flujo, lambda_asturias_mobil),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_asturias_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Asturias  <LM w/ ARIMA(2,0,2)(0,1,1)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots  \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>    <list>    \n1 Asturias  arima_at1   1.02   -687. 1392. 1392. 1429. <cpl [2]> <cpl [9]> \n2 Asturias  arima_at2   1.00   -683. 1386. 1386. 1428. <cpl [9]> <cpl [15]>\n3 Asturias  Snaive      2.66     NA    NA    NA    NA  <NULL>    <NULL>    \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(2,0,1)(1,1,2)[7] errors>   1.00   -683. 1386. 1386. 1428.\n2 arima_… <LM w/ ARIMA(2,0,2)(0,1,1)[7] errors>   1.02   -687. 1392. 1392. 1429.\n3 Snaive                               <SNAIVE>   2.66     NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    15.7    0.0281\n2 Asturias  arima_at2    10.4    0.166 \n3 Asturias  Snaive      701.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    36.7  0.000812\n2 Asturias  arima_at2    35.3  0.00132 \n3 Asturias  Snaive      972.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    42.4   0.00377\n2 Asturias  arima_at2    39.9   0.00773\n3 Asturias  Snaive     1003.    0      \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=90)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1   110.     0.0782\n2 Asturias  arima_at2    96.9    0.290 \n3 Asturias  Snaive     1324.     0     \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_asturias_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_asturias_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_asturias_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h90 <- data_asturias_test %>% \n      select(-num_casos) %>% \n      slice(1:90)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h90 <- fabletools::forecast(fit_model, new_data = data_fc_h90)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Asturias  Test   4.47  8.72  6.22 10.5   26.9 0.125 0.106 0.344 \n2 arima_at2 Asturias  Test   6.46 10.8   7.91 19.3   33.8 0.159 0.131 0.371 \n3 Snaive    Asturias  Test   2.44 14.0   9.93 -9.80  48.8 0.200 0.170 0.0106\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Asturias  Test   9.45  13.1  10.3 26.0   34.2 0.208 0.160  0.206\n2 arima_at2 Asturias  Test  10.8   14.2  11.5 31.6   38.9 0.232 0.173  0.207\n3 Snaive    Asturias  Test   6.74  15.9  11.4  8.44  41.4 0.229 0.194 -0.151\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Asturias  Test   9.54  12.9  10.2 26.9   32.5 0.204 0.157  0.0649\n2 arima_at2 Asturias  Test  10.9   14.1  11.4 32.0   36.9 0.229 0.172  0.0752\n3 Snaive    Asturias  Test   5.84  15.5  11.5  6.84  40.5 0.231 0.189 -0.218 \n\n\n\n\n90 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(90))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(90) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Asturias  Test   356.  636.  356.  63.8  66.1  7.17  7.76 0.892\n2 arima_at2 Asturias  Test   358.  638.  358.  65.8  67.6  7.20  7.77 0.892\n3 Snaive    Asturias  Test   351.  635.  353.  53.3  66.9  7.10  7.74 0.892"
  },
  {
    "objectID": "multivariate.html#barcelona",
    "href": "multivariate.html#barcelona",
    "title": "Multivariate (INE mobility + temp) prediction",
    "section": "Barcelona",
    "text": "Barcelona\n\ndata_Barcelona <- covid_data %>% \n      filter(provincia == \"Barcelona\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed, mob_flujo) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Barcelona\n\n# A tsibble: 563 x 5 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed mob_flujo\n   <chr>     <date>         <dbl> <dbl>     <dbl>\n 1 Barcelona 2020-06-15        62  21.2      22.0\n 2 Barcelona 2020-06-16        66  20.8      22.6\n 3 Barcelona 2020-06-17        70  20.3      23.2\n 4 Barcelona 2020-06-18        68  18.8      23.2\n 5 Barcelona 2020-06-19        65  20.4      23.9\n 6 Barcelona 2020-06-20        53  21.8      21.5\n 7 Barcelona 2020-06-21        38  22.8      20.5\n 8 Barcelona 2020-06-22        69  23.8      19.5\n 9 Barcelona 2020-06-23        95  23.4      18.5\n10 Barcelona 2020-06-24        44  23.6      17.5\n# … with 553 more rows\n\n\n\ndata_Barcelona_train <- data_Barcelona %>% \n      filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Barcelona_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-14\" \"2021-02-13\" \"2021-02-13\" \"2021-06-14\" \"2021-10-14\" \n\n\n\ndata_Barcelona_test <- data_Barcelona %>% \n      filter(fecha > as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Barcelona_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-10-15\" \"2021-11-02\" \"2021-11-21\" \"2021-11-21\" \"2021-12-10\" \"2021-12-29\" \n\n\n\n# Lamba for num_casos\nlambda_Barcelona_casos <- data_Barcelona %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_casos\n\n[1] 0.07878312\n\n# Lamba for average temp\nlambda_Barcelona_tmed <- data_Barcelona %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_tmed\n\n[1] 1.143918\n\n# Lamba for mobility\nlambda_Barcelona_mobil <- data_Barcelona %>%\n      features(mob_flujo, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_mobil\n\n[1] 1.072959\n\n\n\nfit_model <- data_Barcelona_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Barcelona_casos) ~ \n                                    box_cox(tmed, lambda_Barcelona_tmed) + \n                                    box_cox(mob_flujo, lambda_Barcelona_mobil)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Barcelona_casos) ~ \n                                    box_cox(tmed, lambda_Barcelona_tmed) + \n                                    box_cox(mob_flujo, lambda_Barcelona_mobil),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Barcelona_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Barcelona <LM w/ ARIMA(1,1,2)(1,1,2)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots  \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>    <list>    \n1 Barcelona arima_at1 0.0757   -63.1  144.  145.  182. <cpl [8]> <cpl [16]>\n2 Barcelona arima_at2 0.0756   -63.3  143.  143.  176. <cpl [8]> <cpl [9]> \n3 Barcelona Snaive    0.389     NA     NA    NA    NA  <NULL>    <NULL>    \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(1,1,2)(1,1,1)[7] errors> 0.0756   -63.3  143.  143.  176.\n2 arima_… <LM w/ ARIMA(1,1,2)(1,1,2)[7] errors> 0.0757   -63.1  144.  145.  182.\n3 Snaive                               <SNAIVE> 0.389     NA     NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Barcelona arima_at1    2.99     0.886\n2 Barcelona arima_at2    3.04     0.881\n3 Barcelona Snaive    1575.       0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Barcelona arima_at1    6.50     0.952\n2 Barcelona arima_at2    6.74     0.944\n3 Barcelona Snaive    2173.       0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Barcelona arima_at1    10.7     0.969\n2 Barcelona arima_at2    11.0     0.963\n3 Barcelona Snaive     2244.      0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=90)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Barcelona arima_at1    77.9     0.814\n2 Barcelona arima_at2    78.3     0.805\n3 Barcelona Snaive     3329.      0    \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h90 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:90)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h90 <- fabletools::forecast(fit_model, new_data = data_fc_h90)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE      MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl>    <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Barcelona Test   15.6  67.3  57.0  -0.568   30.3 0.152 0.101 0.206\n2 arima_at2 Barcelona Test   16.6  67.7  57.2  -0.0595  30.3 0.152 0.102 0.195\n3 Snaive    Barcelona Test  -18.6  78.4  68.1 -14.2     40.4 0.181 0.118 0.183\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE    MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Barcelona Test   32.2  75.2  58.9   8.01  27.1 0.156 0.113 0.248 \n2 arima_at2 Barcelona Test   33.4  75.9  58.8   8.61  26.9 0.156 0.114 0.237 \n3 Snaive    Barcelona Test  -11.8  86.7  76.4 -10.4   40.4 0.203 0.131 0.0608\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Barcelona Test  54.4   107.  76.8 12.9   29.7 0.204 0.162  0.193\n2 arima_at2 Barcelona Test  56.1   108.  77.0 13.6   29.6 0.205 0.164  0.196\n3 Snaive    Barcelona Test   2.57  119.  90.4 -8.63  40.9 0.240 0.180 -0.235\n\n\n\n\n90 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(90))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(90) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Barcelona Test  2529. 5090. 2535.  62.2  66.8  6.73  7.68 0.827\n2 arima_at2 Barcelona Test  2536. 5098. 2542.  62.8  67.2  6.75  7.69 0.827\n3 Snaive    Barcelona Test  2482. 5070. 2508.  53.0  67.2  6.66  7.65 0.829"
  },
  {
    "objectID": "multivariate.html#madrid",
    "href": "multivariate.html#madrid",
    "title": "Multivariate (INE mobility + temp) prediction",
    "section": "Madrid",
    "text": "Madrid\n\ndata_Madrid <- covid_data %>% \n      filter(provincia == \"Madrid\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed, mob_flujo) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Madrid\n\n# A tsibble: 563 x 5 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed mob_flujo\n   <chr>     <date>         <dbl> <dbl>     <dbl>\n 1 Madrid    2020-06-15       153  20.7      20.6\n 2 Madrid    2020-06-16        91  21        21.6\n 3 Madrid    2020-06-17        93  20.2      21.8\n 4 Madrid    2020-06-18        85  21.9      22.1\n 5 Madrid    2020-06-19        78  22.6      22.0\n 6 Madrid    2020-06-20        67  23.4      18.8\n 7 Madrid    2020-06-21        42  25        19.9\n 8 Madrid    2020-06-22        60  27.3      21.0\n 9 Madrid    2020-06-23        68  28.4      22.1\n10 Madrid    2020-06-24        49  28        23.1\n# … with 553 more rows\n\n\n\ndata_Madrid_train <- data_Madrid %>% \n      filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Madrid_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-14\" \"2021-02-13\" \"2021-02-13\" \"2021-06-14\" \"2021-10-14\" \n\n\n\ndata_Madrid_test <- data_Madrid %>% \n      filter(fecha > as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Madrid_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-10-15\" \"2021-11-02\" \"2021-11-21\" \"2021-11-21\" \"2021-12-10\" \"2021-12-29\" \n\n\n\n# Lamba for num_casos\nlambda_Madrid_casos <- data_Madrid %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_casos\n\n[1] 0.004154257\n\n# Lamba for average temp\nlambda_Madrid_tmed <- data_Madrid %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_tmed\n\n[1] 0.9461578\n\n# Lamba for mobility\nlambda_Madrid_mobil <- data_Madrid %>%\n      features(mob_flujo, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_mobil\n\n[1] -0.01895186\n\n\n\nfit_model <- data_Madrid_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Madrid_casos) ~ \n                                    box_cox(tmed, lambda_Madrid_tmed) + \n                                    box_cox(mob_flujo, lambda_Madrid_mobil)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Madrid_casos) ~ \n                                    box_cox(tmed, lambda_Madrid_tmed) + \n                                    box_cox(mob_flujo, lambda_Madrid_mobil),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Madrid_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Madrid    <LM w/ ARIMA(2,1,1)(1,1,1)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots  \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>    <list>    \n1 Madrid    arima_at1 0.0295    164. -311. -311. -278. <cpl [9]> <cpl [8]> \n2 Madrid    arima_at2 0.0293    166. -314. -314. -276. <cpl [3]> <cpl [15]>\n3 Madrid    Snaive    0.131      NA    NA    NA    NA  <NULL>    <NULL>    \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(3,1,1)(0,1,2)[7] errors> 0.0293    166. -314. -314. -276.\n2 arima_… <LM w/ ARIMA(2,1,1)(1,1,1)[7] errors> 0.0295    164. -311. -311. -278.\n3 Snaive                               <SNAIVE> 0.131      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    12.2    0.0943\n2 Madrid    arima_at2    12.6    0.0826\n3 Madrid    Snaive     1708.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    45.5 0.0000344\n2 Madrid    arima_at2    33.9 0.00211  \n3 Madrid    Snaive     2642.  0        \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    55.6 0.0000574\n2 Madrid    arima_at2    37.7 0.0140   \n3 Madrid    Snaive     2912.  0        \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=90)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1   111.     0.0674\n2 Madrid    arima_at2    91.3    0.442 \n3 Madrid    Snaive     3833.     0     \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h90 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:90)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h90 <- fabletools::forecast(fit_model, new_data = data_fc_h90)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Madrid    Test  130.   159.  141. 37.6   46.5 0.331 0.237 -0.0428\n2 arima_at2 Madrid    Test  142.   171.  153. 41.4   51.2 0.360 0.254 -0.0313\n3 Snaive    Madrid    Test   33.5  125.  106. -6.41  48.4 0.249 0.186 -0.109 \n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Madrid    Test  145.   175.  151. 43.2   48.4 0.357 0.260  0.0901\n2 arima_at2 Madrid    Test  162.   191.  168. 49.7   54.5 0.395 0.285  0.113 \n3 Snaive    Madrid    Test   28.4  127.  105. -7.67  46.6 0.248 0.189 -0.0481\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Madrid    Test  171.   208.  175. 48.3   51.9 0.411 0.310 0.297\n2 arima_at2 Madrid    Test  191.   228.  195. 56.1   59.4 0.459 0.339 0.322\n3 Snaive    Madrid    Test   37.6  141.  118. -6.83  48.6 0.278 0.210 0.131\n\n\n\n\n90 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(90))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(90) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Madrid    Test  3379. 7039. 3380.  78.1  79.1  7.96  10.5 0.855\n2 arima_at2 Madrid    Test  3407. 7055. 3408.  82.8  83.7  8.03  10.5 0.855\n3 Snaive    Madrid    Test  3160. 6905. 3193.  44.5  64.2  7.52  10.3 0.853"
  },
  {
    "objectID": "multivariate.html#malaga",
    "href": "multivariate.html#malaga",
    "title": "Multivariate (INE mobility + temp) prediction",
    "section": "Malaga",
    "text": "Malaga\n\ndata_Malaga <- covid_data %>% \n      filter(provincia == \"Málaga\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed, mob_flujo) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Malaga\n\n# A tsibble: 563 x 5 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed mob_flujo\n   <chr>     <date>         <dbl> <dbl>     <dbl>\n 1 Málaga    2020-06-15         1  27.2      18.9\n 2 Málaga    2020-06-16         1  27.8      19.8\n 3 Málaga    2020-06-17         2  26.9      19.9\n 4 Málaga    2020-06-18         2  21.6      20.0\n 5 Málaga    2020-06-19         1  24.7      20.1\n 6 Málaga    2020-06-20         4  22.6      18.1\n 7 Málaga    2020-06-21         4  22.7      18.8\n 8 Málaga    2020-06-22         6  25        19.5\n 9 Málaga    2020-06-23         8  25.6      20.2\n10 Málaga    2020-06-24        65  24.5      21.0\n# … with 553 more rows\n\n\n\ndata_Malaga_train <- data_Malaga %>% \n      filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Malaga_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-14\" \"2021-02-13\" \"2021-02-13\" \"2021-06-14\" \"2021-10-14\" \n\n\n\ndata_Malaga_test <- data_Malaga %>% \n      filter(fecha > as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Malaga_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-10-15\" \"2021-11-02\" \"2021-11-21\" \"2021-11-21\" \"2021-12-10\" \"2021-12-29\" \n\n\n\n# Lamba for num_casos\nlambda_Malaga_casos <- data_Malaga %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_casos\n\n[1] 0.2360418\n\n# Lamba for average temp\nlambda_Malaga_tmed <- data_Malaga %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_tmed\n\n[1] 0.6474133\n\n# Lamba for mobility\nlambda_Malaga_mobil <- data_Malaga %>%\n      features(mob_flujo, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_mobil\n\n[1] 1.999927\n\n\n\nfit_model <- data_Malaga_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Malaga_casos) ~ \n                                    box_cox(tmed, lambda_Malaga_tmed) + \n                                    box_cox(mob_flujo, lambda_Malaga_mobil)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Malaga_casos) ~ \n                                    box_cox(tmed, lambda_Malaga_tmed) + \n                                    box_cox(mob_flujo, lambda_Malaga_mobil),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Malaga_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Málaga    <LM w/ ARIMA(4,1,0)(2,1,0)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots  \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>    \n1 Málaga    arima_at1  0.610   -559. 1135. 1136. 1173. <cpl [18]> <cpl [0]> \n2 Málaga    arima_at2  0.524   -526. 1070. 1071. 1108. <cpl [8]>  <cpl [10]>\n3 Málaga    Snaive     2.27      NA    NA    NA    NA  <NULL>     <NULL>    \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(1,1,3)(1,1,1)[7] errors>  0.524   -526. 1070. 1071. 1108.\n2 arima_… <LM w/ ARIMA(4,1,0)(2,1,0)[7] errors>  0.610   -559. 1135. 1136. 1173.\n3 Snaive                               <SNAIVE>  2.27      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1   13.3     0.0651\n2 Málaga    arima_at2    5.64    0.582 \n3 Málaga    Snaive    1373.      0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    30.5   0.00652\n2 Málaga    arima_at2    16.7   0.273  \n3 Málaga    Snaive     1974.    0      \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    47.5  0.000795\n2 Málaga    arima_at2    22.8  0.357   \n3 Málaga    Snaive     2116.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=90)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat   lb_pvalue\n  <chr>     <chr>       <dbl>       <dbl>\n1 Málaga    arima_at1   171.  0.000000610\n2 Málaga    arima_at2    81.4 0.731      \n3 Málaga    Snaive     3229.  0          \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h90 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:90)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h90 <- fabletools::forecast(fit_model, new_data = data_fc_h90)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Málaga    Test  13.1   21.3  19.3  13.5  40.4 0.196 0.126  0.0270\n2 arima_at2 Málaga    Test  15.0   22.4  21.8  17.4  47.0 0.221 0.132 -0.0409\n3 Snaive    Málaga    Test  -4.05  22.9  19.8 -27.1  52.2 0.201 0.135  0.0124\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Málaga    Test  17.0   24.8  20.8  21.1  36.5 0.211 0.146  0.151 \n2 arima_at2 Málaga    Test  20.7   28.4  24.5  27.6  43.6 0.249 0.168  0.258 \n3 Snaive    Málaga    Test  -3.93  22.7  18.7 -22.6  43.6 0.190 0.134 -0.0971\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Málaga    Test  23.6   30.9  26.1  29.5  39.7 0.265 0.182 0.314 \n2 arima_at2 Málaga    Test  28.2   35.3  30.7  37.0  47.6 0.312 0.208 0.341 \n3 Snaive    Málaga    Test  -1.04  22.0  18.6 -15.0  37.9 0.188 0.130 0.0886\n\n\n\n\n90 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(90))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(90) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Málaga    Test   380.  720.  382.  55.6  59.2  3.87  4.25 0.826\n2 arima_at2 Málaga    Test   408.  749.  409.  65.2  68.5  4.16  4.42 0.835\n3 Snaive    Málaga    Test   367.  720.  375.  35.8  56.6  3.81  4.25 0.827"
  },
  {
    "objectID": "multivariate.html#sevilla",
    "href": "multivariate.html#sevilla",
    "title": "Multivariate (INE mobility + temp) prediction",
    "section": "Sevilla",
    "text": "Sevilla\n\ndata_Sevilla <- covid_data %>% \n      filter(provincia == \"Sevilla\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed, mob_flujo) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Sevilla\n\n# A tsibble: 563 x 5 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed mob_flujo\n   <chr>     <date>         <dbl> <dbl>     <dbl>\n 1 Sevilla   2020-06-15         2  23.1      19.9\n 2 Sevilla   2020-06-16         1  24.0      20.8\n 3 Sevilla   2020-06-17         0  24.9      21.1\n 4 Sevilla   2020-06-18         0  25.8      21.3\n 5 Sevilla   2020-06-19         0  26.6      21.2\n 6 Sevilla   2020-06-20         0  27.5      18.0\n 7 Sevilla   2020-06-21         0  28.4      18.9\n 8 Sevilla   2020-06-22         1  29.3      19.8\n 9 Sevilla   2020-06-23         0  30.2      20.7\n10 Sevilla   2020-06-24         1  29.4      21.6\n# … with 553 more rows\n\n\n\ndata_Sevilla_train <- data_Sevilla %>% \n      filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Sevilla_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-14\" \"2021-02-13\" \"2021-02-13\" \"2021-06-14\" \"2021-10-14\" \n\n\n\ndata_Sevilla_test <- data_Sevilla %>% \n      filter(fecha > as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Sevilla_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-10-15\" \"2021-11-02\" \"2021-11-21\" \"2021-11-21\" \"2021-12-10\" \"2021-12-29\" \n\n\n\n# Lamba for num_casos\nlambda_Sevilla_casos <- data_Sevilla %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_casos\n\n[1] 0.2191951\n\n# Lamba for average temp\nlambda_Sevilla_tmed <- data_Sevilla %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_tmed\n\n[1] 1.057197\n\n# Lamba for mobility\nlambda_Sevilla_mobil <- data_Sevilla %>%\n      features(mob_flujo, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_mobil\n\n[1] 0.7413917\n\n\n\nfit_model <- data_Sevilla_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Sevilla_casos) ~ \n                                    box_cox(tmed, lambda_Sevilla_tmed) + \n                                    box_cox(mob_flujo, lambda_Sevilla_mobil)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Sevilla_casos) ~ \n                                    box_cox(tmed, lambda_Sevilla_tmed) + \n                                    box_cox(mob_flujo, lambda_Sevilla_mobil),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Sevilla_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Sevilla   <LM w/ ARIMA(3,1,0)(2,1,0)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots  \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>    \n1 Sevilla   arima_at1  0.937   -662. 1341. 1341. 1374. <cpl [17]> <cpl [0]> \n2 Sevilla   arima_at2  0.854   -643. 1304. 1304. 1342. <cpl [7]>  <cpl [11]>\n3 Sevilla   Snaive     2.33      NA    NA    NA    NA  <NULL>     <NULL>    \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(0,1,4)(1,1,1)[7] errors>  0.854   -643. 1304. 1304. 1342.\n2 arima_… <LM w/ ARIMA(3,1,0)(2,1,0)[7] errors>  0.937   -662. 1341. 1341. 1374.\n3 Snaive                               <SNAIVE>  2.33      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1   18.9    0.00840\n2 Sevilla   arima_at2    2.89   0.895  \n3 Sevilla   Snaive     941.     0      \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    25.5    0.0300\n2 Sevilla   arima_at2    11.3    0.666 \n3 Sevilla   Snaive     1369.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    52.1  0.000188\n2 Sevilla   arima_at2    20.9  0.466   \n3 Sevilla   Snaive     1503.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=90)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat  lb_pvalue\n  <chr>     <chr>       <dbl>      <dbl>\n1 Sevilla   arima_at1    163. 0.00000369\n2 Sevilla   arima_at2    106. 0.120     \n3 Sevilla   Snaive      2164. 0         \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h90 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:90)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h90 <- fabletools::forecast(fit_model, new_data = data_fc_h90)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE   MASE  RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>  <dbl>   <dbl>\n1 arima_at1 Sevilla   Test   8.40  11.6  8.40  23.6  23.6 0.0830 0.0735 -0.252 \n2 arima_at2 Sevilla   Test   7.16  10.7  7.85  19.5  21.7 0.0776 0.0676 -0.181 \n3 Snaive    Sevilla   Test  -5.36  15.7 13.3  -20.5  39.5 0.132  0.0995  0.0320\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE   MPE  MAPE   MASE  RMSSE   ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>  <dbl>  <dbl>\n1 arima_at1 Sevilla   Test    7.24  10.6  8.27  19.3  26.2 0.0817 0.0674 -0.229\n2 arima_at2 Sevilla   Test    5.47  10.9  8.30  11.2  27.5 0.0820 0.0693 -0.153\n3 Snaive    Sevilla   Test  -11.8   18.6 15.7  -54.9  64.3 0.155  0.118   0.269\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE   MPE  MAPE  MASE  RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl> <dbl>\n1 arima_at1 Sevilla   Test   10.5   14.9  11.2  26.8  31.4 0.110 0.0943 0.324\n2 arima_at2 Sevilla   Test    8.90  14.0  10.8  20.9  31.8 0.107 0.0886 0.226\n3 Snaive    Sevilla   Test  -13.0   21.2  18.3 -57.5  69.1 0.181 0.134  0.327\n\n\n\n\n90 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(90))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(90) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Sevilla   Test   486.  948.  487.  68.6  69.9  4.81  6.01 0.845\n2 arima_at2 Sevilla   Test   485.  945.  486.  67.3  70.6  4.80  5.99 0.845\n3 Snaive    Sevilla   Test   436.  908.  449.  22.7  70.6  4.44  5.76 0.839"
  },
  {
    "objectID": "multivariate.html#asturias-1",
    "href": "multivariate.html#asturias-1",
    "title": "Multivariate (INE mobility + temp) prediction",
    "section": "Asturias",
    "text": "Asturias\n\ndata_asturias <- covid_data %>% \n      filter(provincia == \"Asturias\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed, mob_flujo) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_asturias\n\n# A tsibble: 563 x 5 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed mob_flujo\n   <chr>     <date>         <dbl> <dbl>     <dbl>\n 1 Asturias  2020-06-15         0  16        19.4\n 2 Asturias  2020-06-16         1  15.6      19.5\n 3 Asturias  2020-06-17         0  15.6      19.7\n 4 Asturias  2020-06-18         0  15.1      20.5\n 5 Asturias  2020-06-19         0  14.8      21.0\n 6 Asturias  2020-06-20         0  16.8      19.8\n 7 Asturias  2020-06-21         0  18.2      20.2\n 8 Asturias  2020-06-22         0  18.2      20.6\n 9 Asturias  2020-06-23         0  20        21.1\n10 Asturias  2020-06-24         0  18.2      21.5\n# … with 553 more rows\n\n\n\ndata_asturias_train <- data_asturias %>% \n      filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\"))\nsummary(data_asturias_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-28\" \"2021-03-13\" \"2021-03-13\" \"2021-07-27\" \"2021-12-10\" \n\n\n\ndata_asturias_test <- data_asturias %>% \n      filter(fecha > as.Date(\"2021-12-10\", format = \"%Y-%m-%d\"))\nsummary(data_asturias_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-12-11\" \"2021-12-15\" \"2021-12-20\" \"2021-12-20\" \"2021-12-24\" \"2021-12-29\" \n\n\n\n# Lamba for num_casos\nlambda_asturias_casos <- data_asturias %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_casos\n\n[1] 0.2493395\n\n# Lamba for average temp\nlambda_asturias_tmed <- data_asturias %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_tmed\n\n[1] 1.142823\n\n# Lamba for mobility\nlambda_asturias_mobil <- data_asturias %>%\n      features(mob_flujo, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_mobil\n\n[1] 1.459993\n\n\n\nfit_model <- data_asturias_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_asturias_casos) ~ \n                                    box_cox(tmed, lambda_asturias_tmed) + \n                                    box_cox(mob_flujo, lambda_asturias_mobil)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_asturias_casos) ~ \n                                    box_cox(tmed, lambda_asturias_tmed) + \n                                    box_cox(mob_flujo, lambda_asturias_mobil),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_asturias_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Asturias  <LM w/ ARIMA(2,0,0)(2,1,1)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots  \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>    \n1 Asturias  arima_at1  1.00    -765. 1545. 1546. 1580. <cpl [16]> <cpl [7]> \n2 Asturias  arima_at2  0.981   -757. 1534. 1535. 1577. <cpl [9]>  <cpl [15]>\n3 Asturias  Snaive     2.69      NA    NA    NA    NA  <NULL>     <NULL>    \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(2,0,1)(1,1,2)[7] errors>  0.981   -757. 1534. 1535. 1577.\n2 arima_… <LM w/ ARIMA(2,0,0)(2,1,1)[7] errors>  1.00    -765. 1545. 1546. 1580.\n3 Snaive                               <SNAIVE>  2.69      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    22.4   0.00217\n2 Asturias  arima_at2    10.9   0.141  \n3 Asturias  Snaive      855.    0      \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    39.3  0.000327\n2 Asturias  arima_at2    34.8  0.00159 \n3 Asturias  Snaive     1188.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    50.0  0.000366\n2 Asturias  arima_at2    41.6  0.00466 \n3 Asturias  Snaive     1236.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=57)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    79.5    0.0260\n2 Asturias  arima_at2    70.9    0.102 \n3 Asturias  Snaive     1339.     0     \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_asturias_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_asturias_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_asturias_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h57 <- data_asturias_test %>% \n      select(-num_casos) %>% \n      slice(1:57)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h57 <- fabletools::forecast(fit_model, new_data = data_fc_h57)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2021-10-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Asturias  Test   51.8  83.3  77.5  6.62  12.0  1.55 1.02  0.0778\n2 arima_at2 Asturias  Test   28.3  72.6  63.7  2.85  10.3  1.27 0.890 0.182 \n3 Snaive    Asturias  Test  183.  216.  184.  27.5   27.5  3.67 2.65  0.424 \n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2021-10-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Asturias  Test   234.  326.  247.  22.2  24.9  4.93  4.00 0.739\n2 arima_at2 Asturias  Test   173.  255.  190.  15.6  19.4  3.80  3.12 0.688\n3 Snaive    Asturias  Test   375.  442.  376.  40.8  40.8  7.50  5.41 0.669\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2021-10-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Asturias  Test   512.  750.  522.  33.1  35.1 10.4   9.20 0.794\n2 arima_at2 Asturias  Test   424.  651.  437.  26.0  28.7  8.72  7.97 0.787\n3 Snaive    Asturias  Test   670.  879.  670.  49.8  49.8 13.4  10.8  0.806\n\n\n\n\n57 days\n\n# Plots\nfc_h57 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(57))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h57\")\n\n\n\n\n\nfc_h57 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(57) &\n                               fecha > as.Date(\"2021-10-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h57\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h57, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Asturias  Test   512.  750.  522.  33.1  35.1 10.4   9.20 0.794\n2 arima_at2 Asturias  Test   424.  651.  437.  26.0  28.7  8.72  7.97 0.787\n3 Snaive    Asturias  Test   670.  879.  670.  49.8  49.8 13.4  10.8  0.806"
  },
  {
    "objectID": "multivariate.html#barcelona-1",
    "href": "multivariate.html#barcelona-1",
    "title": "Multivariate (INE mobility + temp) prediction",
    "section": "Barcelona",
    "text": "Barcelona\n\ndata_Barcelona <- covid_data %>% \n      filter(provincia == \"Barcelona\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed, mob_flujo) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Barcelona\n\n# A tsibble: 563 x 5 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed mob_flujo\n   <chr>     <date>         <dbl> <dbl>     <dbl>\n 1 Barcelona 2020-06-15        62  21.2      22.0\n 2 Barcelona 2020-06-16        66  20.8      22.6\n 3 Barcelona 2020-06-17        70  20.3      23.2\n 4 Barcelona 2020-06-18        68  18.8      23.2\n 5 Barcelona 2020-06-19        65  20.4      23.9\n 6 Barcelona 2020-06-20        53  21.8      21.5\n 7 Barcelona 2020-06-21        38  22.8      20.5\n 8 Barcelona 2020-06-22        69  23.8      19.5\n 9 Barcelona 2020-06-23        95  23.4      18.5\n10 Barcelona 2020-06-24        44  23.6      17.5\n# … with 553 more rows\n\n\n\ndata_Barcelona_train <- data_Barcelona %>% \n      filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\"))\nsummary(data_Barcelona_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-28\" \"2021-03-13\" \"2021-03-13\" \"2021-07-27\" \"2021-12-10\" \n\n\n\ndata_Barcelona_test <- data_Barcelona %>% \n      filter(fecha > as.Date(\"2021-12-10\", format = \"%Y-%m-%d\"))\nsummary(data_Barcelona_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-12-11\" \"2021-12-15\" \"2021-12-20\" \"2021-12-20\" \"2021-12-24\" \"2021-12-29\" \n\n\n\n# Lamba for num_casos\nlambda_Barcelona_casos <- data_Barcelona %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_casos\n\n[1] 0.07878312\n\n# Lamba for average temp\nlambda_Barcelona_tmed <- data_Barcelona %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_tmed\n\n[1] 1.143918\n\n# Lamba for mobility\nlambda_Barcelona_mobil <- data_Barcelona %>%\n      features(mob_flujo, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_mobil\n\n[1] 1.072959\n\n\n\nfit_model <- data_Barcelona_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Barcelona_casos) ~ \n                                    box_cox(tmed, lambda_Barcelona_tmed) + \n                                    box_cox(mob_flujo, lambda_Barcelona_mobil)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Barcelona_casos) ~ \n                                    box_cox(tmed, lambda_Barcelona_tmed) + \n                                    box_cox(mob_flujo, lambda_Barcelona_mobil),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Barcelona_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Barcelona <LM w/ ARIMA(1,0,2)(0,1,0)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>    <list>   \n1 Barcelona arima_at1  0.156   -261.  533.  533.  559. <cpl [1]> <cpl [2]>\n2 Barcelona arima_at2  0.116   -185.  387.  388.  426. <cpl [4]> <cpl [8]>\n3 Barcelona Snaive     0.413     NA    NA    NA    NA  <NULL>    <NULL>   \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(4,0,1)(0,1,1)[7] errors>  0.116   -185.  387.  388.  426.\n2 arima_… <LM w/ ARIMA(1,0,2)(0,1,0)[7] errors>  0.156   -261.  533.  533.  559.\n3 Snaive                               <SNAIVE>  0.413     NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Barcelona arima_at1    56.7  6.83e-10\n2 Barcelona arima_at2    15.8  2.69e- 2\n3 Barcelona Snaive     1489.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Barcelona arima_at1    74.9  2.49e-10\n2 Barcelona arima_at2    18.7  1.77e- 1\n3 Barcelona Snaive     2109.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat    lb_pvalue\n  <chr>     <chr>       <dbl>        <dbl>\n1 Barcelona arima_at1    77.9 0.0000000178\n2 Barcelona arima_at2    21.1 0.451       \n3 Barcelona Snaive     2195.  0           \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=57)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat   lb_pvalue\n  <chr>     <chr>       <dbl>       <dbl>\n1 Barcelona arima_at1   130.  0.000000142\n2 Barcelona arima_at2    78.4 0.0314     \n3 Barcelona Snaive     2888.  0          \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h57 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:57)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h57 <- fabletools::forecast(fit_model, new_data = data_fc_h57)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2021-10-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE    MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Barcelona Test   200. 1499. 1266.   1.31  36.2  3.42  2.32 -0.671\n2 arima_at2 Barcelona Test  -703.  916.  778. -28.8   30.3  2.10  1.42 -0.400\n3 Snaive    Barcelona Test  1377. 1799. 1377.  35.3   35.3  3.72  2.79 -0.683\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2021-10-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Barcelona Test  2247. 3783. 2794. 21.7    39.7  7.55  5.86 0.340\n2 arima_at2 Barcelona Test  1469. 3554. 2412. -0.849  34.9  6.52  5.50 0.696\n3 Snaive    Barcelona Test  3940. 5251. 3940. 53.1    53.1 10.7   8.13 0.605\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2021-10-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Barcelona Test  4318. 6692. 4721.  33.0  46.3  12.8 10.4  0.518\n2 arima_at2 Barcelona Test  3547. 6253. 4241.  14.6  41.0  11.5  9.68 0.726\n3 Snaive    Barcelona Test  6296. 8486. 6296.  61.6  61.6  17.0 13.1  0.673\n\n\n\n\n57 days\n\n# Plots\nfc_h57 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(57))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h57\")\n\n\n\n\n\nfc_h57 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(57) &\n                               fecha > as.Date(\"2021-10-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h57\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h57, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Barcelona Test  4318. 6692. 4721.  33.0  46.3  12.8 10.4  0.518\n2 arima_at2 Barcelona Test  3547. 6253. 4241.  14.6  41.0  11.5  9.68 0.726\n3 Snaive    Barcelona Test  6296. 8486. 6296.  61.6  61.6  17.0 13.1  0.673"
  },
  {
    "objectID": "multivariate.html#madrid-1",
    "href": "multivariate.html#madrid-1",
    "title": "Multivariate (INE mobility + temp) prediction",
    "section": "Madrid",
    "text": "Madrid\n\ndata_Madrid <- covid_data %>% \n      filter(provincia == \"Madrid\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed, mob_flujo) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Madrid\n\n# A tsibble: 563 x 5 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed mob_flujo\n   <chr>     <date>         <dbl> <dbl>     <dbl>\n 1 Madrid    2020-06-15       153  20.7      20.6\n 2 Madrid    2020-06-16        91  21        21.6\n 3 Madrid    2020-06-17        93  20.2      21.8\n 4 Madrid    2020-06-18        85  21.9      22.1\n 5 Madrid    2020-06-19        78  22.6      22.0\n 6 Madrid    2020-06-20        67  23.4      18.8\n 7 Madrid    2020-06-21        42  25        19.9\n 8 Madrid    2020-06-22        60  27.3      21.0\n 9 Madrid    2020-06-23        68  28.4      22.1\n10 Madrid    2020-06-24        49  28        23.1\n# … with 553 more rows\n\n\n\ndata_Madrid_train <- data_Madrid %>% \n      filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\"))\nsummary(data_Madrid_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-28\" \"2021-03-13\" \"2021-03-13\" \"2021-07-27\" \"2021-12-10\" \n\n\n\ndata_Madrid_test <- data_Madrid %>% \n      filter(fecha > as.Date(\"2021-12-10\", format = \"%Y-%m-%d\"))\nsummary(data_Madrid_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-12-11\" \"2021-12-15\" \"2021-12-20\" \"2021-12-20\" \"2021-12-24\" \"2021-12-29\" \n\n\n\n# Lamba for num_casos\nlambda_Madrid_casos <- data_Madrid %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_casos\n\n[1] 0.004154257\n\n# Lamba for average temp\nlambda_Madrid_tmed <- data_Madrid %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_tmed\n\n[1] 0.9461578\n\n# Lamba for mobility\nlambda_Madrid_mobil <- data_Madrid %>%\n      features(mob_flujo, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_mobil\n\n[1] -0.01895186\n\n\n\nfit_model <- data_Madrid_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Madrid_casos) ~ \n                                    box_cox(tmed, lambda_Madrid_tmed) + \n                                    box_cox(mob_flujo, lambda_Madrid_mobil)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Madrid_casos) ~ \n                                    box_cox(tmed, lambda_Madrid_tmed) + \n                                    box_cox(mob_flujo, lambda_Madrid_mobil),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Madrid_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Madrid    <LM w/ ARIMA(2,0,1)(0,1,1)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>    <list>   \n1 Madrid    arima_at1 0.0522    32.4 -50.8 -50.6 -20.8 <cpl [2]> <cpl [8]>\n2 Madrid    arima_at2 0.0497    46.3 -74.6 -74.2 -36.0 <cpl [2]> <cpl [9]>\n3 Madrid    Snaive    0.138     NA    NA    NA    NA   <NULL>    <NULL>   \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(2,0,2)(0,1,1)[7] errors> 0.0497    46.3 -74.6 -74.2 -36.0\n2 arima_… <LM w/ ARIMA(2,0,1)(0,1,1)[7] errors> 0.0522    32.4 -50.8 -50.6 -20.8\n3 Snaive                               <SNAIVE> 0.138     NA    NA    NA    NA  \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    15.6   0.0293 \n2 Madrid    arima_at2    24.3   0.00102\n3 Madrid    Snaive     1470.    0      \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    46.6 0.0000224\n2 Madrid    arima_at2    41.9 0.000128 \n3 Madrid    Snaive     2317.  0        \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    55.2 0.0000657\n2 Madrid    arima_at2    47.5 0.000801 \n3 Madrid    Snaive     2574.  0        \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=57)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat    lb_pvalue\n  <chr>     <chr>       <dbl>        <dbl>\n1 Madrid    arima_at1    124. 0.000000809 \n2 Madrid    arima_at2    132. 0.0000000650\n3 Madrid    Snaive      3050. 0           \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h57 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:57)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h57 <- fabletools::forecast(fit_model, new_data = data_fc_h57)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2021-10-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Madrid    Test  3221. 3881. 3267.  47.5  50.0  8.15  6.03 0.505\n2 arima_at2 Madrid    Test  3459. 4124. 3459.  52.3  52.3  8.63  6.40 0.542\n3 Snaive    Madrid    Test  4063. 4582. 4063.  70.2  70.2 10.1   7.12 0.491\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2021-10-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME   RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Madrid    Test  6943.  9169. 6966.  58.5  59.8  17.4  14.2 0.616\n2 arima_at2 Madrid    Test  7265.  9468. 7265.  62.7  62.7  18.1  14.7 0.634\n3 Snaive    Madrid    Test  8314. 10493. 8314.  78.4  78.4  20.7  16.3 0.680\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2021-10-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME   RMSE    MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl>  <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Madrid    Test   8508. 10700.  8525.  61.9  62.8  21.3  16.6 0.578\n2 arima_at2 Madrid    Test   8921. 11114.  8921.  66.0  66.0  22.3  17.3 0.607\n3 Snaive    Madrid    Test  10402. 12674. 10402.  82.1  82.1  25.9  19.7 0.661\n\n\n\n\n57 days\n\n# Plots\nfc_h57 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(57))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h57\")\n\n\n\n\n\nfc_h57 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(57) &\n                               fecha > as.Date(\"2021-10-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h57\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h57, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME   RMSE    MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl>  <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Madrid    Test   8508. 10700.  8525.  61.9  62.8  21.3  16.6 0.578\n2 arima_at2 Madrid    Test   8921. 11114.  8921.  66.0  66.0  22.3  17.3 0.607\n3 Snaive    Madrid    Test  10402. 12674. 10402.  82.1  82.1  25.9  19.7 0.661"
  },
  {
    "objectID": "multivariate.html#malaga-1",
    "href": "multivariate.html#malaga-1",
    "title": "Multivariate (INE mobility + temp) prediction",
    "section": "Malaga",
    "text": "Malaga\n\ndata_Malaga <- covid_data %>% \n      filter(provincia == \"Málaga\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed, mob_flujo) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Malaga\n\n# A tsibble: 563 x 5 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed mob_flujo\n   <chr>     <date>         <dbl> <dbl>     <dbl>\n 1 Málaga    2020-06-15         1  27.2      18.9\n 2 Málaga    2020-06-16         1  27.8      19.8\n 3 Málaga    2020-06-17         2  26.9      19.9\n 4 Málaga    2020-06-18         2  21.6      20.0\n 5 Málaga    2020-06-19         1  24.7      20.1\n 6 Málaga    2020-06-20         4  22.6      18.1\n 7 Málaga    2020-06-21         4  22.7      18.8\n 8 Málaga    2020-06-22         6  25        19.5\n 9 Málaga    2020-06-23         8  25.6      20.2\n10 Málaga    2020-06-24        65  24.5      21.0\n# … with 553 more rows\n\n\n\ndata_Malaga_train <- data_Malaga %>% \n      filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\"))\nsummary(data_Malaga_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-28\" \"2021-03-13\" \"2021-03-13\" \"2021-07-27\" \"2021-12-10\" \n\n\n\ndata_Malaga_test <- data_Malaga %>% \n      filter(fecha > as.Date(\"2021-12-10\", format = \"%Y-%m-%d\"))\nsummary(data_Malaga_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-12-11\" \"2021-12-15\" \"2021-12-20\" \"2021-12-20\" \"2021-12-24\" \"2021-12-29\" \n\n\n\n# Lamba for num_casos\nlambda_Malaga_casos <- data_Malaga %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_casos\n\n[1] 0.2360418\n\n# Lamba for average temp\nlambda_Malaga_tmed <- data_Malaga %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_tmed\n\n[1] 0.6474133\n\n# Lamba for mobility\nlambda_Malaga_mobil <- data_Malaga %>%\n      features(mob_flujo, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_mobil\n\n[1] 1.999927\n\n\n\nfit_model <- data_Malaga_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Malaga_casos) ~ \n                                    box_cox(tmed, lambda_Malaga_tmed) + \n                                    box_cox(mob_flujo, lambda_Malaga_mobil)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Malaga_casos) ~ \n                                    box_cox(tmed, lambda_Malaga_tmed) + \n                                    box_cox(mob_flujo, lambda_Malaga_mobil),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Malaga_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Málaga    <LM w/ ARIMA(2,0,3)(0,1,1)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots  \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>    <list>    \n1 Málaga    arima_at1  0.550   -602. 1221. 1221. 1260. <cpl [2]> <cpl [10]>\n2 Málaga    arima_at2  0.550   -602. 1221. 1221. 1260. <cpl [2]> <cpl [10]>\n3 Málaga    Snaive     2.19      NA    NA    NA    NA  <NULL>    <NULL>    \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(2,0,3)(0,1,1)[7] errors>  0.550   -602. 1221. 1221. 1260.\n2 arima_… <LM w/ ARIMA(2,0,3)(0,1,1)[7] errors>  0.550   -602. 1221. 1221. 1260.\n3 Snaive                               <SNAIVE>  2.19      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    3.36     0.849\n2 Málaga    arima_at2    3.36     0.849\n3 Málaga    Snaive    1450.       0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    12.3     0.585\n2 Málaga    arima_at2    12.3     0.585\n3 Málaga    Snaive     2094.      0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    24.7     0.261\n2 Málaga    arima_at2    24.7     0.261\n3 Málaga    Snaive     2261.      0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=57)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    55.8     0.520\n2 Málaga    arima_at2    55.8     0.520\n3 Málaga    Snaive     3148.      0    \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h57 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:57)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h57 <- fabletools::forecast(fit_model, new_data = data_fc_h57)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2021-10-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Málaga    Test   175.  221.  175.  19.7  19.7  1.88  1.37 0.370\n2 arima_at2 Málaga    Test   175.  221.  175.  19.7  19.7  1.88  1.37 0.370\n3 Snaive    Málaga    Test   399.  418.  399.  48.9  48.9  4.29  2.58 0.129\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2021-10-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Málaga    Test   394.  492.  394.  30.1  30.1  4.23  3.04 0.506\n2 arima_at2 Málaga    Test   394.  492.  394.  30.1  30.1  4.23  3.04 0.506\n3 Snaive    Málaga    Test   707.  800.  707.  59.3  59.3  7.60  4.94 0.582\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2021-10-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Málaga    Test   588.  785.  588.  35.4  35.4  6.32  4.85 0.529\n2 arima_at2 Málaga    Test   588.  785.  588.  35.4  35.4  6.32  4.85 0.529\n3 Snaive    Málaga    Test   964. 1149.  964.  64.5  64.5 10.4   7.10 0.590\n\n\n\n\n57 days\n\n# Plots\nfc_h57 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(57))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h57\")\n\n\n\n\n\nfc_h57 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(57) &\n                               fecha > as.Date(\"2021-10-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h57\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h57, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Málaga    Test   588.  785.  588.  35.4  35.4  6.32  4.85 0.529\n2 arima_at2 Málaga    Test   588.  785.  588.  35.4  35.4  6.32  4.85 0.529\n3 Snaive    Málaga    Test   964. 1149.  964.  64.5  64.5 10.4   7.10 0.590"
  },
  {
    "objectID": "multivariate.html#sevilla-1",
    "href": "multivariate.html#sevilla-1",
    "title": "Multivariate (INE mobility + temp) prediction",
    "section": "Sevilla",
    "text": "Sevilla\n\ndata_Sevilla <- covid_data %>% \n      filter(provincia == \"Sevilla\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed, mob_flujo) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Sevilla\n\n# A tsibble: 563 x 5 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed mob_flujo\n   <chr>     <date>         <dbl> <dbl>     <dbl>\n 1 Sevilla   2020-06-15         2  23.1      19.9\n 2 Sevilla   2020-06-16         1  24.0      20.8\n 3 Sevilla   2020-06-17         0  24.9      21.1\n 4 Sevilla   2020-06-18         0  25.8      21.3\n 5 Sevilla   2020-06-19         0  26.6      21.2\n 6 Sevilla   2020-06-20         0  27.5      18.0\n 7 Sevilla   2020-06-21         0  28.4      18.9\n 8 Sevilla   2020-06-22         1  29.3      19.8\n 9 Sevilla   2020-06-23         0  30.2      20.7\n10 Sevilla   2020-06-24         1  29.4      21.6\n# … with 553 more rows\n\n\n\ndata_Sevilla_train <- data_Sevilla %>% \n      filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\"))\nsummary(data_Sevilla_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-28\" \"2021-03-13\" \"2021-03-13\" \"2021-07-27\" \"2021-12-10\" \n\n\n\ndata_Sevilla_test <- data_Sevilla %>% \n      filter(fecha > as.Date(\"2021-12-10\", format = \"%Y-%m-%d\"))\nsummary(data_Sevilla_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-12-11\" \"2021-12-15\" \"2021-12-20\" \"2021-12-20\" \"2021-12-24\" \"2021-12-29\" \n\n\n\n# Lamba for num_casos\nlambda_Sevilla_casos <- data_Sevilla %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_casos\n\n[1] 0.2191951\n\n# Lamba for average temp\nlambda_Sevilla_tmed <- data_Sevilla %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_tmed\n\n[1] 1.057197\n\n# Lamba for mobility\nlambda_Sevilla_mobil <- data_Sevilla %>%\n      features(mob_flujo, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_mobil\n\n[1] 0.7413917\n\n\n\nfit_model <- data_Sevilla_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Sevilla_casos) ~ \n                                    box_cox(tmed, lambda_Sevilla_tmed) + \n                                    box_cox(mob_flujo, lambda_Sevilla_mobil)),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Sevilla_casos) ~ \n                                    box_cox(tmed, lambda_Sevilla_tmed) + \n                                    box_cox(mob_flujo, lambda_Sevilla_mobil),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Sevilla_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Sevilla   <LM w/ ARIMA(4,0,0)(2,1,0)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots  \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>    \n1 Sevilla   arima_at1  0.917   -737. 1491. 1491. 1530. <cpl [18]> <cpl [0]> \n2 Sevilla   arima_at2  0.866   -722. 1462. 1463. 1501. <cpl [1]>  <cpl [11]>\n3 Sevilla   Snaive     2.25      NA    NA    NA    NA  <NULL>     <NULL>    \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(1,0,4)(0,1,1)[7] errors>  0.866   -722. 1462. 1463. 1501.\n2 arima_… <LM w/ ARIMA(4,0,0)(2,1,0)[7] errors>  0.917   -737. 1491. 1491. 1530.\n3 Snaive                               <SNAIVE>  2.25      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    18.1    0.0113\n2 Sevilla   arima_at2    10.3    0.173 \n3 Sevilla   Snaive     1028.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    27.5    0.0167\n2 Sevilla   arima_at2    20.7    0.109 \n3 Sevilla   Snaive     1507.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    54.8 0.0000749\n2 Sevilla   arima_at2    28.5 0.126    \n3 Sevilla   Snaive     1658.  0        \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=57)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat  lb_pvalue\n  <chr>     <chr>       <dbl>      <dbl>\n1 Sevilla   arima_at1   115.  0.00000863\n2 Sevilla   arima_at2    77.8 0.0352    \n3 Sevilla   Snaive     2098.  0         \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h57 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:57)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h57 <- fabletools::forecast(fit_model, new_data = data_fc_h57)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2021-10-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Sevilla   Test   474.  544.  474.  46.8  46.8  5.00  3.62 0.418\n2 arima_at2 Sevilla   Test   473.  548.  473.  46.5  46.5  4.99  3.64 0.457\n3 Snaive    Sevilla   Test   613.  682.  613.  62.7  62.7  6.47  4.53 0.324\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2021-12-10\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Sevilla   Test   861. 1043.  861.  56.1  56.1  9.08  6.93 0.731\n2 arima_at2 Sevilla   Test   865. 1057.  865.  55.7  55.7  9.12  7.03 0.741\n3 Snaive    Sevilla   Test  1045. 1227. 1045.  70.9  70.9 11.0   8.16 0.717\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2021-10-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Sevilla   Test  1113. 1364. 1113.  60.3  60.3  11.7  9.07 0.634\n2 arima_at2 Sevilla   Test  1112. 1368. 1112.  59.8  59.8  11.7  9.10 0.644\n3 Snaive    Sevilla   Test  1327. 1584. 1327.  74.7  74.7  14.0 10.5  0.638\n\n\n\n\n57 days\n\n# Plots\nfc_h57 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(57))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h57\")\n\n\n\n\n\nfc_h57 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2021-12-10\", format = \"%Y-%m-%d\")+days(57) &\n                               fecha > as.Date(\"2021-10-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h57\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h57, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Sevilla   Test  1113. 1364. 1113.  60.3  60.3  11.7  9.07 0.634\n2 arima_at2 Sevilla   Test  1112. 1368. 1112.  59.8  59.8  11.7  9.10 0.644\n3 Snaive    Sevilla   Test  1327. 1584. 1327.  74.7  74.7  14.0 10.5  0.638"
  },
  {
    "objectID": "multivariate_google.html",
    "href": "multivariate_google.html",
    "title": "Multivariate (Google mobility + temp) prediction",
    "section": "",
    "text": "Load packages:\nThe temporal limits of our prediction will be:"
  },
  {
    "objectID": "multivariate_google.html#asturias",
    "href": "multivariate_google.html#asturias",
    "title": "Multivariate (Google mobility + temp) prediction",
    "section": "Asturias",
    "text": "Asturias\n\ndata_asturias <- covid_data %>% \n      filter(provincia == \"Asturias\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_asturias\n\n# A tsibble: 653 x 10 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl> <dbl>                <dbl>     <dbl>\n 1 Asturias  2020-06-15         0  16                   -6          39\n 2 Asturias  2020-06-16         1  15.6                 -6           7\n 3 Asturias  2020-06-17         0  15.6                 -7          20\n 4 Asturias  2020-06-18         0  15.1                 -4          68\n 5 Asturias  2020-06-19         0  14.8                 -4          52\n 6 Asturias  2020-06-20         0  16.8                -10          71\n 7 Asturias  2020-06-21         0  18.2                 -5.5        46\n 8 Asturias  2020-06-22         0  18.2                 -1          99\n 9 Asturias  2020-06-23         0  20                   -2         129\n10 Asturias  2020-06-24         0  18.2                 -9          63\n# … with 643 more rows, and 4 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>\n\n\n\ndata_asturias_train <- data_asturias %>% \n      filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_asturias_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-14\" \"2021-02-13\" \"2021-02-13\" \"2021-06-14\" \"2021-10-14\" \n\n\n\ndata_asturias_test <- data_asturias %>% \n      filter(fecha > as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_asturias_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-10-15\" \"2021-11-25\" \"2022-01-05\" \"2022-01-05\" \"2022-02-15\" \"2022-03-29\" \n\n\n\n# Lamba for num_casos\nlambda_asturias_casos <- data_asturias %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_casos\n\n[1] 0.2278229\n\n# Lamba for average temp\nlambda_asturias_tmed <- data_asturias %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_tmed\n\n[1] 1.056074\n\n# Lamba for mobility\nlambda_asturias_grocery <- data_asturias %>%\n      features(mob_grocery_pharmacy, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_grocery\n\n[1] 1.377952\n\nlambda_asturias_parks <- data_asturias %>%\n      features(mob_parks, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_parks\n\n[1] 0.7188469\n\nlambda_asturias_resd <- data_asturias %>%\n      features(mob_residential, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_resd\n\n[1] 1.000064\n\nlambda_asturias_retail <- data_asturias %>%\n      features(mob_retail_recreation, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_retail\n\n[1] 1.058286\n\nlambda_asturias_transit <- data_asturias %>%\n      features(mob_transit_stations, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_transit\n\n[1] 1.116829\n\nlambda_asturias_work <- data_asturias %>%\n      features(mob_workplaces, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_work\n\n[1] 1.999927\n\n\n\nfit_model <- data_asturias_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_asturias_casos) ~ \n                                    box_cox(tmed, lambda_asturias_tmed) + \n                                    box_cox(mob_grocery_pharmacy, lambda_asturias_grocery) +\n                                    box_cox(mob_parks, lambda_asturias_parks) +\n                                    box_cox(mob_residential, lambda_asturias_resd) +\n                                    box_cox(mob_retail_recreation, lambda_asturias_retail) +\n                                    box_cox(mob_transit_stations, lambda_asturias_transit) +\n                                    box_cox(mob_workplaces, lambda_asturias_work)\n                              ),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_asturias_casos) ~ \n                                    box_cox(tmed, lambda_asturias_tmed) + \n                                    box_cox(mob_grocery_pharmacy, lambda_asturias_grocery) +\n                                    box_cox(mob_parks, lambda_asturias_parks) +\n                                    box_cox(mob_residential, lambda_asturias_resd) +\n                                    box_cox(mob_retail_recreation, lambda_asturias_retail) +\n                                    box_cox(mob_transit_stations, lambda_asturias_transit) +\n                                    box_cox(mob_workplaces, lambda_asturias_work),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_asturias_casos))\n      )\n\nWarning in sqrt(diag(best$var.coef)): NaNs produced\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Asturias  <LM w/ ARIMA(4,0,0)(2,0,0)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>   \n1 Asturias  arima_at1  0.955   -675. 1380. 1381. 1443. <cpl [18]> <cpl [0]>\n2 Asturias  arima_at2  0.922   -668. 1363. 1364. 1417. <cpl [9]>  <cpl [8]>\n3 Asturias  Snaive     2.32      NA    NA    NA    NA  <NULL>     <NULL>   \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(2,0,1)(1,0,1)[7] errors>  0.922   -668. 1363. 1364. 1417.\n2 arima_… <LM w/ ARIMA(4,0,0)(2,0,0)[7] errors>  0.955   -675. 1380. 1381. 1443.\n3 Snaive                               <SNAIVE>  2.32      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    17.1    0.0165\n2 Asturias  arima_at2    12.1    0.0972\n3 Asturias  Snaive      629.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    35.5   0.00125\n2 Asturias  arima_at2    28.9   0.0108 \n3 Asturias  Snaive      892.    0      \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    52.1  0.000185\n2 Asturias  arima_at2    38.2  0.0121  \n3 Asturias  Snaive      927.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=90)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1   128.    0.00526\n2 Asturias  arima_at2    99.4   0.233  \n3 Asturias  Snaive     1195.    0      \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_asturias_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_asturias_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_asturias_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h90 <- data_asturias_test %>% \n      select(-num_casos) %>% \n      slice(1:90)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h90 <- fabletools::forecast(fit_model, new_data = data_fc_h90)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE    MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Asturias  Test   3.68  9.00  5.65   6.27  23.7 0.114 0.110 0.0968 \n2 arima_at2 Asturias  Test   5.62  9.84  6.95  15.8   29.0 0.140 0.120 0.318  \n3 Snaive    Asturias  Test   2.41 14.0   9.98 -10.1   49.0 0.201 0.171 0.00766\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Asturias  Test   7.39  11.7  8.37 18.2   26.9 0.168 0.142  0.0327\n2 arima_at2 Asturias  Test  11.4   15.0 12.1  33.0   39.6 0.243 0.183  0.304 \n3 Snaive    Asturias  Test   6.69  16.0 11.4   8.17  41.5 0.229 0.195 -0.156 \n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE     ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>    <dbl>\n1 arima_at1 Asturias  Test   4.99  10.5  7.85  9.97  26.3 0.158 0.128 -0.00881\n2 arima_at2 Asturias  Test  11.7   14.8 12.1  34.3   38.7 0.243 0.180  0.155  \n3 Snaive    Asturias  Test   5.77  15.6 11.5   6.52  40.8 0.232 0.190 -0.223  \n\n\n\n\n90 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(90))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(90) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Asturias  Test   689. 1200.  691.  56.5  64.2  13.9  14.6 0.925\n2 arima_at2 Asturias  Test   721. 1229.  721.  74.4  75.9  14.5  15.0 0.926\n3 Snaive    Asturias  Test   702. 1213.  704.  60.0  71.7  14.2  14.8 0.925"
  },
  {
    "objectID": "multivariate_google.html#barcelona",
    "href": "multivariate_google.html#barcelona",
    "title": "Multivariate (Google mobility + temp) prediction",
    "section": "Barcelona",
    "text": "Barcelona\n\ndata_Barcelona <- covid_data %>% \n      filter(provincia == \"Barcelona\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Barcelona\n\n# A tsibble: 653 x 10 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl> <dbl>                <dbl>     <dbl>\n 1 Barcelona 2020-06-15        62  21.2                   -9        17\n 2 Barcelona 2020-06-16        66  20.8                  -10       -16\n 3 Barcelona 2020-06-17        70  20.3                   -4        14\n 4 Barcelona 2020-06-18        68  18.8                   -8        -6\n 5 Barcelona 2020-06-19        65  20.4                   -5        10\n 6 Barcelona 2020-06-20        53  21.8                  -12        15\n 7 Barcelona 2020-06-21        38  22.8                  -18        18\n 8 Barcelona 2020-06-22        69  23.8                    5        24\n 9 Barcelona 2020-06-23        95  23.4                   19        28\n10 Barcelona 2020-06-24        44  23.6                  -71        28\n# … with 643 more rows, and 4 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>\n\n\n\ndata_Barcelona_train <- data_Barcelona %>% \n      filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Barcelona_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-14\" \"2021-02-13\" \"2021-02-13\" \"2021-06-14\" \"2021-10-14\" \n\n\n\ndata_Barcelona_test <- data_Barcelona %>% \n      filter(fecha > as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Barcelona_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-10-15\" \"2021-11-25\" \"2022-01-05\" \"2022-01-05\" \"2022-02-15\" \"2022-03-29\" \n\n\n\n# Lamba for num_casos\nlambda_Barcelona_casos <- data_asturias %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_casos\n\n[1] 0.2278229\n\n# Lamba for average temp\nlambda_Barcelona_tmed <- data_asturias %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_tmed\n\n[1] 1.056074\n\n# Lamba for mobility\nlambda_Barcelona_grocery <- data_asturias %>%\n      features(mob_grocery_pharmacy, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_grocery\n\n[1] 1.377952\n\nlambda_Barcelona_parks <- data_asturias %>%\n      features(mob_parks, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_parks\n\n[1] 0.7188469\n\nlambda_Barcelona_resd <- data_asturias %>%\n      features(mob_residential, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_resd\n\n[1] 1.000064\n\nlambda_Barcelona_retail <- data_asturias %>%\n      features(mob_retail_recreation, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_retail\n\n[1] 1.058286\n\nlambda_Barcelona_transit <- data_asturias %>%\n      features(mob_transit_stations, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_transit\n\n[1] 1.116829\n\nlambda_Barcelona_work <- data_asturias %>%\n      features(mob_workplaces, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_work\n\n[1] 1.999927\n\n\n\nfit_model <- data_Barcelona_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Barcelona_casos) ~ \n                                    box_cox(tmed, lambda_Barcelona_tmed) + \n                                    box_cox(mob_grocery_pharmacy, lambda_Barcelona_grocery) +\n                                    box_cox(mob_parks, lambda_Barcelona_parks) +\n                                    box_cox(mob_residential, lambda_Barcelona_resd) +\n                                    box_cox(mob_retail_recreation, lambda_Barcelona_retail) +\n                                    box_cox(mob_transit_stations, lambda_Barcelona_transit) +\n                                    box_cox(mob_workplaces, lambda_Barcelona_work)\n                              ),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Barcelona_casos) ~ \n                                    box_cox(tmed, lambda_Barcelona_tmed) + \n                                    box_cox(mob_grocery_pharmacy, lambda_Barcelona_grocery) +\n                                    box_cox(mob_parks, lambda_Barcelona_parks) +\n                                    box_cox(mob_residential, lambda_Barcelona_resd) +\n                                    box_cox(mob_retail_recreation, lambda_Barcelona_retail) +\n                                    box_cox(mob_transit_stations, lambda_Barcelona_transit) +\n                                    box_cox(mob_workplaces, lambda_Barcelona_work),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Barcelona_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Barcelona <LM w/ ARIMA(1,0,2)(1,0,0)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>    <list>   \n1 Barcelona arima_at1  0.501   -525. 1076. 1077. 1131. <cpl [8]> <cpl [2]>\n2 Barcelona arima_at2  0.492   -520. 1068. 1069. 1127. <cpl [9]> <cpl [2]>\n3 Barcelona Snaive     3.23      NA    NA    NA    NA  <NULL>    <NULL>   \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(2,0,2)(1,0,0)[7] errors>  0.492   -520. 1068. 1069. 1127.\n2 arima_… <LM w/ ARIMA(1,0,2)(1,0,0)[7] errors>  0.501   -525. 1076. 1077. 1131.\n3 Snaive                               <SNAIVE>  3.23      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat     lb_pvalue\n  <chr>     <chr>       <dbl>         <dbl>\n1 Barcelona arima_at1    49.8 0.0000000156 \n2 Barcelona arima_at2    52.9 0.00000000385\n3 Barcelona Snaive     1648.  0            \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat     lb_pvalue\n  <chr>     <chr>       <dbl>         <dbl>\n1 Barcelona arima_at1    68.6 0.00000000350\n2 Barcelona arima_at2    69.2 0.00000000268\n3 Barcelona Snaive     2222.  0            \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat    lb_pvalue\n  <chr>     <chr>       <dbl>        <dbl>\n1 Barcelona arima_at1    77.6 0.0000000204\n2 Barcelona arima_at2    78.4 0.0000000147\n3 Barcelona Snaive     2272.  0           \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=90)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat    lb_pvalue\n  <chr>     <chr>       <dbl>        <dbl>\n1 Barcelona arima_at1    182. 0.0000000314\n2 Barcelona arima_at2    176. 0.000000148 \n3 Barcelona Snaive      3575. 0           \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h90 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:90)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h90 <- fabletools::forecast(fit_model, new_data = data_fc_h90)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Barcelona Test  -29.5  75.9  67.0 -20.3  40.8 0.178 0.114 0.551\n2 arima_at2 Barcelona Test  -45.0  88.5  79.0 -28.7  47.2 0.210 0.134 0.598\n3 Snaive    Barcelona Test  -25.0  80.0  67.1 -17.8  40.2 0.178 0.121 0.187\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Barcelona Test  -17.3  72.1  63.5 -12.7  34.8 0.169 0.109 0.462 \n2 arima_at2 Barcelona Test  -47.5  91.4  80.9 -27.0  43.8 0.215 0.138 0.505 \n3 Snaive    Barcelona Test  -21.3  88.0  75.0 -15.3  40.3 0.199 0.133 0.0630\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE    MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Barcelona Test    2.67  82.2  67.8  -7.70  33.2 0.180 0.124  0.389\n2 arima_at2 Barcelona Test  -46.5   91.9  83.2 -28.8   43.5 0.221 0.139  0.321\n3 Snaive    Barcelona Test  -10.1  119.   90.1 -14.8   41.9 0.239 0.179 -0.242\n\n\n\n\n90 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(90))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(90) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Barcelona Test  4772. 8726. 4788.  55.3  65.0  12.7  13.2 0.867\n2 arima_at2 Barcelona Test  4698. 8750. 4736.  42.6  61.9  12.6  13.2 0.869\n3 Snaive    Barcelona Test  4888. 8865. 4913.  56.6  70.5  13.1  13.4 0.870"
  },
  {
    "objectID": "multivariate_google.html#madrid",
    "href": "multivariate_google.html#madrid",
    "title": "Multivariate (Google mobility + temp) prediction",
    "section": "Madrid",
    "text": "Madrid\n\ndata_Madrid <- covid_data %>% \n      filter(provincia == \"Madrid\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Madrid\n\n# A tsibble: 653 x 10 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl> <dbl>                <dbl>     <dbl>\n 1 Madrid    2020-06-15       153  20.7                   -8        34\n 2 Madrid    2020-06-16        91  21                     -8        21\n 3 Madrid    2020-06-17        93  20.2                   -5        34\n 4 Madrid    2020-06-18        85  21.9                   -7        30\n 5 Madrid    2020-06-19        78  22.6                   -9        22\n 6 Madrid    2020-06-20        67  23.4                  -12        25\n 7 Madrid    2020-06-21        42  25                    -13        14\n 8 Madrid    2020-06-22        60  27.3                   -8        29\n 9 Madrid    2020-06-23        68  28.4                   -9        23\n10 Madrid    2020-06-24        49  28                     -7        22\n# … with 643 more rows, and 4 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>\n\n\n\ndata_Madrid_train <- data_Madrid %>% \n      filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Madrid_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-14\" \"2021-02-13\" \"2021-02-13\" \"2021-06-14\" \"2021-10-14\" \n\n\n\ndata_Madrid_test <- data_Madrid %>% \n      filter(fecha > as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Madrid_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-10-15\" \"2021-11-25\" \"2022-01-05\" \"2022-01-05\" \"2022-02-15\" \"2022-03-29\" \n\n\n\n# Lamba for num_casos\nlambda_Madrid_casos <- data_asturias %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_casos\n\n[1] 0.2278229\n\n# Lamba for average temp\nlambda_Madrid_tmed <- data_asturias %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_tmed\n\n[1] 1.056074\n\n# Lamba for mobility\nlambda_Madrid_grocery <- data_asturias %>%\n      features(mob_grocery_pharmacy, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_grocery\n\n[1] 1.377952\n\nlambda_Madrid_parks <- data_asturias %>%\n      features(mob_parks, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_parks\n\n[1] 0.7188469\n\nlambda_Madrid_resd <- data_asturias %>%\n      features(mob_residential, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_resd\n\n[1] 1.000064\n\nlambda_Madrid_retail <- data_asturias %>%\n      features(mob_retail_recreation, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_retail\n\n[1] 1.058286\n\nlambda_Madrid_transit <- data_asturias %>%\n      features(mob_transit_stations, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_transit\n\n[1] 1.116829\n\nlambda_Madrid_work <- data_asturias %>%\n      features(mob_workplaces, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_work\n\n[1] 1.999927\n\n\n\nfit_model <- data_Madrid_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Madrid_casos) ~ \n                                    box_cox(tmed, lambda_Madrid_tmed) + \n                                    box_cox(mob_grocery_pharmacy, lambda_Madrid_grocery) +\n                                    box_cox(mob_parks, lambda_Madrid_parks) +\n                                    box_cox(mob_residential, lambda_Madrid_resd) +\n                                    box_cox(mob_retail_recreation, lambda_Madrid_retail) +\n                                    box_cox(mob_transit_stations, lambda_Madrid_transit) +\n                                    box_cox(mob_workplaces, lambda_Madrid_work)\n                              ),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Madrid_casos) ~ \n                                    box_cox(tmed, lambda_Madrid_tmed) + \n                                    box_cox(mob_grocery_pharmacy, lambda_Madrid_grocery) +\n                                    box_cox(mob_parks, lambda_Madrid_parks) +\n                                    box_cox(mob_residential, lambda_Madrid_resd) +\n                                    box_cox(mob_retail_recreation, lambda_Madrid_retail) +\n                                    box_cox(mob_transit_stations, lambda_Madrid_transit) +\n                                    box_cox(mob_workplaces, lambda_Madrid_work),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Madrid_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Madrid    <LM w/ ARIMA(3,0,0)(1,0,1)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>   \n1 Madrid    arima_at1  0.494   -519. 1066. 1067. 1125. <cpl [10]> <cpl [7]>\n2 Madrid    arima_at2  0.494   -519. 1066. 1067. 1125. <cpl [10]> <cpl [7]>\n3 Madrid    Snaive     3.02      NA    NA    NA    NA  <NULL>     <NULL>   \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(3,0,0)(1,0,1)[7] errors>  0.494   -519. 1066. 1067. 1125.\n2 arima_… <LM w/ ARIMA(3,0,0)(1,0,1)[7] errors>  0.494   -519. 1066. 1067. 1125.\n3 Snaive                               <SNAIVE>  3.02      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    8.14     0.320\n2 Madrid    arima_at2    8.14     0.320\n3 Madrid    Snaive    1553.       0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    19.6     0.144\n2 Madrid    arima_at2    19.6     0.144\n3 Madrid    Snaive     2371.      0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    29.2     0.109\n2 Madrid    arima_at2    29.2     0.109\n3 Madrid    Snaive     2571.      0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=90)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    119.    0.0225\n2 Madrid    arima_at2    119.    0.0225\n3 Madrid    Snaive      3699.    0     \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h90 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:90)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h90 <- fabletools::forecast(fit_model, new_data = data_fc_h90)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Madrid    Test   66.6  114.  98.7 10.6   38.9 0.233 0.170 -0.142\n2 arima_at2 Madrid    Test   66.6  114.  98.7 10.6   38.9 0.233 0.170 -0.142\n3 Snaive    Madrid    Test   25.6  123. 102.  -9.85  47.5 0.240 0.183 -0.107\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Madrid    Test   71.3  118.  102.  12.6  38.2 0.240 0.176 -0.0603\n2 arima_at2 Madrid    Test   71.3  118.  102.  12.6  38.2 0.240 0.176 -0.0603\n3 Snaive    Madrid    Test   16.7  124.  102. -12.8  46.7 0.240 0.185 -0.0438\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Madrid    Test   89.9  148.  121.  15.5  40.0 0.285 0.220 0.225\n2 arima_at2 Madrid    Test   89.9  148.  121.  15.5  40.0 0.285 0.220 0.225\n3 Snaive    Madrid    Test   22.0  137.  112. -13.4  48.6 0.264 0.204 0.131\n\n\n\n\n90 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(90))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(90) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Madrid    Test  4656. 8366. 4665.  56.9  63.6  11.0  12.5 0.838\n2 arima_at2 Madrid    Test  4656. 8366. 4665.  56.9  63.6  11.0  12.5 0.838\n3 Snaive    Madrid    Test  4718. 8525. 4752.  47.9  67.2  11.2  12.7 0.839"
  },
  {
    "objectID": "multivariate_google.html#malaga",
    "href": "multivariate_google.html#malaga",
    "title": "Multivariate (Google mobility + temp) prediction",
    "section": "Malaga",
    "text": "Malaga\n\ndata_Malaga <- covid_data %>% \n      filter(provincia == \"Málaga\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Malaga\n\n# A tsibble: 653 x 10 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl> <dbl>                <dbl>     <dbl>\n 1 Málaga    2020-06-15         1  27.2                  -16        -9\n 2 Málaga    2020-06-16         1  27.8                  -13        -4\n 3 Málaga    2020-06-17         2  26.9                  -13         1\n 4 Málaga    2020-06-18         2  21.6                  -12         3\n 5 Málaga    2020-06-19         1  24.7                  -12         2\n 6 Málaga    2020-06-20         4  22.6                  -14         8\n 7 Málaga    2020-06-21         4  22.7                  -16        -3\n 8 Málaga    2020-06-22         6  25                    -13         1\n 9 Málaga    2020-06-23         8  25.6                  -10        18\n10 Málaga    2020-06-24        65  24.5                  -13        12\n# … with 643 more rows, and 4 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>\n\n\n\ndata_Malaga_train <- data_Malaga %>% \n      filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Malaga_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-14\" \"2021-02-13\" \"2021-02-13\" \"2021-06-14\" \"2021-10-14\" \n\n\n\ndata_Malaga_test <- data_Malaga %>% \n      filter(fecha > as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Malaga_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-10-15\" \"2021-11-25\" \"2022-01-05\" \"2022-01-05\" \"2022-02-15\" \"2022-03-29\" \n\n\n\n# Lamba for num_casos\nlambda_Malaga_casos <- data_asturias %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_casos\n\n[1] 0.2278229\n\n# Lamba for average temp\nlambda_Malaga_tmed <- data_asturias %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_tmed\n\n[1] 1.056074\n\n# Lamba for mobility\nlambda_Malaga_grocery <- data_asturias %>%\n      features(mob_grocery_pharmacy, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_grocery\n\n[1] 1.377952\n\nlambda_Malaga_parks <- data_asturias %>%\n      features(mob_parks, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_parks\n\n[1] 0.7188469\n\nlambda_Malaga_resd <- data_asturias %>%\n      features(mob_residential, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_resd\n\n[1] 1.000064\n\nlambda_Malaga_retail <- data_asturias %>%\n      features(mob_retail_recreation, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_retail\n\n[1] 1.058286\n\nlambda_Malaga_transit <- data_asturias %>%\n      features(mob_transit_stations, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_transit\n\n[1] 1.116829\n\nlambda_Malaga_work <- data_asturias %>%\n      features(mob_workplaces, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_work\n\n[1] 1.999927\n\n\n\nfit_model <- data_Malaga_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Malaga_casos) ~ \n                                    box_cox(tmed, lambda_Malaga_tmed) + \n                                    box_cox(mob_grocery_pharmacy, lambda_Malaga_grocery) +\n                                    box_cox(mob_parks, lambda_Malaga_parks) +\n                                    box_cox(mob_residential, lambda_Malaga_resd) +\n                                    box_cox(mob_retail_recreation, lambda_Malaga_retail) +\n                                    box_cox(mob_transit_stations, lambda_Malaga_transit) +\n                                    box_cox(mob_workplaces, lambda_Malaga_work)\n                              ),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Malaga_casos) ~ \n                                    box_cox(tmed, lambda_Malaga_tmed) + \n                                    box_cox(mob_grocery_pharmacy, lambda_Malaga_grocery) +\n                                    box_cox(mob_parks, lambda_Malaga_parks) +\n                                    box_cox(mob_residential, lambda_Malaga_resd) +\n                                    box_cox(mob_retail_recreation, lambda_Malaga_retail) +\n                                    box_cox(mob_transit_stations, lambda_Malaga_transit) +\n                                    box_cox(mob_workplaces, lambda_Malaga_work),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Malaga_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Málaga    <LM w/ ARIMA(4,1,0)(2,0,0)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>   \n1 Málaga    arima_at1  0.469   -500. 1029. 1030. 1087. <cpl [18]> <cpl [0]>\n2 Málaga    arima_at2  0.464   -498. 1024. 1025. 1083. <cpl [16]> <cpl [2]>\n3 Málaga    Snaive     2.08      NA    NA    NA    NA  <NULL>     <NULL>   \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(2,1,2)(2,0,0)[7] errors>  0.464   -498. 1024. 1025. 1083.\n2 arima_… <LM w/ ARIMA(4,1,0)(2,0,0)[7] errors>  0.469   -500. 1029. 1030. 1087.\n3 Snaive                               <SNAIVE>  2.08      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    6.82     0.448\n2 Málaga    arima_at2    4.67     0.700\n3 Málaga    Snaive    1353.       0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    17.7     0.219\n2 Málaga    arima_at2    10.6     0.715\n3 Málaga    Snaive     1943.      0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    24.8     0.257\n2 Málaga    arima_at2    17.7     0.668\n3 Málaga    Snaive     2088.      0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=90)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1   121.     0.0171\n2 Málaga    arima_at2    87.8    0.545 \n3 Málaga    Snaive     3170.     0     \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h90 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:90)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h90 <- fabletools::forecast(fit_model, new_data = data_fc_h90)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE    MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Málaga    Test   9.98  18.0  16.2   7.92  34.9 0.164 0.107 -0.0177\n2 arima_at2 Málaga    Test  10.2   18.3  16.3   8.34  35.0 0.166 0.108  0.0652\n3 Snaive    Málaga    Test  -3.97  22.9  19.8 -27.0   52.2 0.201 0.135  0.0122\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Málaga    Test  13.0   21.1  17.6  13.8  31.5 0.179 0.124  0.199 \n2 arima_at2 Málaga    Test  13.7   21.7  17.9  15.2  31.7 0.182 0.128  0.241 \n3 Snaive    Málaga    Test  -3.81  22.7  18.7 -22.3  43.6 0.190 0.134 -0.0975\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE   MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Málaga    Test  18.4    26.2  22.0  20.8  33.9 0.224 0.154 0.260 \n2 arima_at2 Málaga    Test  18.5    26.0  22.0  21.1  33.8 0.223 0.154 0.246 \n3 Snaive    Málaga    Test  -0.886  22.0  18.6 -14.7  37.8 0.189 0.130 0.0886\n\n\n\n\n90 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(90))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(90) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Málaga    Test   628. 1042.  629.  58.6  62.8  6.39  6.16 0.933\n2 arima_at2 Málaga    Test   599. 1007.  601.  53.2  57.8  6.10  5.95 0.932\n3 Snaive    Málaga    Test   621. 1049.  628.  45.0  62.4  6.38  6.20 0.929"
  },
  {
    "objectID": "multivariate_google.html#sevilla",
    "href": "multivariate_google.html#sevilla",
    "title": "Multivariate (Google mobility + temp) prediction",
    "section": "Sevilla",
    "text": "Sevilla\n\ndata_Sevilla <- covid_data %>% \n      filter(provincia == \"Sevilla\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Sevilla\n\n# A tsibble: 653 x 10 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl> <dbl>                <dbl>     <dbl>\n 1 Sevilla   2020-06-15         2  23.1                  -14       -13\n 2 Sevilla   2020-06-16         1  24.0                  -10        -4\n 3 Sevilla   2020-06-17         0  24.9                  -10        -7\n 4 Sevilla   2020-06-18         0  25.8                  -12       -13\n 5 Sevilla   2020-06-19         0  26.6                  -13       -20\n 6 Sevilla   2020-06-20         0  27.5                  -20       -34\n 7 Sevilla   2020-06-21         0  28.4                  -27       -47\n 8 Sevilla   2020-06-22         1  29.3                  -17       -19\n 9 Sevilla   2020-06-23         0  30.2                  -12       -13\n10 Sevilla   2020-06-24         1  29.4                  -12       -12\n# … with 643 more rows, and 4 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>\n\n\n\ndata_Sevilla_train <- data_Sevilla %>% \n      filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Sevilla_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-10-14\" \"2021-02-13\" \"2021-02-13\" \"2021-06-14\" \"2021-10-14\" \n\n\n\ndata_Sevilla_test <- data_Sevilla %>% \n      filter(fecha > as.Date(\"2021-10-14\", format = \"%Y-%m-%d\"))\nsummary(data_Sevilla_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2021-10-15\" \"2021-11-25\" \"2022-01-05\" \"2022-01-05\" \"2022-02-15\" \"2022-03-29\" \n\n\n\n# Lamba for num_casos\nlambda_Sevilla_casos <- data_asturias %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_casos\n\n[1] 0.2278229\n\n# Lamba for average temp\nlambda_Sevilla_tmed <- data_asturias %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_tmed\n\n[1] 1.056074\n\n# Lamba for mobility\nlambda_Sevilla_grocery <- data_asturias %>%\n      features(mob_grocery_pharmacy, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_grocery\n\n[1] 1.377952\n\nlambda_Sevilla_parks <- data_asturias %>%\n      features(mob_parks, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_parks\n\n[1] 0.7188469\n\nlambda_Sevilla_resd <- data_asturias %>%\n      features(mob_residential, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_resd\n\n[1] 1.000064\n\nlambda_Sevilla_retail <- data_asturias %>%\n      features(mob_retail_recreation, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_retail\n\n[1] 1.058286\n\nlambda_Sevilla_transit <- data_asturias %>%\n      features(mob_transit_stations, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_transit\n\n[1] 1.116829\n\nlambda_Sevilla_work <- data_asturias %>%\n      features(mob_workplaces, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_work\n\n[1] 1.999927\n\n\n\nfit_model <- data_Sevilla_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Sevilla_casos) ~ \n                                    box_cox(tmed, lambda_Sevilla_tmed) + \n                                    box_cox(mob_grocery_pharmacy, lambda_Sevilla_grocery) +\n                                    box_cox(mob_parks, lambda_Sevilla_parks) +\n                                    box_cox(mob_residential, lambda_Sevilla_resd) +\n                                    box_cox(mob_retail_recreation, lambda_Sevilla_retail) +\n                                    box_cox(mob_transit_stations, lambda_Sevilla_transit) +\n                                    box_cox(mob_workplaces, lambda_Sevilla_work)\n                              ),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Sevilla_casos) ~ \n                                    box_cox(tmed, lambda_Sevilla_tmed) + \n                                    box_cox(mob_grocery_pharmacy, lambda_Sevilla_grocery) +\n                                    box_cox(mob_parks, lambda_Sevilla_parks) +\n                                    box_cox(mob_residential, lambda_Sevilla_resd) +\n                                    box_cox(mob_retail_recreation, lambda_Sevilla_retail) +\n                                    box_cox(mob_transit_stations, lambda_Sevilla_transit) +\n                                    box_cox(mob_workplaces, lambda_Sevilla_work),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Sevilla_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Sevilla   <LM w/ ARIMA(3,1,1)(2,0,0)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>   \n1 Sevilla   arima_at1  0.855   -647. 1321. 1322. 1380. <cpl [17]> <cpl [1]>\n2 Sevilla   arima_at2  0.837   -643. 1311. 1312. 1366. <cpl [10]> <cpl [7]>\n3 Sevilla   Snaive     2.47      NA    NA    NA    NA  <NULL>     <NULL>   \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(3,1,0)(1,0,1)[7] errors>  0.837   -643. 1311. 1312. 1366.\n2 arima_… <LM w/ ARIMA(3,1,1)(2,0,0)[7] errors>  0.855   -647. 1321. 1322. 1380.\n3 Snaive                               <SNAIVE>  2.47      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    6.00     0.539\n2 Sevilla   arima_at2   11.6      0.116\n3 Sevilla   Snaive     995.       0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    15.7     0.333\n2 Sevilla   arima_at2    21.0     0.101\n3 Sevilla   Snaive     1444.      0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    29.5    0.103 \n2 Sevilla   arima_at2    31.9    0.0603\n3 Sevilla   Snaive     1580.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=90)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    124.  0.0104  \n2 Sevilla   arima_at2    145.  0.000218\n3 Sevilla   Snaive      2311.  0       \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h90 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:90)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h90 <- fabletools::forecast(fit_model, new_data = data_fc_h90)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE    MPE  MAPE   MASE  RMSSE    ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl>  <dbl> <dbl>  <dbl>  <dbl>   <dbl>\n1 arima_at1 Sevilla   Test   3.54  9.18  7.23   8.02  21.4 0.0714 0.0582 -0.475 \n2 arima_at2 Sevilla   Test   7.41 10.6   8.11  20.4   23.0 0.0801 0.0675 -0.416 \n3 Snaive    Sevilla   Test  -5.28 15.6  13.3  -20.3   39.3 0.131  0.0990  0.0323\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model   provincia .type      ME  RMSE   MAE    MPE  MAPE   MASE  RMSSE   ACF1\n  <chr>    <chr>     <chr>   <dbl> <dbl> <dbl>  <dbl> <dbl>  <dbl>  <dbl>  <dbl>\n1 arima_a… Sevilla   Test    0.949  8.67  7.40  -6.17  28.5 0.0731 0.0549 -0.387\n2 arima_a… Sevilla   Test    6.21  10.4   7.82  14.3   24.1 0.0772 0.0659 -0.416\n3 Snaive   Sevilla   Test  -11.6   18.4  15.6  -54.4   63.9 0.154  0.117   0.268\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model  provincia .type     ME  RMSE   MAE     MPE  MAPE   MASE  RMSSE    ACF1\n  <chr>   <chr>     <chr>  <dbl> <dbl> <dbl>   <dbl> <dbl>  <dbl>  <dbl>   <dbl>\n1 arima_… Sevilla   Test    3.38  10.7  8.64   0.302  28.6 0.0853 0.0681 -0.0110\n2 arima_… Sevilla   Test    9.87  14.6 10.9   23.4    30.0 0.108  0.0924  0.143 \n3 Snaive  Sevilla   Test  -12.8   21.0 18.2  -57.0    68.6 0.180  0.133   0.328 \n\n\n\n\n90 days\n\n# Plots\nfc_h90 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(90))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h90\")\n\n\n\n\n\nfc_h90 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2021-10-14\", format = \"%Y-%m-%d\")+days(90) &\n                               fecha > as.Date(\"2021-07-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h90\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h90, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Sevilla   Test   687. 1168.  689.  58.0  66.1  6.80  7.40 0.898\n2 arima_at2 Sevilla   Test   717. 1200.  717.  71.8  73.5  7.09  7.61 0.898\n3 Snaive    Sevilla   Test   669. 1164.  680.  34.0  74.1  6.72  7.38 0.893"
  },
  {
    "objectID": "multivariate_google.html#asturias-1",
    "href": "multivariate_google.html#asturias-1",
    "title": "Multivariate (Google mobility + temp) prediction",
    "section": "Asturias",
    "text": "Asturias\n\ndata_asturias <- covid_data %>% \n      filter(provincia == \"Asturias\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_asturias\n\n# A tsibble: 653 x 10 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl> <dbl>                <dbl>     <dbl>\n 1 Asturias  2020-06-15         0  16                   -6          39\n 2 Asturias  2020-06-16         1  15.6                 -6           7\n 3 Asturias  2020-06-17         0  15.6                 -7          20\n 4 Asturias  2020-06-18         0  15.1                 -4          68\n 5 Asturias  2020-06-19         0  14.8                 -4          52\n 6 Asturias  2020-06-20         0  16.8                -10          71\n 7 Asturias  2020-06-21         0  18.2                 -5.5        46\n 8 Asturias  2020-06-22         0  18.2                 -1          99\n 9 Asturias  2020-06-23         0  20                   -2         129\n10 Asturias  2020-06-24         0  18.2                 -9          63\n# … with 643 more rows, and 4 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>\n\n\n\ndata_asturias_train <- data_asturias %>% \n      filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_asturias_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-11-10\" \"2021-04-08\" \"2021-04-08\" \"2021-09-04\" \"2022-01-31\" \n\n\n\ndata_asturias_test <- data_asturias %>% \n      filter(fecha > as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_asturias_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2022-02-01\" \"2022-02-15\" \"2022-03-01\" \"2022-03-01\" \"2022-03-15\" \"2022-03-29\" \n\n\n\n# Lamba for num_casos\nlambda_asturias_casos <- data_asturias %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_casos\n\n[1] 0.2278229\n\n# Lamba for average temp\nlambda_asturias_tmed <- data_asturias %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_tmed\n\n[1] 1.056074\n\n# Lamba for mobility\nlambda_asturias_grocery <- data_asturias %>%\n      features(mob_grocery_pharmacy, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_grocery\n\n[1] 1.377952\n\nlambda_asturias_parks <- data_asturias %>%\n      features(mob_parks, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_parks\n\n[1] 0.7188469\n\nlambda_asturias_resd <- data_asturias %>%\n      features(mob_residential, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_resd\n\n[1] 1.000064\n\nlambda_asturias_retail <- data_asturias %>%\n      features(mob_retail_recreation, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_retail\n\n[1] 1.058286\n\nlambda_asturias_transit <- data_asturias %>%\n      features(mob_transit_stations, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_transit\n\n[1] 1.116829\n\nlambda_asturias_work <- data_asturias %>%\n      features(mob_workplaces, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_asturias_work\n\n[1] 1.999927\n\n\n\nfit_model <- data_asturias_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_asturias_casos) ~ \n                                    box_cox(tmed, lambda_asturias_tmed) + \n                                    box_cox(mob_grocery_pharmacy, lambda_asturias_grocery) +\n                                    box_cox(mob_parks, lambda_asturias_parks) +\n                                    box_cox(mob_residential, lambda_asturias_resd) +\n                                    box_cox(mob_retail_recreation, lambda_asturias_retail) +\n                                    box_cox(mob_transit_stations, lambda_asturias_transit) +\n                                    box_cox(mob_workplaces, lambda_asturias_work)\n                              ),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_asturias_casos) ~ \n                                    box_cox(tmed, lambda_asturias_tmed) + \n                                    box_cox(mob_grocery_pharmacy, lambda_asturias_grocery) +\n                                    box_cox(mob_parks, lambda_asturias_parks) +\n                                    box_cox(mob_residential, lambda_asturias_resd) +\n                                    box_cox(mob_retail_recreation, lambda_asturias_retail) +\n                                    box_cox(mob_transit_stations, lambda_asturias_transit) +\n                                    box_cox(mob_workplaces, lambda_asturias_work),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_asturias_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Asturias  <LM w/ ARIMA(3,1,1)(2,0,0)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>   \n1 Asturias  arima_at1  0.916   -812. 1653. 1653. 1714. <cpl [17]> <cpl [1]>\n2 Asturias  arima_at2  0.891   -806. 1634. 1635. 1683. <cpl [7]>  <cpl [8]>\n3 Asturias  Snaive     2.53      NA    NA    NA    NA  <NULL>     <NULL>   \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(0,1,1)(1,0,1)[7] errors>  0.891   -806. 1634. 1635. 1683.\n2 arima_… <LM w/ ARIMA(3,1,1)(2,0,0)[7] errors>  0.916   -812. 1653. 1653. 1714.\n3 Snaive                               <SNAIVE>  2.53      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    16.9    0.0184\n2 Asturias  arima_at2    15.5    0.0301\n3 Asturias  Snaive      981.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    38.0  0.000521\n2 Asturias  arima_at2    34.2  0.00190 \n3 Asturias  Snaive     1393.   0       \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1    58.5 0.0000214\n2 Asturias  arima_at2    47.4 0.000829 \n3 Asturias  Snaive     1470.  0        \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=57)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Asturias  arima_at1   103.   0.000188\n2 Asturias  arima_at2    79.8  0.0249  \n3 Asturias  Snaive     1527.   0       \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_asturias_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_asturias_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_asturias_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h57 <- data_asturias_test %>% \n      select(-num_casos) %>% \n      slice(1:57)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h57 <- fabletools::forecast(fit_model, new_data = data_fc_h57)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Asturias  Test  -168.  272.  248. -24.8  29.9  2.56  1.24  0.200\n2 arima_at2 Asturias  Test  -253.  336.  319. -33.9  38.0  3.29  1.53  0.166\n3 Snaive    Asturias  Test  -570.  586.  570. -62.8  62.8  5.89  2.66 -0.550\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Asturias  Test  -271.  335.  311.  -44.3  46.9  3.21  1.52 0.387\n2 arima_at2 Asturias  Test  -402.  461.  434.  -62.5  64.5  4.49  2.09 0.457\n3 Snaive    Asturias  Test  -769.  812.  769. -107.  107.   7.94  3.69 0.299\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Asturias  Test  -353.  410.  380.  -74.4  76.1  3.93  1.87 0.530\n2 arima_at2 Asturias  Test  -502.  555.  524. -100.  101.   5.42  2.52 0.602\n3 Snaive    Asturias  Test  -920.  980.  920. -168.  168.   9.50  4.46 0.437\n\n\n\n\n57 days\n\n# Plots\nfc_h57 %>%\n      autoplot(\n            data_asturias_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(57))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h57\")\n\n\n\n\n\nfc_h57 %>%\n      autoplot(\n            data_asturias %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(57) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Asturias - forecast h57\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h57, data_asturias)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Asturias  Test   -571.  623.  581.  -Inf   Inf  6.00  2.83 0.706\n2 arima_at2 Asturias  Test   -707.  749.  715.  -Inf   Inf  7.39  3.41 0.710\n3 Snaive    Asturias  Test  -1282. 1359. 1282.  -Inf   Inf 13.3   6.18 0.471"
  },
  {
    "objectID": "multivariate_google.html#barcelona-1",
    "href": "multivariate_google.html#barcelona-1",
    "title": "Multivariate (Google mobility + temp) prediction",
    "section": "Barcelona",
    "text": "Barcelona\n\ndata_Barcelona <- covid_data %>% \n      filter(provincia == \"Barcelona\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Barcelona\n\n# A tsibble: 653 x 10 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl> <dbl>                <dbl>     <dbl>\n 1 Barcelona 2020-06-15        62  21.2                   -9        17\n 2 Barcelona 2020-06-16        66  20.8                  -10       -16\n 3 Barcelona 2020-06-17        70  20.3                   -4        14\n 4 Barcelona 2020-06-18        68  18.8                   -8        -6\n 5 Barcelona 2020-06-19        65  20.4                   -5        10\n 6 Barcelona 2020-06-20        53  21.8                  -12        15\n 7 Barcelona 2020-06-21        38  22.8                  -18        18\n 8 Barcelona 2020-06-22        69  23.8                    5        24\n 9 Barcelona 2020-06-23        95  23.4                   19        28\n10 Barcelona 2020-06-24        44  23.6                  -71        28\n# … with 643 more rows, and 4 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>\n\n\n\ndata_Barcelona_train <- data_Barcelona %>% \n      filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_Barcelona_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-11-10\" \"2021-04-08\" \"2021-04-08\" \"2021-09-04\" \"2022-01-31\" \n\n\n\ndata_Barcelona_test <- data_Barcelona %>% \n      filter(fecha > as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_Barcelona_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2022-02-01\" \"2022-02-15\" \"2022-03-01\" \"2022-03-01\" \"2022-03-15\" \"2022-03-29\" \n\n\n\n# Lamba for num_casos\nlambda_Barcelona_casos <- data_asturias %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_casos\n\n[1] 0.2278229\n\n# Lamba for average temp\nlambda_Barcelona_tmed <- data_asturias %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_tmed\n\n[1] 1.056074\n\n# Lamba for mobility\nlambda_Barcelona_grocery <- data_asturias %>%\n      features(mob_grocery_pharmacy, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_grocery\n\n[1] 1.377952\n\nlambda_Barcelona_parks <- data_asturias %>%\n      features(mob_parks, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_parks\n\n[1] 0.7188469\n\nlambda_Barcelona_resd <- data_asturias %>%\n      features(mob_residential, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_resd\n\n[1] 1.000064\n\nlambda_Barcelona_retail <- data_asturias %>%\n      features(mob_retail_recreation, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_retail\n\n[1] 1.058286\n\nlambda_Barcelona_transit <- data_asturias %>%\n      features(mob_transit_stations, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_transit\n\n[1] 1.116829\n\nlambda_Barcelona_work <- data_asturias %>%\n      features(mob_workplaces, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Barcelona_work\n\n[1] 1.999927\n\n\n\nfit_model <- data_Barcelona_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Barcelona_casos) ~ \n                                    box_cox(tmed, lambda_Barcelona_tmed) + \n                                    box_cox(mob_grocery_pharmacy, lambda_Barcelona_grocery) +\n                                    box_cox(mob_parks, lambda_Barcelona_parks) +\n                                    box_cox(mob_residential, lambda_Barcelona_resd) +\n                                    box_cox(mob_retail_recreation, lambda_Barcelona_retail) +\n                                    box_cox(mob_transit_stations, lambda_Barcelona_transit) +\n                                    box_cox(mob_workplaces, lambda_Barcelona_work)\n                              ),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Barcelona_casos) ~ \n                                    box_cox(tmed, lambda_Barcelona_tmed) + \n                                    box_cox(mob_grocery_pharmacy, lambda_Barcelona_grocery) +\n                                    box_cox(mob_parks, lambda_Barcelona_parks) +\n                                    box_cox(mob_residential, lambda_Barcelona_resd) +\n                                    box_cox(mob_retail_recreation, lambda_Barcelona_retail) +\n                                    box_cox(mob_transit_stations, lambda_Barcelona_transit) +\n                                    box_cox(mob_workplaces, lambda_Barcelona_work),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Barcelona_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Barcelona <LM w/ ARIMA(1,1,0)(1,0,0)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>   \n1 Barcelona arima_at1  0.909   -816. 1652. 1653. 1696. <cpl [8]>  <cpl [0]>\n2 Barcelona arima_at2  0.815   -783. 1591. 1592. 1648. <cpl [15]> <cpl [2]>\n3 Barcelona Snaive     4.60      NA    NA    NA    NA  <NULL>     <NULL>   \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(1,1,2)(2,0,0)[7] errors>  0.815   -783. 1591. 1592. 1648.\n2 arima_… <LM w/ ARIMA(1,1,0)(1,0,0)[7] errors>  0.909   -816. 1652. 1653. 1696.\n3 Snaive                               <SNAIVE>  4.60      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat     lb_pvalue\n  <chr>     <chr>       <dbl>         <dbl>\n1 Barcelona arima_at1    54.6 0.00000000179\n2 Barcelona arima_at2    15.2 0.0332       \n3 Barcelona Snaive     1689.  0            \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat     lb_pvalue\n  <chr>     <chr>       <dbl>         <dbl>\n1 Barcelona arima_at1    70.7 0.00000000145\n2 Barcelona arima_at2    37.2 0.000690     \n3 Barcelona Snaive     2232.  0            \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat     lb_pvalue\n  <chr>     <chr>       <dbl>         <dbl>\n1 Barcelona arima_at1    79.7 0.00000000897\n2 Barcelona arima_at2    41.8 0.00443      \n3 Barcelona Snaive     2328.  0            \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=57)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Barcelona arima_at1   150.   3.08e-10\n2 Barcelona arima_at2    99.5  4.27e- 4\n3 Barcelona Snaive     2625.   0       \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h57 <- data_Barcelona_test %>% \n      select(-num_casos) %>% \n      slice(1:57)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h57 <- fabletools::forecast(fit_model, new_data = data_fc_h57)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE    MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Barcelona Test   -304.  374.  304.  -4.15  4.15 0.382 0.191 -0.400 \n2 arima_at2 Barcelona Test  -1168. 1213. 1168. -15.2  15.2  1.47  0.619 -0.0336\n3 Snaive    Barcelona Test  -7681. 7943. 7681. -96.6  96.6  9.65  4.06   0.550 \n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model  provincia .type     ME   RMSE   MAE     MPE   MAPE   MASE RMSSE   ACF1\n  <chr>   <chr>     <chr>  <dbl>  <dbl> <dbl>   <dbl>  <dbl>  <dbl> <dbl>  <dbl>\n1 arima_… Barcelona Test   -342.   432.  365.   -6.19   6.90  0.458 0.221 0.0799\n2 arima_… Barcelona Test  -1123.  1217. 1123.  -19.4   19.4   1.41  0.621 0.408 \n3 Snaive  Barcelona Test  -9702. 10297. 9702. -182.   182.   12.2   5.26  0.547 \n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model provincia .type      ME   RMSE    MAE     MPE   MAPE   MASE RMSSE  ACF1\n  <chr>  <chr>     <chr>   <dbl>  <dbl>  <dbl>   <dbl>  <dbl>  <dbl> <dbl> <dbl>\n1 arima… Barcelona Test    -211.   381.   322.   -3.57   7.25  0.404 0.195 0.308\n2 arima… Barcelona Test    -841.  1032.   886.  -15.5   17.4   1.11  0.527 0.620\n3 Snaive Barcelona Test  -10898. 11601. 10898. -262.   262.   13.7   5.92  0.600\n\n\n\n\n57 days\n\n# Plots\nfc_h57 %>%\n      autoplot(\n            data_Barcelona_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(57))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h57\")\n\n\n\n\n\nfc_h57 %>%\n      autoplot(\n            data_Barcelona %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(57) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Barcelona - forecast h57\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h57, data_Barcelona)\n\n# A tibble: 3 × 11\n  .model    provincia .type      ME   RMSE    MAE   MPE  MAPE   MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>   <dbl>  <dbl>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl>\n1 arima_at1 Barcelona Test  -2.65e0   598.   482.  -Inf   Inf  0.605 0.305 0.689\n2 arima_at2 Barcelona Test   6.08e1   912.   777.  -Inf   Inf  0.976 0.466 0.848\n3 Snaive    Barcelona Test  -1.39e4 14803. 13931.  -Inf   Inf 17.5   7.56  0.580"
  },
  {
    "objectID": "multivariate_google.html#madrid-1",
    "href": "multivariate_google.html#madrid-1",
    "title": "Multivariate (Google mobility + temp) prediction",
    "section": "Madrid",
    "text": "Madrid\n\ndata_Madrid <- covid_data %>% \n      filter(provincia == \"Madrid\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Madrid\n\n# A tsibble: 653 x 10 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl> <dbl>                <dbl>     <dbl>\n 1 Madrid    2020-06-15       153  20.7                   -8        34\n 2 Madrid    2020-06-16        91  21                     -8        21\n 3 Madrid    2020-06-17        93  20.2                   -5        34\n 4 Madrid    2020-06-18        85  21.9                   -7        30\n 5 Madrid    2020-06-19        78  22.6                   -9        22\n 6 Madrid    2020-06-20        67  23.4                  -12        25\n 7 Madrid    2020-06-21        42  25                    -13        14\n 8 Madrid    2020-06-22        60  27.3                   -8        29\n 9 Madrid    2020-06-23        68  28.4                   -9        23\n10 Madrid    2020-06-24        49  28                     -7        22\n# … with 643 more rows, and 4 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>\n\n\n\ndata_Madrid_train <- data_Madrid %>% \n      filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_Madrid_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-11-10\" \"2021-04-08\" \"2021-04-08\" \"2021-09-04\" \"2022-01-31\" \n\n\n\ndata_Madrid_test <- data_Madrid %>% \n      filter(fecha > as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_Madrid_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2022-02-01\" \"2022-02-15\" \"2022-03-01\" \"2022-03-01\" \"2022-03-15\" \"2022-03-29\" \n\n\n\n# Lamba for num_casos\nlambda_Madrid_casos <- data_asturias %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_casos\n\n[1] 0.2278229\n\n# Lamba for average temp\nlambda_Madrid_tmed <- data_asturias %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_tmed\n\n[1] 1.056074\n\n# Lamba for mobility\nlambda_Madrid_grocery <- data_asturias %>%\n      features(mob_grocery_pharmacy, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_grocery\n\n[1] 1.377952\n\nlambda_Madrid_parks <- data_asturias %>%\n      features(mob_parks, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_parks\n\n[1] 0.7188469\n\nlambda_Madrid_resd <- data_asturias %>%\n      features(mob_residential, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_resd\n\n[1] 1.000064\n\nlambda_Madrid_retail <- data_asturias %>%\n      features(mob_retail_recreation, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_retail\n\n[1] 1.058286\n\nlambda_Madrid_transit <- data_asturias %>%\n      features(mob_transit_stations, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_transit\n\n[1] 1.116829\n\nlambda_Madrid_work <- data_asturias %>%\n      features(mob_workplaces, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Madrid_work\n\n[1] 1.999927\n\n\n\nfit_model <- data_Madrid_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Madrid_casos) ~ \n                                    box_cox(tmed, lambda_Madrid_tmed) + \n                                    box_cox(mob_grocery_pharmacy, lambda_Madrid_grocery) +\n                                    box_cox(mob_parks, lambda_Madrid_parks) +\n                                    box_cox(mob_residential, lambda_Madrid_resd) +\n                                    box_cox(mob_retail_recreation, lambda_Madrid_retail) +\n                                    box_cox(mob_transit_stations, lambda_Madrid_transit) +\n                                    box_cox(mob_workplaces, lambda_Madrid_work)\n                              ),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Madrid_casos) ~ \n                                    box_cox(tmed, lambda_Madrid_tmed) + \n                                    box_cox(mob_grocery_pharmacy, lambda_Madrid_grocery) +\n                                    box_cox(mob_parks, lambda_Madrid_parks) +\n                                    box_cox(mob_residential, lambda_Madrid_resd) +\n                                    box_cox(mob_retail_recreation, lambda_Madrid_retail) +\n                                    box_cox(mob_transit_stations, lambda_Madrid_transit) +\n                                    box_cox(mob_workplaces, lambda_Madrid_work),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Madrid_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Madrid    <LM w/ ARIMA(1,1,1)(1,0,2)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots  ma_roots  \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>    <list>    \n1 Madrid    arima_at1   1.18   -892. 1809. 1810. 1866. <cpl [8]> <cpl [15]>\n2 Madrid    arima_at2   1.17   -889. 1804. 1804. 1861. <cpl [8]> <cpl [9]> \n3 Madrid    Snaive      5.10     NA    NA    NA    NA  <NULL>    <NULL>    \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(1,1,2)(1,0,1)[7] errors>   1.17   -889. 1804. 1804. 1861.\n2 arima_… <LM w/ ARIMA(1,1,1)(1,0,2)[7] errors>   1.18   -892. 1809. 1810. 1866.\n3 Snaive                               <SNAIVE>   5.10     NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1   12.6     0.0823\n2 Madrid    arima_at2    6.30    0.506 \n3 Madrid    Snaive    1552.      0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    25.5    0.0299\n2 Madrid    arima_at2    21.3    0.0953\n3 Madrid    Snaive     2076.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    36.2    0.0208\n2 Madrid    arima_at2    33.0    0.0462\n3 Madrid    Snaive     2151.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=57)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Madrid    arima_at1    86.2   0.00747\n2 Madrid    arima_at2    78.0   0.0338 \n3 Madrid    Snaive     2518.    0      \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h57 <- data_Madrid_test %>% \n      select(-num_casos) %>% \n      slice(1:57)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h57 <- fabletools::forecast(fit_model, new_data = data_fc_h57)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE    MPE  MAPE  MASE RMSSE    ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl>   <dbl>\n1 arima_at1 Madrid    Test    268.  509.  401.   4.78  7.20 0.537 0.285 0.0164 \n2 arima_at2 Madrid    Test    348.  569.  462.   6.71  8.51 0.619 0.319 0.00237\n3 Snaive    Madrid    Test  -1649. 1869. 1649. -32.7  32.7  2.21  1.05  0.537  \n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type      ME  RMSE   MAE     MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>   <dbl> <dbl> <dbl>   <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Madrid    Test    -70.1  586.  460.  -3.97   12.0 0.615 0.328 0.309\n2 arima_at2 Madrid    Test     56.2  553.  449.  -0.301  11.3 0.601 0.309 0.289\n3 Snaive    Madrid    Test  -2634.  3064. 2634. -70.0    70.0 3.53  1.72  0.464\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Madrid    Test   -449.  911.  709.  -25.2  30.6 0.949 0.510 0.559\n2 arima_at2 Madrid    Test   -320.  830.  657.  -20.4  27.8 0.880 0.465 0.555\n3 Snaive    Madrid    Test  -3530. 4142. 3530. -143.  143.  4.73  2.32  0.576\n\n\n\n\n57 days\n\n# Plots\nfc_h57 %>%\n      autoplot(\n            data_Madrid_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(57))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h57\")\n\n\n\n\n\nfc_h57 %>%\n      autoplot(\n            data_Madrid %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(57) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Madrid - forecast h57\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h57, data_Madrid)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Madrid    Test  -1153. 1478. 1249. -1126. 1128.  1.67 0.828 0.660\n2 arima_at2 Madrid    Test  -1337. 1762. 1461. -1430. 1433.  1.96 0.986 0.741\n3 Snaive    Madrid    Test  -5635. 6384. 5635. -4097. 4097.  7.54 3.57  0.622"
  },
  {
    "objectID": "multivariate_google.html#malaga-1",
    "href": "multivariate_google.html#malaga-1",
    "title": "Multivariate (Google mobility + temp) prediction",
    "section": "Malaga",
    "text": "Malaga\n\ndata_Malaga <- covid_data %>% \n      filter(provincia == \"Málaga\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Malaga\n\n# A tsibble: 653 x 10 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl> <dbl>                <dbl>     <dbl>\n 1 Málaga    2020-06-15         1  27.2                  -16        -9\n 2 Málaga    2020-06-16         1  27.8                  -13        -4\n 3 Málaga    2020-06-17         2  26.9                  -13         1\n 4 Málaga    2020-06-18         2  21.6                  -12         3\n 5 Málaga    2020-06-19         1  24.7                  -12         2\n 6 Málaga    2020-06-20         4  22.6                  -14         8\n 7 Málaga    2020-06-21         4  22.7                  -16        -3\n 8 Málaga    2020-06-22         6  25                    -13         1\n 9 Málaga    2020-06-23         8  25.6                  -10        18\n10 Málaga    2020-06-24        65  24.5                  -13        12\n# … with 643 more rows, and 4 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>\n\n\n\ndata_Malaga_train <- data_Malaga %>% \n      filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_Malaga_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-11-10\" \"2021-04-08\" \"2021-04-08\" \"2021-09-04\" \"2022-01-31\" \n\n\n\ndata_Malaga_test <- data_Malaga %>% \n      filter(fecha > as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_Malaga_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2022-02-01\" \"2022-02-15\" \"2022-03-01\" \"2022-03-01\" \"2022-03-15\" \"2022-03-29\" \n\n\n\n# Lamba for num_casos\nlambda_Malaga_casos <- data_asturias %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_casos\n\n[1] 0.2278229\n\n# Lamba for average temp\nlambda_Malaga_tmed <- data_asturias %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_tmed\n\n[1] 1.056074\n\n# Lamba for mobility\nlambda_Malaga_grocery <- data_asturias %>%\n      features(mob_grocery_pharmacy, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_grocery\n\n[1] 1.377952\n\nlambda_Malaga_parks <- data_asturias %>%\n      features(mob_parks, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_parks\n\n[1] 0.7188469\n\nlambda_Malaga_resd <- data_asturias %>%\n      features(mob_residential, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_resd\n\n[1] 1.000064\n\nlambda_Malaga_retail <- data_asturias %>%\n      features(mob_retail_recreation, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_retail\n\n[1] 1.058286\n\nlambda_Malaga_transit <- data_asturias %>%\n      features(mob_transit_stations, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_transit\n\n[1] 1.116829\n\nlambda_Malaga_work <- data_asturias %>%\n      features(mob_workplaces, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Malaga_work\n\n[1] 1.999927\n\n\n\nfit_model <- data_Malaga_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Malaga_casos) ~ \n                                    box_cox(tmed, lambda_Malaga_tmed) + \n                                    box_cox(mob_grocery_pharmacy, lambda_Malaga_grocery) +\n                                    box_cox(mob_parks, lambda_Malaga_parks) +\n                                    box_cox(mob_residential, lambda_Malaga_resd) +\n                                    box_cox(mob_retail_recreation, lambda_Malaga_retail) +\n                                    box_cox(mob_transit_stations, lambda_Malaga_transit) +\n                                    box_cox(mob_workplaces, lambda_Malaga_work)\n                              ),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Malaga_casos) ~ \n                                    box_cox(tmed, lambda_Malaga_tmed) + \n                                    box_cox(mob_grocery_pharmacy, lambda_Malaga_grocery) +\n                                    box_cox(mob_parks, lambda_Malaga_parks) +\n                                    box_cox(mob_residential, lambda_Malaga_resd) +\n                                    box_cox(mob_retail_recreation, lambda_Malaga_retail) +\n                                    box_cox(mob_transit_stations, lambda_Malaga_transit) +\n                                    box_cox(mob_workplaces, lambda_Malaga_work),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Malaga_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Málaga    <LM w/ ARIMA(4,1,0)(2,0,0)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots  \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>    \n1 Málaga    arima_at1  0.568   -671. 1369. 1370. 1431. <cpl [18]> <cpl [0]> \n2 Málaga    arima_at2  0.550   -662. 1352. 1353. 1414. <cpl [7]>  <cpl [11]>\n3 Málaga    Snaive     2.32      NA    NA    NA    NA  <NULL>     <NULL>    \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(0,1,4)(1,0,1)[7] errors>  0.550   -662. 1352. 1353. 1414.\n2 arima_… <LM w/ ARIMA(4,1,0)(2,0,0)[7] errors>  0.568   -671. 1369. 1370. 1431.\n3 Snaive                               <SNAIVE>  2.32      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    8.51     0.290\n2 Málaga    arima_at2    4.99     0.661\n3 Málaga    Snaive    1613.       0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    27.2    0.0181\n2 Málaga    arima_at2    24.1    0.0447\n3 Málaga    Snaive     2365.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    45.8   0.00136\n2 Málaga    arima_at2    35.4   0.0258 \n3 Málaga    Snaive     2545.    0      \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=57)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Málaga    arima_at1    99.1  0.000463\n2 Málaga    arima_at2    87.6  0.00568 \n3 Málaga    Snaive     3404.   0       \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h57 <- data_Malaga_test %>% \n      select(-num_casos) %>% \n      slice(1:57)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h57 <- fabletools::forecast(fit_model, new_data = data_fc_h57)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type      ME  RMSE   MAE    MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr>   <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Málaga    Test    24.7   169.  128.  -5.55  22.5 0.971 0.683 0.0978\n2 arima_at2 Málaga    Test     2.08  162.  117.  -9.09  21.7 0.888 0.653 0.175 \n3 Snaive    Málaga    Test  -170.    240.  192. -33.7   35.9 1.45  0.969 0.246 \n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE     MPE  MAPE  MASE RMSSE   ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>   <dbl> <dbl> <dbl> <dbl>  <dbl>\n1 arima_at1 Málaga    Test   112.   245.  194.   5.34   27.3  1.47 0.988 0.293 \n2 arima_at2 Málaga    Test    79.4  220.  176.   0.521  26.3  1.33 0.891 0.268 \n3 Snaive    Málaga    Test  -142.   223.  170. -28.9    31.9  1.29 0.901 0.0235\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Málaga    Test    92.3  227.  170.   3.69  24.7  1.29 0.917 0.401\n2 arima_at2 Málaga    Test    59.7  201.  153.  -1.09  23.6  1.16 0.813 0.364\n3 Snaive    Málaga    Test  -209.   280.  228. -41.6   43.5  1.72 1.13  0.172\n\n\n\n\n57 days\n\n# Plots\nfc_h57 %>%\n      autoplot(\n            data_Malaga_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(57))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h57\")\n\n\n\n\n\nfc_h57 %>%\n      autoplot(\n            data_Malaga %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(57) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Malaga - forecast h57\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h57, data_Malaga)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Málaga    Test   -35.6  246.  182.  -Inf   Inf  1.38 0.993 0.597\n2 arima_at2 Málaga    Test   -30.4  219.  161.  -Inf   Inf  1.22 0.885 0.534\n3 Snaive    Málaga    Test  -438.   527.  445.  -Inf   Inf  3.37 2.13  0.514"
  },
  {
    "objectID": "multivariate_google.html#sevilla-1",
    "href": "multivariate_google.html#sevilla-1",
    "title": "Multivariate (Google mobility + temp) prediction",
    "section": "Sevilla",
    "text": "Sevilla\n\ndata_Sevilla <- covid_data %>% \n      filter(provincia == \"Sevilla\") %>% \n      filter(fecha > as.Date(\"2020-06-14\", format = \"%Y-%m-%d\")) %>% \n      select(provincia, fecha, num_casos, tmed, mob_grocery_pharmacy, mob_parks, mob_residential, mob_retail_recreation, mob_transit_stations, mob_workplaces) %>% \n      drop_na() %>% \n      as_tsibble(key = provincia, index = fecha)\ndata_Sevilla\n\n# A tsibble: 653 x 10 [1D]\n# Key:       provincia [1]\n   provincia fecha      num_casos  tmed mob_grocery_pharmacy mob_parks\n   <chr>     <date>         <dbl> <dbl>                <dbl>     <dbl>\n 1 Sevilla   2020-06-15         2  23.1                  -14       -13\n 2 Sevilla   2020-06-16         1  24.0                  -10        -4\n 3 Sevilla   2020-06-17         0  24.9                  -10        -7\n 4 Sevilla   2020-06-18         0  25.8                  -12       -13\n 5 Sevilla   2020-06-19         0  26.6                  -13       -20\n 6 Sevilla   2020-06-20         0  27.5                  -20       -34\n 7 Sevilla   2020-06-21         0  28.4                  -27       -47\n 8 Sevilla   2020-06-22         1  29.3                  -17       -19\n 9 Sevilla   2020-06-23         0  30.2                  -12       -13\n10 Sevilla   2020-06-24         1  29.4                  -12       -12\n# … with 643 more rows, and 4 more variables: mob_residential <dbl>,\n#   mob_retail_recreation <dbl>, mob_transit_stations <dbl>,\n#   mob_workplaces <dbl>\n\n\n\ndata_Sevilla_train <- data_Sevilla %>% \n      filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_Sevilla_train$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2020-06-15\" \"2020-11-10\" \"2021-04-08\" \"2021-04-08\" \"2021-09-04\" \"2022-01-31\" \n\n\n\ndata_Sevilla_test <- data_Sevilla %>% \n      filter(fecha > as.Date(\"2022-01-31\", format = \"%Y-%m-%d\"))\nsummary(data_Sevilla_test$fecha)\n\n        Min.      1st Qu.       Median         Mean      3rd Qu.         Max. \n\"2022-02-01\" \"2022-02-15\" \"2022-03-01\" \"2022-03-01\" \"2022-03-15\" \"2022-03-29\" \n\n\n\n# Lamba for num_casos\nlambda_Sevilla_casos <- data_asturias %>%\n      features(num_casos, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_casos\n\n[1] 0.2278229\n\n# Lamba for average temp\nlambda_Sevilla_tmed <- data_asturias %>%\n      features(tmed, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_tmed\n\n[1] 1.056074\n\n# Lamba for mobility\nlambda_Sevilla_grocery <- data_asturias %>%\n      features(mob_grocery_pharmacy, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_grocery\n\n[1] 1.377952\n\nlambda_Sevilla_parks <- data_asturias %>%\n      features(mob_parks, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_parks\n\n[1] 0.7188469\n\nlambda_Sevilla_resd <- data_asturias %>%\n      features(mob_residential, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_resd\n\n[1] 1.000064\n\nlambda_Sevilla_retail <- data_asturias %>%\n      features(mob_retail_recreation, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_retail\n\n[1] 1.058286\n\nlambda_Sevilla_transit <- data_asturias %>%\n      features(mob_transit_stations, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_transit\n\n[1] 1.116829\n\nlambda_Sevilla_work <- data_asturias %>%\n      features(mob_workplaces, features = guerrero) %>%\n      pull(lambda_guerrero)\nlambda_Sevilla_work\n\n[1] 1.999927\n\n\n\nfit_model <- data_Sevilla_train %>%\n      model(\n            arima_at1 = ARIMA(box_cox(num_casos, lambda_Sevilla_casos) ~ \n                                    box_cox(tmed, lambda_Sevilla_tmed) + \n                                    box_cox(mob_grocery_pharmacy, lambda_Sevilla_grocery) +\n                                    box_cox(mob_parks, lambda_Sevilla_parks) +\n                                    box_cox(mob_residential, lambda_Sevilla_resd) +\n                                    box_cox(mob_retail_recreation, lambda_Sevilla_retail) +\n                                    box_cox(mob_transit_stations, lambda_Sevilla_transit) +\n                                    box_cox(mob_workplaces, lambda_Sevilla_work)\n                              ),\n            arima_at2 = ARIMA(box_cox(num_casos, lambda_Sevilla_casos) ~ \n                                    box_cox(tmed, lambda_Sevilla_tmed) + \n                                    box_cox(mob_grocery_pharmacy, lambda_Sevilla_grocery) +\n                                    box_cox(mob_parks, lambda_Sevilla_parks) +\n                                    box_cox(mob_residential, lambda_Sevilla_resd) +\n                                    box_cox(mob_retail_recreation, lambda_Sevilla_retail) +\n                                    box_cox(mob_transit_stations, lambda_Sevilla_transit) +\n                                    box_cox(mob_workplaces, lambda_Sevilla_work),\n                              stepwise = FALSE, approx = FALSE),\n            Snaive = SNAIVE(box_cox(num_casos, lambda_Sevilla_casos))\n      )\n\n# Show and report model\nfit_model\n\n# A mable: 1 x 4\n# Key:     provincia [1]\n  provincia                             arima_at1\n  <chr>                                   <model>\n1 Sevilla   <LM w/ ARIMA(3,1,1)(2,0,0)[7] errors>\n# … with 2 more variables: arima_at2 <model>, Snaive <model>\n\n\n\nglance(fit_model)\n\n# A tibble: 3 × 9\n  provincia .model    sigma2 log_lik   AIC  AICc   BIC ar_roots   ma_roots  \n  <chr>     <chr>      <dbl>   <dbl> <dbl> <dbl> <dbl> <list>     <list>    \n1 Sevilla   arima_at1  0.940   -821. 1670. 1670. 1731. <cpl [17]> <cpl [1]> \n2 Sevilla   arima_at2  0.910   -813. 1654. 1654. 1715. <cpl [7]>  <cpl [11]>\n3 Sevilla   Snaive     2.93      NA    NA    NA    NA  <NULL>     <NULL>    \n\n\n\nfit_model %>% \n      pivot_longer(-provincia,\n                   names_to = \".model\",\n                   values_to = \"orders\") %>% \n      left_join(glance(fit_model), by = c(\"provincia\", \".model\")) %>% \n      arrange(AICc) %>% \n      select(.model:BIC)\n\n# A mable: 3 x 7\n# Key:     .model [3]\n  .model                                 orders sigma2 log_lik   AIC  AICc   BIC\n  <chr>                                 <model>  <dbl>   <dbl> <dbl> <dbl> <dbl>\n1 arima_… <LM w/ ARIMA(0,1,4)(1,0,1)[7] errors>  0.910   -813. 1654. 1654. 1715.\n2 arima_… <LM w/ ARIMA(3,1,1)(2,0,0)[7] errors>  0.940   -821. 1670. 1670. 1731.\n3 Snaive                               <SNAIVE>  2.93      NA    NA    NA    NA \n\n\n\n# We use a Ljung-Box test >> large p-value, confirms residuals are similar / considered to white noise\nfit_model %>% \n      select(Snaive) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at1) %>% \n      gg_tsresiduals()\n\n\n\n\n\nfit_model %>% \n      select(arima_at2) %>% \n      gg_tsresiduals()\n\n\n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=7)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    2.80     0.903\n2 Sevilla   arima_at2    1.90     0.965\n3 Sevilla   Snaive    1179.       0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=14)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    18.2     0.198\n2 Sevilla   arima_at2    15.5     0.343\n3 Sevilla   Snaive     1697.      0    \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=21)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    29.8    0.0960\n2 Sevilla   arima_at2    24.7    0.261 \n3 Sevilla   Snaive     1803.     0     \n\n\n\naugment(fit_model) %>%\n      features(.innov, ljung_box, lag=57)\n\n# A tibble: 3 × 4\n  provincia .model    lb_stat lb_pvalue\n  <chr>     <chr>       <dbl>     <dbl>\n1 Sevilla   arima_at1    74.5    0.0599\n2 Sevilla   arima_at2    71.2    0.0979\n3 Sevilla   Snaive     2248.     0     \n\n\n\n# To predict future values of infections, we need to pass the model future/prediction values of the complementary variables tmed and mobility\n# We are going to select those from the test dataset\ndata_fc_h7 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:7)\ndata_fc_h14 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:14)\ndata_fc_h21 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:21)\ndata_fc_h57 <- data_Sevilla_test %>% \n      select(-num_casos) %>% \n      slice(1:57)\n\n\n# Significant spikes out of 30 is still consistent with white noise\n# To be sure, use a Ljung-Box test, which has a large p-value, confirming that\n# the residuals are similar to white noise.\n# Note that the alternative models also passed this test.\n# \n# Forecast\nfc_h7  <- fabletools::forecast(fit_model, new_data = data_fc_h7)\nfc_h14 <- fabletools::forecast(fit_model, new_data = data_fc_h14)\nfc_h21 <- fabletools::forecast(fit_model, new_data = data_fc_h21)\nfc_h57 <- fabletools::forecast(fit_model, new_data = data_fc_h57)\n\n\n7 days\n\n# Plots\nfc_h7 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(7))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h7\")\n\n\n\n\n\nfc_h7 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(7) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h7\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h7, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Sevilla   Test    43.3  75.6  58.3   5.86  9.89 0.407 0.277 0.110\n2 arima_at2 Sevilla   Test    37.2  72.4  52.1   6.09  9.43 0.364 0.265 0.196\n3 Snaive    Sevilla   Test  -293.  356.  300.  -46.0  47.8  2.10  1.30  0.521\n\n\n\n\n14 days\n\n# Plots\nfc_h14 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(14))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h14\")\n\n\n\n\n\nfc_h14 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(14) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h14\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h14, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Sevilla   Test   139.  224.  157.  15.1  21.6  1.10 0.819 0.417\n2 arima_at2 Sevilla   Test   132.  211.  147.  15.7  20.2  1.02 0.773 0.379\n3 Snaive    Sevilla   Test  -279.  321.  282. -47.5  48.4  1.97 1.17  0.409\n\n\n\n\n21 days\n\n# Plots\nfc_h21 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(21))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h21\")\n\n\n\n\n\nfc_h21 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(21) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h21\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h21, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Sevilla   Test   123.  211.  155.  10.3  26.5 1.09  0.772 0.476\n2 arima_at2 Sevilla   Test   121.  196.  140.  13.4  22.3 0.980 0.716 0.421\n3 Snaive    Sevilla   Test  -356.  404.  358. -71.9  72.5 2.50  1.48  0.498\n\n\n\n\n57 days\n\n# Plots\nfc_h57 %>%\n      autoplot(\n            data_Sevilla_test %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(57))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h57\")\n\n\n\n\n\nfc_h57 %>%\n      autoplot(\n            data_Sevilla %>% \n                  filter(fecha <= as.Date(\"2022-01-31\", format = \"%Y-%m-%d\")+days(57) &\n                               fecha > as.Date(\"2022-01-01\", format = \"%Y-%m-%d\"))\n      ) +\n      labs(y = \"Nº cases\", title = \"Sevilla - forecast h57\")\n\n\n\n\n\n# Accuracy\nfabletools::accuracy(fc_h57, data_Sevilla)\n\n# A tibble: 3 × 11\n  .model    provincia .type     ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1\n  <chr>     <chr>     <chr>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n1 arima_at1 Sevilla   Test   -43.3  207.  154.  -Inf   Inf 1.08  0.756 0.707\n2 arima_at2 Sevilla   Test    15.5  155.  113.  -Inf   Inf 0.786 0.566 0.597\n3 Snaive    Sevilla   Test  -681.   784.  682.  -Inf   Inf 4.77  2.87  0.637"
  },
  {
    "objectID": "lstm_uni.html",
    "href": "lstm_uni.html",
    "title": "LSTM univariate prediction",
    "section": "",
    "text": "Import python packages:"
  },
  {
    "objectID": "lstm_uni.html#asturias",
    "href": "lstm_uni.html#asturias",
    "title": "LSTM univariate prediction",
    "section": "Asturias",
    "text": "Asturias\n\ndata_asturias = data_covid.loc[data_covid['provincia'] == 'Asturias']\ndata_asturias = data_asturias.set_index('fecha')\ndata_asturias = data_asturias.filter(['num_casos'])\ndata_asturias = data_asturias['2020-06-14':]\ndata_asturias\n\n\n\n\n\n  \n    \n      \n      num_casos\n    \n    \n      fecha\n      \n    \n  \n  \n    \n      2020-06-14\n      0\n    \n    \n      2020-06-15\n      0\n    \n    \n      2020-06-16\n      1\n    \n    \n      2020-06-17\n      0\n    \n    \n      2020-06-18\n      0\n    \n    \n      ...\n      ...\n    \n    \n      2022-03-25\n      244\n    \n    \n      2022-03-26\n      432\n    \n    \n      2022-03-27\n      1\n    \n    \n      2022-03-28\n      9\n    \n    \n      2022-03-29\n      0\n    \n  \n\n654 rows × 1 columns\n\n\n\n\ndata_asturias.describe()\n\n\n\n\n\n  \n    \n      \n      num_casos\n    \n  \n  \n    \n      count\n      654.00000\n    \n    \n      mean\n      312.11315\n    \n    \n      std\n      565.17985\n    \n    \n      min\n      0.00000\n    \n    \n      25%\n      43.50000\n    \n    \n      50%\n      117.00000\n    \n    \n      75%\n      323.75000\n    \n    \n      max\n      3827.00000\n    \n  \n\n\n\n\n\nnp_data_asturias = data_asturias.values\n\n\nscaler = MinMaxScaler(feature_range=(0, 1))\nscaled_data_asturias = scaler.fit_transform(np_data_asturias)\nprint(f'Longitud del conjunto de datos disponible: {len(scaled_data_asturias)}')\n\nLongitud del conjunto de datos disponible: 654\n\n\n\n# Since we are going to predict future values based on the X past elements, \n# we need to create a list with those historic information for each element\nhistoric_values = 90\nscaled_data_asturias_x = []\nscaled_data_asturias_y = []\n\nfor num_casos_i in range(historic_values, len(scaled_data_asturias)):\n    scaled_data_asturias_x.append(scaled_data_asturias[(num_casos_i-historic_values):num_casos_i, 0])\n    scaled_data_asturias_y.append(scaled_data_asturias[num_casos_i, 0])\n\n# Convert the x_train and y_train to numpy arrays\nscaled_data_asturias_x = np.array(scaled_data_asturias_x)\nscaled_data_asturias_y = np.array(scaled_data_asturias_y)\n\n\n# Train data looks like\nscaled_data_asturias_x[235]\n\narray([0.07002874, 0.0611445 , 0.07107395, 0.07394826, 0.06689313,\n       0.05644108, 0.05278286, 0.03841129, 0.03501437, 0.04285341,\n       0.04990854, 0.05016985, 0.04285341, 0.03710478, 0.03057225,\n       0.03240136, 0.03945649, 0.03971779, 0.03762738, 0.04311471,\n       0.02926574, 0.02691403, 0.03945649, 0.03919519, 0.03396917,\n       0.04206951, 0.03684348, 0.03841129, 0.03475307, 0.02795924,\n       0.02560753, 0.02743663, 0.03788869, 0.03814999, 0.02769794,\n       0.03031095, 0.02822054, 0.03893389, 0.03240136, 0.03553697,\n       0.03971779, 0.01802979, 0.01646198, 0.03004965, 0.03109485,\n       0.02926574, 0.04468252, 0.03266266, 0.02482362, 0.03031095,\n       0.03109485, 0.03893389, 0.03579828, 0.02325581, 0.03841129,\n       0.0195976 , 0.02508492, 0.02456232, 0.03057225, 0.03527567,\n       0.03919519, 0.03605958, 0.02534622, 0.02926574, 0.03240136,\n       0.04807944, 0.0399791 , 0.03396917, 0.02743663, 0.02325581,\n       0.02613013, 0.03083355, 0.03788869, 0.02848184, 0.03344656,\n       0.03396917, 0.02822054, 0.02247191, 0.02351712, 0.02586883,\n       0.02534622, 0.02874314, 0.0198589 , 0.0211654 , 0.01254246,\n       0.01907499, 0.01228116, 0.01228116, 0.01881369, 0.01515547])\n\n\n\n# Test data looks like\nscaled_data_asturias_y[235]\n\n0.013326365299189964\n\n\n\n# Since the first 90 values does not have historic, the dataset has been reduced in 90 values\nprint(f'Longitud datos de entrenamiento con historico: {len(scaled_data_asturias_y)}')\n\nLongitud datos de entrenamiento con historico: 564\n\n\n\n# we split data in train and test\n# as in previous analysis, we are going to predict a maximum of 21 days\nx_train = scaled_data_asturias_x[0:len(scaled_data_asturias_x)-91]\ny_train = scaled_data_asturias_y[0:len(scaled_data_asturias_y)-91]\nprint(f'Cantidad datos de entrenamiento: x={len(x_train)} - y={len(y_train)}')\n\nx_test = scaled_data_asturias_x[len(scaled_data_asturias_x)-90:len(scaled_data_asturias_x)]\ny_test = scaled_data_asturias_y[len(scaled_data_asturias_y)-90:len(scaled_data_asturias_y)]\nprint(f'Cantidad datos de test: x={len(x_test)} - y={len(y_test)}')\n\nCantidad datos de entrenamiento: x=473 - y=473\nCantidad datos de test: x=90 - y=90\n\n\n\n# Reshape the data to feed de recurrent network\nx_train = np.reshape(x_train, (x_train.shape[0], x_train.shape[1], 1))\nprint(\"Train data shape:\")\nprint(x_train.shape)\nprint(y_train.shape)\nx_test = np.reshape(x_test, (x_test.shape[0], x_test.shape[1], 1))\nprint(\"Test data shape:\")\nprint(x_test.shape)\nprint(y_test.shape)\n\nTrain data shape:\n(473, 90, 1)\n(473,)\nTest data shape:\n(90, 90, 1)\n(90,)\n\n\n\n# # Configure / setup the neural network model - LSTM\n# Build the model\nprint('Build model...')\nmodel = Sequential()\n# Model with Neurons \n# Inputshape = neurons -> Timestamps\nneurons= x_train.shape[1]\nmodel.add(LSTM(90, \n               activation = 'relu',\n               return_sequences = True, \n               input_shape = (x_train.shape[1], 1))) \nmodel.add(LSTM(50, \n               activation = 'relu',\n               return_sequences = True)) \nmodel.add(LSTM(25, \n               activation = 'relu',\n               return_sequences = False)) \nmodel.add(Dense(5, activation = 'relu'))\nmodel.add(Dense(1))\n\nBuild model...\n\n\n2022-05-25 01:22:54.266575: I tensorflow/core/platform/cpu_feature_guard.cc:193] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 FMA\nTo enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.\n\n\n\nmodel.compile(optimizer='adam', loss='mean_squared_error')\nmodel.summary()\n\nModel: \"sequential\"\n\n\n_________________________________________________________________\n\n\n Layer (type)                Output Shape              Param #   \n\n\n=================================================================\n\n\n lstm (LSTM)                 (None, 90, 90)            33120     \n\n\n                                                                 \n\n\n lstm_1 (LSTM)               (None, 90, 50)            28200     \n\n\n                                                                 \n\n\n lstm_2 (LSTM)               (None, 25)                7600      \n\n\n                                                                 \n\n\n dense (Dense)               (None, 5)                 130       \n\n\n                                                                 \n\n\n dense_1 (Dense)             (None, 1)                 6         \n\n\n                                                                 \n\n\n=================================================================\n\n\nTotal params: 69,056\n\n\nTrainable params: 69,056\n\n\nNon-trainable params: 0\n\n\n_________________________________________________________________\n\n\n\n# Training the model\n# # fit network\nhistory = model.fit(x_train, \n                    y_train, \n                    batch_size=1000, \n                    epochs = 30, \n                    validation_data = (x_test, y_test), \n                    verbose = 0)\n\n\nplt.plot(history.history['loss'], label='train')\nplt.plot(history.history['val_loss'], label='test')\nplt.legend()\nplt.show() \n\n\n\n\n\n# Get the predicted values\npredictions = model.predict(x_test)\npredictions = scaler.inverse_transform(predictions)\n\n1/3 [=========>....................] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - 0s 31ms/step\n\n\n\ny_test = y_test.reshape(-1,1)\ny_test = scaler.inverse_transform(y_test)\n\n\n# Calculate the mean absolute error (MAE)\nmae = mean_absolute_error(y_test, predictions)\nprint('MAE: ' + str(round(mae, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = np.sqrt(mean_squared_error(y_test,predictions))\nprint('RMSE: ' + str(round(rmse, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = mean_squared_error(y_test, \n                          predictions,\n                          squared = False)\nprint('RMSE: ' + str(round(rmse, 1)))\n\nMAE: 1074.0\nRMSE: 1479.1\nRMSE: 1479.1\n\n\n\n# Add the difference between the valid and predicted prices\ntrain = data_asturias[:(len(x_train)+92)]\nvalid = data_asturias[(len(x_train)+91):]\n\n\nvalid.insert(1, \"Predictions\", predictions, True)\nvalid.insert(1, \"Difference\", valid[\"Predictions\"] - valid[\"num_casos\"], True)\n\n\n# Zoom-in to a closer timeframe\n# Date from which on the date is displayed\ndisplay_start_date = \"2021-10-31\" \nvalid = valid[valid.index > display_start_date]\ntrain = train[train.index > display_start_date]\n\n\n# Visualize the data\nmatplotlib.style.use('ggplot')\nfig, ax1 = plt.subplots(figsize=(22, 10), sharex=True)\n\n# Data - Train\nxt = train.index; \nyt = train[[\"num_casos\"]]\n# Data - Test / validation \nxv = valid.index; \nyv = valid[[\"num_casos\", \"Predictions\"]]\n\n# Plot\nplt.title(\"Asturias: Predictions vs Real infections\", fontsize=20)\nplt.ylabel(\"Nº Cases\", fontsize=18)\n\nplt.plot(yt, color=\"blue\", linewidth=1.5)\nplt.plot(yv[\"Predictions\"], color=\"red\", linewidth=1.5)\nplt.plot(yv[\"num_casos\"], color=\"green\", linewidth=1.5)\nplt.legend([\"Train\", \"LSTM Predictions\", \"Test\"], \n           loc=\"upper left\", fontsize=18)\n\n# Bar plot with the differences\nx = valid.index\ny = valid[\"Difference\"]\nplt.bar(x, y, width=0.2, color=\"grey\")\nplt.grid()\nplt.show()"
  },
  {
    "objectID": "lstm_uni.html#barcelona",
    "href": "lstm_uni.html#barcelona",
    "title": "LSTM univariate prediction",
    "section": "Barcelona",
    "text": "Barcelona\n\ndata_Barcelona = data_covid.loc[data_covid['provincia'] == 'Barcelona']\ndata_Barcelona = data_Barcelona.set_index('fecha')\ndata_Barcelona = data_Barcelona.filter(['num_casos'])\ndata_Barcelona = data_Barcelona['2020-06-14':]\ndata_Barcelona\n\n\n\n\n\n  \n    \n      \n      num_casos\n    \n    \n      fecha\n      \n    \n  \n  \n    \n      2020-06-14\n      33\n    \n    \n      2020-06-15\n      62\n    \n    \n      2020-06-16\n      66\n    \n    \n      2020-06-17\n      70\n    \n    \n      2020-06-18\n      68\n    \n    \n      ...\n      ...\n    \n    \n      2022-03-25\n      598\n    \n    \n      2022-03-26\n      345\n    \n    \n      2022-03-27\n      252\n    \n    \n      2022-03-28\n      688\n    \n    \n      2022-03-29\n      0\n    \n  \n\n654 rows × 1 columns\n\n\n\n\ndata_Barcelona.describe()\n\n\n\n\n\n  \n    \n      \n      num_casos\n    \n  \n  \n    \n      count\n      654.000000\n    \n    \n      mean\n      2605.048930\n    \n    \n      std\n      4823.001644\n    \n    \n      min\n      0.000000\n    \n    \n      25%\n      597.250000\n    \n    \n      50%\n      1030.500000\n    \n    \n      75%\n      2243.750000\n    \n    \n      max\n      34701.000000\n    \n  \n\n\n\n\n\nnp_data_Barcelona = data_Barcelona.values\n\n\nscaler = MinMaxScaler(feature_range=(0, 1))\nscaled_data_Barcelona = scaler.fit_transform(np_data_Barcelona)\nprint(f'Longitud del conjunto de datos disponible: {len(scaled_data_Barcelona)}')\n\nLongitud del conjunto de datos disponible: 654\n\n\n\n# Since we are going to predict future values based on the 90 past elements, \n# we need to create a list with those historic information for each element\nhistoric_values = 90\nscaled_data_Barcelona_x = []\nscaled_data_Barcelona_y = []\n\nfor num_casos_i in range(historic_values, len(scaled_data_Barcelona)):\n    scaled_data_Barcelona_x.append(scaled_data_Barcelona[(num_casos_i-historic_values):num_casos_i, 0])\n    scaled_data_Barcelona_y.append(scaled_data_Barcelona[num_casos_i, 0])\n\n# Convert the x_train and y_train to numpy arrays\nscaled_data_Barcelona_x = np.array(scaled_data_Barcelona_x)\nscaled_data_Barcelona_y = np.array(scaled_data_Barcelona_y)\n\n\n# Train data looks like\nscaled_data_Barcelona_x[235]\n\narray([0.05037319, 0.04726089, 0.02899052, 0.02507132, 0.04639636,\n       0.04190081, 0.03749171, 0.03527276, 0.03786634, 0.02619521,\n       0.02351517, 0.04077692, 0.03760699, 0.03587793, 0.0364831 ,\n       0.03120948, 0.02449497, 0.02083513, 0.03792398, 0.03613729,\n       0.03195873, 0.02754964, 0.02818363, 0.02025878, 0.01752111,\n       0.03484049, 0.03037376, 0.02870234, 0.0233999 , 0.02610876,\n       0.01876027, 0.01645486, 0.0282989 , 0.02625285, 0.02680038,\n       0.02564768, 0.02596467, 0.01953834, 0.01746347, 0.03184346,\n       0.02973978, 0.02573413, 0.02838535, 0.02919224, 0.02190139,\n       0.01890435, 0.03720354, 0.03642546, 0.0325639 , 0.0304314 ,\n       0.03556093, 0.02524423, 0.02149794, 0.03803925, 0.03426414,\n       0.03048903, 0.03365897, 0.02218956, 0.02530186, 0.02533068,\n       0.02832771, 0.03835624, 0.03740526, 0.03512867, 0.03680009,\n       0.02855825, 0.02118095, 0.03878851, 0.03507104, 0.03985476,\n       0.03155529, 0.03394715, 0.02423561, 0.02169966, 0.03953777,\n       0.04596409, 0.0350134 , 0.0395954 , 0.03267917, 0.02772254,\n       0.02380335, 0.04668453, 0.04213135, 0.03806807, 0.03671364,\n       0.03509985, 0.02106568, 0.01694476, 0.03803925, 0.02815481])\n\n\n\n# Test data looks like\nscaled_data_Barcelona_y[235]\n\n0.030661940578081325\n\n\n\n# Since the first 90th values does not have historic, the dataset has been reduced in 90 values\nprint(f'Longitud datos de entrenamiento con historico: {len(scaled_data_Barcelona_y)}')\n\nLongitud datos de entrenamiento con historico: 564\n\n\n\n# we split data in train and test\n# as in previous analysis, we are going to predict a maximum of 90 days\nx_train = scaled_data_Barcelona_x[0:len(scaled_data_Barcelona_x)-91]\ny_train = scaled_data_Barcelona_y[0:len(scaled_data_Barcelona_y)-91]\nprint(f'Cantidad datos de entrenamiento: x={len(x_train)} - y={len(y_train)}')\n\nx_test = scaled_data_Barcelona_x[len(scaled_data_Barcelona_x)-90:len(scaled_data_Barcelona_x)]\ny_test = scaled_data_Barcelona_y[len(scaled_data_Barcelona_y)-90:len(scaled_data_Barcelona_y)]\nprint(f'Cantidad datos de test: x={len(x_test)} - y={len(y_test)}')\n\nCantidad datos de entrenamiento: x=473 - y=473\nCantidad datos de test: x=90 - y=90\n\n\n\n# Reshape the data to feed de recurrent network\nx_train = np.reshape(x_train, (x_train.shape[0], x_train.shape[1], 1))\nprint(\"Train data shape:\")\nprint(x_train.shape)\nprint(y_train.shape)\nx_test = np.reshape(x_test, (x_test.shape[0], x_test.shape[1], 1))\nprint(\"Test data shape:\")\nprint(x_test.shape)\nprint(y_test.shape)\n\nTrain data shape:\n(473, 90, 1)\n(473,)\nTest data shape:\n(90, 90, 1)\n(90,)\n\n\n\n# Configure / setup the neural network model - LSTM\n# Build the model\nprint('Build model...')\nmodel = Sequential()\n# Model with Neurons \n# Inputshape = neurons -> Timestamps\nneurons= x_train.shape[1]\nmodel.add(LSTM(90, \n               activation = 'relu',\n               return_sequences = True, \n               input_shape = (x_train.shape[1], 1))) \nmodel.add(LSTM(50, \n               activation = 'relu',\n               return_sequences = True)) \nmodel.add(LSTM(25, \n               activation = 'relu',\n               return_sequences = False)) \nmodel.add(Dense(5, activation = 'relu'))\nmodel.add(Dense(1))\n\nBuild model...\n\n\n\nmodel.compile(optimizer='adam', loss='mean_squared_error')\nmodel.summary()\n\nModel: \"sequential_1\"\n\n\n_________________________________________________________________\n\n\n Layer (type)                Output Shape              Param #   \n\n\n=================================================================\n\n\n lstm_3 (LSTM)               (None, 90, 90)            33120     \n\n\n                                                                 \n\n\n lstm_4 (LSTM)               (None, 90, 50)            28200     \n\n\n                                                                 \n\n\n lstm_5 (LSTM)               (None, 25)                7600      \n\n\n                                                                 \n\n\n dense_2 (Dense)             (None, 5)                 130       \n\n\n                                                                 \n\n\n dense_3 (Dense)             (None, 1)                 6         \n\n\n                                                                 \n\n\n=================================================================\n\n\nTotal params: 69,056\n\n\nTrainable params: 69,056\n\n\nNon-trainable params: 0\n\n\n_________________________________________________________________\n\n\n\n# Training the model\n# fit network\nhistory = model.fit(x_train, \n                    y_train, \n                    batch_size = 1000, \n                    epochs = 30, \n                    validation_data = (x_test, y_test), \n                    verbose = 0)\n\n\nplt.plot(history.history['loss'], label='train')\nplt.plot(history.history['val_loss'], label='test')\nplt.legend()\nplt.show() \n\n\n\n\n\n# Get the predicted values\npredictions = model.predict(x_test)\npredictions = scaler.inverse_transform(predictions)\n\n1/3 [=========>....................] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - 0s 31ms/step\n\n\n\ny_test = y_test.reshape(-1,1)\ny_test = scaler.inverse_transform(y_test)\n\n\n# Calculate the mean absolute error (MAE)\nmae = mean_absolute_error(y_test, predictions)\nprint('MAE: ' + str(round(mae, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = np.sqrt(mean_squared_error(y_test,predictions))\nprint('RMSE: ' + str(round(rmse, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = mean_squared_error(y_test, \n                          predictions,\n                          squared = False)\nprint('RMSE: ' + str(round(rmse, 1)))\n\nMAE: 5228.7\nRMSE: 7609.8\nRMSE: 7609.8\n\n\n\n# Add the difference between the valid and predicted prices\ntrain = data_Barcelona[:(len(x_train)+92)]\nvalid = data_Barcelona[(len(x_train)+91):]\n\n\nvalid.insert(1, \"Predictions\", predictions, True)\nvalid.insert(1, \"Difference\", valid[\"Predictions\"] - valid[\"num_casos\"], True)\n\n\n# Zoom-in to a closer timeframe\n# Date from which on the date is displayed\ndisplay_start_date = \"2021-10-31\" \nvalid = valid[valid.index > display_start_date]\ntrain = train[train.index > display_start_date]\n\n\n# Visualize the data\nmatplotlib.style.use('ggplot')\nfig, ax1 = plt.subplots(figsize=(22, 10), sharex=True)\n\n# Data - Train\nxt = train.index; \nyt = train[[\"num_casos\"]]\n# Data - Test / validation \nxv = valid.index; \nyv = valid[[\"num_casos\", \"Predictions\"]]\n\n# Plot\nplt.title(\"Barcelona: Predictions vs Real infections\", fontsize=20)\nplt.ylabel(\"Nº Cases\", fontsize=18)\n\nplt.plot(yt, color=\"blue\", linewidth=1.5)\nplt.plot(yv[\"Predictions\"], color=\"red\", linewidth=1.5)\nplt.plot(yv[\"num_casos\"], color=\"green\", linewidth=1.5)\nplt.legend([\"Train\", \"LSTM Predictions\", \"Test\"], \n           loc=\"upper left\", fontsize=18)\n\n# Bar plot with the differences\nx = valid.index\ny = valid[\"Difference\"]\nplt.bar(x, y, width=0.2, color=\"grey\")\nplt.grid()\nplt.show()"
  },
  {
    "objectID": "lstm_uni.html#madrid",
    "href": "lstm_uni.html#madrid",
    "title": "LSTM univariate prediction",
    "section": "Madrid",
    "text": "Madrid\n\ndata_Madrid = data_covid.loc[data_covid['provincia'] == 'Madrid']\ndata_Madrid = data_Madrid.set_index('fecha')\ndata_Madrid = data_Madrid.filter(['num_casos'])\ndata_Madrid = data_Madrid['2020-06-14':]\ndata_Madrid\n\n\n\n\n\n  \n    \n      \n      num_casos\n    \n    \n      fecha\n      \n    \n  \n  \n    \n      2020-06-14\n      81\n    \n    \n      2020-06-15\n      153\n    \n    \n      2020-06-16\n      91\n    \n    \n      2020-06-17\n      93\n    \n    \n      2020-06-18\n      85\n    \n    \n      ...\n      ...\n    \n    \n      2022-03-25\n      356\n    \n    \n      2022-03-26\n      303\n    \n    \n      2022-03-27\n      77\n    \n    \n      2022-03-28\n      839\n    \n    \n      2022-03-29\n      6\n    \n  \n\n654 rows × 1 columns\n\n\n\n\ndata_Madrid.describe()\n\n\n\n\n\n  \n    \n      \n      num_casos\n    \n  \n  \n    \n      count\n      654.000000\n    \n    \n      mean\n      2392.562691\n    \n    \n      std\n      3390.272836\n    \n    \n      min\n      6.000000\n    \n    \n      25%\n      662.750000\n    \n    \n      50%\n      1413.000000\n    \n    \n      75%\n      2475.750000\n    \n    \n      max\n      23811.000000\n    \n  \n\n\n\n\n\nnp_data_Madrid = data_Madrid.values\n\n\nscaler = MinMaxScaler(feature_range=(0, 1))\nscaled_data_Madrid = scaler.fit_transform(np_data_Madrid)\nprint(f'Longitud del conjunto de datos disponible: {len(scaled_data_Madrid)}')\n\nLongitud del conjunto de datos disponible: 654\n\n\n\n# Since we are going to predict future values based on the X past elements, \n# we need to create a list with those historic information for each element\nhistoric_values = 90\nscaled_data_Madrid_x = []\nscaled_data_Madrid_y = []\n\nfor num_casos_i in range(historic_values, len(scaled_data_Madrid)):\n    scaled_data_Madrid_x.append(scaled_data_Madrid[(num_casos_i-historic_values):num_casos_i, 0])\n    scaled_data_Madrid_y.append(scaled_data_Madrid[num_casos_i, 0])\n\n# Convert the x_train and y_train to numpy arrays\nscaled_data_Madrid_x = np.array(scaled_data_Madrid_x)\nscaled_data_Madrid_y = np.array(scaled_data_Madrid_y)\n\n\n# Train data looks like\nscaled_data_Madrid_x[235]\n\narray([0.11510187, 0.14820416, 0.08880487, 0.06481832, 0.11169922,\n       0.11354757, 0.089477  , 0.0694812 , 0.09300567, 0.06133165,\n       0.04709095, 0.08447805, 0.07746272, 0.06595253, 0.05708885,\n       0.06515438, 0.04835119, 0.04377232, 0.06372611, 0.05931527,\n       0.05141777, 0.04541063, 0.05330813, 0.04150389, 0.04032766,\n       0.05486242, 0.05225793, 0.04822516, 0.04259609, 0.05246797,\n       0.03919345, 0.03860534, 0.05561857, 0.05452636, 0.04814115,\n       0.04448645, 0.05288805, 0.04125184, 0.03994959, 0.05448435,\n       0.05183785, 0.0531401 , 0.05713085, 0.0431842 , 0.05061962,\n       0.0478891 , 0.07292586, 0.07830288, 0.0626339 , 0.05902121,\n       0.07485822, 0.05326612, 0.05335014, 0.07111951, 0.07095148,\n       0.07784079, 0.05469439, 0.06166772, 0.07149758, 0.07456417,\n       0.09880277, 0.09850872, 0.0857803 , 0.08178954, 0.08951901,\n       0.07225373, 0.05977736, 0.09750053, 0.09762655, 0.08930897,\n       0.08544423, 0.09489603, 0.07187566, 0.06406217, 0.09329973,\n       0.09855072, 0.08435203, 0.07653854, 0.08905692, 0.0647343 ,\n       0.05486242, 0.08237765, 0.0873766 , 0.07326192, 0.06259189,\n       0.07485822, 0.04654484, 0.04494854, 0.04721697, 0.06700273])\n\n\n\n# Test data looks like\nscaled_data_Madrid_y[235]\n\n0.0648183154799412\n\n\n\n# Since the first 90th values does not have historic, the dataset has been reduced in 90 values\nprint(f'Longitud datos de entrenamiento con historico: {len(scaled_data_Madrid_y)}')\n\nLongitud datos de entrenamiento con historico: 564\n\n\n\n# we split data in train and test\n# as in previous analysis, we are going to predict a maximum of 91 days\nx_train = scaled_data_Madrid_x[0:len(scaled_data_Madrid_x)-91]\ny_train = scaled_data_Madrid_y[0:len(scaled_data_Madrid_y)-91]\nprint(f'Cantidad datos de entrenamiento: x={len(x_train)} - y={len(y_train)}')\n\nx_test = scaled_data_Madrid_x[len(scaled_data_Madrid_x)-90:len(scaled_data_Madrid_x)]\ny_test = scaled_data_Madrid_y[len(scaled_data_Madrid_y)-90:len(scaled_data_Madrid_y)]\nprint(f'Cantidad datos de test: x={len(x_test)} - y={len(y_test)}')\n\nCantidad datos de entrenamiento: x=473 - y=473\nCantidad datos de test: x=90 - y=90\n\n\n\n# Reshape the data to feed de recurrent network\nx_train = np.reshape(x_train, (x_train.shape[0], x_train.shape[1], 1))\nprint(\"Train data shape:\")\nprint(x_train.shape)\nprint(y_train.shape)\nx_test = np.reshape(x_test, (x_test.shape[0], x_test.shape[1], 1))\nprint(\"Test data shape:\")\nprint(x_test.shape)\nprint(y_test.shape)\n\nTrain data shape:\n(473, 90, 1)\n(473,)\nTest data shape:\n(90, 90, 1)\n(90,)\n\n\n\n# Configure / setup the neural network model - LSTM\n# Build the model\nprint('Build model...')\nmodel = Sequential()\n# Model with Neurons \n# Inputshape = neurons -> Timestamps\nneurons= x_train.shape[1]\nmodel.add(LSTM(90, \n               activation = 'relu',\n               return_sequences = True, \n               input_shape = (x_train.shape[1], 1))) \nmodel.add(LSTM(50, \n               activation = 'relu',\n               return_sequences = True)) \nmodel.add(LSTM(25, \n               activation = 'relu',\n               return_sequences = False)) \nmodel.add(Dense(5, activation = 'relu'))\nmodel.add(Dense(1))\n\nBuild model...\n\n\n\nmodel.compile(optimizer='adam', loss='mean_squared_error')\nmodel.summary()\n\nModel: \"sequential_2\"\n\n\n_________________________________________________________________\n\n\n Layer (type)                Output Shape              Param #   \n\n\n=================================================================\n\n\n lstm_6 (LSTM)               (None, 90, 90)            33120     \n\n\n                                                                 \n\n\n lstm_7 (LSTM)               (None, 90, 50)            28200     \n\n\n                                                                 \n\n\n lstm_8 (LSTM)               (None, 25)                7600      \n\n\n                                                                 \n\n\n dense_4 (Dense)             (None, 5)                 130       \n\n\n                                                                 \n\n\n dense_5 (Dense)             (None, 1)                 6         \n\n\n                                                                 \n\n\n=================================================================\n\n\nTotal params: 69,056\n\n\nTrainable params: 69,056\n\n\nNon-trainable params: 0\n\n\n_________________________________________________________________\n\n\n\n# Training the model\n# fit network\nhistory = model.fit(x_train, \n                    y_train, \n                    batch_size = 1000, \n                    epochs = 30, \n                    validation_data = (x_test, y_test), \n                    verbose = 0)\n\n\nplt.plot(history.history['loss'], label='train')\nplt.plot(history.history['val_loss'], label='test')\nplt.legend()\nplt.show() \n\n\n\n\n\n# Get the predicted values\npredictions = model.predict(x_test)\npredictions = scaler.inverse_transform(predictions)\n\n1/3 [=========>....................] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - 0s 30ms/step\n\n\n\ny_test = y_test.reshape(-1,1)\ny_test = scaler.inverse_transform(y_test)\n\n\n# Calculate the mean absolute error (MAE)\nmae = mean_absolute_error(y_test, predictions)\nprint('MAE: ' + str(round(mae, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = np.sqrt(mean_squared_error(y_test,predictions))\nprint('RMSE: ' + str(round(rmse, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = mean_squared_error(y_test, \n                          predictions,\n                          squared = False)\nprint('RMSE: ' + str(round(rmse, 1)))\n\nMAE: 4748.2\nRMSE: 6975.8\nRMSE: 6975.8\n\n\n\n# Add the difference between the valid and predicted prices\ntrain = data_Madrid[:(len(x_train)+92)]\nvalid = data_Madrid[(len(x_train)+91):]\n\n\nvalid.insert(1, \"Predictions\", predictions, True)\nvalid.insert(1, \"Difference\", valid[\"Predictions\"] - valid[\"num_casos\"], True)\n\n\n# Zoom-in to a closer timeframe\n# Date from which on the date is displayed\ndisplay_start_date = \"2021-10-31\" \nvalid = valid[valid.index > display_start_date]\ntrain = train[train.index > display_start_date]\n\n\n# Visualize the data\nmatplotlib.style.use('ggplot')\nfig, ax1 = plt.subplots(figsize=(22, 10), sharex=True)\n\n# Data - Train\nxt = train.index; \nyt = train[[\"num_casos\"]]\n# Data - Test / validation \nxv = valid.index; \nyv = valid[[\"num_casos\", \"Predictions\"]]\n\n# Plot\nplt.title(\"Madrid: Predictions vs Real infections\", fontsize=20)\nplt.ylabel(\"Nº Cases\", fontsize=18)\n\nplt.plot(yt, color=\"blue\", linewidth=1.5)\nplt.plot(yv[\"Predictions\"], color=\"red\", linewidth=1.5)\nplt.plot(yv[\"num_casos\"], color=\"green\", linewidth=1.5)\nplt.legend([\"Train\", \"LSTM Predictions\", \"Test\"], \n           loc=\"upper left\", fontsize=18)\n\n# Bar plot with the differences\nx = valid.index\ny = valid[\"Difference\"]\nplt.bar(x, y, width=0.2, color=\"grey\")\nplt.grid()\nplt.show()"
  },
  {
    "objectID": "lstm_uni.html#malaga",
    "href": "lstm_uni.html#malaga",
    "title": "LSTM univariate prediction",
    "section": "Malaga",
    "text": "Malaga\n\ndata_Malaga = data_covid.loc[data_covid['provincia'] == 'Málaga']\ndata_Malaga = data_Malaga.set_index('fecha')\ndata_Malaga = data_Malaga.filter(['num_casos'])\ndata_Malaga = data_Malaga['2020-06-14':]\ndata_Malaga\n\n\n\n\n\n  \n    \n      \n      num_casos\n    \n    \n      fecha\n      \n    \n  \n  \n    \n      2020-06-14\n      2\n    \n    \n      2020-06-15\n      1\n    \n    \n      2020-06-16\n      1\n    \n    \n      2020-06-17\n      2\n    \n    \n      2020-06-18\n      2\n    \n    \n      ...\n      ...\n    \n    \n      2022-03-25\n      565\n    \n    \n      2022-03-26\n      79\n    \n    \n      2022-03-27\n      65\n    \n    \n      2022-03-28\n      39\n    \n    \n      2022-03-29\n      0\n    \n  \n\n654 rows × 1 columns\n\n\n\n\ndata_Malaga.describe()\n\n\n\n\n\n  \n    \n      \n      num_casos\n    \n  \n  \n    \n      count\n      654.000000\n    \n    \n      mean\n      410.206422\n    \n    \n      std\n      489.452348\n    \n    \n      min\n      0.000000\n    \n    \n      25%\n      122.250000\n    \n    \n      50%\n      215.500000\n    \n    \n      75%\n      475.250000\n    \n    \n      max\n      3080.000000\n    \n  \n\n\n\n\n\nnp_data_Malaga = data_Malaga.values\n\n\nscaler = MinMaxScaler(feature_range=(0, 1))\nscaled_data_Malaga = scaler.fit_transform(np_data_Malaga)\nprint(f'Longitud del conjunto de datos disponible: {len(scaled_data_Malaga)}')\n\nLongitud del conjunto de datos disponible: 654\n\n\n\n# Since we are going to predict future values based on the X past elements, \n# we need to create a list with those historic information for each element\nhistoric_values = 90\nscaled_data_Malaga_x = []\nscaled_data_Malaga_y = []\n\nfor num_casos_i in range(historic_values, len(scaled_data_Malaga)):\n    scaled_data_Malaga_x.append(scaled_data_Malaga[(num_casos_i-historic_values):num_casos_i, 0])\n    scaled_data_Malaga_y.append(scaled_data_Malaga[num_casos_i, 0])\n\n# Convert the x_train and y_train to numpy arrays\nscaled_data_Malaga_x = np.array(scaled_data_Malaga_x)\nscaled_data_Malaga_y = np.array(scaled_data_Malaga_y)\n\n\n# Train data looks like\nscaled_data_Malaga_x[235]\n\narray([0.24448052, 0.21915584, 0.15649351, 0.12045455, 0.15357143,\n       0.14448052, 0.1474026 , 0.14675325, 0.11655844, 0.09448052,\n       0.06753247, 0.09545455, 0.11071429, 0.06883117, 0.06980519,\n       0.06688312, 0.04902597, 0.03474026, 0.05974026, 0.04935065,\n       0.04967532, 0.04480519, 0.04188312, 0.03993506, 0.02954545,\n       0.04188312, 0.04772727, 0.05162338, 0.04902597, 0.04318182,\n       0.02792208, 0.0288961 , 0.04253247, 0.04123377, 0.04025974,\n       0.03538961, 0.05097403, 0.03051948, 0.02662338, 0.04123377,\n       0.03149351, 0.04350649, 0.03733766, 0.03571429, 0.02954545,\n       0.0211039 , 0.04188312, 0.04545455, 0.03863636, 0.04772727,\n       0.04935065, 0.03571429, 0.0288961 , 0.05357143, 0.05324675,\n       0.05616883, 0.04253247, 0.04058442, 0.03474026, 0.04935065,\n       0.06623377, 0.07824675, 0.06623377, 0.05909091, 0.06233766,\n       0.05064935, 0.03116883, 0.07077922, 0.05649351, 0.07792208,\n       0.06168831, 0.0711039 , 0.04155844, 0.04577922, 0.06623377,\n       0.06720779, 0.05909091, 0.05519481, 0.05324675, 0.04383117,\n       0.03668831, 0.05941558, 0.06525974, 0.06006494, 0.05551948,\n       0.05876623, 0.04512987, 0.04545455, 0.06266234, 0.07727273])\n\n\n\n# Test data looks like\nscaled_data_Malaga_y[235]\n\n0.0737012987012987\n\n\n\n# Since the first 90th values does not have historic, the dataset has been reduced in 90 values\nprint(f'Longitud datos de entrenamiento con historico: {len(scaled_data_Malaga_y)}')\n\nLongitud datos de entrenamiento con historico: 564\n\n\n\n# we split data in train and test\n# as in previous analysis, we are going to predict a maximum of 91 days\nx_train = scaled_data_Malaga_x[0:len(scaled_data_Malaga_x)-91]\ny_train = scaled_data_Malaga_y[0:len(scaled_data_Malaga_y)-91]\nprint(f'Cantidad datos de entrenamiento: x={len(x_train)} - y={len(y_train)}')\n\nx_test = scaled_data_Malaga_x[len(scaled_data_Malaga_x)-90:len(scaled_data_Malaga_x)]\ny_test = scaled_data_Malaga_y[len(scaled_data_Malaga_y)-90:len(scaled_data_Malaga_y)]\nprint(f'Cantidad datos de test: x={len(x_test)} - y={len(y_test)}')\n\nCantidad datos de entrenamiento: x=473 - y=473\nCantidad datos de test: x=90 - y=90\n\n\n\n# Reshape the data to feed de recurrent network\nx_train = np.reshape(x_train, (x_train.shape[0], x_train.shape[1], 1))\nprint(\"Train data shape:\")\nprint(x_train.shape)\nprint(y_train.shape)\nx_test = np.reshape(x_test, (x_test.shape[0], x_test.shape[1], 1))\nprint(\"Test data shape:\")\nprint(x_test.shape)\nprint(y_test.shape)\n\nTrain data shape:\n(473, 90, 1)\n(473,)\nTest data shape:\n(90, 90, 1)\n(90,)\n\n\n\n# Configure / setup the neural network model - LSTM\n# Build the model\nprint('Build model...')\nmodel = Sequential()\n# Model with Neurons \n# Inputshape = neurons -> Timestamps\nneurons= x_train.shape[1]\nmodel.add(LSTM(90, \n               activation = 'relu',\n               return_sequences = True, \n               input_shape = (x_train.shape[1], 1))) \nmodel.add(LSTM(50, \n               activation = 'relu',\n               return_sequences = True)) \nmodel.add(LSTM(25, \n               activation = 'relu',\n               return_sequences = False)) \nmodel.add(Dense(5, activation = 'relu'))\nmodel.add(Dense(1))\n\nBuild model...\n\n\n\nmodel.compile(optimizer='adam', loss='mean_squared_error')\nmodel.summary()\n\nModel: \"sequential_3\"\n\n\n_________________________________________________________________\n\n\n Layer (type)                Output Shape              Param #   \n\n\n=================================================================\n\n\n lstm_9 (LSTM)               (None, 90, 90)            33120     \n\n\n                                                                 \n\n\n lstm_10 (LSTM)              (None, 90, 50)            28200     \n\n\n                                                                 \n\n\n lstm_11 (LSTM)              (None, 25)                7600      \n\n\n                                                                 \n\n\n dense_6 (Dense)             (None, 5)                 130       \n\n\n                                                                 \n\n\n dense_7 (Dense)             (None, 1)                 6         \n\n\n                                                                 \n\n\n=================================================================\n\n\nTotal params: 69,056\n\n\nTrainable params: 69,056\n\n\nNon-trainable params: 0\n\n\n_________________________________________________________________\n\n\n\n# Training the model\n# fit network\nhistory = model.fit(x_train, \n                    y_train, \n                    batch_size = 1000, \n                    epochs = 30, \n                    validation_data = (x_test, y_test), \n                    verbose = 0)\n\n\nplt.plot(history.history['loss'], label='train')\nplt.plot(history.history['val_loss'], label='test')\nplt.legend()\nplt.show() \n\n\n\n\n\n# Get the predicted values\npredictions = model.predict(x_test)\npredictions = scaler.inverse_transform(predictions)\n\n1/3 [=========>....................] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - 0s 31ms/step\n\n\n\ny_test = y_test.reshape(-1,1)\ny_test = scaler.inverse_transform(y_test)\n\n\n# Calculate the mean absolute error (MAE)\nmae = mean_absolute_error(y_test, predictions)\nprint('MAE: ' + str(round(mae, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = np.sqrt(mean_squared_error(y_test,predictions))\nprint('RMSE: ' + str(round(rmse, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = mean_squared_error(y_test, \n                          predictions,\n                          squared = False)\nprint('RMSE: ' + str(round(rmse, 1)))\n\nMAE: 353.5\nRMSE: 481.1\nRMSE: 481.1\n\n\n\n# Add the difference between the valid and predicted prices\ntrain = data_Malaga[:(len(x_train)+92)]\nvalid = data_Malaga[(len(x_train)+91):]\n\n\nvalid.insert(1, \"Predictions\", predictions, True)\nvalid.insert(1, \"Difference\", valid[\"Predictions\"] - valid[\"num_casos\"], True)\n\n\n# Zoom-in to a closer timeframe\n# Date from which on the date is displayed\ndisplay_start_date = \"2021-10-31\" \nvalid = valid[valid.index > display_start_date]\ntrain = train[train.index > display_start_date]\n\n\n# Visualize the data\nmatplotlib.style.use('ggplot')\nfig, ax1 = plt.subplots(figsize=(22, 10), sharex=True)\n\n# Data - Train\nxt = train.index; \nyt = train[[\"num_casos\"]]\n# Data - Test / validation \nxv = valid.index; \nyv = valid[[\"num_casos\", \"Predictions\"]]\n\n# Plot\nplt.title(\"Malaga: Predictions vs Real infections\", fontsize=20)\nplt.ylabel(\"Nº Cases\", fontsize=18)\n\nplt.plot(yt, color=\"blue\", linewidth=1.5)\nplt.plot(yv[\"Predictions\"], color=\"red\", linewidth=1.5)\nplt.plot(yv[\"num_casos\"], color=\"green\", linewidth=1.5)\nplt.legend([\"Train\", \"LSTM Predictions\", \"Test\"], \n           loc=\"upper left\", fontsize=18)\n\n# Bar plot with the differences\nx = valid.index\ny = valid[\"Difference\"]\nplt.bar(x, y, width=0.2, color=\"grey\")\nplt.grid()\nplt.show()"
  },
  {
    "objectID": "lstm_uni.html#sevilla",
    "href": "lstm_uni.html#sevilla",
    "title": "LSTM univariate prediction",
    "section": "Sevilla",
    "text": "Sevilla\n\ndata_Sevilla = data_covid.loc[data_covid['provincia'] == 'Sevilla']\ndata_Sevilla = data_Sevilla.set_index('fecha')\ndata_Sevilla = data_Sevilla.filter(['num_casos'])\ndata_Sevilla = data_Sevilla['2020-06-14':]\ndata_Sevilla\n\n\n\n\n\n  \n    \n      \n      num_casos\n    \n    \n      fecha\n      \n    \n  \n  \n    \n      2020-06-14\n      0\n    \n    \n      2020-06-15\n      2\n    \n    \n      2020-06-16\n      1\n    \n    \n      2020-06-17\n      0\n    \n    \n      2020-06-18\n      0\n    \n    \n      ...\n      ...\n    \n    \n      2022-03-25\n      365\n    \n    \n      2022-03-26\n      67\n    \n    \n      2022-03-27\n      24\n    \n    \n      2022-03-28\n      12\n    \n    \n      2022-03-29\n      0\n    \n  \n\n654 rows × 1 columns\n\n\n\n\ndata_Sevilla.describe()\n\n\n\n\n\n  \n    \n      \n      num_casos\n    \n  \n  \n    \n      count\n      654.000000\n    \n    \n      mean\n      432.978593\n    \n    \n      std\n      500.618517\n    \n    \n      min\n      0.000000\n    \n    \n      25%\n      127.250000\n    \n    \n      50%\n      282.000000\n    \n    \n      75%\n      528.250000\n    \n    \n      max\n      3692.000000\n    \n  \n\n\n\n\n\nnp_data_Sevilla = data_Sevilla.values\n\n\nscaler = MinMaxScaler(feature_range=(0, 1))\nscaled_data_Sevilla = scaler.fit_transform(np_data_Sevilla)\nprint(f'Longitud del conjunto de datos disponible: {len(scaled_data_Sevilla)}')\n\nLongitud del conjunto de datos disponible: 654\n\n\n\n# Since we are going to predict future values based on the X past elements, \n# we need to create a list with those historic information for each element\nhistoric_values = 90\nscaled_data_Sevilla_x = []\nscaled_data_Sevilla_y = []\n\nfor num_casos_i in range(historic_values, len(scaled_data_Sevilla)):\n    scaled_data_Sevilla_x.append(scaled_data_Sevilla[(num_casos_i-historic_values):num_casos_i, 0])\n    scaled_data_Sevilla_y.append(scaled_data_Sevilla[num_casos_i, 0])\n\n# Convert the x_train and y_train to numpy arrays\nscaled_data_Sevilla_x = np.array(scaled_data_Sevilla_x)\nscaled_data_Sevilla_y = np.array(scaled_data_Sevilla_y)\n\n\n# Train data looks like\nscaled_data_Sevilla_x[235]\n\narray([0.18634886, 0.19799567, 0.14626219, 0.0896533 , 0.13894908,\n       0.1695558 , 0.14572048, 0.12242687, 0.13434453, 0.06500542,\n       0.05390033, 0.08206934, 0.08667389, 0.09452871, 0.06798483,\n       0.05904659, 0.04252438, 0.0343987 , 0.06554713, 0.06473456,\n       0.05444204, 0.0503792 , 0.05796316, 0.04577465, 0.03819068,\n       0.04712893, 0.0528169 , 0.0663597 , 0.06013001, 0.05119177,\n       0.03764897, 0.031961  , 0.05119177, 0.05010834, 0.04739978,\n       0.05119177, 0.05390033, 0.03927411, 0.03737811, 0.06013001,\n       0.05633803, 0.05606717, 0.05850488, 0.06473456, 0.04658722,\n       0.04198267, 0.07150596, 0.07340195, 0.05823402, 0.08071506,\n       0.07773564, 0.05877573, 0.05471289, 0.07990249, 0.08829902,\n       0.0872156 , 0.09019502, 0.07069339, 0.08775731, 0.08396533,\n       0.14951246, 0.12432286, 0.12269772, 0.12378115, 0.13028169,\n       0.11348862, 0.07936078, 0.13299025, 0.12269772, 0.11213434,\n       0.12107259, 0.12432286, 0.09723727, 0.07042254, 0.09886241,\n       0.11782232, 0.10157096, 0.10346696, 0.12621885, 0.08342362,\n       0.07340195, 0.0847779 , 0.08559047, 0.11159263, 0.10292524,\n       0.08911159, 0.07502709, 0.04821235, 0.08315276, 0.09913326])\n\n\n\n# Test data looks like\nscaled_data_Sevilla_y[235]\n\n0.10861321776814734\n\n\n\n# Since the first 90th values does not have historic, the dataset has been reduced in 90 values\nprint(f'Longitud datos de entrenamiento con historico: {len(scaled_data_Sevilla_y)}')\n\nLongitud datos de entrenamiento con historico: 564\n\n\n\n# we split data in train and test\n# as in previous analysis, we are going to predict a maximum of 91 days\nx_train = scaled_data_Sevilla_x[0:len(scaled_data_Sevilla_x)-91]\ny_train = scaled_data_Sevilla_y[0:len(scaled_data_Sevilla_y)-91]\nprint(f'Cantidad datos de entrenamiento: x={len(x_train)} - y={len(y_train)}')\n\nx_test = scaled_data_Sevilla_x[len(scaled_data_Sevilla_x)-90:len(scaled_data_Sevilla_x)]\ny_test = scaled_data_Sevilla_y[len(scaled_data_Sevilla_y)-90:len(scaled_data_Sevilla_y)]\nprint(f'Cantidad datos de test: x={len(x_test)} - y={len(y_test)}')\n\nCantidad datos de entrenamiento: x=473 - y=473\nCantidad datos de test: x=90 - y=90\n\n\n\n# Reshape the data to feed de recurrent network\nx_train = np.reshape(x_train, (x_train.shape[0], x_train.shape[1], 1))\nprint(\"Train data shape:\")\nprint(x_train.shape)\nprint(y_train.shape)\nx_test = np.reshape(x_test, (x_test.shape[0], x_test.shape[1], 1))\nprint(\"Test data shape:\")\nprint(x_test.shape)\nprint(y_test.shape)\n\nTrain data shape:\n(473, 90, 1)\n(473,)\nTest data shape:\n(90, 90, 1)\n(90,)\n\n\n\n# Configure / setup the neural network model - LSTM\n# Build the model\nprint('Build model...')\nmodel = Sequential()\n# Model with Neurons \n# Inputshape = neurons -> Timestamps\nneurons= x_train.shape[1]\nmodel.add(LSTM(90, \n               activation = 'relu',\n               return_sequences = True, \n               input_shape = (x_train.shape[1], 1))) \nmodel.add(LSTM(50, \n               activation = 'relu',\n               return_sequences = True)) \nmodel.add(LSTM(25, \n               activation = 'relu',\n               return_sequences = False)) \nmodel.add(Dense(5, activation = 'relu'))\nmodel.add(Dense(1))\n\nBuild model...\n\n\n\nmodel.compile(optimizer='adam', loss='mean_squared_error')\nmodel.summary()\n\nModel: \"sequential_4\"\n\n\n_________________________________________________________________\n\n\n Layer (type)                Output Shape              Param #   \n\n\n=================================================================\n\n\n lstm_12 (LSTM)              (None, 90, 90)            33120     \n\n\n                                                                 \n\n\n lstm_13 (LSTM)              (None, 90, 50)            28200     \n\n\n                                                                 \n\n\n lstm_14 (LSTM)              (None, 25)                7600      \n\n\n                                                                 \n\n\n dense_8 (Dense)             (None, 5)                 130       \n\n\n                                                                 \n\n\n dense_9 (Dense)             (None, 1)                 6         \n\n\n                                                                 \n\n\n=================================================================\n\n\nTotal params: 69,056\n\n\nTrainable params: 69,056\n\n\nNon-trainable params: 0\n\n\n_________________________________________________________________\n\n\n\n# Training the model\n# fit network\nhistory = model.fit(x_train, \n                    y_train, \n                    batch_size = 1000, \n                    epochs = 30, \n                    validation_data = (x_test, y_test), \n                    verbose = 0)\n\n\nplt.plot(history.history['loss'], label='train')\nplt.plot(history.history['val_loss'], label='test')\nplt.legend()\nplt.show() \n\n\n\n\n\n# Get the predicted values\npredictions = model.predict(x_test)\npredictions = scaler.inverse_transform(predictions)\n\nWARNING:tensorflow:5 out of the last 13 calls to <function Model.make_predict_function.<locals>.predict_function at 0x7fdc69aa8c10> triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.\n\n\n1/3 [=========>....................] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - 0s 32ms/step\n\n\n\ny_test = y_test.reshape(-1,1)\ny_test = scaler.inverse_transform(y_test)\n\n\n# Calculate the mean absolute error (MAE)\nmae = mean_absolute_error(y_test, predictions)\nprint('MAE: ' + str(round(mae, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = np.sqrt(mean_squared_error(y_test,predictions))\nprint('RMSE: ' + str(round(rmse, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = mean_squared_error(y_test, \n                          predictions,\n                          squared = False)\nprint('RMSE: ' + str(round(rmse, 1)))\n\nMAE: 335.1\nRMSE: 474.0\nRMSE: 474.0\n\n\n\n# Add the difference between the valid and predicted prices\ntrain = data_Sevilla[:(len(x_train)+92)]\nvalid = data_Sevilla[(len(x_train)+91):]\n\n\nvalid.insert(1, \"Predictions\", predictions, True)\nvalid.insert(1, \"Difference\", valid[\"Predictions\"] - valid[\"num_casos\"], True)\n\n\n# Zoom-in to a closer timeframe\n# Date from which on the date is displayed\ndisplay_start_date = \"2021-10-31\" \nvalid = valid[valid.index > display_start_date]\ntrain = train[train.index > display_start_date]\n\n\n# Visualize the data\nmatplotlib.style.use('ggplot')\nfig, ax1 = plt.subplots(figsize=(22, 10), sharex=True)\n\n# Data - Train\nxt = train.index; \nyt = train[[\"num_casos\"]]\n# Data - Test / validation \nxv = valid.index; \nyv = valid[[\"num_casos\", \"Predictions\"]]\n\n# Plot\nplt.title(\"Sevilla: Predictions vs Real infections\", fontsize=20)\nplt.ylabel(\"Nº Cases\", fontsize=18)\n\nplt.plot(yt, color=\"blue\", linewidth=1.5)\nplt.plot(yv[\"Predictions\"], color=\"red\", linewidth=1.5)\nplt.plot(yv[\"num_casos\"], color=\"green\", linewidth=1.5)\nplt.legend([\"Train\", \"LSTM Predictions\", \"Test\"], \n           loc=\"upper left\", fontsize=18)\n\n# Bar plot with the differences\nx = valid.index\ny = valid[\"Difference\"]\nplt.bar(x, y, width=0.2, color=\"grey\")\nplt.grid()\nplt.show()"
  },
  {
    "objectID": "lstm_uni.html#asturias-1",
    "href": "lstm_uni.html#asturias-1",
    "title": "LSTM univariate prediction",
    "section": "Asturias",
    "text": "Asturias\n\ndata_asturias = data_covid.loc[data_covid['provincia'] == 'Asturias']\ndata_asturias = data_asturias.set_index('fecha')\ndata_asturias = data_asturias.filter(['num_casos'])\ndata_asturias = data_asturias['2020-06-14':'2021-12-31']\ndata_asturias\n\n\n\n\n\n  \n    \n      \n      num_casos\n    \n    \n      fecha\n      \n    \n  \n  \n    \n      2020-06-14\n      0\n    \n    \n      2020-06-15\n      0\n    \n    \n      2020-06-16\n      1\n    \n    \n      2020-06-17\n      0\n    \n    \n      2020-06-18\n      0\n    \n    \n      ...\n      ...\n    \n    \n      2021-12-27\n      2363\n    \n    \n      2021-12-28\n      2150\n    \n    \n      2021-12-29\n      2159\n    \n    \n      2021-12-30\n      2020\n    \n    \n      2021-12-31\n      1949\n    \n  \n\n566 rows × 1 columns\n\n\n\n\ndata_asturias.describe()\n\n\n\n\n\n  \n    \n      \n      num_casos\n    \n  \n  \n    \n      count\n      566.000000\n    \n    \n      mean\n      180.913428\n    \n    \n      std\n      276.250633\n    \n    \n      min\n      0.000000\n    \n    \n      25%\n      36.000000\n    \n    \n      50%\n      94.500000\n    \n    \n      75%\n      225.750000\n    \n    \n      max\n      2363.000000\n    \n  \n\n\n\n\n\nnp_data_asturias = data_asturias.values\n\n\nscaler = MinMaxScaler(feature_range=(0, 1))\nscaled_data_asturias = scaler.fit_transform(np_data_asturias)\nprint(f'Longitud del conjunto de datos disponible: {len(scaled_data_asturias)}')\n\nLongitud del conjunto de datos disponible: 566\n\n\n\n# Since we are going to predict future values based on the X past elements, \n# we need to create a list with those historic information for each element\nhistoric_values = 90\nscaled_data_asturias_x = []\nscaled_data_asturias_y = []\n\nfor num_casos_i in range(historic_values, len(scaled_data_asturias)):\n    scaled_data_asturias_x.append(scaled_data_asturias[(num_casos_i-historic_values):num_casos_i, 0])\n    scaled_data_asturias_y.append(scaled_data_asturias[num_casos_i, 0])\n\n# Convert the x_train and y_train to numpy arrays\nscaled_data_asturias_x = np.array(scaled_data_asturias_x)\nscaled_data_asturias_y = np.array(scaled_data_asturias_y)\n\n\n# Since the first 90 values does not have historic, the dataset has been reduced in 90 values\nprint(f'Longitud datos de entrenamiento con historico: {len(scaled_data_asturias_y)}')\n\nLongitud datos de entrenamiento con historico: 476\n\n\n\n# we split data in train and test\n# as in previous analysis, we are going to predict a maximum of 21 days\nx_train = scaled_data_asturias_x[0:len(scaled_data_asturias_x)-91]\ny_train = scaled_data_asturias_y[0:len(scaled_data_asturias_y)-91]\nprint(f'Cantidad datos de entrenamiento: x={len(x_train)} - y={len(y_train)}')\n\nx_test = scaled_data_asturias_x[len(scaled_data_asturias_x)-90:len(scaled_data_asturias_x)]\ny_test = scaled_data_asturias_y[len(scaled_data_asturias_y)-90:len(scaled_data_asturias_y)]\nprint(f'Cantidad datos de test: x={len(x_test)} - y={len(y_test)}')\n\nCantidad datos de entrenamiento: x=385 - y=385\nCantidad datos de test: x=90 - y=90\n\n\n\n# Reshape the data to feed de recurrent network\nx_train = np.reshape(x_train, (x_train.shape[0], x_train.shape[1], 1))\nprint(\"Train data shape:\")\nprint(x_train.shape)\nprint(y_train.shape)\nx_test = np.reshape(x_test, (x_test.shape[0], x_test.shape[1], 1))\nprint(\"Test data shape:\")\nprint(x_test.shape)\nprint(y_test.shape)\n\nTrain data shape:\n(385, 90, 1)\n(385,)\nTest data shape:\n(90, 90, 1)\n(90,)\n\n\n\n# # Configure / setup the neural network model - LSTM\n# Build the model\nprint('Build model...')\nmodel = Sequential()\n# Model with Neurons \n# Inputshape = neurons -> Timestamps\nneurons= x_train.shape[1]\nmodel.add(LSTM(90, \n               activation = 'relu',\n               return_sequences = True, \n               input_shape = (x_train.shape[1], 1))) \nmodel.add(LSTM(50, \n               activation = 'relu',\n               return_sequences = True)) \nmodel.add(LSTM(25, \n               activation = 'relu',\n               return_sequences = False)) \nmodel.add(Dense(5, activation = 'relu'))\nmodel.add(Dense(1))\n\nBuild model...\n\n\n\nmodel.compile(optimizer='adam', loss='mean_squared_error')\nmodel.summary()\n\nModel: \"sequential_5\"\n\n\n_________________________________________________________________\n\n\n Layer (type)                Output Shape              Param #   \n\n\n=================================================================\n\n\n lstm_15 (LSTM)              (None, 90, 90)            33120     \n\n\n                                                                 \n\n\n lstm_16 (LSTM)              (None, 90, 50)            28200     \n\n\n                                                                 \n\n\n lstm_17 (LSTM)              (None, 25)                7600      \n\n\n                                                                 \n\n\n dense_10 (Dense)            (None, 5)                 130       \n\n\n                                                                 \n\n\n dense_11 (Dense)            (None, 1)                 6         \n\n\n                                                                 \n\n\n=================================================================\n\n\nTotal params: 69,056\n\n\nTrainable params: 69,056\n\n\nNon-trainable params: 0\n\n\n_________________________________________________________________\n\n\n\n# Training the model\n# # fit network\nhistory = model.fit(x_train, \n                    y_train, \n                    batch_size=1000, \n                    epochs=50, \n                    validation_data = (x_test, y_test), \n                    verbose = 0)\n\n\nplt.plot(history.history['loss'], label='train')\nplt.plot(history.history['val_loss'], label='test')\nplt.legend()\nplt.show() \n\n\n\n\n\n# Get the predicted values\npredictions = model.predict(x_test)\npredictions = scaler.inverse_transform(predictions)\n\nWARNING:tensorflow:5 out of the last 13 calls to <function Model.make_predict_function.<locals>.predict_function at 0x7fdc3a579c10> triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.\n\n\n1/3 [=========>....................] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - 0s 31ms/step\n\n\n\ny_test = y_test.reshape(-1,1)\ny_test = scaler.inverse_transform(y_test)\n\n\n# Calculate the mean absolute error (MAE)\nmae = mean_absolute_error(y_test, predictions)\nprint('MAE: ' + str(round(mae, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = np.sqrt(mean_squared_error(y_test,predictions))\nprint('RMSE: ' + str(round(rmse, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = mean_squared_error(y_test, \n                          predictions,\n                          squared = False)\nprint('RMSE: ' + str(round(rmse, 1)))\n\nMAE: 208.7\nRMSE: 387.0\nRMSE: 387.0\n\n\n\n# Add the difference between the valid and predicted prices\ntrain = data_asturias[:(len(x_train)+92)]\nvalid = data_asturias[(len(x_train)+91):]\n\n\nvalid.insert(1, \"Predictions\", predictions, True)\nvalid.insert(1, \"Difference\", valid[\"Predictions\"] - valid[\"num_casos\"], True)\n\n\n# Zoom-in to a closer timeframe\n# Date from which on the date is displayed\ndisplay_start_date = \"2021-07-15\"\nvalid = valid[valid.index > display_start_date]\ntrain = train[train.index > display_start_date]\n\n\n# Visualize the data\nmatplotlib.style.use('ggplot')\nfig, ax1 = plt.subplots(figsize=(22, 10), sharex=True)\n\n# Data - Train\nxt = train.index; \nyt = train[[\"num_casos\"]]\n# Data - Test / validation \nxv = valid.index; \nyv = valid[[\"num_casos\", \"Predictions\"]]\n\n# Plot\nplt.title(\"Asturias: Predictions vs Real infections\", fontsize=20)\nplt.ylabel(\"Nº Cases\", fontsize=18)\n\nplt.plot(yt, color=\"blue\", linewidth=1.5)\nplt.plot(yv[\"Predictions\"], color=\"red\", linewidth=1.5)\nplt.plot(yv[\"num_casos\"], color=\"green\", linewidth=1.5)\nplt.legend([\"Train\", \"LSTM Predictions\", \"Test\"], \n           loc=\"upper left\", fontsize=18)\n\n# Bar plot with the differences\nx = valid.index\ny = valid[\"Difference\"]\nplt.bar(x, y, width=0.2, color=\"grey\")\nplt.grid()\nplt.show()"
  },
  {
    "objectID": "lstm_uni.html#barcelona-1",
    "href": "lstm_uni.html#barcelona-1",
    "title": "LSTM univariate prediction",
    "section": "Barcelona",
    "text": "Barcelona\n\ndata_Barcelona = data_covid.loc[data_covid['provincia'] == 'Barcelona']\ndata_Barcelona = data_Barcelona.set_index('fecha')\ndata_Barcelona = data_Barcelona.filter(['num_casos'])\ndata_Barcelona = data_Barcelona['2020-06-14':'2021-12-31']\ndata_Barcelona\n\n\n\n\n\n  \n    \n      \n      num_casos\n    \n    \n      fecha\n      \n    \n  \n  \n    \n      2020-06-14\n      33\n    \n    \n      2020-06-15\n      62\n    \n    \n      2020-06-16\n      66\n    \n    \n      2020-06-17\n      70\n    \n    \n      2020-06-18\n      68\n    \n    \n      ...\n      ...\n    \n    \n      2021-12-27\n      19383\n    \n    \n      2021-12-28\n      20192\n    \n    \n      2021-12-29\n      19361\n    \n    \n      2021-12-30\n      17639\n    \n    \n      2021-12-31\n      16651\n    \n  \n\n566 rows × 1 columns\n\n\n\n\ndata_Barcelona.describe()\n\n\n\n\n\n  \n    \n      \n      num_casos\n    \n  \n  \n    \n      count\n      566.000000\n    \n    \n      mean\n      1575.480565\n    \n    \n      std\n      2281.290383\n    \n    \n      min\n      33.000000\n    \n    \n      25%\n      544.750000\n    \n    \n      50%\n      944.500000\n    \n    \n      75%\n      1609.500000\n    \n    \n      max\n      20192.000000\n    \n  \n\n\n\n\n\nnp_data_Barcelona = data_Barcelona.values\n\n\nscaler = MinMaxScaler(feature_range=(0, 1))\nscaled_data_Barcelona = scaler.fit_transform(np_data_Barcelona)\nprint(f'Longitud del conjunto de datos disponible: {len(scaled_data_Barcelona)}')\n\nLongitud del conjunto de datos disponible: 566\n\n\n\n# Since we are going to predict future values based on the 90 past elements, \n# we need to create a list with those historic information for each element\nhistoric_values = 90\nscaled_data_Barcelona_x = []\nscaled_data_Barcelona_y = []\n\nfor num_casos_i in range(historic_values, len(scaled_data_Barcelona)):\n    scaled_data_Barcelona_x.append(scaled_data_Barcelona[(num_casos_i-historic_values):num_casos_i, 0])\n    scaled_data_Barcelona_y.append(scaled_data_Barcelona[num_casos_i, 0])\n\n# Convert the x_train and y_train to numpy arrays\nscaled_data_Barcelona_x = np.array(scaled_data_Barcelona_x)\nscaled_data_Barcelona_y = np.array(scaled_data_Barcelona_y)\n\n\n# Train data looks like\nscaled_data_Barcelona_x[235]\n\narray([0.08507366, 0.07971626, 0.04826628, 0.04151992, 0.07822809,\n       0.07048961, 0.06289995, 0.05908031, 0.06354482, 0.04345454,\n       0.03884121, 0.06855499, 0.06309837, 0.06012203, 0.06116375,\n       0.05208592, 0.0405278 , 0.03422789, 0.06364403, 0.06056848,\n       0.05337566, 0.045786  , 0.04687733, 0.03323578, 0.02852324,\n       0.05833623, 0.05064735, 0.04777023, 0.03864279, 0.04330572,\n       0.03065628, 0.02668783, 0.04707575, 0.04355375, 0.04449625,\n       0.04251203, 0.04305769, 0.03199563, 0.02842403, 0.05317724,\n       0.04955603, 0.04266085, 0.04722456, 0.04861352, 0.0360633 ,\n       0.03090431, 0.06240389, 0.06106454, 0.05441738, 0.05074656,\n       0.05957637, 0.04181755, 0.03536882, 0.06384245, 0.05734411,\n       0.05084578, 0.0563024 , 0.03655935, 0.04191676, 0.04196637,\n       0.04712535, 0.06438811, 0.06275113, 0.05883228, 0.06170941,\n       0.0475222 , 0.03482316, 0.0651322 , 0.05873307, 0.06696761,\n       0.05268118, 0.05679845, 0.04008135, 0.03571606, 0.06642195,\n       0.077484  , 0.05863386, 0.06652116, 0.0546158 , 0.04608364,\n       0.03933727, 0.07872414, 0.07088645, 0.06389206, 0.06156059,\n       0.05878268, 0.03462473, 0.02753113, 0.06384245, 0.04682772])\n\n\n\n# Test data looks like\nscaled_data_Barcelona_y[235]\n\n0.05114340989136366\n\n\n\n# Since the first 90th values does not have historic, the dataset has been reduced in 90 values\nprint(f'Longitud datos de entrenamiento con historico: {len(scaled_data_Barcelona_y)}')\n\nLongitud datos de entrenamiento con historico: 476\n\n\n\n# we split data in train and test\n# as in previous analysis, we are going to predict a maximum of 90 days\nx_train = scaled_data_Barcelona_x[0:len(scaled_data_Barcelona_x)-91]\ny_train = scaled_data_Barcelona_y[0:len(scaled_data_Barcelona_y)-91]\nprint(f'Cantidad datos de entrenamiento: x={len(x_train)} - y={len(y_train)}')\n\nx_test = scaled_data_Barcelona_x[len(scaled_data_Barcelona_x)-90:len(scaled_data_Barcelona_x)]\ny_test = scaled_data_Barcelona_y[len(scaled_data_Barcelona_y)-90:len(scaled_data_Barcelona_y)]\nprint(f'Cantidad datos de test: x={len(x_test)} - y={len(y_test)}')\n\nCantidad datos de entrenamiento: x=385 - y=385\nCantidad datos de test: x=90 - y=90\n\n\n\n# Reshape the data to feed de recurrent network\nx_train = np.reshape(x_train, (x_train.shape[0], x_train.shape[1], 1))\nprint(\"Train data shape:\")\nprint(x_train.shape)\nprint(y_train.shape)\nx_test = np.reshape(x_test, (x_test.shape[0], x_test.shape[1], 1))\nprint(\"Test data shape:\")\nprint(x_test.shape)\nprint(y_test.shape)\n\nTrain data shape:\n(385, 90, 1)\n(385,)\nTest data shape:\n(90, 90, 1)\n(90,)\n\n\n\n# Configure / setup the neural network model - LSTM\n# Build the model\nprint('Build model...')\nmodel = Sequential()\n# Model with Neurons \n# Inputshape = neurons -> Timestamps\nneurons= x_train.shape[1]\nmodel.add(LSTM(90, \n               activation = 'relu',\n               return_sequences = True, \n               input_shape = (x_train.shape[1], 1))) \nmodel.add(LSTM(50, \n               activation = 'relu',\n               return_sequences = True)) \nmodel.add(LSTM(25, \n               activation = 'relu',\n               return_sequences = False)) \nmodel.add(Dense(5, activation = 'relu'))\nmodel.add(Dense(1))\n\nBuild model...\n\n\n\nmodel.compile(optimizer='adam', loss='mean_squared_error')\nmodel.summary()\n\nModel: \"sequential_6\"\n\n\n_________________________________________________________________\n\n\n Layer (type)                Output Shape              Param #   \n\n\n=================================================================\n\n\n lstm_18 (LSTM)              (None, 90, 90)            33120     \n\n\n                                                                 \n\n\n lstm_19 (LSTM)              (None, 90, 50)            28200     \n\n\n                                                                 \n\n\n lstm_20 (LSTM)              (None, 25)                7600      \n\n\n                                                                 \n\n\n dense_12 (Dense)            (None, 5)                 130       \n\n\n                                                                 \n\n\n dense_13 (Dense)            (None, 1)                 6         \n\n\n                                                                 \n\n\n=================================================================\n\n\nTotal params: 69,056\n\n\nTrainable params: 69,056\n\n\nNon-trainable params: 0\n\n\n_________________________________________________________________\n\n\n\n# Training the model\n# fit network\nhistory = model.fit(x_train, \n                    y_train, \n                    batch_size = 1000, \n                    epochs = 50, \n                    validation_data = (x_test, y_test), \n                    verbose = 0)\n\n\nplt.plot(history.history['loss'], label='train')\nplt.plot(history.history['val_loss'], label='test')\nplt.legend()\nplt.show() \n\n\n\n\n\n# Get the predicted values\npredictions = model.predict(x_test)\npredictions = scaler.inverse_transform(predictions)\n\n1/3 [=========>....................] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - 0s 31ms/step\n\n\n\ny_test = y_test.reshape(-1,1)\ny_test = scaler.inverse_transform(y_test)\n\n\n# Calculate the mean absolute error (MAE)\nmae = mean_absolute_error(y_test, predictions)\nprint('MAE: ' + str(round(mae, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = np.sqrt(mean_squared_error(y_test,predictions))\nprint('RMSE: ' + str(round(rmse, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = mean_squared_error(y_test, \n                          predictions,\n                          squared = False)\nprint('RMSE: ' + str(round(rmse, 1)))\n\nMAE: 1674.3\nRMSE: 3525.8\nRMSE: 3525.8\n\n\n\n# Add the difference between the valid and predicted prices\ntrain = data_Barcelona[:(len(x_train)+92)]\nvalid = data_Barcelona[(len(x_train)+91):]\n\n\nvalid.insert(1, \"Predictions\", predictions, True)\nvalid.insert(1, \"Difference\", valid[\"Predictions\"] - valid[\"num_casos\"], True)\n\n\n# Zoom-in to a closer timeframe\n# Date from which on the date is displayed\ndisplay_start_date = \"2021-07-15\" \nvalid = valid[valid.index > display_start_date]\ntrain = train[train.index > display_start_date]\n\n\n# Visualize the data\nmatplotlib.style.use('ggplot')\nfig, ax1 = plt.subplots(figsize=(22, 10), sharex=True)\n\n# Data - Train\nxt = train.index; \nyt = train[[\"num_casos\"]]\n# Data - Test / validation \nxv = valid.index; \nyv = valid[[\"num_casos\", \"Predictions\"]]\n\n# Plot\nplt.title(\"Barcelona: Predictions vs Real infections\", fontsize=20)\nplt.ylabel(\"Nº Cases\", fontsize=18)\n\nplt.plot(yt, color=\"blue\", linewidth=1.5)\nplt.plot(yv[\"Predictions\"], color=\"red\", linewidth=1.5)\nplt.plot(yv[\"num_casos\"], color=\"green\", linewidth=1.5)\nplt.legend([\"Train\", \"LSTM Predictions\", \"Test\"], \n           loc=\"upper left\", fontsize=18)\n\n# Bar plot with the differences\nx = valid.index\ny = valid[\"Difference\"]\nplt.bar(x, y, width=0.2, color=\"grey\")\nplt.grid()\nplt.show()"
  },
  {
    "objectID": "lstm_uni.html#madrid-1",
    "href": "lstm_uni.html#madrid-1",
    "title": "LSTM univariate prediction",
    "section": "Madrid",
    "text": "Madrid\n\ndata_Madrid = data_covid.loc[data_covid['provincia'] == 'Madrid']\ndata_Madrid = data_Madrid.set_index('fecha')\ndata_Madrid = data_Madrid.filter(['num_casos'])\ndata_Madrid = data_Madrid['2020-06-14':'2021-12-31']\ndata_Madrid\n\n\n\n\n\n  \n    \n      \n      num_casos\n    \n    \n      fecha\n      \n    \n  \n  \n    \n      2020-06-14\n      81\n    \n    \n      2020-06-15\n      153\n    \n    \n      2020-06-16\n      91\n    \n    \n      2020-06-17\n      93\n    \n    \n      2020-06-18\n      85\n    \n    \n      ...\n      ...\n    \n    \n      2021-12-27\n      22958\n    \n    \n      2021-12-28\n      23811\n    \n    \n      2021-12-29\n      21914\n    \n    \n      2021-12-30\n      20666\n    \n    \n      2021-12-31\n      7556\n    \n  \n\n566 rows × 1 columns\n\n\n\n\ndata_Madrid.describe()\n\n\n\n\n\n  \n    \n      \n      num_casos\n    \n  \n  \n    \n      count\n      566.000000\n    \n    \n      mean\n      1994.136042\n    \n    \n      std\n      2795.419848\n    \n    \n      min\n      28.000000\n    \n    \n      25%\n      550.250000\n    \n    \n      50%\n      1312.500000\n    \n    \n      75%\n      2282.500000\n    \n    \n      max\n      23811.000000\n    \n  \n\n\n\n\n\nnp_data_Madrid = data_Madrid.values\n\n\nscaler = MinMaxScaler(feature_range=(0, 1))\nscaled_data_Madrid = scaler.fit_transform(np_data_Madrid)\nprint(f'Longitud del conjunto de datos disponible: {len(scaled_data_Madrid)}')\n\nLongitud del conjunto de datos disponible: 566\n\n\n\n# Since we are going to predict future values based on the X past elements, \n# we need to create a list with those historic information for each element\nhistoric_values = 90\nscaled_data_Madrid_x = []\nscaled_data_Madrid_y = []\n\nfor num_casos_i in range(historic_values, len(scaled_data_Madrid)):\n    scaled_data_Madrid_x.append(scaled_data_Madrid[(num_casos_i-historic_values):num_casos_i, 0])\n    scaled_data_Madrid_y.append(scaled_data_Madrid[num_casos_i, 0])\n\n# Convert the x_train and y_train to numpy arrays\nscaled_data_Madrid_x = np.array(scaled_data_Madrid_x)\nscaled_data_Madrid_y = np.array(scaled_data_Madrid_y)\n\n\n# Train data looks like\nscaled_data_Madrid_x[235]\n\narray([0.11428331, 0.14741622, 0.08796199, 0.06395324, 0.11087752,\n       0.11272758, 0.08863474, 0.06862044, 0.09216667, 0.06046336,\n       0.04620948, 0.08363117, 0.07660934, 0.06508851, 0.05621663,\n       0.06428962, 0.04747088, 0.04288778, 0.06286003, 0.05844511,\n       0.0505403 , 0.0445276 , 0.05243241, 0.04061725, 0.03943994,\n       0.05398814, 0.05138124, 0.04734474, 0.04171047, 0.05159147,\n       0.03830467, 0.03771602, 0.05474499, 0.05365177, 0.04726065,\n       0.04360257, 0.05201194, 0.04036497, 0.03906151, 0.05360972,\n       0.05096077, 0.05226422, 0.05625867, 0.04229912, 0.04974141,\n       0.04700837, 0.07206828, 0.07745028, 0.06176681, 0.05815078,\n       0.07400244, 0.05239036, 0.05247446, 0.07026027, 0.07009208,\n       0.07698776, 0.05381996, 0.06079973, 0.07063869, 0.07370811,\n       0.09796914, 0.09767481, 0.08493462, 0.08094017, 0.08867679,\n       0.07139553, 0.05890762, 0.09666569, 0.09679183, 0.08846655,\n       0.08459824, 0.09405878, 0.07101711, 0.0631964 , 0.092461  ,\n       0.09771686, 0.08350502, 0.07568431, 0.08821427, 0.06386915,\n       0.05398814, 0.08152882, 0.0865324 , 0.07240466, 0.06172476,\n       0.07400244, 0.04566287, 0.04406509, 0.04633562, 0.06613968])\n\n\n\n# Test data looks like\nscaled_data_Madrid_y[235]\n\n0.0639532439137199\n\n\n\n# Since the first 90th values does not have historic, the dataset has been reduced in 90 values\nprint(f'Longitud datos de entrenamiento con historico: {len(scaled_data_Madrid_y)}')\n\nLongitud datos de entrenamiento con historico: 476\n\n\n\n# we split data in train and test\n# as in previous analysis, we are going to predict a maximum of 91 days\nx_train = scaled_data_Madrid_x[0:len(scaled_data_Madrid_x)-91]\ny_train = scaled_data_Madrid_y[0:len(scaled_data_Madrid_y)-91]\nprint(f'Cantidad datos de entrenamiento: x={len(x_train)} - y={len(y_train)}')\n\nx_test = scaled_data_Madrid_x[len(scaled_data_Madrid_x)-90:len(scaled_data_Madrid_x)]\ny_test = scaled_data_Madrid_y[len(scaled_data_Madrid_y)-90:len(scaled_data_Madrid_y)]\nprint(f'Cantidad datos de test: x={len(x_test)} - y={len(y_test)}')\n\nCantidad datos de entrenamiento: x=385 - y=385\nCantidad datos de test: x=90 - y=90\n\n\n\n# Reshape the data to feed de recurrent network\nx_train = np.reshape(x_train, (x_train.shape[0], x_train.shape[1], 1))\nprint(\"Train data shape:\")\nprint(x_train.shape)\nprint(y_train.shape)\nx_test = np.reshape(x_test, (x_test.shape[0], x_test.shape[1], 1))\nprint(\"Test data shape:\")\nprint(x_test.shape)\nprint(y_test.shape)\n\nTrain data shape:\n(385, 90, 1)\n(385,)\nTest data shape:\n(90, 90, 1)\n(90,)\n\n\n\n# Configure / setup the neural network model - LSTM\n# Build the model\nprint('Build model...')\nmodel = Sequential()\n# Model with Neurons \n# Inputshape = neurons -> Timestamps\nneurons= x_train.shape[1]\nmodel.add(LSTM(90, \n               activation = 'relu',\n               return_sequences = True, \n               input_shape = (x_train.shape[1], 1))) \nmodel.add(LSTM(50, \n               activation = 'relu',\n               return_sequences = True)) \nmodel.add(LSTM(25, \n               activation = 'relu',\n               return_sequences = False)) \nmodel.add(Dense(5, activation = 'relu'))\nmodel.add(Dense(1))\n\nBuild model...\n\n\n\nmodel.compile(optimizer='adam', loss='mean_squared_error')\nmodel.summary()\n\nModel: \"sequential_7\"\n\n\n_________________________________________________________________\n\n\n Layer (type)                Output Shape              Param #   \n\n\n=================================================================\n\n\n lstm_21 (LSTM)              (None, 90, 90)            33120     \n\n\n                                                                 \n\n\n lstm_22 (LSTM)              (None, 90, 50)            28200     \n\n\n                                                                 \n\n\n lstm_23 (LSTM)              (None, 25)                7600      \n\n\n                                                                 \n\n\n dense_14 (Dense)            (None, 5)                 130       \n\n\n                                                                 \n\n\n dense_15 (Dense)            (None, 1)                 6         \n\n\n                                                                 \n\n\n=================================================================\n\n\nTotal params: 69,056\n\n\nTrainable params: 69,056\n\n\nNon-trainable params: 0\n\n\n_________________________________________________________________\n\n\n\n# Training the model\n# fit network\nhistory = model.fit(x_train, \n                    y_train, \n                    batch_size = 1000, \n                    epochs = 50, \n                    validation_data = (x_test, y_test), \n                    verbose = 0)\n\n\nplt.plot(history.history['loss'], label='train')\nplt.plot(history.history['val_loss'], label='test')\nplt.legend()\nplt.show() \n\n\n\n\n\n# Get the predicted values\npredictions = model.predict(x_test)\npredictions = scaler.inverse_transform(predictions)\n\n1/3 [=========>....................] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - 0s 31ms/step\n\n\n\ny_test = y_test.reshape(-1,1)\ny_test = scaler.inverse_transform(y_test)\n\n\n# Calculate the mean absolute error (MAE)\nmae = mean_absolute_error(y_test, predictions)\nprint('MAE: ' + str(round(mae, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = np.sqrt(mean_squared_error(y_test,predictions))\nprint('RMSE: ' + str(round(rmse, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = mean_squared_error(y_test, \n                          predictions,\n                          squared = False)\nprint('RMSE: ' + str(round(rmse, 1)))\n\nMAE: 2521.6\nRMSE: 5345.2\nRMSE: 5345.2\n\n\n\n# Add the difference between the valid and predicted prices\ntrain = data_Madrid[:(len(x_train)+92)]\nvalid = data_Madrid[(len(x_train)+91):]\n\n\nvalid.insert(1, \"Predictions\", predictions, True)\nvalid.insert(1, \"Difference\", valid[\"Predictions\"] - valid[\"num_casos\"], True)\n\n\n# Zoom-in to a closer timeframe\n# Date from which on the date is displayed\ndisplay_start_date = \"2021-07-15\" \nvalid = valid[valid.index > display_start_date]\ntrain = train[train.index > display_start_date]\n\n\n# Visualize the data\nmatplotlib.style.use('ggplot')\nfig, ax1 = plt.subplots(figsize=(22, 10), sharex=True)\n\n# Data - Train\nxt = train.index; \nyt = train[[\"num_casos\"]]\n# Data - Test / validation \nxv = valid.index; \nyv = valid[[\"num_casos\", \"Predictions\"]]\n\n# Plot\nplt.title(\"Madrid: Predictions vs Real infections\", fontsize=20)\nplt.ylabel(\"Nº Cases\", fontsize=18)\n\nplt.plot(yt, color=\"blue\", linewidth=1.5)\nplt.plot(yv[\"Predictions\"], color=\"red\", linewidth=1.5)\nplt.plot(yv[\"num_casos\"], color=\"green\", linewidth=1.5)\nplt.legend([\"Train\", \"LSTM Predictions\", \"Test\"], \n           loc=\"upper left\", fontsize=18)\n\n# Bar plot with the differences\nx = valid.index\ny = valid[\"Difference\"]\nplt.bar(x, y, width=0.2, color=\"grey\")\nplt.grid()\nplt.show()"
  },
  {
    "objectID": "lstm_uni.html#malaga-1",
    "href": "lstm_uni.html#malaga-1",
    "title": "LSTM univariate prediction",
    "section": "Malaga",
    "text": "Malaga\n\ndata_Malaga = data_covid.loc[data_covid['provincia'] == 'Málaga']\ndata_Malaga = data_Malaga.set_index('fecha')\ndata_Malaga = data_Malaga.filter(['num_casos'])\ndata_Malaga = data_Malaga['2020-06-14':'2021-12-31']\ndata_Malaga\n\n\n\n\n\n  \n    \n      \n      num_casos\n    \n    \n      fecha\n      \n    \n  \n  \n    \n      2020-06-14\n      2\n    \n    \n      2020-06-15\n      1\n    \n    \n      2020-06-16\n      1\n    \n    \n      2020-06-17\n      2\n    \n    \n      2020-06-18\n      2\n    \n    \n      ...\n      ...\n    \n    \n      2021-12-27\n      1627\n    \n    \n      2021-12-28\n      2772\n    \n    \n      2021-12-29\n      3080\n    \n    \n      2021-12-30\n      3075\n    \n    \n      2021-12-31\n      2646\n    \n  \n\n566 rows × 1 columns\n\n\n\n\ndata_Malaga.describe()\n\n\n\n\n\n  \n    \n      \n      num_casos\n    \n  \n  \n    \n      count\n      566.000000\n    \n    \n      mean\n      339.227915\n    \n    \n      std\n      427.261346\n    \n    \n      min\n      1.000000\n    \n    \n      25%\n      110.000000\n    \n    \n      50%\n      193.500000\n    \n    \n      75%\n      344.750000\n    \n    \n      max\n      3080.000000\n    \n  \n\n\n\n\n\nnp_data_Malaga = data_Malaga.values\n\n\nscaler = MinMaxScaler(feature_range=(0, 1))\nscaled_data_Malaga = scaler.fit_transform(np_data_Malaga)\nprint(f'Longitud del conjunto de datos disponible: {len(scaled_data_Malaga)}')\n\nLongitud del conjunto de datos disponible: 566\n\n\n\n# Since we are going to predict future values based on the X past elements, \n# we need to create a list with those historic information for each element\nhistoric_values = 90\nscaled_data_Malaga_x = []\nscaled_data_Malaga_y = []\n\nfor num_casos_i in range(historic_values, len(scaled_data_Malaga)):\n    scaled_data_Malaga_x.append(scaled_data_Malaga[(num_casos_i-historic_values):num_casos_i, 0])\n    scaled_data_Malaga_y.append(scaled_data_Malaga[num_casos_i, 0])\n\n# Convert the x_train and y_train to numpy arrays\nscaled_data_Malaga_x = np.array(scaled_data_Malaga_x)\nscaled_data_Malaga_y = np.array(scaled_data_Malaga_y)\n\n\n# Train data looks like\nscaled_data_Malaga_x[235]\n\narray([0.24423514, 0.21890224, 0.15621955, 0.12016889, 0.15329652,\n       0.14420266, 0.14712569, 0.14647613, 0.11627152, 0.09418642,\n       0.06722962, 0.09516077, 0.11042546, 0.06852874, 0.06950309,\n       0.06658006, 0.04871712, 0.03442676, 0.05943488, 0.0490419 ,\n       0.04936668, 0.04449497, 0.04157194, 0.03962325, 0.02923027,\n       0.04157194, 0.04741799, 0.05131536, 0.04871712, 0.04287106,\n       0.02760637, 0.02858071, 0.0422215 , 0.04092238, 0.03994804,\n       0.03507632, 0.0506658 , 0.03020461, 0.02630724, 0.04092238,\n       0.03117895, 0.04319584, 0.03702501, 0.0354011 , 0.02923027,\n       0.02078597, 0.04157194, 0.04514453, 0.03832413, 0.04741799,\n       0.0490419 , 0.0354011 , 0.02858071, 0.05326405, 0.05293927,\n       0.05586229, 0.0422215 , 0.04027282, 0.03442676, 0.0490419 ,\n       0.0659305 , 0.07794739, 0.0659305 , 0.05878532, 0.06203313,\n       0.05034102, 0.03085417, 0.07047743, 0.05618707, 0.0776226 ,\n       0.06138357, 0.07080221, 0.04124716, 0.04546931, 0.0659305 ,\n       0.06690484, 0.05878532, 0.05488795, 0.05293927, 0.04352062,\n       0.03637545, 0.0591101 , 0.06495615, 0.05975966, 0.05521273,\n       0.05846054, 0.04481975, 0.04514453, 0.06235791, 0.07697304])\n\n\n\n# Test data looks like\nscaled_data_Malaga_y[235]\n\n0.07340045469308218\n\n\n\n# Since the first 90th values does not have historic, the dataset has been reduced in 90 values\nprint(f'Longitud datos de entrenamiento con historico: {len(scaled_data_Malaga_y)}')\n\nLongitud datos de entrenamiento con historico: 476\n\n\n\n# we split data in train and test\n# as in previous analysis, we are going to predict a maximum of 91 days\nx_train = scaled_data_Malaga_x[0:len(scaled_data_Malaga_x)-91]\ny_train = scaled_data_Malaga_y[0:len(scaled_data_Malaga_y)-91]\nprint(f'Cantidad datos de entrenamiento: x={len(x_train)} - y={len(y_train)}')\n\nx_test = scaled_data_Malaga_x[len(scaled_data_Malaga_x)-90:len(scaled_data_Malaga_x)]\ny_test = scaled_data_Malaga_y[len(scaled_data_Malaga_y)-90:len(scaled_data_Malaga_y)]\nprint(f'Cantidad datos de test: x={len(x_test)} - y={len(y_test)}')\n\nCantidad datos de entrenamiento: x=385 - y=385\nCantidad datos de test: x=90 - y=90\n\n\n\n# Reshape the data to feed de recurrent network\nx_train = np.reshape(x_train, (x_train.shape[0], x_train.shape[1], 1))\nprint(\"Train data shape:\")\nprint(x_train.shape)\nprint(y_train.shape)\nx_test = np.reshape(x_test, (x_test.shape[0], x_test.shape[1], 1))\nprint(\"Test data shape:\")\nprint(x_test.shape)\nprint(y_test.shape)\n\nTrain data shape:\n(385, 90, 1)\n(385,)\nTest data shape:\n(90, 90, 1)\n(90,)\n\n\n\n# Configure / setup the neural network model - LSTM\n# Build the model\nprint('Build model...')\nmodel = Sequential()\n# Model with Neurons \n# Inputshape = neurons -> Timestamps\nneurons= x_train.shape[1]\nmodel.add(LSTM(90, \n               activation = 'relu',\n               return_sequences = True, \n               input_shape = (x_train.shape[1], 1))) \nmodel.add(LSTM(50, \n               activation = 'relu',\n               return_sequences = True)) \nmodel.add(LSTM(25, \n               activation = 'relu',\n               return_sequences = False)) \nmodel.add(Dense(5, activation = 'relu'))\nmodel.add(Dense(1))\n\nBuild model...\n\n\n\nmodel.compile(optimizer='adam', loss='mean_squared_error')\nmodel.summary()\n\nModel: \"sequential_8\"\n\n\n_________________________________________________________________\n\n\n Layer (type)                Output Shape              Param #   \n\n\n=================================================================\n\n\n lstm_24 (LSTM)              (None, 90, 90)            33120     \n\n\n                                                                 \n\n\n lstm_25 (LSTM)              (None, 90, 50)            28200     \n\n\n                                                                 \n\n\n lstm_26 (LSTM)              (None, 25)                7600      \n\n\n                                                                 \n\n\n dense_16 (Dense)            (None, 5)                 130       \n\n\n                                                                 \n\n\n dense_17 (Dense)            (None, 1)                 6         \n\n\n                                                                 \n\n\n=================================================================\n\n\nTotal params: 69,056\n\n\nTrainable params: 69,056\n\n\nNon-trainable params: 0\n\n\n_________________________________________________________________\n\n\n\n# Training the model\n# fit network\nhistory = model.fit(x_train, \n                    y_train, \n                    batch_size = 1000, \n                    epochs = 50, \n                    validation_data = (x_test, y_test), \n                    verbose = 0)\n\n\nplt.plot(history.history['loss'], label='train')\nplt.plot(history.history['val_loss'], label='test')\nplt.legend()\nplt.show() \n\n\n\n\n\n# Get the predicted values\npredictions = model.predict(x_test)\npredictions = scaler.inverse_transform(predictions)\n\n1/3 [=========>....................] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - 0s 31ms/step\n\n\n\ny_test = y_test.reshape(-1,1)\ny_test = scaler.inverse_transform(y_test)\n\n\n# Calculate the mean absolute error (MAE)\nmae = mean_absolute_error(y_test, predictions)\nprint('MAE: ' + str(round(mae, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = np.sqrt(mean_squared_error(y_test,predictions))\nprint('RMSE: ' + str(round(rmse, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = mean_squared_error(y_test, \n                          predictions,\n                          squared = False)\nprint('RMSE: ' + str(round(rmse, 1)))\n\nMAE: 197.7\nRMSE: 331.7\nRMSE: 331.7\n\n\n\n# Add the difference between the valid and predicted prices\ntrain = data_Malaga[:(len(x_train)+92)]\nvalid = data_Malaga[(len(x_train)+91):]\n\n\nvalid.insert(1, \"Predictions\", predictions, True)\nvalid.insert(1, \"Difference\", valid[\"Predictions\"] - valid[\"num_casos\"], True)\n\n\n# Zoom-in to a closer timeframe\n# Date from which on the date is displayed\ndisplay_start_date = \"2021-07-15\" \nvalid = valid[valid.index > display_start_date]\ntrain = train[train.index > display_start_date]\n\n\n# Visualize the data\nmatplotlib.style.use('ggplot')\nfig, ax1 = plt.subplots(figsize=(22, 10), sharex=True)\n\n# Data - Train\nxt = train.index; \nyt = train[[\"num_casos\"]]\n# Data - Test / validation \nxv = valid.index; \nyv = valid[[\"num_casos\", \"Predictions\"]]\n\n# Plot\nplt.title(\"Malaga: Predictions vs Real infections\", fontsize=20)\nplt.ylabel(\"Nº Cases\", fontsize=18)\n\nplt.plot(yt, color=\"blue\", linewidth=1.5)\nplt.plot(yv[\"Predictions\"], color=\"red\", linewidth=1.5)\nplt.plot(yv[\"num_casos\"], color=\"green\", linewidth=1.5)\nplt.legend([\"Train\", \"LSTM Predictions\", \"Test\"], \n           loc=\"upper left\", fontsize=18)\n\n# Bar plot with the differences\nx = valid.index\ny = valid[\"Difference\"]\nplt.bar(x, y, width=0.2, color=\"grey\")\nplt.grid()\nplt.show()"
  },
  {
    "objectID": "lstm_uni.html#sevilla-1",
    "href": "lstm_uni.html#sevilla-1",
    "title": "LSTM univariate prediction",
    "section": "Sevilla",
    "text": "Sevilla\n\ndata_Sevilla = data_covid.loc[data_covid['provincia'] == 'Sevilla']\ndata_Sevilla = data_Sevilla.set_index('fecha')\ndata_Sevilla = data_Sevilla.filter(['num_casos'])\ndata_Sevilla = data_Sevilla['2020-06-14':'2021-12-31']\ndata_Sevilla\n\n\n\n\n\n  \n    \n      \n      num_casos\n    \n    \n      fecha\n      \n    \n  \n  \n    \n      2020-06-14\n      0\n    \n    \n      2020-06-15\n      2\n    \n    \n      2020-06-16\n      1\n    \n    \n      2020-06-17\n      0\n    \n    \n      2020-06-18\n      0\n    \n    \n      ...\n      ...\n    \n    \n      2021-12-27\n      2617\n    \n    \n      2021-12-28\n      3190\n    \n    \n      2021-12-29\n      3692\n    \n    \n      2021-12-30\n      3508\n    \n    \n      2021-12-31\n      2816\n    \n  \n\n566 rows × 1 columns\n\n\n\n\ndata_Sevilla.describe()\n\n\n\n\n\n  \n    \n      \n      num_casos\n    \n  \n  \n    \n      count\n      566.000000\n    \n    \n      mean\n      383.807420\n    \n    \n      std\n      454.714408\n    \n    \n      min\n      0.000000\n    \n    \n      25%\n      112.750000\n    \n    \n      50%\n      260.500000\n    \n    \n      75%\n      459.000000\n    \n    \n      max\n      3692.000000\n    \n  \n\n\n\n\n\nnp_data_Sevilla = data_Sevilla.values\n\n\nscaler = MinMaxScaler(feature_range=(0, 1))\nscaled_data_Sevilla = scaler.fit_transform(np_data_Sevilla)\nprint(f'Longitud del conjunto de datos disponible: {len(scaled_data_Sevilla)}')\n\nLongitud del conjunto de datos disponible: 566\n\n\n\n# Since we are going to predict future values based on the X past elements, \n# we need to create a list with those historic information for each element\nhistoric_values = 90\nscaled_data_Sevilla_x = []\nscaled_data_Sevilla_y = []\n\nfor num_casos_i in range(historic_values, len(scaled_data_Sevilla)):\n    scaled_data_Sevilla_x.append(scaled_data_Sevilla[(num_casos_i-historic_values):num_casos_i, 0])\n    scaled_data_Sevilla_y.append(scaled_data_Sevilla[num_casos_i, 0])\n\n# Convert the x_train and y_train to numpy arrays\nscaled_data_Sevilla_x = np.array(scaled_data_Sevilla_x)\nscaled_data_Sevilla_y = np.array(scaled_data_Sevilla_y)\n\n\n# Train data looks like\nscaled_data_Sevilla_x[235]\n\narray([0.18634886, 0.19799567, 0.14626219, 0.0896533 , 0.13894908,\n       0.1695558 , 0.14572048, 0.12242687, 0.13434453, 0.06500542,\n       0.05390033, 0.08206934, 0.08667389, 0.09452871, 0.06798483,\n       0.05904659, 0.04252438, 0.0343987 , 0.06554713, 0.06473456,\n       0.05444204, 0.0503792 , 0.05796316, 0.04577465, 0.03819068,\n       0.04712893, 0.0528169 , 0.0663597 , 0.06013001, 0.05119177,\n       0.03764897, 0.031961  , 0.05119177, 0.05010834, 0.04739978,\n       0.05119177, 0.05390033, 0.03927411, 0.03737811, 0.06013001,\n       0.05633803, 0.05606717, 0.05850488, 0.06473456, 0.04658722,\n       0.04198267, 0.07150596, 0.07340195, 0.05823402, 0.08071506,\n       0.07773564, 0.05877573, 0.05471289, 0.07990249, 0.08829902,\n       0.0872156 , 0.09019502, 0.07069339, 0.08775731, 0.08396533,\n       0.14951246, 0.12432286, 0.12269772, 0.12378115, 0.13028169,\n       0.11348862, 0.07936078, 0.13299025, 0.12269772, 0.11213434,\n       0.12107259, 0.12432286, 0.09723727, 0.07042254, 0.09886241,\n       0.11782232, 0.10157096, 0.10346696, 0.12621885, 0.08342362,\n       0.07340195, 0.0847779 , 0.08559047, 0.11159263, 0.10292524,\n       0.08911159, 0.07502709, 0.04821235, 0.08315276, 0.09913326])\n\n\n\n# Test data looks like\nscaled_data_Sevilla_y[235]\n\n0.10861321776814734\n\n\n\n# Since the first 90th values does not have historic, the dataset has been reduced in 90 values\nprint(f'Longitud datos de entrenamiento con historico: {len(scaled_data_Sevilla_y)}')\n\nLongitud datos de entrenamiento con historico: 476\n\n\n\n# we split data in train and test\n# as in previous analysis, we are going to predict a maximum of 91 days\nx_train = scaled_data_Sevilla_x[0:len(scaled_data_Sevilla_x)-91]\ny_train = scaled_data_Sevilla_y[0:len(scaled_data_Sevilla_y)-91]\nprint(f'Cantidad datos de entrenamiento: x={len(x_train)} - y={len(y_train)}')\n\nx_test = scaled_data_Sevilla_x[len(scaled_data_Sevilla_x)-90:len(scaled_data_Sevilla_x)]\ny_test = scaled_data_Sevilla_y[len(scaled_data_Sevilla_y)-90:len(scaled_data_Sevilla_y)]\nprint(f'Cantidad datos de test: x={len(x_test)} - y={len(y_test)}')\n\nCantidad datos de entrenamiento: x=385 - y=385\nCantidad datos de test: x=90 - y=90\n\n\n\n# Reshape the data to feed de recurrent network\nx_train = np.reshape(x_train, (x_train.shape[0], x_train.shape[1], 1))\nprint(\"Train data shape:\")\nprint(x_train.shape)\nprint(y_train.shape)\nx_test = np.reshape(x_test, (x_test.shape[0], x_test.shape[1], 1))\nprint(\"Test data shape:\")\nprint(x_test.shape)\nprint(y_test.shape)\n\nTrain data shape:\n(385, 90, 1)\n(385,)\nTest data shape:\n(90, 90, 1)\n(90,)\n\n\n\n# Configure / setup the neural network model - LSTM\n# Build the model\nprint('Build model...')\nmodel = Sequential()\n# Model with Neurons \n# Inputshape = neurons -> Timestamps\nneurons= x_train.shape[1]\nmodel.add(LSTM(90, \n               activation = 'relu',\n               return_sequences = True, \n               input_shape = (x_train.shape[1], 1))) \nmodel.add(LSTM(50, \n               activation = 'relu',\n               return_sequences = True)) \nmodel.add(LSTM(25, \n               activation = 'relu',\n               return_sequences = False)) \nmodel.add(Dense(5, activation = 'relu'))\nmodel.add(Dense(1))\n\nBuild model...\n\n\n\nmodel.compile(optimizer='adam', loss='mean_squared_error')\nmodel.summary()\n\nModel: \"sequential_9\"\n\n\n_________________________________________________________________\n\n\n Layer (type)                Output Shape              Param #   \n\n\n=================================================================\n\n\n lstm_27 (LSTM)              (None, 90, 90)            33120     \n\n\n                                                                 \n\n\n lstm_28 (LSTM)              (None, 90, 50)            28200     \n\n\n                                                                 \n\n\n lstm_29 (LSTM)              (None, 25)                7600      \n\n\n                                                                 \n\n\n dense_18 (Dense)            (None, 5)                 130       \n\n\n                                                                 \n\n\n dense_19 (Dense)            (None, 1)                 6         \n\n\n                                                                 \n\n\n=================================================================\n\n\nTotal params: 69,056\n\n\nTrainable params: 69,056\n\n\nNon-trainable params: 0\n\n\n_________________________________________________________________\n\n\n\n# Training the model\n# fit network\nhistory = model.fit(x_train, \n                    y_train, \n                    batch_size = 1000, \n                    epochs = 50, \n                    validation_data = (x_test, y_test), \n                    verbose = 0)\n\n\nplt.plot(history.history['loss'], label='train')\nplt.plot(history.history['val_loss'], label='test')\nplt.legend()\nplt.show() \n\n\n\n\n\n# Get the predicted values\npredictions = model.predict(x_test)\npredictions = scaler.inverse_transform(predictions)\n\n1/3 [=========>....................] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - 0s 32ms/step\n\n\n\ny_test = y_test.reshape(-1,1)\ny_test = scaler.inverse_transform(y_test)\n\n\n# Calculate the mean absolute error (MAE)\nmae = mean_absolute_error(y_test, predictions)\nprint('MAE: ' + str(round(mae, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = np.sqrt(mean_squared_error(y_test,predictions))\nprint('RMSE: ' + str(round(rmse, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = mean_squared_error(y_test, \n                          predictions,\n                          squared = False)\nprint('RMSE: ' + str(round(rmse, 1)))\n\nMAE: 329.2\nRMSE: 595.9\nRMSE: 595.9\n\n\n\n# Add the difference between the valid and predicted prices\ntrain = data_Sevilla[:(len(x_train)+92)]\nvalid = data_Sevilla[(len(x_train)+91):]\n\n\nvalid.insert(1, \"Predictions\", predictions, True)\nvalid.insert(1, \"Difference\", valid[\"Predictions\"] - valid[\"num_casos\"], True)\n\n\n# Zoom-in to a closer timeframe\n# Date from which on the date is displayed\ndisplay_start_date = \"2021-07-15\" \nvalid = valid[valid.index > display_start_date]\ntrain = train[train.index > display_start_date]\n\n\n# Visualize the data\nmatplotlib.style.use('ggplot')\nfig, ax1 = plt.subplots(figsize=(22, 10), sharex=True)\n\n# Data - Train\nxt = train.index; \nyt = train[[\"num_casos\"]]\n# Data - Test / validation \nxv = valid.index; \nyv = valid[[\"num_casos\", \"Predictions\"]]\n\n# Plot\nplt.title(\"Sevilla: Predictions vs Real infections\", fontsize=20)\nplt.ylabel(\"Nº Cases\", fontsize=18)\n\nplt.plot(yt, color=\"blue\", linewidth=1.5)\nplt.plot(yv[\"Predictions\"], color=\"red\", linewidth=1.5)\nplt.plot(yv[\"num_casos\"], color=\"green\", linewidth=1.5)\nplt.legend([\"Train\", \"LSTM Predictions\", \"Test\"], \n           loc=\"upper left\", fontsize=18)\n\n# Bar plot with the differences\nx = valid.index\ny = valid[\"Difference\"]\nplt.bar(x, y, width=0.2, color=\"grey\")\nplt.grid()\nplt.show()"
  },
  {
    "objectID": "lstm_multi.html",
    "href": "lstm_multi.html",
    "title": "LSTM multivariate prediction",
    "section": "",
    "text": "Import python packages:"
  },
  {
    "objectID": "lstm_multi.html#asturias",
    "href": "lstm_multi.html#asturias",
    "title": "LSTM multivariate prediction",
    "section": "Asturias",
    "text": "Asturias\n\ndata_asturias = data_covid.loc[data_covid['provincia'] == 'Asturias']\ndata_asturias = data_asturias.set_index('fecha')\ndata_asturias = data_asturias['2020-06-14':]\ndata_asturias = data_asturias.filter(['num_casos', 'tmed', 'mob_grocery_pharmacy', \n'mob_parks', 'mob_residential', 'mob_residential', 'mob_transit_stations', 'mob_workplaces'])\ndata_asturias\n\n\n\n\n\n  \n    \n      \n      num_casos\n      tmed\n      mob_grocery_pharmacy\n      mob_parks\n      mob_residential\n      mob_residential\n      mob_transit_stations\n      mob_workplaces\n    \n    \n      fecha\n      \n      \n      \n      \n      \n      \n      \n      \n    \n  \n  \n    \n      2020-06-14\n      0\n      16.8\n      -8.0\n      6.0\n      4.0\n      4.0\n      -43.0\n      -2.0\n    \n    \n      2020-06-15\n      0\n      16.0\n      -6.0\n      39.0\n      7.0\n      7.0\n      -38.0\n      -27.0\n    \n    \n      2020-06-16\n      1\n      15.6\n      -6.0\n      7.0\n      9.0\n      9.0\n      -43.0\n      -29.0\n    \n    \n      2020-06-17\n      0\n      15.6\n      -7.0\n      20.0\n      8.0\n      8.0\n      -42.0\n      -28.0\n    \n    \n      2020-06-18\n      0\n      15.1\n      -4.0\n      68.0\n      7.0\n      7.0\n      -39.0\n      -28.0\n    \n    \n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n    \n    \n      2022-03-25\n      244\n      11.6\n      -2.0\n      24.0\n      2.0\n      2.0\n      -13.0\n      -12.0\n    \n    \n      2022-03-26\n      432\n      12.0\n      -13.0\n      27.0\n      1.0\n      1.0\n      -19.0\n      -13.0\n    \n    \n      2022-03-27\n      1\n      14.2\n      -7.5\n      33.0\n      -1.0\n      -1.0\n      -13.0\n      -11.0\n    \n    \n      2022-03-28\n      9\n      13.8\n      -2.0\n      45.0\n      1.0\n      1.0\n      -9.0\n      -10.0\n    \n    \n      2022-03-29\n      0\n      11.7\n      -4.0\n      17.0\n      3.0\n      3.0\n      -15.0\n      -12.0\n    \n  \n\n654 rows × 8 columns\n\n\n\n\ndata_asturias.describe()\n\n\n\n\n\n  \n    \n      \n      num_casos\n      tmed\n      mob_grocery_pharmacy\n      mob_parks\n      mob_residential\n      mob_residential\n      mob_transit_stations\n      mob_workplaces\n    \n  \n  \n    \n      count\n      654.00000\n      654.000000\n      654.00000\n      654.000000\n      654.000000\n      654.000000\n      654.000000\n      654.000000\n    \n    \n      mean\n      312.11315\n      13.909098\n      3.83792\n      57.725535\n      3.695719\n      3.695719\n      -12.614679\n      -20.651376\n    \n    \n      std\n      565.17985\n      4.198047\n      15.05797\n      68.024228\n      4.802763\n      4.802763\n      14.838430\n      12.754756\n    \n    \n      min\n      0.00000\n      3.300000\n      -87.00000\n      -63.000000\n      -8.000000\n      -8.000000\n      -67.000000\n      -80.000000\n    \n    \n      25%\n      43.50000\n      10.800000\n      -0.50000\n      13.000000\n      1.000000\n      1.000000\n      -22.000000\n      -26.000000\n    \n    \n      50%\n      117.00000\n      13.900000\n      5.00000\n      39.000000\n      3.000000\n      3.000000\n      -13.000000\n      -18.500000\n    \n    \n      75%\n      323.75000\n      17.600000\n      10.00000\n      83.500000\n      6.000000\n      6.000000\n      -4.000000\n      -14.000000\n    \n    \n      max\n      3827.00000\n      25.100000\n      42.00000\n      333.000000\n      26.000000\n      26.000000\n      26.000000\n      12.000000\n    \n  \n\n\n\n\n\nnp_data_asturias = data_asturias.values\n\n\n# Train dataset\nscaler = MinMaxScaler(feature_range=(0, 1))\nscaled_data_asturias = scaler.fit_transform(np_data_asturias)\nprint(f'Longitud del conjunto de datos disponible: {len(scaled_data_asturias)}')\n\nLongitud del conjunto de datos disponible: 654\n\n\n\n# Since we are going to predict future values based on the 90 past elements, \n# we need to create a list with those historic information for each element\nhistoric_values = 90\nscaled_data_asturias_x = []\nscaled_data_asturias_y = []\n\nfor i in range(historic_values, len(scaled_data_asturias)):\n    scaled_data_asturias_x.append(scaled_data_asturias[(i-historic_values):i, :])\n    scaled_data_asturias_y.append(scaled_data_asturias[i, 0])\n\n# Convert the x_train and y_train to numpy arrays\nscaled_data_asturias_x = np.array(scaled_data_asturias_x)\nscaled_data_asturias_y = np.array(scaled_data_asturias_y)\n\n\n# Once predicted, we are going to need a exclusive scaler for num_cases\nscaler_pred = MinMaxScaler(feature_range=(0, 1))\ndf_cases_asturias = pd.DataFrame(data_asturias['num_casos'])\nscaled_data_asturias_pred = scaler_pred.fit_transform(df_cases_asturias)\n\n\n# Since the first 90th values does not have historic, the dataset has been reduced in 90 values\nprint(f'Longitud datos de entrenamiento con historico: {len(scaled_data_asturias_y)}')\n\nLongitud datos de entrenamiento con historico: 564\n\n\n\n# we split data in train and test\n# as in previous analysis, we are going to predict a maximum of 90 days\nx_train = scaled_data_asturias_x[0:len(scaled_data_asturias_x)-91]\ny_train = scaled_data_asturias_y[0:len(scaled_data_asturias_y)-91]\nprint(f'Cantidad datos de entrenamiento: x={len(x_train)} - y={len(y_train)}')\n\nx_test = scaled_data_asturias_x[len(scaled_data_asturias_x)-90:len(scaled_data_asturias_x)]\ny_test = scaled_data_asturias_y[len(scaled_data_asturias_y)-90:len(scaled_data_asturias_y)]\nprint(f'Cantidad datos de test: x={len(x_test)} - y={len(y_test)}')\n\nCantidad datos de entrenamiento: x=473 - y=473\nCantidad datos de test: x=90 - y=90\n\n\n\n# Reshape the data to feed de recurrent network\nx_train = np.reshape(x_train, (x_train.shape[0], x_train.shape[1], 8))\nprint(\"Train data shape:\")\nprint(x_train.shape)\nprint(y_train.shape)\nx_test = np.reshape(x_test, (x_test.shape[0], x_test.shape[1], 8))\nprint(\"Test data shape:\")\nprint(x_test.shape)\nprint(y_test.shape)\n\nTrain data shape:\n(473, 90, 8)\n(473,)\nTest data shape:\n(90, 90, 8)\n(90,)\n\n\n\n# Configure / setup the neural network model - LSTM\n# Build the model\nprint('Build model...')\nmodel = Sequential()\n# Model with Neurons \n# Inputshape = neurons -> Timestamps\nneurons= x_train.shape[1]\nmodel.add(LSTM(90, \n               activation = 'relu',\n               return_sequences = True, \n               input_shape = (x_train.shape[1], 8))) \nmodel.add(LSTM(50, \n               activation = 'relu',\n               return_sequences = True)) \nmodel.add(LSTM(25, \n               activation = 'relu',\n               return_sequences = False)) \nmodel.add(Dense(5, activation = 'relu'))\nmodel.add(Dense(1))\n\nBuild model...\n\n\n2022-05-25 01:28:48.052818: I tensorflow/core/platform/cpu_feature_guard.cc:193] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 FMA\nTo enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.\n\n\n\nmodel.compile(optimizer='adam', loss='mean_squared_error')\nmodel.summary()\n\nModel: \"sequential\"\n\n\n_________________________________________________________________\n\n\n Layer (type)                Output Shape              Param #   \n\n\n=================================================================\n\n\n lstm (LSTM)                 (None, 90, 90)            35640     \n\n\n                                                                 \n\n\n lstm_1 (LSTM)               (None, 90, 50)            28200     \n\n\n                                                                 \n\n\n lstm_2 (LSTM)               (None, 25)                7600      \n\n\n                                                                 \n\n\n dense (Dense)               (None, 5)                 130       \n\n\n                                                                 \n\n\n dense_1 (Dense)             (None, 1)                 6         \n\n\n                                                                 \n\n\n=================================================================\n\n\nTotal params: 71,576\n\n\nTrainable params: 71,576\n\n\nNon-trainable params: 0\n\n\n_________________________________________________________________\n\n\n\n# Training the model\n# fit network\nhistory = model.fit(x_train, \n                    y_train, \n                    batch_size=1000, \n                    epochs=30, \n                    validation_data = (x_test, y_test), \n                    verbose = 0)\n\n\nplt.plot(history.history['loss'], label='train')\nplt.plot(history.history['val_loss'], label='test')\nplt.legend()\nplt.show() \n\n\n\n\n\n# Get the predicted values\npredictions = model.predict(x_test)\npredictions = scaler_pred.inverse_transform(predictions)\n\n1/3 [=========>....................] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - 0s 30ms/step\n\n\n\ny_test = y_test.reshape(-1,1)\ny_test = scaler_pred.inverse_transform(y_test)\n\n\n# Calculate the mean absolute error (MAE)\nmae = mean_absolute_error(y_test, predictions)\nprint('MAE: ' + str(round(mae, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = np.sqrt(mean_squared_error(y_test,predictions))\nprint('RMSE: ' + str(round(rmse, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = mean_squared_error(y_test, \n                          predictions,\n                          squared = False)\nprint('RMSE: ' + str(round(rmse, 1)))\n\nMAE: 738.5\nRMSE: 1169.8\nRMSE: 1169.8\n\n\n\n# Add the difference between the valid and predicted prices\ntrain = data_asturias[:(len(x_train)+92)]\nvalid = data_asturias[(len(x_train)+91):]\n\n\nvalid.insert(1, \"Predictions\", predictions, True)\nvalid.insert(1, \"Difference\", valid[\"Predictions\"] - valid[\"num_casos\"], True)\n\n\n# Zoom-in to a closer timeframe\n# Date from which on the date is displayed\ndisplay_start_date = \"2021-10-31\" \nvalid = valid[valid.index > display_start_date]\ntrain = train[train.index > display_start_date]\n\n\n# Visualize the data\nmatplotlib.style.use('ggplot')\nfig, ax1 = plt.subplots(figsize=(22, 10), sharex=True)\n\n# Data - Train\nxt = train.index; \nyt = train[[\"num_casos\"]]\n# Data - Test / validation \nxv = valid.index; \nyv = valid[[\"num_casos\", \"Predictions\"]]\n\n# Plot\nplt.title(\"Asturias: Predictions vs Real infections\", fontsize=20)\nplt.ylabel(\"Nº Cases\", fontsize=18)\n\nplt.plot(yt, color=\"blue\", linewidth=1.5)\nplt.plot(yv[\"Predictions\"], color=\"red\", linewidth=1.5)\nplt.plot(yv[\"num_casos\"], color=\"green\", linewidth=1.5)\nplt.legend([\"Train\", \"LSTM Predictions\", \"Test\"], \n           loc=\"upper left\", fontsize=18)\n\n# Bar plot with the differences\nx = valid.index\ny = valid[\"Difference\"]\nplt.bar(x, y, width=0.2, color=\"grey\")\nplt.grid()\nplt.show()"
  },
  {
    "objectID": "lstm_multi.html#barcelona",
    "href": "lstm_multi.html#barcelona",
    "title": "LSTM multivariate prediction",
    "section": "Barcelona",
    "text": "Barcelona\n\ndata_barcelona = data_covid.loc[data_covid['provincia'] == 'Barcelona']\ndata_barcelona = data_barcelona.set_index('fecha')\ndata_barcelona = data_barcelona['2020-06-14':]\ndata_barcelona = data_barcelona.filter(['num_casos', 'tmed', 'mob_grocery_pharmacy', \n'mob_parks', 'mob_residential', 'mob_residential', 'mob_transit_stations', 'mob_workplaces'])\ndata_barcelona\n\n\n\n\n\n  \n    \n      \n      num_casos\n      tmed\n      mob_grocery_pharmacy\n      mob_parks\n      mob_residential\n      mob_residential\n      mob_transit_stations\n      mob_workplaces\n    \n    \n      fecha\n      \n      \n      \n      \n      \n      \n      \n      \n    \n  \n  \n    \n      2020-06-14\n      33\n      20.6\n      -20.0\n      15.0\n      6.0\n      6.0\n      -31.0\n      -6.0\n    \n    \n      2020-06-15\n      62\n      21.2\n      -9.0\n      17.0\n      14.0\n      14.0\n      -34.0\n      -41.0\n    \n    \n      2020-06-16\n      66\n      20.8\n      -10.0\n      -16.0\n      16.0\n      16.0\n      -39.0\n      -41.0\n    \n    \n      2020-06-17\n      70\n      20.3\n      -4.0\n      14.0\n      15.0\n      15.0\n      -33.0\n      -40.0\n    \n    \n      2020-06-18\n      68\n      18.8\n      -8.0\n      -6.0\n      16.0\n      16.0\n      -38.0\n      -41.0\n    \n    \n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n    \n    \n      2022-03-25\n      598\n      14.4\n      3.0\n      -11.0\n      4.0\n      4.0\n      -18.0\n      -16.0\n    \n    \n      2022-03-26\n      345\n      12.8\n      -11.0\n      -33.0\n      3.0\n      3.0\n      -22.0\n      -12.0\n    \n    \n      2022-03-27\n      252\n      15.6\n      -10.0\n      -3.0\n      0.0\n      0.0\n      -12.0\n      -10.0\n    \n    \n      2022-03-28\n      688\n      14.0\n      -1.0\n      -2.0\n      4.0\n      4.0\n      -15.0\n      -15.0\n    \n    \n      2022-03-29\n      0\n      13.0\n      0.0\n      -13.0\n      5.0\n      5.0\n      -16.0\n      -17.0\n    \n  \n\n654 rows × 8 columns\n\n\n\n\ndata_barcelona.describe()\n\n\n\n\n\n  \n    \n      \n      num_casos\n      tmed\n      mob_grocery_pharmacy\n      mob_parks\n      mob_residential\n      mob_residential\n      mob_transit_stations\n      mob_workplaces\n    \n  \n  \n    \n      count\n      654.000000\n      654.000000\n      654.000000\n      654.000000\n      654.000000\n      654.000000\n      654.000000\n      654.000000\n    \n    \n      mean\n      2605.048930\n      17.294801\n      0.180428\n      -5.547401\n      7.178899\n      7.178899\n      -24.041284\n      -27.391437\n    \n    \n      std\n      4823.001644\n      6.163636\n      16.568328\n      15.365483\n      5.019727\n      5.019727\n      11.241460\n      15.949374\n    \n    \n      min\n      0.000000\n      4.300000\n      -83.000000\n      -76.000000\n      -6.000000\n      -6.000000\n      -72.000000\n      -87.000000\n    \n    \n      25%\n      597.250000\n      12.200000\n      -7.000000\n      -15.000000\n      4.000000\n      4.000000\n      -32.000000\n      -34.000000\n    \n    \n      50%\n      1030.500000\n      16.300000\n      2.000000\n      -5.000000\n      7.000000\n      7.000000\n      -24.000000\n      -25.000000\n    \n    \n      75%\n      2243.750000\n      23.600000\n      10.000000\n      6.000000\n      10.000000\n      10.000000\n      -15.000000\n      -18.000000\n    \n    \n      max\n      34701.000000\n      28.400000\n      58.000000\n      33.000000\n      32.000000\n      32.000000\n      -2.000000\n      6.000000\n    \n  \n\n\n\n\n\nnp_data_barcelona = data_barcelona.values\n\n\n# Train dataset\nscaler = MinMaxScaler(feature_range=(0, 1))\nscaled_data_barcelona = scaler.fit_transform(np_data_barcelona)\nprint(f'Longitud del conjunto de datos disponible: {len(scaled_data_barcelona)}')\n\nLongitud del conjunto de datos disponible: 654\n\n\n\n# Since we are going to predict future values based on the 90 past elements, \n# we need to create a list with those historic information for each element\nhistoric_values = 90\nscaled_data_barcelona_x = []\nscaled_data_barcelona_y = []\n\nfor i in range(historic_values, len(scaled_data_barcelona)):\n    scaled_data_barcelona_x.append(scaled_data_barcelona[(i-historic_values):i, :])\n    scaled_data_barcelona_y.append(scaled_data_barcelona[i, 0])\n\n# Convert the x_train and y_train to numpy arrays\nscaled_data_barcelona_x = np.array(scaled_data_barcelona_x)\nscaled_data_barcelona_y = np.array(scaled_data_barcelona_y)\n\n\n# Once predicted, we are going to need a exclusive scaler for num_cases\nscaler_pred = MinMaxScaler(feature_range=(0, 1))\ndf_cases_barcelona = pd.DataFrame(data_barcelona['num_casos'])\nscaled_data_barcelona_pred = scaler_pred.fit_transform(df_cases_barcelona)\n\n\n# Since the first 90th values does not have historic, the dataset has been reduced in 90 values\nprint(f'Longitud datos de entrenamiento con historico: {len(scaled_data_barcelona_y)}')\n\nLongitud datos de entrenamiento con historico: 564\n\n\n\n# we split data in train and test\n# as in previous analysis, we are going to predict a maximum of 90 days\nx_train = scaled_data_barcelona_x[0:len(scaled_data_barcelona_x)-91]\ny_train = scaled_data_barcelona_y[0:len(scaled_data_barcelona_y)-91]\nprint(f'Cantidad datos de entrenamiento: x={len(x_train)} - y={len(y_train)}')\n\nx_test = scaled_data_barcelona_x[len(scaled_data_barcelona_x)-90:len(scaled_data_barcelona_x)]\ny_test = scaled_data_barcelona_y[len(scaled_data_barcelona_y)-90:len(scaled_data_barcelona_y)]\nprint(f'Cantidad datos de test: x={len(x_test)} - y={len(y_test)}')\n\nCantidad datos de entrenamiento: x=473 - y=473\nCantidad datos de test: x=90 - y=90\n\n\n\n# Reshape the data to feed de recurrent network\nx_train = np.reshape(x_train, (x_train.shape[0], x_train.shape[1], 8))\nprint(\"Train data shape:\")\nprint(x_train.shape)\nprint(y_train.shape)\nx_test = np.reshape(x_test, (x_test.shape[0], x_test.shape[1], 8))\nprint(\"Test data shape:\")\nprint(x_test.shape)\nprint(y_test.shape)\n\nTrain data shape:\n(473, 90, 8)\n(473,)\nTest data shape:\n(90, 90, 8)\n(90,)\n\n\n\n# Configure / setup the neural network model - LSTM\n# Build the model\nprint('Build model...')\nmodel = Sequential()\n# Model with Neurons \n# Inputshape = neurons -> Timestamps\nneurons= x_train.shape[1]\nmodel.add(LSTM(90, \n               activation = 'relu',\n               return_sequences = True, \n               input_shape = (x_train.shape[1], 8))) \nmodel.add(LSTM(50, \n               activation = 'relu',\n               return_sequences = True)) \nmodel.add(LSTM(25, \n               activation = 'relu',\n               return_sequences = False)) \nmodel.add(Dense(5, activation = 'relu'))\nmodel.add(Dense(1))\n\nBuild model...\n\n\n\nmodel.compile(optimizer='adam', loss='mean_squared_error')\nmodel.summary()\n\nModel: \"sequential_1\"\n\n\n_________________________________________________________________\n\n\n Layer (type)                Output Shape              Param #   \n\n\n=================================================================\n\n\n lstm_3 (LSTM)               (None, 90, 90)            35640     \n\n\n                                                                 \n\n\n lstm_4 (LSTM)               (None, 90, 50)            28200     \n\n\n                                                                 \n\n\n lstm_5 (LSTM)               (None, 25)                7600      \n\n\n                                                                 \n\n\n dense_2 (Dense)             (None, 5)                 130       \n\n\n                                                                 \n\n\n dense_3 (Dense)             (None, 1)                 6         \n\n\n                                                                 \n\n\n=================================================================\n\n\nTotal params: 71,576\n\n\nTrainable params: 71,576\n\n\nNon-trainable params: 0\n\n\n_________________________________________________________________\n\n\n\n# Training the model\n# fit network\nhistory = model.fit(x_train, \n                    y_train, \n                    batch_size=1000, \n                    epochs=30, \n                    validation_data = (x_test, y_test), \n                    verbose = 0)\n\n\nplt.plot(history.history['loss'], label='train')\nplt.plot(history.history['val_loss'], label='test')\nplt.legend()\nplt.show() \n\n\n\n\n\n# Get the predicted values\npredictions = model.predict(x_test)\npredictions = scaler_pred.inverse_transform(predictions)\n\n1/3 [=========>....................] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - 0s 31ms/step\n\n\n\ny_test = y_test.reshape(-1,1)\ny_test = scaler_pred.inverse_transform(y_test)\n\n\n# Calculate the mean absolute error (MAE)\nmae = mean_absolute_error(y_test, predictions)\nprint('MAE: ' + str(round(mae, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = np.sqrt(mean_squared_error(y_test,predictions))\nprint('RMSE: ' + str(round(rmse, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = mean_squared_error(y_test, \n                          predictions,\n                          squared = False)\nprint('RMSE: ' + str(round(rmse, 1)))\n\nMAE: 6872.2\nRMSE: 11041.0\nRMSE: 11041.0\n\n\n\n# Add the difference between the valid and predicted prices\ntrain = data_barcelona[:(len(x_train)+92)]\nvalid = data_barcelona[(len(x_train)+91):]\n\n\nvalid.insert(1, \"Predictions\", predictions, True)\nvalid.insert(1, \"Difference\", valid[\"Predictions\"] - valid[\"num_casos\"], True)\n\n\n# Zoom-in to a closer timeframe\n# Date from which on the date is displayed\ndisplay_start_date = \"2021-10-31\" \nvalid = valid[valid.index > display_start_date]\ntrain = train[train.index > display_start_date]\n\n\n# Visualize the data\nmatplotlib.style.use('ggplot')\nfig, ax1 = plt.subplots(figsize=(22, 10), sharex=True)\n\n# Data - Train\nxt = train.index; \nyt = train[[\"num_casos\"]]\n# Data - Test / validation \nxv = valid.index; \nyv = valid[[\"num_casos\", \"Predictions\"]]\n\n# Plot\nplt.title(\"barcelona: Predictions vs Real infections\", fontsize=20)\nplt.ylabel(\"Nº Cases\", fontsize=18)\n\nplt.plot(yt, color=\"blue\", linewidth=1.5)\nplt.plot(yv[\"Predictions\"], color=\"red\", linewidth=1.5)\nplt.plot(yv[\"num_casos\"], color=\"green\", linewidth=1.5)\nplt.legend([\"Train\", \"LSTM Predictions\", \"Test\"], \n           loc=\"upper left\", fontsize=18)\n\n# Bar plot with the differences\nx = valid.index\ny = valid[\"Difference\"]\nplt.bar(x, y, width=0.2, color=\"grey\")\nplt.grid()\nplt.show()"
  },
  {
    "objectID": "lstm_multi.html#madrid",
    "href": "lstm_multi.html#madrid",
    "title": "LSTM multivariate prediction",
    "section": "Madrid",
    "text": "Madrid\n\ndata_madrid = data_covid.loc[data_covid['provincia'] == 'Madrid']\ndata_madrid = data_madrid.set_index('fecha')\ndata_madrid = data_madrid['2020-06-14':]\ndata_madrid = data_madrid.filter(['num_casos', 'tmed', 'mob_grocery_pharmacy', \n'mob_parks', 'mob_residential', 'mob_residential', 'mob_transit_stations', 'mob_workplaces'])\ndata_madrid\n\n\n\n\n\n  \n    \n      \n      num_casos\n      tmed\n      mob_grocery_pharmacy\n      mob_parks\n      mob_residential\n      mob_residential\n      mob_transit_stations\n      mob_workplaces\n    \n    \n      fecha\n      \n      \n      \n      \n      \n      \n      \n      \n    \n  \n  \n    \n      2020-06-14\n      81\n      19.0\n      -15.0\n      25.0\n      7.0\n      7.0\n      -43.0\n      -6.0\n    \n    \n      2020-06-15\n      153\n      20.7\n      -8.0\n      34.0\n      16.0\n      16.0\n      -43.0\n      -47.0\n    \n    \n      2020-06-16\n      91\n      21.0\n      -8.0\n      21.0\n      17.0\n      17.0\n      -43.0\n      -47.0\n    \n    \n      2020-06-17\n      93\n      20.2\n      -5.0\n      34.0\n      17.0\n      17.0\n      -42.0\n      -47.0\n    \n    \n      2020-06-18\n      85\n      21.9\n      -7.0\n      30.0\n      16.0\n      16.0\n      -44.0\n      -47.0\n    \n    \n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n    \n    \n      2022-03-25\n      356\n      11.0\n      -1.0\n      -37.0\n      5.0\n      5.0\n      -19.0\n      -17.0\n    \n    \n      2022-03-26\n      303\n      10.4\n      -7.0\n      -27.0\n      1.0\n      1.0\n      -15.0\n      -5.0\n    \n    \n      2022-03-27\n      77\n      10.6\n      -3.0\n      -17.0\n      0.0\n      0.0\n      -17.0\n      -2.0\n    \n    \n      2022-03-28\n      839\n      10.2\n      2.0\n      -3.0\n      4.0\n      4.0\n      -15.0\n      -17.0\n    \n    \n      2022-03-29\n      6\n      13.0\n      1.0\n      -11.0\n      4.0\n      4.0\n      -16.0\n      -16.0\n    \n  \n\n654 rows × 8 columns\n\n\n\n\ndata_madrid.describe()\n\n\n\n\n\n  \n    \n      \n      num_casos\n      tmed\n      mob_grocery_pharmacy\n      mob_parks\n      mob_residential\n      mob_residential\n      mob_transit_stations\n      mob_workplaces\n    \n  \n  \n    \n      count\n      654.000000\n      654.000000\n      654.000000\n      654.000000\n      654.000000\n      654.000000\n      654.000000\n      654.000000\n    \n    \n      mean\n      2392.562691\n      14.909786\n      -2.608563\n      -4.874618\n      6.978593\n      6.978593\n      -30.003058\n      -27.324159\n    \n    \n      std\n      3390.272836\n      8.073496\n      15.108581\n      20.826186\n      5.672763\n      5.672763\n      12.389295\n      18.988563\n    \n    \n      min\n      6.000000\n      -6.200000\n      -84.000000\n      -62.000000\n      -6.000000\n      -6.000000\n      -73.000000\n      -86.000000\n    \n    \n      25%\n      662.750000\n      8.600000\n      -9.000000\n      -17.750000\n      4.000000\n      4.000000\n      -39.000000\n      -40.000000\n    \n    \n      50%\n      1413.000000\n      13.200000\n      -1.000000\n      -4.000000\n      7.000000\n      7.000000\n      -31.000000\n      -26.000000\n    \n    \n      75%\n      2475.750000\n      21.800000\n      8.000000\n      11.000000\n      10.000000\n      10.000000\n      -21.000000\n      -16.000000\n    \n    \n      max\n      23811.000000\n      32.700000\n      50.000000\n      77.000000\n      31.000000\n      31.000000\n      1.000000\n      20.000000\n    \n  \n\n\n\n\n\nnp_data_madrid = data_madrid.values\n\n\n# Train dataset\nscaler = MinMaxScaler(feature_range=(0, 1))\nscaled_data_madrid = scaler.fit_transform(np_data_madrid)\nprint(f'Longitud del conjunto de datos disponible: {len(scaled_data_madrid)}')\n\nLongitud del conjunto de datos disponible: 654\n\n\n\n# Since we are going to predict future values based on the 90 past elements, \n# we need to create a list with those historic information for each element\nhistoric_values = 90\nscaled_data_madrid_x = []\nscaled_data_madrid_y = []\n\nfor i in range(historic_values, len(scaled_data_madrid)):\n    scaled_data_madrid_x.append(scaled_data_madrid[(i-historic_values):i, :])\n    scaled_data_madrid_y.append(scaled_data_madrid[i, 0])\n\n# Convert the x_train and y_train to numpy arrays\nscaled_data_madrid_x = np.array(scaled_data_madrid_x)\nscaled_data_madrid_y = np.array(scaled_data_madrid_y)\n\n\n# Once predicted, we are going to need a exclusive scaler for num_cases\nscaler_pred = MinMaxScaler(feature_range=(0, 1))\ndf_cases_madrid = pd.DataFrame(data_madrid['num_casos'])\nscaled_data_madrid_pred = scaler_pred.fit_transform(df_cases_madrid)\n\n\n# Since the first 90th values does not have historic, the dataset has been reduced in 90 values\nprint(f'Longitud datos de entrenamiento con historico: {len(scaled_data_madrid_y)}')\n\nLongitud datos de entrenamiento con historico: 564\n\n\n\n# we split data in train and test\n# as in previous analysis, we are going to predict a maximum of 90 days\nx_train = scaled_data_madrid_x[0:len(scaled_data_madrid_x)-91]\ny_train = scaled_data_madrid_y[0:len(scaled_data_madrid_y)-91]\nprint(f'Cantidad datos de entrenamiento: x={len(x_train)} - y={len(y_train)}')\n\nx_test = scaled_data_madrid_x[len(scaled_data_madrid_x)-90:len(scaled_data_madrid_x)]\ny_test = scaled_data_madrid_y[len(scaled_data_madrid_y)-90:len(scaled_data_madrid_y)]\nprint(f'Cantidad datos de test: x={len(x_test)} - y={len(y_test)}')\n\nCantidad datos de entrenamiento: x=473 - y=473\nCantidad datos de test: x=90 - y=90\n\n\n\n# Reshape the data to feed de recurrent network\nx_train = np.reshape(x_train, (x_train.shape[0], x_train.shape[1], 8))\nprint(\"Train data shape:\")\nprint(x_train.shape)\nprint(y_train.shape)\nx_test = np.reshape(x_test, (x_test.shape[0], x_test.shape[1], 8))\nprint(\"Test data shape:\")\nprint(x_test.shape)\nprint(y_test.shape)\n\nTrain data shape:\n(473, 90, 8)\n(473,)\nTest data shape:\n(90, 90, 8)\n(90,)\n\n\n\n# Configure / setup the neural network model - LSTM\n# Build the model\nprint('Build model...')\nmodel = Sequential()\n# Model with Neurons \n# Inputshape = neurons -> Timestamps\nneurons= x_train.shape[1]\nmodel.add(LSTM(90, \n               activation = 'relu',\n               return_sequences = True, \n               input_shape = (x_train.shape[1], 8))) \nmodel.add(LSTM(50, \n               activation = 'relu',\n               return_sequences = True)) \nmodel.add(LSTM(25, \n               activation = 'relu',\n               return_sequences = False)) \nmodel.add(Dense(5, activation = 'relu'))\nmodel.add(Dense(1))\n\nBuild model...\n\n\n\nmodel.compile(optimizer='adam', loss='mean_squared_error')\nmodel.summary()\n\nModel: \"sequential_2\"\n\n\n_________________________________________________________________\n\n\n Layer (type)                Output Shape              Param #   \n\n\n=================================================================\n\n\n lstm_6 (LSTM)               (None, 90, 90)            35640     \n\n\n                                                                 \n\n\n lstm_7 (LSTM)               (None, 90, 50)            28200     \n\n\n                                                                 \n\n\n lstm_8 (LSTM)               (None, 25)                7600      \n\n\n                                                                 \n\n\n dense_4 (Dense)             (None, 5)                 130       \n\n\n                                                                 \n\n\n dense_5 (Dense)             (None, 1)                 6         \n\n\n                                                                 \n\n\n=================================================================\n\n\nTotal params: 71,576\n\n\nTrainable params: 71,576\n\n\nNon-trainable params: 0\n\n\n_________________________________________________________________\n\n\n\n# Training the model\n# fit network\nhistory = model.fit(x_train, \n                    y_train, \n                    batch_size=1000, \n                    epochs=30, \n                    validation_data = (x_test, y_test), \n                    verbose = 0)\n\n\nplt.plot(history.history['loss'], label='train')\nplt.plot(history.history['val_loss'], label='test')\nplt.legend()\nplt.show() \n\n\n\n\n\n# Get the predicted values\npredictions = model.predict(x_test)\npredictions = scaler_pred.inverse_transform(predictions)\n\n1/3 [=========>....................] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - 0s 30ms/step\n\n\n\ny_test = y_test.reshape(-1,1)\ny_test = scaler_pred.inverse_transform(y_test)\n\n\n# Calculate the mean absolute error (MAE)\nmae = mean_absolute_error(y_test, predictions)\nprint('MAE: ' + str(round(mae, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = np.sqrt(mean_squared_error(y_test,predictions))\nprint('RMSE: ' + str(round(rmse, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = mean_squared_error(y_test, \n                          predictions,\n                          squared = False)\nprint('RMSE: ' + str(round(rmse, 1)))\n\nMAE: 4531.8\nRMSE: 7047.1\nRMSE: 7047.1\n\n\n\n# Add the difference between the valid and predicted prices\ntrain = data_madrid[:(len(x_train)+92)]\nvalid = data_madrid[(len(x_train)+91):]\n\n\nvalid.insert(1, \"Predictions\", predictions, True)\nvalid.insert(1, \"Difference\", valid[\"Predictions\"] - valid[\"num_casos\"], True)\n\n\n# Zoom-in to a closer timeframe\n# Date from which on the date is displayed\ndisplay_start_date = \"2021-10-31\" \nvalid = valid[valid.index > display_start_date]\ntrain = train[train.index > display_start_date]\n\n\n# Visualize the data\nmatplotlib.style.use('ggplot')\nfig, ax1 = plt.subplots(figsize=(22, 10), sharex=True)\n\n# Data - Train\nxt = train.index; \nyt = train[[\"num_casos\"]]\n# Data - Test / validation \nxv = valid.index; \nyv = valid[[\"num_casos\", \"Predictions\"]]\n\n# Plot\nplt.title(\"madrid: Predictions vs Real infections\", fontsize=20)\nplt.ylabel(\"Nº Cases\", fontsize=18)\n\nplt.plot(yt, color=\"blue\", linewidth=1.5)\nplt.plot(yv[\"Predictions\"], color=\"red\", linewidth=1.5)\nplt.plot(yv[\"num_casos\"], color=\"green\", linewidth=1.5)\nplt.legend([\"Train\", \"LSTM Predictions\", \"Test\"], \n           loc=\"upper left\", fontsize=18)\n\n# Bar plot with the differences\nx = valid.index\ny = valid[\"Difference\"]\nplt.bar(x, y, width=0.2, color=\"grey\")\nplt.grid()\nplt.show()"
  },
  {
    "objectID": "lstm_multi.html#málaga",
    "href": "lstm_multi.html#málaga",
    "title": "LSTM multivariate prediction",
    "section": "Málaga",
    "text": "Málaga\n\ndata_malaga = data_covid.loc[data_covid['provincia'] == 'Málaga']\ndata_malaga = data_malaga.set_index('fecha')\ndata_malaga = data_malaga['2020-06-14':]\ndata_malaga = data_malaga.filter(['num_casos', 'tmed', 'mob_grocery_pharmacy', \n'mob_parks', 'mob_residential', 'mob_residential', 'mob_transit_stations', 'mob_workplaces'])\ndata_malaga\n\n\n\n\n\n  \n    \n      \n      num_casos\n      tmed\n      mob_grocery_pharmacy\n      mob_parks\n      mob_residential\n      mob_residential\n      mob_transit_stations\n      mob_workplaces\n    \n    \n      fecha\n      \n      \n      \n      \n      \n      \n      \n      \n    \n  \n  \n    \n      2020-06-14\n      2\n      26.6\n      -20.0\n      -15.0\n      2.0\n      2.0\n      -53.0\n      -7.0\n    \n    \n      2020-06-15\n      1\n      27.2\n      -16.0\n      -9.0\n      9.0\n      9.0\n      -44.0\n      -33.0\n    \n    \n      2020-06-16\n      1\n      27.8\n      -13.0\n      -4.0\n      9.0\n      9.0\n      -40.0\n      -33.0\n    \n    \n      2020-06-17\n      2\n      26.9\n      -13.0\n      1.0\n      9.0\n      9.0\n      -41.0\n      -33.0\n    \n    \n      2020-06-18\n      2\n      21.6\n      -12.0\n      3.0\n      9.0\n      9.0\n      -42.0\n      -33.0\n    \n    \n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n    \n    \n      2022-03-25\n      565\n      13.8\n      -3.0\n      -32.0\n      8.0\n      8.0\n      -18.0\n      -12.0\n    \n    \n      2022-03-26\n      79\n      14.5\n      -1.0\n      -1.0\n      3.0\n      3.0\n      -13.0\n      -4.0\n    \n    \n      2022-03-27\n      65\n      15.4\n      5.0\n      -18.0\n      2.0\n      2.0\n      0.0\n      0.0\n    \n    \n      2022-03-28\n      39\n      16.3\n      6.0\n      -4.0\n      3.0\n      3.0\n      -4.0\n      -7.0\n    \n    \n      2022-03-29\n      0\n      16.8\n      4.0\n      -3.0\n      4.0\n      4.0\n      1.0\n      -8.0\n    \n  \n\n654 rows × 8 columns\n\n\n\n\ndata_malaga.describe()\n\n\n\n\n\n  \n    \n      \n      num_casos\n      tmed\n      mob_grocery_pharmacy\n      mob_parks\n      mob_residential\n      mob_residential\n      mob_transit_stations\n      mob_workplaces\n    \n  \n  \n    \n      count\n      654.000000\n      654.000000\n      654.000000\n      654.000000\n      654.000000\n      654.000000\n      654.000000\n      654.00000\n    \n    \n      mean\n      410.206422\n      19.511162\n      8.776758\n      13.570336\n      4.529052\n      4.529052\n      -18.853211\n      -18.04893\n    \n    \n      std\n      489.452348\n      5.721942\n      26.696909\n      39.148014\n      4.064365\n      4.064365\n      18.183256\n      14.55877\n    \n    \n      min\n      0.000000\n      6.200000\n      -80.000000\n      -63.000000\n      -4.000000\n      -4.000000\n      -70.000000\n      -79.00000\n    \n    \n      25%\n      122.250000\n      14.725000\n      -4.000000\n      -13.000000\n      2.000000\n      2.000000\n      -32.000000\n      -26.00000\n    \n    \n      50%\n      215.500000\n      18.400000\n      6.000000\n      5.000000\n      4.000000\n      4.000000\n      -21.000000\n      -17.00000\n    \n    \n      75%\n      475.250000\n      24.500000\n      15.000000\n      30.000000\n      6.750000\n      6.750000\n      -4.000000\n      -11.00000\n    \n    \n      max\n      3080.000000\n      34.500000\n      156.000000\n      152.000000\n      22.000000\n      22.000000\n      20.000000\n      29.00000\n    \n  \n\n\n\n\n\nnp_data_malaga = data_malaga.values\n\n\n# Train dataset\nscaler = MinMaxScaler(feature_range=(0, 1))\nscaled_data_malaga = scaler.fit_transform(np_data_malaga)\nprint(f'Longitud del conjunto de datos disponible: {len(scaled_data_malaga)}')\n\nLongitud del conjunto de datos disponible: 654\n\n\n\n# Since we are going to predict future values based on the 90 past elements, \n# we need to create a list with those historic information for each element\nhistoric_values = 90\nscaled_data_malaga_x = []\nscaled_data_malaga_y = []\n\nfor i in range(historic_values, len(scaled_data_malaga)):\n    scaled_data_malaga_x.append(scaled_data_malaga[(i-historic_values):i, :])\n    scaled_data_malaga_y.append(scaled_data_malaga[i, 0])\n\n# Convert the x_train and y_train to numpy arrays\nscaled_data_malaga_x = np.array(scaled_data_malaga_x)\nscaled_data_malaga_y = np.array(scaled_data_malaga_y)\n\n\n# Once predicted, we are going to need a exclusive scaler for num_cases\nscaler_pred = MinMaxScaler(feature_range=(0, 1))\ndf_cases_malaga = pd.DataFrame(data_malaga['num_casos'])\nscaled_data_malaga_pred = scaler_pred.fit_transform(df_cases_malaga)\n\n\n# Since the first 90th values does not have historic, the dataset has been reduced in 90 values\nprint(f'Longitud datos de entrenamiento con historico: {len(scaled_data_malaga_y)}')\n\nLongitud datos de entrenamiento con historico: 564\n\n\n\n# we split data in train and test\n# as in previous analysis, we are going to predict a maximum of 90 days\nx_train = scaled_data_malaga_x[0:len(scaled_data_malaga_x)-91]\ny_train = scaled_data_malaga_y[0:len(scaled_data_malaga_y)-91]\nprint(f'Cantidad datos de entrenamiento: x={len(x_train)} - y={len(y_train)}')\n\nx_test = scaled_data_malaga_x[len(scaled_data_malaga_x)-90:len(scaled_data_malaga_x)]\ny_test = scaled_data_malaga_y[len(scaled_data_malaga_y)-90:len(scaled_data_malaga_y)]\nprint(f'Cantidad datos de test: x={len(x_test)} - y={len(y_test)}')\n\nCantidad datos de entrenamiento: x=473 - y=473\nCantidad datos de test: x=90 - y=90\n\n\n\n# Reshape the data to feed de recurrent network\nx_train = np.reshape(x_train, (x_train.shape[0], x_train.shape[1], 8))\nprint(\"Train data shape:\")\nprint(x_train.shape)\nprint(y_train.shape)\nx_test = np.reshape(x_test, (x_test.shape[0], x_test.shape[1], 8))\nprint(\"Test data shape:\")\nprint(x_test.shape)\nprint(y_test.shape)\n\nTrain data shape:\n(473, 90, 8)\n(473,)\nTest data shape:\n(90, 90, 8)\n(90,)\n\n\n\n# Configure / setup the neural network model - LSTM\n# Build the model\nprint('Build model...')\nmodel = Sequential()\n# Model with Neurons \n# Inputshape = neurons -> Timestamps\nneurons= x_train.shape[1]\nmodel.add(LSTM(90, \n               activation = 'relu',\n               return_sequences = True, \n               input_shape = (x_train.shape[1], 8))) \nmodel.add(LSTM(50, \n               activation = 'relu',\n               return_sequences = True)) \nmodel.add(LSTM(25, \n               activation = 'relu',\n               return_sequences = False)) \nmodel.add(Dense(5, activation = 'relu'))\nmodel.add(Dense(1))\n\nBuild model...\n\n\n\nmodel.compile(optimizer='adam', loss='mean_squared_error')\nmodel.summary()\n\nModel: \"sequential_3\"\n\n\n_________________________________________________________________\n\n\n Layer (type)                Output Shape              Param #   \n\n\n=================================================================\n\n\n lstm_9 (LSTM)               (None, 90, 90)            35640     \n\n\n                                                                 \n\n\n lstm_10 (LSTM)              (None, 90, 50)            28200     \n\n\n                                                                 \n\n\n lstm_11 (LSTM)              (None, 25)                7600      \n\n\n                                                                 \n\n\n dense_6 (Dense)             (None, 5)                 130       \n\n\n                                                                 \n\n\n dense_7 (Dense)             (None, 1)                 6         \n\n\n                                                                 \n\n\n=================================================================\n\n\nTotal params: 71,576\n\n\nTrainable params: 71,576\n\n\nNon-trainable params: 0\n\n\n_________________________________________________________________\n\n\n\n# Training the model\n# fit network\nhistory = model.fit(x_train, \n                    y_train, \n                    batch_size=1000, \n                    epochs=30, \n                    validation_data = (x_test, y_test), \n                    verbose = 0)\n\n\nplt.plot(history.history['loss'], label='train')\nplt.plot(history.history['val_loss'], label='test')\nplt.legend()\nplt.show() \n\n\n\n\n\n# Get the predicted values\npredictions = model.predict(x_test)\npredictions = scaler_pred.inverse_transform(predictions)\n\n1/3 [=========>....................] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - 0s 31ms/step\n\n\n\ny_test = y_test.reshape(-1,1)\ny_test = scaler_pred.inverse_transform(y_test)\n\n\n# Calculate the mean absolute error (MAE)\nmae = mean_absolute_error(y_test, predictions)\nprint('MAE: ' + str(round(mae, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = np.sqrt(mean_squared_error(y_test,predictions))\nprint('RMSE: ' + str(round(rmse, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = mean_squared_error(y_test, \n                          predictions,\n                          squared = False)\nprint('RMSE: ' + str(round(rmse, 1)))\n\nMAE: 322.4\nRMSE: 508.6\nRMSE: 508.6\n\n\n\n# Add the difference between the valid and predicted prices\ntrain = data_malaga[:(len(x_train)+92)]\nvalid = data_malaga[(len(x_train)+91):]\n\n\nvalid.insert(1, \"Predictions\", predictions, True)\nvalid.insert(1, \"Difference\", valid[\"Predictions\"] - valid[\"num_casos\"], True)\n\n\n# Zoom-in to a closer timeframe\n# Date from which on the date is displayed\ndisplay_start_date = \"2021-10-31\" \nvalid = valid[valid.index > display_start_date]\ntrain = train[train.index > display_start_date]\n\n\n# Visualize the data\nmatplotlib.style.use('ggplot')\nfig, ax1 = plt.subplots(figsize=(22, 10), sharex=True)\n\n# Data - Train\nxt = train.index; \nyt = train[[\"num_casos\"]]\n# Data - Test / validation \nxv = valid.index; \nyv = valid[[\"num_casos\", \"Predictions\"]]\n\n# Plot\nplt.title(\"malaga: Predictions vs Real infections\", fontsize=20)\nplt.ylabel(\"Nº Cases\", fontsize=18)\n\nplt.plot(yt, color=\"blue\", linewidth=1.5)\nplt.plot(yv[\"Predictions\"], color=\"red\", linewidth=1.5)\nplt.plot(yv[\"num_casos\"], color=\"green\", linewidth=1.5)\nplt.legend([\"Train\", \"LSTM Predictions\", \"Test\"], \n           loc=\"upper left\", fontsize=18)\n\n# Bar plot with the differences\nx = valid.index\ny = valid[\"Difference\"]\nplt.bar(x, y, width=0.2, color=\"grey\")\nplt.grid()\nplt.show()"
  },
  {
    "objectID": "lstm_multi.html#sevilla",
    "href": "lstm_multi.html#sevilla",
    "title": "LSTM multivariate prediction",
    "section": "Sevilla",
    "text": "Sevilla\n\ndata_sevilla = data_covid.loc[data_covid['provincia'] == 'Sevilla']\ndata_sevilla = data_sevilla.set_index('fecha')\ndata_sevilla = data_sevilla['2020-06-14':]\ndata_sevilla = data_sevilla.filter(['num_casos', 'tmed', 'mob_grocery_pharmacy', \n'mob_parks', 'mob_residential', 'mob_residential', 'mob_transit_stations', 'mob_workplaces'])\ndata_sevilla\n\n\n\n\n\n  \n    \n      \n      num_casos\n      tmed\n      mob_grocery_pharmacy\n      mob_parks\n      mob_residential\n      mob_residential\n      mob_transit_stations\n      mob_workplaces\n    \n    \n      fecha\n      \n      \n      \n      \n      \n      \n      \n      \n    \n  \n  \n    \n      2020-06-14\n      0\n      22.200000\n      -24.0\n      -36.0\n      0.0\n      0.0\n      -51.0\n      0.0\n    \n    \n      2020-06-15\n      2\n      23.088889\n      -14.0\n      -13.0\n      9.0\n      9.0\n      -41.0\n      -33.0\n    \n    \n      2020-06-16\n      1\n      23.977778\n      -10.0\n      -4.0\n      9.0\n      9.0\n      -37.0\n      -32.0\n    \n    \n      2020-06-17\n      0\n      24.866667\n      -10.0\n      -7.0\n      9.0\n      9.0\n      -37.0\n      -32.0\n    \n    \n      2020-06-18\n      0\n      25.755556\n      -12.0\n      -13.0\n      9.0\n      9.0\n      -41.0\n      -33.0\n    \n    \n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n    \n    \n      2022-03-25\n      365\n      14.100000\n      2.0\n      -20.0\n      4.0\n      4.0\n      -14.0\n      -7.0\n    \n    \n      2022-03-26\n      67\n      15.200000\n      -9.0\n      2.0\n      0.0\n      0.0\n      -12.0\n      -5.0\n    \n    \n      2022-03-27\n      24\n      15.900000\n      2.0\n      -13.0\n      -1.0\n      -1.0\n      -10.0\n      -7.0\n    \n    \n      2022-03-28\n      12\n      17.100000\n      2.0\n      -5.0\n      2.0\n      2.0\n      -10.0\n      -6.0\n    \n    \n      2022-03-29\n      0\n      16.000000\n      3.0\n      -7.0\n      2.0\n      2.0\n      -13.0\n      -5.0\n    \n  \n\n654 rows × 8 columns\n\n\n\n\ndata_sevilla.describe()\n\n\n\n\n\n  \n    \n      \n      num_casos\n      tmed\n      mob_grocery_pharmacy\n      mob_parks\n      mob_residential\n      mob_residential\n      mob_transit_stations\n      mob_workplaces\n    \n  \n  \n    \n      count\n      654.000000\n      654.000000\n      654.000000\n      654.000000\n      654.000000\n      654.000000\n      654.000000\n      654.000000\n    \n    \n      mean\n      432.978593\n      19.663609\n      -0.709480\n      -14.958716\n      3.915902\n      3.915902\n      -25.707951\n      -20.347095\n    \n    \n      std\n      500.618517\n      6.949955\n      18.851349\n      17.982375\n      4.397963\n      4.397963\n      14.307026\n      14.434846\n    \n    \n      min\n      0.000000\n      5.500000\n      -79.000000\n      -70.000000\n      -7.000000\n      -7.000000\n      -71.000000\n      -79.000000\n    \n    \n      25%\n      127.250000\n      13.800000\n      -8.000000\n      -27.000000\n      1.000000\n      1.000000\n      -36.000000\n      -29.000000\n    \n    \n      50%\n      282.000000\n      18.600000\n      0.000000\n      -13.000000\n      4.000000\n      4.000000\n      -26.000000\n      -17.000000\n    \n    \n      75%\n      528.250000\n      25.600000\n      7.000000\n      -4.000000\n      6.000000\n      6.000000\n      -15.000000\n      -10.000000\n    \n    \n      max\n      3692.000000\n      34.400000\n      117.000000\n      61.000000\n      22.000000\n      22.000000\n      16.000000\n      9.000000\n    \n  \n\n\n\n\n\nnp_data_sevilla = data_sevilla.values\n\n\n# Train dataset\nscaler = MinMaxScaler(feature_range=(0, 1))\nscaled_data_sevilla = scaler.fit_transform(np_data_sevilla)\nprint(f'Longitud del conjunto de datos disponible: {len(scaled_data_sevilla)}')\n\nLongitud del conjunto de datos disponible: 654\n\n\n\n# Since we are going to predict future values based on the 90 past elements, \n# we need to create a list with those historic information for each element\nhistoric_values = 90\nscaled_data_sevilla_x = []\nscaled_data_sevilla_y = []\n\nfor i in range(historic_values, len(scaled_data_sevilla)):\n    scaled_data_sevilla_x.append(scaled_data_sevilla[(i-historic_values):i, :])\n    scaled_data_sevilla_y.append(scaled_data_sevilla[i, 0])\n\n# Convert the x_train and y_train to numpy arrays\nscaled_data_sevilla_x = np.array(scaled_data_sevilla_x)\nscaled_data_sevilla_y = np.array(scaled_data_sevilla_y)\n\n\n# Once predicted, we are going to need a exclusive scaler for num_cases\nscaler_pred = MinMaxScaler(feature_range=(0, 1))\ndf_cases_sevilla = pd.DataFrame(data_sevilla['num_casos'])\nscaled_data_sevilla_pred = scaler_pred.fit_transform(df_cases_sevilla)\n\n\n# Since the first 90th values does not have historic, the dataset has been reduced in 90 values\nprint(f'Longitud datos de entrenamiento con historico: {len(scaled_data_sevilla_y)}')\n\nLongitud datos de entrenamiento con historico: 564\n\n\n\n# we split data in train and test\n# as in previous analysis, we are going to predict a maximum of 90 days\nx_train = scaled_data_sevilla_x[0:len(scaled_data_sevilla_x)-91]\ny_train = scaled_data_sevilla_y[0:len(scaled_data_sevilla_y)-91]\nprint(f'Cantidad datos de entrenamiento: x={len(x_train)} - y={len(y_train)}')\n\nx_test = scaled_data_sevilla_x[len(scaled_data_sevilla_x)-90:len(scaled_data_sevilla_x)]\ny_test = scaled_data_sevilla_y[len(scaled_data_sevilla_y)-90:len(scaled_data_sevilla_y)]\nprint(f'Cantidad datos de test: x={len(x_test)} - y={len(y_test)}')\n\nCantidad datos de entrenamiento: x=473 - y=473\nCantidad datos de test: x=90 - y=90\n\n\n\n# Reshape the data to feed de recurrent network\nx_train = np.reshape(x_train, (x_train.shape[0], x_train.shape[1], 8))\nprint(\"Train data shape:\")\nprint(x_train.shape)\nprint(y_train.shape)\nx_test = np.reshape(x_test, (x_test.shape[0], x_test.shape[1], 8))\nprint(\"Test data shape:\")\nprint(x_test.shape)\nprint(y_test.shape)\n\nTrain data shape:\n(473, 90, 8)\n(473,)\nTest data shape:\n(90, 90, 8)\n(90,)\n\n\n\n# Configure / setup the neural network model - LSTM\n# Build the model\nprint('Build model...')\nmodel = Sequential()\n# Model with Neurons \n# Inputshape = neurons -> Timestamps\nneurons= x_train.shape[1]\nmodel.add(LSTM(90, \n               activation = 'relu',\n               return_sequences = True, \n               input_shape = (x_train.shape[1], 8))) \nmodel.add(LSTM(50, \n               activation = 'relu',\n               return_sequences = True)) \nmodel.add(LSTM(25, \n               activation = 'relu',\n               return_sequences = False)) \nmodel.add(Dense(5, activation = 'relu'))\nmodel.add(Dense(1))\n\nBuild model...\n\n\n\nmodel.compile(optimizer='adam', loss='mean_squared_error')\nmodel.summary()\n\nModel: \"sequential_4\"\n\n\n_________________________________________________________________\n\n\n Layer (type)                Output Shape              Param #   \n\n\n=================================================================\n\n\n lstm_12 (LSTM)              (None, 90, 90)            35640     \n\n\n                                                                 \n\n\n lstm_13 (LSTM)              (None, 90, 50)            28200     \n\n\n                                                                 \n\n\n lstm_14 (LSTM)              (None, 25)                7600      \n\n\n                                                                 \n\n\n dense_8 (Dense)             (None, 5)                 130       \n\n\n                                                                 \n\n\n dense_9 (Dense)             (None, 1)                 6         \n\n\n                                                                 \n\n\n=================================================================\n\n\nTotal params: 71,576\n\n\nTrainable params: 71,576\n\n\nNon-trainable params: 0\n\n\n_________________________________________________________________\n\n\n\n# Training the model\n# fit network\nhistory = model.fit(x_train, \n                    y_train, \n                    batch_size=1000, \n                    epochs=30, \n                    validation_data = (x_test, y_test), \n                    verbose = 0)\n\n\nplt.plot(history.history['loss'], label='train')\nplt.plot(history.history['val_loss'], label='test')\nplt.legend()\nplt.show() \n\n\n\n\n\n# Get the predicted values\npredictions = model.predict(x_test)\npredictions = scaler_pred.inverse_transform(predictions)\n\nWARNING:tensorflow:5 out of the last 13 calls to <function Model.make_predict_function.<locals>.predict_function at 0x7fd54fad4430> triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.\n\n\n1/3 [=========>....................] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - 0s 31ms/step\n\n\n\ny_test = y_test.reshape(-1,1)\ny_test = scaler_pred.inverse_transform(y_test)\n\n\n# Calculate the mean absolute error (MAE)\nmae = mean_absolute_error(y_test, predictions)\nprint('MAE: ' + str(round(mae, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = np.sqrt(mean_squared_error(y_test,predictions))\nprint('RMSE: ' + str(round(rmse, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = mean_squared_error(y_test, \n                          predictions,\n                          squared = False)\nprint('RMSE: ' + str(round(rmse, 1)))\n\nMAE: 1622.4\nRMSE: 1889.7\nRMSE: 1889.7\n\n\n\n# Add the difference between the valid and predicted prices\ntrain = data_sevilla[:(len(x_train)+92)]\nvalid = data_sevilla[(len(x_train)+91):]\n\n\nvalid.insert(1, \"Predictions\", predictions, True)\nvalid.insert(1, \"Difference\", valid[\"Predictions\"] - valid[\"num_casos\"], True)\n\n\n# Zoom-in to a closer timeframe\n# Date from which on the date is displayed\ndisplay_start_date = \"2021-10-31\" \nvalid = valid[valid.index > display_start_date]\ntrain = train[train.index > display_start_date]\n\n\n# Visualize the data\nmatplotlib.style.use('ggplot')\nfig, ax1 = plt.subplots(figsize=(22, 10), sharex=True)\n\n# Data - Train\nxt = train.index; \nyt = train[[\"num_casos\"]]\n# Data - Test / validation \nxv = valid.index; \nyv = valid[[\"num_casos\", \"Predictions\"]]\n\n# Plot\nplt.title(\"sevilla: Predictions vs Real infections\", fontsize=20)\nplt.ylabel(\"Nº Cases\", fontsize=18)\n\nplt.plot(yt, color=\"blue\", linewidth=1.5)\nplt.plot(yv[\"Predictions\"], color=\"red\", linewidth=1.5)\nplt.plot(yv[\"num_casos\"], color=\"green\", linewidth=1.5)\nplt.legend([\"Train\", \"LSTM Predictions\", \"Test\"], \n           loc=\"upper left\", fontsize=18)\n\n# Bar plot with the differences\nx = valid.index\ny = valid[\"Difference\"]\nplt.bar(x, y, width=0.2, color=\"grey\")\nplt.grid()\nplt.show()"
  },
  {
    "objectID": "lstm_multi.html#asturias-1",
    "href": "lstm_multi.html#asturias-1",
    "title": "LSTM multivariate prediction",
    "section": "Asturias",
    "text": "Asturias\n\ndata_asturias = data_covid.loc[data_covid['provincia'] == 'Asturias']\ndata_asturias = data_asturias.set_index('fecha')\ndata_asturias = data_asturias['2020-06-14':'2021-12-31']\ndata_asturias = data_asturias.filter(['num_casos', 'tmed', 'mob_grocery_pharmacy', \n'mob_parks', 'mob_residential', 'mob_residential', 'mob_transit_stations', 'mob_workplaces'])\ndata_asturias\n\n\n\n\n\n  \n    \n      \n      num_casos\n      tmed\n      mob_grocery_pharmacy\n      mob_parks\n      mob_residential\n      mob_residential\n      mob_transit_stations\n      mob_workplaces\n    \n    \n      fecha\n      \n      \n      \n      \n      \n      \n      \n      \n    \n  \n  \n    \n      2020-06-14\n      0\n      16.8\n      -8.0\n      6.0\n      4.0\n      4.0\n      -43.0\n      -2.0\n    \n    \n      2020-06-15\n      0\n      16.0\n      -6.0\n      39.0\n      7.0\n      7.0\n      -38.0\n      -27.0\n    \n    \n      2020-06-16\n      1\n      15.6\n      -6.0\n      7.0\n      9.0\n      9.0\n      -43.0\n      -29.0\n    \n    \n      2020-06-17\n      0\n      15.6\n      -7.0\n      20.0\n      8.0\n      8.0\n      -42.0\n      -28.0\n    \n    \n      2020-06-18\n      0\n      15.1\n      -4.0\n      68.0\n      7.0\n      7.0\n      -39.0\n      -28.0\n    \n    \n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n    \n    \n      2021-12-27\n      2363\n      16.6\n      21.0\n      57.0\n      5.0\n      5.0\n      -9.0\n      -35.0\n    \n    \n      2021-12-28\n      2150\n      19.2\n      18.0\n      90.0\n      4.0\n      4.0\n      -6.0\n      -36.0\n    \n    \n      2021-12-29\n      2159\n      15.6\n      24.0\n      108.0\n      4.0\n      4.0\n      0.0\n      -34.0\n    \n    \n      2021-12-30\n      2020\n      13.2\n      39.0\n      88.0\n      4.0\n      4.0\n      -10.0\n      -36.0\n    \n    \n      2021-12-31\n      1949\n      14.6\n      21.0\n      46.0\n      10.0\n      10.0\n      -21.0\n      -54.0\n    \n  \n\n566 rows × 8 columns\n\n\n\n\ndata_asturias.describe()\n\n\n\n\n\n  \n    \n      \n      num_casos\n      tmed\n      mob_grocery_pharmacy\n      mob_parks\n      mob_residential\n      mob_residential\n      mob_transit_stations\n      mob_workplaces\n    \n  \n  \n    \n      count\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n    \n    \n      mean\n      180.913428\n      14.495671\n      4.159011\n      62.592756\n      3.798587\n      3.798587\n      -12.772085\n      -21.289753\n    \n    \n      std\n      276.250633\n      4.098429\n      15.207805\n      71.365461\n      5.051424\n      5.051424\n      15.668332\n      13.018468\n    \n    \n      min\n      0.000000\n      3.300000\n      -87.000000\n      -63.000000\n      -8.000000\n      -8.000000\n      -67.000000\n      -80.000000\n    \n    \n      25%\n      36.000000\n      11.525000\n      -0.375000\n      14.000000\n      0.000000\n      0.000000\n      -23.000000\n      -27.000000\n    \n    \n      50%\n      94.500000\n      15.000000\n      5.000000\n      43.000000\n      3.000000\n      3.000000\n      -13.000000\n      -20.000000\n    \n    \n      75%\n      225.750000\n      18.000000\n      11.000000\n      91.000000\n      7.000000\n      7.000000\n      -2.000000\n      -15.000000\n    \n    \n      max\n      2363.000000\n      25.100000\n      42.000000\n      333.000000\n      26.000000\n      26.000000\n      26.000000\n      12.000000\n    \n  \n\n\n\n\n\nnp_data_asturias = data_asturias.values\n\n\n# Train dataset\nscaler = MinMaxScaler(feature_range=(0, 1))\nscaled_data_asturias = scaler.fit_transform(np_data_asturias)\nprint(f'Longitud del conjunto de datos disponible: {len(scaled_data_asturias)}')\n\nLongitud del conjunto de datos disponible: 566\n\n\n\n# Since we are going to predict future values based on the 90 past elements, \n# we need to create a list with those historic information for each element\nhistoric_values = 90\nscaled_data_asturias_x = []\nscaled_data_asturias_y = []\n\nfor i in range(historic_values, len(scaled_data_asturias)):\n    scaled_data_asturias_x.append(scaled_data_asturias[(i-historic_values):i, :])\n    scaled_data_asturias_y.append(scaled_data_asturias[i, 0])\n\n# Convert the x_train and y_train to numpy arrays\nscaled_data_asturias_x = np.array(scaled_data_asturias_x)\nscaled_data_asturias_y = np.array(scaled_data_asturias_y)\n\n\n# Once predicted, we are going to need a exclusive scaler for num_cases\nscaler_pred = MinMaxScaler(feature_range=(0, 1))\ndf_cases_asturias = pd.DataFrame(data_asturias['num_casos'])\nscaled_data_asturias_pred = scaler_pred.fit_transform(df_cases_asturias)\n\n\n# Since the first 90th values does not have historic, the dataset has been reduced in 90 values\nprint(f'Longitud datos de entrenamiento con historico: {len(scaled_data_asturias_y)}')\n\nLongitud datos de entrenamiento con historico: 476\n\n\n\n# we split data in train and test\n# as in previous analysis, we are going to predict a maximum of 90 days\nx_train = scaled_data_asturias_x[0:len(scaled_data_asturias_x)-91]\ny_train = scaled_data_asturias_y[0:len(scaled_data_asturias_y)-91]\nprint(f'Cantidad datos de entrenamiento: x={len(x_train)} - y={len(y_train)}')\n\nx_test = scaled_data_asturias_x[len(scaled_data_asturias_x)-90:len(scaled_data_asturias_x)]\ny_test = scaled_data_asturias_y[len(scaled_data_asturias_y)-90:len(scaled_data_asturias_y)]\nprint(f'Cantidad datos de test: x={len(x_test)} - y={len(y_test)}')\n\nCantidad datos de entrenamiento: x=385 - y=385\nCantidad datos de test: x=90 - y=90\n\n\n\n# Reshape the data to feed de recurrent network\nx_train = np.reshape(x_train, (x_train.shape[0], x_train.shape[1], 8))\nprint(\"Train data shape:\")\nprint(x_train.shape)\nprint(y_train.shape)\nx_test = np.reshape(x_test, (x_test.shape[0], x_test.shape[1], 8))\nprint(\"Test data shape:\")\nprint(x_test.shape)\nprint(y_test.shape)\n\nTrain data shape:\n(385, 90, 8)\n(385,)\nTest data shape:\n(90, 90, 8)\n(90,)\n\n\n\n# Configure / setup the neural network model - LSTM\n# Build the model\nprint('Build model...')\nmodel = Sequential()\n# Model with Neurons \n# Inputshape = neurons -> Timestamps\nneurons= x_train.shape[1]\nmodel.add(LSTM(90, \n               activation = 'relu',\n               return_sequences = True, \n               input_shape = (x_train.shape[1], 8))) \nmodel.add(LSTM(50, \n               activation = 'relu',\n               return_sequences = True)) \nmodel.add(LSTM(25, \n               activation = 'relu',\n               return_sequences = False)) \nmodel.add(Dense(5, activation = 'relu'))\nmodel.add(Dense(1))\n\nBuild model...\n\n\n\nmodel.compile(optimizer='adam', loss='mean_squared_error')\nmodel.summary()\n\nModel: \"sequential_5\"\n\n\n_________________________________________________________________\n\n\n Layer (type)                Output Shape              Param #   \n\n\n=================================================================\n\n\n lstm_15 (LSTM)              (None, 90, 90)            35640     \n\n\n                                                                 \n\n\n lstm_16 (LSTM)              (None, 90, 50)            28200     \n\n\n                                                                 \n\n\n lstm_17 (LSTM)              (None, 25)                7600      \n\n\n                                                                 \n\n\n dense_10 (Dense)            (None, 5)                 130       \n\n\n                                                                 \n\n\n dense_11 (Dense)            (None, 1)                 6         \n\n\n                                                                 \n\n\n=================================================================\n\n\nTotal params: 71,576\n\n\nTrainable params: 71,576\n\n\nNon-trainable params: 0\n\n\n_________________________________________________________________\n\n\n\n# Training the model\n# fit network\nhistory = model.fit(x_train, \n                    y_train, \n                    batch_size=1000, \n                    epochs=50, \n                    validation_data = (x_test, y_test), \n                    verbose = 0)\n\n\nplt.plot(history.history['loss'], label='train')\nplt.plot(history.history['val_loss'], label='test')\nplt.legend()\nplt.show() \n\n\n\n\n\n# Get the predicted values\npredictions = model.predict(x_test)\npredictions = scaler_pred.inverse_transform(predictions)\n\nWARNING:tensorflow:5 out of the last 13 calls to <function Model.make_predict_function.<locals>.predict_function at 0x7fd53efb6310> triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.\n\n\n1/3 [=========>....................] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - 0s 31ms/step\n\n\n\ny_test = y_test.reshape(-1,1)\ny_test = scaler_pred.inverse_transform(y_test)\n\n\n# Calculate the mean absolute error (MAE)\nmae = mean_absolute_error(y_test, predictions)\nprint('MAE: ' + str(round(mae, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = np.sqrt(mean_squared_error(y_test,predictions))\nprint('RMSE: ' + str(round(rmse, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = mean_squared_error(y_test, \n                          predictions,\n                          squared = False)\nprint('RMSE: ' + str(round(rmse, 1)))\n\nMAE: 263.9\nRMSE: 465.3\nRMSE: 465.3\n\n\n\n# Add the difference between the valid and predicted prices\ntrain = data_asturias[:(len(x_train)+92)]\nvalid = data_asturias[(len(x_train)+91):]\n\n\nvalid.insert(1, \"Predictions\", predictions, True)\nvalid.insert(1, \"Difference\", valid[\"Predictions\"] - valid[\"num_casos\"], True)\n\n\n# Zoom-in to a closer timeframe\n# Date from which on the date is displayed\ndisplay_start_date = \"2021-07-15\" \nvalid = valid[valid.index > display_start_date]\ntrain = train[train.index > display_start_date]\n\n\n# Visualize the data\nmatplotlib.style.use('ggplot')\nfig, ax1 = plt.subplots(figsize=(22, 10), sharex=True)\n\n# Data - Train\nxt = train.index; \nyt = train[[\"num_casos\"]]\n# Data - Test / validation \nxv = valid.index; \nyv = valid[[\"num_casos\", \"Predictions\"]]\n\n# Plot\nplt.title(\"Asturias: Predictions vs Real infections\", fontsize=20)\nplt.ylabel(\"Nº Cases\", fontsize=18)\n\nplt.plot(yt, color=\"blue\", linewidth=1.5)\nplt.plot(yv[\"Predictions\"], color=\"red\", linewidth=1.5)\nplt.plot(yv[\"num_casos\"], color=\"green\", linewidth=1.5)\nplt.legend([\"Train\", \"LSTM Predictions\", \"Test\"], \n           loc=\"upper left\", fontsize=18)\n\n# Bar plot with the differences\nx = valid.index\ny = valid[\"Difference\"]\nplt.bar(x, y, width=0.2, color=\"grey\")\nplt.grid()\nplt.show()"
  },
  {
    "objectID": "lstm_multi.html#barcelona-1",
    "href": "lstm_multi.html#barcelona-1",
    "title": "LSTM multivariate prediction",
    "section": "Barcelona",
    "text": "Barcelona\n\ndata_barcelona = data_covid.loc[data_covid['provincia'] == 'Barcelona']\ndata_barcelona = data_barcelona.set_index('fecha')\ndata_barcelona = data_barcelona['2020-06-14':'2021-12-31']\ndata_barcelona = data_barcelona.filter(['num_casos', 'tmed', 'mob_grocery_pharmacy', \n'mob_parks', 'mob_residential', 'mob_residential', 'mob_transit_stations', 'mob_workplaces'])\ndata_barcelona\n\n\n\n\n\n  \n    \n      \n      num_casos\n      tmed\n      mob_grocery_pharmacy\n      mob_parks\n      mob_residential\n      mob_residential\n      mob_transit_stations\n      mob_workplaces\n    \n    \n      fecha\n      \n      \n      \n      \n      \n      \n      \n      \n    \n  \n  \n    \n      2020-06-14\n      33\n      20.6\n      -20.0\n      15.0\n      6.0\n      6.0\n      -31.0\n      -6.0\n    \n    \n      2020-06-15\n      62\n      21.2\n      -9.0\n      17.0\n      14.0\n      14.0\n      -34.0\n      -41.0\n    \n    \n      2020-06-16\n      66\n      20.8\n      -10.0\n      -16.0\n      16.0\n      16.0\n      -39.0\n      -41.0\n    \n    \n      2020-06-17\n      70\n      20.3\n      -4.0\n      14.0\n      15.0\n      15.0\n      -33.0\n      -40.0\n    \n    \n      2020-06-18\n      68\n      18.8\n      -8.0\n      -6.0\n      16.0\n      16.0\n      -38.0\n      -41.0\n    \n    \n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n    \n    \n      2021-12-27\n      19383\n      16.4\n      15.0\n      7.0\n      12.0\n      12.0\n      -25.0\n      -52.0\n    \n    \n      2021-12-28\n      20192\n      17.7\n      17.0\n      7.0\n      13.0\n      13.0\n      -25.0\n      -52.0\n    \n    \n      2021-12-29\n      19361\n      17.0\n      23.0\n      10.0\n      13.0\n      13.0\n      -25.0\n      -51.0\n    \n    \n      2021-12-30\n      17639\n      15.8\n      37.0\n      6.0\n      12.0\n      12.0\n      -24.0\n      -53.0\n    \n    \n      2021-12-31\n      16651\n      13.6\n      26.0\n      -12.0\n      16.0\n      16.0\n      -36.0\n      -60.0\n    \n  \n\n566 rows × 8 columns\n\n\n\n\ndata_barcelona.describe()\n\n\n\n\n\n  \n    \n      \n      num_casos\n      tmed\n      mob_grocery_pharmacy\n      mob_parks\n      mob_residential\n      mob_residential\n      mob_transit_stations\n      mob_workplaces\n    \n  \n  \n    \n      count\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n    \n    \n      mean\n      1575.480565\n      18.205477\n      -0.574205\n      -4.651943\n      7.353357\n      7.353357\n      -24.865724\n      -28.471731\n    \n    \n      std\n      2281.290383\n      6.086976\n      16.775476\n      15.728472\n      5.162377\n      5.162377\n      11.574598\n      16.238872\n    \n    \n      min\n      33.000000\n      4.300000\n      -83.000000\n      -76.000000\n      -6.000000\n      -6.000000\n      -72.000000\n      -87.000000\n    \n    \n      25%\n      544.750000\n      12.800000\n      -7.000000\n      -14.750000\n      4.000000\n      4.000000\n      -33.000000\n      -36.000000\n    \n    \n      50%\n      944.500000\n      17.800000\n      0.500000\n      -4.000000\n      8.000000\n      8.000000\n      -25.000000\n      -26.000000\n    \n    \n      75%\n      1609.500000\n      24.375000\n      10.000000\n      7.000000\n      10.000000\n      10.000000\n      -15.000000\n      -19.250000\n    \n    \n      max\n      20192.000000\n      28.400000\n      58.000000\n      33.000000\n      32.000000\n      32.000000\n      -2.000000\n      6.000000\n    \n  \n\n\n\n\n\nnp_data_barcelona = data_barcelona.values\n\n\n# Train dataset\nscaler = MinMaxScaler(feature_range=(0, 1))\nscaled_data_barcelona = scaler.fit_transform(np_data_barcelona)\nprint(f'Longitud del conjunto de datos disponible: {len(scaled_data_barcelona)}')\n\nLongitud del conjunto de datos disponible: 566\n\n\n\n# Since we are going to predict future values based on the 90 past elements, \n# we need to create a list with those historic information for each element\nhistoric_values = 90\nscaled_data_barcelona_x = []\nscaled_data_barcelona_y = []\n\nfor i in range(historic_values, len(scaled_data_barcelona)):\n    scaled_data_barcelona_x.append(scaled_data_barcelona[(i-historic_values):i, :])\n    scaled_data_barcelona_y.append(scaled_data_barcelona[i, 0])\n\n# Convert the x_train and y_train to numpy arrays\nscaled_data_barcelona_x = np.array(scaled_data_barcelona_x)\nscaled_data_barcelona_y = np.array(scaled_data_barcelona_y)\n\n\n# Once predicted, we are going to need a exclusive scaler for num_cases\nscaler_pred = MinMaxScaler(feature_range=(0, 1))\ndf_cases_barcelona = pd.DataFrame(data_barcelona['num_casos'])\nscaled_data_barcelona_pred = scaler_pred.fit_transform(df_cases_barcelona)\n\n\n# Since the first 90th values does not have historic, the dataset has been reduced in 90 values\nprint(f'Longitud datos de entrenamiento con historico: {len(scaled_data_barcelona_y)}')\n\nLongitud datos de entrenamiento con historico: 476\n\n\n\n# we split data in train and test\n# as in previous analysis, we are going to predict a maximum of 90 days\nx_train = scaled_data_barcelona_x[0:len(scaled_data_barcelona_x)-91]\ny_train = scaled_data_barcelona_y[0:len(scaled_data_barcelona_y)-91]\nprint(f'Cantidad datos de entrenamiento: x={len(x_train)} - y={len(y_train)}')\n\nx_test = scaled_data_barcelona_x[len(scaled_data_barcelona_x)-90:len(scaled_data_barcelona_x)]\ny_test = scaled_data_barcelona_y[len(scaled_data_barcelona_y)-90:len(scaled_data_barcelona_y)]\nprint(f'Cantidad datos de test: x={len(x_test)} - y={len(y_test)}')\n\nCantidad datos de entrenamiento: x=385 - y=385\nCantidad datos de test: x=90 - y=90\n\n\n\n# Reshape the data to feed de recurrent network\nx_train = np.reshape(x_train, (x_train.shape[0], x_train.shape[1], 8))\nprint(\"Train data shape:\")\nprint(x_train.shape)\nprint(y_train.shape)\nx_test = np.reshape(x_test, (x_test.shape[0], x_test.shape[1], 8))\nprint(\"Test data shape:\")\nprint(x_test.shape)\nprint(y_test.shape)\n\nTrain data shape:\n(385, 90, 8)\n(385,)\nTest data shape:\n(90, 90, 8)\n(90,)\n\n\n\n# Configure / setup the neural network model - LSTM\n# Build the model\nprint('Build model...')\nmodel = Sequential()\n# Model with Neurons \n# Inputshape = neurons -> Timestamps\nneurons= x_train.shape[1]\nmodel.add(LSTM(90, \n               activation = 'relu',\n               return_sequences = True, \n               input_shape = (x_train.shape[1], 8))) \nmodel.add(LSTM(50, \n               activation = 'relu',\n               return_sequences = True)) \nmodel.add(LSTM(25, \n               activation = 'relu',\n               return_sequences = False)) \nmodel.add(Dense(5, activation = 'relu'))\nmodel.add(Dense(1))\n\nBuild model...\n\n\n\nmodel.compile(optimizer='adam', loss='mean_squared_error')\nmodel.summary()\n\nModel: \"sequential_6\"\n\n\n_________________________________________________________________\n\n\n Layer (type)                Output Shape              Param #   \n\n\n=================================================================\n\n\n lstm_18 (LSTM)              (None, 90, 90)            35640     \n\n\n                                                                 \n\n\n lstm_19 (LSTM)              (None, 90, 50)            28200     \n\n\n                                                                 \n\n\n lstm_20 (LSTM)              (None, 25)                7600      \n\n\n                                                                 \n\n\n dense_12 (Dense)            (None, 5)                 130       \n\n\n                                                                 \n\n\n dense_13 (Dense)            (None, 1)                 6         \n\n\n                                                                 \n\n\n=================================================================\n\n\nTotal params: 71,576\n\n\nTrainable params: 71,576\n\n\nNon-trainable params: 0\n\n\n_________________________________________________________________\n\n\n\n# Training the model\n# fit network\nhistory = model.fit(x_train, \n                    y_train, \n                    batch_size=1000, \n                    epochs=50, \n                    validation_data = (x_test, y_test), \n                    verbose = 0)\n\n\nplt.plot(history.history['loss'], label='train')\nplt.plot(history.history['val_loss'], label='test')\nplt.legend()\nplt.show() \n\n\n\n\n\n# Get the predicted values\npredictions = model.predict(x_test)\npredictions = scaler_pred.inverse_transform(predictions)\n\n1/3 [=========>....................] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - 0s 31ms/step\n\n\n\ny_test = y_test.reshape(-1,1)\ny_test = scaler_pred.inverse_transform(y_test)\n\n\n# Calculate the mean absolute error (MAE)\nmae = mean_absolute_error(y_test, predictions)\nprint('MAE: ' + str(round(mae, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = np.sqrt(mean_squared_error(y_test,predictions))\nprint('RMSE: ' + str(round(rmse, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = mean_squared_error(y_test, \n                          predictions,\n                          squared = False)\nprint('RMSE: ' + str(round(rmse, 1)))\n\nMAE: 2657.6\nRMSE: 4156.6\nRMSE: 4156.6\n\n\n\n# Add the difference between the valid and predicted prices\ntrain = data_barcelona[:(len(x_train)+92)]\nvalid = data_barcelona[(len(x_train)+91):]\n\n\nvalid.insert(1, \"Predictions\", predictions, True)\nvalid.insert(1, \"Difference\", valid[\"Predictions\"] - valid[\"num_casos\"], True)\n\n\n# Zoom-in to a closer timeframe\n# Date from which on the date is displayed\ndisplay_start_date = \"2021-07-15\" \nvalid = valid[valid.index > display_start_date]\ntrain = train[train.index > display_start_date]\n\n\n# Visualize the data\nmatplotlib.style.use('ggplot')\nfig, ax1 = plt.subplots(figsize=(22, 10), sharex=True)\n\n# Data - Train\nxt = train.index; \nyt = train[[\"num_casos\"]]\n# Data - Test / validation \nxv = valid.index; \nyv = valid[[\"num_casos\", \"Predictions\"]]\n\n# Plot\nplt.title(\"barcelona: Predictions vs Real infections\", fontsize=20)\nplt.ylabel(\"Nº Cases\", fontsize=18)\n\nplt.plot(yt, color=\"blue\", linewidth=1.5)\nplt.plot(yv[\"Predictions\"], color=\"red\", linewidth=1.5)\nplt.plot(yv[\"num_casos\"], color=\"green\", linewidth=1.5)\nplt.legend([\"Train\", \"LSTM Predictions\", \"Test\"], \n           loc=\"upper left\", fontsize=18)\n\n# Bar plot with the differences\nx = valid.index\ny = valid[\"Difference\"]\nplt.bar(x, y, width=0.2, color=\"grey\")\nplt.grid()\nplt.show()"
  },
  {
    "objectID": "lstm_multi.html#madrid-1",
    "href": "lstm_multi.html#madrid-1",
    "title": "LSTM multivariate prediction",
    "section": "Madrid",
    "text": "Madrid\n\ndata_madrid = data_covid.loc[data_covid['provincia'] == 'Madrid']\ndata_madrid = data_madrid.set_index('fecha')\ndata_madrid = data_madrid['2020-06-14':'2021-12-31']\ndata_madrid = data_madrid.filter(['num_casos', 'tmed', 'mob_grocery_pharmacy', \n'mob_parks', 'mob_residential', 'mob_residential', 'mob_transit_stations', 'mob_workplaces'])\ndata_madrid\n\n\n\n\n\n  \n    \n      \n      num_casos\n      tmed\n      mob_grocery_pharmacy\n      mob_parks\n      mob_residential\n      mob_residential\n      mob_transit_stations\n      mob_workplaces\n    \n    \n      fecha\n      \n      \n      \n      \n      \n      \n      \n      \n    \n  \n  \n    \n      2020-06-14\n      81\n      19.0\n      -15.0\n      25.0\n      7.0\n      7.0\n      -43.0\n      -6.0\n    \n    \n      2020-06-15\n      153\n      20.7\n      -8.0\n      34.0\n      16.0\n      16.0\n      -43.0\n      -47.0\n    \n    \n      2020-06-16\n      91\n      21.0\n      -8.0\n      21.0\n      17.0\n      17.0\n      -43.0\n      -47.0\n    \n    \n      2020-06-17\n      93\n      20.2\n      -5.0\n      34.0\n      17.0\n      17.0\n      -42.0\n      -47.0\n    \n    \n      2020-06-18\n      85\n      21.9\n      -7.0\n      30.0\n      16.0\n      16.0\n      -44.0\n      -47.0\n    \n    \n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n    \n    \n      2021-12-27\n      22958\n      12.3\n      21.0\n      19.0\n      12.0\n      12.0\n      -28.0\n      -52.0\n    \n    \n      2021-12-28\n      23811\n      10.4\n      18.0\n      23.0\n      12.0\n      12.0\n      -30.0\n      -52.0\n    \n    \n      2021-12-29\n      21914\n      9.0\n      27.0\n      18.0\n      13.0\n      13.0\n      -30.0\n      -52.0\n    \n    \n      2021-12-30\n      20666\n      8.7\n      42.0\n      17.0\n      12.0\n      12.0\n      -30.0\n      -53.0\n    \n    \n      2021-12-31\n      7556\n      9.2\n      10.0\n      -15.0\n      18.0\n      18.0\n      -47.0\n      -69.0\n    \n  \n\n566 rows × 8 columns\n\n\n\n\ndata_madrid.describe()\n\n\n\n\n\n  \n    \n      \n      num_casos\n      tmed\n      mob_grocery_pharmacy\n      mob_parks\n      mob_residential\n      mob_residential\n      mob_transit_stations\n      mob_workplaces\n    \n  \n  \n    \n      count\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n    \n    \n      mean\n      1994.136042\n      16.004064\n      -3.793286\n      -4.438163\n      7.238516\n      7.238516\n      -31.560071\n      -28.715548\n    \n    \n      std\n      2795.419848\n      8.085617\n      14.945139\n      21.384112\n      5.850467\n      5.850467\n      12.292703\n      19.230654\n    \n    \n      min\n      28.000000\n      -6.200000\n      -84.000000\n      -62.000000\n      -6.000000\n      -6.000000\n      -73.000000\n      -86.000000\n    \n    \n      25%\n      550.250000\n      9.525000\n      -11.000000\n      -17.750000\n      4.000000\n      4.000000\n      -40.000000\n      -41.000000\n    \n    \n      50%\n      1312.500000\n      14.700000\n      -3.000000\n      -3.000000\n      7.000000\n      7.000000\n      -33.000000\n      -28.000000\n    \n    \n      75%\n      2282.500000\n      23.200000\n      6.000000\n      11.750000\n      11.000000\n      11.000000\n      -24.000000\n      -17.000000\n    \n    \n      max\n      23811.000000\n      32.700000\n      50.000000\n      77.000000\n      31.000000\n      31.000000\n      1.000000\n      20.000000\n    \n  \n\n\n\n\n\nnp_data_madrid = data_madrid.values\n\n\n# Train dataset\nscaler = MinMaxScaler(feature_range=(0, 1))\nscaled_data_madrid = scaler.fit_transform(np_data_madrid)\nprint(f'Longitud del conjunto de datos disponible: {len(scaled_data_madrid)}')\n\nLongitud del conjunto de datos disponible: 566\n\n\n\n# Since we are going to predict future values based on the 90 past elements, \n# we need to create a list with those historic information for each element\nhistoric_values = 90\nscaled_data_madrid_x = []\nscaled_data_madrid_y = []\n\nfor i in range(historic_values, len(scaled_data_madrid)):\n    scaled_data_madrid_x.append(scaled_data_madrid[(i-historic_values):i, :])\n    scaled_data_madrid_y.append(scaled_data_madrid[i, 0])\n\n# Convert the x_train and y_train to numpy arrays\nscaled_data_madrid_x = np.array(scaled_data_madrid_x)\nscaled_data_madrid_y = np.array(scaled_data_madrid_y)\n\n\n# Once predicted, we are going to need a exclusive scaler for num_cases\nscaler_pred = MinMaxScaler(feature_range=(0, 1))\ndf_cases_madrid = pd.DataFrame(data_madrid['num_casos'])\nscaled_data_madrid_pred = scaler_pred.fit_transform(df_cases_madrid)\n\n\n# Since the first 90th values does not have historic, the dataset has been reduced in 90 values\nprint(f'Longitud datos de entrenamiento con historico: {len(scaled_data_madrid_y)}')\n\nLongitud datos de entrenamiento con historico: 476\n\n\n\n# we split data in train and test\n# as in previous analysis, we are going to predict a maximum of 90 days\nx_train = scaled_data_madrid_x[0:len(scaled_data_madrid_x)-91]\ny_train = scaled_data_madrid_y[0:len(scaled_data_madrid_y)-91]\nprint(f'Cantidad datos de entrenamiento: x={len(x_train)} - y={len(y_train)}')\n\nx_test = scaled_data_madrid_x[len(scaled_data_madrid_x)-90:len(scaled_data_madrid_x)]\ny_test = scaled_data_madrid_y[len(scaled_data_madrid_y)-90:len(scaled_data_madrid_y)]\nprint(f'Cantidad datos de test: x={len(x_test)} - y={len(y_test)}')\n\nCantidad datos de entrenamiento: x=385 - y=385\nCantidad datos de test: x=90 - y=90\n\n\n\n# Reshape the data to feed de recurrent network\nx_train = np.reshape(x_train, (x_train.shape[0], x_train.shape[1], 8))\nprint(\"Train data shape:\")\nprint(x_train.shape)\nprint(y_train.shape)\nx_test = np.reshape(x_test, (x_test.shape[0], x_test.shape[1], 8))\nprint(\"Test data shape:\")\nprint(x_test.shape)\nprint(y_test.shape)\n\nTrain data shape:\n(385, 90, 8)\n(385,)\nTest data shape:\n(90, 90, 8)\n(90,)\n\n\n\n# Configure / setup the neural network model - LSTM\n# Build the model\nprint('Build model...')\nmodel = Sequential()\n# Model with Neurons \n# Inputshape = neurons -> Timestamps\nneurons= x_train.shape[1]\nmodel.add(LSTM(90, \n               activation = 'relu',\n               return_sequences = True, \n               input_shape = (x_train.shape[1], 8))) \nmodel.add(LSTM(50, \n               activation = 'relu',\n               return_sequences = True)) \nmodel.add(LSTM(25, \n               activation = 'relu',\n               return_sequences = False)) \nmodel.add(Dense(5, activation = 'relu'))\nmodel.add(Dense(1))\n\nBuild model...\n\n\n\nmodel.compile(optimizer='adam', loss='mean_squared_error')\nmodel.summary()\n\nModel: \"sequential_7\"\n\n\n_________________________________________________________________\n\n\n Layer (type)                Output Shape              Param #   \n\n\n=================================================================\n\n\n lstm_21 (LSTM)              (None, 90, 90)            35640     \n\n\n                                                                 \n\n\n lstm_22 (LSTM)              (None, 90, 50)            28200     \n\n\n                                                                 \n\n\n lstm_23 (LSTM)              (None, 25)                7600      \n\n\n                                                                 \n\n\n dense_14 (Dense)            (None, 5)                 130       \n\n\n                                                                 \n\n\n dense_15 (Dense)            (None, 1)                 6         \n\n\n                                                                 \n\n\n=================================================================\n\n\nTotal params: 71,576\n\n\nTrainable params: 71,576\n\n\nNon-trainable params: 0\n\n\n_________________________________________________________________\n\n\n\n# Training the model\n# fit network\nhistory = model.fit(x_train, \n                    y_train, \n                    batch_size=1000, \n                    epochs=50, \n                    validation_data = (x_test, y_test), \n                    verbose = 0)\n\n\nplt.plot(history.history['loss'], label='train')\nplt.plot(history.history['val_loss'], label='test')\nplt.legend()\nplt.show() \n\n\n\n\n\n# Get the predicted values\npredictions = model.predict(x_test)\npredictions = scaler_pred.inverse_transform(predictions)\n\n1/3 [=========>....................] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - 0s 31ms/step\n\n\n\ny_test = y_test.reshape(-1,1)\ny_test = scaler_pred.inverse_transform(y_test)\n\n\n# Calculate the mean absolute error (MAE)\nmae = mean_absolute_error(y_test, predictions)\nprint('MAE: ' + str(round(mae, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = np.sqrt(mean_squared_error(y_test,predictions))\nprint('RMSE: ' + str(round(rmse, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = mean_squared_error(y_test, \n                          predictions,\n                          squared = False)\nprint('RMSE: ' + str(round(rmse, 1)))\n\nMAE: 2755.3\nRMSE: 5897.2\nRMSE: 5897.2\n\n\n\n# Add the difference between the valid and predicted prices\ntrain = data_madrid[:(len(x_train)+92)]\nvalid = data_madrid[(len(x_train)+91):]\n\n\nvalid.insert(1, \"Predictions\", predictions, True)\nvalid.insert(1, \"Difference\", valid[\"Predictions\"] - valid[\"num_casos\"], True)\n\n\n# Zoom-in to a closer timeframe\n# Date from which on the date is displayed\ndisplay_start_date = \"2021-07-15\" \nvalid = valid[valid.index > display_start_date]\ntrain = train[train.index > display_start_date]\n\n\n# Visualize the data\nmatplotlib.style.use('ggplot')\nfig, ax1 = plt.subplots(figsize=(22, 10), sharex=True)\n\n# Data - Train\nxt = train.index; \nyt = train[[\"num_casos\"]]\n# Data - Test / validation \nxv = valid.index; \nyv = valid[[\"num_casos\", \"Predictions\"]]\n\n# Plot\nplt.title(\"madrid: Predictions vs Real infections\", fontsize=20)\nplt.ylabel(\"Nº Cases\", fontsize=18)\n\nplt.plot(yt, color=\"blue\", linewidth=1.5)\nplt.plot(yv[\"Predictions\"], color=\"red\", linewidth=1.5)\nplt.plot(yv[\"num_casos\"], color=\"green\", linewidth=1.5)\nplt.legend([\"Train\", \"LSTM Predictions\", \"Test\"], \n           loc=\"upper left\", fontsize=18)\n\n# Bar plot with the differences\nx = valid.index\ny = valid[\"Difference\"]\nplt.bar(x, y, width=0.2, color=\"grey\")\nplt.grid()\nplt.show()"
  },
  {
    "objectID": "lstm_multi.html#málaga-1",
    "href": "lstm_multi.html#málaga-1",
    "title": "LSTM multivariate prediction",
    "section": "Málaga",
    "text": "Málaga\n\ndata_malaga = data_covid.loc[data_covid['provincia'] == 'Málaga']\ndata_malaga = data_malaga.set_index('fecha')\ndata_malaga = data_malaga['2020-06-14':'2021-12-31']\ndata_malaga = data_malaga.filter(['num_casos', 'tmed', 'mob_grocery_pharmacy', \n'mob_parks', 'mob_residential', 'mob_residential', 'mob_transit_stations', 'mob_workplaces'])\ndata_malaga\n\n\n\n\n\n  \n    \n      \n      num_casos\n      tmed\n      mob_grocery_pharmacy\n      mob_parks\n      mob_residential\n      mob_residential\n      mob_transit_stations\n      mob_workplaces\n    \n    \n      fecha\n      \n      \n      \n      \n      \n      \n      \n      \n    \n  \n  \n    \n      2020-06-14\n      2\n      26.6\n      -20.0\n      -15.0\n      2.0\n      2.0\n      -53.0\n      -7.0\n    \n    \n      2020-06-15\n      1\n      27.2\n      -16.0\n      -9.0\n      9.0\n      9.0\n      -44.0\n      -33.0\n    \n    \n      2020-06-16\n      1\n      27.8\n      -13.0\n      -4.0\n      9.0\n      9.0\n      -40.0\n      -33.0\n    \n    \n      2020-06-17\n      2\n      26.9\n      -13.0\n      1.0\n      9.0\n      9.0\n      -41.0\n      -33.0\n    \n    \n      2020-06-18\n      2\n      21.6\n      -12.0\n      3.0\n      9.0\n      9.0\n      -42.0\n      -33.0\n    \n    \n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n    \n    \n      2021-12-27\n      1627\n      17.9\n      15.0\n      17.0\n      7.0\n      7.0\n      -12.0\n      -37.0\n    \n    \n      2021-12-28\n      2772\n      17.8\n      18.0\n      30.0\n      7.0\n      7.0\n      -7.0\n      -37.0\n    \n    \n      2021-12-29\n      3080\n      17.0\n      25.0\n      37.0\n      6.0\n      6.0\n      -8.0\n      -37.0\n    \n    \n      2021-12-30\n      3075\n      14.4\n      39.0\n      33.0\n      5.0\n      5.0\n      -8.0\n      -37.0\n    \n    \n      2021-12-31\n      2646\n      11.1\n      22.0\n      -5.0\n      12.0\n      12.0\n      -34.0\n      -50.0\n    \n  \n\n566 rows × 8 columns\n\n\n\n\ndata_malaga.describe()\n\n\n\n\n\n  \n    \n      \n      num_casos\n      tmed\n      mob_grocery_pharmacy\n      mob_parks\n      mob_residential\n      mob_residential\n      mob_transit_stations\n      mob_workplaces\n    \n  \n  \n    \n      count\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n    \n    \n      mean\n      339.227915\n      20.332332\n      8.427562\n      15.765018\n      4.588339\n      4.588339\n      -19.860424\n      -18.724382\n    \n    \n      std\n      427.261346\n      5.690349\n      27.032414\n      41.263233\n      4.227823\n      4.227823\n      19.025924\n      14.733563\n    \n    \n      min\n      1.000000\n      6.200000\n      -80.000000\n      -63.000000\n      -4.000000\n      -4.000000\n      -70.000000\n      -79.000000\n    \n    \n      25%\n      110.000000\n      15.600000\n      -5.000000\n      -14.000000\n      2.000000\n      2.000000\n      -34.000000\n      -27.000000\n    \n    \n      50%\n      193.500000\n      20.000000\n      4.000000\n      7.000000\n      4.000000\n      4.000000\n      -23.000000\n      -18.000000\n    \n    \n      75%\n      344.750000\n      25.075000\n      16.000000\n      36.000000\n      7.000000\n      7.000000\n      -4.000000\n      -12.000000\n    \n    \n      max\n      3080.000000\n      34.500000\n      156.000000\n      152.000000\n      22.000000\n      22.000000\n      20.000000\n      29.000000\n    \n  \n\n\n\n\n\nnp_data_malaga = data_malaga.values\n\n\n# Train dataset\nscaler = MinMaxScaler(feature_range=(0, 1))\nscaled_data_malaga = scaler.fit_transform(np_data_malaga)\nprint(f'Longitud del conjunto de datos disponible: {len(scaled_data_malaga)}')\n\nLongitud del conjunto de datos disponible: 566\n\n\n\n# Since we are going to predict future values based on the 90 past elements, \n# we need to create a list with those historic information for each element\nhistoric_values = 90\nscaled_data_malaga_x = []\nscaled_data_malaga_y = []\n\nfor i in range(historic_values, len(scaled_data_malaga)):\n    scaled_data_malaga_x.append(scaled_data_malaga[(i-historic_values):i, :])\n    scaled_data_malaga_y.append(scaled_data_malaga[i, 0])\n\n# Convert the x_train and y_train to numpy arrays\nscaled_data_malaga_x = np.array(scaled_data_malaga_x)\nscaled_data_malaga_y = np.array(scaled_data_malaga_y)\n\n\n# Once predicted, we are going to need a exclusive scaler for num_cases\nscaler_pred = MinMaxScaler(feature_range=(0, 1))\ndf_cases_malaga = pd.DataFrame(data_malaga['num_casos'])\nscaled_data_malaga_pred = scaler_pred.fit_transform(df_cases_malaga)\n\n\n# Since the first 90th values does not have historic, the dataset has been reduced in 90 values\nprint(f'Longitud datos de entrenamiento con historico: {len(scaled_data_malaga_y)}')\n\nLongitud datos de entrenamiento con historico: 476\n\n\n\n# we split data in train and test\n# as in previous analysis, we are going to predict a maximum of 90 days\nx_train = scaled_data_malaga_x[0:len(scaled_data_malaga_x)-91]\ny_train = scaled_data_malaga_y[0:len(scaled_data_malaga_y)-91]\nprint(f'Cantidad datos de entrenamiento: x={len(x_train)} - y={len(y_train)}')\n\nx_test = scaled_data_malaga_x[len(scaled_data_malaga_x)-90:len(scaled_data_malaga_x)]\ny_test = scaled_data_malaga_y[len(scaled_data_malaga_y)-90:len(scaled_data_malaga_y)]\nprint(f'Cantidad datos de test: x={len(x_test)} - y={len(y_test)}')\n\nCantidad datos de entrenamiento: x=385 - y=385\nCantidad datos de test: x=90 - y=90\n\n\n\n# Reshape the data to feed de recurrent network\nx_train = np.reshape(x_train, (x_train.shape[0], x_train.shape[1], 8))\nprint(\"Train data shape:\")\nprint(x_train.shape)\nprint(y_train.shape)\nx_test = np.reshape(x_test, (x_test.shape[0], x_test.shape[1], 8))\nprint(\"Test data shape:\")\nprint(x_test.shape)\nprint(y_test.shape)\n\nTrain data shape:\n(385, 90, 8)\n(385,)\nTest data shape:\n(90, 90, 8)\n(90,)\n\n\n\n# Configure / setup the neural network model - LSTM\n# Build the model\nprint('Build model...')\nmodel = Sequential()\n# Model with Neurons \n# Inputshape = neurons -> Timestamps\nneurons= x_train.shape[1]\nmodel.add(LSTM(90, \n               activation = 'relu',\n               return_sequences = True, \n               input_shape = (x_train.shape[1], 8))) \nmodel.add(LSTM(50, \n               activation = 'relu',\n               return_sequences = True)) \nmodel.add(LSTM(25, \n               activation = 'relu',\n               return_sequences = False)) \nmodel.add(Dense(5, activation = 'relu'))\nmodel.add(Dense(1))\n\nBuild model...\n\n\n\nmodel.compile(optimizer='adam', loss='mean_squared_error')\nmodel.summary()\n\nModel: \"sequential_8\"\n\n\n_________________________________________________________________\n\n\n Layer (type)                Output Shape              Param #   \n\n\n=================================================================\n\n\n lstm_24 (LSTM)              (None, 90, 90)            35640     \n\n\n                                                                 \n\n\n lstm_25 (LSTM)              (None, 90, 50)            28200     \n\n\n                                                                 \n\n\n lstm_26 (LSTM)              (None, 25)                7600      \n\n\n                                                                 \n\n\n dense_16 (Dense)            (None, 5)                 130       \n\n\n                                                                 \n\n\n dense_17 (Dense)            (None, 1)                 6         \n\n\n                                                                 \n\n\n=================================================================\n\n\nTotal params: 71,576\n\n\nTrainable params: 71,576\n\n\nNon-trainable params: 0\n\n\n_________________________________________________________________\n\n\n\n# Training the model\n# fit network\nhistory = model.fit(x_train, \n                    y_train, \n                    batch_size=1000, \n                    epochs=50, \n                    validation_data = (x_test, y_test), \n                    verbose = 0)\n\n\nplt.plot(history.history['loss'], label='train')\nplt.plot(history.history['val_loss'], label='test')\nplt.legend()\nplt.show() \n\n\n\n\n\n# Get the predicted values\npredictions = model.predict(x_test)\npredictions = scaler_pred.inverse_transform(predictions)\n\n1/3 [=========>....................] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - 0s 31ms/step\n\n\n\ny_test = y_test.reshape(-1,1)\ny_test = scaler_pred.inverse_transform(y_test)\n\n\n# Calculate the mean absolute error (MAE)\nmae = mean_absolute_error(y_test, predictions)\nprint('MAE: ' + str(round(mae, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = np.sqrt(mean_squared_error(y_test,predictions))\nprint('RMSE: ' + str(round(rmse, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = mean_squared_error(y_test, \n                          predictions,\n                          squared = False)\nprint('RMSE: ' + str(round(rmse, 1)))\n\nMAE: 301.5\nRMSE: 408.5\nRMSE: 408.5\n\n\n\n# Add the difference between the valid and predicted prices\ntrain = data_malaga[:(len(x_train)+92)]\nvalid = data_malaga[(len(x_train)+91):]\n\n\nvalid.insert(1, \"Predictions\", predictions, True)\nvalid.insert(1, \"Difference\", valid[\"Predictions\"] - valid[\"num_casos\"], True)\n\n\n# Zoom-in to a closer timeframe\n# Date from which on the date is displayed\ndisplay_start_date = \"2021-07-15\" \nvalid = valid[valid.index > display_start_date]\ntrain = train[train.index > display_start_date]\n\n\n# Visualize the data\nmatplotlib.style.use('ggplot')\nfig, ax1 = plt.subplots(figsize=(22, 10), sharex=True)\n\n# Data - Train\nxt = train.index; \nyt = train[[\"num_casos\"]]\n# Data - Test / validation \nxv = valid.index; \nyv = valid[[\"num_casos\", \"Predictions\"]]\n\n# Plot\nplt.title(\"malaga: Predictions vs Real infections\", fontsize=20)\nplt.ylabel(\"Nº Cases\", fontsize=18)\n\nplt.plot(yt, color=\"blue\", linewidth=1.5)\nplt.plot(yv[\"Predictions\"], color=\"red\", linewidth=1.5)\nplt.plot(yv[\"num_casos\"], color=\"green\", linewidth=1.5)\nplt.legend([\"Train\", \"LSTM Predictions\", \"Test\"], \n           loc=\"upper left\", fontsize=18)\n\n# Bar plot with the differences\nx = valid.index\ny = valid[\"Difference\"]\nplt.bar(x, y, width=0.2, color=\"grey\")\nplt.grid()\nplt.show()"
  },
  {
    "objectID": "lstm_multi.html#sevilla-1",
    "href": "lstm_multi.html#sevilla-1",
    "title": "LSTM multivariate prediction",
    "section": "Sevilla",
    "text": "Sevilla\n\ndata_sevilla = data_covid.loc[data_covid['provincia'] == 'Sevilla']\ndata_sevilla = data_sevilla.set_index('fecha')\ndata_sevilla = data_sevilla['2020-06-14':'2021-12-31']\ndata_sevilla = data_sevilla.filter(['num_casos', 'tmed', 'mob_grocery_pharmacy', \n'mob_parks', 'mob_residential', 'mob_residential', 'mob_transit_stations', 'mob_workplaces'])\ndata_sevilla\n\n\n\n\n\n  \n    \n      \n      num_casos\n      tmed\n      mob_grocery_pharmacy\n      mob_parks\n      mob_residential\n      mob_residential\n      mob_transit_stations\n      mob_workplaces\n    \n    \n      fecha\n      \n      \n      \n      \n      \n      \n      \n      \n    \n  \n  \n    \n      2020-06-14\n      0\n      22.200000\n      -24.0\n      -36.0\n      0.0\n      0.0\n      -51.0\n      0.0\n    \n    \n      2020-06-15\n      2\n      23.088889\n      -14.0\n      -13.0\n      9.0\n      9.0\n      -41.0\n      -33.0\n    \n    \n      2020-06-16\n      1\n      23.977778\n      -10.0\n      -4.0\n      9.0\n      9.0\n      -37.0\n      -32.0\n    \n    \n      2020-06-17\n      0\n      24.866667\n      -10.0\n      -7.0\n      9.0\n      9.0\n      -37.0\n      -32.0\n    \n    \n      2020-06-18\n      0\n      25.755556\n      -12.0\n      -13.0\n      9.0\n      9.0\n      -41.0\n      -33.0\n    \n    \n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n      ...\n    \n    \n      2021-12-27\n      2617\n      17.600000\n      16.0\n      -1.0\n      7.0\n      7.0\n      -19.0\n      -39.0\n    \n    \n      2021-12-28\n      3190\n      16.000000\n      17.0\n      15.0\n      7.0\n      7.0\n      -16.0\n      -37.0\n    \n    \n      2021-12-29\n      3692\n      14.100000\n      24.0\n      18.0\n      6.0\n      6.0\n      -18.0\n      -38.0\n    \n    \n      2021-12-30\n      3508\n      13.000000\n      39.0\n      11.0\n      6.0\n      6.0\n      -21.0\n      -39.0\n    \n    \n      2021-12-31\n      2816\n      14.600000\n      15.0\n      -24.0\n      12.0\n      12.0\n      -44.0\n      -53.0\n    \n  \n\n566 rows × 8 columns\n\n\n\n\ndata_sevilla.describe()\n\n\n\n\n\n  \n    \n      \n      num_casos\n      tmed\n      mob_grocery_pharmacy\n      mob_parks\n      mob_residential\n      mob_residential\n      mob_transit_stations\n      mob_workplaces\n    \n  \n  \n    \n      count\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n      566.000000\n    \n    \n      mean\n      383.807420\n      20.691519\n      -1.908127\n      -16.176678\n      4.086572\n      4.086572\n      -27.310954\n      -21.436396\n    \n    \n      std\n      454.714408\n      6.882766\n      18.249947\n      18.068323\n      4.554635\n      4.554635\n      14.360299\n      14.353391\n    \n    \n      min\n      0.000000\n      5.500000\n      -79.000000\n      -70.000000\n      -7.000000\n      -7.000000\n      -71.000000\n      -79.000000\n    \n    \n      25%\n      112.750000\n      15.000000\n      -10.000000\n      -28.000000\n      1.000000\n      1.000000\n      -37.000000\n      -30.000000\n    \n    \n      50%\n      260.500000\n      20.800000\n      -1.000000\n      -13.000000\n      4.000000\n      4.000000\n      -28.000000\n      -18.000000\n    \n    \n      75%\n      459.000000\n      26.575000\n      6.000000\n      -5.000000\n      7.000000\n      7.000000\n      -18.000000\n      -11.000000\n    \n    \n      max\n      3692.000000\n      34.400000\n      113.000000\n      61.000000\n      22.000000\n      22.000000\n      16.000000\n      9.000000\n    \n  \n\n\n\n\n\nnp_data_sevilla = data_sevilla.values\n\n\n# Train dataset\nscaler = MinMaxScaler(feature_range=(0, 1))\nscaled_data_sevilla = scaler.fit_transform(np_data_sevilla)\nprint(f'Longitud del conjunto de datos disponible: {len(scaled_data_sevilla)}')\n\nLongitud del conjunto de datos disponible: 566\n\n\n\n# Since we are going to predict future values based on the 90 past elements, \n# we need to create a list with those historic information for each element\nhistoric_values = 90\nscaled_data_sevilla_x = []\nscaled_data_sevilla_y = []\n\nfor i in range(historic_values, len(scaled_data_sevilla)):\n    scaled_data_sevilla_x.append(scaled_data_sevilla[(i-historic_values):i, :])\n    scaled_data_sevilla_y.append(scaled_data_sevilla[i, 0])\n\n# Convert the x_train and y_train to numpy arrays\nscaled_data_sevilla_x = np.array(scaled_data_sevilla_x)\nscaled_data_sevilla_y = np.array(scaled_data_sevilla_y)\n\n\n# Once predicted, we are going to need a exclusive scaler for num_cases\nscaler_pred = MinMaxScaler(feature_range=(0, 1))\ndf_cases_sevilla = pd.DataFrame(data_sevilla['num_casos'])\nscaled_data_sevilla_pred = scaler_pred.fit_transform(df_cases_sevilla)\n\n\n# Since the first 90th values does not have historic, the dataset has been reduced in 90 values\nprint(f'Longitud datos de entrenamiento con historico: {len(scaled_data_sevilla_y)}')\n\nLongitud datos de entrenamiento con historico: 476\n\n\n\n# we split data in train and test\n# as in previous analysis, we are going to predict a maximum of 90 days\nx_train = scaled_data_sevilla_x[0:len(scaled_data_sevilla_x)-91]\ny_train = scaled_data_sevilla_y[0:len(scaled_data_sevilla_y)-91]\nprint(f'Cantidad datos de entrenamiento: x={len(x_train)} - y={len(y_train)}')\n\nx_test = scaled_data_sevilla_x[len(scaled_data_sevilla_x)-90:len(scaled_data_sevilla_x)]\ny_test = scaled_data_sevilla_y[len(scaled_data_sevilla_y)-90:len(scaled_data_sevilla_y)]\nprint(f'Cantidad datos de test: x={len(x_test)} - y={len(y_test)}')\n\nCantidad datos de entrenamiento: x=385 - y=385\nCantidad datos de test: x=90 - y=90\n\n\n\n# Reshape the data to feed de recurrent network\nx_train = np.reshape(x_train, (x_train.shape[0], x_train.shape[1], 8))\nprint(\"Train data shape:\")\nprint(x_train.shape)\nprint(y_train.shape)\nx_test = np.reshape(x_test, (x_test.shape[0], x_test.shape[1], 8))\nprint(\"Test data shape:\")\nprint(x_test.shape)\nprint(y_test.shape)\n\nTrain data shape:\n(385, 90, 8)\n(385,)\nTest data shape:\n(90, 90, 8)\n(90,)\n\n\n\n# Configure / setup the neural network model - LSTM\n# Build the model\nprint('Build model...')\nmodel = Sequential()\n# Model with Neurons \n# Inputshape = neurons -> Timestamps\nneurons= x_train.shape[1]\nmodel.add(LSTM(90, \n               activation = 'relu',\n               return_sequences = True, \n               input_shape = (x_train.shape[1], 8))) \nmodel.add(LSTM(50, \n               activation = 'relu',\n               return_sequences = True)) \nmodel.add(LSTM(25, \n               activation = 'relu',\n               return_sequences = False)) \nmodel.add(Dense(5, activation = 'relu'))\nmodel.add(Dense(1))\n\nBuild model...\n\n\n\nmodel.compile(optimizer='adam', loss='mean_squared_error')\nmodel.summary()\n\nModel: \"sequential_9\"\n\n\n_________________________________________________________________\n\n\n Layer (type)                Output Shape              Param #   \n\n\n=================================================================\n\n\n lstm_27 (LSTM)              (None, 90, 90)            35640     \n\n\n                                                                 \n\n\n lstm_28 (LSTM)              (None, 90, 50)            28200     \n\n\n                                                                 \n\n\n lstm_29 (LSTM)              (None, 25)                7600      \n\n\n                                                                 \n\n\n dense_18 (Dense)            (None, 5)                 130       \n\n\n                                                                 \n\n\n dense_19 (Dense)            (None, 1)                 6         \n\n\n                                                                 \n\n\n=================================================================\n\n\nTotal params: 71,576\n\n\nTrainable params: 71,576\n\n\nNon-trainable params: 0\n\n\n_________________________________________________________________\n\n\n\n# Training the model\n# fit network\nhistory = model.fit(x_train, \n                    y_train, \n                    batch_size=1000, \n                    epochs=50, \n                    validation_data = (x_test, y_test), \n                    verbose = 0)\n\n\nplt.plot(history.history['loss'], label='train')\nplt.plot(history.history['val_loss'], label='test')\nplt.legend()\nplt.show() \n\n\n\n\n\n# Get the predicted values\npredictions = model.predict(x_test)\npredictions = scaler_pred.inverse_transform(predictions)\n\n1/3 [=========>....................] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - ETA: 0s\n\n\n\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b3/3 [==============================] - 0s 31ms/step\n\n\n\ny_test = y_test.reshape(-1,1)\ny_test = scaler_pred.inverse_transform(y_test)\n\n\n# Calculate the mean absolute error (MAE)\nmae = mean_absolute_error(y_test, predictions)\nprint('MAE: ' + str(round(mae, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = np.sqrt(mean_squared_error(y_test,predictions))\nprint('RMSE: ' + str(round(rmse, 1)))\n\n# Calculate the root mean squarred error (RMSE)\nrmse = mean_squared_error(y_test, \n                          predictions,\n                          squared = False)\nprint('RMSE: ' + str(round(rmse, 1)))\n\nMAE: 502.2\nRMSE: 535.4\nRMSE: 535.4\n\n\n\n# Add the difference between the valid and predicted prices\ntrain = data_sevilla[:(len(x_train)+92)]\nvalid = data_sevilla[(len(x_train)+91):]\n\n\nvalid.insert(1, \"Predictions\", predictions, True)\nvalid.insert(1, \"Difference\", valid[\"Predictions\"] - valid[\"num_casos\"], True)\n\n\n# Zoom-in to a closer timeframe\n# Date from which on the date is displayed\ndisplay_start_date = \"2021-07-15\" \nvalid = valid[valid.index > display_start_date]\ntrain = train[train.index > display_start_date]\n\n\n# Visualize the data\nmatplotlib.style.use('ggplot')\nfig, ax1 = plt.subplots(figsize=(22, 10), sharex=True)\n\n# Data - Train\nxt = train.index; \nyt = train[[\"num_casos\"]]\n# Data - Test / validation \nxv = valid.index; \nyv = valid[[\"num_casos\", \"Predictions\"]]\n\n# Plot\nplt.title(\"sevilla: Predictions vs Real infections\", fontsize=20)\nplt.ylabel(\"Nº Cases\", fontsize=18)\n\nplt.plot(yt, color=\"blue\", linewidth=1.5)\nplt.plot(yv[\"Predictions\"], color=\"red\", linewidth=1.5)\nplt.plot(yv[\"num_casos\"], color=\"green\", linewidth=1.5)\nplt.legend([\"Train\", \"LSTM Predictions\", \"Test\"], \n           loc=\"upper left\", fontsize=18)\n\n# Bar plot with the differences\nx = valid.index\ny = valid[\"Difference\"]\nplt.bar(x, y, width=0.2, color=\"grey\")\nplt.grid()\nplt.show()"
  }
]