<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.442">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>PEC3 - COVID-19 Outbreak prediction - LSTM multivariate prediction</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<link href="./references.html" rel="next">
<link href="./lstm_uni.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link id="quarto-text-highlighting-styles" href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">LSTM multivariate prediction</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">PEC3 - COVID-19 Outbreak prediction</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/jperezord/jperezord.github.io.git" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Welcome</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">Introduction</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./data.html" class="sidebar-item-text sidebar-link">Task 1: Data acquisition and exploration</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cne_data.html" class="sidebar-item-text sidebar-link">CNE data</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ine_data.html" class="sidebar-item-text sidebar-link">INE data</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./google_data.html" class="sidebar-item-text sidebar-link">GOOGLE data</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./aemet_data.html" class="sidebar-item-text sidebar-link">AEMET data</a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./combination.html" class="sidebar-item-text sidebar-link">Task 2: Datasets combination</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visual.html" class="sidebar-item-text sidebar-link">Task 3: Visual analysis</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visual_demo.html" class="sidebar-item-text sidebar-link">Task 4: Visual demographic analysis</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./arima.html" class="sidebar-item-text sidebar-link">Task 5: ARIMA</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./acf.html" class="sidebar-item-text sidebar-link">ACF and PACF plots</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./stl.html" class="sidebar-item-text sidebar-link">STL decomposition / Transformations</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./univariate.html" class="sidebar-item-text sidebar-link">Univariate prediction</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multivariate_temp.html" class="sidebar-item-text sidebar-link">Multivariate (temperature) prediction</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multivariate.html" class="sidebar-item-text sidebar-link">Multivariate (INE mobility + temp) prediction</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multivariate_google.html" class="sidebar-item-text sidebar-link">Multivariate (Google mobility + temp) prediction</a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a href="./lstm.html" class="sidebar-item-text sidebar-link">Task 6: LSTM</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lstm_uni.html" class="sidebar-item-text sidebar-link">LSTM univariate prediction</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lstm_multi.html" class="sidebar-item-text sidebar-link active">LSTM multivariate prediction</a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#all-the-available-data" id="toc-all-the-available-data" class="nav-link active" data-scroll-target="#all-the-available-data">All the available data</a>
  <ul class="collapse">
  <li><a href="#asturias" id="toc-asturias" class="nav-link" data-scroll-target="#asturias">Asturias</a></li>
  <li><a href="#barcelona" id="toc-barcelona" class="nav-link" data-scroll-target="#barcelona">Barcelona</a></li>
  <li><a href="#madrid" id="toc-madrid" class="nav-link" data-scroll-target="#madrid">Madrid</a></li>
  <li><a href="#málaga" id="toc-málaga" class="nav-link" data-scroll-target="#málaga">Málaga</a></li>
  <li><a href="#sevilla" id="toc-sevilla" class="nav-link" data-scroll-target="#sevilla">Sevilla</a></li>
  </ul></li>
  <li><a href="#just-before-the-sixth-wave" id="toc-just-before-the-sixth-wave" class="nav-link" data-scroll-target="#just-before-the-sixth-wave">Just before the sixth wave</a>
  <ul class="collapse">
  <li><a href="#asturias-1" id="toc-asturias-1" class="nav-link" data-scroll-target="#asturias-1">Asturias</a></li>
  <li><a href="#barcelona-1" id="toc-barcelona-1" class="nav-link" data-scroll-target="#barcelona-1">Barcelona</a></li>
  <li><a href="#madrid-1" id="toc-madrid-1" class="nav-link" data-scroll-target="#madrid-1">Madrid</a></li>
  <li><a href="#málaga-1" id="toc-málaga-1" class="nav-link" data-scroll-target="#málaga-1">Málaga</a></li>
  <li><a href="#sevilla-1" id="toc-sevilla-1" class="nav-link" data-scroll-target="#sevilla-1">Sevilla</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">LSTM multivariate prediction</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<p>Import python packages:</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> MinMaxScaler</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_absolute_error, mean_squared_error</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras <span class="im">import</span> Input</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.models <span class="im">import</span> Sequential</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> Dense, LSTM</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers.core <span class="im">import</span> Dense, Activation, Dropout</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>data_covid <span class="op">=</span> pd.read_csv(<span class="st">'data/clean/final_covid_data.csv'</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>data_covid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>provincia</th>
      <th>fecha</th>
      <th>num_casos</th>
      <th>num_casos_prueba_pcr</th>
      <th>num_casos_prueba_test_ac</th>
      <th>num_casos_prueba_ag</th>
      <th>num_casos_prueba_elisa</th>
      <th>num_casos_prueba_desconocida</th>
      <th>num_hosp</th>
      <th>num_uci</th>
      <th>...</th>
      <th>ws</th>
      <th>ws_max</th>
      <th>sol</th>
      <th>mob_grocery_pharmacy</th>
      <th>mob_parks</th>
      <th>mob_residential</th>
      <th>mob_retail_recreation</th>
      <th>mob_transit_stations</th>
      <th>mob_workplaces</th>
      <th>mob_flujo</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Barcelona</td>
      <td>2020-01-01</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>2.5</td>
      <td>7.2</td>
      <td>4.9</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Madrid</td>
      <td>2020-01-01</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>...</td>
      <td>0.8</td>
      <td>3.6</td>
      <td>8.3</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Málaga</td>
      <td>2020-01-01</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>3.3</td>
      <td>6.7</td>
      <td>7.7</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Asturias</td>
      <td>2020-01-01</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>2.5</td>
      <td>7.8</td>
      <td>7.9</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Sevilla</td>
      <td>2020-01-01</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>...</td>
      <td>1.9</td>
      <td>5.8</td>
      <td>9.1</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>4090</th>
      <td>Barcelona</td>
      <td>2022-03-29</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>7.2</td>
      <td>13.3</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-13.0</td>
      <td>5.0</td>
      <td>-24.0</td>
      <td>-16.0</td>
      <td>-17.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4091</th>
      <td>Madrid</td>
      <td>2022-03-29</td>
      <td>6</td>
      <td>3</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>2.2</td>
      <td>6.1</td>
      <td>2.4</td>
      <td>1.0</td>
      <td>-11.0</td>
      <td>4.0</td>
      <td>-25.0</td>
      <td>-16.0</td>
      <td>-16.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4092</th>
      <td>Málaga</td>
      <td>2022-03-29</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>4.2</td>
      <td>10.8</td>
      <td>1.5</td>
      <td>4.0</td>
      <td>-3.0</td>
      <td>4.0</td>
      <td>-16.0</td>
      <td>1.0</td>
      <td>-8.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4093</th>
      <td>Asturias</td>
      <td>2022-03-29</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>...</td>
      <td>2.2</td>
      <td>6.7</td>
      <td>0.0</td>
      <td>-4.0</td>
      <td>17.0</td>
      <td>3.0</td>
      <td>-25.0</td>
      <td>-15.0</td>
      <td>-12.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4094</th>
      <td>Sevilla</td>
      <td>2022-03-29</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>2.5</td>
      <td>8.3</td>
      <td>1.6</td>
      <td>3.0</td>
      <td>-7.0</td>
      <td>2.0</td>
      <td>-15.0</td>
      <td>-13.0</td>
      <td>-5.0</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>4095 rows × 26 columns</p>
</div>
</div>
</div>
<section id="all-the-available-data" class="level1">
<h1>All the available data</h1>
<section id="asturias" class="level2">
<h2 class="anchored" data-anchor-id="asturias">Asturias</h2>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>data_asturias <span class="op">=</span> data_covid.loc[data_covid[<span class="st">'provincia'</span>] <span class="op">==</span> <span class="st">'Asturias'</span>]</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>data_asturias <span class="op">=</span> data_asturias.set_index(<span class="st">'fecha'</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>data_asturias <span class="op">=</span> data_asturias[<span class="st">'2020-06-14'</span>:]</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>data_asturias <span class="op">=</span> data_asturias.<span class="bu">filter</span>([<span class="st">'num_casos'</span>, <span class="st">'tmed'</span>, <span class="st">'mob_grocery_pharmacy'</span>, </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="st">'mob_parks'</span>, <span class="st">'mob_residential'</span>, <span class="st">'mob_residential'</span>, <span class="st">'mob_transit_stations'</span>, <span class="st">'mob_workplaces'</span>])</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>data_asturias</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
      <th>tmed</th>
      <th>mob_grocery_pharmacy</th>
      <th>mob_parks</th>
      <th>mob_residential</th>
      <th>mob_residential</th>
      <th>mob_transit_stations</th>
      <th>mob_workplaces</th>
    </tr>
    <tr>
      <th>fecha</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-14</th>
      <td>0</td>
      <td>16.8</td>
      <td>-8.0</td>
      <td>6.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>-43.0</td>
      <td>-2.0</td>
    </tr>
    <tr>
      <th>2020-06-15</th>
      <td>0</td>
      <td>16.0</td>
      <td>-6.0</td>
      <td>39.0</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>-38.0</td>
      <td>-27.0</td>
    </tr>
    <tr>
      <th>2020-06-16</th>
      <td>1</td>
      <td>15.6</td>
      <td>-6.0</td>
      <td>7.0</td>
      <td>9.0</td>
      <td>9.0</td>
      <td>-43.0</td>
      <td>-29.0</td>
    </tr>
    <tr>
      <th>2020-06-17</th>
      <td>0</td>
      <td>15.6</td>
      <td>-7.0</td>
      <td>20.0</td>
      <td>8.0</td>
      <td>8.0</td>
      <td>-42.0</td>
      <td>-28.0</td>
    </tr>
    <tr>
      <th>2020-06-18</th>
      <td>0</td>
      <td>15.1</td>
      <td>-4.0</td>
      <td>68.0</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>-39.0</td>
      <td>-28.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2022-03-25</th>
      <td>244</td>
      <td>11.6</td>
      <td>-2.0</td>
      <td>24.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>-13.0</td>
      <td>-12.0</td>
    </tr>
    <tr>
      <th>2022-03-26</th>
      <td>432</td>
      <td>12.0</td>
      <td>-13.0</td>
      <td>27.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>-19.0</td>
      <td>-13.0</td>
    </tr>
    <tr>
      <th>2022-03-27</th>
      <td>1</td>
      <td>14.2</td>
      <td>-7.5</td>
      <td>33.0</td>
      <td>-1.0</td>
      <td>-1.0</td>
      <td>-13.0</td>
      <td>-11.0</td>
    </tr>
    <tr>
      <th>2022-03-28</th>
      <td>9</td>
      <td>13.8</td>
      <td>-2.0</td>
      <td>45.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>-9.0</td>
      <td>-10.0</td>
    </tr>
    <tr>
      <th>2022-03-29</th>
      <td>0</td>
      <td>11.7</td>
      <td>-4.0</td>
      <td>17.0</td>
      <td>3.0</td>
      <td>3.0</td>
      <td>-15.0</td>
      <td>-12.0</td>
    </tr>
  </tbody>
</table>
<p>654 rows × 8 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>data_asturias.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
      <th>tmed</th>
      <th>mob_grocery_pharmacy</th>
      <th>mob_parks</th>
      <th>mob_residential</th>
      <th>mob_residential</th>
      <th>mob_transit_stations</th>
      <th>mob_workplaces</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>654.00000</td>
      <td>654.000000</td>
      <td>654.00000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>312.11315</td>
      <td>13.909098</td>
      <td>3.83792</td>
      <td>57.725535</td>
      <td>3.695719</td>
      <td>3.695719</td>
      <td>-12.614679</td>
      <td>-20.651376</td>
    </tr>
    <tr>
      <th>std</th>
      <td>565.17985</td>
      <td>4.198047</td>
      <td>15.05797</td>
      <td>68.024228</td>
      <td>4.802763</td>
      <td>4.802763</td>
      <td>14.838430</td>
      <td>12.754756</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.00000</td>
      <td>3.300000</td>
      <td>-87.00000</td>
      <td>-63.000000</td>
      <td>-8.000000</td>
      <td>-8.000000</td>
      <td>-67.000000</td>
      <td>-80.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>43.50000</td>
      <td>10.800000</td>
      <td>-0.50000</td>
      <td>13.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>-22.000000</td>
      <td>-26.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>117.00000</td>
      <td>13.900000</td>
      <td>5.00000</td>
      <td>39.000000</td>
      <td>3.000000</td>
      <td>3.000000</td>
      <td>-13.000000</td>
      <td>-18.500000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>323.75000</td>
      <td>17.600000</td>
      <td>10.00000</td>
      <td>83.500000</td>
      <td>6.000000</td>
      <td>6.000000</td>
      <td>-4.000000</td>
      <td>-14.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>3827.00000</td>
      <td>25.100000</td>
      <td>42.00000</td>
      <td>333.000000</td>
      <td>26.000000</td>
      <td>26.000000</td>
      <td>26.000000</td>
      <td>12.000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>np_data_asturias <span class="op">=</span> data_asturias.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train dataset</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias <span class="op">=</span> scaler.fit_transform(np_data_asturias)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud del conjunto de datos disponible: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_asturias)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud del conjunto de datos disponible: 654</code></pre>
</div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we are going to predict future values based on the 90 past elements, </span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to create a list with those historic information for each element</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>historic_values <span class="op">=</span> <span class="dv">90</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias_x <span class="op">=</span> []</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias_y <span class="op">=</span> []</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(historic_values, <span class="bu">len</span>(scaled_data_asturias)):</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    scaled_data_asturias_x.append(scaled_data_asturias[(i<span class="op">-</span>historic_values):i, :])</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    scaled_data_asturias_y.append(scaled_data_asturias[i, <span class="dv">0</span>])</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the x_train and y_train to numpy arrays</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias_x <span class="op">=</span> np.array(scaled_data_asturias_x)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias_y <span class="op">=</span> np.array(scaled_data_asturias_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Once predicted, we are going to need a exclusive scaler for num_cases</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>scaler_pred <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>df_cases_asturias <span class="op">=</span> pd.DataFrame(data_asturias[<span class="st">'num_casos'</span>])</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias_pred <span class="op">=</span> scaler_pred.fit_transform(df_cases_asturias)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since the first 90th values does not have historic, the dataset has been reduced in 90 values</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud datos de entrenamiento con historico: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_asturias_y)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud datos de entrenamiento con historico: 564</code></pre>
</div>
</div>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we split data in train and test</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as in previous analysis, we are going to predict a maximum of 90 days</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> scaled_data_asturias_x[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_asturias_x)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> scaled_data_asturias_y[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_asturias_y)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de entrenamiento: x=</span><span class="sc">{</span><span class="bu">len</span>(x_train)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> scaled_data_asturias_x[<span class="bu">len</span>(scaled_data_asturias_x)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_asturias_x)]</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaled_data_asturias_y[<span class="bu">len</span>(scaled_data_asturias_y)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_asturias_y)]</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de test: x=</span><span class="sc">{</span><span class="bu">len</span>(x_test)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_test)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cantidad datos de entrenamiento: x=473 - y=473
Cantidad datos de test: x=90 - y=90</code></pre>
</div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data to feed de recurrent network</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> np.reshape(x_train, (x_train.shape[<span class="dv">0</span>], x_train.shape[<span class="dv">1</span>], <span class="dv">8</span>))</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train data shape:"</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_train.shape)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_train.shape)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> np.reshape(x_test, (x_test.shape[<span class="dv">0</span>], x_test.shape[<span class="dv">1</span>], <span class="dv">8</span>))</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test data shape:"</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_test.shape)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train data shape:
(473, 90, 8)
(473,)
Test data shape:
(90, 90, 8)
(90,)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure / setup the neural network model - LSTM</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the model</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Build model...'</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with Neurons </span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputshape = neurons -&gt; Timestamps</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>neurons<span class="op">=</span> x_train.shape[<span class="dv">1</span>]</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">90</span>, </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>, </span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>               input_shape <span class="op">=</span> (x_train.shape[<span class="dv">1</span>], <span class="dv">8</span>))) </span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">50</span>, </span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>)) </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">25</span>, </span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">False</span>)) </span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">5</span>, activation <span class="op">=</span> <span class="st">'relu'</span>))</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Build model...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2022-05-25 01:28:48.052818: I tensorflow/core/platform/cpu_feature_guard.cc:193] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.</code></pre>
</div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mean_squared_error'</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "sequential"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Layer (type)                Output Shape              Param #   </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm (LSTM)                 (None, 90, 90)            35640     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_1 (LSTM)               (None, 90, 50)            28200     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_2 (LSTM)               (None, 25)                7600      </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense (Dense)               (None, 5)                 130       </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_1 (Dense)             (None, 1)                 6         </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Total params: 71,576</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Trainable params: 71,576</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Non-trainable params: 0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fit network</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(x_train, </span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>                    y_train, </span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>                    batch_size<span class="op">=</span><span class="dv">1000</span>, </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>                    epochs<span class="op">=</span><span class="dv">30</span>, </span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>                    validation_data <span class="op">=</span> (x_test, y_test), </span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>                    verbose <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'loss'</span>], label<span class="op">=</span><span class="st">'train'</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'val_loss'</span>], label<span class="op">=</span><span class="st">'test'</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>plt.show() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_multi_files/figure-html/cell-16-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predicted values</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.predict(x_test)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> scaler_pred.inverse_transform(predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1/3 [=========&gt;....................] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - 0s 30ms/step</code></pre>
</div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y_test.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaler_pred.inverse_transform(y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean absolute error (MAE)</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, predictions)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MAE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(mae, <span class="dv">1</span>)))</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test,predictions))</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> mean_squared_error(y_test, </span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>                          predictions,</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>                          squared <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE: 738.5
RMSE: 1169.8
RMSE: 1169.8</code></pre>
</div>
</div>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the difference between the valid and predicted prices</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> data_asturias[:(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">92</span>)]</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> data_asturias[(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">91</span>):]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Predictions"</span>, predictions, <span class="va">True</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Difference"</span>, valid[<span class="st">"Predictions"</span>] <span class="op">-</span> valid[<span class="st">"num_casos"</span>], <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Zoom-in to a closer timeframe</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Date from which on the date is displayed</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>display_start_date <span class="op">=</span> <span class="st">"2021-10-31"</span> </span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> valid[valid.index <span class="op">&gt;</span> display_start_date]</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> train[train.index <span class="op">&gt;</span> display_start_date]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the data</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>matplotlib.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">22</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Train</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> train.index<span class="op">;</span> </span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> train[[<span class="st">"num_casos"</span>]]</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Test / validation </span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>xv <span class="op">=</span> valid.index<span class="op">;</span> </span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>yv <span class="op">=</span> valid[[<span class="st">"num_casos"</span>, <span class="st">"Predictions"</span>]]</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Asturias: Predictions vs Real infections"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Nº Cases"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>plt.plot(yt, color<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"Predictions"</span>], color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"num_casos"</span>], color<span class="op">=</span><span class="st">"green"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"LSTM Predictions"</span>, <span class="st">"Test"</span>], </span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>           loc<span class="op">=</span><span class="st">"upper left"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot with the differences</span></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> valid.index</span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> valid[<span class="st">"Difference"</span>]</span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>plt.bar(x, y, width<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">"grey"</span>)</span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_multi_files/figure-html/cell-23-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="barcelona" class="level2">
<h2 class="anchored" data-anchor-id="barcelona">Barcelona</h2>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>data_barcelona <span class="op">=</span> data_covid.loc[data_covid[<span class="st">'provincia'</span>] <span class="op">==</span> <span class="st">'Barcelona'</span>]</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>data_barcelona <span class="op">=</span> data_barcelona.set_index(<span class="st">'fecha'</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>data_barcelona <span class="op">=</span> data_barcelona[<span class="st">'2020-06-14'</span>:]</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>data_barcelona <span class="op">=</span> data_barcelona.<span class="bu">filter</span>([<span class="st">'num_casos'</span>, <span class="st">'tmed'</span>, <span class="st">'mob_grocery_pharmacy'</span>, </span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="st">'mob_parks'</span>, <span class="st">'mob_residential'</span>, <span class="st">'mob_residential'</span>, <span class="st">'mob_transit_stations'</span>, <span class="st">'mob_workplaces'</span>])</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>data_barcelona</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
      <th>tmed</th>
      <th>mob_grocery_pharmacy</th>
      <th>mob_parks</th>
      <th>mob_residential</th>
      <th>mob_residential</th>
      <th>mob_transit_stations</th>
      <th>mob_workplaces</th>
    </tr>
    <tr>
      <th>fecha</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-14</th>
      <td>33</td>
      <td>20.6</td>
      <td>-20.0</td>
      <td>15.0</td>
      <td>6.0</td>
      <td>6.0</td>
      <td>-31.0</td>
      <td>-6.0</td>
    </tr>
    <tr>
      <th>2020-06-15</th>
      <td>62</td>
      <td>21.2</td>
      <td>-9.0</td>
      <td>17.0</td>
      <td>14.0</td>
      <td>14.0</td>
      <td>-34.0</td>
      <td>-41.0</td>
    </tr>
    <tr>
      <th>2020-06-16</th>
      <td>66</td>
      <td>20.8</td>
      <td>-10.0</td>
      <td>-16.0</td>
      <td>16.0</td>
      <td>16.0</td>
      <td>-39.0</td>
      <td>-41.0</td>
    </tr>
    <tr>
      <th>2020-06-17</th>
      <td>70</td>
      <td>20.3</td>
      <td>-4.0</td>
      <td>14.0</td>
      <td>15.0</td>
      <td>15.0</td>
      <td>-33.0</td>
      <td>-40.0</td>
    </tr>
    <tr>
      <th>2020-06-18</th>
      <td>68</td>
      <td>18.8</td>
      <td>-8.0</td>
      <td>-6.0</td>
      <td>16.0</td>
      <td>16.0</td>
      <td>-38.0</td>
      <td>-41.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2022-03-25</th>
      <td>598</td>
      <td>14.4</td>
      <td>3.0</td>
      <td>-11.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>-18.0</td>
      <td>-16.0</td>
    </tr>
    <tr>
      <th>2022-03-26</th>
      <td>345</td>
      <td>12.8</td>
      <td>-11.0</td>
      <td>-33.0</td>
      <td>3.0</td>
      <td>3.0</td>
      <td>-22.0</td>
      <td>-12.0</td>
    </tr>
    <tr>
      <th>2022-03-27</th>
      <td>252</td>
      <td>15.6</td>
      <td>-10.0</td>
      <td>-3.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-12.0</td>
      <td>-10.0</td>
    </tr>
    <tr>
      <th>2022-03-28</th>
      <td>688</td>
      <td>14.0</td>
      <td>-1.0</td>
      <td>-2.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>-15.0</td>
      <td>-15.0</td>
    </tr>
    <tr>
      <th>2022-03-29</th>
      <td>0</td>
      <td>13.0</td>
      <td>0.0</td>
      <td>-13.0</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>-16.0</td>
      <td>-17.0</td>
    </tr>
  </tbody>
</table>
<p>654 rows × 8 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>data_barcelona.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
      <th>tmed</th>
      <th>mob_grocery_pharmacy</th>
      <th>mob_parks</th>
      <th>mob_residential</th>
      <th>mob_residential</th>
      <th>mob_transit_stations</th>
      <th>mob_workplaces</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>2605.048930</td>
      <td>17.294801</td>
      <td>0.180428</td>
      <td>-5.547401</td>
      <td>7.178899</td>
      <td>7.178899</td>
      <td>-24.041284</td>
      <td>-27.391437</td>
    </tr>
    <tr>
      <th>std</th>
      <td>4823.001644</td>
      <td>6.163636</td>
      <td>16.568328</td>
      <td>15.365483</td>
      <td>5.019727</td>
      <td>5.019727</td>
      <td>11.241460</td>
      <td>15.949374</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
      <td>4.300000</td>
      <td>-83.000000</td>
      <td>-76.000000</td>
      <td>-6.000000</td>
      <td>-6.000000</td>
      <td>-72.000000</td>
      <td>-87.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>597.250000</td>
      <td>12.200000</td>
      <td>-7.000000</td>
      <td>-15.000000</td>
      <td>4.000000</td>
      <td>4.000000</td>
      <td>-32.000000</td>
      <td>-34.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>1030.500000</td>
      <td>16.300000</td>
      <td>2.000000</td>
      <td>-5.000000</td>
      <td>7.000000</td>
      <td>7.000000</td>
      <td>-24.000000</td>
      <td>-25.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>2243.750000</td>
      <td>23.600000</td>
      <td>10.000000</td>
      <td>6.000000</td>
      <td>10.000000</td>
      <td>10.000000</td>
      <td>-15.000000</td>
      <td>-18.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>34701.000000</td>
      <td>28.400000</td>
      <td>58.000000</td>
      <td>33.000000</td>
      <td>32.000000</td>
      <td>32.000000</td>
      <td>-2.000000</td>
      <td>6.000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>np_data_barcelona <span class="op">=</span> data_barcelona.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train dataset</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>scaled_data_barcelona <span class="op">=</span> scaler.fit_transform(np_data_barcelona)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud del conjunto de datos disponible: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_barcelona)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud del conjunto de datos disponible: 654</code></pre>
</div>
</div>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we are going to predict future values based on the 90 past elements, </span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to create a list with those historic information for each element</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>historic_values <span class="op">=</span> <span class="dv">90</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>scaled_data_barcelona_x <span class="op">=</span> []</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>scaled_data_barcelona_y <span class="op">=</span> []</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(historic_values, <span class="bu">len</span>(scaled_data_barcelona)):</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    scaled_data_barcelona_x.append(scaled_data_barcelona[(i<span class="op">-</span>historic_values):i, :])</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    scaled_data_barcelona_y.append(scaled_data_barcelona[i, <span class="dv">0</span>])</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the x_train and y_train to numpy arrays</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>scaled_data_barcelona_x <span class="op">=</span> np.array(scaled_data_barcelona_x)</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>scaled_data_barcelona_y <span class="op">=</span> np.array(scaled_data_barcelona_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Once predicted, we are going to need a exclusive scaler for num_cases</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>scaler_pred <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>df_cases_barcelona <span class="op">=</span> pd.DataFrame(data_barcelona[<span class="st">'num_casos'</span>])</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>scaled_data_barcelona_pred <span class="op">=</span> scaler_pred.fit_transform(df_cases_barcelona)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since the first 90th values does not have historic, the dataset has been reduced in 90 values</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud datos de entrenamiento con historico: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_barcelona_y)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud datos de entrenamiento con historico: 564</code></pre>
</div>
</div>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we split data in train and test</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as in previous analysis, we are going to predict a maximum of 90 days</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> scaled_data_barcelona_x[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_barcelona_x)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> scaled_data_barcelona_y[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_barcelona_y)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de entrenamiento: x=</span><span class="sc">{</span><span class="bu">len</span>(x_train)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> scaled_data_barcelona_x[<span class="bu">len</span>(scaled_data_barcelona_x)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_barcelona_x)]</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaled_data_barcelona_y[<span class="bu">len</span>(scaled_data_barcelona_y)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_barcelona_y)]</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de test: x=</span><span class="sc">{</span><span class="bu">len</span>(x_test)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_test)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cantidad datos de entrenamiento: x=473 - y=473
Cantidad datos de test: x=90 - y=90</code></pre>
</div>
</div>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data to feed de recurrent network</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> np.reshape(x_train, (x_train.shape[<span class="dv">0</span>], x_train.shape[<span class="dv">1</span>], <span class="dv">8</span>))</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train data shape:"</span>)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_train.shape)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_train.shape)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> np.reshape(x_test, (x_test.shape[<span class="dv">0</span>], x_test.shape[<span class="dv">1</span>], <span class="dv">8</span>))</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test data shape:"</span>)</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_test.shape)</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train data shape:
(473, 90, 8)
(473,)
Test data shape:
(90, 90, 8)
(90,)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure / setup the neural network model - LSTM</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the model</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Build model...'</span>)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with Neurons </span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputshape = neurons -&gt; Timestamps</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>neurons<span class="op">=</span> x_train.shape[<span class="dv">1</span>]</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">90</span>, </span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>, </span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>               input_shape <span class="op">=</span> (x_train.shape[<span class="dv">1</span>], <span class="dv">8</span>))) </span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">50</span>, </span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>)) </span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">25</span>, </span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">False</span>)) </span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">5</span>, activation <span class="op">=</span> <span class="st">'relu'</span>))</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Build model...</code></pre>
</div>
</div>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mean_squared_error'</span>)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "sequential_1"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Layer (type)                Output Shape              Param #   </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_3 (LSTM)               (None, 90, 90)            35640     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_4 (LSTM)               (None, 90, 50)            28200     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_5 (LSTM)               (None, 25)                7600      </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_2 (Dense)             (None, 5)                 130       </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_3 (Dense)             (None, 1)                 6         </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Total params: 71,576</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Trainable params: 71,576</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Non-trainable params: 0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
</div>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fit network</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(x_train, </span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>                    y_train, </span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>                    batch_size<span class="op">=</span><span class="dv">1000</span>, </span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>                    epochs<span class="op">=</span><span class="dv">30</span>, </span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>                    validation_data <span class="op">=</span> (x_test, y_test), </span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>                    verbose <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'loss'</span>], label<span class="op">=</span><span class="st">'train'</span>)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'val_loss'</span>], label<span class="op">=</span><span class="st">'test'</span>)</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>plt.show() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_multi_files/figure-html/cell-36-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predicted values</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.predict(x_test)</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> scaler_pred.inverse_transform(predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1/3 [=========&gt;....................] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - 0s 31ms/step</code></pre>
</div>
</div>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y_test.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaler_pred.inverse_transform(y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean absolute error (MAE)</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, predictions)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MAE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(mae, <span class="dv">1</span>)))</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test,predictions))</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> mean_squared_error(y_test, </span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>                          predictions,</span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>                          squared <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE: 6872.2
RMSE: 11041.0
RMSE: 11041.0</code></pre>
</div>
</div>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the difference between the valid and predicted prices</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> data_barcelona[:(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">92</span>)]</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> data_barcelona[(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">91</span>):]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Predictions"</span>, predictions, <span class="va">True</span>)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Difference"</span>, valid[<span class="st">"Predictions"</span>] <span class="op">-</span> valid[<span class="st">"num_casos"</span>], <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Zoom-in to a closer timeframe</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Date from which on the date is displayed</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>display_start_date <span class="op">=</span> <span class="st">"2021-10-31"</span> </span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> valid[valid.index <span class="op">&gt;</span> display_start_date]</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> train[train.index <span class="op">&gt;</span> display_start_date]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the data</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>matplotlib.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">22</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Train</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> train.index<span class="op">;</span> </span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> train[[<span class="st">"num_casos"</span>]]</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Test / validation </span></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>xv <span class="op">=</span> valid.index<span class="op">;</span> </span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>yv <span class="op">=</span> valid[[<span class="st">"num_casos"</span>, <span class="st">"Predictions"</span>]]</span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"barcelona: Predictions vs Real infections"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Nº Cases"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a>plt.plot(yt, color<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"Predictions"</span>], color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"num_casos"</span>], color<span class="op">=</span><span class="st">"green"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb99-19"><a href="#cb99-19" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"LSTM Predictions"</span>, <span class="st">"Test"</span>], </span>
<span id="cb99-20"><a href="#cb99-20" aria-hidden="true" tabindex="-1"></a>           loc<span class="op">=</span><span class="st">"upper left"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb99-21"><a href="#cb99-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-22"><a href="#cb99-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot with the differences</span></span>
<span id="cb99-23"><a href="#cb99-23" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> valid.index</span>
<span id="cb99-24"><a href="#cb99-24" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> valid[<span class="st">"Difference"</span>]</span>
<span id="cb99-25"><a href="#cb99-25" aria-hidden="true" tabindex="-1"></a>plt.bar(x, y, width<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">"grey"</span>)</span>
<span id="cb99-26"><a href="#cb99-26" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb99-27"><a href="#cb99-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_multi_files/figure-html/cell-43-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="madrid" class="level2">
<h2 class="anchored" data-anchor-id="madrid">Madrid</h2>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>data_madrid <span class="op">=</span> data_covid.loc[data_covid[<span class="st">'provincia'</span>] <span class="op">==</span> <span class="st">'Madrid'</span>]</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>data_madrid <span class="op">=</span> data_madrid.set_index(<span class="st">'fecha'</span>)</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>data_madrid <span class="op">=</span> data_madrid[<span class="st">'2020-06-14'</span>:]</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>data_madrid <span class="op">=</span> data_madrid.<span class="bu">filter</span>([<span class="st">'num_casos'</span>, <span class="st">'tmed'</span>, <span class="st">'mob_grocery_pharmacy'</span>, </span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a><span class="st">'mob_parks'</span>, <span class="st">'mob_residential'</span>, <span class="st">'mob_residential'</span>, <span class="st">'mob_transit_stations'</span>, <span class="st">'mob_workplaces'</span>])</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>data_madrid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
      <th>tmed</th>
      <th>mob_grocery_pharmacy</th>
      <th>mob_parks</th>
      <th>mob_residential</th>
      <th>mob_residential</th>
      <th>mob_transit_stations</th>
      <th>mob_workplaces</th>
    </tr>
    <tr>
      <th>fecha</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-14</th>
      <td>81</td>
      <td>19.0</td>
      <td>-15.0</td>
      <td>25.0</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>-43.0</td>
      <td>-6.0</td>
    </tr>
    <tr>
      <th>2020-06-15</th>
      <td>153</td>
      <td>20.7</td>
      <td>-8.0</td>
      <td>34.0</td>
      <td>16.0</td>
      <td>16.0</td>
      <td>-43.0</td>
      <td>-47.0</td>
    </tr>
    <tr>
      <th>2020-06-16</th>
      <td>91</td>
      <td>21.0</td>
      <td>-8.0</td>
      <td>21.0</td>
      <td>17.0</td>
      <td>17.0</td>
      <td>-43.0</td>
      <td>-47.0</td>
    </tr>
    <tr>
      <th>2020-06-17</th>
      <td>93</td>
      <td>20.2</td>
      <td>-5.0</td>
      <td>34.0</td>
      <td>17.0</td>
      <td>17.0</td>
      <td>-42.0</td>
      <td>-47.0</td>
    </tr>
    <tr>
      <th>2020-06-18</th>
      <td>85</td>
      <td>21.9</td>
      <td>-7.0</td>
      <td>30.0</td>
      <td>16.0</td>
      <td>16.0</td>
      <td>-44.0</td>
      <td>-47.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2022-03-25</th>
      <td>356</td>
      <td>11.0</td>
      <td>-1.0</td>
      <td>-37.0</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>-19.0</td>
      <td>-17.0</td>
    </tr>
    <tr>
      <th>2022-03-26</th>
      <td>303</td>
      <td>10.4</td>
      <td>-7.0</td>
      <td>-27.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>-15.0</td>
      <td>-5.0</td>
    </tr>
    <tr>
      <th>2022-03-27</th>
      <td>77</td>
      <td>10.6</td>
      <td>-3.0</td>
      <td>-17.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-17.0</td>
      <td>-2.0</td>
    </tr>
    <tr>
      <th>2022-03-28</th>
      <td>839</td>
      <td>10.2</td>
      <td>2.0</td>
      <td>-3.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>-15.0</td>
      <td>-17.0</td>
    </tr>
    <tr>
      <th>2022-03-29</th>
      <td>6</td>
      <td>13.0</td>
      <td>1.0</td>
      <td>-11.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>-16.0</td>
      <td>-16.0</td>
    </tr>
  </tbody>
</table>
<p>654 rows × 8 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>data_madrid.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
      <th>tmed</th>
      <th>mob_grocery_pharmacy</th>
      <th>mob_parks</th>
      <th>mob_residential</th>
      <th>mob_residential</th>
      <th>mob_transit_stations</th>
      <th>mob_workplaces</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>2392.562691</td>
      <td>14.909786</td>
      <td>-2.608563</td>
      <td>-4.874618</td>
      <td>6.978593</td>
      <td>6.978593</td>
      <td>-30.003058</td>
      <td>-27.324159</td>
    </tr>
    <tr>
      <th>std</th>
      <td>3390.272836</td>
      <td>8.073496</td>
      <td>15.108581</td>
      <td>20.826186</td>
      <td>5.672763</td>
      <td>5.672763</td>
      <td>12.389295</td>
      <td>18.988563</td>
    </tr>
    <tr>
      <th>min</th>
      <td>6.000000</td>
      <td>-6.200000</td>
      <td>-84.000000</td>
      <td>-62.000000</td>
      <td>-6.000000</td>
      <td>-6.000000</td>
      <td>-73.000000</td>
      <td>-86.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>662.750000</td>
      <td>8.600000</td>
      <td>-9.000000</td>
      <td>-17.750000</td>
      <td>4.000000</td>
      <td>4.000000</td>
      <td>-39.000000</td>
      <td>-40.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>1413.000000</td>
      <td>13.200000</td>
      <td>-1.000000</td>
      <td>-4.000000</td>
      <td>7.000000</td>
      <td>7.000000</td>
      <td>-31.000000</td>
      <td>-26.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>2475.750000</td>
      <td>21.800000</td>
      <td>8.000000</td>
      <td>11.000000</td>
      <td>10.000000</td>
      <td>10.000000</td>
      <td>-21.000000</td>
      <td>-16.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>23811.000000</td>
      <td>32.700000</td>
      <td>50.000000</td>
      <td>77.000000</td>
      <td>31.000000</td>
      <td>31.000000</td>
      <td>1.000000</td>
      <td>20.000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>np_data_madrid <span class="op">=</span> data_madrid.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train dataset</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>scaled_data_madrid <span class="op">=</span> scaler.fit_transform(np_data_madrid)</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud del conjunto de datos disponible: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_madrid)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud del conjunto de datos disponible: 654</code></pre>
</div>
</div>
<div class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we are going to predict future values based on the 90 past elements, </span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to create a list with those historic information for each element</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>historic_values <span class="op">=</span> <span class="dv">90</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>scaled_data_madrid_x <span class="op">=</span> []</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>scaled_data_madrid_y <span class="op">=</span> []</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(historic_values, <span class="bu">len</span>(scaled_data_madrid)):</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>    scaled_data_madrid_x.append(scaled_data_madrid[(i<span class="op">-</span>historic_values):i, :])</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>    scaled_data_madrid_y.append(scaled_data_madrid[i, <span class="dv">0</span>])</span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the x_train and y_train to numpy arrays</span></span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>scaled_data_madrid_x <span class="op">=</span> np.array(scaled_data_madrid_x)</span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>scaled_data_madrid_y <span class="op">=</span> np.array(scaled_data_madrid_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Once predicted, we are going to need a exclusive scaler for num_cases</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>scaler_pred <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>df_cases_madrid <span class="op">=</span> pd.DataFrame(data_madrid[<span class="st">'num_casos'</span>])</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>scaled_data_madrid_pred <span class="op">=</span> scaler_pred.fit_transform(df_cases_madrid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since the first 90th values does not have historic, the dataset has been reduced in 90 values</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud datos de entrenamiento con historico: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_madrid_y)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud datos de entrenamiento con historico: 564</code></pre>
</div>
</div>
<div class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we split data in train and test</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as in previous analysis, we are going to predict a maximum of 90 days</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> scaled_data_madrid_x[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_madrid_x)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> scaled_data_madrid_y[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_madrid_y)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de entrenamiento: x=</span><span class="sc">{</span><span class="bu">len</span>(x_train)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> scaled_data_madrid_x[<span class="bu">len</span>(scaled_data_madrid_x)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_madrid_x)]</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaled_data_madrid_y[<span class="bu">len</span>(scaled_data_madrid_y)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_madrid_y)]</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de test: x=</span><span class="sc">{</span><span class="bu">len</span>(x_test)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_test)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cantidad datos de entrenamiento: x=473 - y=473
Cantidad datos de test: x=90 - y=90</code></pre>
</div>
</div>
<div class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data to feed de recurrent network</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> np.reshape(x_train, (x_train.shape[<span class="dv">0</span>], x_train.shape[<span class="dv">1</span>], <span class="dv">8</span>))</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train data shape:"</span>)</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_train.shape)</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_train.shape)</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> np.reshape(x_test, (x_test.shape[<span class="dv">0</span>], x_test.shape[<span class="dv">1</span>], <span class="dv">8</span>))</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test data shape:"</span>)</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_test.shape)</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train data shape:
(473, 90, 8)
(473,)
Test data shape:
(90, 90, 8)
(90,)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure / setup the neural network model - LSTM</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the model</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Build model...'</span>)</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with Neurons </span></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputshape = neurons -&gt; Timestamps</span></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>neurons<span class="op">=</span> x_train.shape[<span class="dv">1</span>]</span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">90</span>, </span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>, </span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>               input_shape <span class="op">=</span> (x_train.shape[<span class="dv">1</span>], <span class="dv">8</span>))) </span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">50</span>, </span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>)) </span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">25</span>, </span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">False</span>)) </span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">5</span>, activation <span class="op">=</span> <span class="st">'relu'</span>))</span>
<span id="cb113-19"><a href="#cb113-19" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Build model...</code></pre>
</div>
</div>
<div class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mean_squared_error'</span>)</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "sequential_2"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Layer (type)                Output Shape              Param #   </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_6 (LSTM)               (None, 90, 90)            35640     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_7 (LSTM)               (None, 90, 50)            28200     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_8 (LSTM)               (None, 25)                7600      </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_4 (Dense)             (None, 5)                 130       </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_5 (Dense)             (None, 1)                 6         </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Total params: 71,576</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Trainable params: 71,576</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Non-trainable params: 0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
</div>
<div class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fit network</span></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(x_train, </span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>                    y_train, </span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>                    batch_size<span class="op">=</span><span class="dv">1000</span>, </span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>                    epochs<span class="op">=</span><span class="dv">30</span>, </span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a>                    validation_data <span class="op">=</span> (x_test, y_test), </span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>                    verbose <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'loss'</span>], label<span class="op">=</span><span class="st">'train'</span>)</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'val_loss'</span>], label<span class="op">=</span><span class="st">'test'</span>)</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>plt.show() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_multi_files/figure-html/cell-56-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predicted values</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.predict(x_test)</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> scaler_pred.inverse_transform(predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1/3 [=========&gt;....................] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - 0s 30ms/step</code></pre>
</div>
</div>
<div class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y_test.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaler_pred.inverse_transform(y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean absolute error (MAE)</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, predictions)</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MAE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(mae, <span class="dv">1</span>)))</span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test,predictions))</span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> mean_squared_error(y_test, </span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>                          predictions,</span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>                          squared <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE: 4531.8
RMSE: 7047.1
RMSE: 7047.1</code></pre>
</div>
</div>
<div class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the difference between the valid and predicted prices</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> data_madrid[:(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">92</span>)]</span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> data_madrid[(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">91</span>):]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Predictions"</span>, predictions, <span class="va">True</span>)</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Difference"</span>, valid[<span class="st">"Predictions"</span>] <span class="op">-</span> valid[<span class="st">"num_casos"</span>], <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Zoom-in to a closer timeframe</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Date from which on the date is displayed</span></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>display_start_date <span class="op">=</span> <span class="st">"2021-10-31"</span> </span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> valid[valid.index <span class="op">&gt;</span> display_start_date]</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> train[train.index <span class="op">&gt;</span> display_start_date]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the data</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>matplotlib.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">22</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Train</span></span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> train.index<span class="op">;</span> </span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> train[[<span class="st">"num_casos"</span>]]</span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Test / validation </span></span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a>xv <span class="op">=</span> valid.index<span class="op">;</span> </span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a>yv <span class="op">=</span> valid[[<span class="st">"num_casos"</span>, <span class="st">"Predictions"</span>]]</span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb147-13"><a href="#cb147-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"madrid: Predictions vs Real infections"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb147-14"><a href="#cb147-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Nº Cases"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb147-15"><a href="#cb147-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-16"><a href="#cb147-16" aria-hidden="true" tabindex="-1"></a>plt.plot(yt, color<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb147-17"><a href="#cb147-17" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"Predictions"</span>], color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb147-18"><a href="#cb147-18" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"num_casos"</span>], color<span class="op">=</span><span class="st">"green"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb147-19"><a href="#cb147-19" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"LSTM Predictions"</span>, <span class="st">"Test"</span>], </span>
<span id="cb147-20"><a href="#cb147-20" aria-hidden="true" tabindex="-1"></a>           loc<span class="op">=</span><span class="st">"upper left"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb147-21"><a href="#cb147-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-22"><a href="#cb147-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot with the differences</span></span>
<span id="cb147-23"><a href="#cb147-23" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> valid.index</span>
<span id="cb147-24"><a href="#cb147-24" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> valid[<span class="st">"Difference"</span>]</span>
<span id="cb147-25"><a href="#cb147-25" aria-hidden="true" tabindex="-1"></a>plt.bar(x, y, width<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">"grey"</span>)</span>
<span id="cb147-26"><a href="#cb147-26" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb147-27"><a href="#cb147-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_multi_files/figure-html/cell-63-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="málaga" class="level2">
<h2 class="anchored" data-anchor-id="málaga">Málaga</h2>
<div class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>data_malaga <span class="op">=</span> data_covid.loc[data_covid[<span class="st">'provincia'</span>] <span class="op">==</span> <span class="st">'Málaga'</span>]</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>data_malaga <span class="op">=</span> data_malaga.set_index(<span class="st">'fecha'</span>)</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>data_malaga <span class="op">=</span> data_malaga[<span class="st">'2020-06-14'</span>:]</span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>data_malaga <span class="op">=</span> data_malaga.<span class="bu">filter</span>([<span class="st">'num_casos'</span>, <span class="st">'tmed'</span>, <span class="st">'mob_grocery_pharmacy'</span>, </span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a><span class="st">'mob_parks'</span>, <span class="st">'mob_residential'</span>, <span class="st">'mob_residential'</span>, <span class="st">'mob_transit_stations'</span>, <span class="st">'mob_workplaces'</span>])</span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>data_malaga</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
      <th>tmed</th>
      <th>mob_grocery_pharmacy</th>
      <th>mob_parks</th>
      <th>mob_residential</th>
      <th>mob_residential</th>
      <th>mob_transit_stations</th>
      <th>mob_workplaces</th>
    </tr>
    <tr>
      <th>fecha</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-14</th>
      <td>2</td>
      <td>26.6</td>
      <td>-20.0</td>
      <td>-15.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>-53.0</td>
      <td>-7.0</td>
    </tr>
    <tr>
      <th>2020-06-15</th>
      <td>1</td>
      <td>27.2</td>
      <td>-16.0</td>
      <td>-9.0</td>
      <td>9.0</td>
      <td>9.0</td>
      <td>-44.0</td>
      <td>-33.0</td>
    </tr>
    <tr>
      <th>2020-06-16</th>
      <td>1</td>
      <td>27.8</td>
      <td>-13.0</td>
      <td>-4.0</td>
      <td>9.0</td>
      <td>9.0</td>
      <td>-40.0</td>
      <td>-33.0</td>
    </tr>
    <tr>
      <th>2020-06-17</th>
      <td>2</td>
      <td>26.9</td>
      <td>-13.0</td>
      <td>1.0</td>
      <td>9.0</td>
      <td>9.0</td>
      <td>-41.0</td>
      <td>-33.0</td>
    </tr>
    <tr>
      <th>2020-06-18</th>
      <td>2</td>
      <td>21.6</td>
      <td>-12.0</td>
      <td>3.0</td>
      <td>9.0</td>
      <td>9.0</td>
      <td>-42.0</td>
      <td>-33.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2022-03-25</th>
      <td>565</td>
      <td>13.8</td>
      <td>-3.0</td>
      <td>-32.0</td>
      <td>8.0</td>
      <td>8.0</td>
      <td>-18.0</td>
      <td>-12.0</td>
    </tr>
    <tr>
      <th>2022-03-26</th>
      <td>79</td>
      <td>14.5</td>
      <td>-1.0</td>
      <td>-1.0</td>
      <td>3.0</td>
      <td>3.0</td>
      <td>-13.0</td>
      <td>-4.0</td>
    </tr>
    <tr>
      <th>2022-03-27</th>
      <td>65</td>
      <td>15.4</td>
      <td>5.0</td>
      <td>-18.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2022-03-28</th>
      <td>39</td>
      <td>16.3</td>
      <td>6.0</td>
      <td>-4.0</td>
      <td>3.0</td>
      <td>3.0</td>
      <td>-4.0</td>
      <td>-7.0</td>
    </tr>
    <tr>
      <th>2022-03-29</th>
      <td>0</td>
      <td>16.8</td>
      <td>4.0</td>
      <td>-3.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>1.0</td>
      <td>-8.0</td>
    </tr>
  </tbody>
</table>
<p>654 rows × 8 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>data_malaga.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
      <th>tmed</th>
      <th>mob_grocery_pharmacy</th>
      <th>mob_parks</th>
      <th>mob_residential</th>
      <th>mob_residential</th>
      <th>mob_transit_stations</th>
      <th>mob_workplaces</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.00000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>410.206422</td>
      <td>19.511162</td>
      <td>8.776758</td>
      <td>13.570336</td>
      <td>4.529052</td>
      <td>4.529052</td>
      <td>-18.853211</td>
      <td>-18.04893</td>
    </tr>
    <tr>
      <th>std</th>
      <td>489.452348</td>
      <td>5.721942</td>
      <td>26.696909</td>
      <td>39.148014</td>
      <td>4.064365</td>
      <td>4.064365</td>
      <td>18.183256</td>
      <td>14.55877</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
      <td>6.200000</td>
      <td>-80.000000</td>
      <td>-63.000000</td>
      <td>-4.000000</td>
      <td>-4.000000</td>
      <td>-70.000000</td>
      <td>-79.00000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>122.250000</td>
      <td>14.725000</td>
      <td>-4.000000</td>
      <td>-13.000000</td>
      <td>2.000000</td>
      <td>2.000000</td>
      <td>-32.000000</td>
      <td>-26.00000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>215.500000</td>
      <td>18.400000</td>
      <td>6.000000</td>
      <td>5.000000</td>
      <td>4.000000</td>
      <td>4.000000</td>
      <td>-21.000000</td>
      <td>-17.00000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>475.250000</td>
      <td>24.500000</td>
      <td>15.000000</td>
      <td>30.000000</td>
      <td>6.750000</td>
      <td>6.750000</td>
      <td>-4.000000</td>
      <td>-11.00000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>3080.000000</td>
      <td>34.500000</td>
      <td>156.000000</td>
      <td>152.000000</td>
      <td>22.000000</td>
      <td>22.000000</td>
      <td>20.000000</td>
      <td>29.00000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>np_data_malaga <span class="op">=</span> data_malaga.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train dataset</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>scaled_data_malaga <span class="op">=</span> scaler.fit_transform(np_data_malaga)</span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud del conjunto de datos disponible: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_malaga)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud del conjunto de datos disponible: 654</code></pre>
</div>
</div>
<div class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we are going to predict future values based on the 90 past elements, </span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to create a list with those historic information for each element</span></span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>historic_values <span class="op">=</span> <span class="dv">90</span></span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>scaled_data_malaga_x <span class="op">=</span> []</span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>scaled_data_malaga_y <span class="op">=</span> []</span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(historic_values, <span class="bu">len</span>(scaled_data_malaga)):</span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a>    scaled_data_malaga_x.append(scaled_data_malaga[(i<span class="op">-</span>historic_values):i, :])</span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a>    scaled_data_malaga_y.append(scaled_data_malaga[i, <span class="dv">0</span>])</span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the x_train and y_train to numpy arrays</span></span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a>scaled_data_malaga_x <span class="op">=</span> np.array(scaled_data_malaga_x)</span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a>scaled_data_malaga_y <span class="op">=</span> np.array(scaled_data_malaga_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Once predicted, we are going to need a exclusive scaler for num_cases</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>scaler_pred <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>df_cases_malaga <span class="op">=</span> pd.DataFrame(data_malaga[<span class="st">'num_casos'</span>])</span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>scaled_data_malaga_pred <span class="op">=</span> scaler_pred.fit_transform(df_cases_malaga)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since the first 90th values does not have historic, the dataset has been reduced in 90 values</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud datos de entrenamiento con historico: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_malaga_y)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud datos de entrenamiento con historico: 564</code></pre>
</div>
</div>
<div class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we split data in train and test</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as in previous analysis, we are going to predict a maximum of 90 days</span></span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> scaled_data_malaga_x[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_malaga_x)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> scaled_data_malaga_y[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_malaga_y)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de entrenamiento: x=</span><span class="sc">{</span><span class="bu">len</span>(x_train)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> scaled_data_malaga_x[<span class="bu">len</span>(scaled_data_malaga_x)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_malaga_x)]</span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaled_data_malaga_y[<span class="bu">len</span>(scaled_data_malaga_y)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_malaga_y)]</span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de test: x=</span><span class="sc">{</span><span class="bu">len</span>(x_test)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_test)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cantidad datos de entrenamiento: x=473 - y=473
Cantidad datos de test: x=90 - y=90</code></pre>
</div>
</div>
<div class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data to feed de recurrent network</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> np.reshape(x_train, (x_train.shape[<span class="dv">0</span>], x_train.shape[<span class="dv">1</span>], <span class="dv">8</span>))</span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train data shape:"</span>)</span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_train.shape)</span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_train.shape)</span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> np.reshape(x_test, (x_test.shape[<span class="dv">0</span>], x_test.shape[<span class="dv">1</span>], <span class="dv">8</span>))</span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test data shape:"</span>)</span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_test.shape)</span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train data shape:
(473, 90, 8)
(473,)
Test data shape:
(90, 90, 8)
(90,)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure / setup the neural network model - LSTM</span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the model</span></span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Build model...'</span>)</span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with Neurons </span></span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputshape = neurons -&gt; Timestamps</span></span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a>neurons<span class="op">=</span> x_train.shape[<span class="dv">1</span>]</span>
<span id="cb161-8"><a href="#cb161-8" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">90</span>, </span>
<span id="cb161-9"><a href="#cb161-9" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb161-10"><a href="#cb161-10" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>, </span>
<span id="cb161-11"><a href="#cb161-11" aria-hidden="true" tabindex="-1"></a>               input_shape <span class="op">=</span> (x_train.shape[<span class="dv">1</span>], <span class="dv">8</span>))) </span>
<span id="cb161-12"><a href="#cb161-12" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">50</span>, </span>
<span id="cb161-13"><a href="#cb161-13" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb161-14"><a href="#cb161-14" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>)) </span>
<span id="cb161-15"><a href="#cb161-15" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">25</span>, </span>
<span id="cb161-16"><a href="#cb161-16" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb161-17"><a href="#cb161-17" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">False</span>)) </span>
<span id="cb161-18"><a href="#cb161-18" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">5</span>, activation <span class="op">=</span> <span class="st">'relu'</span>))</span>
<span id="cb161-19"><a href="#cb161-19" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Build model...</code></pre>
</div>
</div>
<div class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mean_squared_error'</span>)</span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "sequential_3"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Layer (type)                Output Shape              Param #   </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_9 (LSTM)               (None, 90, 90)            35640     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_10 (LSTM)              (None, 90, 50)            28200     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_11 (LSTM)              (None, 25)                7600      </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_6 (Dense)             (None, 5)                 130       </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_7 (Dense)             (None, 1)                 6         </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Total params: 71,576</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Trainable params: 71,576</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Non-trainable params: 0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
</div>
<div class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model</span></span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fit network</span></span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(x_train, </span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a>                    y_train, </span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a>                    batch_size<span class="op">=</span><span class="dv">1000</span>, </span>
<span id="cb183-6"><a href="#cb183-6" aria-hidden="true" tabindex="-1"></a>                    epochs<span class="op">=</span><span class="dv">30</span>, </span>
<span id="cb183-7"><a href="#cb183-7" aria-hidden="true" tabindex="-1"></a>                    validation_data <span class="op">=</span> (x_test, y_test), </span>
<span id="cb183-8"><a href="#cb183-8" aria-hidden="true" tabindex="-1"></a>                    verbose <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'loss'</span>], label<span class="op">=</span><span class="st">'train'</span>)</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'val_loss'</span>], label<span class="op">=</span><span class="st">'test'</span>)</span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a>plt.show() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_multi_files/figure-html/cell-76-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predicted values</span></span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.predict(x_test)</span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> scaler_pred.inverse_transform(predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1/3 [=========&gt;....................] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - 0s 31ms/step</code></pre>
</div>
</div>
<div class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y_test.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaler_pred.inverse_transform(y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean absolute error (MAE)</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, predictions)</span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MAE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(mae, <span class="dv">1</span>)))</span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test,predictions))</span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> mean_squared_error(y_test, </span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a>                          predictions,</span>
<span id="cb190-12"><a href="#cb190-12" aria-hidden="true" tabindex="-1"></a>                          squared <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb190-13"><a href="#cb190-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE: 322.4
RMSE: 508.6
RMSE: 508.6</code></pre>
</div>
</div>
<div class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the difference between the valid and predicted prices</span></span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> data_malaga[:(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">92</span>)]</span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> data_malaga[(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">91</span>):]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Predictions"</span>, predictions, <span class="va">True</span>)</span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Difference"</span>, valid[<span class="st">"Predictions"</span>] <span class="op">-</span> valid[<span class="st">"num_casos"</span>], <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Zoom-in to a closer timeframe</span></span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Date from which on the date is displayed</span></span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a>display_start_date <span class="op">=</span> <span class="st">"2021-10-31"</span> </span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> valid[valid.index <span class="op">&gt;</span> display_start_date]</span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> train[train.index <span class="op">&gt;</span> display_start_date]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the data</span></span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>matplotlib.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">22</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Train</span></span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> train.index<span class="op">;</span> </span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> train[[<span class="st">"num_casos"</span>]]</span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Test / validation </span></span>
<span id="cb195-9"><a href="#cb195-9" aria-hidden="true" tabindex="-1"></a>xv <span class="op">=</span> valid.index<span class="op">;</span> </span>
<span id="cb195-10"><a href="#cb195-10" aria-hidden="true" tabindex="-1"></a>yv <span class="op">=</span> valid[[<span class="st">"num_casos"</span>, <span class="st">"Predictions"</span>]]</span>
<span id="cb195-11"><a href="#cb195-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-12"><a href="#cb195-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb195-13"><a href="#cb195-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"malaga: Predictions vs Real infections"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb195-14"><a href="#cb195-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Nº Cases"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb195-15"><a href="#cb195-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-16"><a href="#cb195-16" aria-hidden="true" tabindex="-1"></a>plt.plot(yt, color<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb195-17"><a href="#cb195-17" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"Predictions"</span>], color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb195-18"><a href="#cb195-18" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"num_casos"</span>], color<span class="op">=</span><span class="st">"green"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb195-19"><a href="#cb195-19" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"LSTM Predictions"</span>, <span class="st">"Test"</span>], </span>
<span id="cb195-20"><a href="#cb195-20" aria-hidden="true" tabindex="-1"></a>           loc<span class="op">=</span><span class="st">"upper left"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb195-21"><a href="#cb195-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-22"><a href="#cb195-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot with the differences</span></span>
<span id="cb195-23"><a href="#cb195-23" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> valid.index</span>
<span id="cb195-24"><a href="#cb195-24" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> valid[<span class="st">"Difference"</span>]</span>
<span id="cb195-25"><a href="#cb195-25" aria-hidden="true" tabindex="-1"></a>plt.bar(x, y, width<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">"grey"</span>)</span>
<span id="cb195-26"><a href="#cb195-26" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb195-27"><a href="#cb195-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_multi_files/figure-html/cell-83-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="sevilla" class="level2">
<h2 class="anchored" data-anchor-id="sevilla">Sevilla</h2>
<div class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>data_sevilla <span class="op">=</span> data_covid.loc[data_covid[<span class="st">'provincia'</span>] <span class="op">==</span> <span class="st">'Sevilla'</span>]</span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a>data_sevilla <span class="op">=</span> data_sevilla.set_index(<span class="st">'fecha'</span>)</span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a>data_sevilla <span class="op">=</span> data_sevilla[<span class="st">'2020-06-14'</span>:]</span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a>data_sevilla <span class="op">=</span> data_sevilla.<span class="bu">filter</span>([<span class="st">'num_casos'</span>, <span class="st">'tmed'</span>, <span class="st">'mob_grocery_pharmacy'</span>, </span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a><span class="st">'mob_parks'</span>, <span class="st">'mob_residential'</span>, <span class="st">'mob_residential'</span>, <span class="st">'mob_transit_stations'</span>, <span class="st">'mob_workplaces'</span>])</span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a>data_sevilla</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="83">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
      <th>tmed</th>
      <th>mob_grocery_pharmacy</th>
      <th>mob_parks</th>
      <th>mob_residential</th>
      <th>mob_residential</th>
      <th>mob_transit_stations</th>
      <th>mob_workplaces</th>
    </tr>
    <tr>
      <th>fecha</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-14</th>
      <td>0</td>
      <td>22.200000</td>
      <td>-24.0</td>
      <td>-36.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-51.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2020-06-15</th>
      <td>2</td>
      <td>23.088889</td>
      <td>-14.0</td>
      <td>-13.0</td>
      <td>9.0</td>
      <td>9.0</td>
      <td>-41.0</td>
      <td>-33.0</td>
    </tr>
    <tr>
      <th>2020-06-16</th>
      <td>1</td>
      <td>23.977778</td>
      <td>-10.0</td>
      <td>-4.0</td>
      <td>9.0</td>
      <td>9.0</td>
      <td>-37.0</td>
      <td>-32.0</td>
    </tr>
    <tr>
      <th>2020-06-17</th>
      <td>0</td>
      <td>24.866667</td>
      <td>-10.0</td>
      <td>-7.0</td>
      <td>9.0</td>
      <td>9.0</td>
      <td>-37.0</td>
      <td>-32.0</td>
    </tr>
    <tr>
      <th>2020-06-18</th>
      <td>0</td>
      <td>25.755556</td>
      <td>-12.0</td>
      <td>-13.0</td>
      <td>9.0</td>
      <td>9.0</td>
      <td>-41.0</td>
      <td>-33.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2022-03-25</th>
      <td>365</td>
      <td>14.100000</td>
      <td>2.0</td>
      <td>-20.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>-14.0</td>
      <td>-7.0</td>
    </tr>
    <tr>
      <th>2022-03-26</th>
      <td>67</td>
      <td>15.200000</td>
      <td>-9.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-12.0</td>
      <td>-5.0</td>
    </tr>
    <tr>
      <th>2022-03-27</th>
      <td>24</td>
      <td>15.900000</td>
      <td>2.0</td>
      <td>-13.0</td>
      <td>-1.0</td>
      <td>-1.0</td>
      <td>-10.0</td>
      <td>-7.0</td>
    </tr>
    <tr>
      <th>2022-03-28</th>
      <td>12</td>
      <td>17.100000</td>
      <td>2.0</td>
      <td>-5.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>-10.0</td>
      <td>-6.0</td>
    </tr>
    <tr>
      <th>2022-03-29</th>
      <td>0</td>
      <td>16.000000</td>
      <td>3.0</td>
      <td>-7.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>-13.0</td>
      <td>-5.0</td>
    </tr>
  </tbody>
</table>
<p>654 rows × 8 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>data_sevilla.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="84">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
      <th>tmed</th>
      <th>mob_grocery_pharmacy</th>
      <th>mob_parks</th>
      <th>mob_residential</th>
      <th>mob_residential</th>
      <th>mob_transit_stations</th>
      <th>mob_workplaces</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
      <td>654.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>432.978593</td>
      <td>19.663609</td>
      <td>-0.709480</td>
      <td>-14.958716</td>
      <td>3.915902</td>
      <td>3.915902</td>
      <td>-25.707951</td>
      <td>-20.347095</td>
    </tr>
    <tr>
      <th>std</th>
      <td>500.618517</td>
      <td>6.949955</td>
      <td>18.851349</td>
      <td>17.982375</td>
      <td>4.397963</td>
      <td>4.397963</td>
      <td>14.307026</td>
      <td>14.434846</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
      <td>5.500000</td>
      <td>-79.000000</td>
      <td>-70.000000</td>
      <td>-7.000000</td>
      <td>-7.000000</td>
      <td>-71.000000</td>
      <td>-79.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>127.250000</td>
      <td>13.800000</td>
      <td>-8.000000</td>
      <td>-27.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>-36.000000</td>
      <td>-29.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>282.000000</td>
      <td>18.600000</td>
      <td>0.000000</td>
      <td>-13.000000</td>
      <td>4.000000</td>
      <td>4.000000</td>
      <td>-26.000000</td>
      <td>-17.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>528.250000</td>
      <td>25.600000</td>
      <td>7.000000</td>
      <td>-4.000000</td>
      <td>6.000000</td>
      <td>6.000000</td>
      <td>-15.000000</td>
      <td>-10.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>3692.000000</td>
      <td>34.400000</td>
      <td>117.000000</td>
      <td>61.000000</td>
      <td>22.000000</td>
      <td>22.000000</td>
      <td>16.000000</td>
      <td>9.000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>np_data_sevilla <span class="op">=</span> data_sevilla.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train dataset</span></span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a>scaled_data_sevilla <span class="op">=</span> scaler.fit_transform(np_data_sevilla)</span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud del conjunto de datos disponible: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_sevilla)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud del conjunto de datos disponible: 654</code></pre>
</div>
</div>
<div class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we are going to predict future values based on the 90 past elements, </span></span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to create a list with those historic information for each element</span></span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a>historic_values <span class="op">=</span> <span class="dv">90</span></span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a>scaled_data_sevilla_x <span class="op">=</span> []</span>
<span id="cb201-5"><a href="#cb201-5" aria-hidden="true" tabindex="-1"></a>scaled_data_sevilla_y <span class="op">=</span> []</span>
<span id="cb201-6"><a href="#cb201-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-7"><a href="#cb201-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(historic_values, <span class="bu">len</span>(scaled_data_sevilla)):</span>
<span id="cb201-8"><a href="#cb201-8" aria-hidden="true" tabindex="-1"></a>    scaled_data_sevilla_x.append(scaled_data_sevilla[(i<span class="op">-</span>historic_values):i, :])</span>
<span id="cb201-9"><a href="#cb201-9" aria-hidden="true" tabindex="-1"></a>    scaled_data_sevilla_y.append(scaled_data_sevilla[i, <span class="dv">0</span>])</span>
<span id="cb201-10"><a href="#cb201-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-11"><a href="#cb201-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the x_train and y_train to numpy arrays</span></span>
<span id="cb201-12"><a href="#cb201-12" aria-hidden="true" tabindex="-1"></a>scaled_data_sevilla_x <span class="op">=</span> np.array(scaled_data_sevilla_x)</span>
<span id="cb201-13"><a href="#cb201-13" aria-hidden="true" tabindex="-1"></a>scaled_data_sevilla_y <span class="op">=</span> np.array(scaled_data_sevilla_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Once predicted, we are going to need a exclusive scaler for num_cases</span></span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a>scaler_pred <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a>df_cases_sevilla <span class="op">=</span> pd.DataFrame(data_sevilla[<span class="st">'num_casos'</span>])</span>
<span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a>scaled_data_sevilla_pred <span class="op">=</span> scaler_pred.fit_transform(df_cases_sevilla)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="89">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since the first 90th values does not have historic, the dataset has been reduced in 90 values</span></span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud datos de entrenamiento con historico: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_sevilla_y)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud datos de entrenamiento con historico: 564</code></pre>
</div>
</div>
<div class="cell" data-execution_count="90">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we split data in train and test</span></span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as in previous analysis, we are going to predict a maximum of 90 days</span></span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> scaled_data_sevilla_x[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_sevilla_x)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb205-4"><a href="#cb205-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> scaled_data_sevilla_y[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_sevilla_y)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb205-5"><a href="#cb205-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de entrenamiento: x=</span><span class="sc">{</span><span class="bu">len</span>(x_train)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb205-6"><a href="#cb205-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-7"><a href="#cb205-7" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> scaled_data_sevilla_x[<span class="bu">len</span>(scaled_data_sevilla_x)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_sevilla_x)]</span>
<span id="cb205-8"><a href="#cb205-8" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaled_data_sevilla_y[<span class="bu">len</span>(scaled_data_sevilla_y)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_sevilla_y)]</span>
<span id="cb205-9"><a href="#cb205-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de test: x=</span><span class="sc">{</span><span class="bu">len</span>(x_test)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_test)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cantidad datos de entrenamiento: x=473 - y=473
Cantidad datos de test: x=90 - y=90</code></pre>
</div>
</div>
<div class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data to feed de recurrent network</span></span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> np.reshape(x_train, (x_train.shape[<span class="dv">0</span>], x_train.shape[<span class="dv">1</span>], <span class="dv">8</span>))</span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train data shape:"</span>)</span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_train.shape)</span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_train.shape)</span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> np.reshape(x_test, (x_test.shape[<span class="dv">0</span>], x_test.shape[<span class="dv">1</span>], <span class="dv">8</span>))</span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test data shape:"</span>)</span>
<span id="cb207-8"><a href="#cb207-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_test.shape)</span>
<span id="cb207-9"><a href="#cb207-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train data shape:
(473, 90, 8)
(473,)
Test data shape:
(90, 90, 8)
(90,)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure / setup the neural network model - LSTM</span></span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the model</span></span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Build model...'</span>)</span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with Neurons </span></span>
<span id="cb209-6"><a href="#cb209-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputshape = neurons -&gt; Timestamps</span></span>
<span id="cb209-7"><a href="#cb209-7" aria-hidden="true" tabindex="-1"></a>neurons<span class="op">=</span> x_train.shape[<span class="dv">1</span>]</span>
<span id="cb209-8"><a href="#cb209-8" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">90</span>, </span>
<span id="cb209-9"><a href="#cb209-9" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb209-10"><a href="#cb209-10" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>, </span>
<span id="cb209-11"><a href="#cb209-11" aria-hidden="true" tabindex="-1"></a>               input_shape <span class="op">=</span> (x_train.shape[<span class="dv">1</span>], <span class="dv">8</span>))) </span>
<span id="cb209-12"><a href="#cb209-12" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">50</span>, </span>
<span id="cb209-13"><a href="#cb209-13" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb209-14"><a href="#cb209-14" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>)) </span>
<span id="cb209-15"><a href="#cb209-15" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">25</span>, </span>
<span id="cb209-16"><a href="#cb209-16" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb209-17"><a href="#cb209-17" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">False</span>)) </span>
<span id="cb209-18"><a href="#cb209-18" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">5</span>, activation <span class="op">=</span> <span class="st">'relu'</span>))</span>
<span id="cb209-19"><a href="#cb209-19" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Build model...</code></pre>
</div>
</div>
<div class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mean_squared_error'</span>)</span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "sequential_4"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Layer (type)                Output Shape              Param #   </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_12 (LSTM)              (None, 90, 90)            35640     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_13 (LSTM)              (None, 90, 50)            28200     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_14 (LSTM)              (None, 25)                7600      </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_8 (Dense)             (None, 5)                 130       </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_9 (Dense)             (None, 1)                 6         </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Total params: 71,576</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Trainable params: 71,576</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Non-trainable params: 0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
</div>
<div class="cell" data-execution_count="94">
<div class="sourceCode cell-code" id="cb231"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model</span></span>
<span id="cb231-2"><a href="#cb231-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fit network</span></span>
<span id="cb231-3"><a href="#cb231-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(x_train, </span>
<span id="cb231-4"><a href="#cb231-4" aria-hidden="true" tabindex="-1"></a>                    y_train, </span>
<span id="cb231-5"><a href="#cb231-5" aria-hidden="true" tabindex="-1"></a>                    batch_size<span class="op">=</span><span class="dv">1000</span>, </span>
<span id="cb231-6"><a href="#cb231-6" aria-hidden="true" tabindex="-1"></a>                    epochs<span class="op">=</span><span class="dv">30</span>, </span>
<span id="cb231-7"><a href="#cb231-7" aria-hidden="true" tabindex="-1"></a>                    validation_data <span class="op">=</span> (x_test, y_test), </span>
<span id="cb231-8"><a href="#cb231-8" aria-hidden="true" tabindex="-1"></a>                    verbose <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="95">
<div class="sourceCode cell-code" id="cb232"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'loss'</span>], label<span class="op">=</span><span class="st">'train'</span>)</span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'val_loss'</span>], label<span class="op">=</span><span class="st">'test'</span>)</span>
<span id="cb232-3"><a href="#cb232-3" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb232-4"><a href="#cb232-4" aria-hidden="true" tabindex="-1"></a>plt.show() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_multi_files/figure-html/cell-96-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb233"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predicted values</span></span>
<span id="cb233-2"><a href="#cb233-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.predict(x_test)</span>
<span id="cb233-3"><a href="#cb233-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> scaler_pred.inverse_transform(predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>WARNING:tensorflow:5 out of the last 13 calls to &lt;function Model.make_predict_function.&lt;locals&gt;.predict_function at 0x7fd54fad4430&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>1/3 [=========&gt;....................] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - 0s 31ms/step</code></pre>
</div>
</div>
<div class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb238"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y_test.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb238-2"><a href="#cb238-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaler_pred.inverse_transform(y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean absolute error (MAE)</span></span>
<span id="cb239-2"><a href="#cb239-2" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, predictions)</span>
<span id="cb239-3"><a href="#cb239-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MAE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(mae, <span class="dv">1</span>)))</span>
<span id="cb239-4"><a href="#cb239-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb239-5"><a href="#cb239-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb239-6"><a href="#cb239-6" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test,predictions))</span>
<span id="cb239-7"><a href="#cb239-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span>
<span id="cb239-8"><a href="#cb239-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb239-9"><a href="#cb239-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb239-10"><a href="#cb239-10" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> mean_squared_error(y_test, </span>
<span id="cb239-11"><a href="#cb239-11" aria-hidden="true" tabindex="-1"></a>                          predictions,</span>
<span id="cb239-12"><a href="#cb239-12" aria-hidden="true" tabindex="-1"></a>                          squared <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb239-13"><a href="#cb239-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE: 1622.4
RMSE: 1889.7
RMSE: 1889.7</code></pre>
</div>
</div>
<div class="cell" data-execution_count="99">
<div class="sourceCode cell-code" id="cb241"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the difference between the valid and predicted prices</span></span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> data_sevilla[:(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">92</span>)]</span>
<span id="cb241-3"><a href="#cb241-3" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> data_sevilla[(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">91</span>):]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="100">
<div class="sourceCode cell-code" id="cb242"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Predictions"</span>, predictions, <span class="va">True</span>)</span>
<span id="cb242-2"><a href="#cb242-2" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Difference"</span>, valid[<span class="st">"Predictions"</span>] <span class="op">-</span> valid[<span class="st">"num_casos"</span>], <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="101">
<div class="sourceCode cell-code" id="cb243"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Zoom-in to a closer timeframe</span></span>
<span id="cb243-2"><a href="#cb243-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Date from which on the date is displayed</span></span>
<span id="cb243-3"><a href="#cb243-3" aria-hidden="true" tabindex="-1"></a>display_start_date <span class="op">=</span> <span class="st">"2021-10-31"</span> </span>
<span id="cb243-4"><a href="#cb243-4" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> valid[valid.index <span class="op">&gt;</span> display_start_date]</span>
<span id="cb243-5"><a href="#cb243-5" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> train[train.index <span class="op">&gt;</span> display_start_date]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="102">
<div class="sourceCode cell-code" id="cb244"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the data</span></span>
<span id="cb244-2"><a href="#cb244-2" aria-hidden="true" tabindex="-1"></a>matplotlib.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb244-3"><a href="#cb244-3" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">22</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb244-4"><a href="#cb244-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-5"><a href="#cb244-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Train</span></span>
<span id="cb244-6"><a href="#cb244-6" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> train.index<span class="op">;</span> </span>
<span id="cb244-7"><a href="#cb244-7" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> train[[<span class="st">"num_casos"</span>]]</span>
<span id="cb244-8"><a href="#cb244-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Test / validation </span></span>
<span id="cb244-9"><a href="#cb244-9" aria-hidden="true" tabindex="-1"></a>xv <span class="op">=</span> valid.index<span class="op">;</span> </span>
<span id="cb244-10"><a href="#cb244-10" aria-hidden="true" tabindex="-1"></a>yv <span class="op">=</span> valid[[<span class="st">"num_casos"</span>, <span class="st">"Predictions"</span>]]</span>
<span id="cb244-11"><a href="#cb244-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-12"><a href="#cb244-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb244-13"><a href="#cb244-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"sevilla: Predictions vs Real infections"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb244-14"><a href="#cb244-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Nº Cases"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb244-15"><a href="#cb244-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-16"><a href="#cb244-16" aria-hidden="true" tabindex="-1"></a>plt.plot(yt, color<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb244-17"><a href="#cb244-17" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"Predictions"</span>], color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb244-18"><a href="#cb244-18" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"num_casos"</span>], color<span class="op">=</span><span class="st">"green"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb244-19"><a href="#cb244-19" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"LSTM Predictions"</span>, <span class="st">"Test"</span>], </span>
<span id="cb244-20"><a href="#cb244-20" aria-hidden="true" tabindex="-1"></a>           loc<span class="op">=</span><span class="st">"upper left"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb244-21"><a href="#cb244-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-22"><a href="#cb244-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot with the differences</span></span>
<span id="cb244-23"><a href="#cb244-23" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> valid.index</span>
<span id="cb244-24"><a href="#cb244-24" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> valid[<span class="st">"Difference"</span>]</span>
<span id="cb244-25"><a href="#cb244-25" aria-hidden="true" tabindex="-1"></a>plt.bar(x, y, width<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">"grey"</span>)</span>
<span id="cb244-26"><a href="#cb244-26" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb244-27"><a href="#cb244-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_multi_files/figure-html/cell-103-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="just-before-the-sixth-wave" class="level1">
<h1>Just before the sixth wave</h1>
<section id="asturias-1" class="level2">
<h2 class="anchored" data-anchor-id="asturias-1">Asturias</h2>
<div class="cell" data-execution_count="103">
<div class="sourceCode cell-code" id="cb245"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a>data_asturias <span class="op">=</span> data_covid.loc[data_covid[<span class="st">'provincia'</span>] <span class="op">==</span> <span class="st">'Asturias'</span>]</span>
<span id="cb245-2"><a href="#cb245-2" aria-hidden="true" tabindex="-1"></a>data_asturias <span class="op">=</span> data_asturias.set_index(<span class="st">'fecha'</span>)</span>
<span id="cb245-3"><a href="#cb245-3" aria-hidden="true" tabindex="-1"></a>data_asturias <span class="op">=</span> data_asturias[<span class="st">'2020-06-14'</span>:<span class="st">'2021-12-31'</span>]</span>
<span id="cb245-4"><a href="#cb245-4" aria-hidden="true" tabindex="-1"></a>data_asturias <span class="op">=</span> data_asturias.<span class="bu">filter</span>([<span class="st">'num_casos'</span>, <span class="st">'tmed'</span>, <span class="st">'mob_grocery_pharmacy'</span>, </span>
<span id="cb245-5"><a href="#cb245-5" aria-hidden="true" tabindex="-1"></a><span class="st">'mob_parks'</span>, <span class="st">'mob_residential'</span>, <span class="st">'mob_residential'</span>, <span class="st">'mob_transit_stations'</span>, <span class="st">'mob_workplaces'</span>])</span>
<span id="cb245-6"><a href="#cb245-6" aria-hidden="true" tabindex="-1"></a>data_asturias</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="103">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
      <th>tmed</th>
      <th>mob_grocery_pharmacy</th>
      <th>mob_parks</th>
      <th>mob_residential</th>
      <th>mob_residential</th>
      <th>mob_transit_stations</th>
      <th>mob_workplaces</th>
    </tr>
    <tr>
      <th>fecha</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-14</th>
      <td>0</td>
      <td>16.8</td>
      <td>-8.0</td>
      <td>6.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>-43.0</td>
      <td>-2.0</td>
    </tr>
    <tr>
      <th>2020-06-15</th>
      <td>0</td>
      <td>16.0</td>
      <td>-6.0</td>
      <td>39.0</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>-38.0</td>
      <td>-27.0</td>
    </tr>
    <tr>
      <th>2020-06-16</th>
      <td>1</td>
      <td>15.6</td>
      <td>-6.0</td>
      <td>7.0</td>
      <td>9.0</td>
      <td>9.0</td>
      <td>-43.0</td>
      <td>-29.0</td>
    </tr>
    <tr>
      <th>2020-06-17</th>
      <td>0</td>
      <td>15.6</td>
      <td>-7.0</td>
      <td>20.0</td>
      <td>8.0</td>
      <td>8.0</td>
      <td>-42.0</td>
      <td>-28.0</td>
    </tr>
    <tr>
      <th>2020-06-18</th>
      <td>0</td>
      <td>15.1</td>
      <td>-4.0</td>
      <td>68.0</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>-39.0</td>
      <td>-28.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2021-12-27</th>
      <td>2363</td>
      <td>16.6</td>
      <td>21.0</td>
      <td>57.0</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>-9.0</td>
      <td>-35.0</td>
    </tr>
    <tr>
      <th>2021-12-28</th>
      <td>2150</td>
      <td>19.2</td>
      <td>18.0</td>
      <td>90.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>-6.0</td>
      <td>-36.0</td>
    </tr>
    <tr>
      <th>2021-12-29</th>
      <td>2159</td>
      <td>15.6</td>
      <td>24.0</td>
      <td>108.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>-34.0</td>
    </tr>
    <tr>
      <th>2021-12-30</th>
      <td>2020</td>
      <td>13.2</td>
      <td>39.0</td>
      <td>88.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>-10.0</td>
      <td>-36.0</td>
    </tr>
    <tr>
      <th>2021-12-31</th>
      <td>1949</td>
      <td>14.6</td>
      <td>21.0</td>
      <td>46.0</td>
      <td>10.0</td>
      <td>10.0</td>
      <td>-21.0</td>
      <td>-54.0</td>
    </tr>
  </tbody>
</table>
<p>566 rows × 8 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb246"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a>data_asturias.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="104">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
      <th>tmed</th>
      <th>mob_grocery_pharmacy</th>
      <th>mob_parks</th>
      <th>mob_residential</th>
      <th>mob_residential</th>
      <th>mob_transit_stations</th>
      <th>mob_workplaces</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>180.913428</td>
      <td>14.495671</td>
      <td>4.159011</td>
      <td>62.592756</td>
      <td>3.798587</td>
      <td>3.798587</td>
      <td>-12.772085</td>
      <td>-21.289753</td>
    </tr>
    <tr>
      <th>std</th>
      <td>276.250633</td>
      <td>4.098429</td>
      <td>15.207805</td>
      <td>71.365461</td>
      <td>5.051424</td>
      <td>5.051424</td>
      <td>15.668332</td>
      <td>13.018468</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
      <td>3.300000</td>
      <td>-87.000000</td>
      <td>-63.000000</td>
      <td>-8.000000</td>
      <td>-8.000000</td>
      <td>-67.000000</td>
      <td>-80.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>36.000000</td>
      <td>11.525000</td>
      <td>-0.375000</td>
      <td>14.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>-23.000000</td>
      <td>-27.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>94.500000</td>
      <td>15.000000</td>
      <td>5.000000</td>
      <td>43.000000</td>
      <td>3.000000</td>
      <td>3.000000</td>
      <td>-13.000000</td>
      <td>-20.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>225.750000</td>
      <td>18.000000</td>
      <td>11.000000</td>
      <td>91.000000</td>
      <td>7.000000</td>
      <td>7.000000</td>
      <td>-2.000000</td>
      <td>-15.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>2363.000000</td>
      <td>25.100000</td>
      <td>42.000000</td>
      <td>333.000000</td>
      <td>26.000000</td>
      <td>26.000000</td>
      <td>26.000000</td>
      <td>12.000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="105">
<div class="sourceCode cell-code" id="cb247"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a>np_data_asturias <span class="op">=</span> data_asturias.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="106">
<div class="sourceCode cell-code" id="cb248"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train dataset</span></span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias <span class="op">=</span> scaler.fit_transform(np_data_asturias)</span>
<span id="cb248-4"><a href="#cb248-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud del conjunto de datos disponible: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_asturias)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud del conjunto de datos disponible: 566</code></pre>
</div>
</div>
<div class="cell" data-execution_count="107">
<div class="sourceCode cell-code" id="cb250"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we are going to predict future values based on the 90 past elements, </span></span>
<span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to create a list with those historic information for each element</span></span>
<span id="cb250-3"><a href="#cb250-3" aria-hidden="true" tabindex="-1"></a>historic_values <span class="op">=</span> <span class="dv">90</span></span>
<span id="cb250-4"><a href="#cb250-4" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias_x <span class="op">=</span> []</span>
<span id="cb250-5"><a href="#cb250-5" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias_y <span class="op">=</span> []</span>
<span id="cb250-6"><a href="#cb250-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-7"><a href="#cb250-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(historic_values, <span class="bu">len</span>(scaled_data_asturias)):</span>
<span id="cb250-8"><a href="#cb250-8" aria-hidden="true" tabindex="-1"></a>    scaled_data_asturias_x.append(scaled_data_asturias[(i<span class="op">-</span>historic_values):i, :])</span>
<span id="cb250-9"><a href="#cb250-9" aria-hidden="true" tabindex="-1"></a>    scaled_data_asturias_y.append(scaled_data_asturias[i, <span class="dv">0</span>])</span>
<span id="cb250-10"><a href="#cb250-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-11"><a href="#cb250-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the x_train and y_train to numpy arrays</span></span>
<span id="cb250-12"><a href="#cb250-12" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias_x <span class="op">=</span> np.array(scaled_data_asturias_x)</span>
<span id="cb250-13"><a href="#cb250-13" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias_y <span class="op">=</span> np.array(scaled_data_asturias_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="108">
<div class="sourceCode cell-code" id="cb251"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Once predicted, we are going to need a exclusive scaler for num_cases</span></span>
<span id="cb251-2"><a href="#cb251-2" aria-hidden="true" tabindex="-1"></a>scaler_pred <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb251-3"><a href="#cb251-3" aria-hidden="true" tabindex="-1"></a>df_cases_asturias <span class="op">=</span> pd.DataFrame(data_asturias[<span class="st">'num_casos'</span>])</span>
<span id="cb251-4"><a href="#cb251-4" aria-hidden="true" tabindex="-1"></a>scaled_data_asturias_pred <span class="op">=</span> scaler_pred.fit_transform(df_cases_asturias)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="109">
<div class="sourceCode cell-code" id="cb252"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since the first 90th values does not have historic, the dataset has been reduced in 90 values</span></span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud datos de entrenamiento con historico: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_asturias_y)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud datos de entrenamiento con historico: 476</code></pre>
</div>
</div>
<div class="cell" data-execution_count="110">
<div class="sourceCode cell-code" id="cb254"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we split data in train and test</span></span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as in previous analysis, we are going to predict a maximum of 90 days</span></span>
<span id="cb254-3"><a href="#cb254-3" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> scaled_data_asturias_x[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_asturias_x)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb254-4"><a href="#cb254-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> scaled_data_asturias_y[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_asturias_y)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb254-5"><a href="#cb254-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de entrenamiento: x=</span><span class="sc">{</span><span class="bu">len</span>(x_train)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb254-6"><a href="#cb254-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-7"><a href="#cb254-7" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> scaled_data_asturias_x[<span class="bu">len</span>(scaled_data_asturias_x)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_asturias_x)]</span>
<span id="cb254-8"><a href="#cb254-8" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaled_data_asturias_y[<span class="bu">len</span>(scaled_data_asturias_y)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_asturias_y)]</span>
<span id="cb254-9"><a href="#cb254-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de test: x=</span><span class="sc">{</span><span class="bu">len</span>(x_test)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_test)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cantidad datos de entrenamiento: x=385 - y=385
Cantidad datos de test: x=90 - y=90</code></pre>
</div>
</div>
<div class="cell" data-execution_count="111">
<div class="sourceCode cell-code" id="cb256"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data to feed de recurrent network</span></span>
<span id="cb256-2"><a href="#cb256-2" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> np.reshape(x_train, (x_train.shape[<span class="dv">0</span>], x_train.shape[<span class="dv">1</span>], <span class="dv">8</span>))</span>
<span id="cb256-3"><a href="#cb256-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train data shape:"</span>)</span>
<span id="cb256-4"><a href="#cb256-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_train.shape)</span>
<span id="cb256-5"><a href="#cb256-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_train.shape)</span>
<span id="cb256-6"><a href="#cb256-6" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> np.reshape(x_test, (x_test.shape[<span class="dv">0</span>], x_test.shape[<span class="dv">1</span>], <span class="dv">8</span>))</span>
<span id="cb256-7"><a href="#cb256-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test data shape:"</span>)</span>
<span id="cb256-8"><a href="#cb256-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_test.shape)</span>
<span id="cb256-9"><a href="#cb256-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train data shape:
(385, 90, 8)
(385,)
Test data shape:
(90, 90, 8)
(90,)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="112">
<div class="sourceCode cell-code" id="cb258"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure / setup the neural network model - LSTM</span></span>
<span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the model</span></span>
<span id="cb258-3"><a href="#cb258-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Build model...'</span>)</span>
<span id="cb258-4"><a href="#cb258-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb258-5"><a href="#cb258-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with Neurons </span></span>
<span id="cb258-6"><a href="#cb258-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputshape = neurons -&gt; Timestamps</span></span>
<span id="cb258-7"><a href="#cb258-7" aria-hidden="true" tabindex="-1"></a>neurons<span class="op">=</span> x_train.shape[<span class="dv">1</span>]</span>
<span id="cb258-8"><a href="#cb258-8" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">90</span>, </span>
<span id="cb258-9"><a href="#cb258-9" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb258-10"><a href="#cb258-10" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>, </span>
<span id="cb258-11"><a href="#cb258-11" aria-hidden="true" tabindex="-1"></a>               input_shape <span class="op">=</span> (x_train.shape[<span class="dv">1</span>], <span class="dv">8</span>))) </span>
<span id="cb258-12"><a href="#cb258-12" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">50</span>, </span>
<span id="cb258-13"><a href="#cb258-13" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb258-14"><a href="#cb258-14" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>)) </span>
<span id="cb258-15"><a href="#cb258-15" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">25</span>, </span>
<span id="cb258-16"><a href="#cb258-16" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb258-17"><a href="#cb258-17" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">False</span>)) </span>
<span id="cb258-18"><a href="#cb258-18" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">5</span>, activation <span class="op">=</span> <span class="st">'relu'</span>))</span>
<span id="cb258-19"><a href="#cb258-19" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Build model...</code></pre>
</div>
</div>
<div class="cell" data-execution_count="113">
<div class="sourceCode cell-code" id="cb260"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mean_squared_error'</span>)</span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "sequential_5"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Layer (type)                Output Shape              Param #   </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_15 (LSTM)              (None, 90, 90)            35640     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_16 (LSTM)              (None, 90, 50)            28200     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_17 (LSTM)              (None, 25)                7600      </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_10 (Dense)            (None, 5)                 130       </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_11 (Dense)            (None, 1)                 6         </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Total params: 71,576</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Trainable params: 71,576</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Non-trainable params: 0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
</div>
<div class="cell" data-execution_count="114">
<div class="sourceCode cell-code" id="cb280"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model</span></span>
<span id="cb280-2"><a href="#cb280-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fit network</span></span>
<span id="cb280-3"><a href="#cb280-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(x_train, </span>
<span id="cb280-4"><a href="#cb280-4" aria-hidden="true" tabindex="-1"></a>                    y_train, </span>
<span id="cb280-5"><a href="#cb280-5" aria-hidden="true" tabindex="-1"></a>                    batch_size<span class="op">=</span><span class="dv">1000</span>, </span>
<span id="cb280-6"><a href="#cb280-6" aria-hidden="true" tabindex="-1"></a>                    epochs<span class="op">=</span><span class="dv">50</span>, </span>
<span id="cb280-7"><a href="#cb280-7" aria-hidden="true" tabindex="-1"></a>                    validation_data <span class="op">=</span> (x_test, y_test), </span>
<span id="cb280-8"><a href="#cb280-8" aria-hidden="true" tabindex="-1"></a>                    verbose <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="115">
<div class="sourceCode cell-code" id="cb281"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb281-1"><a href="#cb281-1" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'loss'</span>], label<span class="op">=</span><span class="st">'train'</span>)</span>
<span id="cb281-2"><a href="#cb281-2" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'val_loss'</span>], label<span class="op">=</span><span class="st">'test'</span>)</span>
<span id="cb281-3"><a href="#cb281-3" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb281-4"><a href="#cb281-4" aria-hidden="true" tabindex="-1"></a>plt.show() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_multi_files/figure-html/cell-116-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="116">
<div class="sourceCode cell-code" id="cb282"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predicted values</span></span>
<span id="cb282-2"><a href="#cb282-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.predict(x_test)</span>
<span id="cb282-3"><a href="#cb282-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> scaler_pred.inverse_transform(predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>WARNING:tensorflow:5 out of the last 13 calls to &lt;function Model.make_predict_function.&lt;locals&gt;.predict_function at 0x7fd53efb6310&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>1/3 [=========&gt;....................] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - 0s 31ms/step</code></pre>
</div>
</div>
<div class="cell" data-execution_count="117">
<div class="sourceCode cell-code" id="cb287"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb287-1"><a href="#cb287-1" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y_test.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb287-2"><a href="#cb287-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaler_pred.inverse_transform(y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="118">
<div class="sourceCode cell-code" id="cb288"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean absolute error (MAE)</span></span>
<span id="cb288-2"><a href="#cb288-2" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, predictions)</span>
<span id="cb288-3"><a href="#cb288-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MAE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(mae, <span class="dv">1</span>)))</span>
<span id="cb288-4"><a href="#cb288-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-5"><a href="#cb288-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb288-6"><a href="#cb288-6" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test,predictions))</span>
<span id="cb288-7"><a href="#cb288-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span>
<span id="cb288-8"><a href="#cb288-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-9"><a href="#cb288-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb288-10"><a href="#cb288-10" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> mean_squared_error(y_test, </span>
<span id="cb288-11"><a href="#cb288-11" aria-hidden="true" tabindex="-1"></a>                          predictions,</span>
<span id="cb288-12"><a href="#cb288-12" aria-hidden="true" tabindex="-1"></a>                          squared <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb288-13"><a href="#cb288-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE: 263.9
RMSE: 465.3
RMSE: 465.3</code></pre>
</div>
</div>
<div class="cell" data-execution_count="119">
<div class="sourceCode cell-code" id="cb290"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the difference between the valid and predicted prices</span></span>
<span id="cb290-2"><a href="#cb290-2" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> data_asturias[:(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">92</span>)]</span>
<span id="cb290-3"><a href="#cb290-3" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> data_asturias[(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">91</span>):]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="120">
<div class="sourceCode cell-code" id="cb291"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb291-1"><a href="#cb291-1" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Predictions"</span>, predictions, <span class="va">True</span>)</span>
<span id="cb291-2"><a href="#cb291-2" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Difference"</span>, valid[<span class="st">"Predictions"</span>] <span class="op">-</span> valid[<span class="st">"num_casos"</span>], <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="121">
<div class="sourceCode cell-code" id="cb292"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb292-1"><a href="#cb292-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Zoom-in to a closer timeframe</span></span>
<span id="cb292-2"><a href="#cb292-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Date from which on the date is displayed</span></span>
<span id="cb292-3"><a href="#cb292-3" aria-hidden="true" tabindex="-1"></a>display_start_date <span class="op">=</span> <span class="st">"2021-07-15"</span> </span>
<span id="cb292-4"><a href="#cb292-4" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> valid[valid.index <span class="op">&gt;</span> display_start_date]</span>
<span id="cb292-5"><a href="#cb292-5" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> train[train.index <span class="op">&gt;</span> display_start_date]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="122">
<div class="sourceCode cell-code" id="cb293"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb293-1"><a href="#cb293-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the data</span></span>
<span id="cb293-2"><a href="#cb293-2" aria-hidden="true" tabindex="-1"></a>matplotlib.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb293-3"><a href="#cb293-3" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">22</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb293-4"><a href="#cb293-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-5"><a href="#cb293-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Train</span></span>
<span id="cb293-6"><a href="#cb293-6" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> train.index<span class="op">;</span> </span>
<span id="cb293-7"><a href="#cb293-7" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> train[[<span class="st">"num_casos"</span>]]</span>
<span id="cb293-8"><a href="#cb293-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Test / validation </span></span>
<span id="cb293-9"><a href="#cb293-9" aria-hidden="true" tabindex="-1"></a>xv <span class="op">=</span> valid.index<span class="op">;</span> </span>
<span id="cb293-10"><a href="#cb293-10" aria-hidden="true" tabindex="-1"></a>yv <span class="op">=</span> valid[[<span class="st">"num_casos"</span>, <span class="st">"Predictions"</span>]]</span>
<span id="cb293-11"><a href="#cb293-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-12"><a href="#cb293-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb293-13"><a href="#cb293-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Asturias: Predictions vs Real infections"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb293-14"><a href="#cb293-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Nº Cases"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb293-15"><a href="#cb293-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-16"><a href="#cb293-16" aria-hidden="true" tabindex="-1"></a>plt.plot(yt, color<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb293-17"><a href="#cb293-17" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"Predictions"</span>], color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb293-18"><a href="#cb293-18" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"num_casos"</span>], color<span class="op">=</span><span class="st">"green"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb293-19"><a href="#cb293-19" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"LSTM Predictions"</span>, <span class="st">"Test"</span>], </span>
<span id="cb293-20"><a href="#cb293-20" aria-hidden="true" tabindex="-1"></a>           loc<span class="op">=</span><span class="st">"upper left"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb293-21"><a href="#cb293-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-22"><a href="#cb293-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot with the differences</span></span>
<span id="cb293-23"><a href="#cb293-23" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> valid.index</span>
<span id="cb293-24"><a href="#cb293-24" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> valid[<span class="st">"Difference"</span>]</span>
<span id="cb293-25"><a href="#cb293-25" aria-hidden="true" tabindex="-1"></a>plt.bar(x, y, width<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">"grey"</span>)</span>
<span id="cb293-26"><a href="#cb293-26" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb293-27"><a href="#cb293-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_multi_files/figure-html/cell-123-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="barcelona-1" class="level2">
<h2 class="anchored" data-anchor-id="barcelona-1">Barcelona</h2>
<div class="cell" data-execution_count="123">
<div class="sourceCode cell-code" id="cb294"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a>data_barcelona <span class="op">=</span> data_covid.loc[data_covid[<span class="st">'provincia'</span>] <span class="op">==</span> <span class="st">'Barcelona'</span>]</span>
<span id="cb294-2"><a href="#cb294-2" aria-hidden="true" tabindex="-1"></a>data_barcelona <span class="op">=</span> data_barcelona.set_index(<span class="st">'fecha'</span>)</span>
<span id="cb294-3"><a href="#cb294-3" aria-hidden="true" tabindex="-1"></a>data_barcelona <span class="op">=</span> data_barcelona[<span class="st">'2020-06-14'</span>:<span class="st">'2021-12-31'</span>]</span>
<span id="cb294-4"><a href="#cb294-4" aria-hidden="true" tabindex="-1"></a>data_barcelona <span class="op">=</span> data_barcelona.<span class="bu">filter</span>([<span class="st">'num_casos'</span>, <span class="st">'tmed'</span>, <span class="st">'mob_grocery_pharmacy'</span>, </span>
<span id="cb294-5"><a href="#cb294-5" aria-hidden="true" tabindex="-1"></a><span class="st">'mob_parks'</span>, <span class="st">'mob_residential'</span>, <span class="st">'mob_residential'</span>, <span class="st">'mob_transit_stations'</span>, <span class="st">'mob_workplaces'</span>])</span>
<span id="cb294-6"><a href="#cb294-6" aria-hidden="true" tabindex="-1"></a>data_barcelona</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="123">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
      <th>tmed</th>
      <th>mob_grocery_pharmacy</th>
      <th>mob_parks</th>
      <th>mob_residential</th>
      <th>mob_residential</th>
      <th>mob_transit_stations</th>
      <th>mob_workplaces</th>
    </tr>
    <tr>
      <th>fecha</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-14</th>
      <td>33</td>
      <td>20.6</td>
      <td>-20.0</td>
      <td>15.0</td>
      <td>6.0</td>
      <td>6.0</td>
      <td>-31.0</td>
      <td>-6.0</td>
    </tr>
    <tr>
      <th>2020-06-15</th>
      <td>62</td>
      <td>21.2</td>
      <td>-9.0</td>
      <td>17.0</td>
      <td>14.0</td>
      <td>14.0</td>
      <td>-34.0</td>
      <td>-41.0</td>
    </tr>
    <tr>
      <th>2020-06-16</th>
      <td>66</td>
      <td>20.8</td>
      <td>-10.0</td>
      <td>-16.0</td>
      <td>16.0</td>
      <td>16.0</td>
      <td>-39.0</td>
      <td>-41.0</td>
    </tr>
    <tr>
      <th>2020-06-17</th>
      <td>70</td>
      <td>20.3</td>
      <td>-4.0</td>
      <td>14.0</td>
      <td>15.0</td>
      <td>15.0</td>
      <td>-33.0</td>
      <td>-40.0</td>
    </tr>
    <tr>
      <th>2020-06-18</th>
      <td>68</td>
      <td>18.8</td>
      <td>-8.0</td>
      <td>-6.0</td>
      <td>16.0</td>
      <td>16.0</td>
      <td>-38.0</td>
      <td>-41.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2021-12-27</th>
      <td>19383</td>
      <td>16.4</td>
      <td>15.0</td>
      <td>7.0</td>
      <td>12.0</td>
      <td>12.0</td>
      <td>-25.0</td>
      <td>-52.0</td>
    </tr>
    <tr>
      <th>2021-12-28</th>
      <td>20192</td>
      <td>17.7</td>
      <td>17.0</td>
      <td>7.0</td>
      <td>13.0</td>
      <td>13.0</td>
      <td>-25.0</td>
      <td>-52.0</td>
    </tr>
    <tr>
      <th>2021-12-29</th>
      <td>19361</td>
      <td>17.0</td>
      <td>23.0</td>
      <td>10.0</td>
      <td>13.0</td>
      <td>13.0</td>
      <td>-25.0</td>
      <td>-51.0</td>
    </tr>
    <tr>
      <th>2021-12-30</th>
      <td>17639</td>
      <td>15.8</td>
      <td>37.0</td>
      <td>6.0</td>
      <td>12.0</td>
      <td>12.0</td>
      <td>-24.0</td>
      <td>-53.0</td>
    </tr>
    <tr>
      <th>2021-12-31</th>
      <td>16651</td>
      <td>13.6</td>
      <td>26.0</td>
      <td>-12.0</td>
      <td>16.0</td>
      <td>16.0</td>
      <td>-36.0</td>
      <td>-60.0</td>
    </tr>
  </tbody>
</table>
<p>566 rows × 8 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="124">
<div class="sourceCode cell-code" id="cb295"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a>data_barcelona.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="124">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
      <th>tmed</th>
      <th>mob_grocery_pharmacy</th>
      <th>mob_parks</th>
      <th>mob_residential</th>
      <th>mob_residential</th>
      <th>mob_transit_stations</th>
      <th>mob_workplaces</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>1575.480565</td>
      <td>18.205477</td>
      <td>-0.574205</td>
      <td>-4.651943</td>
      <td>7.353357</td>
      <td>7.353357</td>
      <td>-24.865724</td>
      <td>-28.471731</td>
    </tr>
    <tr>
      <th>std</th>
      <td>2281.290383</td>
      <td>6.086976</td>
      <td>16.775476</td>
      <td>15.728472</td>
      <td>5.162377</td>
      <td>5.162377</td>
      <td>11.574598</td>
      <td>16.238872</td>
    </tr>
    <tr>
      <th>min</th>
      <td>33.000000</td>
      <td>4.300000</td>
      <td>-83.000000</td>
      <td>-76.000000</td>
      <td>-6.000000</td>
      <td>-6.000000</td>
      <td>-72.000000</td>
      <td>-87.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>544.750000</td>
      <td>12.800000</td>
      <td>-7.000000</td>
      <td>-14.750000</td>
      <td>4.000000</td>
      <td>4.000000</td>
      <td>-33.000000</td>
      <td>-36.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>944.500000</td>
      <td>17.800000</td>
      <td>0.500000</td>
      <td>-4.000000</td>
      <td>8.000000</td>
      <td>8.000000</td>
      <td>-25.000000</td>
      <td>-26.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>1609.500000</td>
      <td>24.375000</td>
      <td>10.000000</td>
      <td>7.000000</td>
      <td>10.000000</td>
      <td>10.000000</td>
      <td>-15.000000</td>
      <td>-19.250000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>20192.000000</td>
      <td>28.400000</td>
      <td>58.000000</td>
      <td>33.000000</td>
      <td>32.000000</td>
      <td>32.000000</td>
      <td>-2.000000</td>
      <td>6.000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="125">
<div class="sourceCode cell-code" id="cb296"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb296-1"><a href="#cb296-1" aria-hidden="true" tabindex="-1"></a>np_data_barcelona <span class="op">=</span> data_barcelona.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="126">
<div class="sourceCode cell-code" id="cb297"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb297-1"><a href="#cb297-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train dataset</span></span>
<span id="cb297-2"><a href="#cb297-2" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb297-3"><a href="#cb297-3" aria-hidden="true" tabindex="-1"></a>scaled_data_barcelona <span class="op">=</span> scaler.fit_transform(np_data_barcelona)</span>
<span id="cb297-4"><a href="#cb297-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud del conjunto de datos disponible: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_barcelona)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud del conjunto de datos disponible: 566</code></pre>
</div>
</div>
<div class="cell" data-execution_count="127">
<div class="sourceCode cell-code" id="cb299"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb299-1"><a href="#cb299-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we are going to predict future values based on the 90 past elements, </span></span>
<span id="cb299-2"><a href="#cb299-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to create a list with those historic information for each element</span></span>
<span id="cb299-3"><a href="#cb299-3" aria-hidden="true" tabindex="-1"></a>historic_values <span class="op">=</span> <span class="dv">90</span></span>
<span id="cb299-4"><a href="#cb299-4" aria-hidden="true" tabindex="-1"></a>scaled_data_barcelona_x <span class="op">=</span> []</span>
<span id="cb299-5"><a href="#cb299-5" aria-hidden="true" tabindex="-1"></a>scaled_data_barcelona_y <span class="op">=</span> []</span>
<span id="cb299-6"><a href="#cb299-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb299-7"><a href="#cb299-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(historic_values, <span class="bu">len</span>(scaled_data_barcelona)):</span>
<span id="cb299-8"><a href="#cb299-8" aria-hidden="true" tabindex="-1"></a>    scaled_data_barcelona_x.append(scaled_data_barcelona[(i<span class="op">-</span>historic_values):i, :])</span>
<span id="cb299-9"><a href="#cb299-9" aria-hidden="true" tabindex="-1"></a>    scaled_data_barcelona_y.append(scaled_data_barcelona[i, <span class="dv">0</span>])</span>
<span id="cb299-10"><a href="#cb299-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb299-11"><a href="#cb299-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the x_train and y_train to numpy arrays</span></span>
<span id="cb299-12"><a href="#cb299-12" aria-hidden="true" tabindex="-1"></a>scaled_data_barcelona_x <span class="op">=</span> np.array(scaled_data_barcelona_x)</span>
<span id="cb299-13"><a href="#cb299-13" aria-hidden="true" tabindex="-1"></a>scaled_data_barcelona_y <span class="op">=</span> np.array(scaled_data_barcelona_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="128">
<div class="sourceCode cell-code" id="cb300"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Once predicted, we are going to need a exclusive scaler for num_cases</span></span>
<span id="cb300-2"><a href="#cb300-2" aria-hidden="true" tabindex="-1"></a>scaler_pred <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb300-3"><a href="#cb300-3" aria-hidden="true" tabindex="-1"></a>df_cases_barcelona <span class="op">=</span> pd.DataFrame(data_barcelona[<span class="st">'num_casos'</span>])</span>
<span id="cb300-4"><a href="#cb300-4" aria-hidden="true" tabindex="-1"></a>scaled_data_barcelona_pred <span class="op">=</span> scaler_pred.fit_transform(df_cases_barcelona)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="129">
<div class="sourceCode cell-code" id="cb301"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb301-1"><a href="#cb301-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since the first 90th values does not have historic, the dataset has been reduced in 90 values</span></span>
<span id="cb301-2"><a href="#cb301-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud datos de entrenamiento con historico: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_barcelona_y)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud datos de entrenamiento con historico: 476</code></pre>
</div>
</div>
<div class="cell" data-execution_count="130">
<div class="sourceCode cell-code" id="cb303"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb303-1"><a href="#cb303-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we split data in train and test</span></span>
<span id="cb303-2"><a href="#cb303-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as in previous analysis, we are going to predict a maximum of 90 days</span></span>
<span id="cb303-3"><a href="#cb303-3" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> scaled_data_barcelona_x[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_barcelona_x)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb303-4"><a href="#cb303-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> scaled_data_barcelona_y[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_barcelona_y)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb303-5"><a href="#cb303-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de entrenamiento: x=</span><span class="sc">{</span><span class="bu">len</span>(x_train)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb303-6"><a href="#cb303-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-7"><a href="#cb303-7" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> scaled_data_barcelona_x[<span class="bu">len</span>(scaled_data_barcelona_x)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_barcelona_x)]</span>
<span id="cb303-8"><a href="#cb303-8" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaled_data_barcelona_y[<span class="bu">len</span>(scaled_data_barcelona_y)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_barcelona_y)]</span>
<span id="cb303-9"><a href="#cb303-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de test: x=</span><span class="sc">{</span><span class="bu">len</span>(x_test)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_test)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cantidad datos de entrenamiento: x=385 - y=385
Cantidad datos de test: x=90 - y=90</code></pre>
</div>
</div>
<div class="cell" data-execution_count="131">
<div class="sourceCode cell-code" id="cb305"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data to feed de recurrent network</span></span>
<span id="cb305-2"><a href="#cb305-2" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> np.reshape(x_train, (x_train.shape[<span class="dv">0</span>], x_train.shape[<span class="dv">1</span>], <span class="dv">8</span>))</span>
<span id="cb305-3"><a href="#cb305-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train data shape:"</span>)</span>
<span id="cb305-4"><a href="#cb305-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_train.shape)</span>
<span id="cb305-5"><a href="#cb305-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_train.shape)</span>
<span id="cb305-6"><a href="#cb305-6" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> np.reshape(x_test, (x_test.shape[<span class="dv">0</span>], x_test.shape[<span class="dv">1</span>], <span class="dv">8</span>))</span>
<span id="cb305-7"><a href="#cb305-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test data shape:"</span>)</span>
<span id="cb305-8"><a href="#cb305-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_test.shape)</span>
<span id="cb305-9"><a href="#cb305-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train data shape:
(385, 90, 8)
(385,)
Test data shape:
(90, 90, 8)
(90,)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="132">
<div class="sourceCode cell-code" id="cb307"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb307-1"><a href="#cb307-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure / setup the neural network model - LSTM</span></span>
<span id="cb307-2"><a href="#cb307-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the model</span></span>
<span id="cb307-3"><a href="#cb307-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Build model...'</span>)</span>
<span id="cb307-4"><a href="#cb307-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb307-5"><a href="#cb307-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with Neurons </span></span>
<span id="cb307-6"><a href="#cb307-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputshape = neurons -&gt; Timestamps</span></span>
<span id="cb307-7"><a href="#cb307-7" aria-hidden="true" tabindex="-1"></a>neurons<span class="op">=</span> x_train.shape[<span class="dv">1</span>]</span>
<span id="cb307-8"><a href="#cb307-8" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">90</span>, </span>
<span id="cb307-9"><a href="#cb307-9" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb307-10"><a href="#cb307-10" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>, </span>
<span id="cb307-11"><a href="#cb307-11" aria-hidden="true" tabindex="-1"></a>               input_shape <span class="op">=</span> (x_train.shape[<span class="dv">1</span>], <span class="dv">8</span>))) </span>
<span id="cb307-12"><a href="#cb307-12" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">50</span>, </span>
<span id="cb307-13"><a href="#cb307-13" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb307-14"><a href="#cb307-14" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>)) </span>
<span id="cb307-15"><a href="#cb307-15" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">25</span>, </span>
<span id="cb307-16"><a href="#cb307-16" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb307-17"><a href="#cb307-17" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">False</span>)) </span>
<span id="cb307-18"><a href="#cb307-18" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">5</span>, activation <span class="op">=</span> <span class="st">'relu'</span>))</span>
<span id="cb307-19"><a href="#cb307-19" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Build model...</code></pre>
</div>
</div>
<div class="cell" data-execution_count="133">
<div class="sourceCode cell-code" id="cb309"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb309-1"><a href="#cb309-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mean_squared_error'</span>)</span>
<span id="cb309-2"><a href="#cb309-2" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "sequential_6"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Layer (type)                Output Shape              Param #   </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_18 (LSTM)              (None, 90, 90)            35640     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_19 (LSTM)              (None, 90, 50)            28200     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_20 (LSTM)              (None, 25)                7600      </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_12 (Dense)            (None, 5)                 130       </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_13 (Dense)            (None, 1)                 6         </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Total params: 71,576</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Trainable params: 71,576</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Non-trainable params: 0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
</div>
<div class="cell" data-execution_count="134">
<div class="sourceCode cell-code" id="cb329"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb329-1"><a href="#cb329-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model</span></span>
<span id="cb329-2"><a href="#cb329-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fit network</span></span>
<span id="cb329-3"><a href="#cb329-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(x_train, </span>
<span id="cb329-4"><a href="#cb329-4" aria-hidden="true" tabindex="-1"></a>                    y_train, </span>
<span id="cb329-5"><a href="#cb329-5" aria-hidden="true" tabindex="-1"></a>                    batch_size<span class="op">=</span><span class="dv">1000</span>, </span>
<span id="cb329-6"><a href="#cb329-6" aria-hidden="true" tabindex="-1"></a>                    epochs<span class="op">=</span><span class="dv">50</span>, </span>
<span id="cb329-7"><a href="#cb329-7" aria-hidden="true" tabindex="-1"></a>                    validation_data <span class="op">=</span> (x_test, y_test), </span>
<span id="cb329-8"><a href="#cb329-8" aria-hidden="true" tabindex="-1"></a>                    verbose <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="135">
<div class="sourceCode cell-code" id="cb330"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb330-1"><a href="#cb330-1" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'loss'</span>], label<span class="op">=</span><span class="st">'train'</span>)</span>
<span id="cb330-2"><a href="#cb330-2" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'val_loss'</span>], label<span class="op">=</span><span class="st">'test'</span>)</span>
<span id="cb330-3"><a href="#cb330-3" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb330-4"><a href="#cb330-4" aria-hidden="true" tabindex="-1"></a>plt.show() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_multi_files/figure-html/cell-136-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="136">
<div class="sourceCode cell-code" id="cb331"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb331-1"><a href="#cb331-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predicted values</span></span>
<span id="cb331-2"><a href="#cb331-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.predict(x_test)</span>
<span id="cb331-3"><a href="#cb331-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> scaler_pred.inverse_transform(predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1/3 [=========&gt;....................] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - 0s 31ms/step</code></pre>
</div>
</div>
<div class="cell" data-execution_count="137">
<div class="sourceCode cell-code" id="cb335"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb335-1"><a href="#cb335-1" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y_test.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb335-2"><a href="#cb335-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaler_pred.inverse_transform(y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="138">
<div class="sourceCode cell-code" id="cb336"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb336-1"><a href="#cb336-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean absolute error (MAE)</span></span>
<span id="cb336-2"><a href="#cb336-2" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, predictions)</span>
<span id="cb336-3"><a href="#cb336-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MAE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(mae, <span class="dv">1</span>)))</span>
<span id="cb336-4"><a href="#cb336-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb336-5"><a href="#cb336-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb336-6"><a href="#cb336-6" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test,predictions))</span>
<span id="cb336-7"><a href="#cb336-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span>
<span id="cb336-8"><a href="#cb336-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb336-9"><a href="#cb336-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb336-10"><a href="#cb336-10" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> mean_squared_error(y_test, </span>
<span id="cb336-11"><a href="#cb336-11" aria-hidden="true" tabindex="-1"></a>                          predictions,</span>
<span id="cb336-12"><a href="#cb336-12" aria-hidden="true" tabindex="-1"></a>                          squared <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb336-13"><a href="#cb336-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE: 2657.6
RMSE: 4156.6
RMSE: 4156.6</code></pre>
</div>
</div>
<div class="cell" data-execution_count="139">
<div class="sourceCode cell-code" id="cb338"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb338-1"><a href="#cb338-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the difference between the valid and predicted prices</span></span>
<span id="cb338-2"><a href="#cb338-2" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> data_barcelona[:(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">92</span>)]</span>
<span id="cb338-3"><a href="#cb338-3" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> data_barcelona[(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">91</span>):]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="140">
<div class="sourceCode cell-code" id="cb339"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb339-1"><a href="#cb339-1" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Predictions"</span>, predictions, <span class="va">True</span>)</span>
<span id="cb339-2"><a href="#cb339-2" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Difference"</span>, valid[<span class="st">"Predictions"</span>] <span class="op">-</span> valid[<span class="st">"num_casos"</span>], <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="141">
<div class="sourceCode cell-code" id="cb340"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb340-1"><a href="#cb340-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Zoom-in to a closer timeframe</span></span>
<span id="cb340-2"><a href="#cb340-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Date from which on the date is displayed</span></span>
<span id="cb340-3"><a href="#cb340-3" aria-hidden="true" tabindex="-1"></a>display_start_date <span class="op">=</span> <span class="st">"2021-07-15"</span> </span>
<span id="cb340-4"><a href="#cb340-4" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> valid[valid.index <span class="op">&gt;</span> display_start_date]</span>
<span id="cb340-5"><a href="#cb340-5" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> train[train.index <span class="op">&gt;</span> display_start_date]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="142">
<div class="sourceCode cell-code" id="cb341"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb341-1"><a href="#cb341-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the data</span></span>
<span id="cb341-2"><a href="#cb341-2" aria-hidden="true" tabindex="-1"></a>matplotlib.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb341-3"><a href="#cb341-3" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">22</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb341-4"><a href="#cb341-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb341-5"><a href="#cb341-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Train</span></span>
<span id="cb341-6"><a href="#cb341-6" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> train.index<span class="op">;</span> </span>
<span id="cb341-7"><a href="#cb341-7" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> train[[<span class="st">"num_casos"</span>]]</span>
<span id="cb341-8"><a href="#cb341-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Test / validation </span></span>
<span id="cb341-9"><a href="#cb341-9" aria-hidden="true" tabindex="-1"></a>xv <span class="op">=</span> valid.index<span class="op">;</span> </span>
<span id="cb341-10"><a href="#cb341-10" aria-hidden="true" tabindex="-1"></a>yv <span class="op">=</span> valid[[<span class="st">"num_casos"</span>, <span class="st">"Predictions"</span>]]</span>
<span id="cb341-11"><a href="#cb341-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb341-12"><a href="#cb341-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb341-13"><a href="#cb341-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"barcelona: Predictions vs Real infections"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb341-14"><a href="#cb341-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Nº Cases"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb341-15"><a href="#cb341-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb341-16"><a href="#cb341-16" aria-hidden="true" tabindex="-1"></a>plt.plot(yt, color<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb341-17"><a href="#cb341-17" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"Predictions"</span>], color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb341-18"><a href="#cb341-18" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"num_casos"</span>], color<span class="op">=</span><span class="st">"green"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb341-19"><a href="#cb341-19" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"LSTM Predictions"</span>, <span class="st">"Test"</span>], </span>
<span id="cb341-20"><a href="#cb341-20" aria-hidden="true" tabindex="-1"></a>           loc<span class="op">=</span><span class="st">"upper left"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb341-21"><a href="#cb341-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb341-22"><a href="#cb341-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot with the differences</span></span>
<span id="cb341-23"><a href="#cb341-23" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> valid.index</span>
<span id="cb341-24"><a href="#cb341-24" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> valid[<span class="st">"Difference"</span>]</span>
<span id="cb341-25"><a href="#cb341-25" aria-hidden="true" tabindex="-1"></a>plt.bar(x, y, width<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">"grey"</span>)</span>
<span id="cb341-26"><a href="#cb341-26" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb341-27"><a href="#cb341-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_multi_files/figure-html/cell-143-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="madrid-1" class="level2">
<h2 class="anchored" data-anchor-id="madrid-1">Madrid</h2>
<div class="cell" data-execution_count="143">
<div class="sourceCode cell-code" id="cb342"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb342-1"><a href="#cb342-1" aria-hidden="true" tabindex="-1"></a>data_madrid <span class="op">=</span> data_covid.loc[data_covid[<span class="st">'provincia'</span>] <span class="op">==</span> <span class="st">'Madrid'</span>]</span>
<span id="cb342-2"><a href="#cb342-2" aria-hidden="true" tabindex="-1"></a>data_madrid <span class="op">=</span> data_madrid.set_index(<span class="st">'fecha'</span>)</span>
<span id="cb342-3"><a href="#cb342-3" aria-hidden="true" tabindex="-1"></a>data_madrid <span class="op">=</span> data_madrid[<span class="st">'2020-06-14'</span>:<span class="st">'2021-12-31'</span>]</span>
<span id="cb342-4"><a href="#cb342-4" aria-hidden="true" tabindex="-1"></a>data_madrid <span class="op">=</span> data_madrid.<span class="bu">filter</span>([<span class="st">'num_casos'</span>, <span class="st">'tmed'</span>, <span class="st">'mob_grocery_pharmacy'</span>, </span>
<span id="cb342-5"><a href="#cb342-5" aria-hidden="true" tabindex="-1"></a><span class="st">'mob_parks'</span>, <span class="st">'mob_residential'</span>, <span class="st">'mob_residential'</span>, <span class="st">'mob_transit_stations'</span>, <span class="st">'mob_workplaces'</span>])</span>
<span id="cb342-6"><a href="#cb342-6" aria-hidden="true" tabindex="-1"></a>data_madrid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="143">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
      <th>tmed</th>
      <th>mob_grocery_pharmacy</th>
      <th>mob_parks</th>
      <th>mob_residential</th>
      <th>mob_residential</th>
      <th>mob_transit_stations</th>
      <th>mob_workplaces</th>
    </tr>
    <tr>
      <th>fecha</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-14</th>
      <td>81</td>
      <td>19.0</td>
      <td>-15.0</td>
      <td>25.0</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>-43.0</td>
      <td>-6.0</td>
    </tr>
    <tr>
      <th>2020-06-15</th>
      <td>153</td>
      <td>20.7</td>
      <td>-8.0</td>
      <td>34.0</td>
      <td>16.0</td>
      <td>16.0</td>
      <td>-43.0</td>
      <td>-47.0</td>
    </tr>
    <tr>
      <th>2020-06-16</th>
      <td>91</td>
      <td>21.0</td>
      <td>-8.0</td>
      <td>21.0</td>
      <td>17.0</td>
      <td>17.0</td>
      <td>-43.0</td>
      <td>-47.0</td>
    </tr>
    <tr>
      <th>2020-06-17</th>
      <td>93</td>
      <td>20.2</td>
      <td>-5.0</td>
      <td>34.0</td>
      <td>17.0</td>
      <td>17.0</td>
      <td>-42.0</td>
      <td>-47.0</td>
    </tr>
    <tr>
      <th>2020-06-18</th>
      <td>85</td>
      <td>21.9</td>
      <td>-7.0</td>
      <td>30.0</td>
      <td>16.0</td>
      <td>16.0</td>
      <td>-44.0</td>
      <td>-47.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2021-12-27</th>
      <td>22958</td>
      <td>12.3</td>
      <td>21.0</td>
      <td>19.0</td>
      <td>12.0</td>
      <td>12.0</td>
      <td>-28.0</td>
      <td>-52.0</td>
    </tr>
    <tr>
      <th>2021-12-28</th>
      <td>23811</td>
      <td>10.4</td>
      <td>18.0</td>
      <td>23.0</td>
      <td>12.0</td>
      <td>12.0</td>
      <td>-30.0</td>
      <td>-52.0</td>
    </tr>
    <tr>
      <th>2021-12-29</th>
      <td>21914</td>
      <td>9.0</td>
      <td>27.0</td>
      <td>18.0</td>
      <td>13.0</td>
      <td>13.0</td>
      <td>-30.0</td>
      <td>-52.0</td>
    </tr>
    <tr>
      <th>2021-12-30</th>
      <td>20666</td>
      <td>8.7</td>
      <td>42.0</td>
      <td>17.0</td>
      <td>12.0</td>
      <td>12.0</td>
      <td>-30.0</td>
      <td>-53.0</td>
    </tr>
    <tr>
      <th>2021-12-31</th>
      <td>7556</td>
      <td>9.2</td>
      <td>10.0</td>
      <td>-15.0</td>
      <td>18.0</td>
      <td>18.0</td>
      <td>-47.0</td>
      <td>-69.0</td>
    </tr>
  </tbody>
</table>
<p>566 rows × 8 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="144">
<div class="sourceCode cell-code" id="cb343"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb343-1"><a href="#cb343-1" aria-hidden="true" tabindex="-1"></a>data_madrid.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="144">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
      <th>tmed</th>
      <th>mob_grocery_pharmacy</th>
      <th>mob_parks</th>
      <th>mob_residential</th>
      <th>mob_residential</th>
      <th>mob_transit_stations</th>
      <th>mob_workplaces</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>1994.136042</td>
      <td>16.004064</td>
      <td>-3.793286</td>
      <td>-4.438163</td>
      <td>7.238516</td>
      <td>7.238516</td>
      <td>-31.560071</td>
      <td>-28.715548</td>
    </tr>
    <tr>
      <th>std</th>
      <td>2795.419848</td>
      <td>8.085617</td>
      <td>14.945139</td>
      <td>21.384112</td>
      <td>5.850467</td>
      <td>5.850467</td>
      <td>12.292703</td>
      <td>19.230654</td>
    </tr>
    <tr>
      <th>min</th>
      <td>28.000000</td>
      <td>-6.200000</td>
      <td>-84.000000</td>
      <td>-62.000000</td>
      <td>-6.000000</td>
      <td>-6.000000</td>
      <td>-73.000000</td>
      <td>-86.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>550.250000</td>
      <td>9.525000</td>
      <td>-11.000000</td>
      <td>-17.750000</td>
      <td>4.000000</td>
      <td>4.000000</td>
      <td>-40.000000</td>
      <td>-41.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>1312.500000</td>
      <td>14.700000</td>
      <td>-3.000000</td>
      <td>-3.000000</td>
      <td>7.000000</td>
      <td>7.000000</td>
      <td>-33.000000</td>
      <td>-28.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>2282.500000</td>
      <td>23.200000</td>
      <td>6.000000</td>
      <td>11.750000</td>
      <td>11.000000</td>
      <td>11.000000</td>
      <td>-24.000000</td>
      <td>-17.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>23811.000000</td>
      <td>32.700000</td>
      <td>50.000000</td>
      <td>77.000000</td>
      <td>31.000000</td>
      <td>31.000000</td>
      <td>1.000000</td>
      <td>20.000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="145">
<div class="sourceCode cell-code" id="cb344"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb344-1"><a href="#cb344-1" aria-hidden="true" tabindex="-1"></a>np_data_madrid <span class="op">=</span> data_madrid.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="146">
<div class="sourceCode cell-code" id="cb345"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb345-1"><a href="#cb345-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train dataset</span></span>
<span id="cb345-2"><a href="#cb345-2" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb345-3"><a href="#cb345-3" aria-hidden="true" tabindex="-1"></a>scaled_data_madrid <span class="op">=</span> scaler.fit_transform(np_data_madrid)</span>
<span id="cb345-4"><a href="#cb345-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud del conjunto de datos disponible: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_madrid)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud del conjunto de datos disponible: 566</code></pre>
</div>
</div>
<div class="cell" data-execution_count="147">
<div class="sourceCode cell-code" id="cb347"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb347-1"><a href="#cb347-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we are going to predict future values based on the 90 past elements, </span></span>
<span id="cb347-2"><a href="#cb347-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to create a list with those historic information for each element</span></span>
<span id="cb347-3"><a href="#cb347-3" aria-hidden="true" tabindex="-1"></a>historic_values <span class="op">=</span> <span class="dv">90</span></span>
<span id="cb347-4"><a href="#cb347-4" aria-hidden="true" tabindex="-1"></a>scaled_data_madrid_x <span class="op">=</span> []</span>
<span id="cb347-5"><a href="#cb347-5" aria-hidden="true" tabindex="-1"></a>scaled_data_madrid_y <span class="op">=</span> []</span>
<span id="cb347-6"><a href="#cb347-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-7"><a href="#cb347-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(historic_values, <span class="bu">len</span>(scaled_data_madrid)):</span>
<span id="cb347-8"><a href="#cb347-8" aria-hidden="true" tabindex="-1"></a>    scaled_data_madrid_x.append(scaled_data_madrid[(i<span class="op">-</span>historic_values):i, :])</span>
<span id="cb347-9"><a href="#cb347-9" aria-hidden="true" tabindex="-1"></a>    scaled_data_madrid_y.append(scaled_data_madrid[i, <span class="dv">0</span>])</span>
<span id="cb347-10"><a href="#cb347-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-11"><a href="#cb347-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the x_train and y_train to numpy arrays</span></span>
<span id="cb347-12"><a href="#cb347-12" aria-hidden="true" tabindex="-1"></a>scaled_data_madrid_x <span class="op">=</span> np.array(scaled_data_madrid_x)</span>
<span id="cb347-13"><a href="#cb347-13" aria-hidden="true" tabindex="-1"></a>scaled_data_madrid_y <span class="op">=</span> np.array(scaled_data_madrid_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="148">
<div class="sourceCode cell-code" id="cb348"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb348-1"><a href="#cb348-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Once predicted, we are going to need a exclusive scaler for num_cases</span></span>
<span id="cb348-2"><a href="#cb348-2" aria-hidden="true" tabindex="-1"></a>scaler_pred <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb348-3"><a href="#cb348-3" aria-hidden="true" tabindex="-1"></a>df_cases_madrid <span class="op">=</span> pd.DataFrame(data_madrid[<span class="st">'num_casos'</span>])</span>
<span id="cb348-4"><a href="#cb348-4" aria-hidden="true" tabindex="-1"></a>scaled_data_madrid_pred <span class="op">=</span> scaler_pred.fit_transform(df_cases_madrid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="149">
<div class="sourceCode cell-code" id="cb349"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb349-1"><a href="#cb349-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since the first 90th values does not have historic, the dataset has been reduced in 90 values</span></span>
<span id="cb349-2"><a href="#cb349-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud datos de entrenamiento con historico: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_madrid_y)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud datos de entrenamiento con historico: 476</code></pre>
</div>
</div>
<div class="cell" data-execution_count="150">
<div class="sourceCode cell-code" id="cb351"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb351-1"><a href="#cb351-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we split data in train and test</span></span>
<span id="cb351-2"><a href="#cb351-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as in previous analysis, we are going to predict a maximum of 90 days</span></span>
<span id="cb351-3"><a href="#cb351-3" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> scaled_data_madrid_x[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_madrid_x)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb351-4"><a href="#cb351-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> scaled_data_madrid_y[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_madrid_y)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb351-5"><a href="#cb351-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de entrenamiento: x=</span><span class="sc">{</span><span class="bu">len</span>(x_train)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb351-6"><a href="#cb351-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb351-7"><a href="#cb351-7" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> scaled_data_madrid_x[<span class="bu">len</span>(scaled_data_madrid_x)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_madrid_x)]</span>
<span id="cb351-8"><a href="#cb351-8" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaled_data_madrid_y[<span class="bu">len</span>(scaled_data_madrid_y)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_madrid_y)]</span>
<span id="cb351-9"><a href="#cb351-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de test: x=</span><span class="sc">{</span><span class="bu">len</span>(x_test)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_test)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cantidad datos de entrenamiento: x=385 - y=385
Cantidad datos de test: x=90 - y=90</code></pre>
</div>
</div>
<div class="cell" data-execution_count="151">
<div class="sourceCode cell-code" id="cb353"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb353-1"><a href="#cb353-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data to feed de recurrent network</span></span>
<span id="cb353-2"><a href="#cb353-2" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> np.reshape(x_train, (x_train.shape[<span class="dv">0</span>], x_train.shape[<span class="dv">1</span>], <span class="dv">8</span>))</span>
<span id="cb353-3"><a href="#cb353-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train data shape:"</span>)</span>
<span id="cb353-4"><a href="#cb353-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_train.shape)</span>
<span id="cb353-5"><a href="#cb353-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_train.shape)</span>
<span id="cb353-6"><a href="#cb353-6" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> np.reshape(x_test, (x_test.shape[<span class="dv">0</span>], x_test.shape[<span class="dv">1</span>], <span class="dv">8</span>))</span>
<span id="cb353-7"><a href="#cb353-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test data shape:"</span>)</span>
<span id="cb353-8"><a href="#cb353-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_test.shape)</span>
<span id="cb353-9"><a href="#cb353-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train data shape:
(385, 90, 8)
(385,)
Test data shape:
(90, 90, 8)
(90,)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="152">
<div class="sourceCode cell-code" id="cb355"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb355-1"><a href="#cb355-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure / setup the neural network model - LSTM</span></span>
<span id="cb355-2"><a href="#cb355-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the model</span></span>
<span id="cb355-3"><a href="#cb355-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Build model...'</span>)</span>
<span id="cb355-4"><a href="#cb355-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb355-5"><a href="#cb355-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with Neurons </span></span>
<span id="cb355-6"><a href="#cb355-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputshape = neurons -&gt; Timestamps</span></span>
<span id="cb355-7"><a href="#cb355-7" aria-hidden="true" tabindex="-1"></a>neurons<span class="op">=</span> x_train.shape[<span class="dv">1</span>]</span>
<span id="cb355-8"><a href="#cb355-8" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">90</span>, </span>
<span id="cb355-9"><a href="#cb355-9" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb355-10"><a href="#cb355-10" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>, </span>
<span id="cb355-11"><a href="#cb355-11" aria-hidden="true" tabindex="-1"></a>               input_shape <span class="op">=</span> (x_train.shape[<span class="dv">1</span>], <span class="dv">8</span>))) </span>
<span id="cb355-12"><a href="#cb355-12" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">50</span>, </span>
<span id="cb355-13"><a href="#cb355-13" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb355-14"><a href="#cb355-14" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>)) </span>
<span id="cb355-15"><a href="#cb355-15" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">25</span>, </span>
<span id="cb355-16"><a href="#cb355-16" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb355-17"><a href="#cb355-17" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">False</span>)) </span>
<span id="cb355-18"><a href="#cb355-18" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">5</span>, activation <span class="op">=</span> <span class="st">'relu'</span>))</span>
<span id="cb355-19"><a href="#cb355-19" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Build model...</code></pre>
</div>
</div>
<div class="cell" data-execution_count="153">
<div class="sourceCode cell-code" id="cb357"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb357-1"><a href="#cb357-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mean_squared_error'</span>)</span>
<span id="cb357-2"><a href="#cb357-2" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "sequential_7"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Layer (type)                Output Shape              Param #   </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_21 (LSTM)              (None, 90, 90)            35640     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_22 (LSTM)              (None, 90, 50)            28200     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_23 (LSTM)              (None, 25)                7600      </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_14 (Dense)            (None, 5)                 130       </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_15 (Dense)            (None, 1)                 6         </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Total params: 71,576</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Trainable params: 71,576</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Non-trainable params: 0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
</div>
<div class="cell" data-execution_count="154">
<div class="sourceCode cell-code" id="cb377"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb377-1"><a href="#cb377-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model</span></span>
<span id="cb377-2"><a href="#cb377-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fit network</span></span>
<span id="cb377-3"><a href="#cb377-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(x_train, </span>
<span id="cb377-4"><a href="#cb377-4" aria-hidden="true" tabindex="-1"></a>                    y_train, </span>
<span id="cb377-5"><a href="#cb377-5" aria-hidden="true" tabindex="-1"></a>                    batch_size<span class="op">=</span><span class="dv">1000</span>, </span>
<span id="cb377-6"><a href="#cb377-6" aria-hidden="true" tabindex="-1"></a>                    epochs<span class="op">=</span><span class="dv">50</span>, </span>
<span id="cb377-7"><a href="#cb377-7" aria-hidden="true" tabindex="-1"></a>                    validation_data <span class="op">=</span> (x_test, y_test), </span>
<span id="cb377-8"><a href="#cb377-8" aria-hidden="true" tabindex="-1"></a>                    verbose <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="155">
<div class="sourceCode cell-code" id="cb378"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb378-1"><a href="#cb378-1" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'loss'</span>], label<span class="op">=</span><span class="st">'train'</span>)</span>
<span id="cb378-2"><a href="#cb378-2" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'val_loss'</span>], label<span class="op">=</span><span class="st">'test'</span>)</span>
<span id="cb378-3"><a href="#cb378-3" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb378-4"><a href="#cb378-4" aria-hidden="true" tabindex="-1"></a>plt.show() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_multi_files/figure-html/cell-156-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="156">
<div class="sourceCode cell-code" id="cb379"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb379-1"><a href="#cb379-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predicted values</span></span>
<span id="cb379-2"><a href="#cb379-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.predict(x_test)</span>
<span id="cb379-3"><a href="#cb379-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> scaler_pred.inverse_transform(predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1/3 [=========&gt;....................] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - 0s 31ms/step</code></pre>
</div>
</div>
<div class="cell" data-execution_count="157">
<div class="sourceCode cell-code" id="cb383"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb383-1"><a href="#cb383-1" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y_test.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb383-2"><a href="#cb383-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaler_pred.inverse_transform(y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="158">
<div class="sourceCode cell-code" id="cb384"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb384-1"><a href="#cb384-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean absolute error (MAE)</span></span>
<span id="cb384-2"><a href="#cb384-2" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, predictions)</span>
<span id="cb384-3"><a href="#cb384-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MAE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(mae, <span class="dv">1</span>)))</span>
<span id="cb384-4"><a href="#cb384-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb384-5"><a href="#cb384-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb384-6"><a href="#cb384-6" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test,predictions))</span>
<span id="cb384-7"><a href="#cb384-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span>
<span id="cb384-8"><a href="#cb384-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb384-9"><a href="#cb384-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb384-10"><a href="#cb384-10" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> mean_squared_error(y_test, </span>
<span id="cb384-11"><a href="#cb384-11" aria-hidden="true" tabindex="-1"></a>                          predictions,</span>
<span id="cb384-12"><a href="#cb384-12" aria-hidden="true" tabindex="-1"></a>                          squared <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb384-13"><a href="#cb384-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE: 2755.3
RMSE: 5897.2
RMSE: 5897.2</code></pre>
</div>
</div>
<div class="cell" data-execution_count="159">
<div class="sourceCode cell-code" id="cb386"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb386-1"><a href="#cb386-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the difference between the valid and predicted prices</span></span>
<span id="cb386-2"><a href="#cb386-2" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> data_madrid[:(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">92</span>)]</span>
<span id="cb386-3"><a href="#cb386-3" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> data_madrid[(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">91</span>):]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="160">
<div class="sourceCode cell-code" id="cb387"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb387-1"><a href="#cb387-1" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Predictions"</span>, predictions, <span class="va">True</span>)</span>
<span id="cb387-2"><a href="#cb387-2" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Difference"</span>, valid[<span class="st">"Predictions"</span>] <span class="op">-</span> valid[<span class="st">"num_casos"</span>], <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="161">
<div class="sourceCode cell-code" id="cb388"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb388-1"><a href="#cb388-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Zoom-in to a closer timeframe</span></span>
<span id="cb388-2"><a href="#cb388-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Date from which on the date is displayed</span></span>
<span id="cb388-3"><a href="#cb388-3" aria-hidden="true" tabindex="-1"></a>display_start_date <span class="op">=</span> <span class="st">"2021-07-15"</span> </span>
<span id="cb388-4"><a href="#cb388-4" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> valid[valid.index <span class="op">&gt;</span> display_start_date]</span>
<span id="cb388-5"><a href="#cb388-5" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> train[train.index <span class="op">&gt;</span> display_start_date]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="162">
<div class="sourceCode cell-code" id="cb389"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb389-1"><a href="#cb389-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the data</span></span>
<span id="cb389-2"><a href="#cb389-2" aria-hidden="true" tabindex="-1"></a>matplotlib.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb389-3"><a href="#cb389-3" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">22</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb389-4"><a href="#cb389-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb389-5"><a href="#cb389-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Train</span></span>
<span id="cb389-6"><a href="#cb389-6" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> train.index<span class="op">;</span> </span>
<span id="cb389-7"><a href="#cb389-7" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> train[[<span class="st">"num_casos"</span>]]</span>
<span id="cb389-8"><a href="#cb389-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Test / validation </span></span>
<span id="cb389-9"><a href="#cb389-9" aria-hidden="true" tabindex="-1"></a>xv <span class="op">=</span> valid.index<span class="op">;</span> </span>
<span id="cb389-10"><a href="#cb389-10" aria-hidden="true" tabindex="-1"></a>yv <span class="op">=</span> valid[[<span class="st">"num_casos"</span>, <span class="st">"Predictions"</span>]]</span>
<span id="cb389-11"><a href="#cb389-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb389-12"><a href="#cb389-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb389-13"><a href="#cb389-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"madrid: Predictions vs Real infections"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb389-14"><a href="#cb389-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Nº Cases"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb389-15"><a href="#cb389-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb389-16"><a href="#cb389-16" aria-hidden="true" tabindex="-1"></a>plt.plot(yt, color<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb389-17"><a href="#cb389-17" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"Predictions"</span>], color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb389-18"><a href="#cb389-18" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"num_casos"</span>], color<span class="op">=</span><span class="st">"green"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb389-19"><a href="#cb389-19" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"LSTM Predictions"</span>, <span class="st">"Test"</span>], </span>
<span id="cb389-20"><a href="#cb389-20" aria-hidden="true" tabindex="-1"></a>           loc<span class="op">=</span><span class="st">"upper left"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb389-21"><a href="#cb389-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb389-22"><a href="#cb389-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot with the differences</span></span>
<span id="cb389-23"><a href="#cb389-23" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> valid.index</span>
<span id="cb389-24"><a href="#cb389-24" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> valid[<span class="st">"Difference"</span>]</span>
<span id="cb389-25"><a href="#cb389-25" aria-hidden="true" tabindex="-1"></a>plt.bar(x, y, width<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">"grey"</span>)</span>
<span id="cb389-26"><a href="#cb389-26" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb389-27"><a href="#cb389-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_multi_files/figure-html/cell-163-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="málaga-1" class="level2">
<h2 class="anchored" data-anchor-id="málaga-1">Málaga</h2>
<div class="cell" data-execution_count="163">
<div class="sourceCode cell-code" id="cb390"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb390-1"><a href="#cb390-1" aria-hidden="true" tabindex="-1"></a>data_malaga <span class="op">=</span> data_covid.loc[data_covid[<span class="st">'provincia'</span>] <span class="op">==</span> <span class="st">'Málaga'</span>]</span>
<span id="cb390-2"><a href="#cb390-2" aria-hidden="true" tabindex="-1"></a>data_malaga <span class="op">=</span> data_malaga.set_index(<span class="st">'fecha'</span>)</span>
<span id="cb390-3"><a href="#cb390-3" aria-hidden="true" tabindex="-1"></a>data_malaga <span class="op">=</span> data_malaga[<span class="st">'2020-06-14'</span>:<span class="st">'2021-12-31'</span>]</span>
<span id="cb390-4"><a href="#cb390-4" aria-hidden="true" tabindex="-1"></a>data_malaga <span class="op">=</span> data_malaga.<span class="bu">filter</span>([<span class="st">'num_casos'</span>, <span class="st">'tmed'</span>, <span class="st">'mob_grocery_pharmacy'</span>, </span>
<span id="cb390-5"><a href="#cb390-5" aria-hidden="true" tabindex="-1"></a><span class="st">'mob_parks'</span>, <span class="st">'mob_residential'</span>, <span class="st">'mob_residential'</span>, <span class="st">'mob_transit_stations'</span>, <span class="st">'mob_workplaces'</span>])</span>
<span id="cb390-6"><a href="#cb390-6" aria-hidden="true" tabindex="-1"></a>data_malaga</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="163">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
      <th>tmed</th>
      <th>mob_grocery_pharmacy</th>
      <th>mob_parks</th>
      <th>mob_residential</th>
      <th>mob_residential</th>
      <th>mob_transit_stations</th>
      <th>mob_workplaces</th>
    </tr>
    <tr>
      <th>fecha</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-14</th>
      <td>2</td>
      <td>26.6</td>
      <td>-20.0</td>
      <td>-15.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>-53.0</td>
      <td>-7.0</td>
    </tr>
    <tr>
      <th>2020-06-15</th>
      <td>1</td>
      <td>27.2</td>
      <td>-16.0</td>
      <td>-9.0</td>
      <td>9.0</td>
      <td>9.0</td>
      <td>-44.0</td>
      <td>-33.0</td>
    </tr>
    <tr>
      <th>2020-06-16</th>
      <td>1</td>
      <td>27.8</td>
      <td>-13.0</td>
      <td>-4.0</td>
      <td>9.0</td>
      <td>9.0</td>
      <td>-40.0</td>
      <td>-33.0</td>
    </tr>
    <tr>
      <th>2020-06-17</th>
      <td>2</td>
      <td>26.9</td>
      <td>-13.0</td>
      <td>1.0</td>
      <td>9.0</td>
      <td>9.0</td>
      <td>-41.0</td>
      <td>-33.0</td>
    </tr>
    <tr>
      <th>2020-06-18</th>
      <td>2</td>
      <td>21.6</td>
      <td>-12.0</td>
      <td>3.0</td>
      <td>9.0</td>
      <td>9.0</td>
      <td>-42.0</td>
      <td>-33.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2021-12-27</th>
      <td>1627</td>
      <td>17.9</td>
      <td>15.0</td>
      <td>17.0</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>-12.0</td>
      <td>-37.0</td>
    </tr>
    <tr>
      <th>2021-12-28</th>
      <td>2772</td>
      <td>17.8</td>
      <td>18.0</td>
      <td>30.0</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>-7.0</td>
      <td>-37.0</td>
    </tr>
    <tr>
      <th>2021-12-29</th>
      <td>3080</td>
      <td>17.0</td>
      <td>25.0</td>
      <td>37.0</td>
      <td>6.0</td>
      <td>6.0</td>
      <td>-8.0</td>
      <td>-37.0</td>
    </tr>
    <tr>
      <th>2021-12-30</th>
      <td>3075</td>
      <td>14.4</td>
      <td>39.0</td>
      <td>33.0</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>-8.0</td>
      <td>-37.0</td>
    </tr>
    <tr>
      <th>2021-12-31</th>
      <td>2646</td>
      <td>11.1</td>
      <td>22.0</td>
      <td>-5.0</td>
      <td>12.0</td>
      <td>12.0</td>
      <td>-34.0</td>
      <td>-50.0</td>
    </tr>
  </tbody>
</table>
<p>566 rows × 8 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="164">
<div class="sourceCode cell-code" id="cb391"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb391-1"><a href="#cb391-1" aria-hidden="true" tabindex="-1"></a>data_malaga.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="164">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
      <th>tmed</th>
      <th>mob_grocery_pharmacy</th>
      <th>mob_parks</th>
      <th>mob_residential</th>
      <th>mob_residential</th>
      <th>mob_transit_stations</th>
      <th>mob_workplaces</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>339.227915</td>
      <td>20.332332</td>
      <td>8.427562</td>
      <td>15.765018</td>
      <td>4.588339</td>
      <td>4.588339</td>
      <td>-19.860424</td>
      <td>-18.724382</td>
    </tr>
    <tr>
      <th>std</th>
      <td>427.261346</td>
      <td>5.690349</td>
      <td>27.032414</td>
      <td>41.263233</td>
      <td>4.227823</td>
      <td>4.227823</td>
      <td>19.025924</td>
      <td>14.733563</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1.000000</td>
      <td>6.200000</td>
      <td>-80.000000</td>
      <td>-63.000000</td>
      <td>-4.000000</td>
      <td>-4.000000</td>
      <td>-70.000000</td>
      <td>-79.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>110.000000</td>
      <td>15.600000</td>
      <td>-5.000000</td>
      <td>-14.000000</td>
      <td>2.000000</td>
      <td>2.000000</td>
      <td>-34.000000</td>
      <td>-27.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>193.500000</td>
      <td>20.000000</td>
      <td>4.000000</td>
      <td>7.000000</td>
      <td>4.000000</td>
      <td>4.000000</td>
      <td>-23.000000</td>
      <td>-18.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>344.750000</td>
      <td>25.075000</td>
      <td>16.000000</td>
      <td>36.000000</td>
      <td>7.000000</td>
      <td>7.000000</td>
      <td>-4.000000</td>
      <td>-12.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>3080.000000</td>
      <td>34.500000</td>
      <td>156.000000</td>
      <td>152.000000</td>
      <td>22.000000</td>
      <td>22.000000</td>
      <td>20.000000</td>
      <td>29.000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="165">
<div class="sourceCode cell-code" id="cb392"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb392-1"><a href="#cb392-1" aria-hidden="true" tabindex="-1"></a>np_data_malaga <span class="op">=</span> data_malaga.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="166">
<div class="sourceCode cell-code" id="cb393"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb393-1"><a href="#cb393-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train dataset</span></span>
<span id="cb393-2"><a href="#cb393-2" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb393-3"><a href="#cb393-3" aria-hidden="true" tabindex="-1"></a>scaled_data_malaga <span class="op">=</span> scaler.fit_transform(np_data_malaga)</span>
<span id="cb393-4"><a href="#cb393-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud del conjunto de datos disponible: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_malaga)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud del conjunto de datos disponible: 566</code></pre>
</div>
</div>
<div class="cell" data-execution_count="167">
<div class="sourceCode cell-code" id="cb395"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb395-1"><a href="#cb395-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we are going to predict future values based on the 90 past elements, </span></span>
<span id="cb395-2"><a href="#cb395-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to create a list with those historic information for each element</span></span>
<span id="cb395-3"><a href="#cb395-3" aria-hidden="true" tabindex="-1"></a>historic_values <span class="op">=</span> <span class="dv">90</span></span>
<span id="cb395-4"><a href="#cb395-4" aria-hidden="true" tabindex="-1"></a>scaled_data_malaga_x <span class="op">=</span> []</span>
<span id="cb395-5"><a href="#cb395-5" aria-hidden="true" tabindex="-1"></a>scaled_data_malaga_y <span class="op">=</span> []</span>
<span id="cb395-6"><a href="#cb395-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-7"><a href="#cb395-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(historic_values, <span class="bu">len</span>(scaled_data_malaga)):</span>
<span id="cb395-8"><a href="#cb395-8" aria-hidden="true" tabindex="-1"></a>    scaled_data_malaga_x.append(scaled_data_malaga[(i<span class="op">-</span>historic_values):i, :])</span>
<span id="cb395-9"><a href="#cb395-9" aria-hidden="true" tabindex="-1"></a>    scaled_data_malaga_y.append(scaled_data_malaga[i, <span class="dv">0</span>])</span>
<span id="cb395-10"><a href="#cb395-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-11"><a href="#cb395-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the x_train and y_train to numpy arrays</span></span>
<span id="cb395-12"><a href="#cb395-12" aria-hidden="true" tabindex="-1"></a>scaled_data_malaga_x <span class="op">=</span> np.array(scaled_data_malaga_x)</span>
<span id="cb395-13"><a href="#cb395-13" aria-hidden="true" tabindex="-1"></a>scaled_data_malaga_y <span class="op">=</span> np.array(scaled_data_malaga_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="168">
<div class="sourceCode cell-code" id="cb396"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb396-1"><a href="#cb396-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Once predicted, we are going to need a exclusive scaler for num_cases</span></span>
<span id="cb396-2"><a href="#cb396-2" aria-hidden="true" tabindex="-1"></a>scaler_pred <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb396-3"><a href="#cb396-3" aria-hidden="true" tabindex="-1"></a>df_cases_malaga <span class="op">=</span> pd.DataFrame(data_malaga[<span class="st">'num_casos'</span>])</span>
<span id="cb396-4"><a href="#cb396-4" aria-hidden="true" tabindex="-1"></a>scaled_data_malaga_pred <span class="op">=</span> scaler_pred.fit_transform(df_cases_malaga)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="169">
<div class="sourceCode cell-code" id="cb397"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb397-1"><a href="#cb397-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since the first 90th values does not have historic, the dataset has been reduced in 90 values</span></span>
<span id="cb397-2"><a href="#cb397-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud datos de entrenamiento con historico: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_malaga_y)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud datos de entrenamiento con historico: 476</code></pre>
</div>
</div>
<div class="cell" data-execution_count="170">
<div class="sourceCode cell-code" id="cb399"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb399-1"><a href="#cb399-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we split data in train and test</span></span>
<span id="cb399-2"><a href="#cb399-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as in previous analysis, we are going to predict a maximum of 90 days</span></span>
<span id="cb399-3"><a href="#cb399-3" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> scaled_data_malaga_x[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_malaga_x)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb399-4"><a href="#cb399-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> scaled_data_malaga_y[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_malaga_y)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb399-5"><a href="#cb399-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de entrenamiento: x=</span><span class="sc">{</span><span class="bu">len</span>(x_train)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb399-6"><a href="#cb399-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb399-7"><a href="#cb399-7" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> scaled_data_malaga_x[<span class="bu">len</span>(scaled_data_malaga_x)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_malaga_x)]</span>
<span id="cb399-8"><a href="#cb399-8" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaled_data_malaga_y[<span class="bu">len</span>(scaled_data_malaga_y)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_malaga_y)]</span>
<span id="cb399-9"><a href="#cb399-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de test: x=</span><span class="sc">{</span><span class="bu">len</span>(x_test)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_test)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cantidad datos de entrenamiento: x=385 - y=385
Cantidad datos de test: x=90 - y=90</code></pre>
</div>
</div>
<div class="cell" data-execution_count="171">
<div class="sourceCode cell-code" id="cb401"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb401-1"><a href="#cb401-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data to feed de recurrent network</span></span>
<span id="cb401-2"><a href="#cb401-2" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> np.reshape(x_train, (x_train.shape[<span class="dv">0</span>], x_train.shape[<span class="dv">1</span>], <span class="dv">8</span>))</span>
<span id="cb401-3"><a href="#cb401-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train data shape:"</span>)</span>
<span id="cb401-4"><a href="#cb401-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_train.shape)</span>
<span id="cb401-5"><a href="#cb401-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_train.shape)</span>
<span id="cb401-6"><a href="#cb401-6" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> np.reshape(x_test, (x_test.shape[<span class="dv">0</span>], x_test.shape[<span class="dv">1</span>], <span class="dv">8</span>))</span>
<span id="cb401-7"><a href="#cb401-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test data shape:"</span>)</span>
<span id="cb401-8"><a href="#cb401-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_test.shape)</span>
<span id="cb401-9"><a href="#cb401-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train data shape:
(385, 90, 8)
(385,)
Test data shape:
(90, 90, 8)
(90,)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="172">
<div class="sourceCode cell-code" id="cb403"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb403-1"><a href="#cb403-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure / setup the neural network model - LSTM</span></span>
<span id="cb403-2"><a href="#cb403-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the model</span></span>
<span id="cb403-3"><a href="#cb403-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Build model...'</span>)</span>
<span id="cb403-4"><a href="#cb403-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb403-5"><a href="#cb403-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with Neurons </span></span>
<span id="cb403-6"><a href="#cb403-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputshape = neurons -&gt; Timestamps</span></span>
<span id="cb403-7"><a href="#cb403-7" aria-hidden="true" tabindex="-1"></a>neurons<span class="op">=</span> x_train.shape[<span class="dv">1</span>]</span>
<span id="cb403-8"><a href="#cb403-8" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">90</span>, </span>
<span id="cb403-9"><a href="#cb403-9" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb403-10"><a href="#cb403-10" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>, </span>
<span id="cb403-11"><a href="#cb403-11" aria-hidden="true" tabindex="-1"></a>               input_shape <span class="op">=</span> (x_train.shape[<span class="dv">1</span>], <span class="dv">8</span>))) </span>
<span id="cb403-12"><a href="#cb403-12" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">50</span>, </span>
<span id="cb403-13"><a href="#cb403-13" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb403-14"><a href="#cb403-14" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>)) </span>
<span id="cb403-15"><a href="#cb403-15" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">25</span>, </span>
<span id="cb403-16"><a href="#cb403-16" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb403-17"><a href="#cb403-17" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">False</span>)) </span>
<span id="cb403-18"><a href="#cb403-18" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">5</span>, activation <span class="op">=</span> <span class="st">'relu'</span>))</span>
<span id="cb403-19"><a href="#cb403-19" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Build model...</code></pre>
</div>
</div>
<div class="cell" data-execution_count="173">
<div class="sourceCode cell-code" id="cb405"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb405-1"><a href="#cb405-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mean_squared_error'</span>)</span>
<span id="cb405-2"><a href="#cb405-2" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "sequential_8"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Layer (type)                Output Shape              Param #   </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_24 (LSTM)              (None, 90, 90)            35640     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_25 (LSTM)              (None, 90, 50)            28200     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_26 (LSTM)              (None, 25)                7600      </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_16 (Dense)            (None, 5)                 130       </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_17 (Dense)            (None, 1)                 6         </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Total params: 71,576</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Trainable params: 71,576</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Non-trainable params: 0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
</div>
<div class="cell" data-execution_count="174">
<div class="sourceCode cell-code" id="cb425"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb425-1"><a href="#cb425-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model</span></span>
<span id="cb425-2"><a href="#cb425-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fit network</span></span>
<span id="cb425-3"><a href="#cb425-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(x_train, </span>
<span id="cb425-4"><a href="#cb425-4" aria-hidden="true" tabindex="-1"></a>                    y_train, </span>
<span id="cb425-5"><a href="#cb425-5" aria-hidden="true" tabindex="-1"></a>                    batch_size<span class="op">=</span><span class="dv">1000</span>, </span>
<span id="cb425-6"><a href="#cb425-6" aria-hidden="true" tabindex="-1"></a>                    epochs<span class="op">=</span><span class="dv">50</span>, </span>
<span id="cb425-7"><a href="#cb425-7" aria-hidden="true" tabindex="-1"></a>                    validation_data <span class="op">=</span> (x_test, y_test), </span>
<span id="cb425-8"><a href="#cb425-8" aria-hidden="true" tabindex="-1"></a>                    verbose <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="175">
<div class="sourceCode cell-code" id="cb426"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb426-1"><a href="#cb426-1" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'loss'</span>], label<span class="op">=</span><span class="st">'train'</span>)</span>
<span id="cb426-2"><a href="#cb426-2" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'val_loss'</span>], label<span class="op">=</span><span class="st">'test'</span>)</span>
<span id="cb426-3"><a href="#cb426-3" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb426-4"><a href="#cb426-4" aria-hidden="true" tabindex="-1"></a>plt.show() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_multi_files/figure-html/cell-176-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="176">
<div class="sourceCode cell-code" id="cb427"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb427-1"><a href="#cb427-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predicted values</span></span>
<span id="cb427-2"><a href="#cb427-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.predict(x_test)</span>
<span id="cb427-3"><a href="#cb427-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> scaler_pred.inverse_transform(predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1/3 [=========&gt;....................] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - 0s 31ms/step</code></pre>
</div>
</div>
<div class="cell" data-execution_count="177">
<div class="sourceCode cell-code" id="cb431"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb431-1"><a href="#cb431-1" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y_test.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb431-2"><a href="#cb431-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaler_pred.inverse_transform(y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="178">
<div class="sourceCode cell-code" id="cb432"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb432-1"><a href="#cb432-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean absolute error (MAE)</span></span>
<span id="cb432-2"><a href="#cb432-2" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, predictions)</span>
<span id="cb432-3"><a href="#cb432-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MAE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(mae, <span class="dv">1</span>)))</span>
<span id="cb432-4"><a href="#cb432-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb432-5"><a href="#cb432-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb432-6"><a href="#cb432-6" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test,predictions))</span>
<span id="cb432-7"><a href="#cb432-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span>
<span id="cb432-8"><a href="#cb432-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb432-9"><a href="#cb432-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb432-10"><a href="#cb432-10" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> mean_squared_error(y_test, </span>
<span id="cb432-11"><a href="#cb432-11" aria-hidden="true" tabindex="-1"></a>                          predictions,</span>
<span id="cb432-12"><a href="#cb432-12" aria-hidden="true" tabindex="-1"></a>                          squared <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb432-13"><a href="#cb432-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE: 301.5
RMSE: 408.5
RMSE: 408.5</code></pre>
</div>
</div>
<div class="cell" data-execution_count="179">
<div class="sourceCode cell-code" id="cb434"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb434-1"><a href="#cb434-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the difference between the valid and predicted prices</span></span>
<span id="cb434-2"><a href="#cb434-2" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> data_malaga[:(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">92</span>)]</span>
<span id="cb434-3"><a href="#cb434-3" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> data_malaga[(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">91</span>):]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="180">
<div class="sourceCode cell-code" id="cb435"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb435-1"><a href="#cb435-1" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Predictions"</span>, predictions, <span class="va">True</span>)</span>
<span id="cb435-2"><a href="#cb435-2" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Difference"</span>, valid[<span class="st">"Predictions"</span>] <span class="op">-</span> valid[<span class="st">"num_casos"</span>], <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="181">
<div class="sourceCode cell-code" id="cb436"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb436-1"><a href="#cb436-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Zoom-in to a closer timeframe</span></span>
<span id="cb436-2"><a href="#cb436-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Date from which on the date is displayed</span></span>
<span id="cb436-3"><a href="#cb436-3" aria-hidden="true" tabindex="-1"></a>display_start_date <span class="op">=</span> <span class="st">"2021-07-15"</span> </span>
<span id="cb436-4"><a href="#cb436-4" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> valid[valid.index <span class="op">&gt;</span> display_start_date]</span>
<span id="cb436-5"><a href="#cb436-5" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> train[train.index <span class="op">&gt;</span> display_start_date]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="182">
<div class="sourceCode cell-code" id="cb437"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb437-1"><a href="#cb437-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the data</span></span>
<span id="cb437-2"><a href="#cb437-2" aria-hidden="true" tabindex="-1"></a>matplotlib.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb437-3"><a href="#cb437-3" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">22</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb437-4"><a href="#cb437-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb437-5"><a href="#cb437-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Train</span></span>
<span id="cb437-6"><a href="#cb437-6" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> train.index<span class="op">;</span> </span>
<span id="cb437-7"><a href="#cb437-7" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> train[[<span class="st">"num_casos"</span>]]</span>
<span id="cb437-8"><a href="#cb437-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Test / validation </span></span>
<span id="cb437-9"><a href="#cb437-9" aria-hidden="true" tabindex="-1"></a>xv <span class="op">=</span> valid.index<span class="op">;</span> </span>
<span id="cb437-10"><a href="#cb437-10" aria-hidden="true" tabindex="-1"></a>yv <span class="op">=</span> valid[[<span class="st">"num_casos"</span>, <span class="st">"Predictions"</span>]]</span>
<span id="cb437-11"><a href="#cb437-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb437-12"><a href="#cb437-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb437-13"><a href="#cb437-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"malaga: Predictions vs Real infections"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb437-14"><a href="#cb437-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Nº Cases"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb437-15"><a href="#cb437-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb437-16"><a href="#cb437-16" aria-hidden="true" tabindex="-1"></a>plt.plot(yt, color<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb437-17"><a href="#cb437-17" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"Predictions"</span>], color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb437-18"><a href="#cb437-18" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"num_casos"</span>], color<span class="op">=</span><span class="st">"green"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb437-19"><a href="#cb437-19" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"LSTM Predictions"</span>, <span class="st">"Test"</span>], </span>
<span id="cb437-20"><a href="#cb437-20" aria-hidden="true" tabindex="-1"></a>           loc<span class="op">=</span><span class="st">"upper left"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb437-21"><a href="#cb437-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb437-22"><a href="#cb437-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot with the differences</span></span>
<span id="cb437-23"><a href="#cb437-23" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> valid.index</span>
<span id="cb437-24"><a href="#cb437-24" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> valid[<span class="st">"Difference"</span>]</span>
<span id="cb437-25"><a href="#cb437-25" aria-hidden="true" tabindex="-1"></a>plt.bar(x, y, width<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">"grey"</span>)</span>
<span id="cb437-26"><a href="#cb437-26" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb437-27"><a href="#cb437-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_multi_files/figure-html/cell-183-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="sevilla-1" class="level2">
<h2 class="anchored" data-anchor-id="sevilla-1">Sevilla</h2>
<div class="cell" data-execution_count="183">
<div class="sourceCode cell-code" id="cb438"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb438-1"><a href="#cb438-1" aria-hidden="true" tabindex="-1"></a>data_sevilla <span class="op">=</span> data_covid.loc[data_covid[<span class="st">'provincia'</span>] <span class="op">==</span> <span class="st">'Sevilla'</span>]</span>
<span id="cb438-2"><a href="#cb438-2" aria-hidden="true" tabindex="-1"></a>data_sevilla <span class="op">=</span> data_sevilla.set_index(<span class="st">'fecha'</span>)</span>
<span id="cb438-3"><a href="#cb438-3" aria-hidden="true" tabindex="-1"></a>data_sevilla <span class="op">=</span> data_sevilla[<span class="st">'2020-06-14'</span>:<span class="st">'2021-12-31'</span>]</span>
<span id="cb438-4"><a href="#cb438-4" aria-hidden="true" tabindex="-1"></a>data_sevilla <span class="op">=</span> data_sevilla.<span class="bu">filter</span>([<span class="st">'num_casos'</span>, <span class="st">'tmed'</span>, <span class="st">'mob_grocery_pharmacy'</span>, </span>
<span id="cb438-5"><a href="#cb438-5" aria-hidden="true" tabindex="-1"></a><span class="st">'mob_parks'</span>, <span class="st">'mob_residential'</span>, <span class="st">'mob_residential'</span>, <span class="st">'mob_transit_stations'</span>, <span class="st">'mob_workplaces'</span>])</span>
<span id="cb438-6"><a href="#cb438-6" aria-hidden="true" tabindex="-1"></a>data_sevilla</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="183">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
      <th>tmed</th>
      <th>mob_grocery_pharmacy</th>
      <th>mob_parks</th>
      <th>mob_residential</th>
      <th>mob_residential</th>
      <th>mob_transit_stations</th>
      <th>mob_workplaces</th>
    </tr>
    <tr>
      <th>fecha</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-14</th>
      <td>0</td>
      <td>22.200000</td>
      <td>-24.0</td>
      <td>-36.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-51.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2020-06-15</th>
      <td>2</td>
      <td>23.088889</td>
      <td>-14.0</td>
      <td>-13.0</td>
      <td>9.0</td>
      <td>9.0</td>
      <td>-41.0</td>
      <td>-33.0</td>
    </tr>
    <tr>
      <th>2020-06-16</th>
      <td>1</td>
      <td>23.977778</td>
      <td>-10.0</td>
      <td>-4.0</td>
      <td>9.0</td>
      <td>9.0</td>
      <td>-37.0</td>
      <td>-32.0</td>
    </tr>
    <tr>
      <th>2020-06-17</th>
      <td>0</td>
      <td>24.866667</td>
      <td>-10.0</td>
      <td>-7.0</td>
      <td>9.0</td>
      <td>9.0</td>
      <td>-37.0</td>
      <td>-32.0</td>
    </tr>
    <tr>
      <th>2020-06-18</th>
      <td>0</td>
      <td>25.755556</td>
      <td>-12.0</td>
      <td>-13.0</td>
      <td>9.0</td>
      <td>9.0</td>
      <td>-41.0</td>
      <td>-33.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2021-12-27</th>
      <td>2617</td>
      <td>17.600000</td>
      <td>16.0</td>
      <td>-1.0</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>-19.0</td>
      <td>-39.0</td>
    </tr>
    <tr>
      <th>2021-12-28</th>
      <td>3190</td>
      <td>16.000000</td>
      <td>17.0</td>
      <td>15.0</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>-16.0</td>
      <td>-37.0</td>
    </tr>
    <tr>
      <th>2021-12-29</th>
      <td>3692</td>
      <td>14.100000</td>
      <td>24.0</td>
      <td>18.0</td>
      <td>6.0</td>
      <td>6.0</td>
      <td>-18.0</td>
      <td>-38.0</td>
    </tr>
    <tr>
      <th>2021-12-30</th>
      <td>3508</td>
      <td>13.000000</td>
      <td>39.0</td>
      <td>11.0</td>
      <td>6.0</td>
      <td>6.0</td>
      <td>-21.0</td>
      <td>-39.0</td>
    </tr>
    <tr>
      <th>2021-12-31</th>
      <td>2816</td>
      <td>14.600000</td>
      <td>15.0</td>
      <td>-24.0</td>
      <td>12.0</td>
      <td>12.0</td>
      <td>-44.0</td>
      <td>-53.0</td>
    </tr>
  </tbody>
</table>
<p>566 rows × 8 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="184">
<div class="sourceCode cell-code" id="cb439"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb439-1"><a href="#cb439-1" aria-hidden="true" tabindex="-1"></a>data_sevilla.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="184">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>num_casos</th>
      <th>tmed</th>
      <th>mob_grocery_pharmacy</th>
      <th>mob_parks</th>
      <th>mob_residential</th>
      <th>mob_residential</th>
      <th>mob_transit_stations</th>
      <th>mob_workplaces</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
      <td>566.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>383.807420</td>
      <td>20.691519</td>
      <td>-1.908127</td>
      <td>-16.176678</td>
      <td>4.086572</td>
      <td>4.086572</td>
      <td>-27.310954</td>
      <td>-21.436396</td>
    </tr>
    <tr>
      <th>std</th>
      <td>454.714408</td>
      <td>6.882766</td>
      <td>18.249947</td>
      <td>18.068323</td>
      <td>4.554635</td>
      <td>4.554635</td>
      <td>14.360299</td>
      <td>14.353391</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
      <td>5.500000</td>
      <td>-79.000000</td>
      <td>-70.000000</td>
      <td>-7.000000</td>
      <td>-7.000000</td>
      <td>-71.000000</td>
      <td>-79.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>112.750000</td>
      <td>15.000000</td>
      <td>-10.000000</td>
      <td>-28.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>-37.000000</td>
      <td>-30.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>260.500000</td>
      <td>20.800000</td>
      <td>-1.000000</td>
      <td>-13.000000</td>
      <td>4.000000</td>
      <td>4.000000</td>
      <td>-28.000000</td>
      <td>-18.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>459.000000</td>
      <td>26.575000</td>
      <td>6.000000</td>
      <td>-5.000000</td>
      <td>7.000000</td>
      <td>7.000000</td>
      <td>-18.000000</td>
      <td>-11.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>3692.000000</td>
      <td>34.400000</td>
      <td>113.000000</td>
      <td>61.000000</td>
      <td>22.000000</td>
      <td>22.000000</td>
      <td>16.000000</td>
      <td>9.000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="185">
<div class="sourceCode cell-code" id="cb440"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb440-1"><a href="#cb440-1" aria-hidden="true" tabindex="-1"></a>np_data_sevilla <span class="op">=</span> data_sevilla.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="186">
<div class="sourceCode cell-code" id="cb441"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb441-1"><a href="#cb441-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train dataset</span></span>
<span id="cb441-2"><a href="#cb441-2" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb441-3"><a href="#cb441-3" aria-hidden="true" tabindex="-1"></a>scaled_data_sevilla <span class="op">=</span> scaler.fit_transform(np_data_sevilla)</span>
<span id="cb441-4"><a href="#cb441-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud del conjunto de datos disponible: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_sevilla)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud del conjunto de datos disponible: 566</code></pre>
</div>
</div>
<div class="cell" data-execution_count="187">
<div class="sourceCode cell-code" id="cb443"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb443-1"><a href="#cb443-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we are going to predict future values based on the 90 past elements, </span></span>
<span id="cb443-2"><a href="#cb443-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to create a list with those historic information for each element</span></span>
<span id="cb443-3"><a href="#cb443-3" aria-hidden="true" tabindex="-1"></a>historic_values <span class="op">=</span> <span class="dv">90</span></span>
<span id="cb443-4"><a href="#cb443-4" aria-hidden="true" tabindex="-1"></a>scaled_data_sevilla_x <span class="op">=</span> []</span>
<span id="cb443-5"><a href="#cb443-5" aria-hidden="true" tabindex="-1"></a>scaled_data_sevilla_y <span class="op">=</span> []</span>
<span id="cb443-6"><a href="#cb443-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb443-7"><a href="#cb443-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(historic_values, <span class="bu">len</span>(scaled_data_sevilla)):</span>
<span id="cb443-8"><a href="#cb443-8" aria-hidden="true" tabindex="-1"></a>    scaled_data_sevilla_x.append(scaled_data_sevilla[(i<span class="op">-</span>historic_values):i, :])</span>
<span id="cb443-9"><a href="#cb443-9" aria-hidden="true" tabindex="-1"></a>    scaled_data_sevilla_y.append(scaled_data_sevilla[i, <span class="dv">0</span>])</span>
<span id="cb443-10"><a href="#cb443-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb443-11"><a href="#cb443-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the x_train and y_train to numpy arrays</span></span>
<span id="cb443-12"><a href="#cb443-12" aria-hidden="true" tabindex="-1"></a>scaled_data_sevilla_x <span class="op">=</span> np.array(scaled_data_sevilla_x)</span>
<span id="cb443-13"><a href="#cb443-13" aria-hidden="true" tabindex="-1"></a>scaled_data_sevilla_y <span class="op">=</span> np.array(scaled_data_sevilla_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="188">
<div class="sourceCode cell-code" id="cb444"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb444-1"><a href="#cb444-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Once predicted, we are going to need a exclusive scaler for num_cases</span></span>
<span id="cb444-2"><a href="#cb444-2" aria-hidden="true" tabindex="-1"></a>scaler_pred <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb444-3"><a href="#cb444-3" aria-hidden="true" tabindex="-1"></a>df_cases_sevilla <span class="op">=</span> pd.DataFrame(data_sevilla[<span class="st">'num_casos'</span>])</span>
<span id="cb444-4"><a href="#cb444-4" aria-hidden="true" tabindex="-1"></a>scaled_data_sevilla_pred <span class="op">=</span> scaler_pred.fit_transform(df_cases_sevilla)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="189">
<div class="sourceCode cell-code" id="cb445"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb445-1"><a href="#cb445-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since the first 90th values does not have historic, the dataset has been reduced in 90 values</span></span>
<span id="cb445-2"><a href="#cb445-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Longitud datos de entrenamiento con historico: </span><span class="sc">{</span><span class="bu">len</span>(scaled_data_sevilla_y)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Longitud datos de entrenamiento con historico: 476</code></pre>
</div>
</div>
<div class="cell" data-execution_count="190">
<div class="sourceCode cell-code" id="cb447"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb447-1"><a href="#cb447-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we split data in train and test</span></span>
<span id="cb447-2"><a href="#cb447-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as in previous analysis, we are going to predict a maximum of 90 days</span></span>
<span id="cb447-3"><a href="#cb447-3" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> scaled_data_sevilla_x[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_sevilla_x)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb447-4"><a href="#cb447-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> scaled_data_sevilla_y[<span class="dv">0</span>:<span class="bu">len</span>(scaled_data_sevilla_y)<span class="op">-</span><span class="dv">91</span>]</span>
<span id="cb447-5"><a href="#cb447-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de entrenamiento: x=</span><span class="sc">{</span><span class="bu">len</span>(x_train)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb447-6"><a href="#cb447-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb447-7"><a href="#cb447-7" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> scaled_data_sevilla_x[<span class="bu">len</span>(scaled_data_sevilla_x)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_sevilla_x)]</span>
<span id="cb447-8"><a href="#cb447-8" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaled_data_sevilla_y[<span class="bu">len</span>(scaled_data_sevilla_y)<span class="op">-</span><span class="dv">90</span>:<span class="bu">len</span>(scaled_data_sevilla_y)]</span>
<span id="cb447-9"><a href="#cb447-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Cantidad datos de test: x=</span><span class="sc">{</span><span class="bu">len</span>(x_test)<span class="sc">}</span><span class="ss"> - y=</span><span class="sc">{</span><span class="bu">len</span>(y_test)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cantidad datos de entrenamiento: x=385 - y=385
Cantidad datos de test: x=90 - y=90</code></pre>
</div>
</div>
<div class="cell" data-execution_count="191">
<div class="sourceCode cell-code" id="cb449"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb449-1"><a href="#cb449-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data to feed de recurrent network</span></span>
<span id="cb449-2"><a href="#cb449-2" aria-hidden="true" tabindex="-1"></a>x_train <span class="op">=</span> np.reshape(x_train, (x_train.shape[<span class="dv">0</span>], x_train.shape[<span class="dv">1</span>], <span class="dv">8</span>))</span>
<span id="cb449-3"><a href="#cb449-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train data shape:"</span>)</span>
<span id="cb449-4"><a href="#cb449-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_train.shape)</span>
<span id="cb449-5"><a href="#cb449-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_train.shape)</span>
<span id="cb449-6"><a href="#cb449-6" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> np.reshape(x_test, (x_test.shape[<span class="dv">0</span>], x_test.shape[<span class="dv">1</span>], <span class="dv">8</span>))</span>
<span id="cb449-7"><a href="#cb449-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test data shape:"</span>)</span>
<span id="cb449-8"><a href="#cb449-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_test.shape)</span>
<span id="cb449-9"><a href="#cb449-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train data shape:
(385, 90, 8)
(385,)
Test data shape:
(90, 90, 8)
(90,)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="192">
<div class="sourceCode cell-code" id="cb451"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb451-1"><a href="#cb451-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure / setup the neural network model - LSTM</span></span>
<span id="cb451-2"><a href="#cb451-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the model</span></span>
<span id="cb451-3"><a href="#cb451-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Build model...'</span>)</span>
<span id="cb451-4"><a href="#cb451-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb451-5"><a href="#cb451-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with Neurons </span></span>
<span id="cb451-6"><a href="#cb451-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputshape = neurons -&gt; Timestamps</span></span>
<span id="cb451-7"><a href="#cb451-7" aria-hidden="true" tabindex="-1"></a>neurons<span class="op">=</span> x_train.shape[<span class="dv">1</span>]</span>
<span id="cb451-8"><a href="#cb451-8" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">90</span>, </span>
<span id="cb451-9"><a href="#cb451-9" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb451-10"><a href="#cb451-10" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>, </span>
<span id="cb451-11"><a href="#cb451-11" aria-hidden="true" tabindex="-1"></a>               input_shape <span class="op">=</span> (x_train.shape[<span class="dv">1</span>], <span class="dv">8</span>))) </span>
<span id="cb451-12"><a href="#cb451-12" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">50</span>, </span>
<span id="cb451-13"><a href="#cb451-13" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb451-14"><a href="#cb451-14" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">True</span>)) </span>
<span id="cb451-15"><a href="#cb451-15" aria-hidden="true" tabindex="-1"></a>model.add(LSTM(<span class="dv">25</span>, </span>
<span id="cb451-16"><a href="#cb451-16" aria-hidden="true" tabindex="-1"></a>               activation <span class="op">=</span> <span class="st">'relu'</span>,</span>
<span id="cb451-17"><a href="#cb451-17" aria-hidden="true" tabindex="-1"></a>               return_sequences <span class="op">=</span> <span class="va">False</span>)) </span>
<span id="cb451-18"><a href="#cb451-18" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">5</span>, activation <span class="op">=</span> <span class="st">'relu'</span>))</span>
<span id="cb451-19"><a href="#cb451-19" aria-hidden="true" tabindex="-1"></a>model.add(Dense(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Build model...</code></pre>
</div>
</div>
<div class="cell" data-execution_count="193">
<div class="sourceCode cell-code" id="cb453"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb453-1"><a href="#cb453-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">'adam'</span>, loss<span class="op">=</span><span class="st">'mean_squared_error'</span>)</span>
<span id="cb453-2"><a href="#cb453-2" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "sequential_9"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Layer (type)                Output Shape              Param #   </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_27 (LSTM)              (None, 90, 90)            35640     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_28 (LSTM)              (None, 90, 50)            28200     </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> lstm_29 (LSTM)              (None, 25)                7600      </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_18 (Dense)            (None, 5)                 130       </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> dense_19 (Dense)            (None, 1)                 6         </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>=================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Total params: 71,576</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Trainable params: 71,576</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Non-trainable params: 0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>_________________________________________________________________</code></pre>
</div>
</div>
<div class="cell" data-execution_count="194">
<div class="sourceCode cell-code" id="cb473"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb473-1"><a href="#cb473-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training the model</span></span>
<span id="cb473-2"><a href="#cb473-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fit network</span></span>
<span id="cb473-3"><a href="#cb473-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(x_train, </span>
<span id="cb473-4"><a href="#cb473-4" aria-hidden="true" tabindex="-1"></a>                    y_train, </span>
<span id="cb473-5"><a href="#cb473-5" aria-hidden="true" tabindex="-1"></a>                    batch_size<span class="op">=</span><span class="dv">1000</span>, </span>
<span id="cb473-6"><a href="#cb473-6" aria-hidden="true" tabindex="-1"></a>                    epochs<span class="op">=</span><span class="dv">50</span>, </span>
<span id="cb473-7"><a href="#cb473-7" aria-hidden="true" tabindex="-1"></a>                    validation_data <span class="op">=</span> (x_test, y_test), </span>
<span id="cb473-8"><a href="#cb473-8" aria-hidden="true" tabindex="-1"></a>                    verbose <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="195">
<div class="sourceCode cell-code" id="cb474"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb474-1"><a href="#cb474-1" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'loss'</span>], label<span class="op">=</span><span class="st">'train'</span>)</span>
<span id="cb474-2"><a href="#cb474-2" aria-hidden="true" tabindex="-1"></a>plt.plot(history.history[<span class="st">'val_loss'</span>], label<span class="op">=</span><span class="st">'test'</span>)</span>
<span id="cb474-3"><a href="#cb474-3" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb474-4"><a href="#cb474-4" aria-hidden="true" tabindex="-1"></a>plt.show() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_multi_files/figure-html/cell-196-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="196">
<div class="sourceCode cell-code" id="cb475"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb475-1"><a href="#cb475-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the predicted values</span></span>
<span id="cb475-2"><a href="#cb475-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.predict(x_test)</span>
<span id="cb475-3"><a href="#cb475-3" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> scaler_pred.inverse_transform(predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1/3 [=========&gt;....................] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - ETA: 0s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3/3 [==============================] - 0s 31ms/step</code></pre>
</div>
</div>
<div class="cell" data-execution_count="197">
<div class="sourceCode cell-code" id="cb479"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb479-1"><a href="#cb479-1" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y_test.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb479-2"><a href="#cb479-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> scaler_pred.inverse_transform(y_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="198">
<div class="sourceCode cell-code" id="cb480"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb480-1"><a href="#cb480-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean absolute error (MAE)</span></span>
<span id="cb480-2"><a href="#cb480-2" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y_test, predictions)</span>
<span id="cb480-3"><a href="#cb480-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MAE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(mae, <span class="dv">1</span>)))</span>
<span id="cb480-4"><a href="#cb480-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb480-5"><a href="#cb480-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb480-6"><a href="#cb480-6" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test,predictions))</span>
<span id="cb480-7"><a href="#cb480-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span>
<span id="cb480-8"><a href="#cb480-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb480-9"><a href="#cb480-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the root mean squarred error (RMSE)</span></span>
<span id="cb480-10"><a href="#cb480-10" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> mean_squared_error(y_test, </span>
<span id="cb480-11"><a href="#cb480-11" aria-hidden="true" tabindex="-1"></a>                          predictions,</span>
<span id="cb480-12"><a href="#cb480-12" aria-hidden="true" tabindex="-1"></a>                          squared <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb480-13"><a href="#cb480-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(rmse, <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE: 502.2
RMSE: 535.4
RMSE: 535.4</code></pre>
</div>
</div>
<div class="cell" data-execution_count="199">
<div class="sourceCode cell-code" id="cb482"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb482-1"><a href="#cb482-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the difference between the valid and predicted prices</span></span>
<span id="cb482-2"><a href="#cb482-2" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> data_sevilla[:(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">92</span>)]</span>
<span id="cb482-3"><a href="#cb482-3" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> data_sevilla[(<span class="bu">len</span>(x_train)<span class="op">+</span><span class="dv">91</span>):]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="200">
<div class="sourceCode cell-code" id="cb483"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb483-1"><a href="#cb483-1" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Predictions"</span>, predictions, <span class="va">True</span>)</span>
<span id="cb483-2"><a href="#cb483-2" aria-hidden="true" tabindex="-1"></a>valid.insert(<span class="dv">1</span>, <span class="st">"Difference"</span>, valid[<span class="st">"Predictions"</span>] <span class="op">-</span> valid[<span class="st">"num_casos"</span>], <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="201">
<div class="sourceCode cell-code" id="cb484"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb484-1"><a href="#cb484-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Zoom-in to a closer timeframe</span></span>
<span id="cb484-2"><a href="#cb484-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Date from which on the date is displayed</span></span>
<span id="cb484-3"><a href="#cb484-3" aria-hidden="true" tabindex="-1"></a>display_start_date <span class="op">=</span> <span class="st">"2021-07-15"</span> </span>
<span id="cb484-4"><a href="#cb484-4" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> valid[valid.index <span class="op">&gt;</span> display_start_date]</span>
<span id="cb484-5"><a href="#cb484-5" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> train[train.index <span class="op">&gt;</span> display_start_date]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="202">
<div class="sourceCode cell-code" id="cb485"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb485-1"><a href="#cb485-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the data</span></span>
<span id="cb485-2"><a href="#cb485-2" aria-hidden="true" tabindex="-1"></a>matplotlib.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb485-3"><a href="#cb485-3" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">22</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb485-4"><a href="#cb485-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb485-5"><a href="#cb485-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Train</span></span>
<span id="cb485-6"><a href="#cb485-6" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> train.index<span class="op">;</span> </span>
<span id="cb485-7"><a href="#cb485-7" aria-hidden="true" tabindex="-1"></a>yt <span class="op">=</span> train[[<span class="st">"num_casos"</span>]]</span>
<span id="cb485-8"><a href="#cb485-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Data - Test / validation </span></span>
<span id="cb485-9"><a href="#cb485-9" aria-hidden="true" tabindex="-1"></a>xv <span class="op">=</span> valid.index<span class="op">;</span> </span>
<span id="cb485-10"><a href="#cb485-10" aria-hidden="true" tabindex="-1"></a>yv <span class="op">=</span> valid[[<span class="st">"num_casos"</span>, <span class="st">"Predictions"</span>]]</span>
<span id="cb485-11"><a href="#cb485-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb485-12"><a href="#cb485-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb485-13"><a href="#cb485-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"sevilla: Predictions vs Real infections"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb485-14"><a href="#cb485-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Nº Cases"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb485-15"><a href="#cb485-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb485-16"><a href="#cb485-16" aria-hidden="true" tabindex="-1"></a>plt.plot(yt, color<span class="op">=</span><span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb485-17"><a href="#cb485-17" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"Predictions"</span>], color<span class="op">=</span><span class="st">"red"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb485-18"><a href="#cb485-18" aria-hidden="true" tabindex="-1"></a>plt.plot(yv[<span class="st">"num_casos"</span>], color<span class="op">=</span><span class="st">"green"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb485-19"><a href="#cb485-19" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"LSTM Predictions"</span>, <span class="st">"Test"</span>], </span>
<span id="cb485-20"><a href="#cb485-20" aria-hidden="true" tabindex="-1"></a>           loc<span class="op">=</span><span class="st">"upper left"</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb485-21"><a href="#cb485-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb485-22"><a href="#cb485-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar plot with the differences</span></span>
<span id="cb485-23"><a href="#cb485-23" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> valid.index</span>
<span id="cb485-24"><a href="#cb485-24" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> valid[<span class="st">"Difference"</span>]</span>
<span id="cb485-25"><a href="#cb485-25" aria-hidden="true" tabindex="-1"></a>plt.bar(x, y, width<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">"grey"</span>)</span>
<span id="cb485-26"><a href="#cb485-26" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb485-27"><a href="#cb485-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lstm_multi_files/figure-html/cell-203-output-1.png" class="img-fluid"></p>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./lstm_uni.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">LSTM univariate prediction</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>